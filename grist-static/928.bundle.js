(self.webpackChunkgristy=self.webpackChunkgristy||[]).push([[928,674],{50489:(e,t,o)=>{"use strict";o.r(t),o.d(t,{setupAceEditorCompletions:()=>l});var i=o(62802),n=o.n(i),s=o(64978);const r=new WeakMap;function l(e,t){!function(){if(a)return;a=!0;const e=/\w+\.(?:lookupRecords|lookupOne)\([\w.$\u00A2-\uFFFF]*$|[\w.$\u00A2-\uFFFF]+$/;n().require("ace/autocomplete/util").getCompletionPrefix=function(t){const o=t.getCursorPosition(),i=t.session.getLine(o.row).slice(0,o.column).match(e);return i?i[0]:""};const t=n().require("ace/ext/language_tools");t.setCompleters([]),t.addCompleter({async getCompletions(e,t,o,i,n){const s=r.get(e);if(!s||0===i.length)return void n(null,[]);const l=t.getWordRange(o.row,o.column),a=t.getTokenAt(o.row,l.end.column),p=t.getTokenAt(o.row,l.end.column+1),h=["function.support","identifier"].includes(a.type)&&"paren.lparen"===(null==p?void 0:p.type),m=(await s.getSuggestions(i)).map((e=>{const[t,o]=e;if(Array.isArray(t)){const[e,i]=t;return{value:e+(h?"":"("),caption:e+i,score:1,example:o,funcname:e}}return{value:t,caption:t,score:1,example:o,funcname:""}})),f=m.filter((e=>e.example)).map((e=>e.caption.length)),g=Math.min(Math.min(...f)+d,Math.max(...f),u);for(const e of m){if(!e.example)continue;const t=Math.max(0,g-e.caption.length)+c;e.caption=e.caption+" ".repeat(t)+e.example}n(null,m)}})}(),r.set(e,t);const{Autocomplete:o}=n().require("ace/autocomplete"),i=new o;i.autoSelect=!1,e.completer=i,i._gristShouldRefreshCompletions=function(e){const t=this.editor.getCursorPosition(),o=this.editor.session.getTextRange({start:e,end:t}).toLowerCase();return o.endsWith(".")||o.endsWith(".lookupone(")||o.endsWith(".lookuprecords(")}.bind(i);const s=i.updateCompletions.bind(i);i.updateCompletions=function(e){return e&&this.base&&this.completions&&this._gristShouldRefreshCompletions(this.base)&&(this.completions=null),s(e)}.bind(i);const l=i.insertMatch.bind(i);i.insertMatch=function(){const e=this.base,t=l.apply(...arguments);return this._gristShouldRefreshCompletions(e)&&this.showPopup(this.editor),t}.bind(i),function(e){const t=e.$init;e.$init=function(){const e=t.apply(this,arguments);return p(this,e),e}}(i),e.on("destroy",(()=>{i.editor&&i.detach(),i.popup&&(i.popup.destroy(),i.popup.container.remove())}))}let a=!1;const c=8,d=15,u=40;function p(e,t){const o=t.session.bgTokenizer.$tokenizeRow;t.session.bgTokenizer.$tokenizeRow=function(e){const i=o(e);return function(e,t){if(!e.funcname&&!e.example)return t;const o=e.funcname.lastIndexOf("."),i=o<0?0:o+1,n=e.funcname.length,r=[],l=`${s.PH.functions}/#`+e.funcname.slice(i,n).toLowerCase();let a;r.push({value:l,type:"grist_link_hidden"}),e.example&&(e.caption.endsWith(e.example)?a=e.caption.length-e.example.length:console.warn(`Example "${e.example}" does not match caption "${e.caption}"`));let c=0;for(const e of t){if(a&&c+e.value.length>a){const t=a-c;t>0?(r.push({value:e.value.slice(0,t),type:e.type}),r.push({value:e.value.slice(t),type:"grist_example"})):r.push({value:e.value,type:"grist_example"})}else{const t=i-c,o=n-c;if(t>0){const o=e.value.slice(0,t);r.push({value:o,type:e.type})}if(o>0){const i=e.value.slice(Math.max(0,t),o),n=e.type+(e.type?".":"")+"grist_link";if(r.push({value:i,type:n}),o<e.value.length){const t=e.value.slice(o);r.push({value:t,type:e.type})}}else r.push(e)}c+=e.value.length}return r}(t.data[e],i)},t.removeAllListeners("click"),t.on("click",(function(t){(function(e){var t;const o=e.target;if(o&&o.matches(".ace_grist_link")){const e=null==(t=o.parentElement)?void 0:t.querySelector(".ace_grist_link_hidden");if(e)return window.open(e.textContent,"_blank"),!0}return!1})(t.domEvent)||e.insertMatch(),t.stop()}))}},13998:(e,t,o)=>{"use strict";o.d(t,{RA:()=>a,_O:()=>d,jL:()=>l});var i=o(29922),n=o(7454),s=o(1310);const r=(0,s.makeTestId)("test-banner-");class l extends s.Disposable{constructor(e){super(),this._options=e,this._isExpanded=s.Observable.create(this,!0)}buildDom(){return c({class:this._options.bannerCssClass||""},c.cls(`-${this._options.style}`),this._buildContent(),this._buildButtons(),r("element"))}_buildContent(){const{content:e,contentSmall:t}=this._options;return s.dom.domComputed((o=>{if(void 0===t)return[e];const n=o(this._isExpanded);return[o((0,i.isNarrowScreenObs)())&&!n?t:e]}))}_buildButtons(){return u(this._options.showExpandButton?this._buildExpandButton():null,this._options.showCloseButton?this._buildCloseButton():null)}_buildCloseButton(){return p("CrossBig",s.dom.on("click",(()=>{var e,t;return null==(t=(e=this._options).onClose)?void 0:t.call(e)})),r("close"))}_buildExpandButton(){return s.dom.maybe((0,i.isNarrowScreenObs)(),(()=>h("Dropdown",h.cls("-expanded",this._isExpanded),s.dom.on("click",(()=>this._isExpanded.set(!this._isExpanded.get()))))))}}function a(...e){return g(b("Idea"),m(e))}const c=(0,s.styled)("div",`\n  display: flex;\n  padding: 10px;\n  gap: 16px;\n  color: white;\n\n  &-info {\n    color: black;\n    background: #FFFACD;\n  }\n\n  &-warning {\n    background: #E6A117;\n  }\n\n  &-error {\n    background: ${i.colors.error};\n  }\n`),d=(0,s.styled)("span","\n  cursor: pointer;\n  color: unset;\n  text-decoration: underline;\n\n  &:hover, &:focus {\n    color: unset;\n  }\n"),u=(0,s.styled)("div","\n  display: flex;\n  gap: 16px;\n  flex-shrink: 0;\n  margin-left: auto;\n"),p=(0,s.styled)(n.icon,"\n  width: 16px;\n  height: 16px;\n  cursor: pointer;\n  background-color: white;\n"),h=(0,s.styled)(p,"\n  &-expanded {\n    -webkit-mask-image: var(--icon-DropdownUp) !important;\n  }\n"),m=(0,s.styled)("div","\n  font-weight: 500;\n"),f=(0,s.styled)("div","\n  display: flex;\n  gap: 16px;\n"),g=(0,s.styled)(f,"\n  flex-grow: 1;\n  justify-content: center;\n"),b=(0,s.styled)(n.icon,"\n  flex-shrink: 0;\n  width: 16px;\n  height: 16px;\n  background-color: white;\n")},44747:(e,t,o)=>{"use strict";o.r(t),o.d(t,{ChartConfig:()=>ge,ChartView:()=>me,chartTypes:()=>we,isNumericLike:()=>ue,isNumericOnly:()=>de});var i=o(30583),n=o.n(i),s=o(11579),r=o(93965),l=Object.defineProperty,a=Object.defineProperties,c=Object.getOwnPropertyDescriptors,d=Object.getOwnPropertySymbols,u=Object.prototype.hasOwnProperty,p=Object.prototype.propertyIsEnumerable,h=(e,t,o)=>t in e?l(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,m=(e,t)=>{for(var o in t||(t={}))u.call(t,o)&&h(e,o,t[o]);if(d)for(var o of d(t))p.call(t,o)&&h(e,o,t[o]);return e},f=(e,t)=>a(e,c(t));const g=o(49268),b=o(76274),v=o(50949);function y(e){if(!e[0])return;const t=e[0].values,o=t.map(((e,t)=>t));o.sort(((e,o)=>(0,s.typedCompare)(t[e],t[o])));for(const t of e){const e=t.values;t.values=o.map((t=>e[t]))}}function _(e,t){const o=e[t].values.map(r.xD);return e.map(((i,n)=>{if(n===t)return f(m({},e[t]),{values:v(o)});let s=[];for(const[e,t]of o.entries())Array.isArray(t)?s=s.concat(Array(t.length).fill(i.values[e])):s.push(i.values[e]);return f(m({},i),{values:s})}))}function w(e,t){let o=0;for(const i of t){if(o<e[0].values.length&&i!==e[0].values[o]||o>e[0].values.length-1){e[0].values.splice(o,0,i);for(let t=1;t<e.length;++t)e[t].values.splice(o,0,0)}for(;i===e[0].values[o]&&o<e[0].values.length;)o++}return e}function x(e){return Math.floor(100*e)+" %"}var C=o(96682),D=o(88438),S=o(95163),k=o(62258),T=o(92769),I=o(32529),R=o(22641),F=o(3411),O=o(51536),E=o(92478),A=o(29922),M=o(13884),P=o(7454),B=o(1370),$=o(83277),L=o(48210),N=o(86277),z=o(1310),V=o(29301),H=o(70387),j=Object.defineProperty,U=Object.defineProperties,W=Object.getOwnPropertyDescriptors,Y=Object.getOwnPropertySymbols,G=Object.prototype.hasOwnProperty,K=Object.prototype.propertyIsEnumerable,q=(e,t,o)=>t in e?j(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,J=(e,t)=>{for(var o in t||(t={}))G.call(t,o)&&q(e,o,t[o]);if(Y)for(var o of Y(t))K.call(t,o)&&q(e,o,t[o]);return e},X=(e,t)=>U(e,W(t));const Q=o(26352),Z=o(88466),ee=o(52906),te=o(29809),oe=o(38072),ie=o(7531),ne=o(6311),se=o(37346);let re;const le=(0,z.makeTestId)("test-chart-"),ae=(0,H.makeT)("ChartView");function ce(e){return["pie","donut"].includes(e)}function de(e){return["bar","pie","donut","kaplan_meier","line","area","scatter"].includes(e)}function ue(e,t=$.unwrap){const o=function(e,t=$.unwrap){const o=t(e.pureType);return"Ref"===o?t(t(e.visibleColModel).type):o}(e,t);return["Numeric","Int","Any"].includes(o)}function pe(e,t){if(void 0===e.group)return e.label;const o=""===e.group?"[Blank]":e.group;return t?`${o} • ${e.label}`:String(o)}const he=["ChoiceList","RefList"];class me extends D.Disposable{get _sortSpec(){return this.viewSection.activeSortSpec.peek()}create(e,t){n().call(this,e,t),this._chartDom=this.autoDispose(this.buildDom()),this._resize=this.autoDispose(C.Delay.untilAnimationFrame(this._resizeChart,this)),this.viewPane=this._chartDom,this._chartType=this.viewSection.chartTypeDef,this._options=this.viewSection.optionsObj,this._formatterComp=this.autoDispose(V.computed((()=>{const e=this.viewSection.viewFields().at(1);return null==e?void 0:e.visibleColFormatter()}))),this._update=Z((()=>this._updateView()),0);let o=[];this.autoDispose(this._chartType.subscribe(this._update)),this.autoDispose(this._options.subscribe(this._update)),this.autoDispose(this.viewSection.viewFields().subscribe((e=>{this._update(),o.forEach((e=>e.dispose())),o=[...e.map((e=>e.displayColModel.peek().type.subscribe(this._update))),...e.map((e=>e.visibleColModel.peek().type.subscribe(this._update)))]}))),this.listenTo(this.sortedRows,"rowNotify",this._update),this.autoDispose(this.sortedRows.getKoArray().subscribe(this._update)),this.autoDispose(this._formatterComp.subscribe(this._update)),this.autoDispose(this.gristDoc.currentTheme.addListener((()=>this._update())))}prepareToPrint(e){re.relayout(this._chartDom,{}).catch(T.reportError)}onTableLoaded(){n().prototype.onTableLoaded.call(this),this._update()}onResize(){this._resize()}buildDom(){return(0,z.dom)("div.chart_container",le("container"))}listenTo(...e){}async _updateView(){var e;if(this.isDisposed())return;const t=we[this._chartType()];if("function"!=typeof t)return void console.warn("Unknown trace type %s",this._chartType());const o=this.viewSection.viewFields().all(),i=this.sortedRows.getKoArray().peek(),n=this._options.prop("multiseries").peek()?2:1;let s=o.filter(((e,t)=>t<n||this._isCompatibleSeries(e.column.peek()))).map((e=>{const t=e.displayColModel.peek().colId.peek(),o=this.tableModel.tableData.getRowPropFunc(t),n=e.displayColModel().pureType(),s="Date"===n||"DateTime"===n?function(e){return t=>{const o=1e3*e(t);return o?new Date(o).toISOString():null}}(o):o;return{label:e.label(),values:i.map(s),isInSortSpec:Boolean(L.Sort.findCol(this._sortSpec,e.colRef.peek()))}}));for(let e=0;e<s.length;++e)e<o.length&&he.includes(o[e].column.peek().pureType.peek())&&(e<n?s=_(s,e):s[e].values=s[e].values.map((e=>String((0,r.xD)(e)))));const l={},a=this._options.peek()||{};let c={data:[]};if(ce(this._chartType.peek())&&(l.sort=!1,y(s)),"donut"===this._chartType.peek()&&(l.totalFormatter=this._formatterComp.peek()),!a.multiseries&&s.length)c=t(s,a,l);else if(s.length>1){const o=!s[0].isInSortSpec,i=function(e,t,o){const i=new Map,n=Math.floor(100/t.length);let s=[...new Set(e)];o&&s.sort(),s=s.slice(0,n);for(const e of s)i.set(e,t.map((t=>({label:t.label,group:e,values:[]}))));for(let o=0;o<e.length;o++){const n=e[o],s=i.get(n);if(s)for(let e=0;e<t.length;e++)s[e].values.push(t[e].values[o])}return i}(s[0].values,s.slice(1),o),n=Array.from(new Set(s[1].values));for(const o of i.values()){"bar"===this._chartType.peek()&&(null==(e=this._sortSpec)?void 0:e.length)&&w(o,n);const i=t(o,a,l);i.data=c.data.concat(i.data),c=i}}if(re=re||await(0,k.m)(),this.isDisposed())return;const d=te(c.layout,this._getPlotlyLayout(a)),u=X(J({},c.config),{displayModeBar:!1});await re.react(this._chartDom,c.data,d,u),this._resizeChart()}_resizeChart(){if(this.isDisposed()||!re||!this._chartDom.parentNode)return;const e=window.getComputedStyle(this._chartDom).display;e&&"none"!==e&&re.Plots.resize(this._chartDom)}_isCompatibleSeries(e){return!de(this._chartType.peek())||ue(e)}_getPlotlyLayout(e){const t={automargin:!0,title:{standoff:0}};e.logYAxis&&(t.type="log"),e.invertYAxis&&(t.autorange="reversed");const o=J({margin:{l:50,r:50,b:40,t:30,pad:4},yaxis:t,xaxis:{automargin:!0,title:{standoff:0}}},e.stacked?{barmode:"relative"}:{});return ie(o,this._getPlotlyTheme())}_getPlotlyTheme(){const e=this.gristDoc.docPageModel.appModel,{colors:t}=e.currentTheme.get();return{paper_bgcolor:t["chart-bg"],plot_bgcolor:t["chart-bg"],xaxis:{color:t["chart-x-axis"]},yaxis:{color:t["chart-y-axis"]},font:{color:t["chart-fg"]},legend:{bgcolor:t["chart-legend-bg"]}}}}ee(me.prototype,n().prototype),Object.assign(me.prototype,N.Events);const fe=class extends z.Disposable{constructor(e,t){super(),this._gristDoc=e,this._section=t,this._configFieldsHelper=O.M1.create(this,this._gristDoc,this._section),this._xAxisFieldIndex=z.Computed.create(this,(0,z.fromKo)(this._optionsObj.prop("multiseries")),(0,z.fromKo)(this._optionsObj.prop("isXAxisUndefined")),((e,t,o)=>o?-1:t?1:0)),this._groupDataColId=z.Computed.create(this,(e=>{const t=e(this._optionsObj.prop("multiseries")),o=e(e(this._section.viewFields).getObservable());return t&&0!==o.length?e(e(o[0].column).colId):""})).onWrite((e=>this._setGroupDataColumn(e))),this._freezeXAxis=z.Observable.create(this,!1),this._freezeYAxis=z.Observable.create(this,!1),this._xAxis=z.Computed.create(this,this._xAxisFieldIndex,this._freezeXAxis,((e,t,o)=>{if(o)return this._xAxis.get();const i=e(e(this._section.viewFields).getObservable());return-1<t&&t<i.length?e(e(i[t].column).colId):""})).onWrite((e=>this._setXAxis(e))),this._isValueAggregated=z.Computed.create(this,(e=>this._isSummaryTable(e))).onWrite((e=>this._setAggregation(e))),this._columnsOptions=z.Computed.create(this,this._freezeXAxis,((e,t)=>t?this._columnsOptions.get():(e(this._isValueAggregated)?this._getSummarySourceColumns(e):this._getColumns(e)).filter((e=>!e.isHiddenCol.peek())).map((e=>({value:e.colId(),label:e.label.peek(),icon:"FieldColumn"}))))),this._groupDataOptions=z.Computed.create(this,(e=>[{value:"",label:"Pick a column"},...e(this._columnsOptions)])),this._groupDataForce=z.Observable.create(null,!1),this._groupData=z.Computed.create(this,this._groupDataColId,this._groupDataForce,((e,t,o)=>!!t||o)).onWrite((e=>{!1===e&&this._groupDataColId.set(""),this._groupDataForce.set(e)})),this._firstFieldLabel=z.Computed.create(this,(0,z.fromKo)(this._section.chartTypeDef),((e,t)=>function(e){return["pie","donut","kaplan_meier","scatter"].includes(e)}(t)?"LABEL":"X-AXIS")),this._chartType=z.Computed.create(this,(e=>e(this._section.chartTypeDef))).onWrite((e=>this._gristDoc.docData.bundleActions("switched chart type",(async()=>{await this._section.chartTypeDef.saveOnly(e),ce(e)&&(await this._setGroupDataColumn(""),this._groupDataForce.set(!1))})))),fe._instanceMap.set(t,this)}get _optionsObj(){return this._section.optionsObj}buildDom(){return"chart"!==this._section.parentKey()?null:[(0,F.cssRow)((0,B.select)(this._chartType,[{value:"bar",label:"Bar Chart",icon:"ChartBar"},{value:"pie",label:"Pie Chart",icon:"ChartPie"},{value:"donut",label:"Donut Chart",icon:"ChartDonut"},{value:"area",label:"Area Chart",icon:"ChartArea"},{value:"line",label:"Line Chart",icon:"ChartLine"},{value:"scatter",label:"Scatter Plot",icon:"ChartLine"},{value:"kaplan_meier",label:"Kaplan-Meier Plot",icon:"ChartKaplan"}]),le("type")),z.dom.maybe((e=>!ce(e(this._section.chartTypeDef))),(()=>[ye("Split series",this._groupData),ve("Invert Y-axis",this._optionsObj.prop("invertYAxis")),(0,F.cssRow)(De("Orientation"),(0,z.dom)("div",(0,B.linkSelect)((0,S.fromKoSave)(this._optionsObj.prop("orientation")),[{value:"v",label:"Vertical"},{value:"h",label:"Horizontal"}],{defaultLabel:"Vertical"})),le("orientation")),ve("Log scale Y-axis",this._optionsObj.prop("logYAxis"))])),z.dom.maybeOwned((e=>"donut"===e(this._section.chartTypeDef)),(e=>[be("Hole Size",z.Computed.create(e,(e=>{var t;return null!=(t=e(this._optionsObj.prop("donutHoleSize")))?t:.75})),(e=>this._optionsObj.prop("donutHoleSize").saveOnly(e)),le("option")),ve("Show Total",this._optionsObj.prop("showTotal")),z.dom.maybe(this._optionsObj.prop("showTotal"),(()=>function(e,t,o,...i){let n;async function s(e,i=(e=>e)){let s=parseFloat(e);isFinite(s)&&(s=Q(i(s),1,1/0),await o(s)),n.value=t.get()+"px"}return(0,F.cssRow)(De(e),Oe(n=Ee({type:"text"},z.dom.prop("value",(e=>e(t)+"px")),z.dom.on("change",((e,t)=>s(t.value))),z.dom.onKeyDown({ArrowDown:(e,t)=>s(t.value,(e=>e-1)),ArrowUp:(e,t)=>s(t.value,(e=>e+1))})),Ae("input",{type:"number",step:"1",min:String(1)},z.dom.prop("value",t),z.dom.on("change",((e,t)=>s(t.value))))),...i)}("Text Size",z.Computed.create(e,(e=>{var t;return null!=(t=e(this._optionsObj.prop("textSize")))?t:24})),(e=>this._optionsObj.prop("textSize").saveOnly(e)),le("option"))))])),z.dom.maybe((e=>"line"===e(this._section.chartTypeDef)),(()=>[ve("Connect gaps",this._optionsObj.prop("lineConnectGaps")),ve("Show markers",this._optionsObj.prop("lineMarkers"))])),z.dom.maybe((e=>["line","bar"].includes(e(this._section.chartTypeDef))),(()=>[ve("Stack series",this._optionsObj.prop("stacked")),(0,F.cssRow)(De("Error bars"),(0,z.dom)("div",(0,B.linkSelect)((0,S.fromKoSave)(this._optionsObj.prop("errorBars")),[{value:"",label:"None"},{value:"symmetric",label:"Symmetric"},{value:"separate",label:"Above+Below"}],{defaultLabel:"None"})),le("error-bars")),z.dom.domComputed(this._optionsObj.prop("errorBars"),(e=>"symmetric"===e?Se(ae("Each Y series is followed by a series for the length of error bars.")):"separate"===e?Se(ae("Each Y series is followed by two series, for top and bottom error bars.")):null))])),(0,F.cssSeparator)(),z.dom.maybe(this._groupData,(()=>[(0,F.cssLabel)("Split Series"),(0,F.cssRow)((0,B.select)(this._groupDataColId,this._groupDataOptions),le("group-by-column")),Re(ae("Create separate series for each value of the selected column."))])),(0,F.cssLabel)(z.dom.text(this._firstFieldLabel),le("first-field-label")),(0,F.cssRow)((0,B.select)(this._xAxis,this._columnsOptions,{defaultLabel:ae("Pick a column")}),le("x-axis")),ye("Aggregate values",this._isValueAggregated),(0,F.cssLabel)("SERIES"),this._buildYAxis(),(0,F.cssRow)(Te(ke("Plus"),"Add Series",(0,B.menu)((()=>{const e=this._section.hiddenColumns.peek(),t=this._isCompatibleSeries.bind(this),o=e.filter((e=>!t(e))).length;return[...e.filter((e=>t(e))).map((e=>(0,B.menuItem)((()=>this._configFieldsHelper.addField(e)),e.label.peek()))),o?(0,B.menuText)(`${o} `+(o>1?"non-numeric columns are not shown":"non-numeric column is not shown"),le("yseries-picker-message")):null]})),le("add-y-axis")))]}async _setXAxis(e){const t=this._section.optionsObj,o=()=>this._getColumns().find((t=>t.colId()===e)),i=this._section.viewFields.peek();await this._gristDoc.docData.bundleActions("selected new x-axis",(async()=>{this._freezeYAxis.set(!0),this._freezeXAxis.set(!0);try{-1!==this._xAxisFieldIndex.get()&&this._xAxisFieldIndex.get()<i.peek().length&&await this._configFieldsHelper.removeField(i.peek()[this._xAxisFieldIndex.get()]),await(0,I.setSaveValue)(this._optionsObj.prop("isXAxisUndefined"),!1);const n=i.peek().findIndex((t=>t.column.peek().colId()===e));if(0===n&&t.prop("multiseries").peek())return void await t.prop("multiseries").setAndSave(!1);if(this._isValueAggregated.get()){const t=this._groupDataColId.get(),o=t===e?[e]:[t,e];await this._setGroupByColumns(o)}const s=i.peek()[this._xAxisFieldIndex.get()];if(n>-1)await this._configFieldsHelper.changeFieldPosition(i.peek()[n],s);else{const e=o();e&&await this._configFieldsHelper.addField(e,s)}}finally{this._freezeYAxis.set(!1),this._freezeXAxis.set(!1)}}))}async _setGroupDataColumn(e){const t=this._section.viewFields.peek().peek();await this._gristDoc.docData.bundleActions(ae("selected new group data columns"),(async()=>{this._freezeXAxis.set(!0),this._freezeYAxis.set(!0);try{if(this._groupDataColId.get()&&await this._configFieldsHelper.removeField(t[0]),this._isValueAggregated.get()){const t=this._xAxis.get(),o=t===e?[e]:[e,t];await this._setGroupByColumns(o)}if(e){const o=this._getColumns().find((t=>t.colId()===e)),i=t.find((t=>t.column.peek().colId()===e));i?await this._configFieldsHelper.changeFieldPosition(i,t[0]):await this._configFieldsHelper.addField(o,t[0]),e===this._xAxis.get()&&await this._optionsObj.prop("isXAxisUndefined").setAndSave(!0)}await this._optionsObj.prop("multiseries").setAndSave(Boolean(e))}finally{this._freezeXAxis.set(!1),this._freezeYAxis.set(!1)}}),{nestInActiveBundle:!0})}_getColumns(e=$.unwrap){const t=e(this._section.table);return e(e(t.columns).getObservable())}_getSummarySourceColumns(e=$.unwrap){let t=e(this._section.table);return t=e(t.summarySource),e(e(t.columns).getObservable())}_buildField(e){return(0,O.B3)((0,O.Tw)(z.dom.text(e.label)),Ie("Remove",z.dom.on("click",(()=>this._configFieldsHelper.removeField(e))),le("ref-select-remove")),le("y-axis"))}_buildYAxis(){const e=z.Computed.create(this,(0,z.fromKo)(this._optionsObj.prop("multiseries")),(0,z.fromKo)(this._optionsObj.prop("isXAxisUndefined")),((e,t,o)=>(o?0:1)+(t?1:0)));return z.dom.domComputed((t=>this._configFieldsHelper.buildVisibleFieldsConfigHelper({itemCreateFunc:e=>this._buildField(e),draggableOptions:{removeButton:!1,drag_indicator:M.x},skipFirst:e,freeze:this._freezeYAxis,filterFunc:e=>this._isCompatibleSeries(t(e.column),t)})))}_isCompatibleSeries(e,t=$.unwrap){return!de(t(this._chartType))||ue(e,t)}async _setAggregation(e){try{this._freezeXAxis.set(!0),await this._gristDoc.docData.bundleActions(ae("Toggle chart aggregation"),(async()=>{e?await this._doAggregation():await this._undoAggregation()}))}finally{this.isDisposed()||this._freezeXAxis.set(!1)}}async _doAggregation(){this._isSummaryTable()?await this._setGroupByColumns([this._xAxis.get(),this._groupDataColId.get()]):await this._toggleSummaryTable()}async _undoAggregation(){this._isSummaryTable()&&await this._toggleSummaryTable()}_isSummaryTable(e=$.unwrap){return Boolean(e(e(this._section.table).summarySourceTable))}async _toggleSummaryTable(){const e=[this._xAxis.get(),this._groupDataColId.get()],t=(0,R.FU)(this._section);t.summarize=!this._isSummaryTable(),t.columns=this._getColumnIds(e),this._ensureValidLinkingIfAny(t);const o=await this._gristDoc.saveViewSection(this._section,t);return fe._instanceMap.get(o)}async _setGroupByColumns(e){const t=(0,R.FU)(this._section);return t.columns=this._getColumnIds(e),this._ensureValidLinkingIfAny(t),this._gristDoc.saveViewSection(this._section,t)}_ensureValidLinkingIfAny(e){if(!e.summarize)return;if(!this._section.linkSrcSection().getRowId())return;const t=(0,R.FU)(this._section.linkSrcSection());e.columns=se(e.columns,t.columns)}_getColumnIds(e){const t=this._isSummaryTable()?this._section.table().summarySource().columns().all():this._section.table().columns().all();return e.map((e=>e&&t.find((t=>t.colId()===e)))).filter((e=>Boolean(e))).map((e=>e.id()))}};let ge=fe;function be(e,t,o,...i){let n;async function s(e,i=(e=>e)){let s=parseFloat(e);isFinite(s)&&(s=Q(i(s),0,99)/100,await o(s)),n.value=x(t.get())}return(0,F.cssRow)(De(e),Fe({type:"range",min:"0",max:"1",step:"0.01"},z.dom.prop("value",t),z.dom.on("change",((e,t)=>o(Number(t.value))))),Oe(n=Ee({type:"text"},z.dom.prop("value",(e=>x(e(t)))),z.dom.on("change",((e,t)=>s(t.value))),z.dom.onKeyDown({ArrowDown:(e,t)=>s(t.value,(e=>e-1)),ArrowUp:(e,t)=>s(t.value,(e=>e+1))})),Ae("input",{type:"number",step:"0.01",min:"0",max:"0.99"},z.dom.prop("value",t),z.dom.on("change",((e,t)=>o(Number(t.value)))))),...i)}function ve(e,t,...o){return ye(e,(0,S.fromKoSave)(t),...o)}function ye(e,t,...o){return(0,z.dom)("label",F.cssRow.cls(""),De(e),(0,E.n2)(t,...o))}function _e(e,t,o){xe(e);const i=function(e,t){const o=new Map;if(t.errorBars)for(let i=1;i<e.length;i++)o.set(e[i],{type:"data",symmetric:"symmetric"===t.errorBars,array:e[i+1]&&e[i+1].values,arrayminus:"separate"===t.errorBars?e[i+2]&&e[i+2].values:void 0,thickness:1,width:3}),e.splice(i+1,"symmetric"===t.errorBars?1:2);return o}(e,t);"bar"===o.type&&function(e){if(!e[0])return;const t=e[0].values.length,o=new Set(b(g(t),(t=>e[0].values[t])));e.forEach((e=>{e.values=e.values.filter(((e,t)=>o.has(t)))}))}(e);const[n,s]="h"===t.orientation?["y","x"]:["x","y"];function r(e,t){if(!e)return e;const o=t.find((e=>e&&(e>0||e<0)));return o&&o<0?"-"+e:e}return{data:e.slice(1).map((l=>X(J({name:pe(l,e.length>2),[n]:Ce(e[0].values),[s]:l.values,[`error_${s}`]:i.get(l),orientation:t.orientation},o),{stackgroup:r(o.stackgroup,l.values)}))),layout:{[`${n}axis`]:{title:e.length>0?{text:e[0].label}:{}},[`${s}axis`]:{title:2===e.length?{text:e[1].label}:{}}}}}ge._instanceMap=new WeakMap;const we={bar:(e,t)=>_e(e,t,{type:"bar"}),line:(e,t)=>(y(e),_e(e,t,{type:"scatter",connectgaps:t.lineConnectGaps,mode:t.lineMarkers?"lines+markers":"lines",stackgroup:t.stacked?"A":""})),area:(e,t)=>(y(e),_e(e,t,{type:"scatter",fill:"tozeroy",line:{shape:"spline"}})),scatter:(e,t)=>_e(e.slice(1),t,{type:"scatter",mode:"text+markers",text:e[0].values,textposition:"bottom center"}),pie(e,t,o={}){let i;return 0===e.length?{data:[]}:(e.length>1?(xe(e),i=e[1]):i={label:"Count",values:e[0].values.map((()=>1))},{data:[J({type:"pie",name:pe(i,!1),labels:Ce(e[0].values),values:i.values},o)]})},donut(e,t,o={}){var i;const n=oe(t.donutHoleSize)?t.donutHoleSize:.75,s=[],r=we.pie(e,t,X(J({},o),{hole:n}));var l;return t.showTotal&&s.push({text:(l=e.length>1?ne(e[1].values.filter(oe)):r.data[0].labels.length,o.totalFormatter?o.totalFormatter.formatAny(l):String(l)),showarrow:!1,font:{size:null!=(i=t.textSize)?i:24}}),te(r,{layout:{annotations:s}})},kaplan_meier:e=>e.length<2?{data:[]}:{data:function(e,t){const o=new Map;for(const[i,n]of e.entries())o.has(n)||o.set(n,[]),o.get(n).push(t[i]);return Array.from(o,(([e,t])=>({label:e,values:t})))}(e[0].values,e[1].values).map((e=>{const t=function(e){const t=new Map;for(const o of e)t.set(o,(t.get(o)||0)+1);const o=Array.from(t.keys());o.sort($.nativeCompare);let i=e.length;const n=[{x:0,y:i}];for(const e of o)i-=t.get(e),n.push({x:e,y:i});return n}(e.values);return{type:"scatter",mode:"lines",line:{shape:"hv"},name:pe(e,!1),x:t.map((e=>e.x)),y:t.map((e=>e.y))}}))}};function xe(e){const t=e.slice(1).map((e=>e.values));for(const o of e)o.values=o.values.filter(((e,o)=>t.some((e=>"number"==typeof e[o]))))}function Ce(e){return e.map((e=>null==e||""===e?"-":e))}const De=(0,z.styled)("div",`\n  flex: 1 0 0px;\n  margin-right: 8px;\n\n  font-weight: initial;   /* negate bootstrap */\n  color: ${A.theme.text};\n  overflow: hidden;\n  text-overflow: ellipsis;\n  user-select: none;\n`),Se=(0,z.styled)(F.cssRow,`\n  font-size: ${A.vars.smallFontSize};\n  color: ${A.theme.lightText};\n`),ke=(0,z.styled)(P.icon,"\n  margin-right: 4px;\n"),Te=(0,z.styled)("div",`\n  display: flex;\n  cursor: pointer;\n  color: ${A.theme.controlFg};\n  --icon-color: ${A.theme.controlFg};\n\n  &:not(:first-child) {\n    margin-top: 8px;\n  }\n  &:hover, &:focus, &:active {\n    color: ${A.theme.controlHoverFg};\n    --icon-color: ${A.theme.controlHoverFg};\n  }\n`),Ie=(0,z.styled)(P.icon,`\n  display: none;\n  cursor: pointer;\n  flex: none;\n  margin-left: 8px;\n  .${O.B3.className}:hover & {\n    display: block;\n  }\n`),Re=(0,z.styled)("div",`\n  margin: -4px 16px 8px 16px;\n  color: ${A.theme.lightText};\n`),Fe=(0,z.styled)("input","\n  input& {\n    width: 82px;\n    margin-right: 4px;\n  }\n"),Oe=(0,z.styled)("div","\n  position: relative;\n"),Ee=(0,z.styled)("input","\n  width: 55px;\n"),Ae=(0,z.styled)("input",`\n  width: 19px;\n  position: absolute;\n  top: 2px;\n  right: 1px;\n  border: none;\n  outline: none;\n  appearance: none;\n  -moz-appearance: none;\n  visibility: hidden;\n\n  .${Oe.className}:hover & {\n    visibility: visible;\n  }\n\n  /* needed for chrome to show spinners, indeed the cursor could be outside of spinners' input\n  element */\n  &[type=number]::-webkit-inner-spin-button {\n    opacity: 1;\n  }\n`)},67931:(e,t,o)=>{"use strict";o.r(t),o.d(t,{Cursor:()=>a});var i=o(77709),n=o(1310),s=o(29301);function r(e){return null==e?void 0:e}const l=class extends n.Disposable{constructor(e,t){super(),this._isLive=s.observable(!0),t=t||{},this.viewData=e.viewData,this._sectionId=this.autoDispose(s.computed((()=>e.viewSection.id()))),this._rowId=s.observable(t.rowId||0),this.rowIndex=this.autoDispose(s.computed({read:()=>{if(!this._isLive())return this.rowIndex.peek();const e=this._rowId();return null==e?null:this.viewData.clampIndex(this.viewData.getRowIndexWithSub(e))},write:e=>{const t=null===e?null:this.viewData.clampIndex(e);this._rowId(null==t?null:this.viewData.getRowId(t))}})),this.fieldIndex=e.viewSection.viewFields().makeLiveIndex(t.fieldIndex||0),this.autoDispose(i.createGroup(l.editorCommands,this,e.viewSection.hasFocus)),this._properRowId=this.autoDispose(s.computed((()=>{const e=this.rowIndex();return null===e?null:this.viewData.getRowId(e)}))),this.autoDispose(this._properRowId.subscribe((t=>e.viewSection.activeRowId(t)))),this.onDispose((()=>{e.viewSection.lastCursorPos=this.getCursorPos()})),this.currentPosition=this.autoDispose(s.computed((()=>this._isLive()?this.getCursorPos():{})))}getCursorPos(){return{rowId:r(this._properRowId()),rowIndex:r(this.rowIndex()),fieldIndex:this.fieldIndex(),sectionId:this._sectionId()}}setCursorPos(e){void 0!==e.rowId&&this.viewData.getRowIndex(e.rowId)>=0?this.rowIndex(this.viewData.getRowIndex(e.rowId)):void 0!==e.rowIndex&&e.rowIndex>=0?this.rowIndex(e.rowIndex):this.rowIndex(this.rowIndex.peek()),void 0!==e.fieldIndex&&this.fieldIndex(e.fieldIndex)}setLive(e){this._isLive(e)}};let a=l;a.editorCommands={cursorUp(){this.rowIndex(this.rowIndex()-1)},cursorDown(){this.rowIndex(this.rowIndex()+1)},cursorLeft(){this.fieldIndex(this.fieldIndex()-1)},cursorRight(){this.fieldIndex(this.fieldIndex()+1)},skipUp(){this.rowIndex(this.rowIndex()-5)},skipDown(){this.rowIndex(this.rowIndex()+5)},pageUp(){this.rowIndex(this.rowIndex()-20)},pageDown(){this.rowIndex(this.rowIndex()+20)},prevField(){this.fieldIndex(this.fieldIndex()-1)},nextField(){this.fieldIndex(this.fieldIndex()+1)},moveToFirstRecord(){this.rowIndex(0)},moveToLastRecord(){this.rowIndex(1/0)},moveToFirstField(){this.fieldIndex(0)},moveToLastField(){this.fieldIndex(1/0)}}},11104:(e,t,o)=>{"use strict";o.r(t),o.d(t,{ACIndexImpl:()=>d,buildHighlightedDom:()=>u,highlightNone:()=>c,normalizeText:()=>l});var i=o(83277);const n=o(41469),s=o(8308),r=o(95030);function l(e){return s(e).trim().toLowerCase()}const a=/[\s!"#$%&'()*+,\-./:;<=>?@[\\\]^_`{|}~]+/,c=e=>[e];class d{constructor(e,t=50,o=!1){this._maxResults=t,this._keepOrder=o,this._allItems=e.slice(0);const n=[];for(let e=0;e<this._allItems.length;e++){const t=this._allItems[e].cleanText.split(a).filter((e=>e));for(let o=0;o<t.length;o++)n.push({word:t[o],index:e,pos:o})}n.sort(((e,t)=>(0,i.localeCompare)(e.word,t.word))),this._words=n}search(e){const t=l(e),o=t.split(a).filter((e=>e)),s=new Map;if(o.length>0){for(let e=0;e<o.length;e++){const t=o[e];for(const[o,i]of this._findOverlaps(t,e))s.set(o,(s.get(o)||0)+i)}for(const[e,o]of s)this._allItems[e].cleanText.startsWith(t)&&s.set(e,o+1)}const r=Array.from(s).sort(((e,t)=>(0,i.nativeCompare)(t[1],e[1])||(0,i.nativeCompare)(e[0],t[0]))).slice(0,this._maxResults),d=r.map((([e,t])=>e));for(let e=0;e<this._allItems.length&&d.length<this._maxResults;e++)this._allItems[e].cleanText&&!s.has(e)&&d.push(e);this._keepOrder&&d.sort(i.nativeCompare);const u=d.map((e=>this._allItems[e]));if(!t)return{items:u,highlightFunc:c,selectIndex:-1};const p=h.bind(null,o);let m=r.length>0?d.indexOf(r[0][0]):-1;return m>=0&&!function(e,t,o){if(e.cleanText.startsWith(t))return!0;const i=new RegExp(o.map((e=>"\\b"+n(e))).join(".*")),s=e.cleanText.split(a).join(" ");return i.test(s)}(u[m],t,o)&&(m=-1),{items:u,highlightFunc:p,selectIndex:m}}_findOverlaps(e,t){const o=(0,i.sortedIndex)(this._words,{word:e},((e,t)=>(0,i.localeCompare)(e.word,t.word))),n=new Map;for(const i of[1,-1]){let s=e,r=o+(i>0?0:-1);for(;s&&r>=0&&r<this._words.length;){for(;r>=0&&r<this._words.length;r+=i){const o=this._words[r];if(!o.word.startsWith(s))break;const i=s.length+(o.word===e?1:0)+Math.pow(2,-(t+o.pos));i>=(n.get(o.index)||0)&&n.set(o.index,i)}s=s.slice(0,-1)}}return n}}function u(e,t,o){return e?t(e).map(((e,t)=>t%2?o(e):e)):e}const p=new RegExp(`(${a.source})`);function h(e,t){const o=t.split(p),i=[""];for(let t=0;t<o.length;t+=2){const n=o[t],l=o[t+1]||"",a=m(s(n).toLowerCase(),e);if(0===a)i[i.length-1]+=n+l;else{const e=r(n,"");i.push(e.slice(0,a).join(""),e.slice(a).join("")+l)}}return i}function m(e,t){return t.reduce(((t,o)=>Math.max(t,function(e,t){let o=0;for(;o<e.length&&e[o]===t[o];)++o;return o}(e,o))),0)}},84462:(e,t,o)=>{"use strict";o.d(t,{H:()=>u,R:()=>c});var i=o(11104),n=o(6632),s=o(29922),r=o(7454),l=o(1370),a=o(1310);function c(e,t,...o){const{acIndex:s,valueObs:r,save:c}=t,f=a.Holder.create(e);let g;const b=()=>!f.isEmpty(),v=()=>f.isEmpty()&&n.Autocomplete.create(f,g,D),y=()=>{f.clear(),g.blur()},_=()=>{g.value=r.get(),y()},w=async()=>{await C()||_()},x=()=>{b()?w().catch((()=>{})):v()},C=async()=>{var e;const t=null==(e=f.get())?void 0:e.getSelectedItem();t&&(g.value=t.value),g.disabled=!0;try{return await c(g.value,t),y(),!0}catch(e){return!1}finally{g.disabled=!1}},D={menuCssClass:`${l.menuCssClass} test-acselect-dropdown`,search:async e=>s.search(e),renderItem:(e,t)=>u((0,i.buildHighlightedDom)(e.label,t,m)),getItemText:e=>e.value,onClick:C};return d(g=p({type:"text"},a.dom.prop("value",r),a.dom.on("focus",((e,t)=>t.select())),a.dom.on("blur",w),a.dom.prop("disabled",(e=>!!t.disabled&&e(t.disabled))),a.dom.onKeyDown({Escape:_,Enter:x,ArrowDown:v,Tab:C}),a.dom.on("input",v)),a.dom.on("mousedown",(e=>{var o;e.preventDefault(),(null==(o=t.disabled)?void 0:o.get())||(b()||g.focus(),x())})),h("Dropdown"),...o)}const d=(0,a.styled)("div",`\n  position: relative;\n  width: 100%;\n  height: 30px;\n  color: ${s.theme.selectButtonFg};\n  --icon-color: ${s.theme.selectButtonFg};\n`),u=(0,a.styled)("li",`\n  color: ${s.theme.menuItemFg};\n  display: block;\n  white-space: pre;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  outline: none;\n  padding: var(--weaseljs-menu-item-padding, 8px 24px);\n  cursor: pointer;\n\n  &.selected {\n    background-color: ${s.theme.menuItemSelectedBg};\n    color:            ${s.theme.menuItemSelectedFg};\n  }\n`),p=(0,a.styled)("input",`\n  color: ${s.theme.inputFg};\n  background-color: ${s.theme.inputBg};\n  appearance: none;\n  -webkit-appearance: none;\n  -moz-appearance: none;\n  height: 100%;\n  width: 100%;\n  padding: 0 6px;\n  outline: none;\n  border: 1px solid ${s.theme.inputBorder};\n  border-radius: 3px;\n  cursor: pointer;\n  line-height: 16px;\n  cursor: pointer;\n\n  &:disabled {\n    color: ${s.theme.inputDisabledFg};\n    background-color: ${s.theme.inputDisabledBg};\n  }\n  &:focus {\n    cursor: initial;\n    outline: none;\n    box-shadow: 0px 0px 2px 2px ${s.theme.inputFocus};\n  }\n  &::placeholder {\n    color: ${s.theme.inputPlaceholderFg};\n  }\n`),h=(0,a.styled)(r.icon,"\n  position: absolute;\n  right: 6px;\n  top: calc(50% - 8px);\n"),m=(0,a.styled)("span",`\n  color: ${s.theme.autocompleteMatchText};\n  .selected > & {\n    color: ${s.theme.autocompleteSelectedMatchText};\n  }\n`)},59011:(e,t,o)=>{"use strict";o.r(t),o.d(t,{CustomSectionElement:()=>n,ViewProcess:()=>i.$m});var i=o(42064);class n{static getSections(e){return e.reduce(((e,t)=>{const o=t.definition.manifest.contributions.customSections,i=t.definition.id;if(o){const t=o.map((e=>({sectionId:e.name,pluginId:i})));return e.concat(t)}return e}),[])}static find(e,t){const o=e.definition.manifest.contributions.customSections;if(o){const i=o.find((({name:e})=>e===t));if(i)return e.safeBrowser.createViewProcess(i.path)}}}},96682:(e,t,o)=>{"use strict";o.r(t),o.d(t,{Delay:()=>n});var i=o(88438);class n extends i.Disposable{constructor(){super(...arguments),this._timeoutId=null}static wrapWithDelay(e,t,o){return function(...i){const n=o||this;setTimeout((()=>t.apply(n,i)),e)}}static untilAnimationFrame(e,t){let o=null;const i=function(...i){null===o&&(o=window.requestAnimationFrame((()=>{o=null,e.apply(t,i)})))};return i.dispose=function(){null!==o&&window.cancelAnimationFrame(o)},i}create(){this.autoDisposeCallback(this.cancel)}cancel(){null!==this._timeoutId&&(clearTimeout(this._timeoutId),this._timeoutId=null)}isPending(){return null!==this._timeoutId}schedule(e,t,o,...i){this.cancel(),this._timeoutId=setTimeout((()=>{this._timeoutId=null,t.apply(o,i)}),e)}}},42064:(e,t,o)=>{"use strict";o.d(t,{$m:()=>y,u0:()=>g});var i=o(11527),n=o(81294),s=o.n(n),r=o(50733),l=o(81336),a=o(55688),c=o(63678),d=o(36322),u=o(85090),p=o(18975),h=o(45353),m=o(88438);const f=(0,i.get)("document","window");class g extends a.H6{constructor(e,t,o,i="",n=console,s=(0,a.GO)(n,`PLUGIN ${e.definition.id} SafeBrowser:`)){super(e.definition.manifest,s),this._plugin=e,this._clientScope=t,this._untrustedContentOrigin=o,this._mainPath=i,this._baseLogger=n,this._viewProcesses=new Map,this._viewCount=0,this._pluginId=e.definition.id,this._pluginRpc=e.rpc}static createWorker(e,t,o){return new v(e,t,o)}static createView(e,t,o){return f.window.isRunningUnderElectron?new w(e,t,o):new _(e,t,o)}createViewProcess(e){return this._createViewProcess(e)[0]}receiveAction(e){for(const t of this._viewProcesses.values())t.receiveAction(e)}async renderImpl(e,t,o){const[i,n]=this._createViewProcess(e);return this._plugin.getRenderTarget(t,o)(i.element),this._mainProcess&&this._mainProcess.autoDispose(i),n}async disposeImpl(e){const t=this._viewProcesses.get(e);t&&(this._viewProcesses.delete(e),t.dispose())}doForwardCall(e){if(this._mainProcess)return this._mainProcess.rpc.forwardCall(e);throw new Error("Using SafeBrowser as an IForwarder requires a main script")}doForwardMessage(e){if(this._mainProcess)return this._mainProcess.rpc.forwardMessage(e);throw new Error("Using SafeBrowser as an IForwarder requires a main script")}async activateImplementation(){if(this._mainPath){const e=this._createRpc(this._mainPath),t=`plugins/${this._pluginId}/${this._mainPath}`;this._mainProcess=g.createWorker(this,e,t)}}async deactivateImplementation(){this._mainProcess&&this._mainProcess.dispose()}_createViewProcess(e){const t=this._createRpc(e),o=`${this._untrustedContentOrigin}/plugins/${this._plugin.definition.id}/${e}?host=${f.window.location.origin}`,i=this._viewCount++,n=g.createView(this,t,o);return this._viewProcesses.set(i,n),this._pluginRpc.registerForwarder(e,t),n.autoDisposeCallback((()=>{this._pluginRpc.unregisterForwarder(e),this._viewProcesses.delete(i)})),[n,i]}_createRpc(e){const t=new h.Rpc({logger:(0,a.GO)(this._baseLogger,`PLUGIN ${this._pluginId}/${e} SafeBrowser:`)});return t.queueOutgoingUntilReadyMessage(),(0,a.$o)(t,3e3,"Plugin isn't ready; be sure to call grist.ready() from plugin"),t.registerForwarder("*",this._pluginRpc),this._clientScope.servePlugin(this._pluginId,t),t}}class b extends m.Disposable{create(e,t,o){this.rpc=t,this._safeBrowser=e,this._src=o,this._actionRouter=new l.o(this.rpc);const i={subscribe:(0,c.n)(this._actionRouter.subscribeTable,this._actionRouter),unsubscribe:(0,c.n)(this._actionRouter.unsubscribeTable,this._actionRouter),render:(0,c.n)(this._safeBrowser.renderImpl,this._safeBrowser),dispose:(0,c.n)(this._safeBrowser.disposeImpl,this._safeBrowser)};t.registerImpl(u.X,i,p.C4.GristAPI),this.autoDisposeCallback((()=>{this.rpc.unregisterImpl(u.X)}))}receiveAction(e){this._actionRouter.process(e).catch((e=>console.warn("ClientProcess[%s] receiveAction: failed with %s",this._src,e)))}}class v extends b{create(e,t,o){super.create(e,t,o);const i=new Worker((0,d.getOriginUrl)(`/${o}`));i.addEventListener("message",(e=>this.rpc.receiveMessage(e.data))),this.rpc.setSendMessage(i.postMessage.bind(i)),this.autoDisposeCallback((()=>i.terminate()))}}class y extends b{}class _ extends y{create(e,t,o){super.create(e,t,o);const i=this.element=this.autoDispose(s()("iframe.safe_browser_process.clipboard_focus",{src:o})),n=e=>{e.source===i.contentWindow&&this.rpc.receiveMessage(e.data)};f.window.addEventListener("message",n),this.autoDisposeCallback((()=>{f.window.removeEventListener("message",n)})),this.rpc.setSendMessage((e=>i.contentWindow.postMessage(e,"*")))}}class w extends y{create(e,t,o){super.create(e,t,o);const i=this.element=this.autoDispose(s()("webview.safe_browser_process.clipboard_focus",{src:o,allowpopups:"",partition:"plugins"}));r.setPaused(!0),this.autoDisposeCallback((()=>r.setPaused(!1))),i.addEventListener("ipc-message",(e=>{"grist"===e.channel&&t.receiveMessage(e.args[0])})),this.rpc.setSendMessage((e=>i.send("grist",e)))}}},85842:(e,t,o)=>{"use strict";o.r(t),o.d(t,{copyToClipboard:()=>n,readDataFromClipboard:()=>r,readTextFromClipboard:()=>s});const i=(0,o(11527).get)("document","window");async function n(e){"string"==typeof e?await async function(e){if(i.window.navigator&&i.window.navigator.clipboard&&i.window.navigator.clipboard.writeText)try{return void await i.window.navigator.clipboard.writeText(e)}catch(e){}const t=i.document.createElement("textarea");t.value=e,t.setAttribute("readonly",""),t.style.position="absolute",t.style.left="-10000px",i.document.body.appendChild(t);const o=i.document.getSelection().rangeCount>0&&i.document.getSelection().getRangeAt(0);t.select(),i.document.execCommand("copy"),i.document.body.removeChild(t),o&&(i.document.getSelection().removeAllRanges(),i.document.getSelection().addRange(o))}(e):await async function(e){var t,o;if(!(null==(o=null==(t=i.window.navigator)?void 0:t.clipboard)?void 0:o.write))throw new Error("navigator.clipboard.write is not supported on this browser");await i.window.navigator.clipboard.write([e])}(e)}function s(){var e,t;if(!(null==(t=null==(e=i.window.navigator)?void 0:e.clipboard)?void 0:t.readText))throw new Error("navigator.clipboard.readText is not supported on this browser");return i.window.navigator.clipboard.readText()}function r(){var e,t;if(!(null==(t=null==(e=i.window.navigator)?void 0:e.clipboard)?void 0:t.read))throw new Error("navigator.clipboard.read is not supported on this browser");return i.window.navigator.clipboard.read()}},88101:(e,t,o)=>{"use strict";o.d(t,{b:()=>r});var i=o(92769),n=o(1310),s=o(2996);function r(e,t=i.reportError){const o=s.G.document.createComment("a"),r=s.G.document.createComment("b");return[o,r,i=>{let s=!1;e.then((e=>s||(0,n.replaceContent)(o,r,e))).catch(t),(0,n.onDisposeElem)(r,(()=>{s=!0}))}]}},95163:(e,t,o)=>{"use strict";o.r(t),o.d(t,{KoSaveWrapObs:()=>r,fromKoSave:()=>s});var i=o(1310);const n=new WeakMap;function s(e){return n.get(e)||n.set(e,new r(e)).get(e)}class r extends i.KoWrapObs{constructor(e){if(!("saveOnly"in e))throw new Error("fromKoSave needs a saveable observable");super(e)}set(e){this._koObs.saveOnly(e)}}},59727:(e,t,o)=>{"use strict";o.d(t,{$:()=>n});var i=o(1310);function n(e,t){return(0,i.setDisposeOwner)(e,new s(t))}class s extends i.MutableObsArray{constructor(e){super(Array.from(e.peek())),this._koSub=null,this._koSub=e.subscribe((e=>{const t=e.array.slice(e.start,e.start+e.added);this.splice(e.start,e.deleted.length,...t)}),null,"spliceChange")}dispose(){this._koSub.dispose(),super.dispose()}}},62808:(e,t,o)=>{"use strict";o.d(t,{F:()=>n,S:()=>s});var i=o(1310);function n(e){const t=document.createElement("style");return t.innerHTML=`*{cursor: ${e}!important;}`,t.id="cursor-style",document.head.appendChild(t),{dispose(){this.isDisposed()||document.head.removeChild(t)},isDisposed:()=>!t.isConnected}}function s(e){return t=>{let o=0,s=0;i.dom.onElem(t,"mousedown",(r=>{if(0!==r.button)return;o=r.clientX,s=r.clientY;const l=e.onStart(),a=new i.Holder,c=i.MultiHolder.create(a);i.dom.autoDisposeElem(t,a),c.autoDispose(i.dom.onElem(document,"mousemove",(t=>{const i=t.clientX-o,n=t.clientY-s;e.onMove(i,n,l)}))),c.autoDispose(i.dom.onElem(document,"mouseup",(()=>{var t;null==(t=e.onEnd)||t.call(e),a.clear()}))),c.autoDispose(n("ns-resize")),r.stopPropagation(),r.preventDefault()}),{useCapture:!0})}}},56209:(e,t,o)=>{"use strict";o.d(t,{HD:()=>c,h4:()=>r,hj:()=>l,jn:()=>a});var i=o(83277),n=o(1310),s=o(268);function r(e,t,o,r){let l=!1;const a=(0,s.G)(),c=n.Observable.create(e,function(e){const t=null==e?null:(0,i.safeJsonParse)(e,null);return r(t)?t:o}(a.getItem(t)));return c.addListener((e=>{if(l)return;const i=function(e){return e!==o&&r(e)?JSON.stringify(e):null}(e);null==i?a.removeItem(t):a.setItem(t,i)})),Object.assign(c,{pauseSaving(e){l=e}})}function l(e){return"number"==typeof e}function a(e){return"boolean"==typeof e}function c(e){return"string"==typeof e}},88480:(e,t,o)=>{"use strict";o.d(t,{L:()=>l,n:()=>n.getOptionFull});var i=o(1310),n=o(21467),s=o(6632),r=o(1370);class l extends i.Disposable{constructor(e,t,o,l={}){var u;super(),this._ctl=e,this._items=t,this._action=o,this._selectedIndex=-1;const p=l.renderItem||(e=>(0,n.getOptionFull)(e).label);this.content=(0,n.cssMenuWrap)((0,i.dom)("div",{class:r.menuCssClass+" grist-floating-menu"},n.cssMenu.cls(""),d.cls(""),null==(u=l.headerDom)?void 0:u.call(l),this._menuContent=a(i.dom.forEach(this._items,(e=>{const t=(0,n.getOptionFull)(e);return c({class:r.menuItem.className+" "+n.cssMenuItem.className},i.dom.on("click",(()=>this._doAction(t.value))),p(e),i.dom.cls("disabled",Boolean(t.disabled)),i.dom.data("itemValue",t.value))})))),i.dom.on("mouseleave",(e=>this.setSelected(-1)))),this.autoDispose(t.addListener((()=>this._update()))),this._mouseOver=(0,s.attachMouseOverOnMove)(this._menuContent,(e=>this.setSelected(this._findTargetItem(e.target)))),this._update()}listenKeys(e){this.autoDispose(i.dom.onKeyElem(e,"keydown",{Escape:()=>this._ctl.close(),ArrowDown:()=>this.setSelected(this._getNextSelectable(1)),ArrowUp:()=>this.setSelected(this._getNextSelectable(-1)),Enter:()=>this._doAction(this._getSelectedData())}))}setSelected(e){const t=this._menuContent.children[e]||null,o=this._selected;if(t!==o){const e=n.cssMenuItem.className+"-sel";o&&o.classList.remove(e),t&&(t.classList.add(e),t.scrollIntoView({block:"nearest"}))}this._selected=t,this._selectedIndex=t?e:-1}_update(){var e;null==(e=this._mouseOver)||e.reset()}_findTargetItem(e){const t=(0,s.findAncestorChild)(this._menuContent,e);return(null==t?void 0:t.classList.contains("disabled"))?-1:Array.prototype.indexOf.call(this._menuContent.children,t)}_getSelectedData(){return this._selected?i.dom.getData(this._selected,"itemValue"):null}_doAction(e){e&&this._action(e),this._ctl.close()}_getNext(e,t){const o=this._items.get().length+1,i=(e+t+o)%o;return i===o-1?-1:i}_getNextSelectable(e){var t;let o=this._getNext(this._selectedIndex,e);for(;null==(t=this._menuContent.children[o])?void 0:t.classList.contains("disabled");)o=this._getNext(o,e);return o}}const a=(0,i.styled)("ul","\n  overflow: auto;\n  list-style: none;\n  outline: none;\n  padding: 0;\n  width: 100%;\n  margin: 0;\n"),c=(0,i.styled)("li","\n  white-space: nowrap;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  display: block;\n"),d=(0,i.styled)("div","\n  overflow: hidden;\n  display: flex;\n  flex-direction: column;\n")},52064:(e,t,o)=>{"use strict";o.r(t),o.d(t,{addToSort:()=>c,sortBy:()=>d,updatePositions:()=>u});var i=o(6870),n=o(3871),s=o(631),r=o(11579),l=o(48210);const a=o(49268);function c(e,t,o){const i=e.peek(),n=l.Sort.findColIndex(i,t);-1!==n?i.splice(n,1,t*o):i.push(t*o),e(i)}function d(e,t,o){var i;let n=e.peek();const s=null!=(i=l.Sort.findCol(n,t))?i:t;n=[l.Sort.setColDirection(s,o)],e(n)}async function u(e,t){const o=t.table.peek().tableId.peek(),l=e.getTableModel(o),c=new r.SortFunc(new i.ClientColumnGetters(l,{unversioned:!0}));c.updateSpec(t.activeDisplaySortSpec.peek());const d=n.SortedRowSet.create(null,((e,t)=>c.compare(e,t)),l.tableData);d.subscribeTo(l);const u=d.getKoArray().peek().slice(0);d.dispose();const p={[s.MANUALSORT]:a(0,u.length)};await e.docData.sendActions([["BulkUpdateRecord",o,u,p],["UpdateRecord","_grist_Views_section",t.getRowId(),{sortColRefs:"[]"}]],`Updated table ${o} row positions.`),t.activeSortJson.revert()}},15323:(e,t,o)=>{"use strict";o.r(t),o.d(t,{fieldInsertPositions:()=>d,getDocIdHash:()=>p,makeDeleteAction:()=>g,makePasteHtml:()=>h,makePasteText:()=>u,parsePasteHtml:()=>m});var i=o(11527),n=o(3534),s=o(83277),r=o(79801),l=o(1310);const a=o(90445),c=(0,i.get)("document","DOMParser");function d(e,t,o=1){const i=t<e.peekLength?e.at(t).parentPos():null;return Array(o).fill(i)}function u(e,t){const o=t.rowIds.map((e=>t.columns.map((t=>t.fmtGetter(e)))));return(0,r.tsvEncode)(o)}function p(){const e=window.gristDocPageModel.currentDocId.get();return(0,n.zJ)(e)}function h(e,t,o){const i=t.rowStyle||{},n=t.colStyle||{};return(0,l.dom)("table",{border:"1",cellspacing:"0",style:"white-space: pre","data-grist-doc-id-hash":p()},(0,l.dom)("colgroup",t.colIds.map(((o,i)=>(0,l.dom)("col",{style:f(n[o]),"data-grist-col-ref":String(t.colRefs[i]),"data-grist-col-type":e.getColType(o)})))),o?(0,l.dom)("tr",t.colIds.map((e=>(0,l.dom)("th",e)))):null,t.rowIds.map((e=>(0,l.dom)("tr",{style:f(i[e])},t.columns.map((t=>{const o=t.rawGetter(e),i=t.fmtGetter(e),n=o===i?{}:{"data-grist-raw-value":JSON.stringify(o)};return(0,l.dom)("td",n,i)})))))).outerHTML}function m(e){const t=(new c.DOMParser).parseFromString(e,"text/html").querySelector("table"),o=t.getAttribute("data-grist-doc-id-hash"),i=[...t.querySelectorAll("col")],n=[...t.querySelectorAll("tr")].map((e=>Array.from(e.querySelectorAll("td, th"),((e,t)=>{const n=i[t],r=null==n?void 0:n.getAttribute("data-grist-col-type"),l=n&&Number(n.getAttribute("data-grist-col-ref")),a={displayValue:e.textContent,docIdHash:o,colType:r,colRef:l};return e.hasAttribute("data-grist-raw-value")&&(a.rawValue=(0,s.safeJsonParse)(e.getAttribute("data-grist-raw-value"),a.displayValue)),a})))).filter((e=>e.length>0));if(0===n.length)throw new Error("Unable to parse data from text/html");return n}function f(e){return"object"!=typeof e?"":Object.entries(e).map((([e,t])=>`${e}: ${t};`)).join(" ")}function g(e){const t=e.rowIds.filter((e=>"number"==typeof e));if(0===t.length)return null;const o=t.map((()=>"")),i=e.fields.filter((e=>!e.column().isRealFormula()&&!e.disableEditData())).map((e=>e.colId())),n=e.fields[0].column().table().tableId();return 0===i.length?null:["BulkUpdateRecord",n,t,a(i,i.map((()=>o)))]}},80864:(e,t,o)=>{"use strict";o.r(t),o.d(t,{setTestState:()=>n});const i=(0,o(11527).get)("window");function n(e){"testGrist"in i.window||(i.window.testGrist={}),Object.assign(i.window.testGrist,e)}},56634:(e,t,o)=>{"use strict";o.d(t,{O8:()=>d,QK:()=>h,c5:()=>m,lX:()=>u,IL:()=>p});var i=o(92769),n=o(86391),s=o(83277),r=o(36322),l=o(6015);const a=o(78870),c=o(82238),d=[".grist",".csv",".tsv",".txt",".xlsx",".xlsm"];async function u(e,t=a){t(0);let o=null;const i=window.electronSelectFiles;if("function"==typeof i)o=await i(function(e){const t={filters:[],properties:["openFile"]};if(e.extensions){const o=e.extensions.map((e=>c(e,".")));t.filters.push({name:"Select files",extensions:o})}return e.multiple&&t.properties.push("multiSelections"),t}(e));else{const i=await(0,n.y)(function(e){const t={};return e.multiple&&(t.multiple=e.multiple),e.extensions&&(t.accept=e.extensions.join(",")),t}(e));o=await p(i,e,t)}return t(100),o}async function p(e,t,o=a){if(!e.length)return null;const n=new FormData;for(const t of e)n.append("upload",t);const l=window.gristConfig||{},{maxUploadSizeImport:c,maxUploadSizeAttachment:d}=l;if("import"===t.sizeLimit&&c){if(e.reduce(((e,t)=>e+(t.name.endsWith(".grist")?0:t.size)),0)>c)throw new i.UserError(`Imported files may not exceed ${(0,s.byteString)(c)}`)}else if("attachment"===t.sizeLimit&&d&&e.some((e=>e.size>d)))throw new i.UserError(`Attachments may not exceed ${(0,s.byteString)(d)}`);return new Promise(((e,l)=>{const a=new XMLHttpRequest;a.open("post",(0,r.docUrl)(t.docWorkerUrl,"uploads"),!0),a.setRequestHeader("X-Requested-With","XMLHttpRequest"),a.withCredentials=!0,a.upload.addEventListener("progress",(e=>{e.lengthComputable&&o(e.loaded/e.total*100)})),a.addEventListener("error",(e=>{console.warn("Upload error",e),l(new Error("Upload error"))})),a.addEventListener("load",(()=>{if(200!==a.status){console.warn("Upload failed",a.status,a.responseText);const e=(0,s.safeJsonParse)(a.responseText,null);l(new i.UserError("Upload failed: "+(e&&e.error||a.status)))}else e(JSON.parse(a.responseText))})),a.send(n)}))}async function h(e,t,o,i=a){if(m(t))return e.fetchURL(t,o);let n;try{n=await window.fetch(t)}catch(i){return console.log(`Could not fetch ${t} on the Client, falling back to server fetch: ${i.message}`),e.fetchURL(t,o)}const s=(0,l.basename)(t),r=n.headers.get("content-type"),c=r?{type:r}:{},d=new File([await n.blob()],s,c);return await p([d],{docWorkerUrl:e.docWorkerUrl},i)}function m(e){return e?!!/^https:\/\/(docs|drive).google.com\/(spreadsheets|file)\/d\/([^/]*)/i.exec(e):null}},6870:(e,t,o)=>{"use strict";o.r(t),o.d(t,{ClientColumnGetters:()=>r,ClientColumnGettersByColId:()=>l});var i=o(631),n=o(11579),s=o(48210);class r{constructor(e,t={}){this._tableModel=e,this._options=t}getColGetter(e){var t;const o=this._tableModel.docModel.columns.getRowModel(s.Sort.getColRef(e)),r=o.colId();let l=this._tableModel.tableData.getRowPropFunc(r);if(!l)return null;if(this._options.unversioned&&this._tableModel.tableData.mayHaveVersions()){const e=l;l=t=>{const o=e(t);if(o&&i.isVersions(o)){const e=o[1];return"parent"in e?e.parent:"local"in e?e.local:e.remote}return o}}if(s.Sort.specToDetails(e).orderByChoice&&"Choice"===o.pureType()){const e=(null==(t=o.widgetOptionsJson.peek())?void 0:t.choices)||[];l=(0,n.choiceGetter)(l,e)}return l}getManualSortGetter(){const e=this._tableModel.tableMetaRow.columns().peek().find((e=>e.colId()===i.MANUALSORT));return e?this.getColGetter(e.getRowId()):null}}class l{constructor(e){this._tableData=e}getColGetterByColId(e){return this._tableData.getRowPropFunc(e)}}},45051:(e,t,o)=>{"use strict";o.r(t),o.d(t,{ALL_INCLUSIVE_FILTER_JSON:()=>c,ColumnFilter:()=>a,NEW_FILTER_JSON:()=>d});var i=o(91655),n=o(34903),s=o(75083),r=o(83277),l=o(1310);class a extends l.Disposable{constructor(e,t="",o="",i=[]){super(),this._initialFilterJson=e,this._columnType=t,this.visibleColumnType=o,this._allValues=i,this.min=l.Observable.create(this,void 0),this.max=l.Observable.create(this,void 0),this.filterFunc=l.Observable.create(this,(()=>!0)),this.isInclusionFilter=l.Computed.create(this,this.filterFunc,(()=>this._include)),this.state=l.Computed.create(this,this.filterFunc,(()=>this._getState())),this.isRange=l.Computed.create(this,this.filterFunc,(()=>this._isRange())),this.setState(e),this.autoDispose(this.min.addListener((()=>this._updateState()))),this.autoDispose(this.max.addListener((()=>this._updateState())))}get columnType(){return this._columnType}get initialFilterJson(){return this._initialFilterJson}setState(e){const t=(0,n.nR)(e);(0,n.xX)(t)?(this.min.set(t.min),this.max.set(t.max),this._include=!1,this._values=new Set):(this.min.set(void 0),this.max.set(void 0),this._include=t.include,this._values=t.values),this._updateState()}includes(e){return this.filterFunc.get()(e)}add(e){this.addMany([e])}addMany(e){this._toValues();for(const t of e)this._include?this._values.add(t):this._values.delete(t);this._updateState()}delete(e){this.deleteMany([e])}deleteMany(e){this._toValues();for(const t of e)this._include?this._values.delete(t):this._values.add(t);this._updateState()}clear(){this._values.clear(),this._include=!0,this._updateState()}selectAll(){this._values.clear(),this._include=!1,this._updateState()}makeFilterJson(){let e;if(void 0!==this.min.get()||void 0!==this.max.get())e={min:this.min.get(),max:this.max.get()};else{const t=Array.from(this._values).sort(r.nativeCompare);e={[this._include?"included":"excluded"]:t}}return JSON.stringify(e)}hasChanged(){return this.makeFilterJson()!==this._initialFilterJson}getBoundsValue(e){const t=this[e].get();return void 0===t?"min"===e?-1/0:1/0:(0,n.CV)(t)?(0,s.ZW)(t):t}_updateState(){this.filterFunc.set((0,i.o)(this._getState(),this._columnType))}_getState(){return{include:this._include,values:this._values,min:this.min.get(),max:this.max.get()}}_isRange(){return(0,n.xX)(this._getState())}_toValues(){if(this._isRange()){const e=this.filterFunc.get(),t=this._include?{included:this._allValues.filter((t=>e(t)))}:{excluded:this._allValues.filter((t=>!e(t)))};this.setState(t)}}}const c='{"excluded":[]}',d="{}"},82882:(e,t,o)=>{"use strict";o.d(t,{V:()=>n});var i=o(49142);class n{constructor(e){var t,o,n,s,r,l,a;this.name="string"==typeof e?e:e.name,this.title="string"==typeof e?e:null!=(t=e.title)?t:e.name,this.description="string"==typeof e?"":null!=(o=e.description)?o:"",this.optional="string"!=typeof e&&null!=(n=e.optional)&&n,this.type="string"==typeof e?"Any":null!=(s=e.type)?s:"Any",this.typeDesc=String(null!=(l=null==(r=i.UD[this.type])?void 0:r.label)?l:"any").toLowerCase(),this.allowMultiple="string"!=typeof e&&null!=(a=e.allowMultiple)&&a}canByMapped(e){return e===this.type||"Any"===e||"Any"===this.type}}},92517:(e,t,o)=>{"use strict";o.r(t),o.d(t,{DataRowModel:()=>l});var i=o(33620),n=o(55424),s=o.n(n),r=o(29301);class l extends(s()){constructor(e,t){super(e,t),this.cells=this;const o=e.tableMetaRow.validations;this._isAddRow=r.observable(!1),this._isRealChange=r.observable(!0),this._validationFailures=this.autoDispose(r.pureComputed((()=>o().all().filter((e=>!this.cells[this.getValidationNameFromId(e.id())]())))))}getValidationNameFromId(e){return"validation___"+e}async updateColValues(e){const t=this._isAddRow.peek()?["AddRecord",null,e]:["UpdateRecord",this._rowId,e];try{return await this._table.sendTableAction(t)}finally{Object.keys(e).forEach((e=>this._assignColumn(e)))}}assign(e){this._rowId=e,this._isAddRow("new"===e),this._isRealChange(!1),setTimeout((()=>this.isDisposed()||this._isRealChange(!0)),0),null!==this._rowId&&this._fields.forEach((e=>this._assignColumn(e)))}_assignColumn(e){if(!this.isDisposed()&&this.hasOwnProperty(e)){const t="new"!==this._rowId&&this._rowId?this._table.tableData.getValue(this._rowId,e):"";i.withKoUtils(this.cells[e]).assign(t)}}}},89971:(e,t,o)=>{"use strict";o.r(t),o.d(t,{DataTableModelWithDiff:()=>c,ExtraRows:()=>a,TableDataWithDiff:()=>d});var i=o(41367),n=o.n(i),s=o(549),r=o(9072),l=o(6263);class a{constructor(e,t){var o,i,n,s,r,l,a,c;this.tableId=e,this.comparison=t;const d=h(e,t);this.leftTableDelta=null==(i=null==(o=this.comparison)?void 0:o.leftChanges)?void 0:i.tableDeltas[e],d&&(this.rightTableDelta=null==(s=null==(n=this.comparison)?void 0:n.rightChanges)?void 0:s.tableDeltas[d]),this.rightAddRows=new Set(null==(r=this.rightTableDelta)?void 0:r.addRows.map((e=>2*-e-1))),this.rightRemoveRows=new Set(null==(l=this.rightTableDelta)?void 0:l.removeRows),this.leftAddRows=new Set(null==(a=this.leftTableDelta)?void 0:a.addRows),this.leftRemoveRows=new Set(null==(c=this.leftTableDelta)?void 0:c.removeRows.map((e=>2*-e-2)))}static interpretRowId(e){return e>=0?{type:"shared",id:e}:-1===e?{type:"skipped",id:e}:e%2!=0?{type:"remote-add",id:-(e+1)/2}:{type:"local-remove",id:-(e+2)/2}}getExtraRows(){return[...this.rightAddRows].concat([...this.leftRemoveRows])}getRowType(e){return this.rightAddRows.has(e)?"remote-add":this.leftAddRows.has(e)?"local-add":this.rightRemoveRows.has(e)?"remote-remove":this.leftRemoveRows.has(e)?"local-remove":""}}class c extends r.G{constructor(e,t){super(),this.core=e,this.tableMetaRow=e.tableMetaRow,this.tableQuerySets=e.tableQuerySets,this.docModel=e.docModel;const o=e.tableData.tableId,i=h(o,t)||"";this.tableData=new d(e.tableData,t.leftChanges.tableDeltas[o]||(0,s.dB)(),t.rightChanges.tableDeltas[i]||(0,s.dB)()),this.isLoaded=e.isLoaded,this._wrappedModel=new(n())(this.docModel,this.tableData,this.tableMetaRow)}createLazyRowsModel(e,t){return this._wrappedModel.createLazyRowsModel(e,t)}createFloatingRowModel(e){return this._wrappedModel.createFloatingRowModel(e)}fetch(e){return this.core.fetch(e)}getAllRows(){return this.core.getAllRows()}getNumRows(){return this.core.getNumRows()}getRowGrouping(e){return this.core.getRowGrouping(e)}sendTableActions(e,t){return this.core.sendTableActions(e,t)}sendTableAction(e,t){return this.core.sendTableAction(e,t)}}class d{constructor(e,t,o){this.core=e,this.leftTableDelta=t,this.rightTableDelta=o,this.dataLoadedEmitter=e.dataLoadedEmitter,this.tableActionEmitter=e.tableActionEmitter,this._leftRemovals=new Set(t.removeRows),this._rightRemovals=new Set(o.removeRows),this._updates=new Set([...t.updateRows.filter((e=>!this._rightRemovals.has(e))),...o.updateRows.filter((e=>!this._leftRemovals.has(e)))])}getColIds(){return this.core.getColIds()}sendTableActions(e,t){return this.core.sendTableActions(e,t)}sendTableAction(e,t){return this.core.sendTableAction(e,t)}getRowPropFunc(e){const t=this.core.getRowPropFunc(e);return t?o=>"new"!==o&&(o<0||this._updates.has(o))?this.getValue(o,e):t(o):t}getKeepFunc(){return e=>"new"===e||this._updates.has(e)||e<0||this._leftRemovals.has(e)||this._rightRemovals.has(e)}getSkipRowId(){return-1}mayHaveVersions(){return!0}getValue(e,t){var o,i,n,s;if(-1===e&&"id"!==t)return[l.w.Skip];if(this._updates.has(e)){const n=null==(o=this.leftTableDelta.columnDeltas[t])?void 0:o[e],s=null==(i=this.rightTableDelta.columnDeltas[t])?void 0:i[e];if(void 0!==n&&void 0!==s)return[l.w.Versions,{parent:u(n),local:p(n),remote:p(s)}];if(void 0!==s)return[l.w.Versions,{parent:u(s),remote:p(s)}];if(void 0!==n)return[l.w.Versions,{parent:u(n),local:p(n)}]}else{if("id"===t)return e;const{type:o,id:i}=a.interpretRowId(e);if("remote-add"===o){const e=null==(n=this.rightTableDelta.columnDeltas[t])?void 0:n[i];return void 0!==e?p(e):void 0}if("local-remove"===o){const e=null==(s=this.leftTableDelta.columnDeltas[t])?void 0:s[i];return void 0!==e?u(e):void 0}}return this.core.getValue(e,t)}get tableId(){return this.core.tableId}numRecords(){return this.core.numRecords()}}function u(e){var t;return"?"===e[0]?null:null==(t=e[0])?void 0:t[0]}function p(e){var t;return"?"===e[1]?null:null==(t=e[1])?void 0:t[0]}function h(e,t){if(!t)return e;const o=(0,s.Yo)(t.leftChanges.tableRenames,e);return(0,s.d)(t.rightChanges.tableRenames,o)}},25192:(e,t,o)=>{"use strict";o.r(t),o.d(t,{DynamicQuerySet:()=>v,QuerySet:()=>y,QuerySetManager:()=>b,TableQuerySets:()=>_,getFilterFunc:()=>w});var i=o(6870),n=o(3871),s=o(83277),r=o(8954),l=o(43967),a=o(63678),c=o(1310),d=o(29301),u=Object.defineProperty,p=Object.getOwnPropertySymbols,h=Object.prototype.hasOwnProperty,m=Object.prototype.propertyIsEnumerable,f=(e,t,o)=>t in e?u(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;const g=o(88466);class b extends c.Disposable{constructor(e,t){super(),this._docModel=e,this._queryMap=this.autoDispose(new r.i({create:o=>y.create(null,e,t,o,this),dispose:(e,t)=>t.dispose(),gracePeriodMs:6e4}))}useQuerySet(e,t){const o=(i=function(e,t){var o;const i=null==(o=Object.values(e.dataTables).find((e=>e.tableData.tableId===t.tableId)))?void 0:o.tableMetaRow;if(!i)throw new Error(`Table ${t.tableId} not found`);const n={id:"id"};for(const e of i.columns.peek().peek())n[e.colId.peek()]=e.getRowId();const r=Object.keys(t.filters).map((e=>{const o=t.filters[e];return o.sort(s.nativeCompare),[n[e],t.operations[e],o]}));return r.sort(((e,t)=>(0,s.nativeCompare)(e[0],t[0])||(0,s.nativeCompare)(e[1],t[1]))),{tableRef:i.getRowId(),filterTuples:r}}(this._docModel,t),JSON.stringify([i.tableRef,i.filterTuples]));var i;const n=this._queryMap.use(o);return e.autoDispose(n),n.get()}purgeKey(e){this._queryMap.purgeKey(e)}testSetGracePeriodMs(e){return this._queryMap.testSetGracePeriodMs(e)}}class v extends n.RowSource{constructor(e,t){super(),this._querySetManager=e,this._tableModel=t,this._holder=c.Holder.create(this),this._updateQuerySetDebounced=g((0,a.n)(this._updateQuerySet,this),0)}getAllRows(){return this._querySet?this._querySet.getAllRows():[]}getNumRows(){return this._querySet?this._querySet.getNumRows():0}get isTruncated(){return!!this._querySet&&this._querySet.isTruncated}makeQuery(e,t,o){const i={tableId:this._tableModel.tableData.tableId,filters:e,operations:t},n=this._querySetManager.useQuerySet(this._holder,i);n.fetchPromise.then((()=>{this._updateQuerySetDebounced(n,o)})).catch((e=>{o(e,!1)}))}_updateQuerySet(e,t){try{if(e!==this._querySet){const t=this._querySet;this._querySet=e,t&&(this.stopListening(t,"rowChange"),this.stopListening(t,"rowNotify"),this.trigger("rowChange","remove",t.getAllRows())),this.trigger("rowChange","add",this._querySet.getAllRows()),this.listenTo(this._querySet,"rowNotify",(0,a.n)(this.trigger,this,"rowNotify")),this.listenTo(this._querySet,"rowChange",(0,a.n)(this.trigger,this,"rowChange"))}t(null,!0)}catch(e){t(e,!0)}}}class y extends n.BaseFilteredRowSource{constructor(e,t,o,i){const n=function(e){const[t,o]=JSON.parse(e);return{tableRef:t,filterTuples:o}}(o),s=function(e,t){const o=e.dataTablesByRef.get(t.tableRef).tableMetaRow,i={},n={};for(const[o,s,r]of t.filterTuples){const t="id"===o?"id":e.columns.getRowModel(o).colId.peek();i[t]=r,n[t]=s}return{tableId:o.tableId.peek(),filters:i,operations:n}}(e,n);super(w(e.docData,s)),this.isTruncated=!1;const r=this.autoDispose(function(e,t){const o=e.tables.getRowModel(t.tableRef)._isDeleted,i=t.filterTuples.map((([t,,])=>"id"===t?null:e.columns.getRowModel(t)._isDeleted));return d.computed((()=>Boolean(o()||i.some((e=>null==e?void 0:e())))))}(e,n));this.autoDispose(r.subscribe((e=>{e&&i.purgeKey(o)})));const l=e.dataTables[s.tableId],a=Object.keys(s.filters);if(a.length>0){const e=Math.floor(500/a.length);for(const t of a){const o=s.filters[t];o.length>e&&(s.filters[t]=o.slice(0,e),this.isTruncated=!0)}}let c;if(l.tableMetaRow.onDemand()){const e=l.tableQuerySets;c=t.useQuerySet(((e,t)=>{for(var o in t||(t={}))h.call(t,o)&&f(e,o,t[o]);if(p)for(var o of p(t))m.call(t,o)&&f(e,o,t[o]);return e})({limit:1e4},s)).then((o=>{o.tableData[2].length>=1e4&&(this.isTruncated=!0),this.onDispose((()=>{t.disposeQuerySet(o.querySubId).catch((e=>{console.log(`Promise rejected for disposeQuerySet: ${e.message}`)})),e.removeQuerySet(this)})),e.addQuerySet(this,o.tableData)}))}else c=l.fetch(!1);this.fetchPromise=c.then((()=>this.subscribeTo(l)))}}class _{constructor(e){this._tableData=e,this._querySets=new Set}addQuerySet(e,t){this._querySets.add(e),this._tableData.loadPartial(t)}removeQuerySet(e){this._querySets.delete(e);const t=new Set(e.getAllRows());for(const e of this._querySets)for(const o of e.getAllRows())t.delete(o);this._tableData.unloadPartial(Array.from(t))}}function w(e,t){const o=e.getTable(t.tableId),n=new i.ClientColumnGettersByColId(o),s=(0,l.O)(n,t);return e=>"new"!==e&&s(e)}},98548:(e,t,o)=>{"use strict";o.r(t),o.d(t,{SectionFilter:()=>r});var i=o(91655),n=o(43967),s=o(1310);class r extends s.Disposable{constructor(e,t){super(),this.viewSection=e,this._tableData=t,this._openFilterOverride=s.Observable.create(this,null),this._tempRows=(0,s.obsArray)();const o=s.Computed.create(this,this._openFilterOverride,((e,t)=>{const o=t&&e(t.colFilter.filterFunc);return this._buildPlainFilterFunc((function(e,i){return(null==t?void 0:t.colRef)===e.origCol().getRowId()?o:i}),e)}));this.sectionFilterFunc=s.Computed.create(this,o,this._tempRows,((e,t,o)=>this._addRowsToFilter(t,o))),this.autoDispose(o.addListener((e=>{this._tempRows.set(this._tempRows.get().filter((t=>!e(t))))})))}setFilterOverride(e,t){this._openFilterOverride.set({colRef:e,colFilter:t}),t.onDispose((()=>{const e=this._openFilterOverride.get();e&&e.colFilter===t&&this._openFilterOverride.set(null)}))}addTemporaryRow(e){this.sectionFilterFunc.get()(e)||this._tempRows.push(e)}resetTemporaryRows(){this._tempRows.set([])}buildFilterFunc(e,t){return this._addRowsToFilter(this._buildPlainFilterFunc(e,t),this._tempRows.get())}_addRowsToFilter(e,t){return o=>t.includes(o)||"number"!=typeof o||e(o)}_buildPlainFilterFunc(e,t){const o=t(this.viewSection.filters).map((({filter:o,fieldOrColumn:s})=>{const r=(0,i.v)(t(o),t(t(s.origCol).type)),l=e(s,r),a=this._tableData.getRowPropFunc(s.colId.peek());return l&&a?(0,n.X)(a,l):null})).filter((e=>null!==e));return e=>o.every((t=>Boolean(t&&t(e))))}}},53186:(e,t,o)=>{"use strict";o.r(t),o.d(t,{CombinedStyle:()=>i});class i{constructor(e,t){var o,i,n,s,r,l;for(let a=0;a<e.length;a++)if(t[a]){const t=null==(o=e[a])?void 0:o.textColor,c=null==(i=e[a])?void 0:i.fillColor,d=null==(n=e[a])?void 0:n.fontBold,u=null==(s=e[a])?void 0:s.fontUnderline,p=null==(r=e[a])?void 0:r.fontItalic,h=null==(l=e[a])?void 0:l.fontStrikethrough;this.textColor=t||this.textColor,this.fillColor=c||this.fillColor,this.fontBold=d||this.fontBold,this.fontUnderline=u||this.fontUnderline,this.fontItalic=p||this.fontItalic,this.fontStrikethrough=h||this.fontStrikethrough}}}},3871:(e,t,o)=>{"use strict";o.r(t),o.d(t,{ALL:()=>a,ArrayRowSource:()=>p,BaseFilteredRowSource:()=>f,ExtendedRowSource:()=>m,FilteredRowSource:()=>g,MappedRowSource:()=>h,RowGrouping:()=>y,RowListener:()=>u,RowSource:()=>c,RowWatcher:()=>w,SortedRowSet:()=>_});var i=o(13988),n=o.n(i),s=o(9072),r=o(83277),l=o(1310);const a=Symbol("ALL");class c extends s.G{}const d={add:"onAddRows",remove:"onRemoveRows",update:"onUpdateRows"};class u extends s.G{subscribeTo(e){this.onAddRows(e.getAllRows()),this.listenTo(e,"rowChange",((e,t)=>{this[d[e]](t)})),this.listenTo(e,"rowNotify",this.onRowNotify)}unsubscribeFrom(e){this.stopListening(e,"rowChange"),this.stopListening(e,"rowNotify"),this.onRemoveRows(e.getAllRows())}onAddRows(e){}onRemoveRows(e){}onUpdateRows(e){}onRowNotify(e,t){this.trigger("rowNotify",e,t)}}class p extends c{constructor(e){super(),this._rows=e}getAllRows(){return this._rows}getNumRows(){return this._rows.length}}class h extends c{constructor(e,t){super(),this.parentRowSource=e,this._mapperFunc=e=>t(e),this.listenTo(e,"rowChange",((e,t)=>{this.trigger("rowChange",e,Array.from(t,this._mapperFunc))})),this.listenTo(e,"rowNotify",((e,t)=>{this.trigger("rowNotify",e===a?a:Array.from(e,this._mapperFunc),t)}))}getAllRows(){return Array.from(this.parentRowSource.getAllRows(),this._mapperFunc)}getNumRows(){return this.parentRowSource.getNumRows()}}class m extends c{constructor(e,t){super(),this.parentRowSource=e,this.extras=t,this.listenTo(e,"rowChange",((e,t)=>{this.trigger("rowChange",e,t)})),this.listenTo(e,"rowNotify",((e,t)=>{this.trigger("rowNotify",e===a?a:e,t)}))}getAllRows(){return[...this.parentRowSource.getAllRows()].concat(this.extras)}getNumRows(){return this.parentRowSource.getNumRows()+this.extras.length}}class f extends u{constructor(e){super(),this._filterFunc=e,this._matchingRows=new Set}getAllRows(){return this._matchingRows.values()}getNumRows(){return this._matchingRows.size}onAddRows(e){const t=[];for(const o of e)this._filterFunc(o)?(this._matchingRows.add(o),t.push(o)):this._addExcludedRow(o);t.length>0&&this.trigger("rowChange","add",t)}onRemoveRows(e){const t=[];for(const o of e)this._matchingRows.delete(o)&&t.push(o),this._deleteExcludedRow(o);t.length>0&&this.trigger("rowChange","remove",t)}onUpdateRows(e){const t=this._updateRowsHelper({},e);t.removes&&this.trigger("rowChange","remove",t.removes),t.updates&&this.trigger("rowChange","update",t.updates),t.adds&&this.trigger("rowChange","add",t.adds)}onRowNotify(e,t){if(e===a)this.trigger("rowNotify",a,t);else{const o=[];for(const t of e)this._matchingRows.has(t)&&o.push(t);o.length>0&&this.trigger("rowNotify",o,t)}}_updateRowsHelper(e,t){for(const o of t)this._filterFunc(o)?this._matchingRows.has(o)?(e.updates||(e.updates=[])).push(o):this._deleteExcludedRow(o)&&(this._matchingRows.add(o),(e.adds||(e.adds=[])).push(o)):this._matchingRows.delete(o)&&(this._addExcludedRow(o),(e.removes||(e.removes=[])).push(o));return e}_addExcludedRow(e){}_deleteExcludedRow(e){return!0}}class g extends f{constructor(){super(...arguments),this._excludedRows=new Set}updateFilter(e){this._filterFunc=e;const t={};this._updateRowsHelper(t,this._matchingRows),this._updateRowsHelper(t,this._excludedRows),t.removes&&this.trigger("rowChange","remove",t.removes),t.adds&&this.trigger("rowChange","add",t.adds)}refilterRows(e){const t=this._updateRowsHelper({},e);t.removes&&this.trigger("rowChange","remove",t.removes),t.adds&&this.trigger("rowChange","add",t.adds)}getHiddenRows(){return this._excludedRows.values()}_addExcludedRow(e){this._excludedRows.add(e)}_deleteExcludedRow(e){return this._excludedRows.delete(e)}}class b extends c{constructor(e){super(),this.groupValue=e,this._rows=new Set}getAllRows(){return this._rows.values()}getNumRows(){return this._rows.size}_addAll(e){for(const t of e)this._rows.add(t)}_removeAll(e){for(const t of e)this._rows.delete(t)}}function v(e,t,o){let i=e.get(t);i||e.set(t,i=[]),i.push(o)}class y extends u{constructor(e){super(),this._groupFunc=e,this._rowsToValues=new Map,this._valuesToGroups=new Map,this.onDispose((()=>{for(const e of this._valuesToGroups.values())e.dispose()}))}getGroup(e){let t=this._valuesToGroups.get(e);return t||(t=new b(e),this._valuesToGroups.set(e,t)),t}onAddRows(e){const t=new Map;for(const o of e){const e=this._groupFunc(o);v(t,e,o),this._rowsToValues.set(o,e)}t.forEach(((e,t)=>{const o=this.getGroup(t);o._addAll(e),o.trigger("rowChange","add",e)}))}onRemoveRows(e){const t=new Map;for(const o of e)v(t,this._rowsToValues.get(o),o),this._rowsToValues.delete(o);t.forEach(((e,t)=>{const o=this._valuesToGroups.get(t);o._removeAll(e),o.trigger("rowChange","remove",e)}))}onUpdateRows(e){let t,o,i;for(const n of e){const e=this._rowsToValues.get(n),s=this._groupFunc(n);s===e?v(t||(t=new Map),e,n):(this._rowsToValues.set(n,s),v(o||(o=new Map),e,n),v(i||(i=new Map),s,n))}o&&o.forEach(((e,t)=>{const o=this._valuesToGroups.get(t);o._removeAll(e),o.trigger("rowChange","remove",e)})),t&&t.forEach(((e,t)=>{this._valuesToGroups.get(t).trigger("rowChange","update",e)})),i&&i.forEach(((e,t)=>{const o=this.getGroup(t);o._addAll(e),o.trigger("rowChange","add",e)}))}onRowNotify(e,t){if(e===a)for(const e of this._valuesToGroups.values())e.trigger("rowNotify",a,t);else{const o=new Map;for(const t of e)v(o,this._rowsToValues.get(t),t);o.forEach(((e,o)=>{this._valuesToGroups.get(o).trigger("rowNotify",e,t)}))}}}class _ extends u{constructor(e,t){super(),this._compareFunc=e,this._skippableRows=t,this._allRows=new Set,this._isPaused=!1,this._koArray=this.autoDispose(n()()),this._keepFunc=null==t?void 0:t.getKeepFunc()}getKoArray(){return this._koArray}pause(e){!e&&this._isPaused&&this._koArray.assign(Array.from(this._allRows).sort(this._compareFunc)),this._isPaused=Boolean(e)}updateSort(e){this._compareFunc=e,this._isPaused||this._koArray.assign(Array.from(this._koArray.peek()).sort(this._compareFunc))}onAddRows(e){for(const t of e)this._allRows.add(t);if(!this._isPaused)if(this._canChangeIncrementally(e))for(const t of e){const e=(0,r.sortedIndex)(this._koArray.peek(),t,this._compareFunc);this._koArray.splice(e,0,t)}else this._koArray.assign(this._keep(Array.from(this._allRows).sort(this._compareFunc)))}onRemoveRows(e){for(const t of e)this._allRows.delete(t);if(!this._isPaused)if(this._canChangeIncrementally(e))for(const t of e){const e=this._koArray.peek().indexOf(t);-1!==e&&this._koArray.splice(e,1)}else this._koArray.assign(this._keep(Array.from(this._allRows).sort(this._compareFunc)))}onUpdateRows(e){if(this._isPaused)return;const t=Array.from(e).sort(this._compareFunc);(function(e,t,o,i){let n=0;for(const s of o){if(!t.has(s))continue;const o=e.indexOf(s,n);if(-1===o||!x(e,o,i))return!1;n=o}return!0})(this._koArray.peek(),this._allRows,t,this._compareFunc)||(this._canChangeIncrementally(e)?(this.onRemoveRows(e),this.onAddRows(e)):this._koArray.assign(this._keep(Array.from(this._koArray.peek()).sort(this._compareFunc))))}_canChangeIncrementally(e){return!this._keepFunc&&function(e){return Array.isArray(e)&&e.length<=2}(e)}_keep(e,t=2){var o;if(!this._keepFunc)return e;const i=e.map(this._keepFunc),n=e.map((()=>!1)),s=e.length;s>=1&&(i[0]=!0),s>=2&&(i[s-1]=!0);let r=-t-1;for(let e=0;e<s;e++)i[e]?r=e:e-r<=t&&(i[e]=!0);r=s+t+1;for(let e=s-1;e>=0;e--)i[e]?r=e:r-e<=t&&(i[e]=!0);let l=!1;for(let e=0;e<s;e++)i[e]?l=!1:l||(n[e]=!0,l=!0);const a=(null==(o=this._skippableRows)?void 0:o.getSkipRowId())||0;return e.map(((e,t)=>n[t]?a:e)).filter(((e,t)=>i[t]||n[t]||"new"===e))}}class w extends u{constructor(){super(...arguments),this.rowFilter=l.Observable.create(this,(()=>!1)),this._rowCounter=new Map}clear(){this._rowCounter.clear(),this.rowFilter.set((()=>!1)),this.stopListening()}onAddRows(e){for(const t of e)this._rowCounter.set(t,(this._rowCounter.get(t)||0)+1);this.rowFilter.set((e=>{var t;return(null!=(t=this._rowCounter.get(e))?t:0)>0}))}onRemoveRows(e){for(const t of e)this._rowCounter.set(t,(this._rowCounter.get(t)||0)-1);this.rowFilter.set((e=>{var t;return(null!=(t=this._rowCounter.get(e))?t:0)>0}))}}function x(e,t,o){const i=e[t];return(0===t||o(e[t-1],i)<=0)&&(t===e.length-1||o(i,e[t+1])<=0)}},85050:(e,t,o)=>{"use strict";o.d(t,{Lh:()=>l,mm:()=>a});var i=o(62802),n=o(29922),s=o(36322),r=o(1310);function l(e,t,...o){const{gristTheme:n,placeholder:l,maxLines:a}=t,{enableCustomCss:d}=(0,s.getGristConfig)(),u=i.require("ace/ext/static_highlight"),p=i.require("ace/mode/python").Mode,h=i.require("ace/lib/dom"),m=i.require("ace/theme/chrome"),f=i.require("ace/theme/dracula"),g=new p,b=r.Observable.create(null,""),v=r.Observable.create(null,n.get());function y(e){let t,o,i=b.get();if(!i)return void(e.textContent=l||"");if(a){const e=i.split(/\n/);e.length>a&&(i=e.slice(0,a).join("\n")+" …")}"dark"!==v.get().appearance||d?(t="chrome",o=m):(t="dracula",o=f);const{html:n,css:s}=u.render(i,g,o,1,!0);e.innerHTML=n,h.importCssString(s,`${t}-highlighted-code`)}return c(r.dom.autoDispose(b),r.dom.autoDispose(v),(t=>(0,r.subscribeElem)(t,e,(e=>{b.set(e),y(t)}))),(e=>(0,r.subscribeElem)(e,n,(t=>{v.set(t),y(e)}))),...o)}o(32806),o(99102),o(54021),o(25081);const a=(0,r.styled)("div",`\n  font-family: 'Monaco', 'Menlo', monospace;\n  font-size: ${n.vars.smallFontSize};\n  background-color: ${n.theme.highlightedCodeBlockBg};\n  &[disabled], &.disabled {\n    background-color: ${n.theme.highlightedCodeBlockBgDisabled};\n  }\n`),c=(0,r.styled)(a,`\n  position: relative;\n  white-space: pre;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  border: 1px solid ${n.theme.highlightedCodeBorder};\n  border-radius: 3px;\n  min-height: 28px;\n  padding: 5px 6px;\n  color: ${n.theme.highlightedCodeFg};\n\n  &.disabled, &.disabled .ace-chrome, &.disabled .ace-dracula {\n    background-color: ${n.theme.highlightedCodeBgDisabled};\n  }\n  & .ace_line {\n    overflow: hidden;\n    text-overflow: ellipsis;\n  }\n`);(0,r.styled)(l,`\n  flex: auto;\n  cursor: pointer;\n  margin-top: 4px;\n  padding-left: 24px;\n  --icon-color: ${n.theme.accentIcon};\n\n  &-disabled-icon.formula_field_sidepane::before {\n    --icon-color: ${n.theme.iconDisabled};\n  }\n  &-disabled {\n    pointer-events: none;\n  }\n`)},62905:(e,t,o)=>{"use strict";o.r(t),o.d(t,{attachColumnFilterMenu:()=>Oe,columnFilterMenu:()=>xe,createFilterMenu:()=>ke,cssItemValue:()=>Ve});var i,n=o(77709),s=o(29813),r=o(70387),l=o(45051),a=o(11104),c=o(1310);const d=o(41469),u=o(37707),p=new Intl.Collator("en-US",{numeric:!0}).compare;class h extends c.Disposable{constructor(e){super(),this._params=e,this.columnFilter=this._params.columnFilter,this.filterInfo=this._params.filterInfo,this.gristDoc=this._params.gristDoc,this.initialPinned=this.filterInfo.isPinned.peek(),this.limitShown=null!=(i=this._params.limitShow)?i:500,this.searchValue=c.Observable.create(this,""),this.isSortedByCount=c.Observable.create(this,!1),this.filterSet=c.Computed.create(this,this.searchValue,((e,t)=>{const o=new RegExp(d((0,a.normalizeText)(t)),"i"),i=["Bool","Choice","ChoiceList"].includes(this.columnFilter.columnType);return new Set(this._params.valueCount.filter((([e,{label:t,count:n}])=>(!!i||n)&&o.test((0,a.normalizeText)(t)))).map((([e])=>e)))})),this.filteredValues=c.Computed.create(this,this.filterSet,this.isSortedByCount,((e,t,o)=>{const i=o?"count":"displayValue";let n=u;return["Date","DateTime","Numeric","Int"].includes(this.columnFilter.visibleColumnType)&&(n=e=>u(e)||isNaN(e)),this._params.valueCount.filter((([e])=>t.has(e))).sort(((e,t)=>((e,t)=>n(e)?-1:n(t)?1:p(e,t))(e[1][i],t[1][i])))})),this.otherValues=c.Computed.create(this,this.filterSet,((e,t)=>this._params.valueCount.filter((([e])=>!t.has(e))))),this.filteredKeys=c.Computed.create(this,this.filterSet,((e,t)=>this._params.valueCount.filter((([e])=>t.has(e))).map((([e])=>e)))),this.valuesBeyondLimit=c.Computed.create(this,this.filteredValues,((e,t)=>t.slice(this.limitShown)))}}var m=o(29922),f=o(11187),g=o(88918),b=o(34903),v=o(75083),y=o(68652),_=o.n(y),w=Object.defineProperty,x=Object.getOwnPropertySymbols,C=Object.prototype.hasOwnProperty,D=Object.prototype.propertyIsEnumerable,S=(e,t,o)=>t in e?w(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,k=(e,t)=>{for(var o in t||(t={}))C.call(t,o)&&S(e,o,t[o]);if(x)for(var o of x(t))D.call(t,o)&&S(e,o,t[o]);return e};const T={getCurrentTime:g.Z},I=[v.zr,[{quantity:-3,unit:"day"}],[{quantity:-7,unit:"day"}],[{quantity:-30,unit:"day"}],[{quantity:0,unit:"year"}],[{quantity:3,unit:"day"}],[{quantity:7,unit:"day"}],[{quantity:30,unit:"day"}],[{quantity:0,unit:"year",endOf:!0}]];function R(e){if(void 0===e)return I;(0,b.CV)(e)&&(e=(0,v.ZW)(e));const t=_().utc(1e3*e),o=[e];let i=F(e,{unit:"day"});return Math.abs(i[0].quantity)<=90&&o.push(i),i=F(e,{unit:"week"}),Math.abs(i[0].quantity)<=4&&o.push(i),i=F(e,{unit:"month"}),Math.abs(i[0].quantity)<=(1===t.date()?12:3)&&o.push(i),1===t.date()&&0===t.month()&&o.push(F(e,{unit:"year"})),31===t.date()&&11===t.month()&&o.push(F(e,{unit:"year",endOf:!0})),t.clone().endOf("month").date()===t.date()&&(i=F(e,{unit:"month",endOf:!0}),Math.abs(i[0].quantity)<12&&o.push(i)),o}function F(e,t){const{unit:o}=t,i=_().utc(1e3*e),n=function(){const e=T.getCurrentTime();return _().utc([e.year(),e.month(),e.date()])}(),s=(0,v.QG)(i,n.clone(),o),r=n.clone().add(s,o);t.endOf?(r.endOf(o),r.startOf("day")):r.startOf(o);const l=(0,v.QG)(i,r,"day"),a=[k({quantity:s},t)];return l&&a.push({quantity:l,unit:"day"}),a}function O(e,t){return(0,b.CV)(e)?(0,v.iv)(e):t(e)}class E extends c.Disposable{constructor(e){super(),this._opts=e,this._moveToSelected=this._moveToSelected.bind(this),this.autoDispose(this.columnFilter.min.addListener((()=>this._setRange()))),this.autoDispose(this.columnFilter.max.addListener((()=>this._setRange()))),this.autoDispose(this._opts.selectedBoundObs.addListener(this._moveToSelected))}get columnFilter(){return this._opts.columnFilter}get selectedBoundObs(){return this._opts.selectedBoundObs}buildDom(){return setTimeout((()=>this._moveToSelected()),0),A(P(M("← List view",c.dom.on("click",(()=>this._opts.selectedBoundObs.set(null)))),M("Today",c.dom.on("click",(()=>{this._$el.datepicker("update",this._getCurrentTime()),this._cleanup()}))),(0,m.testId)("calendar-links")),B((e=>{const t=this._$el=$(e);t.datepicker({defaultViewDate:this._getCurrentTime(),todayHighlight:!0}),t[0].querySelector(".datepicker"),this._setRange(),t.on("changeDate",(()=>this._onChangeDate())),t.on("changeMonth",(()=>setTimeout((()=>this._cleanup()),0))),t.on("changeYear",(()=>setTimeout((()=>this._cleanup()),0))),t.on("changeDecade",(()=>setTimeout((()=>this._cleanup()),0))),t.on("changeCentury",(()=>setTimeout((()=>this._cleanup()),0)))})))}_setRange(){this._$el.datepicker("setRange",this._getRange()),this._moveToSelected()}_moveToSelected(){const e=this._opts.selectedBoundObs.get();let t=this._getCurrentTime();if(null!==e){const o=this.columnFilter.getBoundsValue(e);isFinite(o)&&(t=new Date(1e3*o))}this._$el.datepicker("update",t),this._cleanup()}_getCurrentTime(){return(0,g.Z)().toDate()}_onChangeDate(){const e=this._$el.datepicker("getUTCDate").valueOf()/1e3,{min:t,max:o}=this.columnFilter;"min"===this.selectedBoundObs.get()?(t.set(this._updateBoundValue(t.get(),e)),this.columnFilter.getBoundsValue("max")<e&&o.set(this._updateBoundValue(o.get(),e))):(o.set(this._updateBoundValue(o.get(),e)),this.columnFilter.getBoundsValue("min")>e&&t.set(this._updateBoundValue(t.get(),e))),this._cleanup()}_getRange(){const e=this.columnFilter.getBoundsValue("min"),t=this.columnFilter.getBoundsValue("max"),o=e=>{const t=_().utc(1e3*e);return new Date(Date.UTC(t.year(),t.month(),t.date()))};return isFinite(e)||isFinite(t)?isFinite(e)?isFinite(t)?[o(e),o(t)]:[o(e),{valueOf:()=>1/0}]:[{valueOf:()=>-1/0},o(t)]:[]}_updateBoundValue(e,t){return(0,b.CV)(e)?function(e,t){const o=Array.isArray(e)?e:[e];if([1,2].includes(o.length)){const{unit:e,endOf:i}=o[0],n=F(t,{unit:e,endOf:i});return R(t).find((e=>(0,b.CV)(e)&&(0,v.u7)(e,n)))?n:t}throw new Error(`Relative date spec does only support 1 or 2 periods, got ${o.length}!`)}(e,t):t}_cleanup(){const e=this._$el.get()[0].querySelectorAll(".active");for(const t of e)t.classList.remove("active")}}const A=(0,c.styled)("div","\n  padding: 16px 16px;\n"),M=f.textButton,P=(0,c.styled)("div","\n  display: flex;\n  justify-content: space-between;\n"),B=(0,c.styled)("div","\n  padding-top: 16px;\n");var L=o(21467),N=Object.defineProperty,z=Object.defineProperties,V=Object.getOwnPropertyDescriptors,H=Object.getOwnPropertySymbols,j=Object.prototype.hasOwnProperty,U=Object.prototype.propertyIsEnumerable,W=(e,t,o)=>t in e?N(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;var Y=o(88480);class G extends c.Disposable{constructor(e,t,o){super(),this._obs=t,this._opt=o,this._items=c.Observable.create(this,[]),this._dropdownList=Y.L.create(this,e,this._items,this._action.bind(this)),this._dropdownList.listenKeys(e.getTriggerElem()),this.content=this._dropdownList.content,this.autoDispose(this._obs.addListener((()=>this._update()))),this._update()}_getOptions(){var e,t;return(e=this._obs.get(),t=this._opt.valueFormatter,R(e).map((e=>({spec:e,label:O(e,t)})))).map((e=>({label:e.label,value:e.spec})))}_update(){this._items.set(this._getOptions());const e=this._items.get().findIndex((e=>(0,b.t0)(e.value,this._obs.get())));this._dropdownList.setSelected(null!=e?e:-1)}_action(e){this._obs.set(e)}}var K=o(37540);const q=[{label:"Today",min:v.zr,max:v.zr},{label:"Last 7 days",min:[{quantity:-7,unit:"day"}],max:[{quantity:-1,unit:"day"}]},{label:"Next 7 days",min:[{quantity:1,unit:"day"}],max:[{quantity:7,unit:"day"}]},{label:"Last Week",min:[{quantity:-1,unit:"week"}],max:[{quantity:-1,unit:"week",endOf:!0}]},{label:"Last 30 days",min:[{quantity:-30,unit:"day"}],max:[{quantity:-1,unit:"day"}]},{label:"This week",min:[{quantity:0,unit:"week"}],max:[{quantity:0,unit:"week",endOf:!0}]},{label:"This month",min:[{quantity:0,unit:"month"}],max:[{quantity:0,unit:"month",endOf:!0}]},{label:"This year",min:[{quantity:0,unit:"year"}],max:[{quantity:0,unit:"year",endOf:!0}]}];var J=o(3411),X=o(92478),Q=o(7454),Z=o(1370),ee=o(31490),te=o(55330),oe=o(631),ie=o(11486),ne=o(93965),se=Object.defineProperty,re=Object.defineProperties,le=Object.getOwnPropertyDescriptors,ae=Object.getOwnPropertySymbols,ce=Object.prototype.hasOwnProperty,de=Object.prototype.propertyIsEnumerable,ue=(e,t,o)=>t in e?se(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,pe=(e,t)=>{for(var o in t||(t={}))ce.call(t,o)&&ue(e,o,t[o]);if(ae)for(var o of ae(t))de.call(t,o)&&ue(e,o,t[o]);return e};const he=o(15145),me=o(72827),fe=o(78870),ge=o(19647),be=o(2278),ve=o(14116),ye=o(88466),_e=(0,r.makeT)("ColumnFilterMenu"),we=(0,c.makeTestId)("test-filter-menu-");function xe(e,t){const{model:o,doCancel:i,doSave:r,onClose:l,renderValue:a,valueParser:d,showAllFiltersButton:u}=t,{columnFilter:p,filterInfo:h,gristDoc:m}=o,g=t.valueFormatter||(e=>(null==e?void 0:e.toString())||""),v=new Map,y=p.filterFunc.addListener(ye((e=>{for(const[t,o]of v)o.checked=e(t)}))),{searchValue:_,filteredValues:w,filteredKeys:x,isSortedByCount:C}=o,D=c.Computed.create(e,(e=>e(o.valuesBeyondLimit).length>0)),S=c.Computed.create(e,(e=>Boolean(e(_)))),k=(0,oe.isNumberType)(p.columnType)||(0,oe.isDateLikeType)(p.columnType),T=(0,oe.isDateLikeType)(p.columnType),I=c.Observable.create(e,null),R=c.Computed.create(e,(e=>T&&e(I)?"calendarView":"listView")),F=c.Computed.create(e,(e=>"min"===e(I))).onWrite((e=>e?I.set("min"):I.set("max"))),O=c.Computed.create(e,(e=>"max"===e(I))).onWrite((e=>e?I.set("max"):I.set("min")));let A,M=!1,P=!1;return Ee({tabindex:"-1"},we("wrapper"),(t=>{s.FocusLayer.create(e,{defaultFocusElem:t,pauseMousetrap:!0}),setTimeout((()=>{const e=A;e.focus(),e.select()}),0)}),c.dom.cls(Z.menuCssClass),c.dom.autoDispose(y),c.dom.onDispose((()=>M?i():r(P))),c.dom.onKeyDown({Enter:()=>l(),Escape:()=>l()}),c.dom.maybe(k,(()=>[Ze(Ce(p.min,{isDateFilter:T,placeholder:_e(T?"Start":"Min"),valueParser:d,valueFormatter:g,isSelected:F,viewTypeObs:R,nextSelected:()=>I.set("max")},we("min"),c.dom.onKeyDown({Tab:e=>e.shiftKey||I.set("max")})),Ce(p.max,{isDateFilter:T,placeholder:_e(T?"End":"Max"),valueParser:d,valueFormatter:g,isSelected:O,viewTypeObs:R},we("max"),c.dom.onKeyDown({Tab:e=>e.shiftKey?I.set("min"):I.set("max")}))),c.dom.maybe(T,(()=>{function e(e){const{min:t,max:o}=e;p.min.set(t),p.max.set(o),I.set("min")}return[ze(we("presets-links"),Ne(q[0].label,c.dom.on("click",(()=>e(q[0])))),Ne(q[1].label,c.dom.on("click",(()=>e(q[1])))),Ne("More ",(0,Q.icon)("Dropdown"),(0,Z.menu)((()=>q.map((t=>(0,Z.menuItem)((()=>e(t)),t.label)))),{attach:"."+Ee.className})))]})),Be()])),c.dom.domComputed(R,(e=>"listView"===e?[Ae(Ke("Search"),A=Ge(_,{onInput:!0},we("search-input"),{type:"search",placeholder:_e("Search values")},c.dom.onKeyDown({Enter:()=>{_.get()&&p.setState({included:x.get()})},Escape$:e=>{_.get()&&(_.set(""),A.focus(),e.stopPropagation())}})),c.dom.maybe(_,(()=>Ke("CrossSmall",we("search-close"),c.dom.on("click",(()=>{_.set(""),A.focus()})))))),Be(),Le(c.dom.domComputed((e=>{const t=e(_);e(x);const o=t?{included:e(x)}:{excluded:[]},i=t?{excluded:e(x)}:{included:[]},n=e(p.state);return[Me(c.dom.text(_e(t?"All Shown":"All")),c.dom.prop("disabled",(0,b.oz)(n,o)),c.dom.on("click",(()=>p.setState(o))),we("bulk-action")),Pe("•"),Me(_e(t?"All Except":"None"),c.dom.prop("disabled",(0,b.oz)(n,i)),c.dom.on("click",(()=>p.setState(i))),we("bulk-action"))]})),Je("Sort",Je.cls("-active",C),c.dom.on("click",(()=>C.set(!C.get()))))),$e(we("list"),c.dom.maybe((e=>0===e(w).length),(()=>qe(_e("No matching values")))),c.dom.domComputed(w,(e=>e.slice(0,o.limitShown).map((([e,t])=>Le(Xe((0,X.kZ)({type:"checkbox"},c.dom.on("change",((t,o)=>{o.checked?p.add(e):p.delete(e)})),(t=>{t.checked=p.includes(e),v.set(e,t)}),c.dom.style("position","relative")),a(e,t)),He(t.count.toLocaleString(),we("count"))))))))]:c.dom.create(E,{viewTypeObs:R,selectedBoundObs:I,columnFilter:p}))),[Be(),je(c.dom.domComputed((e=>{const t=e(D),i=e(S),n=e(o.otherValues),s=Boolean(n.length),r=e(o.valuesBeyondLimit);return e(p.isRange)||"calendarView"===e(R)?[]:t?i?[Se(_e("Other Matching"),r,!1,o),Se(_e("Other Non-Matching"),n,!0,o)]:[Se(_e("Other Values"),he(n,r),!1,o),Se(_e("Future Values"),[],!0,o)]:s?[Se(_e("Others"),n,!0,o)]:[Se(_e("Future Values"),[],!0,o)]})),Ue((0,c.dom)("div",We("Close",we("apply-btn"),c.dom.on("click",(()=>{P=!0,l()}))),(0,f.basicButton)("Cancel",we("cancel-btn"),c.dom.on("click",(()=>{M=!0,l()}))),u?Ye("All filters",c.dom.on("click",(()=>{l(),n.allCommands.sortFilterMenuOpen.run(h.viewSection.getRowId())})),we("all-filters-btn")):null),(0,c.dom)("div",(0,J.cssPinButton)((0,Q.icon)("PinTilted"),J.cssPinButton.cls("-pinned",o.filterInfo.isPinned),c.dom.on("click",(()=>h.pinned(!h.pinned()))),m.behavioralPromptsManager.attachTip("filterButtons",{popupOptions:{attach:null,modifiers:{flip:{behavior:["right","top"]}},placement:"right"}}),we("pin-btn")))))],c.dom.on("click",(e=>e.stopPropagation())))}function Ce(e,t,...o){const i=()=>[c.dom.maybe((t=>(0,b.CV)(t(e))),(()=>function(e,t){return nt(it(c.dom.text((t=>(0,v.iv)(t(e)))),(0,ee.cssDeleteButton)(c.dom.on("mousedown",(e=>e.stopPropagation())),(0,ee.cssDeleteIcon)("CrossSmall"),c.dom.on("click",(()=>e.set(void 0))),we("tokenfield-delete")),we("tokenfield-token")))}(e))),De(e,t)];return et(c.dom.maybe(t.isDateFilter,(()=>[tt("FieldDate"),i(),(0,Q.icon)("Dropdown")])),c.dom.maybe(!t.isDateFilter,(()=>[i()])),et.cls("-relative",(t=>(0,b.CV)(t(e)))),c.dom.cls("selected",(e=>"calendarView"===e(t.viewTypeObs)&&e(t.isSelected))),c.dom.on("click",(()=>t.isSelected.set(!0))),(o=>t.isDateFilter?function(e,t,o){const i=function(e,t,o){const i=function(e,t,o){const i=L.PopupControl.create(null);var n;return i.attachElem(e,(function(e){const o=t(e);return{content:o,dispose:function(){(0,c.domDispose)(o)}}}),(n=((e,t)=>{for(var o in t||(t={}))j.call(t,o)&&W(e,o,t[o]);if(H)for(var o of H(t))U.call(t,o)&&W(e,o,t[o]);return e})({attach:"body",boundaries:"viewport"},o),z(n,V({trigger:void 0})))),i}(e,(e=>G.create(null,e,t,o).content),o);return c.dom.autoDisposeElem(e,i),i}(e,t,(s=pe({},o),r={placement:"right-start",attach:"."+Ee.className},re(s,le(r)))),n=()=>{o.isSelected.get()?i.open():i.close()};var s,r;c.dom.update(e,[c.dom.on("click",(()=>i.toggle())),c.dom.autoDispose(o.isSelected.addListener(n)),c.dom.autoDispose(t.addListener(n)),c.dom.onKeyDown({Enter$:e=>{var t;"listView"!==o.viewTypeObs.get()&&(o.isSelected.get()&&(i.isOpen()?null==(t=o.nextSelected)||t.call(o):i.open()),e.stopPropagation())}})])}(o,e,t):null),c.dom.onKeyDown({Backspace$:()=>(0,b.CV)(e.get())&&e.set(void 0)}),...o)}function De(e,t,...o){const i=t.valueParser||Number,n=t.valueFormatter,s=t.placeholder;let r,l=!1;const a=()=>{d.flush(),l=!1,r.value=n(e.get()),setTimeout((()=>{"calendarView"===t.viewTypeObs.get()&&t.isSelected.get()&&r.focus()}))},d=ye((()=>{if((0,b.CV)(e.get()))return;l=!0;const t=r.value?i(r.value):void 0;(void 0===t||"number"==typeof t&&!isNaN(t))&&e.set(t)}),100);return r=ot({inputmode:"numeric",placeholder:s,value:n(e.get())},c.dom.on("input",d),c.dom.on("blur",a),c.dom.autoDispose(e.addListener((()=>l?null:r.value=n(e.get())))),c.dom.autoDispose(t.isSelected.addListener((e=>e&&r.focus()))),c.dom.onKeyDown({Enter$:()=>a(),Tab$:()=>a()}),...o)}function Se(e,t,o,i){const n=i.columnFilter,s=c.Computed.create(null,n.isInclusionFilter,n.filterFunc,((e,i)=>{const s=t.map((e=>({getState:()=>n.includes(e[0])})));if(o&&s.push({getState:()=>!i}),!s.length)return!1;const r=s[0].getState();return be(ve(s),(e=>e.getState()!==r))?X.HF:r})).onWrite((e=>{if(o){const t=e?{excluded:i.filteredKeys.get().filter((e=>!n.includes(e)))}:{included:i.filteredKeys.get().filter((e=>n.includes(e)))};n.setState(t)}else{const o=t.map((([e])=>e));e?n.addMany(o):n.deleteMany(o)}}));return Le(c.dom.autoDispose(s),we("summary"),(0,X.af)(s,`${e} ${function(e){const t=e.length;return t?"("+t.toLocaleString()+")":""}(t)}`.trim()),He(function(e){const t=function(e){return e.reduce(((e,t)=>e+t[1].count),0)}(e);return t?t.toLocaleString():""}(t),we("count")))}function ke(e){var t,o;const{openCtl:i,sectionFilter:n,filterInfo:s,rowSource:r,tableData:a,gristDoc:d,showAllFiltersButton:u,onClose:p=fe}=e,{fieldOrColumn:m,filter:f,isPinned:g}=s,b=m.origCol.peek().type.peek(),v=(null==(t=m.visibleColModel.peek())?void 0:t.type.peek())||b,{keyMapFunc:y,labelMapFunc:_,valueMapFunc:w}=function(e,t,o){const i=t.getRowPropFunc(o.colId()),n=t.getRowPropFunc(o.displayColModel().colId()),s=o.visibleColFormatter();let r;return r=(0,oe.isRefListType)(e)?e=>{const t=n(e);return t?((0,oe.isList)(t)?t.slice(1):[t]).map((e=>s.formatAny(e))):""}:e=>s.formatAny(n(e)),{keyMapFunc:i,labelMapFunc:r,valueMapFunc:e=>(0,ne.xD)(n(e))}}(b,a,m),x=null==(o=m.createValueParser)?void 0:o.call(m);let C=m.visibleColFormatter();if("DateTime"===(0,oe.extractTypeFromColType)(C.type)){const{docSettings:e}=C,t=m.origCol.peek().widgetOptionsJson();C=(0,ie.SP)("Date",t,e)}const D=(0,oe.isDateLikeType)(v)?e=>C.formatAny(e):void 0;function S(e,t){return e.getRowId()===m.getRowId()?null:t}const k=c.Computed.create(null,(e=>n.buildFilterFunc(S,e)));i.autoDispose(k);const[T,I]=ge(Array.from(r.getAllRows()),k.get()),R=function(e){var t;const o=e.origCol().type();let i=[];return"Bool"===o?i=[!0,!1]:["Choice","ChoiceList"].includes(o)&&(i=null!=(t=e.origCol().widgetOptionsJson.prop("choices")())?t:[]),new Map(i.map((e=>[e,{label:String(e),count:0,displayValue:e}])))}(m);Ie(R,T,{keyMapFunc:y,labelMapFunc:_,columnType:b,valueMapFunc:w}),Ie(R,I,{keyMapFunc:y,labelMapFunc:_,columnType:b,areHiddenRows:!0,valueMapFunc:w});const F=Array.from(R),O=l.ColumnFilter.create(i,f.peek(),b,v,F.map((e=>e[0])));n.setFilterOverride(m.origCol().getRowId(),O);const E=h.create(i,{columnFilter:O,filterInfo:s,valueCount:F,gristDoc:d});return xe(i,{model:E,valueCounts:R,onClose:()=>{i.close(),p()},doSave:(e=!1)=>{const t=O.makeFilterJson(),{viewSection:o}=n;o.setFilter(m.origCol().origColRef(),{filter:t}),e&&n.resetTemporaryRows(),O.initialFilterJson===l.NEW_FILTER_JSON&&g()&&2===o.pinnedActiveFilters.get().length&&o.showNestedFilteringPopup.set(!0)},doCancel:()=>{const{viewSection:e}=n;if(O.initialFilterJson===l.NEW_FILTER_JSON)e.revertFilter(m.origCol().origColRef());else{const t=O.initialFilterJson;O.setState(t),e.setFilter(m.origCol().origColRef(),{filter:t,pinned:E.initialPinned})}},renderValue:Te(b,m),valueParser:x,valueFormatter:D,showAllFiltersButton:u})}function Te(e,t){if(["Choice","ChoiceList"].includes(e)){const e=t.widgetOptionsJson.peek(),o=new Set(e.choices||[]),i=e.choiceOptions||{};return(e,t)=>{var n,s,r,l,a,d,u,p,h,m;return""===t.label?Ve(t.label):(0,te.choiceToken)(t.label,{fillColor:null==(n=i[t.label])?void 0:n.fillColor,textColor:null==(s=i[t.label])?void 0:s.textColor,fontBold:null!=(l=null==(r=i[t.label])?void 0:r.fontBold)&&l,fontUnderline:null!=(d=null==(a=i[t.label])?void 0:a.fontUnderline)&&d,fontItalic:null!=(p=null==(u=i[t.label])?void 0:u.fontItalic)&&p,fontStrikethrough:null!=(m=null==(h=i[t.label])?void 0:h.fontStrikethrough)&&m,invalid:!o.has(t.label)},c.dom.cls(Qe.className),we("choice-token"))}}return(e,t)=>Ve(void 0===t.label?String(e):t.label)}function Ie(e,t,{keyMapFunc:o=me,labelMapFunc:i=me,columnType:n,areHiddenRows:s=!1,valueMapFunc:r}){for(const l of t){let t=o(l);if((0,oe.isList)(t)&&"ChoiceList"===n){const o=(0,ne.xD)(t);o.length||Re(e,"",(()=>""),(()=>""),s);for(const t of o)Re(e,t,(()=>t),(()=>t),s)}else if((0,oe.isList)(t)&&(0,oe.isRefListType)(n)){const o=(0,ne.xD)(t);o.length||Re(e,null,(()=>null),(()=>null),s);const n=i(l),a=r(l);o.forEach(((t,o)=>{Re(e,t,(()=>n[o]),(()=>a[o]),s)}))}else Array.isArray(t)&&(t=JSON.stringify(t)),Re(e,t,(()=>i(l)),(()=>r(l)),s)}}function Re(e,t,o,i,n){e.has(t)||e.set(t,{label:o(),count:0,displayValue:i()}),n||e.get(t).count++}const Fe={placement:"bottom-start",boundaries:"viewport",trigger:["click"]};function Oe(e,t={}){const o=t,{popupOptions:i}=o,n=((e,t)=>{var o={};for(var i in e)ce.call(e,i)&&t.indexOf(i)<0&&(o[i]=e[i]);if(null!=e&&ae)for(var i of ae(e))t.indexOf(i)<0&&de.call(e,i)&&(o[i]=e[i]);return o})(o,["popupOptions"]),s=pe(pe({},Fe),i);return t=>{const o=e.viewSection.viewInstance();o&&o.createFilterMenu&&(0,L.setPopupToCreateDom)(t,(t=>o.createFilterMenu(t,e,n)),s)}}const Ee=(0,c.styled)("div",`\n  display: flex;\n  flex-direction: column;\n  min-width: 252px;\n  max-width: 400px;\n  max-height: 90vh;\n  outline: none;\n  background-color: ${m.theme.menuBg};\n  padding-top: 0;\n  padding-bottom: 12px;\n`),Ae=(0,c.styled)("div","\n  height: 40px;\n  flex-shrink: 0;\n\n  display: flex;\n  align-items: center;\n\n  margin: 0 16px;\n"),Me=(0,c.styled)(f.textButton,`\n  --icon-color: ${m.theme.controlFg};\n`),Pe=(0,c.styled)("span",`\n  color: ${m.theme.controlFg};\n  margin: 0 4px;\n  user-select: none;\n`),Be=(0,c.styled)(Z.menuDivider,"\n  flex-shrink: 0;\n  margin: 0;\n"),$e=(0,c.styled)("div","\n  flex-shrink: 1;\n  overflow: auto;\n  min-height: 80px;\n  margin-top: 4px;\n  padding-bottom: 8px;\n"),Le=(0,c.styled)("div","\n  display: flex;\n  padding: 8px 16px;\n"),Ne=f.textButton,ze=(0,c.styled)(Le,"\n  column-gap: 12px;\n  padding-top: 0;\n  padding-bottom: 16px;\n"),Ve=(0,c.styled)(X.Jr,"\n  margin-right: 12px;\n  white-space: pre;\n"),He=(0,c.styled)("div",`\n  flex-grow: 1;\n  align-self: normal;\n  text-align: right;\n  color: ${m.theme.lightText};\n`),je=(0,c.styled)("div","\n  display: flex;\n  flex-shrink: 0;\n  flex-direction: column;\n  padding-top: 4px;\n"),Ue=(0,c.styled)("div","\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  padding: 8px 16px;\n"),We=(0,c.styled)(f.primaryButton,"\n  margin-right: 8px;\n"),Ye=(0,c.styled)(f.textButton,"\n  margin-left: 8px;\n"),Ge=(0,c.styled)(c.input,`\n  color: ${m.theme.inputFg};\n  background-color: ${m.theme.inputBg};\n  flex-grow: 1;\n  min-width: 1px;\n  -webkit-appearance: none;\n  -moz-appearance: none;\n\n  font-size: ${m.vars.mediumFontSize};\n\n  margin: 0px 16px 0px 8px;\n  padding: 0px;\n  border: none;\n  outline: none;\n\n  &::placeholder {\n    color: ${m.theme.inputPlaceholderFg};\n  }\n`),Ke=(0,c.styled)(Q.icon,`\n  --icon-color: ${m.theme.lightText};\n  flex-shrink: 0;\n  margin-left: auto;\n  margin-right: 4px;\n`),qe=(0,c.styled)(Le,`\n  font-style: italic;\n  color: ${m.theme.lightText};\n  justify-content: center;\n`),Je=(0,c.styled)(Q.icon,`\n  --icon-color: ${m.theme.controlSecondaryFg};\n  margin-left: auto;\n  &-active {\n    --icon-color: ${m.theme.controlFg}\n  }\n`),Xe=(0,c.styled)(X.xY,"\n  align-items: center;\n  font-weight: initial;   /* negate bootstrap */\n"),Qe=(0,c.styled)("div","\n  margin-left: 8px;\n  margin-right: 12px;\n"),Ze=(0,c.styled)(Le,"\n  display: flex;\n  align-items: center;\n  row-gap: 6px;\n  flex-direction: column;\n  padding: 16px 16px;\n"),et=(0,c.styled)("div",`\n  position: relative;\n  width: 100%;\n  display: flex;\n  background-color: ${m.theme.inputBg};\n  height: 30px;\n  width: 100%;\n  border-radius: 3px;\n  border: 1px solid ${m.theme.inputBorder};\n  outline: none;\n  padding: 5px;\n  &.selected {\n    border: 1px solid ${m.theme.inputValid};\n  }\n  &-relative input {\n    padding: 0;\n    max-width: 0;\n  }\n`),tt=Z.cssOptionRowIcon,ot=(0,c.styled)(K.g,"\n  height: unset;\n  border: none;\n  padding: 0;\n  width: unset;\n  flex-grow: 1;\n"),it=(0,c.styled)(ee.cssToken,"\n  height: 18px;\n  line-height: unset;\n  align-self: center;\n  cursor: default;\n"),nt=(0,c.styled)("div","\n  width: 100%;\n  display: flex;\n  outline: none;\n")},3898:(e,t,o)=>{"use strict";o.r(t),o.d(t,{buildFormulaConfig:()=>j,buildNameConfig:()=>H,cssFieldFormula:()=>W});var i=o(70387),n=o(85050),s=o(7485),r=o(3411),l=o(8881),a=o(92769),c=o(98987),d=o(11187),u=o(92478),p=o(29922),h=o(7454),m=o(1370),f=o(48402),g=o(631),b=o(83277),v=o(93965),y=o(1310),_=o(21467),w=Object.defineProperty,x=Object.defineProperties,C=Object.getOwnPropertyDescriptors,D=Object.getOwnPropertySymbols,S=Object.prototype.hasOwnProperty,k=Object.prototype.propertyIsEnumerable,T=(e,t,o)=>t in e?w(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;const I=o(36812),R=(0,i.makeT)("TriggerFormulas");function F(e,t,o){const i=y.Computed.create(e,(e=>e(t.recalcWhen)!==g.RecalcWhen.NEVER)).onWrite((e=>l(e?g.RecalcWhen.DEFAULT:g.RecalcWhen.NEVER,null))),n=y.Observable.create(e,!1),s=y.Computed.create(e,(e=>{return e(n)||(o=e(t.recalcWhen),i=e(t.recalcDeps),o===g.RecalcWhen.MANUAL_UPDATES||o===g.RecalcWhen.DEFAULT&&null!=i&&!(0,g.isEmptyList)(i));var o,i})).onWrite((async function(e){await l(g.RecalcWhen.DEFAULT,null),n.set(e)}));async function l(e,o){if(e!==t.recalcWhen.peek()||o!==t.recalcDeps.peek())return t._table.sendTableAction(["UpdateRecord",t.id.peek(),{recalcWhen:e,recalcDeps:(0,v.Cx)(o)}])}const c=t._table.docModel,w=y.Computed.create(e,(e=>{if(e(t.recalcWhen)===g.RecalcWhen.MANUAL_UPDATES)return R("Any field");const o=(0,v.xD)(e(t.recalcDeps));return o&&0!==o.length?o.map((t=>{var o;return e(null==(o=c.columns.getRowModel(t))?void 0:o.label)})).join(", "):""})),F=y.Computed.create(e,(e=>Boolean(o.disabled&&e(o.disabled)||o.notTrigger&&e(o.notTrigger)))),N=y.Computed.create(e,(e=>Boolean(e(s)||e(F))));return[(0,r.cssRow)((0,u.rp)(i,R("Apply to new records"),y.dom.boolAttr("disabled",N),(0,p.testId)("field-formula-apply-to-new"))),(0,r.cssRow)((0,u.rp)(s,y.dom.text((e=>e(s)?R("Apply on changes to:"):R("Apply on record changes"))),y.dom.boolAttr("disabled",F),(0,p.testId)("field-formula-apply-on-changes"))),y.dom.maybe(s,(()=>O((0,f.G)(E(y.dom.text(w)),(0,h.icon)("Dropdown"),(0,p.testId)("field-triggers-select"),y.dom.cls("disabled",(e=>!!o.disabled&&e(o.disabled))),(e=>{var o;(0,_.setPopupToCreateDom)(e,(e=>function(e,t,o,i){const n=e,s=new Set((0,v.xD)(o.recalcDeps.peek())),r=y.Observable.create(n,o.recalcWhen.peek()===g.RecalcWhen.MANUAL_UPDATES),l=t.columns.peek().peek().filter((e=>!e.isHiddenCol.peek()));l.sort(((e,t)=>(0,b.nativeCompare)(e.label.peek(),t.label.peek())));const c=l.map((e=>y.Observable.create(n,s.has(e.id.peek())))),h=c.find(((e,t)=>l[t].id.peek()===o.id.peek()));n.autoDispose(r.addListener((e=>{e&&c.forEach((e=>e.set(!1)))})));const f=y.Computed.create(n,(e=>e(r)?g.RecalcWhen.MANUAL_UPDATES:g.RecalcWhen.DEFAULT)),_=y.Computed.create(n,(e=>e(r)?null:l.filter(((t,o)=>e(c[o]))).map((e=>e.id.peek())))),w=y.Computed.create(n,(e=>e(f)!==e(o.recalcWhen)||!I(new Set(e(_)),s)));let x=!0;function C(t){x=t,e.close()}return A({tabindex:"-1"},(0,p.testId)("field-triggers-dropdown"),y.dom.cls(m.menuCssClass),y.dom.onDispose((function(){x&&w.get()&&i(f.get(),_.get()).catch(a.reportError)})),y.dom.onKeyDown({Enter:()=>C(!0),Escape:()=>C(!1)}),(e=>{setTimeout((()=>e.focus()),0)}),P(B((0,u.rp)(h,[R("Current field "),$("(data cleaning)")],y.dom.boolAttr("disabled",r))),(0,m.menuDivider)(),B((0,u.rp)(r,[`${R("Any field")} `,$("(except formulas)")]))),M(l.map(((e,t)=>B((0,u.rp)(c[t],e.label.peek(),y.dom.boolAttr("disabled",r)))))),P(L(y.dom.maybe(w,(()=>(0,d.primaryButton)(R("OK"),y.dom.on("click",(()=>C(!0))),(0,p.testId)("trigger-deps-apply")))),(0,d.basicButton)(y.dom.text((e=>e(w)?R("Cancel"):R("Close"))),y.dom.on("click",(()=>C(!1))),(0,p.testId)("trigger-deps-cancel")))))}(e,t.table.peek(),t,l)),(o=((e,t)=>{for(var o in t||(t={}))S.call(t,o)&&T(e,o,t[o]);if(D)for(var o of D(t))k.call(t,o)&&T(e,o,t[o]);return e})({},_.defaultMenuOptions),x(o,C({placement:"bottom-end"}))))})))))]}const O=(0,y.styled)(r.cssRow,"\n  margin-left: 40px;\n"),E=(0,y.styled)("div",`\n  flex: 1 1 0px;\n  overflow: hidden;\n  text-overflow: ellipsis;\n\n  &:empty::before {\n    content: "Select fields";\n    color: ${p.theme.selectButtonPlaceholderFg};\n  }\n`),A=(0,y.styled)(_.cssMenu,"\n  display: flex;\n  flex-direction: column;\n  max-height: calc(max(300px, 95vh - 300px));\n  max-width: 400px;\n  padding-bottom: 0px;\n"),M=(0,y.styled)(c.a,`\n  flex: auto;\n  min-height: 80px;\n  border-top: 1px solid ${p.theme.menuBorder};\n  border-bottom: 1px solid ${p.theme.menuBorder};\n  margin-top: 8px;\n  padding: 8px 0;\n`),P=(0,y.styled)("div","\n  flex: none;\n"),B=(0,y.styled)(_.cssMenuItem,"\n  justify-content: flex-start;\n  align-items: center;\n  display: flex;\n  padding: 8px 16px;\n  white-space: nowrap;\n"),$=(0,y.styled)("span",`\n  color: ${p.theme.lightText};\n`),L=(0,y.styled)(B,"\n  justify-content: space-between;\n  margin: 3px 0;\n");var N=o(29002),z=o(97767);const V=(0,i.makeT)("FieldConfig");function H(e,t,o,i){const s=t.untieColIdFromLabel,l=y.Observable.create(e,""),a=y.Computed.create(e,l,((e,o)=>"$"+(o?(0,b.sanitizeIdent)(o):e(t.colId)))),c=y.Computed.create(e,(e=>Boolean(e(e(t.table).summarySourceTable))));let d;return e.autoDispose(o.subscribe((()=>{null==d||d.blur()}))),[(0,r.cssLabel)(V("COLUMN LABEL AND ID")),(0,r.cssRow)(y.dom.cls(r.cssBlockedCursor.className,t.disableModify),G(d=X((0,y.fromKo)(t.label),(async e=>{await t.label.saveOnly(e),l.set("")}),y.dom.on("input",((e,t)=>{s.peek()||l.set(t.value)})),y.dom.boolAttr("readonly",(e=>e(t.disableModify)||e(i))),(0,p.testId)("field-label")),X(a,(e=>t.colId.saveOnly(e.startsWith("$")?e.slice(1):e)),y.dom.boolAttr("readonly",(e=>e(i)||e(t.disableModify)||!e(t.untieColIdFromLabel))),n.mm.cls(""),{style:"margin-top: 8px"},(0,p.testId)("field-col-id"))),K(q(),Y((0,h.icon)("FieldReference"),Y.cls("-selected",(e=>!e(s))),y.dom.on("click",(()=>{t.disableModify.peek()||i.peek()||s.saveOnly(!s.peek()).catch(reportError)})),Y.cls("-disabled",(e=>e(t.disableModify)||e(i))),(0,p.testId)("field-derive-id")))),y.dom.maybe(c,(()=>(0,r.cssRow)(V("Column options are limited in summary tables."))))]}function j(e,t,o,i){const n=y.Computed.create(e,(e=>e(t.disableModify))),a=y.Observable.create(e,!1),c=y.Observable.create(e,!1),u=y.Computed.create(e,(e=>Boolean(e(e(t.table).summarySourceTable)))),h=y.Computed.create(e,(e=>e(t.id)?e(t.isRealFormula)||e(a)?"formula":e(c)||!e(t.isEmpty)?"data":"empty":null));let f=null;const g=()=>(0,y.bundleChanges)((()=>{e.isDisposed()||(a.set(!1),c.set(!1),f=null)}));e.autoDispose(t.id.subscribe(g)),e.autoDispose(t.formula.subscribe(g)),e.autoDispose(t.isFormula.subscribe(g));const b=y.Computed.create(e,(e=>{var t;return null==(t=e(o.currentView))?void 0:t.viewSection})),v=y.Computed.create(e,(e=>{const t=e(b);return!!t&&e(t.selectedFields).length>1})),_=y.Computed.create(e,(e=>{if(!e(v))return!1;const t=e(b);return!!t&&e(t.columnsBehavior)})),w=y.Computed.create(e,(e=>{if(!e(v))return!1;const t=e(b);return!!t&&e(t.columnsAllIsFormula)})),x=()=>{return((null==(e=b.get())?void 0:e.selectedFields.peek().map((e=>e.column.peek())))||[]).map((e=>e.id.peek()))||[];var e},C=(e,t)=>(0,r.cssRow)((0,m.selectMenu)(e,(()=>v.get()?[w.get()?(0,m.selectOption)((()=>o.convertIsFormula(x(),{toFormula:!1,noRecalc:!0})),"Convert columns to data","Database",y.dom.cls("disabled",u)):null,(0,m.selectOption)((()=>Promise.all([o.clearColumns(x())])),"Clear and reset","CrossSmall")]:t),(0,p.testId)("field-behaviour"),(e=>e.removeAttribute("tabindex")),y.dom.cls(r.cssBlockedCursor.className,n),y.dom.cls("disabled",n))),D=y.Computed.create(e,h,((e,t)=>{if(e(v)){const t=e(_);return"formula"===t?V("Formula Columns",{count:2}):"data"===t?V("Data Columns",{count:2}):"mixed"===t?V("Mixed Behavior"):V("Empty Columns",{count:2})}return V("formula"===t?"Formula Columns":"data"===t?"Data Columns":"Empty Columns",{count:1})})),S=y.Computed.create(e,(e=>e(D)===V("Data Columns",{count:2})||e(D)===V("Data Columns",{count:1})?"Database":"Script")),k=()=>(0,m.selectTitle)(D,S),T=()=>o.convertIsFormula([t.id.peek()],{toFormula:!1,noRecalc:!0}),I=()=>(0,m.selectOption)(T,V("Convert column to data"),"Database",y.dom.cls("disabled",u)),R=()=>(0,m.selectOption)((()=>o.clearColumns([t.id.peek()])),V("Clear and reset"),"CrossSmall"),O=()=>{c.set(!0),null==f||f.focus()},E=()=>o.convertIsFormula([t.id.peek()],{toFormula:!1,noRecalc:!1}),A=()=>(a.set(!0),null==f?void 0:f.focus()),M=()=>(c.set(!0),null==f?void 0:f.focus()),P=async(t,i)=>{if(e.isDisposed())return;const n=Boolean(i),s=t.formula.peek();(n||s)&&await o.convertToFormula(t.id.peek(),i),e.isDisposed()||g()},B=async(t,i)=>{i&&!t.hasTriggerFormula.peek()?await o.convertToTrigger(t.id.peek(),i):t.hasTriggerFormula.peek()&&await o.updateFormula(t.id.peek(),i),e.isDisposed()||g()},$=y.Computed.create(e,(e=>e(n)||e(v))),L=(0,z.Ue)(e,o,t),N=(e,n)=>[(0,r.cssRow)(f=U(t,i,{gristTheme:o.currentTheme,disabled:$,canDetach:n,onSave:e,onCancel:g})),y.dom.maybe(L,(e=>(0,r.cssRow)((0,z.So)(e),(0,p.testId)("field-error-count"))))];return y.dom.maybe(h,(e=>[(0,r.cssLabel)(V("COLUMN BEHAVIOR")),..."empty"===e?[C(k(),[I()]),J(),(0,r.cssRow)((0,d.textButton)(V("Set formula"),y.dom.on("click",A),y.dom.prop("disabled",$),(0,p.testId)("field-set-formula"))),(0,r.cssRow)((0,l.withInfoTooltip)((0,d.textButton)(V("Set trigger formula"),y.dom.on("click",M),y.dom.prop("disabled",(e=>e(u)||e($))),(0,p.testId)("field-set-trigger")),s.D.setTriggerFormula())),(0,r.cssRow)((0,d.textButton)(V("Make into data column"),y.dom.on("click",T),y.dom.prop("disabled",(e=>e(u)||e($))),(0,p.testId)("field-set-data")))]:"formula"===e?[C(k(),[I(),R()]),N(P),J(),(0,r.cssRow)((0,d.textButton)(V("Convert to trigger formula"),y.dom.on("click",E),y.dom.hide(a),y.dom.prop("disabled",(e=>e(u)||e($))),(0,p.testId)("field-set-trigger")))]:[C(k(),[y.dom.domComputed(t.hasTriggerFormula,(e=>e?(0,m.selectOption)((()=>o.convertIsFormula([t.id.peek()],{toFormula:!0,noRecalc:!0})),V("Clear and make into formula"),"Script"):(0,m.selectOption)((()=>(a.set(!0),null==f?void 0:f.focus())),V("Clear and make into formula"),"Script"))),R()]),y.dom.maybe((e=>e(c)||e(t.hasTriggerFormula)),(()=>[(0,r.cssLabel)(V("TRIGGER FORMULA")),N(B,!1),y.dom.create(F,t,{disabled:$,notTrigger:c})])),y.dom.maybe((e=>!(e(c)||e(t.hasTriggerFormula))),(()=>[J(),(0,r.cssRow)((0,l.withInfoTooltip)((0,d.textButton)(V("Set trigger formula"),y.dom.on("click",O),y.dom.prop("disabled",$),(0,p.testId)("field-set-trigger")),s.D.setTriggerFormula()))]))]]))}function U(e,t,o){const{gristTheme:i,disabled:n,canDetach:s=!0,onSave:r,onCancel:l}=o;return W(e.formula,{gristTheme:i,maxLines:2},y.dom.cls("formula_field_sidepane"),W.cls("-disabled",n),W.cls("-disabled-icon",(t=>!t(e.formula))),y.dom.cls("disabled"),{tabIndex:"-1"},y.dom.on("focus",((e,o)=>t({refElem:o,editValue:void 0,canDetach:s,onSave:r,onCancel:l}))))}const W=(0,y.styled)(n.Lh,`\n  flex: auto;\n  cursor: pointer;\n  margin-top: 4px;\n  padding-left: 24px;\n  --icon-color: ${p.theme.accentIcon};\n\n  &-disabled-icon.formula_field_sidepane::before {\n    --icon-color: ${p.theme.lightText};\n  }\n  &-disabled {\n    pointer-events: none;\n  }\n`),Y=(0,y.styled)(h.cssIconButton,`\n  margin-left: 8px;\n  background-color: ${p.theme.rightPanelToggleButtonDisabledBg};\n  box-shadow: inset 0 0 0 1px ${p.theme.inputBorder};\n\n  &-selected, &-selected:hover {\n    box-shadow: none;\n    background-color: ${p.theme.rightPanelToggleButtonEnabledBg};\n    --icon-color: ${p.theme.rightPanelToggleButtonEnabledFg};\n  }\n  &-selected:hover {\n    --icon-color: ${p.theme.rightPanelToggleButtonEnabledHoverFg};\n  }\n  &-disabled, &-disabled:hover {\n    --icon-color: ${p.theme.rightPanelToggleButtonDisabledFg};\n    background-color: ${p.theme.rightPanelToggleButtonDisabledBg};\n  }\n`),G=(0,y.styled)("div","\n  display: flex;\n  flex-direction: column;\n  flex: auto;\n  min-width: 80px;\n"),K=(0,y.styled)("div","\n  position: relative;\n"),q=(0,y.styled)("div",`\n  position: absolute;\n  border: 2px solid ${p.theme.inputBorder};\n  top: -9px;\n  bottom: -9px;\n  right: 11px;\n  left: 0px;\n  border-left: none;\n  z-index: -1;\n`),J=(0,y.styled)("div","\n  margin-top: 16px;\n"),X=(0,y.styled)(N.textInput,`\n  color: ${p.theme.inputFg};\n  background-color: ${p.theme.mainPanelBg};\n  border: 1px solid ${p.theme.inputBorder};\n\n  &::placeholder {\n    color: ${p.theme.inputPlaceholderFg};\n  }\n\n  &[readonly] {\n    background-color: ${p.theme.inputDisabledBg};\n    color: ${p.theme.inputDisabledFg};\n  }\n`)},86391:(e,t,o)=>{"use strict";o.d(t,{y:()=>u});var i=o(11527),n=o(81294),s=o.n(n);const r=i.get("document","window");function l(){}let a,c,d=l;function u(e){return new Promise((t=>function(e,t){c||(a=s()("form#file_dialog_form",{style:"position: absolute; top: 0; display: none"},c=s()("input#file_dialog_input",{type:"file"})),r.document.body.appendChild(a),c.addEventListener("change",(e=>{d(c.files?Array.from(c.files):[]),d=l}))),a.reset(),c.multiple=Boolean(e.multiple),c.accept=e.accept||"",d=t,setTimeout((()=>c.click()),0)}(e,t)))}},60664:(e,t,o)=>{"use strict";o.d(t,{B:()=>p,s:()=>h});var i=o(45051),n=o(62905),s=o(11187),r=o(29922),l=o(7454),a=o(1310),c=o(70387),d=o(59793);const u=(0,c.makeT)("FilterBar");function p(e,t,o){const i=new WeakMap;return m((0,r.testId)("filter-bar"),a.dom.forEach(o.activeFilters,(e=>function(e,t){const{fieldOrColumn:o,filter:i,pinned:s,isPinned:l}=e;return f((0,r.testId)("filter-field"),_((0,r.testId)("btn"),g("FilterSimple"),b(a.dom.text(o.origCol().label)),y.cls("-grayed",(e=>e(i.isSaved)&&e(s.isSaved))),(0,n.attachColumnFilterMenu)(e,{popupOptions:{placement:"bottom-start",attach:"body",trigger:["click",(e,i)=>t.set(o.origCol(),i)]},showAllFiltersButton:!0})),f.cls("-unpinned",(e=>!e(l))))}(e,i))),a.dom.maybe(o.showNestedFilteringPopup,(()=>(0,a.dom)("div",t.behavioralPromptsManager.attachTip("nestedFiltering",{onDispose:()=>o.showNestedFilteringPopup.set(!1)})))),function(e,t){return a.dom.domComputed((o=>{const i=o(e.filters);return w(y.cls("-grayed"),v("Plus"),h(i,t,{allowedColumns:"unpinned-or-unfiltered"}),(0,r.testId)("add-filter-btn"))}))}(o,i),m.cls("-hidden",(e=>0===e(o.pinnedActiveFilters).length)))}function h(e,t,o={}){const{allowedColumns:n,menuOptions:s}=o;return(0,d.z)({action:e=>function({fieldOrColumn:e,isFiltered:t,viewSection:o},n){var s;o.setFilter(e.origCol().origColRef(),{filter:t.peek()?void 0:i.NEW_FILTER_JSON,pinned:!0}),null==(s=n.get(e.origCol()))||s.open()}(e,t),options:()=>e.map((e=>({label:e.fieldOrColumn.origCol().label.peek(),value:e,disabled:"unpinned-or-unfiltered"===n?e.isPinned.peek()&&e.isFiltered.peek():e.isFiltered.peek()}))),popupOptions:s,placeholder:u("Search Columns")})}const m=(0,a.styled)("div.filter_bar","\n  display: flex;\n  flex-direction: row;\n  flex-wrap: wrap;\n  row-gap: 8px;\n  margin: 8px 0px 8px -4px;\n  &-hidden {\n    display: none;\n  }\n"),f=(0,a.styled)("div",`\n  flex: 1 1 80px;\n  min-width: 0px;\n  max-width: max-content;\n  border-radius: ${r.vars.controlBorderRadius};\n  margin: 0 4px;\n  &-unpinned {\n    display: none;\n  }\n`),g=(0,a.styled)(l.icon,"\n  flex-shrink: 0;\n"),b=(0,a.styled)("span","\n  flex-grow: 1;\n  overflow: hidden;\n  white-space: nowrap;\n  text-overflow: ellipsis;\n"),v=(0,a.styled)(l.icon,"\n  margin-top: -3px;\n"),y=(0,a.styled)("div",`\n  display: flex;\n  align-items: center;\n  column-gap: 4px;\n\n  height: 24px;\n  padding: 3px 8px;\n  .${m.className} > & {\n    margin: 0 4px;\n  }\n  &-grayed {\n    color:        ${r.theme.filterBarButtonSavedFg};\n    --icon-color: ${r.theme.filterBarButtonSavedFg};\n    background-color: ${r.theme.filterBarButtonSavedBg};\n    border-color: ${r.theme.filterBarButtonSavedBg};\n  }\n  &-grayed:hover {\n    background-color: ${r.theme.filterBarButtonSavedHoverBg};\n    border-color: ${r.theme.filterBarButtonSavedHoverBg};\n  }\n`),_=(...e)=>(0,a.dom)("div",s.cssButton.cls(""),s.cssButton.cls("-primary"),y.cls(""),...e),w=(0,a.styled)(_,"\n  padding: 3px 3px\n")},91465:(e,t,o)=>{"use strict";o.d(t,{P:()=>_});var i=o(70387),n=o(62905),s=o(60664),r=o(3411),l=o(29922),a=o(7454),c=o(1310),d=Object.defineProperty,u=Object.defineProperties,p=Object.getOwnPropertyDescriptors,h=Object.getOwnPropertySymbols,m=Object.prototype.hasOwnProperty,f=Object.prototype.propertyIsEnumerable,g=(e,t,o)=>t in e?d(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,b=(e,t)=>{for(var o in t||(t={}))m.call(t,o)&&g(e,o,t[o]);if(h)for(var o of h(t))f.call(t,o)&&g(e,o,t[o]);return e};const v=(0,c.makeTestId)("test-filter-config-"),y=(0,i.makeT)("SortConfig");class _ extends c.Disposable{constructor(e,t={}){super(),this._section=e,this._options=t,this._popupControls=new WeakMap,this._canAddFilter=c.Computed.create(this,(e=>e(this._section.filters).some((t=>!e(t.isFiltered)))))}buildDom(){const{menuOptions:e}=this._options;return(0,c.dom)("div",c.dom.forEach(this._section.activeFilters,(t=>{const{fieldOrColumn:o,filter:i,pinned:s,isPinned:l}=t;return(0,r.cssRow)((0,r.cssSortFilterColumn)(w(D("FilterSimple",D.cls("-accent",(e=>!e(i.isSaved)||!e(s.isSaved))),v("filter-icon"))),x(c.dom.text(o.label)),(0,n.attachColumnFilterMenu)(t,{popupOptions:(d=b({placement:"bottom-end"},e),h={trigger:["click",(e,t)=>this._popupControls.set(o.origCol(),t)]},u(d,p(h)))}),v("column")),k((0,a.icon)("PinTilted"),c.dom.on("click",(()=>this._section.setFilter(o.origCol().origColRef(),{pinned:!l.peek()}))),r.cssPinButton.cls("-pinned",l),v("pin-filter")),w(S("Remove",c.dom.on("click",(()=>this._section.setFilter(o.origCol().origColRef(),{filter:"",pinned:!1}))),v("remove-filter"))),v("filter"));var d,h})),(0,r.cssRow)(c.dom.domComputed((e=>{const t=e(this._section.filters);return C(y("Add Column"),(0,s.s)(t,this._popupControls,{menuOptions:b({placement:"bottom-end"},this._options.menuOptions)}),c.dom.on("click",(e=>e.stopPropagation())),c.dom.hide((e=>!e(this._canAddFilter))),v("add-filter-btn"))}))),v("container"))}}const w=(0,c.styled)("div",""),x=(0,c.styled)("div","\n  white-space: nowrap;\n  text-overflow: ellipsis;\n  overflow: hidden;\n  flex-grow: 1;\n"),C=(0,c.styled)("div",`\n  color: ${l.theme.controlFg};\n  cursor: pointer;\n\n  &:hover {\n    color: ${l.theme.controlHoverFg};\n  }\n`),D=(0,c.styled)(r.cssIcon,`\n  flex: none;\n  margin: 0px 6px 0px 0px;\n  background-color: ${l.theme.controlSecondaryFg};\n\n  &-accent {\n    background-color: ${l.theme.accentIcon};\n  }\n`),S=(0,c.styled)(r.cssIcon,`\n  flex: none;\n  margin: 0 6px;\n  background-color: ${l.theme.controlSecondaryFg};\n  cursor: pointer;\n\n  &:hover {\n    background-color: ${l.theme.controlSecondaryHoverFg};\n  }\n`),k=(0,c.styled)(r.cssPinButton,"\n  margin-left: 6px;\n")},63561:(e,t,o)=>{"use strict";o.d(t,{Jn:()=>f,QS:()=>T,Sq:()=>_,X$:()=>g});var i,n,s,r=o(70387),l=o(62808),a=o(8881),c=o(29922),d=o(7454),u=o(1310);const p=16,h=(0,r.makeT)("FloatingPopup"),m=(0,u.makeTestId)("test-floating-popup-"),f="floatingPopupTooltip";class g extends u.Disposable{constructor(e={}){super(),this._options=e,this._isMinimized=u.Observable.create(this,!1),this._closable=null!=(i=this._options.closeButton)&&i,this._minimizable=null!=(n=this._options.minimizable)&&n,this._minHeight=null!=(s=this._options.minHeight)?s:300,this._isFinishingMove=!1,this._popupElement=null,this._popupMinimizeButtonElement=null,this._resize=!1,this._cursorGrab=null,e.stopClickPropagationOnMove&&window.addEventListener("click",(e=>{var t;return this._isFinishingMove?(e.stopPropagation(),void(this._isFinishingMove=!1)):(null==(t=this._popupMinimizeButtonElement)?void 0:t.contains(e.target))?(e.stopPropagation(),void this._minimizeOrMaximize()):void 0}),{capture:!0}),this._handleMouseDown=this._handleMouseDown.bind(this),this._handleMouseMove=this._handleMouseMove.bind(this),this._handleMouseUp=this._handleMouseUp.bind(this),this._handleTouchStart=this._handleTouchStart.bind(this),this._handleTouchMove=this._handleTouchMove.bind(this),this._handleTouchEnd=this._handleTouchEnd.bind(this),this._handleWindowResize=this._handleWindowResize.bind(this),this.autoDispose((0,c.isNarrowScreenObs)().addListener((()=>this._repositionPopup()))),this.onDispose((()=>{var e;this._disposePopup(),null==(e=this._cursorGrab)||e.dispose()}))}showPopup(){this._popupElement=this._buildPopup(),document.body.appendChild(this._popupElement);const{initialPosition:e}=this._options;if(e)this._setPosition(e),this._repositionPopup();else{const e=document.body.offsetWidth-this._popupElement.offsetWidth-p,t=document.body.offsetHeight-this._popupElement.offsetHeight-b();this._setPosition([e,t])}}_closePopup(){this._closable&&this._disposePopup()}_buildTitle(){var e,t,o;return null!=(o=null==(t=(e=this._options).title)?void 0:t.call(e))?o:null}_buildContent(){var e,t,o;return null!=(o=null==(t=(e=this._options).content)?void 0:t.call(e))?o:null}_buildArgs(){var e;return null!=(e=this._options.args)?e:[]}_disposePopup(){this._popupElement&&(document.body.removeChild(this._popupElement),u.dom.domDispose(this._popupElement),this._popupElement=null)}_setPosition([e,t]){this._popupElement&&(this._popupElement.style.left=`${e}px`,this._popupElement.style.top=`${t}px`)}_rememberPosition(){this._initialLeft=this._popupElement.offsetLeft,this._initialTop=this._popupElement.offsetTop,this._initialBottom=this._popupElement.offsetTop+this._popupElement.offsetHeight}_handleMouseDown(e){0===e.button&&(this._startX=e.clientX,this._startY=e.clientY,this._rememberPosition(),document.addEventListener("mousemove",this._handleMouseMove),document.addEventListener("mouseup",this._handleMouseUp),this._forceCursor())}_handleTouchStart(e){this._startX=e.touches[0].clientX,this._startY=e.touches[0].clientY,this._rememberPosition(),document.addEventListener("touchmove",this._handleTouchMove),document.addEventListener("touchend",this._handleTouchEnd),this._resize=!1,this._forceCursor()}_handleTouchMove({touches:e}){this._handleMouseMove(e[0])}_handleMouseMove({clientX:e,clientY:t}){this._resize?this._handleResize(t):this._handleMove(e,t)}_handleResize(e){const t=e-this._startY;if(this._resize&&!(0,c.isNarrowScreen)()){let e=this._initialBottom-711,o=this._initialBottom-this._minHeight;e=Math.max(e,b()),o=Math.min(document.body.offsetHeight-30-2,o);const i=Math.max(e,Math.min(o,this._initialTop+t)),n=this._initialBottom-i;return this._popupElement.style.top=`${i}px`,void this._popupElement.style.setProperty("--height",`${n}px`)}}_handleMove(e,t){const o=e-this._startX,i=t-this._startY,n={right:document.body.offsetWidth,bottom:document.body.offsetHeight,top:b(),left:0};n.right+=this._popupElement.offsetWidth-128,n.left-=this._popupElement.offsetWidth-128,n.bottom+=this._popupElement.offsetHeight-30-2;let s=this._initialLeft+o,r=this._initialTop+i;const l=e=>(void 0!==e&&(s=e-this._popupElement.offsetWidth),s+this._popupElement.offsetWidth),a=e=>(void 0!==e&&(r=e-this._popupElement.offsetHeight),r+this._popupElement.offsetHeight);s<n.left&&(s=n.left),l()>n.right&&l(n.right),r<n.top&&(r=n.top),a()>n.bottom&&a(n.bottom),this._popupElement.style.left=`${s}px`,this._popupElement.style.top=`${r}px`}_handleMouseUp(){this._isFinishingMove=!0,document.removeEventListener("mousemove",this._handleMouseMove),document.removeEventListener("mouseup",this._handleMouseUp),document.body.removeEventListener("mouseleave",this._handleMouseUp),this._handleMouseEnd()}_handleTouchEnd(){document.removeEventListener("touchmove",this._handleTouchMove),document.removeEventListener("touchend",this._handleTouchEnd),document.body.removeEventListener("touchcancel",this._handleTouchEnd),this._handleMouseEnd()}_handleMouseEnd(){var e;this._resize=!1,null==(e=this._cursorGrab)||e.dispose()}_handleWindowResize(){this._repositionPopup()}_repositionPopup(){let e=this._popupElement.offsetLeft,t=this._popupElement.offsetTop;const o=b();e-p<0&&(e=p),t-o<0&&(t=o),e+p>document.body.offsetWidth-this._popupElement.offsetWidth&&(e=document.body.offsetWidth-this._popupElement.offsetWidth-p),t+o>document.body.offsetHeight-this._popupElement.offsetHeight&&(t=document.body.offsetHeight-this._popupElement.offsetHeight-o),this._popupElement.style.left=`${e}px`,this._popupElement.style.top=`${t}px`}_minimizeOrMaximize(){this._minimizable&&(this._isMinimized.set(!this._isMinimized.get()),this._repositionPopup())}_buildPopup(){var e;const t=x({tabIndex:"-1"},x.cls("-auto",null!=(e=this._options.autoHeight)&&e),u.dom.style("min-height",`${this._minHeight}px`),C(O(m("move-handle")),u.dom.maybe((e=>!e(this._isMinimized)),(()=>R(F(m("resize-handle")),u.dom.on("mousedown",(()=>this._resize=!0)),u.dom.on("dblclick",(e=>{var t;e.stopImmediatePropagation(),null==(t=this._popupElement)||t.style.setProperty("--height","711px"),this._repositionPopup()}))))),u.dom.domComputed(this._isMinimized,(e=>{var t;return[D(I((0,d.icon)("Maximize"),u.dom.show(this._minimizable)),I((0,d.icon)("CrossBig"),u.dom.show(this._closable)),u.dom.style("visibility","hidden")),S(k(this._buildTitle()),m("title")),D(this._popupMinimizeButtonElement=I(e?(0,d.icon)("Maximize"):(0,d.icon)("Minimize"),(0,a.hoverTooltip)(h(e?"Maximize":"Minimize"),{key:f}),u.dom.on("click",(()=>this._minimizeOrMaximize())),u.dom.show(this._minimizable),m("minimize-maximize")),I((0,d.icon)(null!=(t=this._options.closeButtonIcon)?t:"CrossBig"),this._options.closeButtonHover&&(0,a.hoverTooltip)(this._options.closeButtonHover(),{key:f}),u.dom.on("click",(()=>{var e,t;null!=(null==(t=(e=this._options).onClose)?void 0:t.call(e))||this._closePopup()})),u.dom.show(this._closable),m("close")),u.dom.on("mousedown",(e=>e.stopPropagation())),u.dom.on("touchstart",(e=>e.stopPropagation())))]})),u.dom.on("mousedown",this._handleMouseDown),u.dom.on("touchstart",this._handleTouchStart),u.dom.on("dblclick",(()=>this._minimizeOrMaximize())),m("header")),E(this._buildContent(),E.cls("-minimized",this._isMinimized)),(()=>{window.addEventListener("resize",this._handleWindowResize)}),u.dom.onDispose((()=>{document.removeEventListener("mousemove",this._handleMouseMove),document.removeEventListener("mouseup",this._handleMouseUp),document.removeEventListener("touchmove",this._handleTouchMove),document.removeEventListener("touchend",this._handleTouchEnd),window.removeEventListener("resize",this._handleWindowResize)})),x.cls("-minimized",this._isMinimized),x.cls("-mobile",(0,c.isNarrowScreenObs)()),m("window"),this._buildArgs());if(this._options.autoHeight){const e=new MutationObserver((()=>{this._repositionPopup()}));e.observe(t,{childList:!0,subtree:!0}),u.dom.update(t,u.dom.onDispose((()=>e.disconnect())))}return t}_forceCursor(){var e;null==(e=this._cursorGrab)||e.dispose();const t=this._resize?"ns-resize":"grabbing";this._cursorGrab=(0,l.F)(t)}}function b(){return p+((0,c.isNarrowScreen)()?50:0)}const v="min(var(--height), calc(100% - (2 * 16px)))",y="min(var(--height), calc(100% - (2 * 16px) - (2 * 50px)))",_=436,w=`min(${_}px, calc(100% - (2 * 16px)))`,x=(0,u.styled)("div.floating-popup",`\n  position: fixed;\n  display: flex;\n  flex-direction: column;\n  border: 2px solid ${c.theme.accentBorder};\n  border-radius: 5px;\n  z-index: ${c.vars.floatingPopupZIndex};\n  --height: 711px;\n  height: ${v};\n  width: ${w};\n  background-color: ${c.theme.popupBg};\n  box-shadow: 0 2px 18px 0 ${c.theme.popupInnerShadow}, 0 0 1px 0 ${c.theme.popupOuterShadow};\n  outline: unset;\n\n  &-mobile {\n    height: ${y};\n  }\n\n  &-minimized {\n    max-width: 225px;\n    height: unset;\n    min-height: unset;\n  }\n\n  &-minimized:not(&-mobile) {\n    max-height: ${v};\n  }\n\n  &-minimized&-mobile {\n    max-height: ${y};\n  }\n\n  &-auto {\n    height: auto;\n    max-height: ${v};\n    min-height: unset;\n  }\n\n  &-auto&-mobile {\n    max-height: ${y};\n  }\n`),C=(0,u.styled)("div",`\n  color: ${c.theme.tutorialsPopupHeaderFg};\n  --icon-color: ${c.theme.tutorialsPopupHeaderFg};\n  background-color: ${c.theme.accentBorder};\n  align-items: center;\n  flex-shrink: 0;\n  cursor: grab;\n  padding-left: 4px;\n  padding-right: 4px;\n  height: 30px;\n  user-select: none;\n  display: flex;\n  justify-content: space-between;\n  position: relative;\n  isolation: isolate;\n  &:active {\n    cursor: grabbing;\n  }\n`),D=(0,u.styled)("div","\n  display: flex;\n  column-gap: 8px;\n  align-items: center;\n"),S=(0,u.styled)("div","\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  font-weight: 600;\n  overflow: hidden;\n"),k=(0,u.styled)("div","\n  overflow: hidden;\n  white-space: nowrap;\n  text-overflow: ellipsis;\n"),T=(0,u.styled)("div","\n  flex-grow: 1;\n  padding: 24px;\n  overflow: auto;\n"),I=(0,u.styled)("div",`\n  padding: 4px;\n  border-radius: 4px;\n  cursor: pointer;\n  z-index: 1000;\n\n  &:hover {\n    background-color: ${c.theme.hover};\n  }\n`),R=(0,u.styled)("div","\n  position: absolute;\n  top: -6px;\n  left: 0;\n  right: 0;\n  bottom: 28px;\n  z-index: 500;\n  cursor: ns-resize;\n"),F=(0,u.styled)("div","\n  position: absolute;\n  top: 0;\n  left: 0;\n  width: 1px;\n  height: 1px;\n  pointer-events: none;\n  user-select: none;\n  visibility: hidden;\n"),O=(0,u.styled)(F,"\n  top: unset;\n  bottom: 0;\n  left: 0;\n"),E=(0,u.styled)("div","\n  display: flex;\n  flex-direction: column;\n  flex-grow: 1;\n  overflow: hidden;\n\n  &-minimized {\n    display: none;\n  }\n")},22641:(e,t,o)=>{"use strict";o.d(t,{FU:()=>_,lt:()=>D,ng:()=>S});var i,n=o(70387),s=o(38109),r=o(36258),l=o(7485),a=o(21602),c=o(8881),d=o(33769),u=o(11187),p=o(29922),h=o(7454),m=o(20742),f=o(83277),g=o(1310),b=o(21467);const v=o(83116),y=(0,n.makeT)("PageWidgetPicker");function _(e){const t=(0,a.N3)({srcSectionRef:e.linkSrcSectionRef.peek(),srcColRef:e.linkSrcColRef.peek(),targetColRef:e.linkTargetColRef.peek()});return{type:e.parentKey.peek(),table:e.table.peek().summarySourceTable.peek()||e.tableRef.peek(),summarize:Boolean(e.table.peek().summarySourceTable.peek()),columns:e.table.peek().columns.peek().peek().filter((e=>e.summarySourceCol.peek())).map((e=>e.summarySourceCol.peek())),link:t,section:e.id.peek()}}const w=(0,g.makeTestId)("test-wselect-");function x(e,t){return"New Table"!==e?["record","single","detail","chart","custom","custom.calendar"]:t?["record"]:["record","single","detail"]}function C(e,t,o){return null!==e&&x(e,o).includes(t)}function D(e,t,o,i={}){i.placement="left",(0,b.setPopupToCreateDom)(e,(e=>k(e,t,o,i)),{placement:"left",trigger:["click"],attach:"body",boundaries:"viewport"})}function S(e,t,o,i={}){(0,b.popupOpen)(e,(e=>k(e,t,o,i)),{placement:"right"})}function k(e,t,o,i={}){const{behavioralPromptsManager:n,docModel:s}=t,r=(0,g.fromKo)(s.visibleTables.getObservable()),l=(0,g.fromKo)(s.columns.createAllRowsModel("parentPos").getObservable()),c={type:"record",table:null,summarize:!1,columns:[],link:a.bG,section:0},u=i.value&&i.value()||c,p={type:g.Observable.create(e,u.type),table:g.Observable.create(e,u.table),summarize:g.Observable.create(e,u.summarize),columns:g.Observable.create(e,u.columns),link:g.Observable.create(e,u.link),section:g.Observable.create(e,u.section)};async function h(){e.close();const t=p.type.get(),i=o({type:t,table:p.table.get(),summarize:p.summarize.get(),columns:q(p.columns.get(),l.get().map((e=>e.id.peek()))),link:p.link.get(),section:p.section.get()});if("New Table"===p.table.get())await i;else if(await(0,f.isLongerThan)(i,500)){const e=(0,d.a)(t).label;await(0,m.spinnerModal)(y("Building {{- label}} widget",{label:e}),i)}}return i.placement&&"left"===i.placement&&e.autoDispose(p.summarize.addListener(((t,o)=>t&&e.update()))),E(g.dom.create(R,p,r,l,h,n,i),(e=>{setTimeout((()=>e.focus()),0)}),(0,g.onKeyDown)({Escape:()=>e.close(),Enter:()=>C(p.table.get(),p.type.get(),i.isNewPage)&&h()}))}const T=["custom.calendar"],I=["record","single","detail","chart",...(null!=(i=(0,r.PERMITTED_CUSTOM_WIDGETS)().get().map((e=>e)))?i:[]).filter((e=>T.includes(e))),"custom"];class R extends(179==o.j?g.Disposable:null){constructor(e,t,o,i,n,s={}){super(),this._value=e,this._tables=t,this._columns=o,this._onSave=i,this._behavioralPromptsManager=n,this._options=s,this._selectByOptions=this._options.selectBy?g.Computed.create(this,(e=>{const t={type:e(this._value.type),table:e(this._value.table),summarize:e(this._value.summarize),columns:e(this._value.columns),link:this._value.link.get(),section:e(this._value.section)};return this._options.selectBy(t)})):null,this._isNewTableDisabled=g.Computed.create(this,this._value.type,((e,t)=>!C("New Table",t,this._options.isNewPage)))}buildDom(){return O(w("container"),A(M(F(y("Select Widget")),I.map((e=>{const{label:t,icon:o}=(0,d.a)(e),i=(0,g.computed)(this._value.table,((t,o)=>this._isTypeDisabled(e,o)));return B(g.dom.autoDispose(i),L(o),t,g.dom.on("click",(()=>!i.get()&&this._selectType(e))),B.cls("-selected",(t=>t(this._value.type)===e)),B.cls("-disabled",i),w("type"))}))),M(w("data"),F(y("Select Data")),B($("TypeTable"),"New Table",g.dom.on("click",(e=>!this._isNewTableDisabled.get()&&this._selectTable("New Table"))),this._behavioralPromptsManager.attachTip("pageWidgetPicker",{popupOptions:{attach:null,placement:"right-start"}}),B.cls("-selected",(e=>"New Table"===e(this._value.table))),B.cls("-disabled",this._isNewTableDisabled),w("table")),g.dom.forEach(this._tables,(e=>(0,g.dom)("div",V(B($("TypeTable"),N(g.dom.text(e.tableNameDef),(0,c.overflowTooltip)()),g.dom.on("click",(()=>this._selectTable(e.id()))),B.cls("-selected",(t=>t(this._value.table)===e.id())),w("table-label")),H(j("Pivot"),B.cls("-selected",(t=>t(this._value.summarize)&&t(this._value.table)===e.id())),g.dom.on("click",((t,o)=>this._selectPivot(e.id(),o))),w("pivot")),w("table")))))),M(F(y("Group by")),g.dom.hide((e=>!e(this._value.summarize))),(0,g.domComputed)((e=>e(this._columns).filter((t=>!t.isHiddenCol()&&t.parentId()===e(this._value.table)))),(e=>e?g.dom.forEach(e,(e=>B($("FieldColumn"),z(g.dom.text(e.label)),g.dom.on("click",(()=>this._toggleColumnId(e.id()))),B.cls("-selected",(t=>t(this._value.columns).includes(e.id()))),w("column")))):null)))),U(W(g.dom.maybe((e=>this._selectByOptions&&e(this._selectByOptions).length>1),(()=>(0,c.withInfoTooltip)(K(Y("SELECT BY"),g.dom.update(G(this._value.link,this._selectByOptions),w("selectby"))),l.D.selectBy(),{tooltipMenuOptions:{attach:null},domArgs:[this._behavioralPromptsManager.attachTip("pageWidgetPickerSelectBy",{popupOptions:{attach:null,placement:"bottom"}})]}))),(0,g.dom)("div",{style:"flex-grow: 1"}),(0,u.bigPrimaryButton)(this._options.buttonLabel||y("Add to Page"),g.dom.prop("disabled",(e=>!C(e(this._value.table),e(this._value.type),this._options.isNewPage))),g.dom.on("click",(()=>this._onSave().catch(s.eK))),w("addBtn")))))}_closeSummarizePanel(){this._value.summarize.set(!1),this._value.columns.set([])}_openSummarizePanel(){this._value.summarize.set(!0)}_selectType(e){this._value.type.set(e)}_selectTable(e){e!==this._value.table.get()&&this._value.link.set(a.bG),this._value.table.set(e),this._closeSummarizePanel()}_isSelected(e){return e.classList.contains(B.className+"-selected")}_selectPivot(e,t){this._isSelected(t)?this._closeSummarizePanel():(e!==this._value.table.get()&&(this._value.columns.set([]),this._value.table.set(e),this._value.link.set(a.bG)),this._openSummarizePanel())}_toggleColumnId(e){const t=this._value.columns.get(),o=t.includes(e)?v(t,e):[...t,e];this._value.columns.set(o)}_isTypeDisabled(e,t){return null!==t&&!x(t,this._options.isNewPage).includes(e)}}function F(e,...t){return P((0,g.dom)("h4",e),...t,w("heading"))}const O=(0,g.styled)("div",`\n  --outline: 1px solid ${p.theme.widgetPickerBorder};\n\n  max-height: 386px;\n  box-shadow: 0 2px 20px 0 ${p.theme.widgetPickerShadow};\n  border-radius: 2px;\n  display: flex;\n  flex-direction: column;\n  user-select: none;\n  background-color: ${p.theme.widgetPickerPrimaryBg};\n`),E=(0,g.styled)("div","\n  &:focus {\n    outline: none;\n  }\n"),A=(0,g.styled)("div","\n  display: flex;\n  min-height: 0;\n"),M=(0,g.styled)("div",`\n  width: 224px;\n  font-size: ${p.vars.mediumFontSize};\n  overflow: auto;\n  padding-bottom: 18px;\n  &:nth-of-type(2n) {\n    background-color: ${p.theme.widgetPickerSecondaryBg};\n    outline: var(--outline);\n  }\n`),P=(0,g.styled)("div",`\n  color: ${p.theme.text};\n  margin: 24px 0 24px 24px;\n  font-size: ${p.vars.mediumFontSize};\n`),B=(0,g.styled)("div",`\n  color: ${p.theme.widgetPickerItemFg};\n  padding: 0 0 0 24px;\n  height: 32px;\n  display: flex;\n  flex-direction: row;\n  flex: 1 1 0px;\n  align-items: center;\n  white-space: nowrap;\n  overflow: hidden;\n  cursor: pointer;\n  &-selected {\n    background-color: ${p.theme.widgetPickerItemSelectedBg};\n  }\n  &-disabled {\n    color: ${p.theme.widgetPickerItemDisabledBg};\n    cursor: default;\n  }\n  &-disabled&-selected {\n    background-color: inherit;\n  }\n`),$=(0,g.styled)(h.icon,`\n  margin-right: 8px;\n  flex-shrink: 0;\n  --icon-color: ${p.theme.widgetPickerIcon};\n  .${B.className}-disabled > & {\n    opacity: 0.25;\n  }\n`),L=(0,g.styled)($,`\n  --icon-color: ${p.theme.widgetPickerPrimaryIcon};\n`),N=(0,g.styled)("span","\n  text-overflow: ellipsis;\n  overflow: hidden;\n"),z=(0,g.styled)(N,"\n  padding-right: 8px;\n"),V=(0,g.styled)("div","\n  display: flex;\n  align-items: center;\n"),H=(0,g.styled)(B,"\n  width: 48px;\n  padding-left: 8px;\n  flex: 0 0 auto;\n"),j=(0,g.styled)(h.icon,`\n  width: 24px;\n  height: 24px;\n  background-color: ${p.theme.widgetPickerSummaryIcon};\n`),U=(0,g.styled)("div","\n  display: flex;\n  border-top: var(--outline);\n"),W=(0,g.styled)("div","\n  flex-grow: 1;\n  height: 65px;\n  display: flex;\n  flex-direction: row;\n  align-items: center;\n  padding: 0 24px 0 24px;\n"),Y=(0,g.styled)("span",`\n  color: ${p.theme.text};\n  font-size: ${p.vars.xsmallFontSize};\n  margin-right: 8px;\n`),G=(0,g.styled)(g.select,`\n  color: ${p.theme.selectButtonFg};\n  background-color: ${p.theme.selectButtonBg};\n  flex: 1 0 160px;\n  width: 160px;\n`),K=(0,g.styled)("div","\n  display: flex;\n  align-items: center;\n");function q(e,t){const o={};for(const[e,i]of t.entries())o[i]=e;return e.slice().sort(((e,t)=>(0,f.nativeCompare)(o[e],o[t])))}},71571:(e,t,o)=>{"use strict";o.d(t,{QN:()=>_e,lX:()=>xe,Ql:()=>ye});var i=o(77709),n=o(13988),s=o(15323),r=o(51536),l=o(29922),a=o(7454),c=o(1370),d=o(83277),u=o(1310),p=o(29301),h=o.n(p),m=o(21467),f=o(70387);const g=(0,f.makeT)("RefSelect");class b extends(179==o.j?u.Disposable:null){constructor(e){super(),this._docModel=e.docModel,this._origColumn=e.origColumn,this._colId=this._origColumn.colId,this.isForeignRefCol=this.autoDispose(h().computed((()=>{const e=this._origColumn.refTable();return Boolean(e&&e.getRowId()!==this._origColumn.parentId())}))),this._fieldObs=this.autoDispose(h().computed((()=>{const t=e.fieldBuilder();return t?t.field:null}))),this._validCols=this.autoDispose(h().computed((()=>{const e=this._origColumn.refTable();return e?e.columns().all().filter((e=>!e.isHiddenCol()&&!d.startsWith(e.type(),"Ref:"))):[]})));const t=this.autoDispose(h().computed((()=>this.isForeignRefCol()&&this._fieldObs()?this._getReferencedCols(this._fieldObs()).map((e=>({label:e.label(),value:e.colId()}))):[])));this._added=this.autoDispose(n.syncedKoArray(t)),this._addedSet=this.autoDispose(h().computed((()=>new Set(this._added.all().map((e=>e.value))))))}buildDom(){return v((0,l.testId)("ref-select"),u.dom.forEach((0,u.fromKo)(this._added.getObservable()),(e=>(0,r.B3)((0,r.Tw)(u.dom.text(e.label)),x("Remove",u.dom.on("click",(()=>this._removeFormulaField(e))),(0,l.testId)("ref-select-remove")),(0,l.testId)("ref-select-item")))),_(w("Plus"),g("Add Column"),(0,m.menu)((()=>[...this._validCols.peek().filter((e=>!this._addedSet.peek().has(e.colId.peek()))).map((e=>(0,m.menuItem)((()=>this._addFormulaField({label:e.label(),value:e.colId()})),e.label.peek()))),y(g("No columns to add")),(0,l.testId)("ref-select-menu")])),(0,l.testId)("ref-select-add")))}async _addFormulaField(e){const t=this._fieldObs();if(!t)return;const o=this._docModel.dataTables[this._origColumn.table().tableId()].tableData,i=this._origColumn.table().columns().all().find((t=>t.formula()===`$${this._colId()}.${e.value}`&&!t.isHiddenCol())),n=t.viewSection().viewFields(),r=n.all().sort(((e,t)=>e.parentPos()>t.parentPos()?1:-1)).findIndex((e=>e.getRowId()===t.getRowId())),l=s.fieldInsertPositions(n,r+1)[0];let a;a=i?Promise.resolve({colRef:i.getRowId(),colId:i.colId()}):o.sendTableAction(["AddColumn",`${this._colId()}_${e.value}`,{type:"Any",isFormula:!0,formula:`$${this._colId()}.${e.value}`,_position:l}]);const c=await a;if(t.viewSection().isRaw())return;const d={colRef:c.colRef,parentId:t.viewSection().getRowId(),parentPos:l};return this._docModel.viewFields.sendTableAction(["AddRecord",null,d])}_removeFormulaField(e){const t=this._docModel.dataTables[this._origColumn.table().tableId()].tableData;this._getReferrerFields(e.value).forEach((e=>{const o=this._fieldObs().viewSection().getRowId();return e.column().viewFields().all().filter((e=>!e.viewSection().isRaw())).some((e=>e.parentId()!==o))?this._docModel.viewFields.sendTableAction(["RemoveRecord",e.getRowId()]):t.sendTableAction(["RemoveColumn",e.column().colId()])}))}_getReferrerFields(e){const t=new RegExp("^\\$"+this._colId()+"\\."+e+"$");return this._fieldObs().viewSection().viewFields().all().filter((e=>t.exec(e.column().formula())))}_getReferencedCols(e){const t=this._getFormulaMatchSet(e);return this._validCols().filter((e=>t.has(e.colId())))}_getFormulaMatchSet(e){const t=e.viewSection().viewFields().all(),o=new RegExp("^\\$"+this._colId()+"\\.(\\w+)$");return new Set(t.map((e=>{const t=o.exec(e.column().formula());return t?t[1]:null})))}}const v=(0,u.styled)("div",`\n  display: flex;\n  flex-direction: column;\n  width: 100%;\n\n  & > .${r.B3.className} {\n    margin: 2px 0;\n  }\n`),y=(0,u.styled)(c.menuText,"\n  font-size: inherit;\n  &:not(:first-child) {\n    display: none;\n  }\n"),_=(0,u.styled)("div",`\n  display: flex;\n  cursor: pointer;\n  color: ${l.colors.lightGreen};\n  --icon-color: ${l.colors.lightGreen};\n\n  &:not(:first-child) {\n    margin-top: 8px;\n  }\n  &:hover, &:focus, &:active {\n    color: ${l.colors.darkGreen};\n    --icon-color: ${l.colors.darkGreen};\n  }\n`),w=(0,u.styled)(a.icon,"\n  margin-right: 4px;\n"),x=(0,u.styled)(a.icon,`\n  display: none;\n  cursor: pointer;\n  flex: none;\n  margin-left: 8px;\n  .${r.B3.className}:hover & {\n    display: block;\n  }\n`);var C=o(88101),D=o(62258),S=o(56209),k=o(38109),T=o(73783),I=o(82882),R=o(92769),F=o(3411),O=o(11187),E=o(13884),A=o(29002),M=o(4425),P=o(21296);const B=(0,f.makeT)("CustomSectionConfig"),$="custom",L=(0,u.makeTestId)("test-config-widget-");class N extends(179==o.j?u.Disposable:null){constructor(e,t,o){super(),this._value=e,this._column=t,this._section=o}buildDom(){const e=u.Computed.create(this,(e=>{const t=e(this._value);return Array.isArray(t)?null:t}));e.onWrite((e=>this._value.set(e)));const t=u.Computed.create(this,(e=>e(this._section.columns).filter((t=>this._column.canByMapped(e(t.pureType)))).map((t=>({value:t.getRowId(),label:e(t.label),icon:"FieldColumn"})))));return[(0,F.cssLabel)(this._column.title,this._column.optional?X(B(" (optional)")):null,L("label-for-"+this._column.name)),this._column.description?(0,F.cssHelp)(this._column.description,L("help-for-"+this._column.name)):null,(0,F.cssRow)((0,c.select)(e,t,{defaultLabel:"any"!=this._column.typeDesc?B("Pick a {{columnType}} column",{columnType:this._column.typeDesc}):B("Pick a column")}),L("mapping-for-"+this._column.name))]}}class z extends(179==o.j?u.Disposable:null){constructor(e,t,o){super(),this._value=e,this._column=t,this._section=o,this._typeFilter=(e=d.unwrap)=>t=>this._column.canByMapped(e(t.pureType))}buildDom(){return u.dom.domComputed((e=>[(0,F.cssLabel)(this._column.title,F.cssLabel.cls("-required",!this._column.optional),L("label-for-"+this._column.name)),this._buildDraggableList(e),this._buildAddColumn()]))}_buildAddColumn(){return[(0,F.cssRow)(Q(q("Plus"),B("Add")+" "+this._column.title,(0,c.menu)((()=>{const e=this._getNotMappedColumns(),t=e.filter(this._typeFilter()),o=e.length-t.length;return[...t.map((e=>(0,c.menuItem)((()=>this._addColumn(e)),e.label.peek()))),o>0?(0,c.menuText)(B("{{wrongTypeCount}} non-{{columnType}} columns are not shown",{wrongTypeCount:o,columnType:this._column.type.toLowerCase(),count:o}),L("map-message-"+this._column.name)):null]})),L("add-column-for-"+this._column.name)))]}_buildDraggableList(e){return u.dom.update(T.draggableList(this._readItems(e),this._renderItem.bind(this,e),{itemClass:r.KM.className,reorder:this._reorder.bind(this),receive:this._addColumn.bind(this),drag_indicator:E.x}),L("map-list-for-"+this._column.name))}_getNotMappedColumns(){const e=this._section.columns.peek(),t=this._list();return e.filter((e=>!t.includes(e.id.peek())))}_readItems(e){let t=e(this._value)||[];Array.isArray(t)||(t=[]);const o=e(this._section.columns).filter(this._typeFilter(e)),i=new Map(o.map((e=>[e.id.peek(),e])));return t.map((e=>i.get(e))).filter((e=>Boolean(e)))}_renderItem(e,t){return(0,r.B3)((0,r.Tw)(u.dom.text(t.label),L("ref-select-label")),J("Remove",u.dom.on("click",(()=>this._remove(t))),L("ref-select-remove")))}_list(e){if(!e){let e=this._value.get()||[];return Array.isArray(e)||(e=[]),e}this._value.set(e)}_reorder(e,t){const o=e.id.peek(),i=null==t?void 0:t.id.peek(),n=this._list(),s=n.indexOf(o);n.splice(s,1);const r=i?n.indexOf(i):n.length;n.splice(r,0,o),this._list(n)}_remove(e){const t=this._list();this._value.set(t.filter((t=>t!=e.id.peek())))}_addColumn(e){const t=this._list();t.push(e.id.peek()),this._value.set(t)}}class V extends(179==o.j?u.Disposable:null){constructor(e){super(),this._section=e,this._hasConfiguration=u.Computed.create(this,(t=>t(e.hasCustomOptions)))}buildDom(){return(0,u.dom)("div",u.dom.maybe(this._hasConfiguration,(()=>G((0,O.textButton)(B("Open configuration"),u.dom.on("click",(()=>this._openConfiguration())),L("open-configuration"))))),u.dom.maybeOwned((e=>e(this._section.columnsToMap)),((e,t)=>{const o=t=>{const o=u.Computed.create(e,(e=>(e(this._section.customDef.columnsMapping)||{})[t.name]));return o.onWrite((async e=>{const o=this._section.customDef.columnsMapping.peek()||{};o[t.name]=e,await this._section.customDef.columnsMapping.setAndSave(o)})),o};return[...t.map((e=>new I.V(e))).map((e=>({value:o(e),column:e}))).map((e=>e.column.allowMultiple?u.dom.create(z,e.value,e.column,this._section):u.dom.create(N,e.value,e.column,this._section)))]})))}_openConfiguration(){i.allCommands.openWidgetConfiguration.run()}}class H extends(179==o.j?u.Disposable:null){constructor(e,t){var o;super(),this._section=e,this._gristDoc=t,this._canSelect=!0,this._customSectionConfigurationConfig=new V(e);const i=window.gristConfig||{};this._canSelect=null==(o=i.enableWidgetRepository)||o,this._widgets=u.Observable.create(this,[]),this._getWidgets().catch(R.reportError),this._selectedId=u.Computed.create(this,(t=>t(e.customDef.widgetDef)?e.customDef.widgetDef.peek().widgetId:$)),this._selectedId.onWrite((async t=>{var o;if(t===$)(0,u.bundleChanges)((()=>{e.customDef.url(null),e.customDef.widgetDef(null),e.customDef.access(P.u.none),e.customDef.widgetOptions(null),e.hasCustomOptions(!1),e.customDef.columnsMapping(null),e.columnsToMap(null),this._desiredAccess.set(P.u.none)})),await e.saveCustomDef();else{const i=this._widgets.get().find((e=>e.widgetId===t));if(!i)throw new Error("Error accessing widget from the list");if((null==(o=e.customDef.widgetDef.peek())?void 0:o.widgetId)===t)return;(0,u.bundleChanges)((()=>{e.customDef.access(P.u.none),this._desiredAccess.set(i.accessLevel||P.u.none),e.customDef.widgetDef(i),e.customDef.url(i.url),e.customDef.widgetOptions(null),e.hasCustomOptions(!1),e.customDef.columnsMapping(null),e.columnsToMap(null)})),await e.saveCustomDef()}})),this._url=u.Computed.create(this,(t=>t(e.customDef.url)||"")),this._url.onWrite((t=>e.customDef.url.setAndSave(t))),this._currentAccess=u.Computed.create(this,(t=>t(e.customDef.access)||P.u.none)),this._currentAccess.onWrite((async t=>{await e.customDef.access.setAndSave(t)})),this._desiredAccess=(0,u.fromKo)(e.desiredAccessLevel),this.autoDispose(e.id.subscribe((()=>this._reject())))}buildDom(){const e=new u.MultiHolder,t=u.Computed.create(e,(e=>e(this._desiredAccess)&&!(0,P.Z)(e(this._currentAccess),e(this._desiredAccess)))),o=u.Computed.create(e,(e=>Boolean(e(this._selectedId)))),i=u.Computed.create(e,(e=>e(this._selectedId)===$||!this._canSelect)),n=u.Computed.create(e,(e=>[{label:"Custom URL",value:"custom"},...e(this._widgets).map((e=>({label:e.name,value:e.widgetId})))])),s=[{label:B("No document access"),value:P.u.none},{label:B("Read selected table"),value:P.u.read_table},{label:B("Full document access"),value:P.u.full}];return(0,u.dom)("div",u.dom.autoDispose(e),this.shouldRenderWidgetSelector()&&this._canSelect?(0,F.cssRow)((0,c.select)(this._selectedId,n,{defaultLabel:B("Select Custom Widget"),menuCssClass:K.className}),L("select")):null,u.dom.maybe(i&&this.shouldRenderWidgetSelector(),(()=>[(0,F.cssRow)(Z(this._url,(async e=>this._url.set(e)),u.dom.attr("placeholder",B("Enter Custom URL")),L("url")),this._gristDoc.behavioralPromptsManager.attachTip("customURL",{popupOptions:{placement:"left-start"}}))])),u.dom.maybe(t,(()=>T.prompt({tabindex:"-1"},U(j((0,a.icon)("Lock")),(0,u.dom)("div",W(u.dom.domComputed(this._desiredAccess,(e=>function(e){if(!e)return null;switch(e){case P.u.none:return Y(B("Widget does not require any permissions."));case P.u.read_table:return Y(B("Widget needs to {{read}} the current table.",{read:(0,u.dom)("b","read")}));case P.u.full:return Y(B("Widget needs {{fullAccess}} to this document.",{fullAccess:(0,u.dom)("b","full access")}));default:throw new Error(`Unsupported ${e} access level`)}}(e)))),W((0,O.primaryButton)("Accept",L("access-accept"),u.dom.on("click",(()=>this._accept()))),(0,O.basicButton)("Reject",L("access-reject"),u.dom.on("click",(()=>this._reject()))))))))),u.dom.maybe((e=>e(o)||!this._canSelect),(()=>[(0,F.cssLabel)("ACCESS LEVEL"),(0,F.cssRow)((0,c.select)(this._currentAccess,s),L("access"))])),G((0,M.Y3)(u.dom.attr("href","https://support.getgrist.com/widget-custom"),u.dom.attr("target","_blank"),B("Learn more about custom widgets"))),(0,F.cssSeparator)(),this._customSectionConfigurationConfig.buildDom())}shouldRenderWidgetSelector(){return!0}async _getWidgets(){const e=this._gristDoc.app.topAppModel.api,t=await e.getWidgets();this._canSelect&&this._section.customDef.widgetDef.peek()&&t.push(this._section.customDef.widgetDef.peek()),this._widgets.set(t)}_accept(){this._desiredAccess.get()&&this._currentAccess.set(this._desiredAccess.get()),this._reject()}_reject(){this._desiredAccess.set(null)}}const j=(0,u.styled)("div",`\n  padding-left: 8px;\n  padding-top: 6px;\n  --icon-color: ${l.theme.iconError}\n`),U=(0,u.styled)("div","\n  display: flex;\n"),W=(0,u.styled)("div","\n  display: flex;\n  padding: 8px;\n  gap: 8px;\n"),Y=(0,u.styled)("span","\n  white-space: pre-wrap;\n"),G=(0,u.styled)("div","\n  margin: 16px 16px 12px 16px;\n"),K=(0,u.styled)("div",`\n  & > li:first-child {\n    border-bottom: 1px solid ${l.theme.menuBorder};\n  }\n`),q=(0,u.styled)(a.icon,"\n  margin-right: 4px;\n"),J=(0,u.styled)(a.icon,`\n  display: none;\n  cursor: pointer;\n  flex: none;\n  margin-left: 8px;\n  .${r.B3.className}:hover & {\n    display: block;\n  }\n`),X=(0,u.styled)("span",`\n  text-transform: none;\n  font-size: ${l.vars.xsmallFontSize};\n  color: ${l.theme.lightText};\n`),Q=(0,u.styled)("div",`\n  display: flex;\n  cursor: pointer;\n  color: ${l.theme.controlFg};\n  --icon-color: ${l.theme.controlFg};\n\n  &:not(:first-child) {\n    margin-top: 8px;\n  }\n  &:hover, &:focus, &:active {\n    color: ${l.theme.controlHoverFg};\n    --icon-color: ${l.theme.controlHoverFg};\n  }\n`),Z=(0,u.styled)(A.textInput,`\n  flex: 1 0 auto;\n\n  color: ${l.theme.inputFg};\n  background-color: ${l.theme.inputBg};\n\n  &:disabled {\n    color: ${l.theme.inputDisabledFg};\n    background-color: ${l.theme.inputDisabledBg};\n    pointer-events: none;\n  }\n\n  &::placeholder {\n    color: ${l.theme.inputPlaceholderFg};\n  }\n`);var ee=o(73181),te=o(91033);const oe=(0,f.makeT)("DescriptionConfig");function ie(e,t,o){let i;return e.autoDispose(o.cursor.subscribe((()=>{null==i||i.blur()}))),[(0,F.cssLabel)(oe("DESCRIPTION")),(0,F.cssRow)(i=ne((0,u.fromKo)(t),{onInput:!1},{rows:"3"},u.dom.on("blur",(async(e,o)=>{await t.saveOnly(o.value)})),(0,l.testId)(`${o.testPrefix}-description`),(0,ee.po)((0,u.fromKo)(t))))]}const ne=(0,u.styled)(te.J7,`\n  color: ${l.theme.inputFg};\n  background-color: ${l.theme.mainPanelBg};\n  border: 1px solid ${l.theme.inputBorder};\n  width: 100%;\n  outline: none;\n  border-radius: 3px;\n  padding: 3px 7px;\n  min-height: calc(3em * 1.5);\n\n  &::placeholder {\n    color: ${l.theme.inputPlaceholderFg};\n  }\n\n  &[readonly] {\n    background-color: ${l.theme.inputDisabledBg};\n    color: ${l.theme.inputDisabledFg};\n  }\n`);var se=o(32529),re=o(92478);const le=(0,f.makeT)("GridOptions");class ae extends(179==o.j?u.Disposable:null){constructor(e){super(),this._section=e}buildDom(){const e=this._section;return[(0,F.cssLabel)(le("Grid Options")),(0,u.dom)("div",[(0,F.cssRow)(de(ce(0,e.optionsObj.prop("verticalGridlines"))),le("Vertical Gridlines"),(0,l.testId)("v-grid-button")),(0,F.cssRow)(de(ce(0,e.optionsObj.prop("horizontalGridlines"))),le("Horizontal Gridlines"),(0,l.testId)("h-grid-button")),(0,F.cssRow)(de(ce(0,e.optionsObj.prop("zebraStripes"))),le("Zebra Stripes"),(0,l.testId)("zebra-stripe-button")),(0,l.testId)("grid-options")])]}}function ce(e,t){const o=u.Computed.create(null,(e=>e(t)));return o.onWrite((async e=>{await(0,se.setSaveValue)(t,e)})),o}const de=(0,u.styled)(re.n2,"\n  margin-right: 8px;\n");var ue=o(22641);class pe extends(179==o.j?H:null){constructor(e,t){super(e,t)}buildDom(){return this._customSectionConfigurationConfig.buildDom()}shouldRenderWidgetSelector(){return!1}async _getWidgets(){}}var he=o(21602),me=o(33769),fe=o(45689);const ge=(0,f.makeT)("RightPanel"),be=(0,fe.U)("pageWidget","field"),ve=(0,fe.U)("widget","sortAndFilter","data");function ye(e){const t=new Map([["record",{label:ge("Columns",{count:1}),icon:"TypeCell",pluralLabel:ge("Columns",{count:2})}],["detail",{label:ge("Fields",{count:1}),icon:"TypeCell",pluralLabel:ge("Fields",{count:2})}],["single",{label:ge("Fields",{count:1}),icon:"TypeCell",pluralLabel:ge("Fields",{count:2})}],["chart",{label:ge("Series",{count:1}),icon:"ChartLine",pluralLabel:ge("Series",{count:2})}],["custom",{label:ge("Columns",{count:1}),icon:"TypeCell",pluralLabel:ge("Columns",{count:2})}]]);return t.get(e||"record")||t.get("record")}class _e extends(179==o.j?u.Disposable:null){constructor(e,t){super(),this._gristDoc=e,this._isOpen=t,this._topTab=(0,S.h4)(this,"rightTopTab","pageWidget",be.guard),this._subTab=(0,S.h4)(this,"rightPageSubTab","widget",ve.guard),this._pageWidgetType=u.Computed.create(this,(e=>{const t=e(this._gristDoc.viewModel.activeSection);return e(t.parentKey)||null})),this._validSection=u.Computed.create(this,(e=>{const t=e(this._gristDoc.viewModel.activeSection);return t.getRowId()?t:null})),this._extraTool=e.rightPanelTool,this.autoDispose((0,u.subscribe)(this._extraTool,((e,o)=>o&&t.set(!0)))),this.header=this._buildHeaderDom(),this.content=this._buildContentDom(),this.autoDispose(i.createGroup({fieldTabOpen:()=>this._openFieldTab(),viewTabOpen:()=>this._openViewTab(),viewTabFocus:()=>this._viewTabFocus(),sortFilterTabOpen:()=>this._openSortFilter(),dataSelectionTabOpen:()=>this._openDataSelection()},this,!0))}_openFieldTab(){this._open("field")}_openViewTab(){this._open("pageWidget","widget")}_viewTabFocus(){this._focus("pageWidget")}_openSortFilter(){this._open("pageWidget","sortAndFilter")}_openDataSelection(){this._open("pageWidget","data")}_open(e,t){(0,u.bundleChanges)((()=>{this._isOpen.set(!0),this._topTab.set(e),t&&this._subTab.set(t)}))}_focus(e){(0,u.bundleChanges)((()=>{this._isOpen.get()&&(this._isOpen.set(!0),this._topTab.set(e))}))}_buildHeaderDom(){return u.dom.domComputed((e=>{if(!e(this._isOpen))return null;const t=e(this._extraTool);return t?this._buildToolHeader(t):this._buildStandardHeader()}))}_buildToolHeader(e){return Ie(Re(e.icon),e.label,Fe(Oe("CrossBig"),u.dom.on("click",(()=>this._gristDoc.showTool("none"))),(0,l.testId)("right-tool-close")),Ie.cls("-selected",!0))}_buildStandardHeader(){return u.dom.maybe(this._pageWidgetType,(e=>{const t=me.v.get(e)||{label:"Table",icon:"TypeTable"},o=ye(e);return[Ie(Re(t.icon),t.label,Ie.cls("-selected",(e=>"pageWidget"===e(this._topTab))),u.dom.on("click",(()=>this._topTab.set("pageWidget"))),(0,l.testId)("right-tab-pagewidget")),Ie(Re(o.icon),o.label,Ie.cls("-selected",(e=>"field"===e(this._topTab))),u.dom.on("click",(()=>this._topTab.set("field"))),(0,l.testId)("right-tab-field"))]}))}_buildContentDom(){return u.dom.domComputed((e=>{if(!e(this._isOpen))return null;const t=e(this._extraTool);if(t)return function(e){function t(e){return(0,u.dom)("div.config_item",u.dom.show(e.showObs||!0),e.buildDom())}return"buildDom"in e?e.buildDom():Me(u.dom.forEach(e,(e=>e.header?(0,u.dom)("div.config_group",u.dom.show(e.showObs||!0),e.label?(0,u.dom)("div.config_header",e.label):null,u.dom.forEach(e.items,(e=>t(e)))):t(e))))}(t.content);const o=e(this._topTab);return"field"===o?u.dom.create(this._buildFieldContent.bind(this)):"pageWidget"===o&&e(this._pageWidgetType)?u.dom.create(this._buildPageWidgetContent.bind(this)):null}))}_buildFieldContent(e){var t;const o=e.autoDispose(p.computed((()=>{var e,t;const o=null==(t=(e=this._gristDoc.viewModel).activeSection)?void 0:t.call(e).viewInstance();return o&&o.activeFieldBuilder()}))),i=e.autoDispose(p.computed((()=>{var e,t,i;const n=null==(t=(e=this._gristDoc.viewModel).activeSection)?void 0:t.call(e).viewInstance();if(n&&n.selectedColumns)return n.selectedColumns();const s=null==(i=o())?void 0:i.field;return s?[s]:[]}))),n=e.autoDispose(p.pureComputed((()=>{const e=i();return Boolean(e&&e.length>1)})));e.autoDispose(i.subscribe((t=>{if(e.isDisposed()||this._gristDoc.isDisposed()||this._gristDoc.viewModel.isDisposed())return;const o=this._gristDoc.viewModel.activeSection();o&&!o.isDisposed()&&o.selectedFields(t||[])}))),null==(t=this._gristDoc.viewModel.activeSection())||t.selectedFields(i.peek()||[]);const s=this._gristDoc.docModel,r=e.autoDispose(p.computed((()=>{var e;return(null==(e=o())?void 0:e.origColumn.origColRef())||0}))),a=e.autoDispose(s.columns.createFloatingRowModel(r)),c=e.autoDispose(p.computed((()=>Boolean(r())))),d=b.create(e,{docModel:s,origColumn:a,fieldBuilder:o}),h=e.autoDispose(p.computed((()=>{var e,t,o;const i=null==(t=(e=this._gristDoc.viewModel).activeSection)?void 0:t.call(e).viewInstance();return null!=(o=null==i?void 0:i.cursor.currentPosition())?o:{}})));return(0,C.b)(D.nt().then((e=>{const{buildNameConfig:t,buildFormulaConfig:i}=e.FieldConfig;return u.dom.maybe(c,(()=>xe(He(u.dom.create(t,a,h,n)),He(u.dom.create(ie,a.description,{cursor:h,testPrefix:"column"})),Pe(),He(u.dom.create(i,a,this._gristDoc,this._activateFormulaEditor.bind(this))),Pe(),u.dom.maybe(o,(e=>[(0,F.cssLabel)(ge("COLUMN TYPE")),He(e.buildSelectTypeDom()),He(e.buildSelectWidgetDom()),He(e.buildConfigDom()),e.buildColorConfigDom(),He(e.buildSettingOptions(),u.dom.maybe(n,(()=>we())))])),Pe(),He(u.dom.maybe(d.isForeignRefCol,(()=>[(0,F.cssLabel)(ge("Add referenced columns")),Se(d.buildDom()),Pe()])),(0,F.cssLabel)(ge("TRANSFORM")),u.dom.maybe(o,(e=>e.buildTransformDom())),u.dom.maybe(n,(()=>we())),(0,l.testId)("panel-transform")),this._disableIfReadonly())))})))}_activateFormulaEditor(e){const t=this._gristDoc.viewModel.activeSection().viewInstance();if(!t)return;const{refElem:o,editValue:i,canDetach:n,onSave:s,onCancel:r}=e,l=t.moveEditRowToCursor();return t.activeFieldBuilder.peek().openSideFormulaEditor({editRow:l,refElem:o,canDetach:n,editValue:i,onSave:s,onCancel:r})}_buildPageWidgetContent(e){return[Ee(Ae(ge("Widget"),Ae.cls("-selected",(e=>"widget"===e(this._subTab))),u.dom.on("click",(()=>this._subTab.set("widget"))),(0,l.testId)("config-widget")),Ae(ge("Sort & Filter"),Ae.cls("-selected",(e=>"sortAndFilter"===e(this._subTab))),u.dom.on("click",(()=>this._subTab.set("sortAndFilter"))),(0,l.testId)("config-sortAndFilter")),Ae(ge("Data"),Ae.cls("-selected",(e=>"data"===e(this._subTab))),u.dom.on("click",(()=>this._subTab.set("data"))),(0,l.testId)("config-data"))),u.dom.domComputed(this._subTab,(e=>u.dom.maybe(this._validSection,(t=>xe("widget"===e?u.dom.create(this._buildPageWidgetConfig.bind(this),t):"sortAndFilter"===e?u.dom.create(this._buildPageSortFilterConfig.bind(this)):"data"===e?u.dom.create(this._buildPageDataConfig.bind(this),t):null)))))]}_createViewConfigTab(e){const t=u.Observable.create(e,null),o=this._gristDoc;return D.nt().then((i=>{e.isDisposed()||t.set(e.autoDispose(i.ViewConfigTab.create({gristDoc:o,viewModel:o.viewModel})))})).catch(k.eK),t}_buildPageWidgetConfig(e,t){const o=this._createViewConfigTab(e),i=u.Computed.create(e,(e=>{const o=e(this._pageWidgetType),i="custom"===o||(null==o?void 0:o.startsWith("custom.")),n=e(t.columnsToMap);return Boolean(i&&n)})),n=e.autoDispose(p.computed((()=>{var e,t,o;const i=null==(t=(e=this._gristDoc.viewModel).activeSection)?void 0:t.call(e).viewInstance();return null!=(o=null==i?void 0:i.cursor.currentPosition())?o:{}})));return u.dom.maybe(o,(o=>[this._disableIfReadonly(),(0,F.cssLabel)(u.dom.text((e=>e(t.isRaw)?ge("DATA TABLE NAME"):ge("WIDGET TITLE"))),u.dom.style("margin-bottom","14px")),Se(Ve(u.Computed.create(e,(e=>e(t.titleDef))),(e=>t.titleDef.saveOnly(e)),u.dom.boolAttr("disabled",(e=>{const o=e(t.isRaw),i=0!==e(e(t.table).summarySourceTable);return o&&i})),(0,l.testId)("right-widget-title"))),He(u.dom.create(ie,t.description,{cursor:n,testPrefix:"right-widget"})),u.dom.maybe((e=>!e(t.isRaw)),(()=>Se((0,O.primaryButton)(ge("Change Widget"),this._createPageWidgetPicker()),Se.cls("-top-space")))),Pe(),u.dom.maybe((e=>["detail","single"].includes(e(this._pageWidgetType))),(()=>[(0,F.cssLabel)(ge("Theme")),(0,u.dom)("div",o._buildThemeDom(),o._buildLayoutDom())])),(0,u.domComputed)((e=>"record"!==e(this._pageWidgetType)?null:u.dom.create(ae,t))),(0,u.domComputed)((e=>"record"!==e(this._pageWidgetType)?null:[Pe(),(0,F.cssLabel)(ge("ROW STYLE")),(0,C.b)(D.nt().then((e=>u.dom.create(e.ConditionalStyle,ge("Row Style"),t,this._gristDoc))))])),u.dom.maybe((e=>"chart"===e(this._pageWidgetType)),(()=>[(0,F.cssLabel)(ge("CHART TYPE")),o._buildChartConfigDom()])),u.dom.maybe((e=>"custom"===e(this._pageWidgetType)),(()=>{const e=o._buildCustomTypeItems();return[(0,F.cssLabel)(ge("CUSTOM")),u.dom.maybe((e=>e(this._gristDoc.app.features).customViewPlugin),(()=>(0,u.dom)("div",e[0].buildDom()))),u.dom.maybe((e=>"plugin"===e(t.customDef.mode)),(()=>(0,u.dom)("div",e[2].buildDom()))),u.dom.maybe((e=>"url"===e(t.customDef.mode)&&"custom"===e(this._pageWidgetType)),(()=>u.dom.create(H,t,this._gristDoc)))]})),u.dom.maybe((e=>{var t;return null==(t=e(this._pageWidgetType))?void 0:t.startsWith("custom.")}),(()=>[u.dom.create(pe,t,this._gristDoc)])),u.dom.maybe((e=>!(e(i)||"chart"===e(this._pageWidgetType)||e(t.isRaw))),(()=>[Pe(),u.dom.create(r.M1,this._gristDoc,t)]))]))}_buildPageSortFilterConfig(e){const t=this._createViewConfigTab(e);return u.dom.maybe(t,(e=>e.buildSortFilterDom()))}_buildPageDataConfig(e,t){const o=this._createViewConfigTab(e),i=this._gristDoc.viewModel,n=t.table,s=u.Computed.create(e,(e=>e(e(n).groupByColumns))),r=u.Computed.create(e,(e=>(0,he.N3)({srcSectionRef:e(t.linkSrcSectionRef),srcColRef:e(t.linkSrcColRef),targetColRef:e(t.linkTargetColRef)}))),a=u.Observable.create(e,!1),d=u.Computed.create(e,(e=>(e(a),(0,he.Kg)(this._gristDoc.docModel,i.viewSections().all(),t))));return r.onWrite((e=>this._gristDoc.saveLink(e))),[this._disableIfReadonly(),(0,F.cssLabel)(ge("DATA TABLE")),Se(Te("TypeTable"),$e(ge("SOURCE DATA")),Le(u.dom.text((e=>e(e(n).primaryTableId))),(0,l.testId)("pwc-table"))),(0,u.dom)("div",Se(Te("Pivot"),$e(ge("GROUPED BY"))),Se((0,u.domComputed)(s,(e=>Ne(e.map((e=>ze(u.dom.text(e.label),(0,l.testId)("pwc-groupedBy-col")))))))),(0,l.testId)("pwc-groupedBy"),u.dom.hide((e=>!e(e(n).summarySourceTable)))),u.dom.maybe((e=>!e(t.isRaw)),(()=>ke((0,O.primaryButton)(ge("Edit Data Selection"),this._createPageWidgetPicker(),(0,l.testId)("pwc-editDataSelection")),u.dom.maybe((e=>Boolean(e(e(t.table).summarySourceTable))),(()=>(0,O.basicButton)(ge("Detach"),u.dom.on("click",(()=>this._gristDoc.docData.sendAction(["DetachSummaryViewSection",t.getRowId()]))),(0,l.testId)("detach-button")))),Se.cls("-top-space")))),u.dom.maybe(o,(e=>Se((0,u.dom)("div",e._buildAdvancedSettingsDom())))),Pe(),u.dom.maybe((e=>!e(t.isRaw)),(()=>[(0,F.cssLabel)(ge("SELECT BY")),Se(u.dom.update((0,c.select)(r,d,{defaultLabel:ge("Select Widget")}),u.dom.on("click",(()=>{a.set(!a.get())}))),(0,l.testId)("right-select-by"))])),(0,u.domComputed)((e=>{const o=e(e(t.linkedSections).getObservable());return o.length?[(0,F.cssLabel)(ge("SELECTOR FOR"),(0,l.testId)("selector-for")),Se(Ne(o.map((e=>this._buildSectionItem(e)))))]:null}))]}_createPageWidgetPicker(){const e=this._gristDoc,t=e.viewModel.activeSection,o=o=>e.saveViewSection(t.peek(),o);return i=>{(0,ue.lt)(i,e,o,{buttonLabel:ge("Save"),value:()=>(0,ue.FU)(t.peek()),selectBy:t=>e.selectBy(t)})}}_buildSectionItem(e){return ze(u.dom.text(e.titleDef),(0,l.testId)("selector-for-entry"))}_disableIfReadonly(){if(this._gristDoc.docPageModel)return u.dom.maybe(this._gristDoc.docPageModel.isReadonly,(()=>Ce((0,l.testId)("disable-overlay"),De(ge("You do not have edit access to this document")))))}}function we(){return Ce((0,l.testId)("panel-disabled-section"))}function xe(...e){return Be((0,u.dom)("div",{style:"position: relative; padding-top: 1px;"},...e))}const Ce=(0,u.styled)("div",`\n  background-color: ${l.theme.rightPanelDisabledOverlay};\n  opacity: 0.8;\n  position: absolute;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  z-index: 100;\n`),De=(0,u.styled)("span",`\n  color: ${l.theme.text};\n  position: absolute;\n  bottom: -40px;\n  padding: 4px 16px;\n`),Se=(0,u.styled)("div",`\n  color: ${l.theme.text};\n  display: flex;\n  margin: 8px 16px;\n  align-items: center;\n  &-top-space {\n    margin-top: 24px;\n  }\n  &-disabled {\n    color: ${l.theme.disabledText};\n  }\n`),ke=(0,u.styled)(Se,"\n  margin-left: 0;\n  margin-right: 0;\n  & > button {\n    margin-left: 16px;\n  }\n"),Te=(0,u.styled)(a.icon,`\n  flex: 0 0 auto;\n  --icon-color: ${l.theme.lightText};\n`),Ie=(0,u.styled)("div",`\n  flex: 1 1 0px;\n  height: 100%;\n  background-color: ${l.theme.rightPanelTabBg};\n  font-weight: ${l.vars.headerControlTextWeight};\n  color: ${l.theme.rightPanelTabFg};\n  --icon-color: ${l.theme.rightPanelTabIcon};\n  display: flex;\n  align-items: center;\n  cursor: default;\n\n  &-selected {\n    background-color: ${l.theme.rightPanelTabSelectedBg};\n    font-weight: initial;\n    color: ${l.theme.rightPanelTabSelectedFg};\n    --icon-color: ${l.theme.rightPanelTabSelectedFg};\n  }\n  &:not(&-selected):hover {\n    background-color: ${l.theme.rightPanelTabHoverBg};\n    --icon-color: ${l.theme.rightPanelTabIconHover};\n  }\n`),Re=(0,u.styled)(a.icon,"\n  flex: none;\n  margin: 16px;\n  height: 16px;\n  width: 16px;\n  background-color: var(--icon-color);\n"),Fe=(0,u.styled)("div",`\n  margin-left: auto;\n  margin-right: 8px;\n  width: 32px;\n  height: 32px;\n  background: none;\n  border-radius: 16px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n\n  &:hover {\n    background-color: ${l.theme.rightPanelTabButtonHoverBg};\n  }\n`),Oe=(0,u.styled)(a.icon,"\n  height: 16px;\n  width: 16px;\n  background-color: var(--icon-color);\n"),Ee=(0,u.styled)("div","\n  height: 48px;\n  flex: none;\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n"),Ae=(0,u.styled)("div",`\n  color: ${l.theme.rightPanelSubtabFg};\n  flex: auto;\n  height: 100%;\n  display: flex;\n  flex-direction: column;\n  justify-content: flex-end;\n  text-align: center;\n  padding-bottom: 8px;\n  border-bottom: 1px solid ${l.theme.pagePanelsBorder};\n  cursor: default;\n\n  &-selected {\n    color: ${l.theme.rightPanelSubtabSelectedFg};\n    border-bottom: 1px solid ${l.theme.rightPanelSubtabSelectedUnderline};\n  }\n  &:not(&-selected):hover {\n    color: ${l.theme.rightPanelSubtabHoverFg};\n  }\n  &:hover {\n    border-bottom: 1px solid ${l.theme.rightPanelSubtabHoverUnderline};\n  }\n  .${Ee.className}:hover > &-selected:not(:hover) {\n    border-bottom: 1px solid ${l.theme.pagePanelsBorder};\n  }\n`),Me=(0,u.styled)("div","\n  padding: 16px 8px;\n  overflow: auto;\n"),Pe=(0,u.styled)("div",`\n  border-bottom: 1px solid ${l.theme.pagePanelsBorder};\n  margin-top: 16px;\n`),Be=(0,u.styled)("div.test-config-container",'\n  overflow: auto;\n  --color-list-item: none;\n  --color-list-item-hover: none;\n\n  &:after {\n    content: "";\n    display: block;\n    height: 40px;\n  }\n  & .fieldbuilder_settings {\n    margin: 16px 0 0 0;\n  }\n'),$e=(0,u.styled)("div",`\n  flex: 0 0 81px;\n  color: ${l.theme.lightText};\n  font-size: ${l.vars.xsmallFontSize};\n  margin-left: 4px;\n  margin-top: 2px;\n`),Le=(0,u.styled)("div","\n  flex: 0 1 auto;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  min-width: 1em;\n"),Ne=(0,u.styled)("div","\n  list-style: none;\n  width: 100%;\n"),ze=(0,u.styled)("li",`\n  background-color: ${l.theme.hover};\n  border-radius: 2px;\n  margin-bottom: 4px;\n  white-space: nowrap;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  width: 100%;\n  padding: 4px 8px;\n`),Ve=(0,u.styled)(A.textInput,`\n  flex: 1 0 auto;\n  color: ${l.theme.inputFg};\n  background-color: ${l.theme.inputBg};\n\n  &:disabled {\n    color: ${l.theme.inputDisabledFg};\n    background-color: ${l.theme.inputDisabledBg};\n    pointer-events: none;\n  }\n`),He=(0,u.styled)("div","\n  position: relative;\n")},3411:(e,t,o)=>{"use strict";o.r(t),o.d(t,{cssBlockedCursor:()=>p,cssButtonRow:()=>h,cssHelp:()=>a,cssIcon:()=>r,cssLabel:()=>l,cssPinButton:()=>g,cssRow:()=>c,cssRowWrapped:()=>d,cssSaveButtonsRow:()=>f,cssSeparator:()=>m,cssSortFilterColumn:()=>u});var i=o(29922),n=o(7454),s=o(1310);const r=(0,s.styled)(n.icon,`\n  flex: 0 0 auto;\n  --icon-color: ${i.theme.lightText};\n`),l=(0,s.styled)("div",`\n  color: ${i.theme.text};\n  text-transform: uppercase;\n  margin: 16px 16px 12px 16px;\n  font-size: ${i.vars.xsmallFontSize};\n`),a=(0,s.styled)("div",`\n  margin: -8px 16px 12px 16px;\n  font-style: italic;\n  font-size: ${i.vars.xsmallFontSize};\n`),c=(0,s.styled)("div",`\n  display: flex;\n  margin: 8px 16px;\n  align-items: center;\n  color: ${i.theme.text};\n  &-top-space {\n    margin-top: 24px;\n  }\n  &-disabled {\n    color: ${i.theme.disabledText};\n  }\n`),d=(0,s.styled)(c,"\n  flex-wrap: wrap;\n  row-gap: 5px;\n"),u=(0,s.styled)("div",`\n  cursor: pointer;\n  display: flex;\n  flex-grow: 1;\n  align-items: center;\n  color: ${i.theme.text};\n  background-color: ${i.theme.hover};\n  overflow: hidden;\n  border-radius: 4px;\n  padding: 4px 8px;\n`),p=(0,s.styled)("span","\n  &, & * {\n    cursor: not-allowed !important;\n  }\n"),h=(0,s.styled)(d,"\n  margin-left: 0;\n  margin-right: 0;\n  & > button {\n    margin-left: 16px;\n  }\n"),m=(0,s.styled)("div",`\n  border-bottom: 1px solid ${i.theme.pagePanelsBorder};\n  margin-top: 16px;\n`),f=(0,s.styled)("div","\n  margin: 16px 16px 12px 16px;\n"),g=(0,s.styled)("div",`\n  cursor: pointer;\n  --icon-color: ${i.theme.controlSecondaryFg};\n  border-radius: ${i.vars.controlBorderRadius};\n  padding: 3px;\n\n  &-pinned {\n    background-color: ${i.theme.controlPrimaryBg};\n    --icon-color: ${i.theme.controlPrimaryFg};\n  }\n\n  &:not(&-pinned):hover {\n    background-color: ${i.theme.hover};\n  }\n`)},21376:(e,t,o)=>{"use strict";o.d(t,{m:()=>w});var i=o(13988),n=o.n(i),s=o(73783),r=o(70387),l=o(52064),a=o(59793),c=o(3411),d=o(92478),u=o(29922),p=o(13884),h=o(1370),m=o(48210),f=o(1310),g=o(21467);const b=o(29274),v=o(36812),y=(0,f.makeTestId)("test-sort-config-"),_=(0,r.makeT)("SortConfig");class w extends f.Disposable{constructor(e,t,o={}){super(),this._section=e,this._gristDoc=t,this._options=o,this._columns=f.Computed.create(this,(e=>e(e(e(this._section.table).columns).getObservable()).filter((t=>!e(t.isHiddenCol))).map((t=>({label:e(t.label),value:t.getRowId(),icon:"FieldColumn",type:t.type()}))))),this._colRefs=f.Computed.create(this,(e=>e(this._section.activeSortSpec).map((e=>m.Sort.getColRef(e))))),this._sortRows=this.autoDispose(n()(this._colRefs.get())),this._changedColRefs=f.Computed.create(this,(e=>{const t=b(e(this._section.activeSortSpec),m.Sort.parseSortColRefs(e(this._section.sortColRefs)));return new Set(t.map((e=>m.Sort.getColRef(e))))})),this.autoDispose(this._colRefs.addListener(((e,t)=>{v(e,t)||this._sortRows.assign(e)})))}buildDom(){return(0,f.dom)("div",s.draggableList(this._sortRows,(e=>this._createRow(e)),{reorder:(e,t)=>this._reorder(e,t),removeButton:!1,drag_indicator:p.x,itemClass:x.className}),this._buildAddToSortButton(this._columns),this._buildUpdateDataButton(),y("container"))}_createRow(e){return this._buildSortRow(e,this._section.activeSortSpec,this._columns)}_buildSortRow(e,t,o){const i=new f.MultiHolder,{menuOptions:n}=this._options,s=f.Computed.create(i,(()=>e)),r=f.Computed.create(i,(o=>m.Sort.specToDetails(m.Sort.findCol(o(t),e)))),l=f.Computed.create(i,r,((e,t)=>m.Sort.hasOptions(t))),a=f.Computed.create(i,r,((e,t)=>t.direction===m.Sort.ASC));s.onWrite((o=>{let i=t.peek();const n=m.Sort.findCol(i,e),s=m.Sort.findCol(i,o);s?(i=m.Sort.swap(i,e,o),i=m.Sort.setSortDirection(i,e,m.Sort.direction(s)),i=m.Sort.setSortDirection(i,o,m.Sort.direction(n))):i=m.Sort.replace(i,e,m.Sort.createColSpec(o,m.Sort.direction(n))),this._saveSort(i)}));const u=(o,n,s)=>{const l=f.Computed.create(i,r,((e,t)=>t[o]||!1));return l.onWrite((i=>{const n=t.peek(),s=m.Sort.specToDetails(m.Sort.findCol(n,e));s[o]=i,this._saveSort(m.Sort.replace(n,m.Sort.getColRef(e),s))})),{computed:l,allowedTypes:n,flag:o,label:s}},p=u("orderByChoice",["Choice"],_("Use choice position")),b=u("naturalSort",["Text"],_("Natural sort")),v=[p,u("emptyLast",null,_("Empty values last")),b],w=o.get().find((t=>t.value===m.Sort.getColRef(e)));return D(f.dom.autoDispose(i),(0,c.cssSortFilterColumn)(f.dom.domComputed(a,(e=>T("Sort",T.cls("-accent",(e=>e(this._changedColRefs).has(w.value))),f.dom.style("transform",e?"scaleY(-1)":"none"),y("order"),y(e?"sort-order-asc":"sort-order-desc")))),C(w.label),f.dom.on("click",(()=>{this._saveSort(m.Sort.flipSort(t.peek(),e))})),y("column")),F(I((0,c.cssIcon)("Dots",f.dom.cls(R.className,l)),y("options-icon")),(0,h.menu)((e=>v.map((({computed:e,allowedTypes:t,flag:o,label:i})=>{const n=!t||t.includes(w.type);return(0,g.cssMenuItem)((0,d.Ad)(e,i,f.dom.prop("disabled",!n)),f.dom.cls(O.className),f.dom.cls("disabled",!n),y("option"),y(`option-${o}`))}))),n)),k("Remove",f.dom.on("click",(()=>{const o=t.peek();m.Sort.findCol(o,e)&&this._saveSort(m.Sort.removeCol(o,e))})),y("remove")),y("row"))}_buildAddToSortButton(e){const t=f.Computed.create(null,(t=>{const o=t(this._section.activeSortSpec),i=new Set(o.map((e=>m.Sort.getColRef(e))));return t(e).filter((e=>!i.has(e.value)))})),{menuOptions:o}=this._options;return E(f.dom.autoDispose(t),f.dom.domComputed((e=>{const i=e(t);return S(_("Add Column"),(0,a.z)({popupOptions:o,options:()=>i.map((e=>({label:e.label,value:e}))),action:e=>(0,l.addToSort)(this._section.activeSortSpec,e.value,1),placeholder:_("Search Columns")}),f.dom.on("click",(e=>{e.stopPropagation()})),y("add"))})),f.dom.hide((e=>!e(t).length)))}_buildUpdateDataButton(){return f.dom.maybe(this._section.isSorted,(()=>E(S(_("Update Data"),f.dom.on("click",(()=>(0,l.updatePositions)(this._gristDoc,this._section))),y("update"),f.dom.show((e=>e(e(this._section.table).supportsManualSort)&&!e(this._gristDoc.isReadonly)))))))}_reorder(e,t){const o=this._section.activeSortSpec.peek(),i=m.Sort.findCol(o,e);if(void 0===i)throw new Error(`Col ${e} not found in active sort spec`);const n=m.Sort.reorderSortRefs(this._section.activeSortSpec.peek(),i,t);this._saveSort(n)}_saveSort(e){this._section.activeSortSpec(e)}}const x=(0,f.styled)("div","\n  display: flex !important;\n  align-items: center;\n  margin: 0 16px 0px 0px;\n  & > .kf_draggable_content {\n    margin: 4px 0;\n    flex: 1 1 0px;\n    min-width: 0px;\n  }\n"),C=(0,f.styled)("div","\n  white-space: nowrap;\n  text-overflow: ellipsis;\n  overflow: hidden;\n  flex-grow: 1;\n"),D=(0,f.styled)("div","\n  display: flex;\n  align-items: center;\n  width: 100%;\n"),S=(0,f.styled)("div",`\n  color: ${u.theme.controlFg};\n  cursor: pointer;\n\n  &:hover {\n    color: ${u.theme.controlHoverFg};\n  }\n`),k=(0,f.styled)(c.cssIcon,`\n  flex: none;\n  margin: 0 6px;\n  cursor: pointer;\n  background-color: ${u.theme.controlSecondaryFg};\n\n  &:hover {\n    background-color: ${u.theme.controlSecondaryHoverFg};\n  }\n`),T=(0,f.styled)(c.cssIcon,`\n  flex: none;\n  margin: 0px 6px 0px 0px;\n  background-color: ${u.theme.controlSecondaryFg};\n\n  &-accent {\n    background-color: ${u.theme.accentIcon};\n  }\n`),I=(0,f.styled)("div","\n  padding: 3px;\n  border-radius: 3px;\n  cursor: pointer;\n  user-select: none;\n"),R=(0,f.styled)("div",`\n  background: ${u.theme.accentIcon}\n`),F=(0,f.styled)("div",`\n  display: inline-flex;\n  cursor: pointer;\n  border-radius: 3px;\n  border: 1px solid transparent;\n  margin-left: 6px;\n  &:hover, &.weasel-popup-open {\n    background-color: ${u.theme.hover};\n  }\n`),O=(0,f.styled)("div",`\n  &:hover {\n    background-color: ${u.theme.hover};\n  }\n  & label {\n    flex: 1;\n    cursor: pointer;\n  }\n  &.disabled * {\n    color: ${u.theme.menuItemDisabledFg} important;\n    cursor: not-allowed;\n  }\n`),E=(0,f.styled)(c.cssRow,"\n  margin-top: 4px;\n")},51536:(e,t,o)=>{"use strict";o.d(t,{B3:()=>F,KM:()=>R,M1:()=>S,Tw:()=>E});var i=o(13988),n=o(73783),s=o(70387),r=o(15323),l=o(71571),a=o(11187),c=o(92478),d=o(29922),u=o(13884),p=o(7454),h=o(83277),m=o(1310),f=Object.defineProperty,g=Object.getOwnPropertySymbols,b=Object.prototype.hasOwnProperty,v=Object.prototype.propertyIsEnumerable,y=(e,t,o)=>t in e?f(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,_=(e,t)=>{for(var o in t||(t={}))b.call(t,o)&&y(e,o,t[o]);if(g)for(var o of g(t))v.call(t,o)&&y(e,o,t[o]);return e};const w=o(29274),x=o(36812),C=(0,m.makeTestId)("test-vfc-"),D=(0,s.makeT)("VisibleFieldsConfig");class S extends m.Disposable{constructor(e,t){super(),this._gristDoc=e,this._section=t,this._hiddenFields=this.autoDispose((0,i.syncedKoArray)(this._section.hiddenColumns)),this._fieldLabel=m.Computed.create(this,(e=>{const t=e(this._section.parentKey);return(0,l.Ql)(t).pluralLabel})),this._collapseHiddenFields=m.Observable.create(this,!1),this._showVisibleBatchButtons=m.Observable.create(this,!1),this._showHiddenBatchButtons=m.Observable.create(this,!1),this._visibleFieldsSelection=new Set,this._hiddenFieldsSelection=new Set,this.autoDispose(this._section.viewFields.peek().subscribe((e=>{I(this._visibleFieldsSelection,e),this._showVisibleBatchButtons.set(Boolean(this._visibleFieldsSelection.size))}),null,"spliceChange")),this.autoDispose(this._hiddenFields.subscribe((e=>{I(this._hiddenFieldsSelection,e),this._showHiddenBatchButtons.set(Boolean(this._hiddenFieldsSelection.size))}),null,"spliceChange"))}buildVisibleFieldsConfigHelper(e){let t=this._section.viewFields.peek();if(e.skipFirst||e.filterFunc){let o=function(){if(r&&r.get())return;const e=l.peek().filter(((e,t)=>t+1>n.get())).filter(s);x(a.all(),e)||a.assign(e)};const n=e.skipFirst||m.Observable.create(this,-1),s=e.filterFunc||(()=>!0),r=e.freeze,l=this._section.viewFields.peek(),a=new i.KoArray;o(),this.autoDispose(l.subscribe(o)),this.autoDispose((0,m.subscribe)(n,o)),e.freeze&&this.autoDispose((0,m.subscribe)(e.freeze,o)),t=a}return n.draggableList(t,e.itemCreateFunc,_({itemClass:R.className,reorder:this.changeFieldPosition.bind(this),remove:this.removeField.bind(this),receive:this.addField.bind(this)},e.draggableOptions))}buildSectionFieldsConfigHelper(e){const t=this.buildVisibleFieldsConfigHelper(e.visibleFields),o=n.draggableList(this._hiddenFields,e.hiddenFields.itemCreateFunc,_({itemClass:R.className,reorder(){throw new Error(D("Hidden Fields cannot be reordered"))},receive(){throw new Error(D("Cannot drop items into Hidden Fields"))},remove:e=>e,removeButton:!1},e.hiddenFields.draggableOptions));return n.connectDraggableOneWay(o,t),[t,o]}buildDom(){const[e,t]=this.buildSectionFieldsConfigHelper({visibleFields:{itemCreateFunc:e=>this._buildVisibleFieldItem(e),draggableOptions:{removeButton:!1,drag_indicator:u.x}},hiddenFields:{itemCreateFunc:e=>this._buildHiddenFieldItem(e),draggableOptions:{removeButton:!1,drag_indicator:u.x}}});return[B(A(m.dom.text((e=>D("Visible {{label}}",{label:e(this._fieldLabel)})))),m.dom.maybe((e=>Boolean(e(e(this._section.viewFields).getObservable()).length)),(()=>P((0,p.icon)("Tick"),D("Select All"),m.dom.on("click",(()=>this._setVisibleCheckboxes(e,!0))),C("visible-fields-select-all"))))),m.dom.update(e,C("visible-fields")),m.dom.maybe(this._showVisibleBatchButtons,(()=>M((0,a.primaryButton)(m.dom.text((e=>D("Hide {{label}}",{label:e(this._fieldLabel)}))),m.dom.on("click",(()=>this._removeSelectedFields())),C("visible-hide")),(0,a.basicButton)(D("Clear"),m.dom.on("click",(()=>this._setVisibleCheckboxes(e,!1))),C("visible-clear")),C("visible-batch-buttons")))),B($("Dropdown",m.dom.style("transform",(e=>e(this._collapseHiddenFields)?"rotate(-90deg)":"")),m.dom.style("cursor","pointer"),m.dom.on("click",(()=>this._collapseHiddenFields.set(!this._collapseHiddenFields.get()))),C("collapse-hidden")),A(m.dom.text((e=>D("Hidden {{label}}",{label:e(this._fieldLabel)})))),m.dom.maybe((e=>Boolean(e(this._hiddenFields.getObservable()).length&&!e(this._collapseHiddenFields))),(()=>P((0,p.icon)("Tick"),D("Select All"),m.dom.on("click",(()=>this._setHiddenCheckboxes(t,!0))),C("hidden-fields-select-all"))))),(0,m.dom)("div",m.dom.hide(this._collapseHiddenFields),m.dom.update(t,C("hidden-fields")),m.dom.maybe(this._showHiddenBatchButtons,(()=>M((0,a.primaryButton)(m.dom.text((e=>D("Show {{label}}",{label:e(this._fieldLabel)}))),m.dom.on("click",(()=>this._addSelectedFields())),C("hidden-show")),(0,a.basicButton)(D("Clear"),m.dom.on("click",(()=>this._setHiddenCheckboxes(t,!1))),C("hidden-clear")),C("hidden-batch-buttons")))))]}async removeField(e){const t=this._section.viewFields.peek().peek().find((t=>t.column.peek().getRowId()===e.origCol.peek().id.peek()));if(!t)return;const o=["RemoveRecord",t.id.peek()];await this._gristDoc.docModel.viewFields.sendTableAction(o)}async addField(e,t=null){if(-1!==this._section.viewFields.peek().peek().findIndex((t=>t.column.peek().getRowId()===e.id.peek())))return;const o=k(this._section.viewFields.peek(),0,t),i=["AddRecord",null,{parentId:this._section.id.peek(),colRef:e.id.peek(),parentPos:o}];await this._gristDoc.docModel.viewFields.sendTableAction(i)}changeFieldPosition(e,t){const o=k(this._section.viewFields.peek(),0,t),i=["UpdateRecord",e.id.peek(),{parentPos:o}];return this._gristDoc.docModel.viewFields.sendTableAction(i)}_setVisibleCheckboxes(e,t){this._setCheckboxesHelper(e,this._section.viewFields.peek().peek(),this._visibleFieldsSelection,t),this._showVisibleBatchButtons.set(t)}_setHiddenCheckboxes(e,t){this._setCheckboxesHelper(e,this._hiddenFields.peek(),this._hiddenFieldsSelection,t),this._showHiddenBatchButtons.set(t)}_setCheckboxesHelper(e,t,o,i){var n;(n=e,n.querySelectorAll("input")).forEach((e=>e.checked=i)),o.clear(),i&&t.forEach((e=>o.add(e.id.peek())))}_buildHiddenFieldItem(e){const t=e.id.peek(),o=this._hiddenFieldsSelection;return F(E(m.dom.text(e.label)),O("EyeShow",m.dom.on("click",(()=>this.addField(e))),C("hide")),T(m.dom.prop("checked",o.has(t)),m.dom.on("change",((e,i)=>{i.checked?o.add(t):o.delete(t),this._showHiddenBatchButtons.set(Boolean(o.size))}))))}_buildVisibleFieldItem(e){const t=e.id.peek(),o=this._visibleFieldsSelection;return F(E(m.dom.text(e.label)),O("EyeHide",m.dom.on("click",(()=>this.removeField(e))),C("hide")),T(m.dom.prop("checked",o.has(t)),m.dom.on("change",((e,i)=>{i.checked?o.add(t):o.delete(t),this._showVisibleBatchButtons.set(Boolean(o.size))}))))}async _removeSelectedFields(){const e=["BulkRemoveRecord",Array.from(this._visibleFieldsSelection).sort(h.nativeCompare)];await this._gristDoc.docModel.viewFields.sendTableAction(e)}async _addSelectedFields(){const e=Array.from(this._hiddenFieldsSelection),t=["BulkAddRecord",h.arrayRepeat(e.length,null),{parentId:h.arrayRepeat(e.length,this._section.id.peek()),colRef:e}];await this._gristDoc.docModel.viewFields.sendTableAction(t)}}function k(e,t,o){const i=function(e,t){return null!==t?e.peek().indexOf(t):e.peek().length}(e,o);return r.fieldInsertPositions(e,i,1)[0]}function T(...e){return c.xY({style:"flex-shrink: 0;"},c.kZ({type:"checkbox"},...e))}function I(e,t){const o=w(t.deleted,t.array);for(const t of o)e.delete(t.id.peek())}const R=(0,m.styled)("div","\n  display: flex !important;\n  align-items: center;\n  margin: 0 16px 0px 0px;\n  & > .kf_draggable_content {\n    margin: 2px 0;\n    flex: 1 1 0px;\n    min-width: 0px;\n  }\n"),F=(0,m.styled)("div",`\n  display: flex;\n  background-color: ${d.theme.hover};\n  width: 100%;\n  border-radius: 2px;\n  margin: 0 8px 0 0;\n  padding: 4px 8px;\n  cursor: default;\n  white-space: nowrap;\n  overflow: hidden;\n  text-overflow: ellipsis;\n\n  --icon-color: ${d.theme.lightText};\n`),O=(0,m.styled)(p.icon,`\n  --icon-color: ${d.theme.lightText};\n  display: none;\n  cursor: pointer;\n  flex: none;\n  margin-right: 8px;\n  .kf_draggable:hover & {\n    display: block;\n  }\n`),E=(0,m.styled)("span",`\n  color: ${d.theme.text};\n  flex: 1 1 auto;\n  text-overflow: ellipsis;\n  overflow: hidden;\n`),A=(0,m.styled)("span",`\n  color: ${d.theme.text};\n  flex: 1 1 0px;\n  font-size: ${d.vars.xsmallFontSize};\n  text-transform: uppercase;\n`),M=(0,m.styled)("div",`\n  display: flex;\n  margin: 16px;\n  overflow: hidden;\n  --icon-color: ${d.theme.lightText};\n  & > .${a.cssButton.className} {\n    margin-right: 8px;\n  }\n`),P=(0,m.styled)("div",`\n  --icon-color: ${d.theme.controlFg};\n  color: ${d.theme.controlFg};\n  cursor: pointer;\n`),B=(0,m.styled)(M,"\n  align-items: center;\n  justify-content: space-between;\n  margin-bottom: 12px;\n"),$=(0,m.styled)(p.icon,`\n  --icon-color: ${d.theme.lightText};\n  flex: none;\n  margin-right: 4px;\n`)},73181:(e,t,o)=>{"use strict";o.d(t,{po:()=>r});var i=o(92478),n=o(1310);function s(e){e.style.height="5px";const t=getComputedStyle(e,null).borderTopWidth||"0";e.style.height=`calc(${e.scrollHeight}px + 2 * ${t})`}function r(e){return t=>{t.addEventListener("input",(()=>s(t))),n.dom.autoDisposeElem(t,e.addListener((()=>s(t)))),setTimeout((()=>s(t)),10),n.dom.autoDisposeElem(t,e.addListener((e=>{e||(t.style.height="5px")})))}}const l=(0,n.styled)("form","\n  margin-bottom: 32px;\n  font-size: 14px;\n  &:focus {\n    outline: none;\n  }\n  & input:focus, & button:focus {\n    outline: none;\n    box-shadow: 0 0 1px 2px lightblue;\n  }\n"),a=((0,n.styled)("div","\n  margin: 32px 0;\n  padding-left: 24px;\n  & > :first-child {\n    margin-left: -24px;\n  }\n"),(0,n.styled)("div","\n  margin: 16px 0;\n  font-size: 15px;\n"),(0,n.styled)(i.xY,"\n  font-size: 14px;\n  font-weight: normal;\n  display: flex;\n  align-items: center;\n  margin: 12px 0;\n  user-select: unset;\n"),(0,n.styled)(i.kZ,"\n  position: relative;\n  margin-right: 12px !important;\n  border-radius: var(--radius);\n"),(0,n.styled)("input","\n  flex: auto;\n  width: 100%;\n  font-size: inherit;\n  padding: 4px 8px;\n  border: 1px solid #D9D9D9;\n  border-radius: 3px;\n\n  &-invalid {\n    color: red;\n  }\n"));l.bind(null,{tabIndex:"-1"}),a.bind(null,{type:"text"})},91033:(e,t,o)=>{"use strict";o.d(t,{J7:()=>l,Y2:()=>r});var i=o(29922),n=o(1310);const s=(0,n.styled)("input",`\n  font-size: ${i.vars.mediumFontSize};\n  height: 48px;\n  line-height: 20px;\n  width: 100%;\n  padding: 14px;\n  border: 1px solid ${i.theme.inputBorder};\n  border-radius: 4px;\n  outline: none;\n  display: block;\n  color: ${i.theme.inputFg};\n  background-color: ${i.theme.inputBg};\n\n  &::placeholder {\n    color: ${i.theme.inputPlaceholderFg};\n  }\n\n  &[type=number] {\n    -moz-appearance: textfield;\n  }\n  &[type=number]::-webkit-inner-spin-button,\n  &[type=number]::-webkit-outer-spin-button {\n    -webkit-appearance: none;\n    margin: 0;\n  }\n\n  &-invalid {\n    border: 1px solid ${i.theme.inputInvalid};\n  }\n\n  &-valid {\n    border: 1px solid ${i.theme.inputValid};\n  }\n`);function r(e,...t){return s(n.dom.prop("value",e),n.dom.on("input",((t,o)=>e.set(o.value))),...t)}function l(e,t,...o){const i=t.isValid;function s(t){e.set(t.value),i&&i.set(t.validity.valid)}return(0,n.dom)("textarea",...o,n.dom.prop("value",e),i?t=>n.dom.autoDisposeElem(t,(0,n.subscribe)(e,(e=>i.set(t.checkValidity())))):null,t.onInput?n.dom.on("input",((e,t)=>s(t))):null,n.dom.on("change",((e,t)=>s(t))))}},60321:(e,t,o)=>{"use strict";o.d(t,{j:()=>r});var i=o(11989),n=o.n(i);const s={ADD_TAGS:["iframe"],ADD_ATTR:["allowFullscreen"]};function r(e){return n().sanitize(e,s)}n().addHook("uponSanitizeAttribute",(e=>{"target"in e&&e.setAttribute("target","_blank")})),n().addHook("uponSanitizeElement",((e,t)=>{var o;if("iframe"!==t.tagName)return;const i=e.getAttribute("src");return(null==i?void 0:i.startsWith("https://www.youtube.com/embed/"))||null==(o=e.parentNode)?void 0:o.removeChild(e)}))},59793:(e,t,o)=>{"use strict";o.d(t,{z:()=>m});var i=o(1310),n=o(29922),s=o(11104),r=o(1370),l=o(7454),a=o(21467),c=o(32275),d=o(88480);const u=(0,o(70387).makeT)("searchDropdown"),p=(0,i.makeTestId)("test-sd-");class h{constructor(e,t,o){this.label=e,this.value=t,this.disabled=o,this.cleanText=(0,s.normalizeText)(this.label)}}function m(e){return t=>{const o=(0,c.mergeWith)({},a.defaultMenuOptions,e.popupOptions,((e,t)=>Array.isArray(t)?t:void 0));(0,a.setPopupToFunc)(t,(t=>f.create(null,t,e)),o)}}class f extends i.Disposable{constructor(e,t){super(),this._ctl=e,this._options=t;const o=t.options().map(d.n).map((e=>new h(e.label,e.value,e.disabled)));this._acIndex=new s.ACIndexImpl(o),this._items=i.Observable.create(this,o),this._highlightFunc=()=>[],this._simpleList=this._buildSimpleList(),this._simpleList.listenKeys(this._inputElem),this._update(),setTimeout((()=>this._inputElem.focus()),1)}get content(){return this._simpleList.content}_buildSimpleList(){const e=this._action.bind(this),t=this._buildHeader.bind(this),o=this._buildItem.bind(this);return d.L.create(this,this._ctl,this._items,e,{headerDom:t,renderItem:o})}_buildHeader(){return[b(v("Search"),this._inputElem=y({placeholder:this._options.placeholder||u("Search")},i.dom.on("input",(()=>{this._update()})),i.dom.on("blur",(()=>setTimeout((()=>this._inputElem.focus()),0)))),i.dom.on("click",(e=>e.stopPropagation())),p("search")),_()]}_buildItem(e){return[(0,s.buildHighlightedDom)(e.label,this._highlightFunc,g),p("searchable-list-item")]}_update(){var e;const t=this._acIndex.search((null==(e=this._inputElem)?void 0:e.value)||"");this._highlightFunc=t.highlightFunc,this._items.set(t.items),this._simpleList.setSelected(t.selectIndex)}_action(e){e&&this._options.action(e),this._ctl.close()}}const g=(0,i.styled)("span",`\n  color: ${n.theme.autocompleteMatchText};\n  .${a.cssMenuItem.className}-sel > & {\n    color: ${n.theme.autocompleteSelectedMatchText};\n  }\n`),b=(0,i.styled)("div","\n  display: flex;\n  padding: 13px 17px 15px 17px;\n"),v=(0,i.styled)(l.icon,`\n  --icon-color: ${n.theme.lightText};\n  flex-shrink: 0;\n  margin-left: auto;\n  margin-right: 4px;\n`),y=(0,i.styled)("input",`\n  color: ${n.theme.inputFg};\n  background-color: ${n.theme.inputBg};\n  flex-grow: 1;\n  min-width: 1px;\n  -webkit-appearance: none;\n  -moz-appearance: none;\n\n  font-size: ${n.vars.mediumFontSize};\n\n  margin: 0px 16px 0px 8px;\n  padding: 0px;\n  border: none;\n  outline: none;\n\n  &::placeholder {\n    color: ${n.theme.inputPlaceholderFg};\n  }\n`),_=(0,i.styled)(r.menuDivider,"\n  flex-shrink: 0;\n  margin: 0;\n")},21602:(e,t,o)=>{"use strict";o.d(t,{Kg:()=>_,N3:()=>k,bG:()=>g,pS:()=>T,vH:()=>I});var i=o(631),n=o(20543),s=o.n(n),r=o(83277),l=Object.defineProperty,a=Object.defineProperties,c=Object.getOwnPropertyDescriptors,d=Object.getOwnPropertySymbols,u=Object.prototype.hasOwnProperty,p=Object.prototype.propertyIsEnumerable,h=(e,t,o)=>t in e?l(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,m=(e,t)=>{for(var o in t||(t={}))u.call(t,o)&&h(e,o,t[o]);if(d)for(var o of d(t))p.call(t,o)&&h(e,o,t[o]);return e};const f=o(36812),g=k({srcSectionRef:0,srcColRef:0,targetColRef:0}),b={label:"Select Widget",value:g};function v(e){var t;return e.isSummary&&"group"===(null==(t=e.column)?void 0:t.colId.peek())}function y(e,t){if(e.section.getRowId()===t.section.getRowId())return!1;if(e.tableId!==t.tableId)return!1;if(v(e)&&(!t.column||v(t))||v(t))return!1;if(e.isSummary&&!e.column&&t.column||t.isSummary&&!t.column&&e.column)return!1;if(!e.column&&!t.column&&t.isSummary&&(!e.isSummary||!r.isSubset(e.groupbyColumns,t.groupbyColumns)))return!1;if("chart"===e.widgetType)return!1;if("custom"===e.widgetType){if(e.tableId!==e.section.table.peek().primaryTableId.peek())return!1;if(!e.section.allowSelectBy())return!1}return!e.ancestors.has(t.section.getRowId())}function _(e,t,o){const i=x(e,t),n=x(e,[o]),s=[b];for(const e of i){const t=n.filter((t=>y(e,t))),o=t.length>1;for(const i of t){const t=k({srcSectionRef:e.section.getRowId(),srcColRef:e.column?e.column.getRowId():0,targetColRef:i.column?i.column.getRowId():0});let n=e.section.titleDef();e.column&&!v(e)&&(n+=` • ${e.column.label.peek()}`),i.column&&!v(i)&&(o||v(e))&&(n+=` → ${i.column.label.peek()}`),s.push({label:n,value:t})}}return s}function w(e){return Boolean(e.getRowId)}function x(e,t){const o=[];for(const i of t)w(i)?o.push(...C(i)):o.push(...D(e,i));return o}function C(e){if(e.isDisposed())return[];const t=e.table.peek(),o=new Set;for(let t=e;t.getRowId();t=t.linkSrcSection.peek()){if(o.has(t.getRowId())){console.warn(`Links should not create a cycle - section ids: ${Array.from(o)}`);break}o.add(t.getRowId())}const i=t.primaryTableId.peek()!==t.tableId.peek(),n={tableId:t.primaryTableId.peek(),isSummary:i,groupbyColumns:i?t.summarySourceColRefs.peek():void 0,widgetType:e.parentKey.peek(),ancestors:o,section:e};return S(t,n)}function D(e,t){if("number"!=typeof t.table)return[];let o=e.tables.getRowModel(t.table);const i=t.summarize,n=i?new Set(t.columns):void 0;let s=!0;if(i){const t=e.tables.rowModels.find((e=>(null==e?void 0:e.summarySourceTable.peek())&&f(e.summarySourceColRefs.peek(),n)));t?o=t:s=!1}const r={tableId:o.primaryTableId.peek(),isSummary:i,groupbyColumns:n,widgetType:t.type,ancestors:new Set,section:e.viewSections.getRowModel(t.section)};return S(o,r,s)}function S(e,t,o=!0){const n=[t],s=e.columns.peek().peek();for(const e of s){if(!o&&!t.groupbyColumns.has(e.getRowId()))continue;const s=(0,i.getReferencedTableId)(e.type.peek());s&&n.push((r=m({},t),a(r,c({tableId:s,column:e}))))}var r;return n}function k(e){return JSON.stringify([e.srcSectionRef,e.srcColRef,e.targetColRef])}function T(e){const[t,o,i]=JSON.parse(e);return{srcSectionRef:t,srcColRef:o,targetColRef:i}}class I{constructor(e){this.tgtCol=e.linkTargetCol(),this.srcCol=e.linkSrcCol(),this.srcSection=e.linkSrcSection(),this.tgtSection=e,this.srcColId=this.srcCol.colId(),this.tgtColId=this.tgtCol.colId(),this._assertValid()}_assertValid(){var e,t,o,n;const r=(null==(e=this.srcCol)?void 0:e.getRowId())?this.srcCol:null,l=(null==(t=this.tgtCol)?void 0:t.getRowId())?this.tgtCol:null,a=r?(0,i.getReferencedTableId)(r.type()):this.srcSection.table().primaryTableId(),c=l?(0,i.getReferencedTableId)(l.type()):this.tgtSection.table().primaryTableId(),d=this.srcSection.table().summarySourceTable(),u=this.tgtSection.table().summarySourceTable();try{s()(Boolean(this.srcSection.getRowId()),"srcSection was disposed"),s()(!l||l.parentId()===this.tgtSection.tableRef(),"tgtCol belongs to wrong table"),s()(!r||r.parentId()===this.srcSection.tableRef(),"srcCol belongs to wrong table"),s()(this.srcSection.getRowId()!==this.tgtSection.getRowId(),"srcSection links to itself"),0!==d&&d===u||(s()(c,"tgtCol not a valid reference"),s()(a,"srcCol not a valid reference")),s()(a===c,"mismatched tableIds")}catch(e){throw new Error(`LinkConfig invalid: ${this.srcSection.getRowId()}:${null==(o=this.srcCol)?void 0:o.getRowId()}[${a}] -> ${this.tgtSection.getRowId()}:${null==(n=this.tgtCol)?void 0:n.getRowId()}[${c}]: ${e}`)}}}},98987:(e,t,o)=>{"use strict";o.d(t,{a:()=>n});var i=o(1310);function n(...e){const t=i.Observable.create(null,!0),o=i.Observable.create(null,!0);return r(i.dom.autoDispose(t),i.dom.autoDispose(o),(e=>{setTimeout((()=>o.set(s(e))),0)}),i.dom.on("scroll",((e,i)=>{t.set(function(e){return 0===e.scrollTop}(i)),o.set(s(i))})),i.dom.style("box-shadow",(e=>[e(t)?null:"inset 0 4px 6px 0 rgba(217,217,217,0.4)",e(o)?null:"inset 0 -4px 6px 0 rgba(217,217,217,0.4)"].filter((e=>e)).join(", "))),...e)}function s(e){return e.scrollTop>=e.scrollHeight-e.offsetHeight}const r=(0,i.styled)("div","\n  flex: 1 1 0;\n  width: 100%;\n  overflow-y: auto;\n")},33769:(e,t,o)=>{"use strict";o.d(t,{a:()=>n,v:()=>i});const i=new Map([["record",{label:"Table",icon:"TypeTable"}],["single",{label:"Card",icon:"TypeCard"}],["detail",{label:"Card List",icon:"TypeCardList"}],["chart",{label:"Chart",icon:"TypeChart"}],["custom",{label:"Custom",icon:"TypeCustom"}],["custom.calendar",{label:"Calendar",icon:"FieldDate"}]]);function n(e){return i.get(e||"record")||i.get("record")}},89068:(e,t,o)=>{"use strict";o.d(t,{Mv:()=>D,UV:()=>k,Lz:()=>S});var i=o(11187);const n=["#FFFFFF","#DCDCDC","#888888","#000000","#FECBCC","#FD8182","#E00A17","#740206","#F3E1D2","#D6A77F","#AA632B","#653008","#FEE7C3","#FECC81","#FD9D28","#B36F19","#FFFACD","#FEF47A","#E8D62F","#928619","#E1FEDE","#98FD90","#2AE028","#126E0E","#CCFEFE","#8AFCFE","#24D6DB","#0C686A","#D3E7FE","#75B5FC","#157AFB","#084794","#E8D0FE","#BC77FC","#8725FB","#460D81","#FED6FB","#FD79F4","#E621D7","#760C6E"];function s(e){return e%4<=1}var r=o(29922),l=o(29002),a=o(7454),c=o(48402),d=o(83277),u=o(1310),p=o(21467),h=o(70387),m=Object.defineProperty,f=Object.defineProperties,g=Object.getOwnPropertyDescriptors,b=Object.getOwnPropertySymbols,v=Object.prototype.hasOwnProperty,y=Object.prototype.propertyIsEnumerable,_=(e,t,o)=>t in e?m(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,w=(e,t)=>{for(var o in t||(t={}))v.call(t,o)&&_(e,o,t[o]);if(b)for(var o of b(t))y.call(t,o)&&_(e,o,t[o]);return e},x=(e,t)=>f(e,g(t));const C=(0,h.makeT)("ColorSelect");class D{constructor(e){this.allowsNone=!1,this.defaultColor="",this.noneText="",Object.assign(this,e)}}function S(e,t){const{textColor:o,fillColor:i}=e,{onSave:n,onOpen:s,onRevert:l,placeholder:d=C("Default cell style")}=t,h=(0,c.G)(H(q("T",u.dom.style("color",(e=>e(o.color)||o.defaultColor)),u.dom.style("background-color",(e=>{var t;return(null==(t=e(i.color))?void 0:t.slice(0,7))||i.defaultColor})),u.dom.cls("font-bold",(t=>{var o;return null!=(o=t(e.fontBold))&&o})),u.dom.cls("font-italic",(t=>{var o;return null!=(o=t(e.fontItalic))&&o})),u.dom.cls("font-underline",(t=>{var o;return null!=(o=t(e.fontUnderline))&&o})),u.dom.cls("font-strikethrough",(t=>{var o;return null!=(o=t(e.fontStrikethrough))&&o})),U.cls(""),(0,r.testId)("btn-icon")),u.dom.text(d)),(0,a.icon)("Dropdown"),(0,r.testId)("color-select"));return(0,p.setPopupToCreateDom)(h,(t=>(null==s||s(),T(t,{styleOptions:e,onSave:n,onRevert:l}))),x(w({},p.defaultMenuOptions),{placement:"bottom-end"})),h}function k(e){const t=e,{colorPickerDomArgs:o}=t,i=((e,t)=>{var o={};for(var i in e)v.call(e,i)&&t.indexOf(i)<0&&(o[i]=e[i]);if(null!=e&&b)for(var i of b(e))t.indexOf(i)<0&&y.call(e,i)&&(o[i]=e[i]);return o})(t,["colorPickerDomArgs"]),{styleOptions:n}=i,{textColor:s,fillColor:l}=n,a=J("T",u.dom.style("color",(e=>e(s.color)||s.defaultColor)),u.dom.style("background-color",(e=>{var t;return(null==(t=e(l.color))?void 0:t.slice(0,7))||l.defaultColor})),u.dom.cls("font-bold",(e=>{var t;return null!=(t=e(n.fontBold))&&t})),u.dom.cls("font-italic",(e=>{var t;return null!=(t=e(n.fontItalic))&&t})),u.dom.cls("font-underline",(e=>{var t;return null!=(t=e(n.fontUnderline))&&t})),u.dom.cls("font-strikethrough",(e=>{var t;return null!=(t=e(n.fontStrikethrough))&&t})),(0,r.testId)("color-button"));return(0,p.setPopupToCreateDom)(a,(e=>T(e,i,o)),x(w({},p.defaultMenuOptions),{placement:"bottom-end"})),a}function T(e,t,...o){const{styleOptions:n,onSave:s,onRevert:l,onClose:a}=t,{textColor:c,fillColor:d,fontBold:p,fontUnderline:h,fontItalic:m,fontStrikethrough:f}=n,g=R.create(null,c.color),b=R.create(null,d.color),v=F.create(null,p),y=F.create(null,h),_=F.create(null,m),x=F.create(null,f),D=[g,b,v,y,_,x],S=u.Computed.create(null,(e=>D.every((t=>!1===e(t.needsSaving)))));function k(){null==l||l(),l||D.forEach((e=>e.revert())),e.close()}return e.onDispose((async()=>{if(!S.get())try{await s()}catch(e){null==l||l(),l||D.forEach((e=>e.revert()))}D.forEach((e=>e.dispose())),S.dispose(),null==a||a()})),V(u.dom.create(E,{fontBoldModel:v,fontUnderlineModel:y,fontItalicModel:_,fontStrikethroughModel:x}),z(),u.dom.create(O,g,w({title:"text"},c)),z(),u.dom.create(O,b,w({title:"fill"},d)),(e=>{setTimeout((()=>e.focus()),0)}),(0,u.onKeyDown)({Escape:()=>{k()},Enter:()=>{e.close()}}),X((0,i.primaryButton)(C("Apply"),u.dom.on("click",(()=>e.close())),u.dom.boolAttr("disabled",S),(0,r.testId)("colors-save")),(0,i.basicButton)(C("Cancel"),u.dom.on("click",(()=>k())),(0,r.testId)("colors-cancel"))),u.dom.on("focusout",((e,t)=>e.target!==t&&t.focus())),...o)}class I extends u.Disposable{constructor(e){super(),this.obs=e,this._localChange=!1,this._serverValue=u.Observable.create(this,this.obs.get()),this.needsSaving=u.Computed.create(this,(e=>{const t=e(this.obs),o=e(this._serverValue);return t!==("boolean"==typeof t?null!=o&&o:o)})),this.autoDispose(this.obs.addListener((e=>{this._localChange||this._serverValue.set(e)})))}setValue(e){this._localChange=!0,this.obs.set(e),this._localChange=!1}revert(){this.obs.set(this._serverValue.get())}}class R extends I{}class F extends I{}class O extends u.Disposable{constructor(e,t){super(),this._model=e,this._options=t,this._color=u.Computed.create(this,this._model.obs,((e,t)=>(t||this._options.defaultColor).toUpperCase().slice(0,7)))}buildDom(){const e=this._options.title,t=u.Computed.create(null,(e=>e(this._color)||this._options.noneText));return[L(e),$(B(u.dom.update(W(U.cls(""),u.dom.style("background-color",this._color),K("Empty",u.dom.hide((e=>!0===Boolean(e(this._color)))))),P({type:"color"},u.dom.attr("value",this._color),u.dom.on("input",((e,t)=>this._setValue(t.value||void 0))),(0,r.testId)(`${e}-input`))),j(t,(async e=>{e&&!(0,d.isValidHex)(e)||this._model.setValue(e||void 0)}),u.dom.autoDispose(t),(0,r.testId)(`${e}-hex`),u.dom.on("click",((e,t)=>setTimeout((()=>t.select()),0))))),Y(Y.cls("-selected",(e=>!e(this._color))),u.dom.on("click",(()=>this._setValue(void 0))),u.dom.hide(!this._options.allowsNone),K("Empty"),(0,r.testId)(`${e}-empty`))),N(n.map(((e,t)=>W(u.dom.style("background-color",e),U.cls("",s(t)),W.cls("-selected",(t=>t(this._color)===e)),u.dom.style("outline-color",s(t)?"":e),u.dom.on("click",(()=>this._setValue(e))),(0,r.testId)(`color-${e}`)))),(0,r.testId)(`${e}-palette`))]}_setValue(e){this._model.setValue(e)}}class E extends u.Disposable{constructor(e){super(),this._options=e}buildDom(){function e(e,t){return M(G(e),u.dom.on("click",(()=>t.setValue(!t.obs.get()))),M.cls("-selected",(e=>{var o;return null!=(o=e(t.obs))&&o})),(0,r.testId)(`font-option-${e}`))}return A(e("FontBold",this._options.fontBoldModel),e("FontUnderline",this._options.fontUnderlineModel),e("FontItalic",this._options.fontItalicModel),e("FontStrikethrough",this._options.fontStrikethroughModel))}}const A=(0,u.styled)("div",`\n  display: flex;\n  gap: 1px;\n  background: ${r.theme.colorSelectFontOptionsBorder};\n  border: 1px solid ${r.theme.colorSelectFontOptionsBorder};\n`),M=(0,u.styled)("div",`\n  display: grid;\n  place-items: center;\n  flex-grow: 1;\n  background: ${r.theme.colorSelectFontOptionBg};\n  --icon-color: ${r.theme.colorSelectFontOptionFg};\n  height: 24px;\n  cursor: pointer;\n  &:hover:not(&-selected) {\n    background: ${r.theme.colorSelectFontOptionBgHover};\n  }\n  &-selected {\n    background: ${r.theme.colorSelectFontOptionBgSelected};\n    --icon-color: ${r.theme.colorSelectFontOptionFgSelected}\n  }\n`),P=(0,u.styled)("input","\n  opacity: 0;\n  position: absolute;\n  top: 0;\n  left: 0;\n  width: 100%;\n  height: 100%;\n  padding: 0;\n  border: none;\n"),B=(0,u.styled)("div","\n  display: flex;\n"),$=(0,u.styled)("div","\n  display: flex;\n  justify-content: space-between;\n  margin-bottom: 8px;\n"),L=(0,u.styled)("div",`\n  color: ${r.theme.colorSelectFg};\n  text-transform: uppercase;\n  font-size: ${r.vars.smallFontSize};\n  margin-bottom: 12px;\n`),N=(0,u.styled)("div","\n  width: 236px;\n  height: calc(4 * 20px + 3 * 4px);\n  display: flex;\n  flex-direction: column;\n  flex-wrap: wrap;\n  justify-content: space-between;\n  align-content: space-between;\n"),z=(0,u.styled)("div","\n  height: 24px;\n"),V=(0,u.styled)("div",`\n  padding: 18px 16px;\n  background-color: ${r.theme.colorSelectBg};\n  box-shadow: 0 2px 16px 0 ${r.theme.colorSelectShadow};\n  z-index: 20;\n  margin: 2px 0;\n  &:focus {\n    outline: none;\n  }\n`),H=(0,u.styled)("div","\n  display: flex;\n  align-items: center;\n"),j=(0,u.styled)(l.textInput,`\n  border: 1px solid ${r.theme.colorSelectInputBorder};\n  border-left: none;\n  font-size: ${r.vars.smallFontSize};\n  display: flex;\n  align-items: center;\n  color: ${r.theme.colorSelectInputFg};\n  background-color: ${r.theme.colorSelectInputBg};\n  width: 56px;\n  outline: none;\n  padding: 0 3px;\n  height: unset;\n  border-radius: unset;\n`),U=(0,u.styled)("div",`\n  border: 1px solid ${r.theme.colorSelectColorSquareBorder};\n`),W=(0,u.styled)("div",`\n  width: 20px;\n  height: 20px;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  position: relative;\n  &-selected {\n    outline: 1px solid ${r.theme.colorSelectColorSquareBorder};\n    outline-offset: 1px;\n  }\n`),Y=(0,u.styled)(W,`\n  --icon-color: ${r.theme.iconError};\n  border: 1px solid #D9D9D9;\n  &-selected {\n    outline: 1px solid ${r.theme.colorSelectColorSquareBorderEmpty};\n    outline-offset: 1px;\n  }\n`),G=(0,u.styled)(a.icon,"\n  height: 12px;\n  width: 12px;\n"),K=(0,u.styled)(a.icon,`\n  height: 100%;\n  width: 100%;\n  --icon-color: ${r.theme.iconError}\n`),q=(0,u.styled)(W,"\n  margin-right: 6px;\n  margin-left: 4px;\n"),J=(0,u.styled)(W,"\n  min-width: 18px;\n  width: 18px;\n  height: 18px;\n  cursor: pointer;\n  display: grid;\n  place-items: center;\n"),X=(0,u.styled)("div","\n  gap: 8px;\n  display: flex;\n  margin-top: 24px;\n")},88261:(e,t,o)=>{"use strict";o.r(t),o.d(t,{alignmentSelect:()=>d,buttonSelect:()=>a,buttonToggleSelect:()=>c,colorSelect:()=>u,cssButtonSelect:()=>m,makeButtonSelect:()=>p});var i=o(29922),n=o(7454),s=o(83277),r=o(1310);const l=o(88466);function a(e,t,...o){return p(e,t,(t=>{e.set(t)}),...o)}function c(e,t,...o){return p(e,t,(t=>{e.set(e.get()===t?null:t)}),...o)}function d(e,...t){return a(e,[{value:"left",icon:"LeftAlign"},{value:"center",icon:"CenterAlign"},{value:"right",icon:"RightAlign"}],{},(0,i.testId)("alignment-select"),...t)}function u(e,t,...o){const i=l((t=>e.set(t.target.value)),300),n=l((e=>t(e.target.value)),300);return b(v({type:"color"},r.dom.attr("value",(t=>t(e).slice(0,7))),r.dom.on("input",i),r.dom.on("change",n)),r.dom.style("background-color",(t=>t(e)||"#000000")),b.cls("-dark",(t=>(0,s.isColorDark)(t(e)||"#000000"))),y("Dots"),...o)}function p(e,t,o,...s){return m(r.dom.forEach(t,(t=>{const s=function(e){return h(e)?e.value:e}(t),l=function(e){return h(e)?e.label:e}(t);return f(f.cls("-selected",(t=>t(e)===s)),r.dom.on("click",(()=>o(s))),h(t)&&t.icon?(0,n.icon)(t.icon):null,l?g(l):null,(0,i.testId)("select-button"))})),...s)}function h(e){return"string"!=typeof e}const m=(0,r.styled)("div",`\n  /* Resets */\n  position: relative;\n  outline: none;\n  border-style: none;\n  display: flex;\n\n  /* Vars */\n  color: ${i.theme.text};\n  flex: 1 1 0;\n`),f=(0,r.styled)("div",`\n  /* Resets */\n  position: relative;\n  outline: none;\n  border-style: none;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n\n  /* Vars */\n  flex: 1 1 0;\n  font-size: ${i.vars.mediumFontSize};\n  letter-spacing: -0.08px;\n  text-align: center;\n  line-height: normal;\n  min-width: 32px;\n  white-space: nowrap;\n  padding: 4px 10px;\n\n  background-color: ${i.theme.buttonGroupBg};\n  border: 1px solid ${i.theme.buttonGroupBorder};\n  --icon-color: ${i.theme.buttonGroupIcon};\n\n  margin-left: -1px;\n\n  cursor: pointer;\n\n  &:first-child {\n    border-top-left-radius: ${i.vars.controlBorderRadius};\n    border-bottom-left-radius: ${i.vars.controlBorderRadius};\n    margin-left: 0;\n  }\n\n  &:last-child {\n    border-top-right-radius: ${i.vars.controlBorderRadius};\n    border-bottom-right-radius: ${i.vars.controlBorderRadius};\n  }\n\n  &:hover:not(&-selected) {\n    border: 1px solid ${i.theme.buttonGroupBorderHover};\n    z-index: 5;  /* Update z-index so selected borders take precedent */\n  }\n\n  &-selected {\n    color: ${i.theme.buttonGroupSelectedFg};\n    --icon-color: ${i.theme.buttonGroupSelectedFg};\n    border: 1px solid ${i.theme.buttonGroupSelectedBorder};\n    background-color: ${i.theme.buttonGroupSelectedBg};\n    z-index: 10;  /* Update z-index so selected borders take precedent */\n  }\n\n  /* Styles when container includes cssButtonSelect.cls('-light') */\n  .${m.className}-light > & {\n    border: none;\n    border-radius: ${i.vars.controlBorderRadius};\n    margin-left: 0px;\n    padding: 8px;\n    color: ${i.theme.buttonGroupLightFg};\n    --icon-color: ${i.theme.buttonGroupLightFg};\n  }\n  .${m.className}-light > &-selected {\n    border: none;\n    color: ${i.theme.buttonGroupLightSelectedFg};\n    --icon-color: ${i.theme.buttonGroupLightSelectedFg};\n    background-color: initial;\n  }\n  .${m.className}-light > &:hover {\n    border: none;\n    background-color: ${i.theme.hover};\n  }\n  .${m.className}-disabled > &,\n  .${m.className}-disabled > &:hover {\n    --icon-color: ${i.theme.rightPanelToggleButtonDisabledFg};\n    color: ${i.theme.rightPanelToggleButtonDisabledFg};\n    background-color: ${i.theme.rightPanelToggleButtonDisabledBg};\n    border-color: ${i.theme.buttonGroupBorder};\n    pointer-events: none;\n  }\n`),g=(0,r.styled)("span","\n  margin: 0 2px;\n  vertical-align: middle;\n"),b=(0,r.styled)("div",`\n  position: relative;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  width: 100%;\n  min-width: 32px;\n  max-width: 56px;\n  height: 32px;\n  border-radius: 4px;\n  border: 1px solid ${i.colors.darkGrey};\n\n  &:hover {\n    border: 1px solid ${i.colors.hover};\n  }\n\n  &-dark {\n    border: none !important;\n  }\n`),v=(0,r.styled)("input","\n  position: absolute;\n  cursor: pointer;\n  opacity: 0;\n  top: 0;\n  left: 0;\n  width: 100%;\n  height: 100%;\n"),y=(0,r.styled)(n.icon,`\n  margin: 0 2px;\n  background-color: ${i.colors.slate};\n  pointer-events: none;\n\n  .${b.className}-dark & {\n    background-color: ${i.colors.light};\n  }\n`)},13884:(e,t,o)=>{"use strict";o.d(t,{x:()=>s});var i=o(29922),n=o(7454);const s=(0,o(1310).styled)(((...e)=>(0,n.icon)("DragDrop",(0,i.testId)("dragger"),...e)),`\n  --icon-color: ${i.theme.controlSecondaryFg};\n  visibility: hidden;\n  align-self: center;\n  flex-shrink: 0;\n  .kf_draggable:hover & {\n    visibility: visible;\n  }\n`)},73974:(e,t,o)=>{"use strict";o.r(t),o.d(t,{CellStyle:()=>u});var i=o(70387),n=o(77709),s=o(11187),r=o(89068),l=o(29922),a=o(31825),c=o(1310);const d=(0,i.makeT)("CellStyle");class u extends c.Disposable{constructor(e,t,o){super(),this._field=e,this._gristDoc=t,this._defaultTextColor=o}buildDom(){const e="record"===this._field.viewSection().parentKey();return[c.dom.maybe((t=>e),(()=>[p(h(d("HEADER STYLE"))),f((0,l.testId)("header-color-select"),c.dom.domComputedOwned((0,c.fromKo)(this._field.config.headerStyle),((e,t)=>{const o=(0,c.fromKo)(t.prop("headerTextColor")),i=(0,c.fromKo)(t.prop("headerFillColor")),n=(0,c.fromKo)(t.prop("headerFontBold")),s=(0,c.fromKo)(t.prop("headerFontUnderline")),l=(0,c.fromKo)(t.prop("headerFontItalic")),a=(0,c.fromKo)(t.prop("headerFontStrikethrough")),u=c.Computed.create(e,(e=>!!e(this._field.config.multiselect)&&[e(t.mixed("headerTextColor")),e(t.mixed("headerFillColor")),e(t.mixed("headerFontBold")),e(t.mixed("headerFontUnderline")),e(t.mixed("headerFontItalic")),e(t.mixed("headerFontStrikethrough"))].some(Boolean)));return(0,r.Lz)({textColor:new r.Mv({color:o,defaultColor:this._defaultTextColor,noneText:"default"}),fillColor:new r.Mv({color:i,allowsNone:!0,noneText:"none"}),fontBold:n,fontItalic:l,fontUnderline:s,fontStrikethrough:a},{onSave:()=>t.save(),onRevert:()=>t.revert(),placeholder:e=>e(u)?d("Mixed style"):d("Default header style")})})))])),p(h(d("CELL STYLE")),m(d("Open row styles"),c.dom.on("click",n.allCommands.viewTabOpen.run))),f((0,l.testId)("cell-color-select"),c.dom.domComputedOwned((0,c.fromKo)(this._field.config.style),((e,t)=>{const o=(0,c.fromKo)(t.prop("textColor")),i=(0,c.fromKo)(t.prop("fillColor")),n=(0,c.fromKo)(t.prop("fontBold")),s=(0,c.fromKo)(t.prop("fontUnderline")),l=(0,c.fromKo)(t.prop("fontItalic")),a=(0,c.fromKo)(t.prop("fontStrikethrough")),u=c.Computed.create(e,(e=>!!e(this._field.config.multiselect)&&[e(t.mixed("textColor")),e(t.mixed("fillColor")),e(t.mixed("fontBold")),e(t.mixed("fontUnderline")),e(t.mixed("fontItalic")),e(t.mixed("fontStrikethrough"))].some(Boolean)));return(0,r.Lz)({textColor:new r.Mv({color:o,defaultColor:this._defaultTextColor,noneText:"default"}),fillColor:new r.Mv({color:i,allowsNone:!0,noneText:"none"}),fontBold:n,fontItalic:l,fontUnderline:s,fontStrikethrough:a},{onSave:()=>t.save(),onRevert:()=>t.revert(),placeholder:e=>e(u)?d("Mixed style"):d("Default cell style")})}))),c.dom.create(a.o,d("Cell Style"),this._field,this._gristDoc,(0,c.fromKo)(this._field.config.multiselect))]}}const p=(0,c.styled)("div","\n  display: flex;\n  margin: 16px 16px 12px 16px;\n  justify-content: space-between;\n  align-items: baseline;\n"),h=(0,c.styled)("div",`\n  color: ${l.theme.text};\n  text-transform: uppercase;\n  font-size: ${l.vars.xsmallFontSize};\n`),m=(0,c.styled)(s.textButton,`\n  font-size: ${l.vars.mediumFontSize};\n`),f=(0,c.styled)("div",`\n  display: flex;\n  margin: 8px 16px;\n  align-items: center;\n  &-top-space {\n    margin-top: 24px;\n  }\n  &-disabled {\n    color: ${l.theme.disabledText};\n  }\n`)},31490:(e,t,o)=>{"use strict";o.r(t),o.d(t,{ChoiceItem:()=>b,ChoiceListEditor:()=>v,cssChoiceList:()=>k,cssDeleteButton:()=>x,cssDeleteIcon:()=>C,cssMatchText:()=>I,cssPlusButton:()=>R,cssPlusIcon:()=>F,cssToken:()=>w});var i=o(77709),n=o(11104),s=o(64982),r=o(29922),l=o(1370),a=o(16151),c=o(41880),d=o(63074),u=o(65552),p=o(93965),h=o(74987),m=o(55330),f=o(7454),g=o(1310);class b{constructor(e,t,o){this.label=e,this.isInvalid=t,this.isNew=o,this.cleanText=(0,n.normalizeText)(this.label)}}class v extends d._{constructor(e){super(e),this.options=e,this._enableAddNew=!0,this._showAddNew=!1;const t=e.field.widgetOptionsJson.peek().choices||[];this._choiceOptionsByName=e.field.widgetOptionsJson.peek().choiceOptions||{};const o=t.map((e=>new b(e,!1))),c=new Set(t),d=new n.ACIndexImpl(o),u={menuCssClass:`${l.menuCssClass} ${k.className} test-autocomplete`,search:async e=>this._maybeShowAddNew(d.search(e),e),renderItem:(e,t)=>this._renderACItem(e,t),getItemText:e=>e.label};this.commandGroup=this.autoDispose((0,i.createGroup)(e.commands,null,!0)),this._alignment=e.field.widgetOptionsJson.peek().alignment||"left";const f=(0,p.xD)(e.cellValue),v=(void 0===e.editValue&&Array.isArray(f)?f:[]).map((e=>new b(String(e),!c.has(String(e)))));this._tokenField=s.T.ctor().create(this,{initialValue:v,renderToken:e=>{var t,o,i,n,s,r,l,a;return[e.label,g.dom.style("background-color",(0,h.Yp)(this._choiceOptionsByName[e.label])),g.dom.style("color",(0,h.Us)(this._choiceOptionsByName[e.label])),g.dom.cls("font-bold",null!=(o=null==(t=this._choiceOptionsByName[e.label])?void 0:t.fontBold)&&o),g.dom.cls("font-underline",null!=(n=null==(i=this._choiceOptionsByName[e.label])?void 0:i.fontUnderline)&&n),g.dom.cls("font-italic",null!=(r=null==(s=this._choiceOptionsByName[e.label])?void 0:s.fontItalic)&&r),g.dom.cls("font-strikethrough",null!=(a=null==(l=this._choiceOptionsByName[e.label])?void 0:l.fontStrikethrough)&&a),m.cssChoiceToken.cls("-invalid",e.isInvalid)]},createToken:e=>new b(e,!c.has(e)),acOptions:u,openAutocompleteOnFocus:!0,readonly:e.readonly,trimLabels:!0,styles:{cssTokenField:_,cssToken:w,cssDeleteButton:x,cssDeleteIcon:C}}),this._dom=(0,g.dom)("div.default_editor",g.dom.cls("readonly_editor",e.readonly),g.dom.cls(T.className,e.readonly),this.cellEditorDiv=y((0,r.testId)("widget-text-editor"),this._contentSizer=D(),(e=>this._tokenField.attach(e))),(0,a.createMobileButtons)(e.commands)),this._textInput=this._tokenField.getTextInput(),g.dom.update(this._tokenField.getRootElem(),g.dom.style("justify-content",this._alignment)),g.dom.update(this._tokenField.getHiddenInput(),this.commandGroup.attach()),g.dom.update(this._textInput,g.dom.on("input",(()=>this.resizeInput(!0))),g.dom.prop("value",e.editValue||""),this.commandGroup.attach())}attach(e){this._editorPlacement=c.EditorPlacement.create(this,this._dom,e,{margins:(0,a.getButtonMargins)()}),this.autoDispose(this._editorPlacement.onReposition.addListener((()=>this.resizeInput()))),this.autoDispose(this._tokenField.tokensObs.addListener((()=>Promise.resolve().then((()=>this.resizeInput()))))),this.setSizerLimits(),this.resizeInput(),this._textInput.focus();const t=Math.min(this.options.cursorPos,this._textInput.value.length);this._textInput.setSelectionRange(t,t)}getDom(){return this._dom}getCellValue(){return(0,p.Cx)(this._tokenField.tokensObs.get().map((e=>e.label)))}getTextValue(){const e=this._tokenField.tokensObs.get().map((e=>e.label));return(0,u.cw)(e,{prettier:!0})}getCursorPos(){return this._textInput.selectionStart||0}async prepForSave(){const e=this._tokenField.tokensObs.get().filter((e=>e.isNew)).map((e=>e.label));if(e.length>0){const t=this.options.field.widgetOptionsJson.prop("choices");await t.saveOnly([...t.peek()||[],...new Set(e)])}}setSizerLimits(){const e=this._tokenField.getRootElem(),t=this._editorPlacement.calcSizeWithPadding(e,{width:1/0,height:1/0},{calcOnly:!0});this._contentSizer.style.maxWidth=Math.ceil(t.width)+"px"}resizeInput(e=!1){if(this.isDisposed())return;const t=this._tokenField.getRootElem();e&&this._inputSizer||(this._contentSizer.innerHTML="",g.dom.update(this._contentSizer,g.dom.update(t.cloneNode(!0),g.dom.style("width",""),g.dom.style("height",""),this._inputSizer=S(),g.dom.cls("test-tokenfield",!1)))),this._inputSizer.textContent=this._textInput.value+"​";const o=this._contentSizer.getBoundingClientRect(),i=this._editorPlacement.calcSizeWithPadding(t,o);t.style.width=i.width+"px",t.style.height=i.height+"px",this._textInput.style.width=this._inputSizer.getBoundingClientRect().width+"px"}_maybeShowAddNew(e,t){this._showAddNew=!1;const o=t.trim();if(!this._enableAddNew||!o)return e;const i=new b(o,!1,!0);return e.items.find((e=>e.cleanText===i.cleanText))||(e.items.push(i),this._showAddNew=!0),e}_renderACItem(e,t){const o=this._choiceOptionsByName[e.label];return(0,m.cssChoiceACItem)(e.isNew?[m.cssChoiceACItem.cls("-new"),R(F("Plus"))]:[m.cssChoiceACItem.cls("-with-new",this._showAddNew)],(0,m.choiceToken)((0,n.buildHighlightedDom)(e.label,t,I),o||{},g.dom.style("max-width","100%"),(0,r.testId)("choice-list-editor-item-label")),(0,r.testId)("choice-list-editor-item"),e.isNew?(0,r.testId)("choice-list-editor-new-item"):null)}}const y=(0,g.styled)("div",`\n  background-color: ${r.theme.cellEditorBg};\n  font-family: var(--grist-font-family-data);\n  font-size: var(--grist-medium-font-size);\n`),_=(0,g.styled)(s.c.cssTokenField,"\n  border: none;\n  align-items: start;\n  align-content: start;\n  padding: 0 3px;\n  height: min-content;\n  min-height: 22px;\n  color: black;\n  flex-wrap: wrap;\n"),w=(0,g.styled)(s.c.cssToken,`\n  padding: 1px 4px;\n  margin: 2px;\n  line-height: 16px;\n  white-space: pre;\n\n  &.selected {\n    box-shadow: inset 0 0 0 1px ${r.colors.lightGreen};\n  }\n`),x=(0,g.styled)(s.c.cssDeleteButton,`\n  position: absolute;\n  top: -8px;\n  right: -6px;\n  border-radius: 16px;\n  background-color: ${r.colors.dark};\n  width: 14px;\n  height: 14px;\n  cursor: pointer;\n  z-index: 1;\n  display: none;\n  align-items: center;\n  justify-content: center;\n\n  .${w.className}:hover & {\n    display: flex;\n  }\n  .${_.className}.token-dragactive & {\n    cursor: unset;\n  }\n`),C=(0,g.styled)(s.c.cssDeleteIcon,`\n  --icon-color: ${r.colors.light};\n  &:hover {\n    --icon-color: ${r.colors.darkGrey};\n  }\n`),D=(0,g.styled)("div",`\n  position: absolute;\n  left: 0;\n  top: -100px;\n  border: none;\n  visibility: hidden;\n  overflow: visible;\n  width: max-content;\n\n  & .${s.c.cssInputWrapper.className} {\n    display: none;\n  }\n`),S=(0,g.styled)("div","\n  flex: auto;\n  min-width: 24px;\n  margin: 3px 2px;\n"),k=(0,g.styled)("div",`\n  z-index: 1001;\n  box-shadow: 0 0px 8px 0 ${r.theme.menuShadow};\n  overflow-y: auto;\n  padding: 8px 0 0 0;\n  --weaseljs-menu-item-padding: 8px 16px;\n`),T=(0,g.styled)("div","\n  padding-left: 16px;\n  background: white;\n"),I=(0,g.styled)("span","\n  text-decoration: underline;\n"),R=(0,g.styled)("div",`\n  display: inline-block;\n  width: 20px;\n  height: 20px;\n  border-radius: 20px;\n  margin-right: 8px;\n  text-align: center;\n  background-color: ${r.colors.lightGreen};\n  color: ${r.colors.light};\n\n  .selected > & {\n    background-color: ${r.colors.darkGreen};\n  }\n`),F=(0,g.styled)(f.icon,`\n  background-color: ${r.colors.light};\n`)},74987:(e,t,o)=>{"use strict";o.d(t,{Rf:()=>re,Yp:()=>ne,Us:()=>se});var i=o(70387),n=o(3411),s=o(29922),r=o(7454),l=o(64982),a=o(11187),c=o(89068),d=o(29002),u=o(1310),p=o(77143),h=Object.defineProperty,m=Object.getOwnPropertySymbols,f=Object.prototype.hasOwnProperty,g=Object.prototype.propertyIsEnumerable,b=(e,t,o)=>t in e?h(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,v=(e,t)=>{for(var o in t||(t={}))f.call(t,o)&&b(e,o,t[o]);if(m)for(var o of m(t))g.call(t,o)&&b(e,o,t[o]);return e};const y=o(36812),_=o(76274);class w{constructor(e){for(const{label:t,previousLabel:o}of e.filter((e=>e.previousLabel)))t!==o&&(this[o]=t)}}class x{constructor(e,t,o){this.label=e,this.previousLabel=t,this.options=o}static from(e){return new x(e.label,e.previousLabel,e.options)}rename(e){return new x(e,this.previousLabel,this.options)}changeStyle(e){return new x(this.label,this.previousLabel,v(v({},this.options),e))}}const C={ChoiceItemType:(0,p.iface)([],{label:"string",previousLabel:(0,p.union)("string","null"),options:(0,p.opt)("ChoiceOptionsType")}),ChoiceOptionsType:(0,p.iface)([],{textColor:(0,p.opt)("string"),fillColor:(0,p.opt)("string"),fontBold:(0,p.opt)("boolean"),fontUnderline:(0,p.opt)("boolean"),fontItalic:(0,p.opt)("boolean"),fontStrikethrough:(0,p.opt)("boolean")})},{ChoiceItemType:D}=(0,p.createCheckers)(C);class S extends u.Disposable{constructor(e,t,o,i,n){super(),this._values=e,this._choiceOptionsByName=t,this._onSave=o,this._disabled=i,this._mixed=n,this._isEditing=u.Observable.create(this,!1),this._tokenFieldHolder=u.Holder.create(this),this._editorContainer=null,this._editorSaveButtons=null,this.autoDispose(this._values.addListener((()=>{this._cancel()}))),this.onDispose((()=>{this._isEditing.get()&&this._save()}))}buildDom(e=6){return u.dom.domComputed(this._isEditing,(t=>{if(t){const e=this._mixed.get()?[]:this._values.get().map((e=>new x(e,e,this._choiceOptionsByName.get().get(e)))),t=l.T.ctor().create(this._tokenFieldHolder,{initialValue:e,renderToken:e=>this._renderToken(e),createToken:e=>new x(e,null),clipboardToTokens:F,tokensToClipboard:(e,t)=>{t.setData("application/json",JSON.stringify(e)),t.setData("text/plain",e.map((e=>e.label)).join("\n"))},openAutocompleteOnFocus:!1,trimLabels:!0,styles:{cssTokenField:M,cssToken:P,cssTokenInput:z,cssInputWrapper:V,cssDeleteButton:Y,cssDeleteIcon:G},keyBindings:{previous:"ArrowUp",next:"ArrowDown"},variant:"vertical"});return U(this._editorContainer=O({tabIndex:"-1"},(e=>{t.attach(e),this._focusOnOpen(t.getTextInput())}),u.dom.on("focusout",(e=>{const t=(e,t=document.activeElement)=>null==e?void 0:e.contains(t);setTimeout((()=>{this._isEditing.get()&&(t(this._editorContainer)||t(document.querySelector(".token-color-picker"))||t(this._editorSaveButtons,e.relatedTarget)||this._save())}),0)})),(0,s.testId)("choice-list-entry")),this._editorSaveButtons=W((0,a.primaryButton)("Save",u.dom.on("click",(()=>this._save())),(0,s.testId)("choice-list-entry-save")),(0,a.basicButton)("Cancel",u.dom.on("click",(()=>this._cancel())),(0,s.testId)("choice-list-entry-cancel"))),u.dom.onKeyDown({Escape:()=>this._cancel()}),u.dom.onKeyDown({Enter:()=>this._save()}))}{const t=new u.MultiHolder,o=u.Computed.create(t,this._values,((t,o)=>o.length<=e?o:o.slice(0,e-1))),i=u.Computed.create(t,o,((e,t)=>0===t.length));return U(u.dom.autoDispose(t),u.dom.maybe(this._mixed,(()=>[E(u.dom.cls(n.cssBlockedCursor.className,this._disabled),T("Mixed configuration"))])),u.dom.maybe((e=>!e(this._mixed)),(()=>[E(u.dom.cls(n.cssBlockedCursor.className,this._disabled),u.dom.maybe(i,(()=>T("No choices configured"))),u.dom.domComputed(this._choiceOptionsByName,(e=>u.dom.forEach(o,(t=>{var o,i,n,r,l,a,c,d;return T(B(u.dom.style("background-color",R(e.get(t))||"#FFFFFF"),u.dom.style("color",I(e.get(t))||"#000000"),u.dom.cls("font-bold",null!=(i=null==(o=e.get(t))?void 0:o.fontBold)&&i),u.dom.cls("font-underline",null!=(r=null==(n=e.get(t))?void 0:n.fontUnderline)&&r),u.dom.cls("font-italic",null!=(a=null==(l=e.get(t))?void 0:l.fontItalic)&&a),u.dom.cls("font-strikethrough",null!=(d=null==(c=e.get(t))?void 0:c.fontStrikethrough)&&d),"T",(0,s.testId)("choice-list-entry-color")),$(t,(0,s.testId)("choice-list-entry-label")))})))),u.dom.maybe((t=>t(this._values).length>e),(()=>T((0,u.dom)("span",(0,s.testId)("choice-list-entry-label"),u.dom.text((t=>`+${t(this._values).length-(e-1)} more`)))))),u.dom.on("click",(()=>this._startEditing())),E.cls("-disabled",this._disabled),(0,s.testId)("choice-list-entry"))])),u.dom.maybe((e=>!e(this._disabled)),(()=>[W((0,a.primaryButton)(u.dom.text((e=>e(this._mixed)?"Reset":"Edit")),u.dom.on("click",(()=>this._startEditing())),(0,s.testId)("choice-list-entry-edit")))])))}}))}_startEditing(){this._disabled.get()||this._isEditing.set(!0)}_save(){const e=this._tokenFieldHolder.get();if(!e)return;const t=e.tokensObs.get(),o=e.getTextInputValue();""!==o&&t.push(new x(o,null));const i=_(t,(e=>e.label)),n=i.map((e=>e.label)),s=new Map,r=["fillColor","textColor","fontBold","fontItalic","fontStrikethrough","fontUnderline"];for(const e of i)if(e.options){const t={};r.filter((t=>void 0!==e.options[t])).forEach((o=>t[o]=e.options[o])),s.set(e.label,t)}y(this._values.get(),n)&&y(this._choiceOptionsByName.get(),s)?this._cancel():this._onSave(n,s,new w(i))}_cancel(){this._isEditing.set(!1)}_focusOnOpen(e){setTimeout((()=>k(e)),0)}_renderToken(e){var t,o,i,n;const r=u.Observable.create(null,R(e.options)),l=u.Observable.create(null,I(e.options)),a=u.Observable.create(null,null==(t=e.options)?void 0:t.fontBold),p=u.Observable.create(null,null==(o=e.options)?void 0:o.fontItalic),h=u.Observable.create(null,null==(i=e.options)?void 0:i.fontUnderline),m=u.Observable.create(null,null==(n=e.options)?void 0:n.fontStrikethrough),f=u.Observable.create(null,e.label);function g(e){e.stopPropagation()}const b=j(u.dom.autoDispose(r),u.dom.autoDispose(l),u.dom.autoDispose(f),(0,c.UV)({styleOptions:{textColor:new c.Mv({color:l,defaultColor:"#000000"}),fillColor:new c.Mv({color:r,allowsNone:!0,noneText:"none",defaultColor:"#FFFFFF"}),fontBold:a,fontItalic:p,fontUnderline:h,fontStrikethrough:m},onSave:async()=>{const t=this._tokenFieldHolder.get();if(!t)return;const o=r.get(),i=l.get(),n=a.get(),s=p.get(),c=h.get(),d=m.get();t.replaceToken(e.label,x.from(e).changeStyle({fillColor:o,textColor:i,fontBold:n,fontItalic:s,fontUnderline:c,fontStrikethrough:d}))},onClose:()=>{var e;return null==(e=this._editorContainer)?void 0:e.focus()},colorPickerDomArgs:[u.dom.cls("token-color-picker")]}),(0,d.editableLabel)(f,{save:async t=>{const o=this._tokenFieldHolder.get();o&&((t=t.trim())?o.replaceToken(e.label,x.from(e).rename(t)):f.set(e.label))},inputArgs:[(0,s.testId)("token-label"),u.dom.on("keydown",g),u.dom.on("copy",g),u.dom.on("cut",g),u.dom.on("paste",g),u.dom.onKeyDown({Enter:()=>{const e=this._tokenFieldHolder.get();e&&k(e.getTextInput())},Escape:()=>{var e;return null==(e=b.parentElement)?void 0:e.focus()}}),u.dom.on("click",g),u.dom.cls(L.className)],args:[u.dom.cls(N.className)]}));return[b,u.dom.onKeyDown({Escape$:()=>this._cancel()})]}}function k(e){e.focus(),e.setSelectionRange(e.value.length,e.value.length),e.scrollTo(0,e.scrollHeight)}function T(...e){return A(...e,(0,s.testId)("choice-list-entry-row"))}function I(e){return null==e?void 0:e.textColor}function R(e){return null==e?void 0:e.fillColor}function F(e){const t=e.getData("application/json");if(t&&function(e){try{return JSON.parse(e),!0}catch(e){return!1}}(t)){const e=JSON.parse(t);if(Array.isArray(e)&&e.every((e=>D.test(e))))return e.forEach((e=>e.previousLabel=null)),e}const o=e.getData("text/plain");return o?o.split("\n").map((e=>new x(e,null))):[]}const O=(0,u.styled)("div",`\n  width: 100%;\n  padding: 1px;\n  line-height: 1.5;\n  padding-left: 4px;\n  padding-right: 4px;\n  border: 1px solid ${s.theme.choiceEntryBorderHover};\n  border-radius: 4px;\n  background-color: ${s.theme.choiceEntryBg};\n`),E=(0,u.styled)(O,`\n  cursor: pointer;\n  border: 1px solid ${s.theme.choiceEntryBorder};\n\n  &:hover:not(&-disabled) {\n    border: 1px solid ${s.theme.choiceEntryBorderHover};\n  }\n  &-disabled {\n    opacity: 0.6;\n  }\n`),A=(0,u.styled)("div",`\n  display: flex;\n  margin-top: 4px;\n  margin-bottom: 4px;\n  padding: 4px 8px;\n  color: ${s.colors.dark};\n  background-color: ${s.colors.mediumGreyOpaque};\n  border-radius: 3px;\n  text-overflow: ellipsis;\n`),M=(0,u.styled)("div","\n  &.token-dragactive {\n    cursor: grabbing;\n  }\n"),P=(0,u.styled)(A,`\n  position: relative;\n  display: flex;\n  justify-content: space-between;\n  user-select: none;\n  cursor: grab;\n\n  &.selected {\n    background-color: ${s.colors.darkGrey};\n  }\n  &.token-dragging {\n    pointer-events: none;\n    z-index: 1;\n    opacity: 0.7;\n  }\n  .${M.className}.token-dragactive & {\n    cursor: unset;\n  }\n  &:focus {\n    outline: none;\n  }\n`),B=(0,u.styled)("div","\n  flex-shrink: 0;\n  width: 18px;\n  height: 18px;\n  display: grid;\n  place-items: center;\n"),$=(0,u.styled)("span","\n  margin-left: 6px;\n  display: inline-block;\n  text-overflow: ellipsis;\n  white-space: pre;\n  overflow: hidden;\n"),L=(0,u.styled)("input","\n  display: inline-block;\n  text-overflow: ellipsis;\n  white-space: pre;\n  overflow: hidden;\n"),N=(0,u.styled)("div","\n  margin-left: 6px;\n  text-overflow: ellipsis;\n  white-space: pre;\n  overflow: hidden;\n"),z=(0,u.styled)("input",`\n  background-color: ${s.theme.choiceEntryBg};\n  padding-top: 4px;\n  padding-bottom: 4px;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  flex: auto;\n  -webkit-appearance: none;\n  -moz-appearance: none;\n  border: none;\n  outline: none;\n`),V=(0,u.styled)("div","\n  margin-top: 4px;\n  margin-bottom: 4px;\n  position: relative;\n  flex: auto;\n  display: flex;\n"),H=(0,u.styled)("div","\n  display: flex;\n"),j=(0,u.styled)(H,"\n  max-width: calc(100% - 20px);\n"),U=(0,u.styled)("div","\n  width: 100%;\n  display: flex;\n  flex-direction: column;\n"),W=(0,u.styled)("div","\n  gap: 8px;\n  display: flex;\n  margin-top: 8px;\n  margin-bottom: 16px;\n"),Y=(0,u.styled)("div",`\n  display: inline;\n  float: right;\n  margin-left: 4px;\n  cursor: pointer;\n  .${M.className}.token-dragactive & {\n    cursor: unset;\n  }\n`),G=(0,u.styled)(r.icon,`\n   --icon-color: ${s.colors.slate};\n   &:hover {\n     --icon-color: ${s.colors.dark};\n   }\n `);var K=o(55330),q=o(61957),J=Object.defineProperty,X=Object.defineProperties,Q=Object.getOwnPropertyDescriptors,Z=Object.getOwnPropertySymbols,ee=Object.prototype.hasOwnProperty,te=Object.prototype.propertyIsEnumerable,oe=(e,t,o)=>t in e?J(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;const ie=(0,i.makeT)("ChoiceTextBox");function ne(e){var t;return null!=(t=null==e?void 0:e.fillColor)?t:K.DEFAULT_FILL_COLOR}function se(e){var t;return null!=(t=null==e?void 0:e.textColor)?t:K.DEFAULT_TEXT_COLOR}class re extends q.D{constructor(e){super(e),this._choices=this.options.prop("choices"),this._choiceOptions=this.options.prop("choiceOptions"),this._choiceValues=u.Computed.create(this,(e=>e(this._choices)||[])),this._choiceValuesSet=u.Computed.create(this,this._choiceValues,((e,t)=>new Set(t))),this._choiceOptionsByName=u.Computed.create(this,(e=>{return(t=e(this._choiceOptions))?new Map(Object.entries(t)):new Map;var t}))}buildDom(e){const t=e.cells[this.field.colId()],o="single"===this.field.viewSection().parentKey()?ue("Dropdown"):null;return ae(ce(u.dom.style("justify-content",(e=>"right"===e(this.alignment)?"flex-end":e(this.alignment))),o,u.dom.domComputed((o=>{if(this.isDisposed()||o(e._isAddRow))return null;const i=o(this.valueFormatter).formatAny(o(t));return""===i?null:(0,K.choiceToken)(i,(n=((e,t)=>{for(var o in t||(t={}))ee.call(t,o)&&oe(e,o,t[o]);if(Z)for(var o of Z(t))te.call(t,o)&&oe(e,o,t[o]);return e})({},o(this._choiceOptionsByName).get(i)||{}),r={invalid:!o(this._choiceValuesSet).has(i)},X(n,Q(r))),u.dom.cls(de.className),(0,s.testId)("choice-token"));var n,r}))))}buildConfigDom(){const e=u.Computed.create(null,(e=>e(this.field.disableModify)||e(e(this.field.column).disableEditData)||e(this.field.config.options.disabled("choices")))),t=u.Computed.create(null,(t=>!t(e)&&(t(this.field.config.options.mixed("choices"))||t(this.field.config.options.mixed("choiceOptions")))));return[super.buildConfigDom(),(0,n.cssLabel)(ie("CHOICES")),(0,n.cssRow)(u.dom.autoDispose(e),u.dom.autoDispose(t),u.dom.create(S,this._choiceValues,this._choiceOptionsByName,this.save.bind(this),e,t))]}buildTransformConfigDom(){return this.buildConfigDom()}getChoiceValuesSet(){return this._choiceValuesSet}getChoiceOptions(){return this._choiceOptionsByName}save(e,t,o){const i={choices:e,choiceOptions:le(t)};return this.field.config.updateChoices(o,i)}}function le(e){const t={};for(const[o,i]of e.entries())t[o]=i;return t}const ae=(0,u.styled)("div.field_clip","\n  padding: 0 3px;\n"),ce=(0,u.styled)("div","\n  display: flex;\n  width: 100%;\n  min-width: 0px;\n  overflow: hidden;\n"),de=(0,u.styled)("div","\n  margin: 2px;\n  height: min-content;\n  line-height: 16px;\n"),ue=(0,u.styled)(r.icon,`\n  background-color: ${s.colors.slate};\n  display: block;\n  height: inherit;\n`)},55330:(e,t,o)=>{"use strict";o.r(t),o.d(t,{DEFAULT_FILL_COLOR:()=>s,DEFAULT_TEXT_COLOR:()=>r,choiceToken:()=>l,cssChoiceACItem:()=>c,cssChoiceToken:()=>a});var i=o(29922),n=o(1310);const s=i.colors.mediumGreyOpaque.value,r="#000000";function l(e,t,...o){const{fillColor:i,textColor:l,fontBold:c,fontItalic:d,fontUnderline:u,fontStrikethrough:p,invalid:h}=t;return a(e,n.dom.style("background-color",null!=i?i:s),n.dom.style("color",null!=l?l:r),n.dom.cls("font-bold",null!=c&&c),n.dom.cls("font-underline",null!=u&&u),n.dom.cls("font-italic",null!=d&&d),n.dom.cls("font-strikethrough",null!=p&&p),h?a.cls("-invalid"):null,...o)}const a=(0,n.styled)("div",`\n  display: inline-block;\n  padding: 1px 4px;\n  border-radius: 3px;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  white-space: pre;\n\n  &-invalid {\n    background-color: white !important;\n    box-shadow: inset 0 0 0 1px ${i.colors.error};\n  }\n`),c=(0,n.styled)("li",`\n  display: block;\n  font-family: ${i.vars.fontFamily};\n  white-space: pre;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  outline: none;\n  padding: var(--weaseljs-menu-item-padding, 8px 24px);\n  cursor: pointer;\n\n  &.selected {\n    background-color: ${i.theme.autocompleteChoiceSelectedBg};\n  }\n  &-with-new {\n    scroll-margin-bottom: 37px;\n  }\n  &-new {\n    display: flex;\n    align-items: center;\n    position: sticky;\n    bottom: 0px;\n    height: 37px;\n    background-color: ${i.theme.menuBg};\n    border-top: 1px solid ${i.theme.menuBorder};\n    scroll-margin-bottom: initial;\n  }\n`)},31825:(e,t,o)=>{"use strict";o.d(t,{o:()=>v});var i=o(70387),n=o(3898),s=o(7485),r=o(8881),l=o(11187),a=o(89068),c=o(29922),d=o(7454),u=o(49506),p=o(97767),h=o(631),m=o(1310);const f=o(88466),g=(0,m.makeTestId)("test-widget-style-"),b=(0,i.makeT)("ConditionalStyle");class v extends m.Disposable{constructor(e,t,o,i){super(),this._label=e,this._ruleOwner=t,this._gristDoc=o,this._disabled=i,this._dataChangeTrigger=m.Observable.create(this,0),this._currentRecord=m.Computed.create(this,(e=>{if(!e(this._ruleOwner.hasRules))return;e(this._dataChangeTrigger);const i=e(t.tableId),n=o.docData.getTable(i),s=e(o.cursorPosition);return s&&"number"==typeof s.rowId?n.getRecord(s.rowId):void 0}));const n=f((()=>{this._dataChangeTrigger.isDisposed()||this._dataChangeTrigger.set(this._dataChangeTrigger.get()+1)}),0);m.Computed.create(this,(e=>{const i=e(t.tableId),s=o.docData.getTable(i);return s?e.owner.autoDispose(s.tableActionEmitter.addListener(n)):null}))}buildDom(){return[w({style:"margin-top: 16px"},(0,r.withInfoTooltip)((0,l.textButton)(b("Add conditional style"),g("add-conditional-style"),m.dom.on("click",(()=>this._ruleOwner.addEmptyRule())),m.dom.prop("disabled",this._disabled)),this._label===b("Row Style")?s.D.addRowConditionalStyle():s.D.addColumnConditionalStyle()),m.dom.hide((e=>e(this._ruleOwner.hasRules)))),m.dom.domComputedOwned((e=>e(this._ruleOwner.rulesCols)),((e,t)=>D(m.dom.show((e=>t.length>0&&(!this._disabled||!e(this._disabled)))),...t.map(((t,o)=>{const i=this._buildStyleOption(e,o,"textColor"),n=this._buildStyleOption(e,o,"fillColor"),s=this._buildStyleOption(e,o,"fontBold"),r=this._buildStyleOption(e,o,"fontItalic"),l=this._buildStyleOption(e,o,"fontUnderline"),c=this._buildStyleOption(e,o,"fontStrikethrough"),d=m.Computed.create(e,(e=>{const o=e(this._currentRecord);if(!o)return null;const i=o[e(t.colId)];return null!=i?i:null})),u=m.Computed.create(e,(e=>!(0,h.isValidRuleValue)(e(d)))),p=m.Computed.create(e,(e=>{const t=e(d);return e(u)?(0,h.isRaisedException)(t)?b("Error in style rule"):b("Rule must return True or False"):""}));return(0,m.dom)("div",g(`conditional-rule-${o}`),g("conditional-rule"),C("IF..."),T(I(this._buildRuleFormula(t.formula,t,u),k(m.dom.text(p),m.dom.show(u),g(`rule-error-${o}`)),(0,a.Lz)({textColor:new a.Mv({color:i,allowsNone:!0,noneText:"default"}),fillColor:new a.Mv({color:n,allowsNone:!0,noneText:"none"}),fontBold:s,fontItalic:r,fontUnderline:l,fontStrikethrough:c},{onSave:async()=>{await this._ruleOwner.rulesStyles.save()},placeholder:this._label||"Conditional Style"})),x("Remove",g(`remove-rule-${o}`),m.dom.on("click",(()=>this._ruleOwner.removeRule(o))))))}))))),w((0,l.textButton)(b("Add another rule"),m.dom.on("click",(()=>this._ruleOwner.addEmptyRule())),g("add-another-rule"),m.dom.prop("disabled",(e=>this._disabled&&e(this._disabled)))),m.dom.show((e=>e(this._ruleOwner.hasRules))))]}_buildStyleOption(e,t,o){const i=m.Computed.create(e,(e=>{var i;const n=e(this._ruleOwner.rulesStyles);return null==(i=null==n?void 0:n[t])?void 0:i[o]}));return i.onWrite((e=>{var i,n;const s=Array.from(null!=(i=this._ruleOwner.rulesStyles.peek())?i:[]);s[t]=null!=(n=s[t])?n:{},s[t][o]=e,this._ruleOwner.rulesStyles(s)})),i}_buildRuleFormula(e,t,o){return(0,n.cssFieldFormula)(e,{gristTheme:this._gristDoc.currentTheme,maxLines:1},m.dom.cls("formula_field_sidepane"),m.dom.cls(S.className,o),{tabIndex:"-1"},m.dom.on("focus",((e,o)=>{const i=this._gristDoc.viewModel.activeSection(),n=i.viewInstance(),s=(0,p.Ex)({gristDoc:this._gristDoc,editingFormula:i.editingFormula,column:t,editRow:null==n?void 0:n.moveEditRowToCursor(),refElem:o,setupCleanup:u.Sf,canDetach:!1});this._gristDoc.fieldEditorHolder.autoDispose(s)})))}}const y=(0,m.styled)(d.icon,"\n  flex: 0 0 auto;\n"),_=(0,m.styled)("div",`\n  text-transform: uppercase;\n  margin: 16px 16px 12px 16px;\n  color: ${c.theme.text};\n  font-size: ${c.vars.xsmallFontSize};\n`),w=(0,m.styled)("div",`\n  display: flex;\n  margin: 8px 16px;\n  align-items: center;\n  &-top-space {\n    margin-top: 24px;\n  }\n  &-disabled {\n    color: ${c.theme.disabledText};\n  }\n`),x=(0,m.styled)(y,`\n  flex: none;\n  margin: 6px;\n  margin-right: 0px;\n  transform: translateY(4px);\n  cursor: pointer;\n  --icon-color: ${c.theme.controlSecondaryFg};\n  &:hover {\n    --icon-color: ${c.theme.controlFg};\n  }\n`),C=(0,m.styled)(_,"\n  margin-top: 0px;\n  margin-bottom: 0px;\n"),D=(0,m.styled)("div","\n  display: flex;\n  flex-direction: column;\n  gap: 12px;\n  margin-top: 16px;\n  margin-bottom: 12px;\n"),S=(0,m.styled)("div",`\n  border-color: ${c.theme.inputInvalid};\n`),k=(0,m.styled)(p.So,"\n  margin: 2px 0px 10px 0px;\n"),T=(0,m.styled)(w,"\n  align-items: flex-start;\n  margin-top: 0px;\n  margin-bottom: 0px;\n"),I=(0,m.styled)("div","\n  overflow: hidden;\n  flex: 1;\n  display: flex;\n  flex-direction: column;\n  gap: 4px;\n")},66632:(e,t,o)=>{"use strict";o.d(t,{g:()=>d});var i=o(70387),n=o(84462),s=o(1310),r=o(11104),l=o(29922),a=o(22985);const c=(0,i.makeT)("CurrencyPicker");function d(e,t,o,{defaultCurrencyLabel:i,disabled:d}){const u=a.QT.map((e=>({value:e.code,label:`${e.code} ${e.name}`,cleanText:`${e.code} ${e.name}`.trim().toLowerCase()})));u.unshift({label:i,value:i,cleanText:i.toLowerCase()});const p=s.Computed.create(e,(e=>e(t)||i)),h=new r.ACIndexImpl(u,200,!0);return(0,n.R)(e,{acIndex:h,valueObs:p,disabled:d,save(e,t){if(!t)throw new Error(c("Invalid currency"));o(t.value===i?void 0:t.value)}},(0,l.testId)("currency-autocomplete"))}},85837:(e,t,o)=>{"use strict";o.d(t,{XY:()=>$,c8:()=>B,un:()=>j});var i=o(70387),n=o(29813),s=o(59727),r=o(76961),l=o(92769),a=o(3871),c=o(18222),d=o(11187),u=o(92478),p=o(29922),h=o(7454),m=o(1370),f=o(631),g=o(1310),b=o(84418),v=o(29301),y=o(60611),_=o.n(y),w=o(20106),x=o(73181),C=Object.defineProperty,D=Object.defineProperties,S=Object.getOwnPropertyDescriptors,k=Object.getOwnPropertySymbols,T=Object.prototype.hasOwnProperty,I=Object.prototype.propertyIsEnumerable,R=(e,t,o)=>t in e?C(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,F=(e,t)=>{for(var o in t||(t={}))T.call(t,o)&&R(e,o,t[o]);if(k)for(var o of k(t))I.call(t,o)&&R(e,o,t[o]);return e},O=(e,t)=>D(e,S(t));const E=o(16914),A=(0,g.makeTestId)("test-discussion-"),M=(0,i.makeT)("DiscussionEditor");class P extends g.Disposable{constructor(e){super(),this.gristDoc=e}async comment(e){}async reply(e,t){const o=Y(this.gristDoc);await this.gristDoc.docData.bundleActions(M("Reply to a comment"),(()=>{var i,n;return Promise.all([this.gristDoc.docModel.cells.sendTableAction(["AddRecord",null,{parentId:e.id.peek(),root:!1,type:f.CellInfoType.COMMENT,userRef:null!=(i=null==o?void 0:o.ref)?i:"",content:JSON.stringify({userName:null!=(n=null==o?void 0:o.name)?n:"",timeCreated:Date.now(),timeUpdated:null,text:t}),tableRef:e.tableRef.peek(),colRef:e.colRef.peek(),rowId:e.rowId.peek()}])])}))}resolve(e){var t;const o=Y(this.gristDoc);return e.resolved(!0),e.resolvedBy(null!=(t=null==o?void 0:o.email)?t:""),e.timeUpdated.setAndSave(Date.now())}async update(e,t){const o=Date.now();return e.text(t.trim()),e.timeUpdated.setAndSave(o)}async open(e){return e.resolved(!1),e.resolvedBy(""),e.timeUpdated.setAndSave(Date.now())}async remove(e){await e._table.sendTableAction(["RemoveRecord",e.id.peek()])}}class B extends P{constructor(e){super(e.gristDoc),this.props=e;const{column:t,rowId:o}=e;this.comments=g.Computed.create(this,(e=>e(e(t.cells).getObservable()).filter((t=>e(t.rowId)===o&&e(t.root)&&!e(t.hidden)))))}async comment(e){var t,o;const i=this.props,n=Y(i.gristDoc),s=Date.now(),r=["AddRecord","_grist_Cells",null,{tableRef:i.tableRef,colRef:i.column.id.peek(),rowId:i.rowId,type:f.CellInfoType.COMMENT,root:!0,userRef:null!=(t=null==n?void 0:n.ref)?t:"",content:JSON.stringify({timeCreated:s,text:e,userName:null!=(o=null==n?void 0:n.name)?o:""})}];await i.gristDoc.docData.sendActions([r],M("Started discussion"))}}class $ extends g.Disposable{constructor(e){super(),this.props=e,this._isEmpty=g.Computed.create(this,(t=>0===t(e.topic.comments).filter((e=>!t(e.resolved))).filter((e=>!t(e.hidden))).length));const t=(0,g.dom)("div",A("popup"),g.dom.domComputed((e=>e(this._isEmpty)),(t=>t?g.dom.create(L,{closeClicked:e.closeClicked,onSave:e=>this.props.topic.comment(e)}):g.dom.create(N,{topic:e.topic,readonly:e.gristDoc.isReadonly,gristDoc:e.gristDoc,panel:!1,closeClicked:e.closeClicked}))));!function(e,t,o,i,n){const s=(0,b.fi)(t,o,i);e.onDispose((()=>s.destroy())),document.body.appendChild(o),e.onDispose((()=>{g.dom.domDispose(o),o.remove()})),e.autoDispose(function(e,t){return g.dom.onElem(document,"click",(t=>{var o;const i=t.target;if(i&&!e.contains(i)){if(null==(o=i.parentElement)?void 0:o.closest(".grist-floating-menu"))return;n()}}),{useCapture:!0})}(o))}(this,e.domEl,t,G,this.props.closeClicked)}}class L extends g.Disposable{constructor(e){super(),this.props=e,this._newText=g.Observable.create(this,"")}buildDom(){return ae(A("topic-empty"),A("topic"),this._createCommentEntry(),g.dom.onKeyDown({Escape:()=>{var e,t;return null==(t=(e=this.props).closeClicked)?void 0:t.call(e)}}))}_createCommentEntry(){return Z(g.dom.create(H,{mode:"start",text:this._newText,onSave:()=>this.props.onSave(this._newText.get()),onCancel:()=>{var e,t;return null==(t=(e=this.props).closeClicked)?void 0:t.call(e)},editorArgs:[{placeholder:M("Write a comment")}],mainButton:M("Comment"),buttons:[M("Cancel")],args:[A("editor-start")]}))}}class N extends g.Disposable{constructor(e){super(),this.props=e,this._newText=g.Observable.create(this,""),this._commentInEdit=g.Observable.create(this,null),this._closing=g.Observable.create(this,!1),e.panel?this._comments=g.Computed.create(this,(t=>t(e.topic.comments).filter((e=>!t(e.hidden)&&t(e.root))))):this._comments=g.Computed.create(this,(t=>t(e.topic.comments).filter((e=>!t(e.resolved)&&!t(e.hidden)&&t(e.root))))),this._commentsToRender=g.Computed.create(this,(e=>{const t=e(this._comments).sort(((t,o)=>{var i,n;return(null!=(i=e(t.timeCreated))?i:0)-(null!=(n=e(o.timeCreated))?n:0)})),o=Math.max(0,t.length-200);return t.slice(o)})),this._truncated=g.Computed.create(this,(e=>e(this._comments).length>200))}buildDom(){return ae(g.dom.maybe(this._truncated,(()=>Ee(M("Showing last {{nb}} comments",{nb:200})))),ae.cls("-panel",this.props.panel),Ie(V.EDIT,(e=>this._onEditComment(e))),Ie(V.CANCEL,(e=>this._onCancelEdit())),g.dom.hide(this._closing),A("topic"),A("topic-filled"),g.dom.maybe(!this.props.panel,(()=>le(A("topic-header"),(0,g.dom)("div",g.dom.style("align-self","center"),"Comments"),Se(),Te((0,h.icon)("Popup"),A("topic-button-panel"),g.dom.on("click",(()=>this.props.gristDoc.showTool("discussion"))),{title:"Open panel"}),le.cls("-border")))),this._discussionList=he(A("topic-comments"),g.dom.forEach(this._commentsToRender,(e=>ce(de(de.cls("-resolved",(t=>Boolean(t(e.resolved)))),g.dom.create(V,O(F({},this.props),{comment:e}))))))),this.props.panel?null:this._createCommentEntry(),g.dom.onKeyDown({Escape:()=>{var e,t;return null==(t=(e=this.props).closeClicked)?void 0:t.call(e)}}))}_onCancelEdit(){var e;this._commentInEdit.get()&&(null==(e=this._commentInEdit.get())||e.isEditing.set(!1)),this._commentInEdit.set(null)}_onEditComment(e){var t;this._commentInEdit.get()&&(null==(t=this._commentInEdit.get())||t.isEditing.set(!1)),e.isEditing.set(!0),this._commentInEdit.set(e)}async _save(){try{return await this.props.topic.comment(this._newText.get().trim())}catch(e){return(0,l.reportError)(e)}finally{this._newText.set(""),this._discussionList.scrollTo(0,1e4)}}_createCommentEntry(){return oe(g.dom.create(H,{mode:"comment",text:this._newText,onSave:()=>this._save(),onCancel:()=>{var e,t;return null==(t=(e=this.props).closeClicked)?void 0:t.call(e)},mainButton:"Send",editorArgs:[{placeholder:M("Comment")}],args:[A("editor-add")]}))}}const z=class extends g.Disposable{constructor(e){super(),this.props=e,this.isEditing=g.Observable.create(this,!1),this.replying=g.Observable.create(this,!1),this._expanded=g.Observable.create(this,!1),this._replies=(0,s.$)(this,e.comment.children()),this._hasReplies=g.Computed.create(this,(e=>e(this._replies).length>0)),this._resolved=g.Computed.create(this,(t=>Boolean(t(e.comment.resolved)))),this._showReplies=g.Computed.create(this,(e=>!this.props.isReply&&e(this._replies).length>0&&(e(this._expanded)||!e(this.props.comment.resolved))))}buildDom(){var e;const t=this.props.comment,o=this.props.topic,i=e=>t.hidden()?null:Y(this.props.gristDoc,e.userRef(),e.userName());return this._bodyDom=ge(...null!=(e=this.props.args)?e:[],this.props.isReply?A("reply"):A("comment"),g.dom.on("click",(()=>{this.props.isReply||(Re(this._bodyDom,z.SELECT,t),this._resolved.get()&&this._expanded.set(!this._expanded.get()))})),g.dom.maybe((e=>!e(t.hidden)),(()=>[me(U(i(t),A("comment-avatar")),ve(ye((0,g.dom)("div",W(i(t),A("comment-nick")),g.dom.domComputed((e=>{var o,i;return Ce(function(e){const t=_()(e);return _()().diff(t,"days")<1?t.fromNow():t.format("MMM D, YYYY")}(null!=(i=null!=(o=e(t.timeUpdated))?o:e(t.timeCreated))?i:0),A("comment-time"))}))),Se(),_e((0,h.icon)("Dots"),A("comment-menu"),g.dom.style("margin-left","3px"),(0,m.menu)((()=>this._menuItems()),{placement:"bottom-start"}),g.dom.on("click",K))))),g.dom.maybe((e=>!e(this.isEditing)),(()=>g.dom.domComputed(t.hidden,(e=>e?ue("CENSORED",A("comment-text")):pe(g.dom.text((e=>{var o;return null!=(o=e(t.text))?o:""})),{style:"margin-top: 4px"},A("comment-text")))))),g.dom.maybeOwned(this.isEditing,(e=>{var i;const n=g.Observable.create(e,null!=(i=t.text.peek())?i:"");return g.dom.create(H,{text:n,mainButton:M("Save"),buttons:[M("Cancel")],onSave:async()=>{const e=n.get();n.set(""),await o.update(t,e),Re(this._bodyDom,z.CANCEL,this),this.isEditing.set(!1)},onCancel:()=>{Re(this._bodyDom,z.CANCEL,this),this.isEditing.set(!1)},mode:"start",args:[A("editor-edit")]})})),g.dom.maybe(this._showReplies,(()=>fe(A("replies"),be(g.dom.forEach(this._replies,(e=>(0,g.dom)("div",g.dom.create(z,O(F({},this.props),{comment:e,isReply:!0,args:[g.dom.style("padding-left","0px"),g.dom.style("padding-right","0px")]}))))))))),g.dom.maybe((e=>!e(this.isEditing)&&!this.props.isReply&&!e(t.resolved)),(()=>g.dom.domComputed((e=>{if(e(this.replying)){const e=g.Observable.create(null,"");return g.dom.create(H,{text:e,args:[g.dom.style("margin-top","8px"),A("editor-reply")],mainButton:M("Reply"),buttons:[M("Cancel")],onSave:async()=>{const i=e.get();this.replying.set(!1),await o.reply(t,i)},onCancel:()=>this.replying.set(!1),onClick:e=>{e===M("Cancel")&&this.replying.set(!1)},mode:"reply"})}return xe((0,h.icon)("Message"),M("Reply"),A("comment-reply-button"),g.dom.on("click",q((()=>this.replying.set(!0)))),g.dom.style("margin-left",(e=>e(this._hasReplies)?"16px":"0px")))})))),g.dom.domComputed((e=>!e(t.resolved)||this.props.isReply?null:Fe(A("comment-resolved"),(0,h.icon)("FieldChoice"),Oe(g.dom.text(M("Marked as resolved"))))))]))),this._bodyDom}_menuItems(){var e,t;const o=null==(t=null==(e=this.props.gristDoc.app.topAppModel.appObs.get())?void 0:e.currentUser)?void 0:t.ref,i=!this.props.comment.resolved()&&!this.props.isReply,n=this.props.comment;return[i?(0,m.menuItem)((()=>this.props.topic.resolve(this.props.comment)),M("Resolve")):null,n.resolved()?(0,m.menuItem)((()=>this.props.topic.open(n)),M("Open")):null,(0,m.menuItem)((()=>this.props.topic.remove(n)),M("Remove"),g.dom.cls("disabled",(e=>o!==e(n.userRef)))),(0,m.menuItem)((()=>this._edit()),M("Edit"),g.dom.cls("disabled",(e=>o!==e(n.userRef))))]}_edit(){Re(this._bodyDom,z.EDIT,this),this.isEditing.set(!0)}};let V=z;V.EDIT="comment-edit",V.CANCEL="comment-cancel",V.SELECT="comment-select";class H extends g.Disposable{constructor(e){super(),this.props=e}buildDom(){var e,t,o;const i=this.props.text,s=e=>g.dom.on("click",(()=>{var t,o,i,n;e===M("Cancel")?null==(o=(t=this.props).onCancel)||o.call(t):null==(n=(i=this.props).onClick)||n.call(i,e)})),r=async()=>{var e,t;return i.get()?await(null==(t=(e=this.props).onSave)?void 0:t.call(e)):{}};let l;return ie(...null!=(e=this.props.args)?e:[],ie.cls(`-${null!=(t=this.props.mode)?t:"comment"}`),A("comment-input"),g.dom.on("click",K),l=function(e,...t){return re(function(e){return[g.dom.prop("value",e),g.dom.on("input",((t,o)=>e.set(o.value)))]}(e),(e=>{setTimeout((()=>e.focus()),10)}),(0,x.po)(e),...t)}(i,ne.cls(""),re.cls(`-${this.props.mode}`),g.dom.onKeyDown({Enter$:async e=>{if((e.ctrlKey||e.metaKey)&&i.get().trim())return await(null==r?void 0:r()),e.preventDefault(),void e.stopPropagation()},Escape:e=>{var t,o;null==(o=(t=this.props).onCancel)||o.call(t),e.preventDefault(),e.stopPropagation()}}),...this.props.editorArgs||[],A("textarea")),(e=>{n.FocusLayer.create(this,{defaultFocusElem:l,allowFocus:e=>e!==document.body,pauseMousetrap:!0})}),se((0,d.primaryButton)(null!=(o=this.props.mainButton)?o:"Send",g.dom.prop("disabled",(e=>!e(i).trim())),g.dom.on("click",q(r)),A("button-send")),g.dom.forEach(this.props.buttons||[],(e=>(0,d.basicButton)(e,s(e),A(`button-${e}`))))))}}class j extends g.Disposable{constructor(e){var t,o;super(),this._grist=e,this._length=g.Observable.create(this,0);const i=(null==(o=null==(t=e.app.topAppModel.appObs.get())?void 0:t.currentUser)?void 0:o.id)||0;this._resolved=this.autoDispose((0,r.pD)(`u:${i};showResolvedDiscussions`,!1)),this._onlyMine=this.autoDispose((0,r.pD)(`u:${i};showMyDiscussions`,!1)),this._currentPage=this.autoDispose((0,r.pD)(`u:${i};showCurrentPage`,!0)),this._currentPageKo=v.observable(this._currentPage.get()),this._currentPage.addListener((e=>this._currentPageKo(e)))}buildDom(){var e;const t=new g.MultiHolder,o=g.Computed.create(t,(e=>e(e(this._grist.viewModel.viewSections).getObservable()))),i=g.Computed.create(t,(e=>e(this._currentPageKo)?[...new Set(e(o).map((t=>e(t.table))).filter((t=>e(t.tableId))))]:e(this._grist.docModel.visibleTables.getObservable()).filter((t=>e(t.tableId))))),n=g.Computed.create(t,(e=>{if(e(this._currentPageKo)){const t=new Set;return e(o).forEach((o=>{e(e(o.viewFields).getObservable()).forEach((o=>t.add(e(o.colRef))))})),o=>t.has(e(o.colRef))}return()=>!0})),s=a.RowWatcher.create(t);s.rowFilter.set((()=>!0));const r=t.autoDispose(v.computed((()=>{if(this._currentPageKo()){const e=[];for(const t of this._grist.viewModel.viewSections().all()){const o=t.viewInstance();o&&e.push(o.rowSource)}return e}return null})));null==(e=r.peek())||e.forEach((e=>s.subscribeTo(e))),t.autoDispose(r.subscribe((e=>{(0,g.bundleChanges)((()=>{s.clear(),e?e.forEach((e=>s.subscribeTo(e))):s.rowFilter.set((()=>!0))}))})));const l=s.rowFilter,c=g.Computed.create(t,(e=>{var t,o,i;const s=e(l),r=e(n),a=e(this._resolved),c=!e(this._onlyMine),d=null!=(i=null==(o=null==(t=e(this._grist.app.topAppModel.appObs))?void 0:t.currentUser)?void 0:o.email)?i:"";return t=>!e(t.hidden)&&s(e(t.rowId))&&r(t)&&(c||(t=>{const o=e(e(t.children).getObservable());return e(t.userRef)===d||o.some((t=>e(t.userRef)===d))})(t))&&(a||!e(t.resolved))})),d=g.Computed.create(t,(e=>E(E(e(i).map((t=>e(e(t.columns).getObservable()).map((t=>e(e(t.cells).getObservable()).filter((t=>e(t.root)&&e(t.type)===f.CellInfoType.COMMENT)))))))))),u=g.Computed.create(t,(e=>{const t=e(d),o=e(c);return t.filter(o)})),p=P.create(t,this._grist);return p.comments=u,t.autoDispose(u.addListener((e=>this._length.set(e.length)))),this._length.set(u.get().length),X(g.dom.autoDispose(t),A("panel"),Q(g.dom.create(N,{readonly:this._grist.isReadonly,gristDoc:this._grist,topic:p,panel:!0})),Ie(V.SELECT,(e=>{this._navigate(e).catch((()=>{}))})))}buildMenu(){return ee((0,g.dom)("span",g.dom.text((e=>`${e(this._length)} comments`)),A("comment-count")),we((0,h.icon)("Dots"),A("panel-menu"),(0,m.menu)((()=>[te((0,u.rp)(this._onlyMine,M("Only my threads"),A("my-threads")),(0,u.rp)(this._currentPage,M("Only current page"),A("only-page")),(0,u.rp)(this._resolved,M("Show resolved comments"),A("show-resolved")))]),{placement:"bottom-start"}),g.dom.on("click",K)))}async _navigate(e){const t=e.rowId.peek();function o(t){var o;const i=t.filter((t=>t.tableRef.peek()===e.tableRef.peek())).filter((t=>t.viewFields.peek().all().find((t=>t.colRef.peek()===e.colRef.peek()))))[0],n=null==i?void 0:i.getRowId(),s=null!=(o=null==i?void 0:i.viewFields.peek().all().findIndex((t=>t.colRef.peek()===e.colRef.peek())))?o:-1;return-1!==s?{sectionId:n,fieldIndex:s}:null}let i=0,n=-1;const s=o(this._grist.viewModel.viewSections.peek().all());if(s)i=s.sectionId,n=s.fieldIndex;else for(const e of this._grist.docModel.pages.getAllRows()){const t=o(this._grist.docModel.pages.getRowModel(e).view.peek().viewSections.peek().all());if(t){i=t.sectionId,n=t.fieldIndex;break}}if(!i)return;const r=this._grist.cursorPosition.get();(null==r?void 0:r.sectionId)===i&&r.fieldIndex===n&&r.rowId===t||await this._grist.recursiveMoveToCursorPos({rowId:t,sectionId:i,fieldIndex:n},!0)}}function U(e,...t){return J(e,"small",...t)}function W(e,...t){var o;return De(null!=(o=null==e?void 0:e.name)?o:"Anonymous",...t)}function Y(e,t,o){var i;if(t)return"string"!=typeof o?null:{name:o,ref:t||"",email:"",id:0};{const n=null==(i=e.app.topAppModel.appObs.get())?void 0:i.currentValidUser;if(!n)return{name:o||"",ref:t||"",email:"",id:0};if(!n.ref)throw new Error("User reference is not set");return n}}const G={placement:"bottom",strategy:"fixed",modifiers:[O(F({},w.Z),{options:{padding:4}}),{name:"applyMaxSize",enabled:!0,phase:"beforeWrite",requires:["maxSize"],fn({state:e}){const{height:t}=e.modifiersData.maxSize;Object.assign(e.styles.popper,{maxHeight:`${Math.min(Math.max(250,t),600)}px`})}},{name:"offset",options:{offset:[0,4]}},{name:"computeStyles",options:{gpuAcceleration:!1}},{name:"eventListeners",enabled:!1}]};function K(e){e.stopPropagation()}function q(e){return t=>{K(t),e()}}const J=(0,g.styled)(c.O_,"\n  flex: none;\n  margin-top: 2px;\n"),X=(0,g.styled)("div","\n  display: flex;\n  flex-direction: column;\n  flex: 1;\n  overflow: auto;\n  padding: 8px;\n"),Q=(0,g.styled)("div","\n  margin-bottom: 0px;\n"),Z=(0,g.styled)("div","\n  padding: 16px;\n"),ee=(0,g.styled)("div","\n  display: flex;\n  flex: 1;\n  align-items: center;\n  justify-content: space-between;\n"),te=(0,g.styled)("div","\n  display: flex;\n  padding: 12px;\n  padding-left: 16px;\n  padding-right: 16px;\n  gap: 10px;\n  flex-direction: column;\n"),oe=(0,g.styled)(Z,`\n  border-top: 1px solid ${p.theme.commentsPopupBorder};\n`),ie=(0,g.styled)("div",'\n  display: grid;\n  &-comment {\n    grid-template-columns: 1fr auto;\n    grid-template-rows: 1fr;\n    gap: 8px;\n    grid-template-areas: "text buttons";\n  }\n  &-start, &-reply {\n    grid-template-rows: 1fr auto;\n    grid-template-columns: 1fr;\n    gap: 8px;\n    grid-template-areas: "text" "buttons";\n  }\n'),ne=(0,g.styled)("div","\n  grid-area: text;\n"),se=(0,g.styled)("div","\n  grid-area: buttons;\n  display: flex;\n  align-items: flex-start;\n\n  gap: 8px;\n"),re=(0,g.styled)("textarea",`\n  min-height: 5em;\n  border-radius: 3px;\n  padding: 4px 6px;\n  color: ${p.theme.inputFg};\n  background-color: ${p.theme.inputBg};\n  border: 1px solid ${p.theme.inputBorder};\n  outline: none;\n  width: 100%;\n  resize: none;\n  max-height: 10em;\n  &-comment, &-reply {\n    min-height: 28px;\n    height: 28px;\n  }\n  &::placeholder {\n    color: ${p.theme.inputPlaceholderFg};\n  }\n`),le=(0,g.styled)("div",`\n  color: ${p.theme.text};\n  background-color: ${p.theme.commentsPopupHeaderBg};\n  padding: 12px; /* 12px * 2 + 24px (size of the icon) == 48px in height */\n  padding-right: 16px;\n  display: flex;\n  gap: 8px;\n  &-border {\n    border-bottom: 1px solid ${p.theme.commentsPopupBorder};\n  }\n`),ae=(0,g.styled)("div",`\n  position: relative;\n  display: flex;\n  flex-direction: column;\n  border: 1px solid ${p.theme.commentsPopupBorder};\n  border-radius: 4px;\n  background-color: ${p.theme.commentsPopupBodyBg};\n  box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);\n  z-index: 100;\n  width: 325px;\n  overflow: hidden;\n  outline: none;\n  max-height: inherit;\n  &-disabled {\n    background-color: ${p.theme.commentsPanelResolvedTopicBg}\n  }\n  &-panel {\n    width: unset;\n    box-shadow: none;\n    border-radius: 0px;\n    background: unset;\n    border: 0px;\n  }\n`),ce=(0,g.styled)("div",`\n  border-bottom: 1px solid ${p.theme.commentsPopupBorder};\n  &:last-child {\n    border-bottom: none;\n  }\n  .${ae.className}-panel & {\n    border: 1px solid ${p.theme.commentsPanelTopicBorder};\n    border-radius: 4px;\n    background-color: ${p.theme.commentsPanelTopicBg};\n    margin-bottom: 4px;\n  }\n`),de=(0,g.styled)("div",`\n  display: flex;\n  flex-direction: column;\n  padding: 16px;\n  &-resolved {\n    background-color: ${p.theme.commentsPanelResolvedTopicBg};\n    cursor: pointer;\n  }\n  &-resolved * {\n    color: ${p.theme.lightText} !important;\n  }\n`),ue=(0,g.styled)("div",`\n  color: ${p.theme.text};\n  margin-top: 4px;\n`),pe=(0,g.styled)("pre",`\n  color: ${p.theme.text};\n  padding: 0px;\n  font-size: revert;\n  border: 0px;\n  background: inherit;\n  font-family: inherit;\n  margin: 0px;\n  white-space: break-spaces;\n  word-break: break-word;\n  word-wrap: break-word;\n`),he=(0,g.styled)("div","\n  display: flex;\n  flex-direction: column;\n  overflow: auto;\n"),me=(0,g.styled)("div","\n  display: flex;\n  align-items: flex-start;\n  gap: 8px;\n"),fe=(0,g.styled)("div","\n  margin-top: 16px;\n"),ge=(0,g.styled)("div",`\n  border-bottom: 1px solid ${p.theme.commentsPopupBorder};\n  .${he.className} &:last-child {\n    border-bottom: 0px;\n  }\n`),be=(0,g.styled)("div","\n  margin-left: 16px;\n  display: flex;\n  flex-direction: column;\n  gap: 20px;\n"),ve=(0,g.styled)("div","\n  flex: 1;\n  display: flex;\n  flex-direction: column;\n  gap: 2px;\n  overflow: hidden;\n"),ye=(0,g.styled)("div","\n  display: flex;\n  align-items: baseline;\n  overflow: hidden;\n"),_e=(0,g.styled)("div",`\n  flex: none;\n  margin: 0 4px 0 auto;\n  height: 24px;\n  width: 24px;\n  padding: 4px;\n  line-height: 0px;\n  border-radius: 3px;\n  cursor: pointer;\n  --icon-color: ${p.theme.controlSecondaryFg};\n  &:hover, &.weasel-popup-open {\n    background-color: ${p.theme.controlSecondaryHoverBg};\n  }\n`),we=(0,g.styled)("div",`\n  flex: none;\n  margin: 0 4px 0 auto;\n  height: 24px;\n  width: 24px;\n  padding: 4px;\n  line-height: 0px;\n  border-radius: 3px;\n  cursor: pointer;\n  --icon-color: ${p.theme.rightPanelTabSelectedFg};\n  &:hover, &.weasel-popup-open {\n    background-color: ${p.theme.rightPanelTabButtonHoverBg};\n  }\n`),xe=(0,g.styled)(d.textButton,"\n  align-self: flex-start;\n  display: flex;\n  gap: 4px;\n  margin-top: 16px;\n"),Ce=(0,g.styled)("div",`\n  color: ${p.theme.lightText};\n  font-size: ${p.vars.smallFontSize};\n  text-overflow: ellipsis;\n  white-space: nowrap;\n  letter-spacing: 0.02em;\n  line-height: 16px;\n`),De=(0,g.styled)("div",`\n  font-weight: 600;\n  text-overflow: ellipsis;\n  white-space: nowrap;\n  overflow: hidden;\n  color: ${p.theme.commentsUserNameFg};\n  &-small {\n    font-size: 12px;\n  }\n`),Se=(0,g.styled)("div","\n  flex-grow: 1;\n"),ke=(0,g.styled)("div",`\n  padding: 4px;\n  border-radius: 4px;\n  line-height: 1px;\n  cursor: pointer;\n  --icon-color: ${p.theme.controlSecondaryFg};\n  &:hover {\n    background-color: ${p.theme.hover};\n  }\n`),Te=(0,g.styled)(ke,`\n  &:hover {\n    --icon-color: ${p.theme.controlPrimaryBg};\n  }\n`);function Ie(e,t){return o=>{g.dom.onElem(o,e,((e,o)=>{var i;t(null!=(i=e.detail.args)?i:{},e,o)}))}}function Re(e,t,o){e.dispatchEvent(new CustomEvent(t,{bubbles:!0,detail:{args:o}}))}const Fe=(0,g.styled)("div",`\n  margin-top: 5px;\n  --icon-color: ${p.theme.text};\n`),Oe=(0,g.styled)("span",`\n  color: ${p.theme.text};\n  font-size: ${p.vars.smallFontSize};\n  margin-left: 5px;\n`),Ee=(0,g.styled)("div","\n  position: absolute;\n  background: white;\n  inset: 0;\n  height: 2rem;\n  opacity: 57%;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  font-weight: 600;\n")},16151:(e,t,o)=>{"use strict";o.r(t),o.d(t,{createMobileButtons:()=>l,getButtonMargins:()=>a});var i=o(65106),n=o(29922),s=o(7454),r=o(1310);function l(e){return(0,i.nI)()?null:[d(p(h("CrossSmall")),r.dom.on("click",e.fieldEditCancel)),u(p(h("Tick")),r.dom.on("click",e.fieldEditSaveHere))]}function a(){return(0,i.nI)()?void 0:{left:20,right:20,top:0,bottom:0}}const c=(0,r.styled)("div","\n  height: 40px;\n  width: 40px;\n  padding: 8px;\n  position: absolute;\n  top: -8px;\n  --icon-color: white;\n"),d=(0,r.styled)(c,`\n  --icon-background-color: ${n.colors.error};\n  left: -40px;\n`),u=(0,r.styled)(c,`\n  --icon-background-color: ${n.colors.lightGreen};\n  right: -40px;\n`),p=(0,r.styled)("div","\n  border-radius: 20px;\n  background-color: var(--icon-background-color);\n  height: 24px;\n  width: 24px;\n"),h=(0,r.styled)(s.icon,"\n  height: 24px;\n  width: 24px;\n")},41880:(e,t,o)=>{"use strict";o.r(t),o.d(t,{EditorPlacement:()=>n});var i=o(1310);class n extends i.Disposable{constructor(e,t,o={}){var n,r,l,a;super(),this._cellElem=t,this.onReposition=this.autoDispose(new i.Emitter),this._margins={top:((null==(n=o.margins)?void 0:n.top)||0)+12,bottom:((null==(r=o.margins)?void 0:r.bottom)||0)+12,left:((null==(l=o.margins)?void 0:l.left)||0)+12,right:((null==(a=o.margins)?void 0:a.right)||0)+12},this._maxRect=document.body.getBoundingClientRect(),this._cellRect=s(this._cellElem),this.autoDispose(i.dom.onElem(window,"resize",(()=>{this._maxRect=document.body.getBoundingClientRect(),this._cellRect=s(this._cellElem),this.onReposition.emit()})));const c=this._editorRoot=(0,i.dom)("div.cell_editor",e);c.style.visibility="hidden",document.body.appendChild(c),this.onDispose((()=>{i.dom.domDispose(c),c.remove()}))}calcSize(e,t={}){const o=this._maxRect,i=this._margins,n=o.right-i.right-this._cellRect.left,s=Math.min(o.width-i.left-i.right,Math.max(560,n)),r=Math.min(s,Math.max(this._cellRect.width,e.width)),l=Math.max(i.left,Math.min(this._cellRect.left-o.left,o.width-i.right-r)),a=o.bottom-i.bottom-this._cellRect.top,c=Math.min(o.height-i.top-i.bottom,Math.max(400,a)),d=Math.min(c,Math.max(this._cellRect.height,e.height)),u=Math.max(i.top,Math.min(this._cellRect.top-o.top,o.height-i.bottom-d));return t.calcOnly||Object.assign(this._editorRoot.style,{visibility:"visible",left:l+"px",top:u+"px",width:r+"px","max-height":c+"px"}),{width:r,height:d}}calcSizeWithPadding(e,t,o={}){const i=this._editorRoot.getBoundingClientRect(),n=e.getBoundingClientRect(),s=i.height-n.height,r=i.width-n.width,{width:l,height:a}=this.calcSize({width:t.width+r,height:t.height+s},o);return{width:l-r,height:a-s}}}function s(e){const t=e.getBoundingClientRect(),o=getComputedStyle(e,null),i=parseFloat(o.getPropertyValue("border-top-width")),n=parseFloat(o.getPropertyValue("border-right-width")),s=parseFloat(o.getPropertyValue("border-bottom-width")),r=parseFloat(o.getPropertyValue("border-left-width"));return{width:t.width-r-n,height:t.height-i-s,top:t.top+i,bottom:t.bottom-s,left:t.left+r,right:t.right-n}}},86448:(e,t,o)=>{"use strict";o.r(t),o.d(t,{FieldBuilder:()=>si,createAllFieldWidgets:()=>ii});var i=o(77709),n=o(87056),s=o(1310),r=o(99451),l=o.n(r),a=Object.defineProperty,c=Object.getOwnPropertySymbols,d=Object.prototype.hasOwnProperty,u=Object.prototype.propertyIsEnumerable,p=(e,t,o)=>t in e?a(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,h=(e,t)=>{for(var o in t||(t={}))d.call(t,o)&&p(e,o,t[o]);if(c)for(var o of c(t))u.call(t,o)&&p(e,o,t[o]);return e};const m=o(78870);class f extends s.Disposable{constructor(e,t){super(),this.gristDoc=e,this._fieldBuilder=t,this.editor=null,this.formulaUpToDate=s.Observable.create(this,!0),this._shouldExecute=!1,this._triggerFinalize=m,this._isFinalizing=!1,this.field=t.field,this.origColumn=this.field.column(),this.origDisplayCol=this.field.displayColModel(),this.origWidgetOptions=this.field.widgetOptionsJson(),this.rules=this.origColumn.rules(),this.isCallPending=t.isCallPending,this._tableData=e.docData.getTable(this.origColumn.table().tableId()),this.autoDispose(i.createGroup({undo:this.cancel,redo:m},this,!0)),this.onDispose((()=>{this._setTransforming(!1),this._fieldBuilder.columnTransform=null,this.isCallPending(!1)}))}buildDom(){throw new Error("Not Implemented")}async finalize(){return this._triggerFinalize()}buildEditorDom(e){return this.editor||(this.editor=this.autoDispose(n.create({gristDoc:this.gristDoc,observable:this.transformColumn.formula,saveValueOnBlurEvent:!1}))),this.editor.buildDom((e=>{this.editor.adjustContentToWidth(),this.editor.attachSaveCommand(),e.on("change",(()=>{this.editor&&this.formulaUpToDate.set(this.editor.getValue()===this.transformColumn.formula())})),e.focus()}))}async prepare(e){const t=e||this.origColumn.type.peek(),o=this._tableData.docData.startBundlingActions({description:`Transformed column ${this.origColumn.colId()}.`,shouldIncludeInBundle:this._shouldIncludeInBundle.bind(this),prepare:this._doPrepare.bind(this,t),finalize:this._doFinalize.bind(this)});this._triggerFinalize=o.triggerFinalize,await o.preparePromise}async _doPrepare(e){if(!this.isDisposed()){this.isCallPending(!0);try{const t=await this.addTransformColumn(e);return this.field.colRef(t),this.transformColumn=this.field.column(),this.transformColumn.origColRef(this.origColumn.getRowId()),this._setTransforming(!0),this.postAddTransformColumn()}finally{this.isCallPending(!1)}}}_shouldIncludeInBundle(e){return e.every((e=>{var t,o,i;return(null==(t=e[2])?void 0:t.toString().startsWith("gristHelper_Transform"))||(null==(o=e[2])?void 0:o.toString().startsWith("gristHelper_Converted"))||(null==(i=e[3])?void 0:i.toString().startsWith("gristHelper_Converted"))||"SetDisplayFormula"===e[0]||"_grist_Tables_column"===e[1]||"_grist_Views_section_field"===e[1]}))}async addTransformColumn(e){const t=await this._tableData.sendTableAction(["AddColumn","gristHelper_Transform",h({type:e,isFormula:!0,formula:this.getIdentityFormula()},this.origWidgetOptions?{widgetOptions:JSON.stringify(this.origWidgetOptions)}:{})]);return this.rules&&await this.gristDoc.docData.sendActions([["UpdateRecord","_grist_Tables_column",t.colRef,{rules:this.rules}]]),t.colRef}postAddTransformColumn(){}async cancel(){return this._shouldExecute=!1,this._triggerFinalize()}async execute(){return this._shouldExecute=!0,this._triggerFinalize()}async _doFinalize(){if(this.isDisposed()||this._isFinalizing)return;this._isFinalizing=!0;const e=this.transformColumn.colId(),t=this.field,o=this.origColumn.getRowId(),i=this._tableData;this.isCallPending(!0);try{this._shouldExecute&&await this.gristDoc.docData.sendActions(this.executeActions())}finally{t.colRef(o),i.sendTableAction(["RemoveColumn",e]),this.cleanup(),this.dispose()}}executeActions(){const e=l()(this.origWidgetOptions)?h(h({},this.origWidgetOptions),this._fieldBuilder.options.peek()):this._fieldBuilder.options.peek();return[...this.previewActions(),["CopyFromColumn",this._tableData.tableId,this.transformColumn.colId.peek(),this.origColumn.colId.peek(),JSON.stringify(e)]]}cleanup(){}getIdentityFormula(){return"return $"+this.origColumn.colId()}_setTransforming(e){this.origColumn.isTransforming(e),this.transformColumn.isTransforming(e)}isFinalizing(){return this._isFinalizing}preview(){if(this.editor)return this.editor.writeObservable()}previewActions(){if(!this.editor)return[];const e=this.editor.getValue(),t=this.transformColumn.formula();return e===t?[]:e||t?[["UpdateRecord","_grist_Tables_column",this.transformColumn.getRowId(),{formula:e}]]:[]}}var g=o(3411),b=o(11187),v=o(29922);class y extends f{constructor(e,t){super(e,t)}buildDom(){return[(0,s.dom)("div.transform_menu",(0,s.dom)("div.transform_editor",this.buildEditorDom(this.getIdentityFormula()),(0,v.testId)("formula-transform-top"))),(0,g.cssButtonRow)((0,b.basicButton)(s.dom.on("click",(()=>this.cancel())),"Cancel",(0,v.testId)("formula-transform-cancel")),(0,b.basicButton)(s.dom.on("click",(()=>this.preview())),"Preview",s.dom.cls("disabled",this.formulaUpToDate),{title:"Update formula (Shift+Enter)"},(0,v.testId)("formula-transform-update")),(0,b.primaryButton)(s.dom.on("click",(()=>this.execute())),"Apply",(0,v.testId)("formula-transform-apply")))]}}var _=o(56209),w=o(65552),x=o(631),C=o(83277),D=o(50590),S=o(62862),k=o(93965),T=Object.defineProperty,I=Object.defineProperties,R=Object.getOwnPropertyDescriptors,F=Object.getOwnPropertySymbols,O=Object.prototype.hasOwnProperty,E=Object.prototype.propertyIsEnumerable,A=(e,t,o)=>t in e?T(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,M=(e,t)=>{for(var o in t||(t={}))O.call(t,o)&&A(e,o,t[o]);if(F)for(var o of F(t))E.call(t,o)&&A(e,o,t[o]);return e},P=(e,t)=>I(e,R(t));function B(e,t,o){switch(e){case"Ref":case"RefList":{const i=function(e,t){const o=e.docData.getTable(t.table().tableId()),i=o&&o.getColValues(t.colId());if(i)for(const t of i){if(x.isReferencing(t))return t[1];if(x.isList(t)){const e=t[1];if(x.isReference(e))return e[1]}else if("string"==typeof t){const o=t.match(/^\[?(\w+)\[/);if(o&&e.docData.getTable(o[1]))return o[1]}}return null}(o,t)||t.table().primaryTableId();return`${e}:${i}`}case"DateTime":return"DateTime:"+o.docInfoRow.timezone();default:return e}}async function $(e,t,o,i,n){const s=x.extractTypeFromColType(i),r=e.docData.getTable(t.table().tableId()),l=t.visibleColModel(),a=0!==l.getRowId()?l:t;let c=M({},a.widgetOptionsJson()||{});if(N(t)){delete c.rulesOptions;const{rulesOptions:e}=t.widgetOptionsJson()||{};e&&(c.rulesOptions=e)}const d={type:B(i,t,e),isFormula:!0,visibleCol:0,formula:`rec.${n}`,rules:t.rules()};switch(s){case"Bool":delete c.widget;break;case"Date":case"DateTime":{let{dateFormat:e}=c;if(!e){const t=r.getColValues(a.colId())||[];e=(0,S.guessDateFormat)(t.map(String)),c=M(M({},c),(0,S.dateTimeWidgetOptions)(e,!0))}"DateTime"!==s||c.timeFormat||(c.timeFormat=S.timeFormatOptions[0],c.isCustomTimeFormat=!1);break}case"Numeric":case"Int":if(!["Numeric","Int"].includes(a.type())){const t=D.Z.fromSettings(e.docData.docSettings()),o=r.getColValues(a.colId())||[];c=M(M({},c),t.guessOptions(o.filter(_.HD)))}break;case"Choice":if(!Array.isArray(c.choices)){const e=r.getDistinctValues(a.colId(),100);e&&(e.delete(""),e.delete(null),c=P(M({},c),{choices:Array.from(e,String)}))}break;case"ChoiceList":if(!Array.isArray(c.choices)){const e=new Set;for(let t of r.getColValues(a.colId())||[]){if(null===t)continue;t=String((0,k.xD)(t)).trim();const o=t.startsWith("[")&&C.safeJsonParse(t,null)||(0,w._0)(t);for(const t of o)if(e.add(String(t).trim()),e.size>100)break}e.delete(""),c=P(M({},c),{choices:Array.from(e)})}break;case"Ref":case"RefList":{const n=C.removePrefix(i,`${s}:`)||void 0;let l,a;const c=x.extractInfoFromColType(t.type.peek());if(n||"Ref"!==c.type&&"RefList"!==c.type){const i=r.getDistinctValues(o.colId(),100);if(!i)break;if(i.delete(x.getDefaultForType(t.type())),l=(await e.docData.findColFromValues(Array.from(i),2,n)).find((e=>e!==t.getRowId())),!l)break;if(a=e.columns.getRowModel(l).table().tableId(),n&&a!==n){console.warn("Inappropriate column received from findColFromValues");break}}else l=t.visibleCol.peek(),a=c.tableId;d.type=`${s}:${a}`,d.visibleCol=l;break}}return Object.keys(c).length&&(d.widgetOptions=JSON.stringify(c)),d}async function L(e,t,o){const i=null==o?t.visibleCol():o;if(N(t)){const o=function(e,t){return t?e.columns.getRowModel(t).colId():void 0}(e,i),n=t.colId(),s=0===i?"":`$${n}.${o}`;return t.saveDisplayFormula(s)}}function N(e){return(0,x.isFullReferencingType)(e.type())}var z=o(92769),V=o(70387),H=Object.defineProperty,j=Object.defineProperties,U=Object.getOwnPropertyDescriptors,W=Object.getOwnPropertySymbols,Y=Object.prototype.hasOwnProperty,G=Object.prototype.propertyIsEnumerable,K=(e,t,o)=>t in e?H(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,q=(e,t)=>{for(var o in t||(t={}))Y.call(t,o)&&K(e,o,t[o]);if(W)for(var o of W(t))G.call(t,o)&&K(e,o,t[o]);return e};const J=(0,V.makeT)("TypeTransform");class X extends f{constructor(e,t){super(e,t),this._reviseTypeChange=s.Observable.create(this,!1),this._shouldExecute=!0,this._transformWidget=s.Computed.create(this,(0,s.fromKo)(t.widgetImpl),((e,t)=>e(this.origColumn.isTransforming)?t:null))}buildDom(){const e=s.Observable.create(null,!1);return this._reviseTypeChange.set(!1),(0,s.dom)("div",(0,v.testId)("type-transform-top"),s.dom.maybe(this._transformWidget,(e=>e.buildTransformConfigDom())),s.dom.maybe(this._reviseTypeChange,(()=>(0,s.dom)("div.transform_editor",this.buildEditorDom(),(0,v.testId)("type-transform-formula")))),(0,g.cssButtonRow)((0,b.basicButton)(s.dom.on("click",(()=>{this.cancel().catch(z.reportError),e.set(!0)})),J("Cancel"),(0,v.testId)("type-transform-cancel"),s.dom.cls("disabled",e)),s.dom.domComputed(this._reviseTypeChange,(t=>t?(0,b.basicButton)(s.dom.on("click",(()=>this.preview())),J("Preview"),(0,v.testId)("type-transform-update"),s.dom.cls("disabled",(t=>t(e)||t(this.formulaUpToDate))),{title:J("Update formula (Shift+Enter)")}):(0,b.basicButton)(s.dom.on("click",(()=>{this._reviseTypeChange.set(!0)})),J("Revise"),(0,v.testId)("type-transform-revise"),s.dom.cls("disabled",e)))),(0,b.primaryButton)(s.dom.on("click",(()=>{this.execute().catch(z.reportError),e.set(!0)})),J("Apply"),(0,v.testId)("type-transform-apply"),s.dom.cls("disabled",e))))}async addTransformColumn(e){const t=this.gristDoc.docModel,o=await this._tableData.sendTableActions([["AddColumn","gristHelper_Converted",{type:"Any"}],["AddColumn","gristHelper_Transform",{type:"Any"}]]),i=o[0].colRef,n=o[1].colRef;this.transformColumn=t.columns.getRowModel(n),this._convertColumn=t.columns.getRowModel(i);const s=await $(t,this.origColumn,this.origDisplayCol,e,this._convertColumn.colId.peek()),r=s.rules;var l,a;return delete s.rules,await this._tableData.sendTableActions([["ModifyColumn",this._convertColumn.colId.peek(),(l=q({},s),a={isFormula:!1,formula:""},j(l,U(a)))],["ModifyColumn",this.transformColumn.colId.peek(),s]]),r&&await this.gristDoc.docData.sendActions([["UpdateRecord","_grist_Tables_column",n,{rules:r}]]),await this.convertValues(),n}convertValuesActions(){return[["ConvertFromColumn",this._tableData.tableId,this.origColumn.colId.peek(),this._convertColumn.colId.peek(),this.transformColumn.type.peek(),this.transformColumn.widgetOptions.peek(),this.transformColumn.visibleCol.peek()]]}async convertValues(){await Promise.all([this.gristDoc.docData.sendActions(this.convertValuesActions()),L(this.gristDoc.docModel,this.transformColumn)])}executeActions(){return[...this.convertValuesActions(),...super.executeActions()]}postAddTransformColumn(){this.autoDispose(this.transformColumn.type.subscribe(this.convertValues,this,"change")),this.autoDispose(this.transformColumn.type.subscribe(this.convertValues,this,"save")),this.autoDispose(this.transformColumn.visibleCol.subscribe(this.convertValues,this,"save")),this.autoDispose(this.field.widgetOptionsJson.subscribe(this.convertValues,this,"save"))}cleanup(){this._tableData.sendTableAction(["RemoveColumn",this._convertColumn.colId.peek()])}async setType(e){const t=this.gristDoc.docModel,o=await $(t,this.origColumn,this.origDisplayCol,e,this._convertColumn.colId.peek()),i=this.transformColumn;await i.updateColValues(o)}}var Q=o(26475),Z=o(7935),ee=o(81294),te=o.n(ee),oe=o(92979),ie=o(73783),ne=o(33620),se=o(38109),re=o(32529),le=o(53186),ae=o(36258),ce=o(1370);const de=(0,V.makeT)("FieldMenus");var ue=o(88261),pe=o(64283),he=o(64055);class me extends pe.a{constructor(){super(...arguments),this._diffTool=new he.diff_match_patch}buildConfigDom(){return(0,s.dom)("div")}buildDom(e){const t=s.Computed.create(null,(t=>{if(t(e._isAddRow)||this.isDisposed()||t(this.field.displayColModel).isDisposed())return[];const o=t(e.cells[t(t(this.field.displayColModel).colId)]),i=t(this.valueFormatter);return this._prepareCellDiff(o,i)}));return(0,s.dom)("div.field_clip",s.dom.autoDispose(t),s.dom.style("text-align",this.options.prop("alignment")),s.dom.cls("text_wrapping",(e=>Boolean(e(this.options.prop("wrap"))))),(0,C.inlineStyle)("--grist-diff-color","#000000"),(0,C.inlineStyle)("--grist-diff-background-color","#00000000"),s.dom.forEach(t,(([e,t])=>e===he.DIFF_DELETE?(0,s.dom)("span.diff-parent",t):e===he.DIFF_INSERT?(0,s.dom)("span.diff-remote",t):e===fe?(0,s.dom)("span.diff-local",t):(0,s.dom)("span.diff-common",t))))}_prepareCellDiff(e,t){if(!(0,x.isVersions)(e))return[[he.DIFF_EQUAL,t.formatAny(e)]];const o=e[1];return"local"in o?"remote"in o?[[he.DIFF_DELETE,t.formatAny(o.parent)],[fe,t.formatAny(o.local)],[he.DIFF_INSERT,t.formatAny(o.remote)]]:this._prepareTextDiff(t.formatAny(o.parent),t.formatAny(o.local)).map((([e,t])=>[e===he.DIFF_INSERT?fe:e,t])):this._prepareTextDiff(t.formatAny(o.parent),t.formatAny(o.remote))}_prepareTextDiff(e,t){const o=this._diffTool.diff_main(e,t);return this._diffTool.diff_cleanupSemantic(o),o.length>2&&this._notDiffWorthy(e,o.length)&&this._notDiffWorthy(t,o.length)?[[he.DIFF_DELETE,e],[he.DIFF_INSERT,t]]:(1===o.length&&o[0][0]===he.DIFF_DELETE&&o.push([1,"∅"]),o)}_notDiffWorthy(e,t){return e.length<5*t||this._isMostlyNumeric(e)}_isMostlyNumeric(e){return[...e].filter((e=>e>="0"&&e<="9")).length>e.length/2}}const fe=2;var ge=o(11486),be=o(49506),ve=o(85837),ye=o(97767),_e=o(49142),we=o(56634),xe=o(29002),Ce=o(7454),De=o(20742),Se=o(6263),ke=o(6015),Te=Object.defineProperty,Ie=Object.defineProperties,Re=Object.getOwnPropertyDescriptors,Fe=Object.getOwnPropertySymbols,Oe=Object.prototype.hasOwnProperty,Ee=Object.prototype.propertyIsEnumerable,Ae=(e,t,o)=>t in e?Te(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,Me=(e,t)=>{for(var o in t||(t={}))Oe.call(t,o)&&Ae(e,o,t[o]);if(Fe)for(var o of Fe(t))Ee.call(t,o)&&Ae(e,o,t[o]);return e};class Pe extends pe.a{constructor(e){super(e),this._attachmentsTable=this._getDocData().getMetaTable("_grist_Attachments"),this._height=this.options.prop("height"),this.autoDispose(this._height.subscribe((()=>{this.field.viewSection().events.trigger("rowHeightChange")})))}buildDom(e){const t=e.cells[this.field.colId()],o=s.Computed.create(null,(0,s.fromKo)(t),((e,t)=>Array.isArray(t)?t.slice(1):[])),i=this.field.colId(),n=this.field.column().table().tableId();return $e(s.dom.autoDispose(o),s.dom.cls("field_clip"),(0,ee.dragOverClass)("attachment_drag_over"),Le(Le.cls("-hover",(e=>e(o).length>0)),s.dom.on("click",(()=>this._selectAndSave(e,t))),(0,v.testId)("attachment-icon")),s.dom.maybe(e.id,(e=>s.dom.forEach(o,(t=>isNaN(t)?null:this._buildAttachment(t,o,{rowId:e,colId:i,tableId:n}))))),s.dom.on("drop",(o=>this._uploadAndSave(e,t,o.dataTransfer.files))),(0,v.testId)("attachment-widget"))}buildConfigDom(){const e=this.field.config.options,t=e.prop("height"),o=(0,s.input)((0,s.fromKo)(t),{onInput:!0},{style:"margin: 0 5px;",type:"range",min:"16",max:"96",value:"36"},(0,v.testId)("pw-thumbnail-size"),s.dom.prop("disabled",(t=>t(e.disabled("height")))));return(0,s.onElem)(o,"change",(e=>{t.setAndSave(o.value).catch(reportError)})),(0,g.cssRow)(ze("Size"),o)}_buildAttachment(e,t,o){const n=this._attachmentsTable.getValue(e,"fileName"),r=this._attachmentsTable.getValue(e,"fileIdent"),l=this._attachmentsTable.getValue(e,"imageHeight"),a=this._attachmentsTable.getValue(e,"imageWidth"),c=Boolean(l),d=c?a/l:1;return Ne({title:n},s.dom.style("height",(e=>`${e(this._height)}px`)),s.dom.style("width",(e=>parseInt(e(this._height),10)*d+"px")),c?(0,s.dom)("img",{style:"height: 100%; min-width: 100%; vertical-align: top;"},s.dom.attr("src",this._getUrl(e,o))):Be(n,r,this._height),s.dom.on("dblclick",(()=>i.allCommands.input.run(String(t.get().indexOf(e)+1)))),(0,v.testId)("pw-thumbnail"))}_getUrl(e,t){const o=this._getDocComm();return o.docUrl("attachment")+"?"+(0,C.encodeQueryParams)((i=Me(Me({},o.getUrlParams()),t),n={attId:e,name:this._attachmentsTable.getValue(e,"fileName")},Ie(i,Re(n))));var i,n}async _selectAndSave(e,t){const o=await(0,we.lX)({docWorkerUrl:this._getDocComm().docWorkerUrl,multiple:!0,sizeLimit:"attachment"});return this._save(e,t,o)}async _uploadAndSave(e,t,o){const i=await(0,we.IL)(Array.from(o),{docWorkerUrl:this._getDocComm().docWorkerUrl,sizeLimit:"attachment"});return this._save(e,t,i)}async _save(e,t,o){if(!o)return;const n=await this._getDocComm().addAttachments(o.uploadId),s=(t()?t():[Se.w.List]).concat(n);i.allCommands.setCursor.run(e,this.field),i.allCommands.input.run(s)}}function Be(e,t,o){const i=(0,ke.extname)("x"+e).slice(1)||(0,ke.extname)("x"+t).slice(1)||"?";return Ve(i.toUpperCase(),o&&Ve.cls((e=>{const t=parseFloat(e(o));return t<28?"-small":t<60?"-medium":"-large"})))}const $e=(0,s.styled)("div","\n  display: flex;\n  flex-wrap: wrap;\n  white-space: pre-wrap;\n\n  &.attachment_drag_over {\n    outline: 2px dashed #ff9a00;\n    outline-offset: -2px;\n  }\n"),Le=(0,s.styled)("div.glyphicon.glyphicon-paperclip",`\n  position: absolute;\n  top: 2px;\n  left: 2px;\n  padding: 2px;\n  background-color: #D0D0D0;\n  color: white;\n  border-radius: 2px;\n  border: none;\n  cursor: pointer;\n  box-shadow: 0 0 0 1px white;\n  z-index: 1;\n\n  &:hover {\n    background-color: #3290BF;\n  }\n\n  &-hover {\n    display: none;\n  }\n  .${$e.className}:hover &-hover {\n    display: inline;\n  }\n`),Ne=(0,s.styled)("div",`\n  color: black;\n  background-color: white;\n  border: 1px solid #bbb;\n  margin: 0 2px 2px 0;\n  position: relative;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  z-index: 0;\n  &:hover {\n    border-color: ${v.colors.lightGreen};\n  }\n`),ze=(0,s.styled)("div",`\n  color: ${v.colors.slate};\n  margin-right: 9px;\n`),Ve=(0,s.styled)("div",`\n  height: 100%;\n  width: 100%;\n  max-height: 80px;\n  max-width: 80px;\n  background-color: ${v.colors.slate};\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  font-size: ${v.vars.mediumFontSize};\n  font-weight: bold;\n  color: white;\n  overflow: hidden;\n\n  &-small { font-size: ${v.vars.xxsmallFontSize}; }\n  &-medium { font-size: ${v.vars.smallFontSize}; }\n  &-large { font-size: ${v.vars.mediumFontSize}; }\n`);var He=o(63074),je=o(65604),Ue=Object.defineProperty,We=Object.defineProperties,Ye=Object.getOwnPropertyDescriptors,Ge=Object.getOwnPropertySymbols,Ke=Object.prototype.hasOwnProperty,qe=Object.prototype.propertyIsEnumerable,Je=(e,t,o)=>t in e?Ue(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,Xe=(e,t)=>{for(var o in t||(t={}))Ke.call(t,o)&&Je(e,o,t[o]);if(Ge)for(var o of Ge(t))qe.call(t,o)&&Je(e,o,t[o]);return e},Qe=(e,t)=>We(e,Ye(t));class Ze extends He._{constructor(e){super(e);const t=e.gristDoc.docData,o=e.cellValue,i={rowId:e.rowId,colId:e.field.colId(),tableId:e.field.column().table().tableId()},n=e.editValue&&parseInt(e.editValue,0)-1||0;this._attachmentsTable=t.getMetaTable("_grist_Attachments"),this._docComm=t.docComm,this._rowIds=(0,s.obsArray)(Array.isArray(o)?o.slice(1):[]),this._attachments=(0,s.computedArray)(this._rowIds,(e=>{const t=this._attachmentsTable.getValue(e,"fileIdent"),o=je.lookup(t)||"application/octet-stream",n=(0,s.observable)(this._attachmentsTable.getValue(e,"fileName"));return{rowId:e,fileIdent:t,fileType:o,filename:n,hasPreview:Boolean(this._attachmentsTable.getValue(e,"imageHeight")),url:(0,s.computed)((t=>this._getUrl(i,e,t(n)))),inlineUrl:(0,s.computed)((t=>this._getUrl(i,e,t(n),!0)))}})),this._index=(0,s.makeLiveIndex)(this,this._attachments,n),this._selected=this.autoDispose((0,s.computed)((e=>{const t=e(this._index);return null===t?null:e(this._attachments)[t]})))}static skipEditor(e,t){if(Array.isArray(e))return e}attach(e){(0,De.modal)(((e,t)=>(this.onDispose(e.close),[tt.cls(""),s.dom.onKeyDown({Enter:t=>{e.close(),this.options.commands.fieldEditSaveHere()},Escape:t=>{e.close(),this.options.commands.fieldEditCancel()},ArrowLeft$:e=>!et(e)&&this._moveIndex(-1),ArrowRight$:e=>!et(e)&&this._moveIndex(1)}),s.dom.on("click",((t,o)=>{t.target===o&&e.close()})),...this._buildDom(e)])),{noEscapeKey:!0})}getCellValue(){return["L",...this._rowIds.get()]}getCursorPos(){return 0}getTextValue(){return""}_buildDom(e){return[ot(lt(s.dom.text((e=>{const t=e(this._attachments).length;return t?`${(e(this._index)||0)+1} of ${t}`:""})),(0,v.testId)("pw-counter")),s.dom.maybe(this._selected,(e=>st(rt(e.filename,{save:t=>this._renameAttachment(e,t),inputArgs:[(0,v.testId)("pw-name")]})))),lt(at(s.dom.maybe(this._selected,(e=>(0,b.basicButtonLink)(ct.cls(""),dt("Download"),"Download",s.dom.attr("href",e.url),s.dom.attr("target","_blank"),s.dom.attr("download",e.filename),(0,v.testId)("pw-download")))),this.options.readonly?null:[ct(dt("FieldAttachment"),"Add",s.dom.on("click",(()=>this._select())),(0,v.testId)("pw-add")),s.dom.maybe(this._selected,(()=>ct(dt("Remove"),"Delete",s.dom.on("click",(()=>this._remove())),(0,v.testId)("pw-remove"))))]),it(nt("CrossBig"),s.dom.on("click",(()=>e.close())),(0,v.testId)("pw-close")))),ut(ut.cls("-left"),nt("Expand"),(0,v.testId)("pw-left"),s.dom.hide((e=>!e(this._attachments).length||0===e(this._index))),s.dom.on("click",(()=>this._moveIndex(-1)))),ut(ut.cls("-right"),nt("Expand"),(0,v.testId)("pw-right"),s.dom.hide((e=>!e(this._attachments).length||e(this._index)===e(this._attachments).length-1)),s.dom.on("click",(()=>this._moveIndex(1)))),s.dom.domComputed(this._selected,(e=>function(e,t){const o=[ht.cls(""),(0,v.testId)("pw-attachment-content")];return e?e.hasPreview?(0,s.dom)("img",s.dom.attr("src",e.url),...o):e.fileType.startsWith("video/")?(0,s.dom)("video",s.dom.attr("src",e.inlineUrl),{autoplay:!1,controls:!0},...o):e.fileType.startsWith("audio/")?(0,s.dom)("audio",s.dom.attr("src",e.inlineUrl),{autoplay:!1,controls:!0},...o):e.fileType.startsWith("text/")||"application/json"===e.fileType?(0,s.dom)("div",...o,mt(ht.cls(""),Be(e.filename.get(),e.fileIdent),ft("Preview not available."))):(0,s.dom)("object",{type:e.fileType},s.dom.attr("data",e.inlineUrl),...o,mt(ht.cls(""),Be(e.filename.get(),e.fileIdent),ft("Preview not available."))):mt("No attachments",t?null:ft("Drop files here to attach."),...o)}(e,this.options.readonly))),e=>function(e,t){let o=null;function i(i,n){o=n?i.target:null,i.stopPropagation(),i.preventDefault(),e.classList.toggle(t,n)}s.dom.onElem(e,"dragenter",(e=>i(e,!0))),s.dom.onElem(e,"dragleave",(e=>e.target===o&&i(e,!1))),s.dom.onElem(e,"drop",(e=>i(e,!1)))}(e,pt.className),gt(this.options.readonly?null:mt("Drop files here to attach")),this.options.readonly?null:s.dom.on("drop",(e=>this._upload(e.dataTransfer.files))),(0,v.testId)("pw-modal")]}async _renameAttachment(e,t){await this._attachmentsTable.sendTableAction(["UpdateRecord",e.rowId,{fileName:t}]),e.filename.set(this._attachmentsTable.getValue(e.rowId,"fileName"))}_getUrl(e,t,o,i){return this._docComm.docUrl("attachment")+"?"+(0,C.encodeQueryParams)(Xe(Qe(Xe(Qe(Xe({},this._docComm.getUrlParams()),{name:o}),e),{maybeNew:1,attId:t}),i?{inline:1}:{}))}_moveIndex(e){const t=this._index.get()+e;this._index.set((0,C.clamp)(t,0,this._attachments.get().length))}_remove(){this._rowIds.splice(this._index.get(),1)}async _select(){const e=await(0,we.lX)({docWorkerUrl:this._docComm.docWorkerUrl,multiple:!0,sizeLimit:"attachment"});return this._add(e)}async _upload(e){const t=await(0,we.IL)(Array.from(e),{docWorkerUrl:this._docComm.docWorkerUrl,sizeLimit:"attachment"});return this._add(t)}async _add(e){if(!e)return;const t=await this._docComm.addAttachments(e.uploadId),o=this._rowIds.get().length;t.length>0&&(this._rowIds.push(...t),this._index.set(o))}}function et(e){return"INPUT"===e.target.tagName}const tt=(0,s.styled)("div","\n  background-color: initial;\n  width: 100%;\n  height: 100%;\n  border: none;\n  border-radius: 0px;\n  box-shadow: none;\n  padding: 0px;\n"),ot=(0,s.styled)("div","\n  padding: 16px 24px;\n  position: fixed;\n  width: 100%;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  color: white;\n"),it=(0,s.styled)("div",`\n  padding: 6px;\n  border-radius: 32px;\n  cursor: pointer;\n  background-color: ${v.colors.light};\n  --icon-color: ${v.colors.lightGreen};\n\n  &:hover {\n    background-color: ${v.colors.mediumGreyOpaque};\n    --icon-color: ${v.colors.darkGreen};\n  }\n`),nt=(0,s.styled)(Ce.icon,"\n  padding: 10px;\n"),st=(0,s.styled)("div",`\n  display: inline-block;\n  padding: 8px 16px;\n  margin-right: 8px;\n  min-width: 0px;\n  overflow: hidden;\n\n  &:hover {\n    outline: 1px solid ${v.colors.slate};\n  }\n  &:focus-within {\n    outline: 1px solid ${v.colors.darkGreen};\n  }\n`),rt=(0,s.styled)(xe.editableLabel,`\n  font-size: ${v.vars.mediumFontSize};\n  font-weight: bold;\n  color: white;\n`),lt=(0,s.styled)("div","\n  flex: 1;\n  display: flex;\n"),at=(0,s.styled)(b.cssButtonGroup,"\n  margin-left: auto;\n  margin-right: 16px;\n  height: 32px;\n  flex: none;\n"),ct=(0,s.styled)(b.basicButton,`\n  background-color: ${v.colors.light};\n  font-weight: normal;\n  padding: 0 16px;\n  border-top: none;\n  border-right: none;\n  border-bottom: none;\n  border-left: 1px solid ${v.colors.darkGrey};\n  display: flex;\n  align-items: center;\n\n  &:first-child {\n    border: none;\n  }\n  &:hover {\n    background-color: ${v.colors.mediumGreyOpaque};\n    border-color: ${v.colors.darkGrey};\n  }\n`),dt=(0,s.styled)(Ce.icon,`\n  --icon-color: ${v.colors.slate};\n  margin-right: 4px;\n`),ut=(0,s.styled)("div",`\n  position: fixed;\n  height: 32px;\n  margin: auto 24px;\n  top: 0px;\n  bottom: 0px;\n  z-index: 1;\n\n  padding: 6px;\n  border-radius: 32px;\n  cursor: pointer;\n  background-color: ${v.colors.lightGreen};\n  --icon-color: ${v.colors.light};\n\n  &:hover {\n    background-color: ${v.colors.darkGreen};\n  }\n  &-left {\n    transform: rotateY(180deg);\n    left: 0px;\n  }\n  &-right {\n    right: 0px;\n  }\n`),pt=(0,s.styled)("div",""),ht=(0,s.styled)("div",`\n  display: block;\n  height: calc(100% - 72px);\n  width: calc(100% - 64px);\n  max-width: 800px;\n  margin-left: auto;\n  margin-right: auto;\n  margin-top: 64px;\n  margin-bottom: 8px;\n  outline: none;\n  img& {\n    width: max-content;\n    height: unset;\n  }\n  audio& {\n    padding-bottom: 64px;\n  }\n  .${pt.className} > & {\n    display: none;\n  }\n`),mt=(0,s.styled)("div",`\n  display: flex;\n  flex-direction: column;\n  justify-content: center;\n  align-items: center;\n  font-size: ${v.vars.mediumFontSize};\n  font-weight: bold;\n  color: white;\n  padding: 0px;\n`),ft=(0,s.styled)("div","\n  font-weight: normal;\n  margin-top: 24px;\n"),gt=(0,s.styled)(ht,`\n  border: 2px dashed ${v.colors.mediumGreyOpaque};\n  height: calc(100% - 96px);\n  margin-top: 64px;\n  padding: 0px;\n  justify-content: center;\n  display: none;\n  .${pt.className} > & {\n    display: flex;\n  }\n`);var bt=o(9443),vt=o.n(bt),yt=o(29511),_t=o.n(yt),wt=o(74987),xt=o(55330),Ct=Object.defineProperty,Dt=Object.defineProperties,St=Object.getOwnPropertyDescriptors,kt=Object.getOwnPropertySymbols,Tt=Object.prototype.hasOwnProperty,It=Object.prototype.propertyIsEnumerable,Rt=(e,t,o)=>t in e?Ct(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;class Ft extends wt.Rf{buildDom(e){const t=e.cells[this.field.colId.peek()];return Ot(s.dom.cls("field_clip"),Ot.cls("-wrap",this.wrapping),s.dom.style("justify-content",(e=>"right"===e(this.alignment)?"flex-end":e(this.alignment))),s.dom.domComputed((o=>o(e._isAddRow)?null:[o(t),o(this.getChoiceValuesSet()),o(this.getChoiceOptions())]),(e=>{if(!e)return null;const[t,o,i]=e,n=(0,k.xD)(t);return n?(Array.isArray(n)?n:[n]).map((e=>{return(0,xt.choiceToken)(String(e),(t=((e,t)=>{for(var o in t||(t={}))Tt.call(t,o)&&Rt(e,o,t[o]);if(kt)for(var o of kt(t))It.call(t,o)&&Rt(e,o,t[o]);return e})({},i.get(String(e))||{}),n={invalid:!o.has(String(e))},Dt(t,St(n))),s.dom.cls(Et.className),(0,v.testId)("choice-list-cell-token"));var t,n})):null})))}}const Ot=(0,s.styled)("div","\n  display: flex;\n  align-content: start;\n  align-items: start;\n  padding: 0 3px;\n\n  position: relative;\n  min-height: 22px;\n\n  &-wrap {\n    flex-wrap: wrap;\n  }\n"),Et=(0,s.styled)("div","\n  flex: 0 1 auto;\n  min-width: 0px;\n  margin: 2px;\n  line-height: 16px;\n");var At=o(31490),Mt=o(40293),Pt=o.n(Mt),Bt=o(38062),$t=o.n(Bt),Lt=o(52445),Nt=o.n(Lt),zt=o(38149),Vt=o.n(zt),Ht=o(16151),jt=o(41880);class Ut extends He._{constructor(e){var t;super(e),this.options=e;const o=(0,C.undef)(e.state,e.editValue,String(null!=(t=e.cellValue)?t:""));this.editorState=s.Observable.create(this,o),this.commandGroup=this.autoDispose((0,i.createGroup)(e.commands,this,!0)),this._alignment=e.field.widgetOptionsJson.peek().alignment||"left",this._dom=(0,s.dom)("div.default_editor",s.dom.cls("readonly_editor",e.readonly),this.cellEditorDiv=(0,s.dom)("div.celleditor_cursor_editor",(0,v.testId)("widget-text-editor"),this._contentSizer=(0,s.dom)("div.celleditor_content_measure"),this.textInput=(0,s.dom)("textarea",s.dom.cls("celleditor_text_editor"),s.dom.style("text-align",this._alignment),s.dom.prop("value",o),s.dom.boolAttr("readonly",e.readonly),this.commandGroup.attach(),s.dom.on("input",(()=>this.onInput())))),(0,Ht.createMobileButtons)(e.commands))}attach(e){this._editorPlacement=jt.EditorPlacement.create(this,this._dom,e,{margins:(0,Ht.getButtonMargins)()}),this.autoDispose(this._editorPlacement.onReposition.addListener(this.resizeInput,this)),this.setSizerLimits(),this.resizeInput(),this.textInput.focus();const t=Math.min(this.options.cursorPos,this.textInput.value.length);this.textInput.setSelectionRange(t,t)}getDom(){return this._dom}getCellValue(){return this.options.field.createValueParser()(this.getTextValue())}getTextValue(){return this.textInput.value}getCursorPos(){return this.textInput.selectionStart}setSizerLimits(){const e=this._editorPlacement.calcSizeWithPadding(this.textInput,{width:1/0,height:1/0},{calcOnly:!0});this._contentSizer.style.maxWidth=Math.ceil(e.width)+"px"}onInput(){this.resizeInput(),this.editorState.set(String(this.getTextValue()))}resizeInput(){const e=this.textInput;this._contentSizer.textContent=e.value+"​";const t=this._contentSizer.getBoundingClientRect();"left"===this._alignment&&(t.width+=16);const o=this._editorPlacement.calcSizeWithPadding(e,t);var i,n,s;e.style.width=o.width+"px",e.style.height=o.height+"px",s=o,(n=t).width<=s.width&&n.height<=s.height&&((i=e).scrollHeight>i.clientHeight||i.scrollWidth>i.clientWidth)&&(e.style.overflow="hidden",e.clientHeight,e.style.overflow="auto")}}const Wt=(0,V.makeT)("HyperLinkEditor");var Yt=o(3988),Gt=o(4425),Kt=o(61957);class qt extends Kt.D{constructor(e){super(e,{defaultTextColor:v.colors.lightGreen.value})}buildDom(e){const t=e.cells[this.field.colId()],o=s.Computed.create(null,(e=>(0,Yt.constructUrl)(e(t))));return Jt(s.dom.autoDispose(o),s.dom.style("text-align",this.alignment),s.dom.cls("text_wrapping",this.wrapping),s.dom.maybe((e=>Boolean(e(t))),(()=>(0,Gt.rg)(o,(0,Ce.cssIconBackground)((0,Ce.icon)("FieldLink",(0,v.testId)("tb-link-icon")),s.dom.cls(Xt.className)),(0,v.testId)("tb-link")))),s.dom.text((e=>function(e){if("string"!=typeof e)return"";const t=e.lastIndexOf(" ");return t>=0?e.slice(0,t):e}(e(t)))))}}const Jt=(0,s.styled)("div.field_clip",`\n  color: var(--grist-actual-cell-color, ${v.colors.lightGreen});\n`),Xt=(0,Gt.Tf)(Jt.className);var Qt=o(66632),Zt=o(99597),eo=o(17933),to=Object.defineProperty,oo=Object.defineProperties,io=Object.getOwnPropertyDescriptors,no=Object.getOwnPropertySymbols,so=Object.prototype.hasOwnProperty,ro=Object.prototype.propertyIsEnumerable,lo=(e,t,o)=>t in e?to(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,ao=(e,t)=>{for(var o in t||(t={}))so.call(t,o)&&lo(e,o,t[o]);if(no)for(var o of no(t))ro.call(t,o)&&lo(e,o,t[o]);return e};const co=(0,V.makeT)("NumericTextBox"),uo=[{value:"currency",label:"$"},{value:"decimal",label:","},{value:"percent",label:"%"},{value:"scientific",label:"Exp"}],po=[{value:"parens",label:"(-)"}];class ho extends Kt.D{constructor(e){super(e)}buildConfigDom(){const e=new s.MultiHolder,t=s.Computed.create(e,(e=>{const{numMode:t}=e(this.field.config.options),o=e(this.field.documentSettings);return(0,Zt.y6)({numMode:t},o).resolvedOptions()})),o=this.field.config.options,i=(0,s.fromKo)(o),n=(0,s.fromKo)(this.field.documentSettings),r=s.Computed.create(e,i,((e,t)=>t.numMode||null)),l=s.Computed.create(e,i,((e,t)=>t.numSign||null)),a=s.Computed.create(e,i,((e,t)=>t.currency)),c=s.Computed.create(e,(e=>e(this.field.config.options.disabled("currency")))),d=s.Computed.create(e,i,((e,t)=>mo(t.decimals,""))),u=s.Computed.create(e,i,((e,t)=>mo(t.maxDecimals,""))),p=s.Computed.create(e,t,((e,t)=>t.minimumFractionDigits)),h=s.Computed.create(e,t,((e,t)=>t.maximumFractionDigits)),m=s.Computed.create(e,n,((e,t)=>{var o,i;return null!=(i=t.currency)?i:eo.z(null!=(o=t.locale)?o:"en-US")})),f=(e,t)=>{const i=ao({},o.peek());var n;t!==i[e]&&(o(ao((n=ao({},i),oo(n,io({[e]:t}))),function(e,t){return"numMode"!==e||t&&"scientific"!==t&&"percent"!==t?{}:{numSign:void 0}}(e,t))),o.save().catch((e=>{(0,z.reportError)(e),o(i)})))},b=e=>f("currency",e),y=ue.cssButtonSelect.cls("-disabled",c);return[super.buildConfigDom(),(0,g.cssLabel)(co("Number Format")),(0,g.cssRow)(s.dom.autoDispose(e),(0,ue.makeButtonSelect)(r,uo,(e=>f("numMode",e!==r.get()?e:void 0)),y,Co.cls(""),(0,v.testId)("numeric-mode")),(0,ue.makeButtonSelect)(l,po,(e=>f("numSign",e!==l.get()?e:void 0)),y,Do.cls(""),(0,v.testId)("numeric-sign"))),s.dom.maybe((e=>"currency"===e(r)),(()=>[(0,g.cssLabel)(co("Currency")),(0,g.cssRow)(s.dom.domComputed(m,(t=>(0,Qt.g)(e,a,b,{defaultCurrencyLabel:co("Default currency ({{defaultCurrency}})",{defaultCurrency:t}),disabled:c}))),(0,v.testId)("numeric-currency"))])),(0,g.cssLabel)(co("Decimals")),(0,g.cssRow)(fo("min",d,p,(e=>f("decimals",e&&(0,C.clamp)(e,0,20))),c,(0,v.testId)("numeric-min-decimals")),fo("max",u,h,(e=>f("maxDecimals",e&&(0,C.clamp)(e,0,20))),c,(0,v.testId)("numeric-max-decimals")))]}}function mo(e,t){return null!=e?Number(e):t}function fo(e,t,o,i,n,...r){return go(go.cls("-disabled",n),bo(e),vo({type:"text",size:"2",min:"0"},s.dom.prop("value",t),s.dom.prop("placeholder",o),s.dom.on("change",((e,o)=>{const n=parseInt(o.value,10);o.value=String(t.get()),i(Number.isNaN(n)?void 0:n),o.blur()})),s.dom.on("focus",((e,t)=>t.select()))),yo(_o(wo("DropdownUp"),s.dom.on("click",(()=>i(mo(t.get(),o.get())+1)))),_o(xo("Dropdown"),s.dom.on("click",(()=>i(mo(t.get(),o.get())-1))))),...r)}const go=(0,s.styled)("div",`\n  position: relative;\n  flex: auto;\n  --icon-color: ${v.theme.lightText};\n  color: ${v.theme.lightText};\n  font-weight: normal;\n  display: flex;\n  align-items: center;\n  &:first-child {\n    margin-right: 16px;\n  }\n  &-disabled {\n    background-color: ${v.theme.rightPanelToggleButtonDisabledBg};\n    pointer-events: none;\n  }\n`),bo=(0,s.styled)("div","\n  position: absolute;\n  padding-left: 8px;\n  pointer-events: none;\n"),vo=(0,s.styled)("input",`\n  padding: 4px 32px 4px 40px;\n  border: 1px solid ${v.theme.inputBorder};\n  border-radius: 3px;\n  background-color: ${v.theme.inputBg};\n  color: ${v.theme.inputFg};\n  width: 100%;\n  text-align: right;\n  appearance: none;\n  -moz-appearance: none;\n  -webkit-appearance: none;\n`),yo=(0,s.styled)("div","\n  position: absolute;\n  right: 8px;\n  width: 16px;\n  height: 100%;\n  display: flex;\n  flex-direction: column;\n"),_o=(0,s.styled)("div",`\n  --icon-color: ${v.theme.controlSecondaryFg};\n  flex: 1 1 0px;\n  min-height: 0px;\n  position: relative;\n  cursor: pointer;\n  overflow: hidden;\n  &:hover {\n    --icon-color: ${v.theme.controlSecondaryHoverFg};\n  }\n`),wo=(0,s.styled)(Ce.icon,"\n  position: absolute;\n  top: 0px;\n"),xo=(0,s.styled)(Ce.icon,"\n  position: absolute;\n  bottom: 0px;\n"),Co=(0,s.styled)(ue.makeButtonSelect,`\n  flex: 4 4 0px;\n  background-color: ${v.theme.inputBg};\n`),Do=(0,s.styled)(ue.makeButtonSelect,`\n  flex: 1 1 0px;\n  background-color: ${v.theme.inputBg};\n  margin-left: 16px;\n`),So=(0,V.makeT)("Reference");class ko extends Kt.D{constructor(e){super(e),this._visibleColRef=s.Computed.create(this,(e=>e(this.field.visibleColRef))),this._visibleColRef.onWrite((e=>this.field.visibleColRef.saveOnly(e))),this._validCols=s.Computed.create(this,(e=>{const t=e(e(this.field.column).refTable);return t?e(e(t.columns).getObservable()).filter((t=>!e(t.isHiddenCol))).map((t=>({label:e(t.label),value:t.getRowId(),icon:"FieldColumn",disabled:(0,x.isFullReferencingType)(e(t.type))||e(t.isTransforming)}))).concat([{label:So("Row ID"),value:0,icon:"FieldColumn"}]):[]}))}buildConfigDom(){return[this.buildTransformConfigDom(),(0,g.cssLabel)(So("CELL FORMAT")),super.buildConfigDom()]}buildTransformConfigDom(){const e=s.Computed.create(null,(e=>e(this.field.config.multiselect)));return[(0,g.cssLabel)(So("SHOW COLUMN")),(0,g.cssRow)(s.dom.autoDispose(e),(0,ce.select)(this._visibleColRef,this._validCols,{disabled:e}),(0,v.testId)("fbuilder-ref-col-select"))]}buildDom(e){const t=s.Computed.create(null,(t=>{const o=e.cells[t(this.field.colId)];return o&&t(o)})),o=s.Computed.create(null,(o=>{let[i,n]=["",!1];if(o(e._isAddRow)||this.isDisposed()||o(this.field.displayColModel).isDisposed())return{value:i,hasBlankReference:n};const s=e.cells[o(o(this.field.displayColModel).colId)];if(!s)return{value:i,hasBlankReference:n};const r=o(s);return i=(0,x.isVersions)(r)?o(this.field.formatter).formatAny(r[1].local||r[1].parent):o(this.field.formatter).formatAny(r),n=0!==t.get()&&""===i.trim(),{value:i,hasBlankReference:n}}));return Io(s.dom.autoDispose(o),s.dom.autoDispose(t),Io.cls("-blank",(e=>e(o).hasBlankReference)),s.dom.style("text-align",this.alignment),s.dom.cls("text_wrapping",this.wrapping),To("FieldReference",(0,v.testId)("ref-link-icon"),(0,v.hideInPrintView)()),s.dom.text((e=>0===e(t)?"":e(o).hasBlankReference?"[Blank]":e(o).value)))}}const To=(0,s.styled)(Ce.icon,`\n  float: left;\n  background-color: ${v.colors.slate};\n  margin: -1px 2px 2px 0;\n`),Io=(0,s.styled)("div.field_clip",`\n  &-blank {\n    color: ${v.colors.slate}\n  }\n`);var Ro=o(11104),Fo=o(6632);class Oo{constructor(e,t){this.field=e;const o=e.column().type(),i=(0,x.getReferencedTableId)(o);if(!i)throw new Error("Non-Reference column of type "+o);this.refTableId=i;const n=t.getTable(i);if(!n)throw new Error("Invalid referenced table "+i);this.tableData=n,this.visibleColFormatter=e.visibleColFormatter(),this.visibleColModel=e.visibleColModel(),this.visibleColId=this.visibleColModel.colId()||"id",this.isRefList=(0,x.isRefListType)(o)}idToText(e){return"number"==typeof e?this.visibleColFormatter.formatAny(this.tableData.getValue(e,this.visibleColId)):String(e||"")}autocompleteSearch(e){return this.tableData.columnACIndexes.getColACIndex(this.visibleColId,this.visibleColFormatter).search(e)}}function Eo(e,t,o,i){return o?Po(Po.cls("-new"),Bo($o("Plus")),e,(0,v.testId)("ref-editor-item"),(0,v.testId)("ref-editor-new-item")):Po(Po.cls("-with-new",i),(0,Ro.buildHighlightedDom)(e,t,No),(0,v.testId)("ref-editor-item"))}const Ao=(0,s.styled)("div","\n  & > .celleditor_text_editor, & > .celleditor_content_measure {\n    padding-left: 18px;\n  }\n"),Mo=(0,s.styled)("div","\n  z-index: 1001;\n  overflow-y: auto;\n  padding: 8px 0 0 0;\n  --weaseljs-menu-item-padding: 8px 16px;\n"),Po=(0,s.styled)("li",`\n  display: block;\n  font-family: ${v.vars.fontFamily};\n  white-space: pre;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  outline: none;\n  padding: var(--weaseljs-menu-item-padding, 8px 24px);\n  cursor: pointer;\n  color: ${v.theme.menuItemFg};\n\n  &.selected {\n    background-color: ${v.theme.menuItemSelectedBg};\n    color:            ${v.theme.menuItemSelectedFg};\n  }\n  &-with-new {\n    scroll-margin-bottom: 37px;\n  }\n  &-new {\n    color: ${v.theme.lightText};\n    position: sticky;\n    bottom: 0px;\n    height: 37px;\n    background-color: ${v.theme.menuBg};\n    border-top: 1px solid ${v.theme.menuBorder};\n    scroll-margin-bottom: initial;\n  }\n  &-new.selected {\n    color: ${v.theme.menuItemSelectedFg};\n  }\n`),Bo=(0,s.styled)("div",`\n  display: inline-block;\n  width: 20px;\n  height: 20px;\n  border-radius: 20px;\n  margin-right: 8px;\n  text-align: center;\n  background-color: ${v.colors.lightGreen};\n  color: ${v.colors.light};\n\n  .selected > & {\n    background-color: ${v.colors.darkGreen};\n  }\n`),$o=(0,s.styled)(Ce.icon,`\n  background-color: ${v.colors.light};\n`),Lo=(0,s.styled)(Ce.icon,`\n  background-color: ${v.colors.slate};\n  position: absolute;\n  top: 0;\n  left: 0;\n  margin: 3px 3px 0 3px;\n`),No=(0,s.styled)("span",`\n  color: ${v.theme.autocompleteMatchText};\n  .selected > & {\n    color: ${v.theme.autocompleteSelectedMatchText};\n  }\n`);var zo=o(64982);class Vo{constructor(e,t){this.text=e,this.rowId=t,this.label="number"==typeof this.rowId?String(this.rowId):this.text,this.cleanText=(0,Ro.normalizeText)(this.text)}}class Ho extends He._{constructor(e){super(e),this.options=e,this._showAddNew=!1;const t=e.gristDoc.docData;this._utils=new Oo(e.field,t);const o=this._utils.visibleColModel;this._enableAddNew=o&&!o.isRealFormula()&&!!o.colId();const n={menuCssClass:`${ce.menuCssClass} ${Mo.className}`,search:this._doSearch.bind(this),renderItem:this._renderItem.bind(this),getItemText:e=>e.text};this.commandGroup=this.autoDispose((0,i.createGroup)(e.commands,null,!0)),this._alignment=e.field.widgetOptionsJson.peek().alignment||"left";const r=(0,k.xD)(e.cellValue),l=void 0===e.editValue&&Array.isArray(r)?r:[],a=void 0===e.editValue&&!this._utils.tableData.isLoaded,c=a?[]:l.map((e=>new Vo(this._utils.idToText(e),"number"==typeof e?e:"invalid")));this._tokenField=zo.T.ctor().create(this,{initialValue:c,renderToken:e=>{const t=""===e.cleanText;return[t?"[Blank]":e.text,Wo.cls("-blank",t),xt.cssChoiceToken.cls("-invalid","invalid"===e.rowId)]},createToken:e=>new Vo(e,"invalid"),acOptions:n,openAutocompleteOnFocus:!0,readonly:e.readonly,trimLabels:!0,styles:{cssTokenField:Uo,cssToken:Wo,cssDeleteButton:Yo,cssDeleteIcon:Go}}),this._dom=(0,s.dom)("div.default_editor",s.dom.cls("readonly_editor",e.readonly),s.dom.cls(Jo.className,e.readonly),this.cellEditorDiv=jo((0,v.testId)("widget-text-editor"),this._contentSizer=Ko(),(e=>this._tokenField.attach(e))),(0,Ht.createMobileButtons)(e.commands)),this._textInput=this._tokenField.getTextInput(),s.dom.update(this._tokenField.getRootElem(),s.dom.style("justify-content",this._alignment)),s.dom.update(this._tokenField.getHiddenInput(),this.commandGroup.attach()),s.dom.update(this._textInput,s.dom.on("input",(()=>this.resizeInput(!0))),s.dom.prop("value",e.editValue||""),this.commandGroup.attach()),t.fetchTable(this._utils.refTableId).then((()=>{if(this.isDisposed())return;a&&(this._tokenField.setTokens(l.map((e=>new Vo(this._utils.idToText(e),"number"==typeof e?e:"invalid")))),this.resizeInput());const e=this._tokenField.getAutocomplete();e&&e.search()})).catch(z.reportError)}attach(e){this._editorPlacement=jt.EditorPlacement.create(this,this._dom,e,{margins:(0,Ht.getButtonMargins)()}),this.autoDispose(this._editorPlacement.onReposition.addListener((()=>this.resizeInput()))),this.autoDispose(this._tokenField.tokensObs.addListener((()=>Promise.resolve().then((()=>this.resizeInput()))))),this.setSizerLimits(),this.resizeInput(),this._textInput.focus();const t=Math.min(this.options.cursorPos,this._textInput.value.length);this._textInput.setSelectionRange(t,t)}getDom(){return this._dom}getCellValue(){const e=this._tokenField.tokensObs.get().map((e=>"number"==typeof e.rowId?e.rowId:e.text));return(0,k.Cx)(e)}getTextValue(){const e=this._tokenField.tokensObs.get().map((e=>"number"==typeof e.rowId?String(e.rowId):e.text));return(0,w.cw)(e,{prettier:!0})}getCursorPos(){return this._textInput.selectionStart||0}async prepForSave(){const e=this._tokenField.tokensObs.get(),t=e.filter((e=>"new"===e.rowId));if(0===t.length)return;const o={[this._utils.visibleColId]:t.map((e=>e.text))},i=await this._utils.tableData.sendTableAction(["BulkAddRecord",new Array(t.length).fill(null),o]);let n=0;const s=e.map((e=>"new"===e.rowId?new Vo(e.text,i[n++]):e));this._tokenField.setTokens(s)}setSizerLimits(){const e=this._tokenField.getRootElem(),t=this._editorPlacement.calcSizeWithPadding(e,{width:1/0,height:1/0},{calcOnly:!0});this._contentSizer.style.maxWidth=Math.ceil(t.width)+"px"}resizeInput(e=!1){if(this.isDisposed())return;const t=this._tokenField.getRootElem();e&&this._inputSizer||(this._contentSizer.innerHTML="",s.dom.update(this._contentSizer,s.dom.update(t.cloneNode(!0),s.dom.style("width",""),s.dom.style("height",""),this._inputSizer=qo(),s.dom.cls("test-tokenfield",!1)))),this._inputSizer.textContent=this._textInput.value+"​";const o=this._contentSizer.getBoundingClientRect(),i=this._editorPlacement.calcSizeWithPadding(t,o);t.style.width=i.width+"px",t.style.height=i.height+"px",this._textInput.style.width=this._inputSizer.getBoundingClientRect().width+"px"}async _doSearch(e){const{items:t,selectIndex:o,highlightFunc:i}=this._utils.autocompleteSearch(e),n={selectIndex:o,highlightFunc:i,items:t.map((e=>new Vo(e.text,e.rowId)))};if(this._showAddNew=!1,!this._enableAddNew||!e)return n;const s=(0,Ro.normalizeText)(e);return n.items.find((e=>e.cleanText===s))||(n.items.push(new Vo(e,"new")),this._showAddNew=!0),n}_renderItem(e,t){return Eo(e.text,t,"new"===e.rowId,this._showAddNew)}}const jo=(0,s.styled)("div",`\n  background-color: ${v.theme.cellEditorBg};\n  font-family: var(--grist-font-family-data);\n  font-size: var(--grist-medium-font-size);\n`),Uo=(0,s.styled)(zo.c.cssTokenField,"\n  border: none;\n  align-items: start;\n  align-content: start;\n  padding: 0 3px;\n  height: min-content;\n  min-height: 22px;\n  color: black;\n  flex-wrap: wrap;\n"),Wo=(0,s.styled)(zo.c.cssToken,`\n  padding: 1px 4px;\n  margin: 2px;\n  line-height: 16px;\n  white-space: pre;\n\n  &.selected {\n    box-shadow: inset 0 0 0 1px ${v.colors.lightGreen};\n  }\n\n  &-blank {\n    color: ${v.colors.slate};\n  }\n`),Yo=(0,s.styled)(zo.c.cssDeleteButton,`\n  position: absolute;\n  top: -8px;\n  right: -6px;\n  border-radius: 16px;\n  background-color: ${v.colors.dark};\n  width: 14px;\n  height: 14px;\n  cursor: pointer;\n  z-index: 1;\n  display: none;\n  align-items: center;\n  justify-content: center;\n\n  .${Wo.className}:hover & {\n    display: flex;\n  }\n  .${Uo.className}.token-dragactive & {\n    cursor: unset;\n  }\n`),Go=(0,s.styled)(zo.c.cssDeleteIcon,`\n  --icon-color: ${v.colors.light};\n  &:hover {\n    --icon-color: ${v.colors.darkGrey};\n  }\n`),Ko=(0,s.styled)("div",`\n  position: absolute;\n  left: 0;\n  top: -100px;\n  border: none;\n  visibility: hidden;\n  overflow: visible;\n  width: max-content;\n\n  & .${zo.c.cssInputWrapper.className} {\n    display: none;\n  }\n`),qo=(0,s.styled)("div","\n  flex: auto;\n  min-width: 24px;\n  margin: 3px 2px;\n"),Jo=(0,s.styled)("div","\n  padding-left: 16px;\n  background: white;\n");var Xo=o(29301);class Qo extends pe.a{_addClickEventHandler(e){return s.dom.on("click",(t=>{t.shiftKey||this.field.column().isRealFormula()||(i.allCommands.setCursor.run(e,this.field),i.allCommands.input.run(" "))}))}}const Zo={TextBox:Kt.D,TextEditor:Ut,NumericTextBox:ho,HyperLinkTextBox:qt,HyperLinkEditor:class extends Ut{constructor(e){super(e),this.textInput.setAttribute("placeholder",Wt("[link label] url"))}},Spinner:class extends ho{constructor(e){super(e);const t=this.autoDispose(Xo.computed((()=>{const{numMode:e}=this.options(),t=this.field.documentSettings();return(0,Zt.y6)({numMode:e},t).resolvedOptions()})));this._stepSize=this.autoDispose(Xo.computed((()=>{const e="percent"===this.options().numMode?2:0;return Math.pow(10,-(this.options().decimals||t().minimumFractionDigits)-e)})))}buildDom(e){const t=e.cells[this.field.colId.peek()];return s.dom.update(super.buildDom(e),s.dom.cls("widget_spinner"),ie.spinner(t,this._stepSize))}},CheckBox:class extends Qo{constructor(e,t={}){super(e,{defaultTextColor:"#606060"})}buildDom(e){const t=e.cells[this.field.colId.peek()];return(0,s.dom)("div.field_clip",(0,s.dom)("div.widget_checkbox",(0,s.dom)("div.widget_checkmark",s.dom.show(t),(0,s.dom)("div.checkmark_kick"),(0,s.dom)("div.checkmark_stem")),this._addClickEventHandler(e)))}},CheckBoxEditor:vt(),Reference:ko,Switch:class extends Qo{constructor(e,t={}){super(e,{defaultTextColor:"#2CB0AF"})}buildDom(e){const t=e.cells[this.field.colId.peek()];return(0,s.dom)("div.field_clip",(0,s.dom)("div.widget_switch",s.dom.cls("switch_on",t),s.dom.cls("switch_transition",e._isRealChange),(0,s.dom)("div.switch_slider"),(0,s.dom)("div.switch_circle"),this._addClickEventHandler(e)))}},ReferenceEditor:class extends Ut{constructor(e){super(e),this._showAddNew=!1;const t=e.gristDoc.docData;this._utils=new Oo(e.field,t);const o=this._utils.visibleColModel;this._enableAddNew=o&&!o.isRealFormula()&&!!o.colId(),e.readonly||(this.cellEditorDiv.classList.add(Ao.className),this.cellEditorDiv.appendChild(Lo("FieldReference"))),this.textInput.value=(0,C.undef)(e.state,e.editValue,this._idToText());const i=void 0===e.editValue&&!this._utils.tableData.isLoaded;t.fetchTable(this._utils.refTableId).then((()=>{this.isDisposed()||(i&&""===this.textInput.value&&(this.textInput.value=(0,C.undef)(e.state,e.editValue,this._idToText()),this.resizeInput()),this._autocomplete&&(void 0===e.editValue?this._autocomplete.search((t=>t.findIndex((t=>t.rowId===e.cellValue)))):this._autocomplete.search()))})).catch(z.reportError)}attach(e){super.attach(e),this.options.readonly||(this._autocomplete=this.autoDispose(new Fo.Autocomplete(this.textInput,{menuCssClass:ce.menuCssClass+" "+Mo.className,search:this._doSearch.bind(this),renderItem:this._renderItem.bind(this),getItemText:e=>e.text,onClick:()=>this.options.commands.fieldEditSaveHere()})))}async prepForSave(){const e=this._autocomplete&&this._autocomplete.getSelectedItem();if(e&&"new"===e.rowId&&e.text===this.textInput.value){const t={[this._utils.visibleColId]:this.textInput.value};e.rowId=await this._utils.tableData.sendTableAction(["AddRecord",null,t])}}getCellValue(){const e=this._autocomplete&&this._autocomplete.getSelectedItem();return e?e.rowId:(t=this.textInput.value,o=this._idToText(),t.trim().toLowerCase()===o.trim().toLowerCase()?this.options.cellValue:super.getCellValue());var t,o}_idToText(){return this._utils.idToText(this.options.cellValue)}async _doSearch(e){const t=this._utils.autocompleteSearch(e);if(this._showAddNew=!1,!this._enableAddNew||!e)return t;const o=(0,Ro.normalizeText)(e);return t.items.find((e=>e.cleanText===o))||(t.items.push({rowId:"new",text:e,cleanText:o}),this._showAddNew=!0),t}_renderItem(e,t){return Eo(e.text,t,"new"===e.rowId,this._showAddNew)}},ReferenceList:class extends ko{buildDom(e){return Ot(s.dom.cls("field_clip"),Ot.cls("-wrap",this.wrapping),s.dom.style("justify-content",(e=>"right"===e(this.alignment)?"flex-end":e(this.alignment))),s.dom.domComputed((t=>{if(t(e._isAddRow)||this.isDisposed()||t(this.field.displayColModel).isDisposed())return null;const o=e.cells[t(t(this.field.displayColModel).colId)];if(!o)return null;const i=t(o);if(!i)return null;const n=(0,x.isList)(i)?i.slice(1):[i],s=t(this.field.visibleColFormatter);return n.map((e=>s.formatAny(e)))}),(e=>e?e.map((e=>{const t=""===e.trim();return(0,xt.choiceToken)(t?"[Blank]":e,{textColor:t?v.colors.slate.value:void 0},s.dom.cls(Et.className),(0,v.testId)("ref-list-cell-token"))})):null)))}},ReferenceListEditor:Ho,ChoiceTextBox:wt.Rf,ChoiceEditor:_t(),ChoiceListCell:Ft,ChoiceListEditor:At.ChoiceListEditor,DateTimeTextBox:Vt(),DateTextBox:$t(),DateEditor:Pt(),AttachmentsWidget:Pe,AttachmentsEditor:Ze,DateTimeEditor:Nt()};var ei=o(54156);const ti=(0,s.makeTestId)("test-fbuilder-"),oi=(0,V.makeT)("FieldBuilder");function ii(e,t,o,i={}){return t().map((function(t){return new si(e,t,o,i)})).setAutoDisposeValues()}function ni(e,t,o){return ne.withKoUtils(Xo.computed((()=>{var i;if(e.isDisposed())return!1;const n=null==(i=t())?void 0:i.style;return(null==n?void 0:n[o])||e.field[o]()}))).onlyNotifyUnequal()}class si extends s.Disposable{constructor(e,t,o,i={}){super(),this.gristDoc=e,this.field=t,this._cursor=o,this._options=i,this._isEditorActive=s.Observable.create(this,!1),this._docModel=e.docModel,this.origColumn=t.origCol(),this.options=t.widgetOptionsJson,this._comments=Xo.pureComputed((()=>(0,s.toKo)(Xo,(0,ae.COMMENTS)())())),this._readOnlyPureType=Xo.pureComputed((()=>this.field.column().pureType())),this._readonly=s.Computed.create(this,(o=>o(e.isReadonly)||o(t.disableEditData)||Boolean(this._options.isPreview))),this._availableTypes=s.Computed.create(this,(e=>{const t=e(this.origColumn.isFormula),o=[];return ei.each(_e.UD,((e,i)=>{const n={value:i,label:e.label,icon:e.icon};"Any"===i&&(n.disabled=!t),o.push(n)})),o})),this._isRightType=Xo.pureComputed((()=>x.isRightType(this._readOnlyPureType())||ei.constant(!1))),this._isRef=this.autoDispose(Xo.computed((()=>{const e=this.field.column().type();return"Attachments"!==e&&(0,x.isFullReferencingType)(e)}))),this._refTableId=this.autoDispose(Xo.computed({read:()=>(0,x.getReferencedTableId)(this.field.column().type()),write:e=>{this.field.column().type().startsWith("Ref:")?this._setType(`Ref:${e}`):this._setType(`RefList:${e}`)}})),this.widget=Xo.pureComputed((()=>this.field.widget())),this.isCallPending=Xo.observable(!1),this.columnTransform=null,this._isTransformingFormula=this.autoDispose(Xo.computed((()=>this.field.column().isTransforming()&&this.columnTransform instanceof y))),this._isTransformingType=this.autoDispose(Xo.computed((()=>(this.field.column().isTransforming()||this.isCallPending())&&this.columnTransform instanceof X))),this._rowMap=new Map,this._widgetCons=this.autoDispose(ne.withKoUtils(Xo.computed((()=>function(e,t){const{config:o}=(0,_e.Tb)(e,t);return Zo[o.cons]}(this.options().widget,this._readOnlyPureType())))).onlyNotifyUnequal()),this.widgetImpl=this.autoDispose(ne.computedBuilder((()=>{const e=this._widgetCons();return e.create.bind(e,this.field,this.field.colId())}),this).extend({deferred:!0})),this.diffImpl=this.autoDispose(me.create(this.field)),this._showRefConfigPopup=Xo.observable(!1)}buildSelectWidgetDom(){return s.dom.maybe((e=>!e(this._isTransformingType)&&e(this._readOnlyPureType)),(e=>{const t=function(e){return e&&_e.UD[e]||_e.UD.Text}(e).widgets,o=Object.keys(t).map((e=>({label:e,value:e,icon:t[e].icon})));if(o.length<=1)return null;const i=s.Computed.create(null,(e=>{if(!(o.length<=2))return e(this.field.config.widget)}));i.onWrite((e=>this.field.config.widget(e)));const n=s.Computed.create(null,(e=>!e(this.field.config.sameWidgets)));return[(0,g.cssLabel)(oi("CELL FORMAT")),(0,g.cssRow)(s.dom.autoDispose(i),o.length<=2?(0,ue.buttonSelect)((0,s.fromKo)(this.field.config.widget),o,ue.cssButtonSelect.cls("-disabled",n)):(0,ce.select)(i,o,{disabled:n,defaultLabel:oi("Mixed format")}),ti("widget-select"))]}))}buildSelectTypeDom(){const e=new s.MultiHolder,t=s.Computed.create(e,(e=>e(e(this.field.viewSection).columnsType))),o=s.Computed.create(e,(e=>{const o=e((0,s.fromKo)(this._readOnlyPureType));return"mixed"===e(t)?"":o}));o.onWrite((e=>{if(e!==this._readOnlyPureType.peek()||"mixed"===t.get())return["Ref","RefList"].includes(e)&&this._showRefConfigPopup(!0),this._setType(e)}));const i=()=>this.isDisposed()||o.set(this.field.column().pureType()),n=s.Computed.create(e,(e=>e(e(this.field.viewSection).columnsAllIsFormula)));return[(0,g.cssRow)(s.dom.autoDispose(e),(0,ce.select)(o,this._availableTypes,{disabled:e=>e(this._isTransformingFormula)||e(this.origColumn.disableModifyBase)||e(this.field.config.multiselect)&&!e(n)||e(this.isCallPending),menuCssClass:ri.className,defaultLabel:oi("Mixed types"),renderOptionArgs:e=>{if(!["Ref","RefList"].includes(o.get()))return"Reference"===e.label?this.gristDoc.behavioralPromptsManager.attachTip("referenceColumns",{popupOptions:{attach:`.${ri.className}`,placement:"left-start"}}):null}}),ti("type-select"),s.dom.cls("tour-type-selector"),s.dom.cls(g.cssBlockedCursor.className,(e=>e(this.origColumn.disableModifyBase)||e(this.field.config.multiselect)&&!e(n)))),s.dom.maybe((e=>e(this._isRef)&&!e(this._isTransformingType)),(()=>this._buildRefTableSelect())),s.dom.maybe(this._isTransformingType,(()=>te()("div.type_transform_prompt",ie.prompt(te()("div",s.dom.maybe(this._isRef,(()=>this._buildRefTableSelect())),s.dom.maybe((e=>e(this.field.column().isTransforming)),(()=>this.columnTransform.buildDom())))),s.dom.onDispose(i))))]}_setType(e){if(this.origColumn.isFormula()){const t=this.field.column(),o=B(e,t,this._docModel);if(this.field.viewSection.peek().selectedFields.peek().length>1&&["formula","empty"].indexOf(this.field.viewSection.peek().columnsBehavior.peek()))return this.gristDoc.docData.bundleActions(oi("Changing multiple column types"),(()=>Promise.all(this.field.viewSection.peek().selectedFields.peek().map((e=>e.column.peek().type.setAndSave(o)))))).catch(se.eK);t.type.setAndSave(o).catch(se.eK)}else{if(!this.columnTransform)return this.columnTransform=X.create(null,this.gristDoc,this),this.columnTransform.prepare(e);if(this.columnTransform instanceof X)return this.columnTransform.setType(e)}}_buildRefTableSelect(){const e=s.Computed.create(null,(e=>e(this._docModel.visibleTables.getObservable()).map((t=>({value:e(t.tableId),label:e(t.tableNameDef),icon:"FieldTable"}))))),t=s.Computed.create(null,(e=>e(this.origColumn.disableModifyBase)||e(this.field.config.multiselect)));return[(0,g.cssLabel)(oi("DATA FROM TABLE"),this._showRefConfigPopup.peek()?this.gristDoc.behavioralPromptsManager.attachTip("referenceColumnsConfig",{onDispose:()=>this._showRefConfigPopup(!1),popupOptions:{placement:"left-start"}}):null),(0,g.cssRow)(te().autoDispose(e),te().autoDispose(t),(0,ce.select)((0,s.fromKo)(this._refTableId),e,{disabled:t}),ti("ref-table-select"))]}buildTransformDom(){const e=Xo.computed({read:()=>this.field.column().isTransforming(),write:e=>e?(this.columnTransform=y.create(null,this.gristDoc,this),this.columnTransform.prepare()):this.columnTransform&&this.columnTransform.cancel()});return te()("div",te().autoDispose(e),te().onDispose((()=>{this.columnTransform&&this.columnTransform.finalize().catch(se.eK)})),ie.row(15,ie.label(oi("Apply Formula to Data")),3,ie.buttonGroup(ie.checkButton(e,te()("span.glyphicon.glyphicon-flash"),te().testId("FieldBuilder_editTransform"),ti("edit-transform"),oe.toggleClass("disabled",(()=>this._isTransformingType()||this.origColumn.isFormula()||this.origColumn.disableModifyBase()))))),oe.maybe(this._isTransformingFormula,(()=>this.columnTransform.buildDom())))}buildConfigDom(){return te()("div",oe.maybe((()=>!this._isTransformingType()&&this.widgetImpl()),(e=>te()("div",e.buildConfigDom(),li()))))}buildColorConfigDom(){return te()("div",oe.maybe((()=>!this._isTransformingType()&&this.widgetImpl()),(e=>te()("div",e.buildColorConfigDom(this.gristDoc)))))}buildSettingOptions(){return te()("div",oe.maybe((()=>!this._isTransformingType()&&this.widgetImpl()),(e=>te()("div",oe.maybe((()=>this.origColumn.viewFields().all().length>1),(()=>te()("div.fieldbuilder_settings",ie.row(oe.toggleClass("fieldbuilder_settings_header",!0),ie.label(te()("div.fieldbuilder_settings_button",te().testId("FieldBuilder_settings"),oe.text((()=>this.field.useColOptions()?"Common":"Separate"))," ▾",(0,ce.menu)((()=>{return e=this.field.useColOptions(),t=this.field.viewSection().isRaw(),o={useSeparate:()=>this.fieldSettingsUseSeparate(),saveAsCommon:()=>this.fieldSettingsSaveAsCommon(),revertToCommon:()=>this.fieldSettingsRevertToCommon()},e=e||t,[(0,ce.menuSubHeader)(de(e?"Using common settings":"Using separate settings")),e?(0,ce.menuItem)(o.useSeparate,de("Use separate settings"),s.dom.cls("disabled",t)):[(0,ce.menuItem)(o.saveAsCommon,de("Save as common settings")),(0,ce.menuItem)(o.revertToCommon,de("Revert to common settings"))]];var e,t,o}))),"Field in ",oe.text((()=>this.origColumn.viewFields().all().length))," views")))))))))}fieldSettingsUseSeparate(){return this.gristDoc.docData.bundleActions(oi("Use separate field settings for {{colId}}",{colId:this.origColumn.colId()}),(()=>Promise.all([(0,re.setSaveValue)(this.field.widgetOptions,this.field.column().widgetOptions()),(0,re.setSaveValue)(this.field.visibleCol,this.field.column().visibleCol()),this.field.saveDisplayFormula(this.field.column()._displayColModel().formula()||"")])))}fieldSettingsSaveAsCommon(){return this.gristDoc.docData.bundleActions(oi("Save field settings for {{colId}} as common",{colId:this.origColumn.colId()}),(()=>Promise.all([(0,re.setSaveValue)(this.field.column().widgetOptions,this.field.widgetOptions()),(0,re.setSaveValue)(this.field.column().visibleCol,this.field.visibleCol()),this.field.column().saveDisplayFormula(this.field._displayColModel().formula()||""),(0,re.setSaveValue)(this.field.widgetOptions,""),(0,re.setSaveValue)(this.field.visibleCol,0),this.field.saveDisplayFormula("")])))}fieldSettingsRevertToCommon(){return this.gristDoc.docData.bundleActions(oi("Revert field settings for {{colId}} to common",{colId:this.origColumn.colId()}),(()=>Promise.all([(0,re.setSaveValue)(this.field.widgetOptions,""),(0,re.setSaveValue)(this.field.visibleCol,0),this.field.saveDisplayFormula("")])))}buildDomWithCursor(e,t,o){const i=ne.withKoUtils(Xo.pureComputed((()=>this.field.rulesColsIds().map((t=>{var o,i,n;return null!=(n=null==(i=(o=e.cells)[t])?void 0:i.call(o))&&n}))),this).extend({deferred:!0})),n=ne.withKoUtils(Xo.pureComputed((()=>{if(this.isDisposed())return null;if(e._isAddRow()||!e.id())return null;const t=this.field.rulesStyles();if(!Array.isArray(t)||0===t.length)return null;const o=i();if(t.length<o.length)return;const n=o.some((e=>!x.isValidRuleValue(e)));return n?{error:n}:{style:new le.CombinedStyle(t,o)}}),this).extend({deferred:!0})).previousOnUndefined(),r=ne.withKoUtils(Xo.computed((()=>{if(this.isDisposed())return null;const t=e.cells[this.field.colId()],o=t&&t();return t&&this._isRightType()(o,this.options)||e._isAddRow.peek()?this.widgetImpl():x.isVersions(o)?this.diffImpl:null})).extend({deferred:!0})).onlyNotifyUnequal(),l=ne.withKoUtils(Xo.computed((()=>{var e,t;return this.isDisposed()?null:(null==(t=null==(e=n())?void 0:e.style)?void 0:t.textColor)||""}))).onlyNotifyUnequal(),a=ne.withKoUtils(Xo.computed((()=>{var e,t;return this.isDisposed()?null:ai((null==(t=null==(e=n())?void 0:e.style)?void 0:t.fillColor)||"")}))).onlyNotifyUnequal(),c=ni(this,n,"fontBold"),d=ni(this,n,"fontItalic"),u=ni(this,n,"fontUnderline"),p=ni(this,n,"fontStrikethrough"),h=Xo.pureComputed((()=>{var e;return Boolean(null==(e=n())?void 0:e.error)})),m=Xo.pureComputed((()=>this.field.textColor()||"")),f=Xo.pureComputed((()=>ai(this.field.fillColor()||""))),g=ne.withKoUtils(Xo.computed((()=>{if(this.isDisposed())return!1;if(!this._comments())return!1;if(this.gristDoc.isReadonlyKo())return!1;const t=e.id(),o=this.field.column().cells().all().find((e=>e.rowId()===t&&!e.resolved()&&e.type()===x.CellInfoType.COMMENT&&!e.hidden()&&e.root()));return Boolean(o)})).extend({deferred:!0})).onlyNotifyUnequal(),b=new s.MultiHolder;return b.autoDispose(g),b.autoDispose(r),b.autoDispose(i),b.autoDispose(h),b.autoDispose(m),b.autoDispose(f),b.autoDispose(n),b.autoDispose(c),b.autoDispose(d),b.autoDispose(u),b.autoDispose(p),i=>{this._rowMap.set(e,i),te()(i,te().autoDispose(b),oe.style("--grist-cell-color",m),oe.style("--grist-cell-background-color",f),oe.style("--grist-rule-color",l),oe.style("--grist-column-rule-background-color",a),this._options.isPreview?null:oe.cssClass(this.field.formulaCssClass),oe.toggleClass("field-with-comments",g),oe.maybe(g,(()=>te()("div.field-comment-indicator"))),oe.toggleClass("readonly",(0,s.toKo)(Xo,this._readonly)),oe.maybe(o,(()=>te()("div.selected_cursor",oe.toggleClass("active_cursor",t)))),oe.scope(r,(o=>{if(this.isDisposed())return null;const i=o?o.buildDom(e):function(e,t){const o=e.cells[t.colId.peek()],i=t.widgetOptionsJson;return(0,s.dom)("div.field_clip.invalid",s.dom.clsPrefix("field-error-",(e=>(0,x.getObjCode)(e(o))||"")),s.dom.style("text-align",i.prop("alignment")),s.dom.cls("text_wrapping",(e=>Boolean(e(i.prop("wrap"))))),s.dom.text((e=>(0,ge.cT)(o?e(o):"???"))))}(e,this.field);return te()(i,oe.toggleClass("has_cursor",t),oe.toggleClass("field-error-from-style",h),oe.toggleClass("font-bold",c),oe.toggleClass("font-underline",u),oe.toggleClass("font-italic",d),oe.toggleClass("font-strikethrough",p))})))}}buildEditorDom(e,t,o){if(this.columnTransform)return void this.columnTransform.finalize().catch(se.eK);const i=this.gristDoc.fieldEditorHolder,n=()=>this.isEditorActive()&&i.clear(),s=e.cells[this.field.colId()],r=s&&s();if(x.isCensored(r)&&!this.origColumn.isFormula.peek())return n();const l=function(e,t){const{config:o}=(0,_e.Tb)(e,t);return Zo[o.editCons]}(this.options().widget,this._readOnlyPureType());if(!l)return n();if(this._readonly.get()&&l.supportsReadonly&&!l.supportsReadonly())return n();if(!this._readonly.get()&&(0,be.qw)(l,e,this.field,o.init))return n();const a=this._rowMap.get(t),c=be.P1.create(i,{gristDoc:this.gristDoc,field:this.field,cursor:this._cursor,editRow:e,cellElem:a,editorCtor:l,state:o.state,startVal:this._readonly.get()?void 0:o.init,readonly:this._readonly.get()});this._isEditorActive.set(!0),c.onDispose((()=>{this._isEditorActive.set(!1),this.gristDoc.activeEditor.set(null)})),this.gristDoc.activeEditor.set(c)}buildDiscussionPopup(e,t,o){const i=this.gristDoc.fieldEditorHolder,n=this._rowMap.get(t);if(this.columnTransform)return void this.columnTransform.finalize().catch(se.eK);if(e._isAddRow.peek()||this._readonly.get())return;const r=this.gristDoc.fieldEditorHolder,l=e.cells[this.field.colId()],a=l&&l();if(x.isCensored(a))return void r.clear();const c=this.field.viewSection.peek().tableRef.peek(),d=s.MultiHolder.create(i),u=ve.c8.create(d,{gristDoc:this.gristDoc,tableRef:c,column:this.field.column.peek(),rowId:e.id.peek()});ve.XY.create(d,{domEl:n,topic:u,discussionId:o,gristDoc:this.gristDoc,closeClicked:()=>i.clear()})}isEditorActive(){return!this.gristDoc.fieldEditorHolder.isEmpty()&&this._isEditorActive.get()}openSideFormulaEditor(e){const{editRow:t,refElem:o,canDetach:i,editValue:n,onSave:r,onCancel:l}=e,a=this.gristDoc.cursorPosition.get(),c={attach:async e=>{o.isConnected?u.attach(o):(u.dispose(),s.dom.domDispose(e),await this.gristDoc.recursiveMoveToCursorPos(a,!0))},detach:()=>u.detach(),autoDispose:e=>u.autoDispose(e),dispose(){u.dispose()}},d=this.gristDoc.docModel.viewFields.getRowModel(this.field.getRowId()),u=(0,ye.Ex)({gristDoc:this.gristDoc,field:d,editingFormula:this.field.editingFormula,setupCleanup:function(e,t,o,i){const n=()=>p.active.get()?void 0:i().catch(se.eK);Z.LV.create(e,(async()=>{await n()})),t.app.on("clipboard_focus",n),e.onDispose((()=>{t.app.off("clipboard_focus",n),o(!1)}))},editRow:t,refElem:o,editValue:n,canDetach:i,onSave:r,onCancel:l}),p=Q.k.create(u,c,{gristDoc:this.gristDoc,refElem:o,placement:"overlapping"});this.gristDoc.fieldEditorHolder.autoDispose(u)}}const ri=(0,s.styled)("div","\n  max-height: 500px;\n"),li=(0,s.styled)("div",`\n  border-bottom: 1px solid ${v.theme.pagePanelsBorder};\n  margin-top: 16px;\n`);function ai(e){return e?e.startsWith("#")&&9===e.length?e.substring(0,7):e.startsWith("rgba")?e.replace(/^rgba\((\d+)[,\s]+(\d+)[,\s]+(\d+)[/,\s]+([\d.%]+)\)$/i,"rgb($1, $2, $3)"):e:e}},49506:(e,t,o)=>{"use strict";o.d(t,{P1:()=>x,qw:()=>_,Sf:()=>C});var i=o(77709),n=o(7935),s=o(70387),r=o(92769),l=o(8881),a=o(29922),c=o(7454),d=o(4425),u=o(1310);const p=(0,s.makeT)("EditorTooltip"),h=(0,u.styled)("div",`\n  display: flex;\n  align-items: center;\n  --icon-color: ${a.colors.lightGreen};\n\n  & > .${d.Y3.className} {\n    margin-left: 8px;\n  }\n`);var m=o(97767),f=o(48517),g=o(83277),b=o(26475);const v=o(36812),y=(0,s.makeT)("FieldEditor");function _(e,t,o,i){if(!o.column.peek().isRealFormula.peek()&&e.skipEditor){const n=t.cells[o.colId()].peek(),s=e.skipEditor(i,n);if(void 0!==s)return w(t,o,s).catch(r.reportError),!0}return!1}async function w(e,t,o){const i=e.cells[t.colId()];if(!v(o,i.peek()))return i.setAndSave(o)}class x extends u.Disposable{constructor(e){super(),this.saveEmitter=this.autoDispose(new u.Emitter),this.cancelEmitter=this.autoDispose(new u.Emitter),this.changeEmitter=this.autoDispose(new u.Emitter),this._editorHolder=u.Holder.create(this),this._saveEdit=(0,f.tJ)((()=>this._doSaveEdit())),this._editorHasChanged=!1,this._isFormula=!1,this._readonly=!1,this._detached=u.Observable.create(this,!1),this._detachedAt=null,this._gristDoc=e.gristDoc,this._field=e.field,this._cursor=e.cursor,this._editRow=e.editRow,this._editorCtor=e.editorCtor,this._cellElem=e.cellElem,this._readonly=e.readonly;const t=e.startVal;let o=!1;const n=this._field.column();this._isFormula=n.isRealFormula.peek();let s=t;!e.readonly&&t&&g.startsWith(t,"=")&&(this._isFormula||this._field.column().isEmpty()?(this._isFormula=!0,s=g.removePrefix(t,"=")):o=!0),this._editCommands={fieldEditSave:()=>{this._saveEdit().then((e=>{e||i.allCommands.fieldEditSave.run()})).catch(r.reportError)},fieldEditSaveHere:()=>{this._saveEdit().catch(r.reportError)},fieldEditCancel:()=>{this._cancelEdit()},prevField:()=>{this._saveEdit().then(i.allCommands.prevField.run).catch(r.reportError)},nextField:()=>{this._saveEdit().then(i.allCommands.nextField.run).catch(r.reportError)},makeFormula:()=>this._makeFormula(),unmakeFormula:()=>this._unmakeFormula()},e.readonly&&(this._editCommands.fieldEditSave=()=>{this._editCommands.fieldEditCancel(),i.allCommands.fieldEditSave.run()},this._editCommands.fieldEditSaveHere=this._editCommands.fieldEditCancel,this._editCommands.prevField=()=>{this._cancelEdit(),i.allCommands.prevField.run()},this._editCommands.nextField=()=>{this._cancelEdit(),i.allCommands.nextField.run()},this._editCommands.makeFormula=()=>!0,this._editCommands.unmakeFormula=()=>!0),this.rebuildEditor(s,Number.POSITIVE_INFINITY,e.state),this.floatingEditor=b.k.create(this,this,{gristDoc:this._gristDoc,refElem:this._cellElem,placement:"adjacent"}),o&&this._offerToMakeFormula(),this._gristDoc.editorMonitor.monitorEditor(this);var l,a,c;e.readonly?(this,l=this._gristDoc,a=this._field,c=()=>this._cancelEdit(),l.app.on("clipboard_focus",c),this.onDispose((()=>{a.editingFormula(!1),l.app.off("clipboard_focus",c)}))):C(this,this._gristDoc,this._field.editingFormula,(async()=>{this._detached.get()||await this._saveEdit()}))}rebuildEditor(e,t,o){const i=this._isFormula?m.tC:this._editorCtor,n=this._field.column(),s=this._editRow.cells[this._field.colId()].peek();let r;r=n.isFormula()?n.formula():Array.isArray(s)&&"C"===s[0]?"":s;const l=new u.MultiHolder,a=(0,m.Nk)(l,{gristDoc:this._gristDoc,editRow:this._editRow,field:this._field});if(!this._readonly){const t=this._isFormula&&void 0!==e;this._field.editingFormula(t)}this._detached.set(!1),this._editorHasChanged=!1;const c=this._editorHolder.autoDispose(i.create({gristDoc:this._gristDoc,field:this._field,column:this._field.column(),editingFormula:this._field.editingFormula,cellValue:r,rowId:this._editRow.id(),formulaError:a,editValue:e,cursorPos:t,state:o,canDetach:!0,commands:this._editCommands,readonly:this._readonly}));c.autoDispose(l),c.editorState&&c.autoDispose(c.editorState.addListener((e=>{this._editorHasChanged=!0;const t={position:this.cellPosition(),wasModified:this._editorHasChanged,currentState:e,type:this._field.column.peek().pureType.peek()};this.changeEmitter.emit(t)}))),c.attach(this._cellElem)}detach(){return this._detached.set(!0),this._detachedAt=this._gristDoc.cursorPosition.get(),this._editorHolder.get().detach()}async attach(e){var t;if(!this._cellElem.isConnected)return u.dom.domDispose(e),await this._gristDoc.recursiveMoveToCursorPos(this._detachedAt,!0)&&await this._gristDoc.activateEditorAtCursor(),void this.dispose();this._detached.set(!1),null==(t=this._editorHolder.get())||t.attach(this._cellElem),this._field.viewSection.peek().hasFocus(!0)}getDom(){var e;return null==(e=this._editorHolder.get())?void 0:e.getDom()}cellPosition(){return{rowId:this._editRow.getRowId(),colRef:this._field.column.peek().origColRef.peek(),sectionId:this._field.viewSection.peek().id.peek()}}_makeFormula(){const e=this._editorHolder.get();if(e&&!this._field.editingFormula.peek()&&0===e.getCursorPos()){if(this._field.column().isEmpty())return this._isFormula=!0,this.rebuildEditor(e.getTextValue(),0),!1;this._offerToMakeFormula()}return!0}_unmakeFormula(){const e=this._editorHolder.get();return!(!(e instanceof m.tC&&e.isDetached.get())&&e&&this._field.editingFormula.peek()&&0===e.getCursorPos()&&!this._field.column().isRealFormula()&&(this._isFormula=!1,this.rebuildEditor("="+e.getTextValue(),1),1))}_offerToMakeFormula(){var e;const t=null==(e=this._editorHolder.get())?void 0:e.getDom();t&&function(e,t){const o=(0,l.showTooltip)(e,(function(e){return h((0,c.icon)("Convert"),(0,d.Y3)(p("Convert column to formula"),u.dom.on("mousedown",(e=>{e.preventDefault(),t()})),(0,a.testId)("editor-tooltip-convert")),(0,l.tooltipCloseButton)(e))}),{key:"col-to-formula"});u.dom.onDisposeElem(e,o.close);const i=u.dom.onElem(e,"keydown",(()=>{i.dispose(),o.close()}))}(t,(()=>this._convertEditorToFormula()))}_convertEditorToFormula(){const e=this._editorHolder.get();if(e){const t=e.getTextValue(),o=t.startsWith("=")?t.slice(1):t;this._isFormula=!0,this.rebuildEditor(o,0)}}_cancelEdit(){var e,t;if(this.isDisposed())return;const o={position:this.cellPosition(),wasModified:this._editorHasChanged,currentState:null==(t=null==(e=this._editorHolder.get())?void 0:e.editorState)?void 0:t.get(),type:this._field.column.peek().pureType.peek()};this.cancelEmitter.emit(o),this.dispose()}async _doSaveEdit(){var e,t,o;const i=this._editorHolder.get();if(!i)return!1;const n=this._cursor.rowIndex();if(await i.prepForSave(),this.isDisposed())return console.warn(y("Unable to finish saving edited cell")),!1;const s=this._field.editingFormula(),r=this._field.column();let l=null;if(s){const t=String(null!=(e=i.getCellValue())?e:"");s===r.isFormula.peek()&&t===r.formula.peek()||(l=this._gristDoc.docData.bundleActions(null,(()=>Promise.all([r.updateColValues({isFormula:s,formula:t}),!this._detached.get()&&this._editRow._isAddRow.peek()&&""!==t?this._editRow.updateColValues({}):void 0]))))}else{const e=i.getCellValue();r.isRealFormula()?console.warn(y("It should be impossible to save a plain data value into a formula column")):l=w(this._editRow,this._field,e)}const a={position:this.cellPosition(),wasModified:this._editorHasChanged,currentState:null==(o=null==(t=this._editorHolder.get())?void 0:t.editorState)?void 0:o.get(),type:this._field.column.peek().pureType.peek()};this.saveEmitter.emit(a);const c=this._cursor;return this.dispose(),await l,s||n!==c.rowIndex()}}function C(e,t,o,i){const s=()=>i().catch(r.reportError);t.app.on("clipboard_focus",s),n.LV.create(e,(async()=>{await s()})),e.onDispose((()=>{t.app.off("clipboard_focus",s),o(!1)}))}},26475:(e,t,o)=>{"use strict";o.d(t,{A:()=>f,k:()=>m});var i,n=o(77709),s=o(81294),r=o(29813),l=o(70387),a=o(63561),c=o(29922),d=o(7454),u=o(1310);const p=(0,l.makeT)("FloatingEditor"),h=(0,u.makeTestId)("test-floating-editor-");class m extends u.Disposable{constructor(e,t){super(),this._fieldEditor=e,this._options=t,this.active=u.Observable.create(this,!1),this._gristDoc=this._options.gristDoc,this._placement=null!=(i=this._options.placement)?i:"fixed",this._refElem=this._options.refElem,this.autoDispose(n.createGroup({detachEditor:this.createPopup.bind(this)},this,!0))}createPopup(){const e=this._fieldEditor,t=u.Holder.create(e),o=new u.MultiHolder;try{r.FocusLayer.create(o,{defaultFocusElem:document.activeElement});const i=this._gristDoc.cursorPosition.get(),n=this._gristDoc.docModel.viewSections.getRowModel(i.sectionId),l=`${n.tableId.peek()}.${n.viewFields.peek().at(i.fieldIndex).label.peek()}`;let c;const d=a.X$.create(t,{content:()=>c=e.detach(),title:()=>l,closeButton:!0,closeButtonIcon:"Minimize",closeButtonHover:()=>p("Collapse Editor"),onClose:async()=>{const o=r.FocusLayer.create(null,{defaultFocusElem:document.activeElement});try{(0,s.detachNode)(c),t.dispose(),await e.attach(c)}finally{o.dispose()}},minHeight:550,initialPosition:this._getInitialPosition(),args:[h("popup")]});this.active.set(!0),d.onDispose((()=>{this.active.set(!1)})),d.showPopup()}finally{o.dispose()}}_getInitialPosition(){if(!this._refElem||"fixed"===this._placement)return;const e=this._refElem.getBoundingClientRect();return"overlapping"===this._placement?[e.left,e.top]:window.innerWidth-e.right>=a.Sq?[e.right,e.top]:[e.left-a.Sq,e.top]}}function f(...e){return b(g("Maximize"),u.dom.on("click",(e=>{e.stopPropagation(),e.preventDefault(),n.allCommands.detachEditor.run()})),u.dom.on("mousedown",(e=>{e.preventDefault(),e.stopPropagation()})),h("detach-button"),...e)}const g=(0,u.styled)(d.icon,"\n  width: 14px;\n  height: 14px;\n"),b=(0,u.styled)("div",`\n  position: absolute;\n  right: -2px;\n  top: -20px;\n  line-height: 0px;\n  cursor: pointer;\n  z-index: 10;\n  --icon-color: ${c.theme.cellBg};\n  background: var(--grist-theme-control-primary-bg, var(--grist-primary-fg));\n  height: 20px;\n  width: 21px;\n  --icon-color: white;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  line-height: 0px;\n  border-top-left-radius: 4px;\n  border-top-right-radius: 4px;\n  &:hover {\n    background: var(--grist-theme-control-primary-hover-bg, var(--grist-primary-fg-hover))\n  }\n  & > div {\n    transition: background .05s ease-in-out;\n  }\n`)},97767:(e,t,o)=>{"use strict";o.d(t,{tC:()=>et,Ue:()=>nt,So:()=>rt,Nk:()=>ot,Ex:()=>tt});var i,n,s,r,l=o(87056),a=o(77709),c=o(70387),d=o(92769),u=o(36258),p=o(8881),h=o(11187),m=o(29922),f=o(7454),g=o(16151),b=o(41880),v=o(26475),y=o(13998),_=o(76961),w=o(62808),x=o(77561),C=o(3988),D=o(85050),S=o(73181),k=o(60321),T=o(18222),I=o(4425),R=o(99002),F=o(1370),O=o(79003),E=o(49668),A=o(64978),M=o(36322),P=o(1310),B=o(88466),$=o.n(B),L=o(78870),N=o.n(L),z=o(34925),V=o(2877),H=Object.defineProperty,j=Object.defineProperties,U=Object.getOwnPropertyDescriptors,W=Object.getOwnPropertySymbols,Y=Object.prototype.hasOwnProperty,G=Object.prototype.propertyIsEnumerable,K=(e,t,o)=>t in e?H(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,q=(e,t)=>{for(var o in t||(t={}))Y.call(t,o)&&K(e,o,t[o]);if(W)for(var o of W(t))G.call(t,o)&&K(e,o,t[o]);return e},J=(e,t)=>j(e,U(t));const X=(0,c.makeT)("FormulaEditor"),Q=(0,P.makeTestId)("test-formula-editor-");class Z extends P.Disposable{constructor(e){if(super(),this._options=e,this._gristDoc=this._options.gristDoc,this._appModel=this._gristDoc.appModel,this._userInput=P.Observable.create(this,""),this._assistantExpanded=this.autoDispose((0,_.pD)(`u:${null!=(n=null==(i=this._appModel.currentUser)?void 0:i.id)?n:0};formulaAssistantExpanded`,!0)),this._waiting=P.Observable.create(this,!1),this._triggerFinalize=N(),this._action="close",this._chatPanelBodyClientHeight=P.Observable.create(this,0),this._hasExpandedOnce=!1,this._isResizing=P.Observable.create(this,!1),this._showApproachingLimitBanner=this.autoDispose((0,_.$P)(`org:${null!=(r=null==(s=this._appModel.currentOrg)?void 0:s.id)?r:0};formulaAssistantShowApproachingLimitBanner`,!0)),this._numRemainingCredits=P.Observable.create(this,null),this._resizeEditor=$()((()=>{this.isDisposed()||this._options.editor.resize()}),10),this._assistantEnabled=(0,u.HAS_FORMULA_ASSISTANT)(),!this._options.field)throw new Error("Formula assistant requires a field to be passed.");this._chat=ee.create(this,J(q({},this._options),{apply:this._apply.bind(this),logTelemetryEvent:this._logTelemetryEvent.bind(this)})),this.autoDispose(a.createGroup({activateAssistant:()=>{this._expandChatPanel(),setTimeout((()=>{this._focusChatInput()}),0)}},this,!0));const t=new ResizeObserver(this._resizeEditor);t.observe(this._options.editor.getDom()),this.onDispose((()=>t.disconnect()));const o=this._options.gristDoc.docData.startBundlingActions({description:"Formula Editor",prepare:()=>this._preparePreview(),finalize:()=>this._cleanupPreview(),shouldIncludeInBundle:e=>{if(1!==e.length)return!1;const t=e[0][0];if("ModifyColumn"===t){const t=this._options.column.table.peek().tableId.peek();return e[0][1]===t&&"string"==typeof e[0][2]&&[this._transformColId,this._options.column.id.peek()].includes(e[0][2])}return"UpdateRecord"===t&&"_grist_Tables_column"===e[0][1]&&e[0][2]===this._transformColRef}});this._triggerFinalize=o.triggerFinalize,this.onDispose((()=>{this._hasExpandedOnce&&this._logTelemetryEvent("assistantClose",!1,{suggestionApplied:this._chat.conversationSuggestedFormulas.get().includes(this._options.column.formula.peek()),conversationLength:this._chat.conversationLength.get(),conversationHistoryLength:this._chat.conversationHistoryLength.get()}),this._triggerFinalize()}))}buildDom(){const e=new ResizeObserver(this._resizeEditor);return this._domElement=ke((t=>e.observe(t)),P.dom.onDispose((()=>e.disconnect())),Se((0,h.basicButton)(X("Cancel"),P.dom.on("click",(()=>{this._cancel()})),Q("cancel-button")),(0,h.basicButton)(X("Preview"),P.dom.on("click",(async()=>{await this._preview()})),Q("preview-button")),(0,h.primaryButton)(X("Save"),P.dom.on("click",(()=>{this._saveOrClose()})),Q("save-button"))),this._buildChatPanel()),this._assistantEnabled&&(this._assistantExpanded.get()?this._chatPanelBody.style.setProperty("height","999px"):this._chatPanelBody.style.setProperty("height","0px")),this._assistantEnabled&&this._assistantExpanded.get()&&(this._logTelemetryEvent("assistantOpen",!0),this._hasExpandedOnce=!0),this._domElement}_buildChatPanel(){return P.dom.maybe(this._assistantEnabled,(()=>le(pe((0,w.S)({onStart:this._onResizeStart.bind(this),onMove:this._onResizeMove.bind(this),onEnd:this._onResizeEnd.bind(this)}),pe.cls("-collapsed",(e=>!e(this._assistantExpanded)))),this._buildChatPanelHeader(),this._buildChatPanelBody())))}_logTelemetryEvent(e,t=!1,o={}){(0,x.C)(e,{full:q(q({docIdDigest:this._gristDoc.docId,conversationId:this._chat.conversationId.get()},t?{context:{type:"formula",tableId:this._options.column.table.peek().tableId.peek(),colId:this._options.column.colId.peek()}}:{}),o)})}_buildChatPanelHeader(){return ae(ce((0,f.icon)("Robot"),X("AI Assistant")),de(ue(P.dom.domComputed(this._assistantExpanded,(e=>e?(0,f.icon)("Dropdown"):(0,f.icon)("DropdownUp"))),P.dom.on("click",(()=>{this._assistantExpanded.get()?this._collapseChatPanel():this._expandChatPanel()})),Q("ai-assistant-expand-collapse")),ue((0,f.icon)("Dots"),(0,F.menu)((()=>[(0,F.menuItem)((()=>this._clear()),X("Clear Conversation"),Q("ai-assistant-options-clear-conversation"))]),{menuCssClass:F.menuCssClass+" "+Fe.className}),Q("ai-assistant-options"))))}_buildChatPanelBody(){setTimeout((()=>{this.isDisposed()||this._chat.scrollDown(!1),this._options.editor.resize()}),0);const e=new ResizeObserver((()=>{this._chatPanelBodyClientHeight.set(this._chatPanelBody.clientHeight)}));return this._chatPanelBody=he(P.dom.onDispose((()=>e.disconnect())),Q("ai-assistant-chat-panel"),this._buildChatPanelBanner(),this._chat.buildDom(),this._appModel.currentValidUser?this._buildChatInput():this._buildSignupNudge(),he.cls("-resizing",this._isResizing),P.dom.on("mousedown",(e=>e.stopPropagation()))),e.observe(this._chatPanelBody),this._chatPanelBody}_buildChatPanelBanner(){return P.dom.domComputed((e=>{const t=e(this._numRemainingCredits);return null===t||t>10?null:0===t?P.dom.create(y.jL,{content:(0,y.RA)(X("You have used all available credits.")," ",this._buildBannerUpgradeMessage(),Q("ai-assistant-banner-message")),style:"error",bannerCssClass:ze.className}):e(this._showApproachingLimitBanner)?P.dom.create(y.jL,{content:(0,y.RA)(X("You have {{numCredits}} remaining credits.",{numCredits:t})," ",this._buildBannerUpgradeMessage(),Q("ai-assistant-banner-message")),style:"warning",showCloseButton:!0,onClose:()=>{this._showApproachingLimitBanner.set(!1)},bannerCssClass:ze.className}):null}))}_buildBannerUpgradeMessage(){const e=this._appModel.isOwner()&&Boolean(this._appModel.planName&&(0,E.Vz)(this._appModel.planName)),t=this._appModel.isBillingManager()||this._appModel.isSupport();return e||t?X("For higher limits, {{upgradeNudge}}.",{upgradeNudge:(0,y._O)(X(e?"upgrade to the Pro Team plan":"upgrade your plan"),P.dom.on("click",(async()=>{e?this._gristDoc.appModel.showUpgradeModal():await(0,C.urlState)().pushUrl({billing:"billing"})})))}):X("For higher limits, contact the site owner.")}_saveOrClose(){this._hasExpandedOnce&&this._logTelemetryEvent("assistantSave",!0,{oldFormula:this._options.column.formula.peek(),newFormula:this._options.editor.getTextValue()}),this._action="save",this._triggerFinalize()}_cancel(){this._hasExpandedOnce&&this._logTelemetryEvent("assistantCancel",!0),this._action="cancel",this._triggerFinalize()}async _preview(){const e=this._options.column.table.peek().tableId.peek(),t=this._options.editor.getCellValue();await this._options.gristDoc.docData.sendAction(["ModifyColumn",e,this._transformColId,{formula:t,isFormula:!0}]),this.isDisposed()||this._options.editor.focus()}async _preparePreview(){var e,t,o,i,n;const s=this._options.gristDoc.docData,r=this._options.column.table.peek().tableId.peek(),{colRef:l,colId:a}=await s.sendAction(["AddColumn",r,"gristHelper_Transform",{type:this._options.column.type.peek(),label:this._options.column.colId.peek(),isFormula:!0,formula:this._options.column.formula.peek(),widgetOptions:JSON.stringify(null==(e=this._options.field)?void 0:e.widgetOptionsJson())}]);this._transformColRef=l,this._transformColId=a,(null==(t=this._options.field)?void 0:t.rulesList())&&await s.sendAction(["UpdateRecord","_grist_Tables_column",l,{rules:null==(o=this._options.field)?void 0:o.rulesList()}]),null==(i=this._options.field)||i.colRef(l);const c=null==(n=this._options.field)?void 0:n.column.peek();c&&(c.isTransforming(!0),this._options.column.isTransforming(!0),c.origColRef(this._options.column.getRowId()))}async _cleanupPreview(){var e,t;this._triggerFinalize=N();const o=this._options.gristDoc.docData,i=this._options.column.table.peek().tableId.peek(),n=this._options.column;try{if("save"===this._action){const e=this._options.editor.getCellValue();await o.sendActions([["ModifyColumn",i,n.colId.peek(),{formula:e,isFormula:!0}]])}if(null==(e=this._options.field)||e.colRef(n.getRowId()),"save"===this._action)a.allCommands.fieldEditSaveHere.run();else if("cancel"===this._action)a.allCommands.fieldEditCancel.run();else{if("close"!==this._action)throw new Error("Unexpected value for _action");this.isDisposed()||a.allCommands.fieldEditCancel.run()}await o.sendActions([["RemoveColumn",i,this._transformColId]])}finally{null==(t=this._options.field)||t.colRef(n.getRowId()),n.isTransforming(!1)}}_collapseChatPanel(){this._assistantExpanded.get()&&(this._assistantExpanded.set(!1),this._chatPanelBody.style.setProperty("transition","none"),this._chatPanelBody.style.setProperty("height",`${this._chatPanelBody.clientHeight}px`),this._chatPanelBody.offsetHeight,this._chatPanelBody.style.removeProperty("transition"),this._chatPanelBody.style.setProperty("height","0px"),this._resizeEditor())}_expandChatPanel(){if(this._hasExpandedOnce||(this._logTelemetryEvent("assistantOpen",!0),this._hasExpandedOnce=!0),this._assistantExpanded.get())return;this._assistantExpanded.set(!0);const e=this._options.editor.getDom();let t=e.clientHeight-te-oe-se;if(e.querySelector(".error_msg")&&(t-=e.querySelector(".error_msg").clientHeight),e.querySelector(".error_details")&&(t-=e.querySelector(".error_details").clientHeight),this._lastChatPanelHeight){const e=Math.min(Math.max(this._lastChatPanelHeight,220),t);this._chatPanelBody.style.setProperty("height",`${e}px`),this._lastChatPanelHeight=e}else this._lastChatPanelHeight=t,this._chatPanelBody.style.setProperty("height",`${this._lastChatPanelHeight}px`);this._resizeEditor()}_onResizeStart(){var e;return this._isResizing.set(!0),{start:null==(e=this._domElement)?void 0:e.clientHeight,total:this._options.editor.getDom().clientHeight}}_onResizeMove(e,t,{start:o,total:i}){const n=o-t-se-oe;if(n<ne&&this._isResizing.get()?this._isResizing.set(!1):n>=ne&&!this._isResizing.get()&&this._isResizing.set(!0),n<78)this._collapseChatPanel();else{this._expandChatPanel();const e=Math.max(ne,Math.min(i-te,n));this._chatPanelBody.style.height=`${e}px`}}_onResizeEnd(){this._isResizing.set(!1),this._assistantExpanded.get()&&(this._lastChatPanelHeight=this._chatPanelBody.clientHeight)}_buildChatInput(){return this._input&&P.dom.domDispose(this._input),this._input=Re(P.dom.on("input",(e=>{this._userInput.set(e.target.value)})),(0,S.po)(this._userInput),P.dom.style("max-height",(e=>{var t,o,i,n;const s=e(this._chatPanelBodyClientHeight)-((null!=(o=null==(t=this._inputWrapper)?void 0:t.clientHeight)?o:0)-(null!=(n=null==(i=this._input)?void 0:i.clientHeight)?n:0))-ie;return`${Math.max(s,re)}px`})),P.dom.onKeyDown({Enter$:e=>this._handleChatEnterKeyDown(e),Escape:()=>this._cancel()}),P.dom.autoDispose(this._userInput.addListener((e=>this._input.value=e))),P.dom.prop("disabled",this._waiting),P.dom.prop("placeholder",(e=>{const t=e(this._chat.lastSuggestedFormula);return X(t?"Press Enter to apply suggested formula.":"What do you need help with?")})),P.dom.autoDispose(this._waiting.addListener((e=>{e||setTimeout((()=>this._focusChatInput()),0)})))),this._inputWrapper=ge(Q("ai-assistant-chat-input"),P.dom.cls(me.className),P.dom.cls(fe.className),ye(P.dom.cls(be.className),this._input,Te(Ie((0,f.icon)("FieldAny"),P.dom.on("click",this._handleSendMessageClick.bind(this)),Ie.cls("-disabled",(e=>e(this._waiting)||0===e(this._userInput).length))),P.dom.on("click",(e=>{e.stopPropagation(),this._focusChatInput()})),Te.cls("-disabled",this._waiting)),ye.cls("-disabled",this._waiting)))}_buildSignupNudge(){const{deploymentType:e}=(0,M.getGristConfig)();return"saas"===e?$e(Le(X("Sign up for a free Grist account to start using the Formula AI Assistant.")),Ne((0,h.bigPrimaryButtonLink)(X("Sign Up for Free"),{href:(0,C.getLoginOrSignupUrl)()},Q("ai-assistant-sign-up")))):$e($e.cls("-center"),Le(X("Formula AI Assistant is only available for logged in users.")))}async _handleChatEnterKeyDown(e){if(e.shiftKey)return;e.preventDefault();const t=this._chat.lastSuggestedFormula.get();""===this._input.value&&t?this._apply(t).catch(reportError):this._ask().catch(reportError)}async _handleSendMessageClick(e){this._waiting.get()||0===this._input.value.length||await this._ask()}async _apply(e){this._options.editor.setFormula(e),this._resizeEditor(),await this._preview()}async _sendMessage(e){const{column:t,gristDoc:o}=this._options,i=this._chat.conversationId.get(),n=t.chatHistory.peek().get().state,{reply:s,suggestedActions:r,suggestedFormula:l,state:a,limit:c}=await async function(e,t){const{column:o,description:i,conversationId:n,state:s}=t,r=o.table.peek().tableId.peek(),l=o.colId.peek();return await e.docApi.getAssistance({conversationId:n,context:{type:"formula",tableId:r,colId:l},text:i,state:s})}(o,{conversationId:i,column:t,description:e,state:n});return c&&c.limit>=0?this._numRemainingCredits.set(Math.max(c.limit-c.usage,0)):this._numRemainingCredits.set(null),console.debug("received formula assistant response: ",{suggestedActions:r,suggestedFormula:l,reply:s,state:a}),t.chatHistory.peek().get().state=a,{message:a?s||l||"":l||s||"",formula:l,action:r[0],sender:"ai"}}_focusChatInput(){this._input&&(this._input.focus(),this._input.value.length>0&&(this._input.selectionStart=this._input.value.length,this._input.scrollTop=this._input.scrollHeight))}_clear(){this._chat.clear(),this._userInput.set("")}async _ask(){if(this._waiting.get())return;const e=this._userInput.get();e&&(this._chat.addQuestion(e),this._userInput.set(""),await this._doAsk(e))}async _doAsk(e){var t;this._chat.thinking(),this._waiting.set(!0);try{const t=await this._sendMessage(e);this._chat.addResponse(t)}catch(e){if(e instanceof O.M&&429===e.status&&(null==(t=e.details)?void 0:t.limit)){const{projectedValue:t,maximum:o}=e.details.limit;if(t>=o)return void this._numRemainingCredits.set(0)}throw e}finally{this._chat.thinking(!1),this._waiting.set(!1)}}}class ee extends P.Disposable{constructor(e){super(),this._options=e;const t=this._options.column;let o=t.chatHistory.peek().get().conversationId;if(!o){o=(0,V.v4)();const e=t.chatHistory.peek();e.set(J(q({},e.get()),{conversationId:o}))}this.conversationId=P.Observable.create(this,o),this.autoDispose(this.conversationId.addListener((e=>{const o=t.chatHistory.peek();o.set(J(q({},o.get()),{conversationId:e}))}))),this.conversationHistory=this.autoDispose((0,P.obsArray)(t.chatHistory.peek().get().messages)),this.autoDispose(this.conversationHistory.addListener((e=>{const o=t.chatHistory.peek();o.set(J(q({},o.get()),{messages:[...e]}))}))),this.conversation=this.autoDispose((0,P.obsArray)()),this.conversationHistoryLength=P.Computed.create(this,(e=>e(this.conversationHistory).length)),this.conversationLength=P.Computed.create(this,(e=>e(this.conversation).length)),this.conversationSuggestedFormulas=P.Computed.create(this,(e=>e(this.conversation).map((({formula:e})=>e)).filter((e=>Boolean(e))))),this.lastSuggestedFormula=P.Computed.create(this,(e=>{var t,o;return null!=(o=null==(t=[...e(this.conversationHistory)].reverse().find((({formula:e})=>e)))?void 0:t.formula)?o:null}))}thinking(e=!0){if(e)this.conversationHistory.push({message:"...",sender:"ai"}),this.scrollDown();else{const e=[...this.conversationHistory.get()].filter((e=>"..."===e.message));for(const t of e)this.conversationHistory.splice(this.conversationHistory.get().indexOf(t),1)}}supportsMarkdown(){return void 0!==this._options.column.chatHistory.peek().get().state}addResponse(e){this.thinking(!1);const t=J(q({},e),{sender:"ai"});this.conversationHistory.push(t),this.conversation.push(t),this.scrollDown()}addQuestion(e){this.thinking(!1);const t={message:e,sender:"user"};this.conversationHistory.push(t),this.conversation.push(t)}lastQuestion(){const e=this.conversationHistory.get();if(0===e.length)return null;const t=e[e.length-1];if("user"===(null==t?void 0:t.sender))return t.message;throw new Error("No last question found")}removeLastResponse(){const e=this.conversationHistory.get()[this.conversationHistory.get().length-1];"ai"===(null==e?void 0:e.sender)&&this.conversationHistory.pop()}clear(){this._options.logTelemetryEvent("assistantClearConversation",!0),this.conversationId.set((0,V.v4)()),this.conversationHistory.set([]);const{column:e}=this._options;e.chatHistory.peek().get().state=void 0}scrollDown(e=!0){this._element.scroll({top:99999,behavior:e?"smooth":"auto"})}buildDom(){return this._element=ve(this._buildIntroMessage(),P.dom.forEach(this.conversationHistory,(e=>"user"===e.sender?_e((0,P.dom)("span",P.dom.text(e.message),Q("ai-assistant-message-user"),Q("ai-assistant-message")),Ce(function(e){var t;const o=(null==(t=e.app.topAppModel.appObs.get())?void 0:t.currentUser)||null;return o?(0,T.O_)(o,"medium"):(0,P.dom)("div","")}(this._options.gristDoc))):(0,P.dom)("div",we(Ce(De()),"..."===e.message?Be():this._render(e.message,P.dom.cls("formula-assistant-message"),Q("ai-assistant-message-ai"),Q("ai-assistant-message"))),Oe(Ee((0,h.primaryButton)(X("Apply"),P.dom.on("click",(()=>{this._options.apply(e.formula)})))),P.dom.show(Boolean(e.formula)))))))}_buildIntroMessage(){return xe(Ce(De()),(0,P.dom)("div",Ae(X("Hi, I'm the Grist Formula AI Assistant.")),Ae(X("There are some things you should know when working with me:")),Ae(Me(Pe("Tick"),X("I can only help with formulas. I cannot build tables, columns, and views, or write access rules.")),Me(Pe("Tick"),X('Talk to me like a person. No need to specify tables and column names. For example, you can ask "Please calculate the total invoice amount."')),"OpenAI"===(0,u.WHICH_FORMULA_ASSISTANT)()?Me(Pe("Tick"),(0,P.dom)("div",X("When you talk to me, your questions and your document structure (visible in {{codeView}}) are sent to OpenAI. {{learnMore}}.",{codeView:(0,I.Y3)(X("Code View"),(0,C.urlState)().setLinkUrl({docPage:"code"})),learnMore:(0,I.Y3)(X("Learn more"),{href:A.PH.helpAssistantDataUse,target:"_blank"})}))):null),Ae(X("For more help with formulas, check out our {{functionList}} and {{formulaCheatSheet}}, or visit our {{community}} for more help.",{functionList:(0,I.Y3)(X("Function List"),{href:A.PH.functions,target:"_blank"}),formulaCheatSheet:(0,I.Y3)(X("Formula Cheat Sheet"),{href:A.PH.formulaSheet,target:"_blank"}),community:(0,I.Y3)(X("Community"),{href:A.PH.community,target:"_blank"})}))),Q("ai-assistant-message-intro"))}_render(e,...t){const o=this._options.gristDoc;return this.supportsMarkdown()?(0,P.dom)("div",(t=>(0,P.subscribeElem)(t,o.currentTheme,(()=>{const i=(0,k.j)((0,z.TU)(e,{highlight:e=>(0,D.Lh)(e,{gristTheme:o.currentTheme,maxLines:60}).innerHTML}));t.innerHTML=i}))),...t):(0,D.Lh)(e,{gristTheme:o.currentTheme,maxLines:100})}}const te=100,oe=42,ie=160,ne=180,se=30,re=42,le=(0,P.styled)("div","\n  position: relative;\n  display: flex;\n  flex-direction: column;\n  overflow:hidden;\n  flex-grow: 1;\n"),ae=(0,P.styled)("div",`\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  flex-shrink: 0;\n  padding: 0px 8px 0px 8px;\n  background-color: ${m.theme.formulaAssistantHeaderBg};\n  height: ${se}px;\n  border-top: 1px solid ${m.theme.formulaAssistantBorder};\n  border-bottom: 1px solid ${m.theme.formulaAssistantBorder};\n`),ce=(0,P.styled)("div",`\n  display: flex;\n  align-items: center;\n  color: ${m.theme.lightText};\n  --icon-color: ${m.theme.accentIcon};\n  column-gap: 8px;\n  user-select: none;\n`),de=(0,P.styled)("div","\n  display: flex;\n  align-items: center;\n  column-gap: 8px;\n"),ue=(0,P.styled)("div",`\n  --icon-color: ${m.theme.controlSecondaryFg};\n  border-radius: 3px;\n  padding: 3px;\n  cursor: pointer;\n  user-select: none;\n  &:hover, &.weasel-popup-open {\n    background-color: ${m.theme.hover};\n  }\n`),pe=(0,P.styled)("div","\n  position: absolute;\n  top: -3px;\n  height: 7px;\n  width: 100%;\n  cursor: ns-resize;\n"),he=(0,P.styled)("div","\n  overflow: hidden;\n  display: flex;\n  flex-direction: column;\n  flex-grow: 1;\n  transition: height 0.4s;\n\n  &-resizing {\n    transition: unset;\n  }\n"),me=(0,P.styled)("div",`\n  border-top: 1px solid ${m.theme.formulaAssistantBorder};\n`),fe=(0,P.styled)("div","\n  padding-top: 18px;\n  padding-bottom: 18px;\n"),ge=(0,P.styled)("div","\n  margin-top: auto;\n  padding-left: 18px;\n  padding-right: 18px;\n  display: flex;\n  flex-shrink: 0;\n  flex-direction: column;\n"),be=(0,P.styled)("div",`\n  color: ${m.theme.inputFg};\n`),ve=(0,P.styled)("div",`\n  overflow: auto;\n  display: flex;\n  flex-direction: column;\n  color: ${m.theme.inputFg};\n`),ye=(0,P.styled)("div",`\n  display: flex;\n  flex-direction: column;\n  border: 1px solid ${m.theme.inputBorder};\n  border-radius: 3px;\n  align-items: center;\n  --icon-color: ${m.theme.controlSecondaryFg};\n  &-disabled {\n    background-color: ${m.theme.inputDisabledBg};\n  }\n  & > input {\n    outline: none;\n    padding: 0px;\n    align-self: stretch;\n    flex: 1;\n    border: none;\n    background-color: inherit;\n  }\n`),_e=(0,P.styled)("div",`\n  display: grid;\n  grid-template-columns: 1fr 60px;\n  border-top: 1px solid ${m.theme.formulaAssistantBorder};\n  padding: 20px 0px 20px 20px;\n`),we=(0,P.styled)("div",`\n  position: relative;\n  display: grid;\n  grid-template-columns: 60px 1fr;\n  border-top: 1px solid ${m.theme.formulaAssistantBorder};\n  padding: 20px 20px 20px 0px;\n\n  & pre {\n    border: none;\n    background: ${m.theme.formulaAssistantPreformattedTextBg};\n    font-size: 10px;\n  }\n\n  & pre .ace-chrome, & pre .ace-dracula {\n    background: ${m.theme.formulaAssistantPreformattedTextBg} !important;\n  }\n\n  & p > code {\n    background: #FFFFFF;\n    border: 1px solid #E1E4E5;\n    color: #333333;\n    white-space: pre-wrap;\n    word-wrap: break-word;\n  }\n`),xe=(0,P.styled)(we,"\n  border-top: unset;\n"),Ce=(0,P.styled)("div","\n  display: flex;\n  align-items: flex-start;\n  justify-content: center;\n"),De=(0,P.styled)("div","\n  flex: none;\n  height: 32px;\n  width: 32px;\n  border-radius: 50%;\n  background-color: white;\n  background-image: var(--icon-GristLogo);\n  background-size: 22px 22px;\n  background-repeat: no-repeat;\n  background-position: center;\n"),Se=(0,P.styled)("div","\n  display: flex;\n  justify-content: flex-end;\n  gap: 8px;\n  padding: 8px;\n"),ke=(0,P.styled)("div._tools_container","\n  display: flex;\n  flex-direction: column;\n  overflow: hidden;\n"),Te=(0,P.styled)("div","\n  padding-top: 8px;\n  width: 100%;\n  justify-content: flex-end;\n  cursor: text;\n  display: flex;\n\n  &-disabled {\n    cursor: default;\n  }\n"),Ie=(0,P.styled)("div",`\n  padding: 3px;\n  border-radius: 4px;\n  align-self: flex-end;\n  margin-bottom: 6px;\n  margin-right: 6px;\n\n  &-disabled {\n    --icon-color: ${m.theme.controlSecondaryFg};\n  }\n\n  &:not(&-disabled) {\n    cursor: pointer;\n    --icon-color: ${m.theme.controlPrimaryFg};\n    color: ${m.theme.controlPrimaryFg};\n    background-color: ${m.theme.controlPrimaryBg};\n  }\n\n  &:hover:not(&-disabled) {\n    background-color: ${m.theme.controlPrimaryHoverBg};\n  }\n`),Re=(0,P.styled)("textarea",`\n  border: 0px;\n  flex-grow: 1;\n  outline: none;\n  width: 100%;\n  padding: 4px 6px;\n  padding-top: 6px;\n  resize: none;\n  min-height: ${re}px;\n  background: transparent;\n\n  &:disabled {\n    background-color: ${m.theme.inputDisabledBg};\n    color: ${m.theme.inputDisabledFg};\n  }\n\n  &::placeholder {\n    color: ${m.theme.inputPlaceholderFg};\n  }\n`),Fe=(0,P.styled)("div",`\n  z-index: ${m.vars.floatingPopupMenuZIndex};\n`),Oe=(0,P.styled)("div","\n  display: flex;\n  justify-content: flex-end;\n  padding: 8px;\n"),Ee=(0,P.styled)("div","\n  display: flex;\n  column-gap: 8px;\n"),Ae=(0,P.styled)("div","\n  margin-bottom: 8px;\n"),Me=(0,P.styled)("div","\n  display: flex;\n  align-items: flex-start;\n  margin-bottom: 6px;\n"),Pe=(0,P.styled)(f.icon,`\n  --icon-color: ${m.theme.accentIcon};\n  margin-right: 8px;\n  flex-shrink: 0;\n`),Be=(0,P.styled)(R.W,"\n  --dot-size: 5px;\n  align-items: center;\n"),$e=(0,P.styled)("div",`\n  border-top: 1px solid ${m.theme.formulaAssistantBorder};\n  padding: 16px;\n  margin-top: auto;\n  display: flex;\n  flex-shrink: 0;\n  flex-direction: column;\n  &-center {\n    display: flex;\n    justify-content: center;\n    align-items: center;\n  }\n`),Le=(0,P.styled)("div",`\n  font-size: ${m.vars.mediumFontSize};\n  font-weight: 500;\n  margin-bottom: 12px;\n  text-align: center;\n`),Ne=(0,P.styled)("div","\n  display: flex;\n  justify-content: center;\n"),ze=(0,P.styled)("div","\n  padding: 6px 8px 6px 8px;\n");var Ve=o(63074),He=o(48517),je=o(631),Ue=o(83277),We=o(93965),Ye=Object.defineProperty,Ge=Object.getOwnPropertySymbols,Ke=Object.prototype.hasOwnProperty,qe=Object.prototype.propertyIsEnumerable,Je=(e,t,o)=>t in e?Ye(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,Xe=(e,t)=>{for(var o in t||(t={}))Ke.call(t,o)&&Je(e,o,t[o]);if(Ge)for(var o of Ge(t))qe.call(t,o)&&Je(e,o,t[o]);return e};const Qe=o(88466),Ze=(0,c.makeT)("FormulaEditor");class et extends Ve._{constructor(e){super(e),this.isDetached=P.Observable.create(this,!1),this._placementHolder=P.Holder.create(this);const t=e.editingFormula,o=(0,Ue.undef)(e.state,e.editValue,String(e.cellValue));this.editorState=P.Observable.create(this,o),this._isEmpty=P.Computed.create(this,this.editorState,((e,t)=>""===t)),this._aceEditor=l.create({column:e.column,calcSize:this._calcSize.bind(this),gristDoc:e.gristDoc,saveValueOnBlurEvent:!e.readonly,editorState:this.editorState,readonly:e.readonly});const i=e.readonly?{}:{setCursor:this._onSetCursor},n=P.Computed.create(this,(e=>Boolean(e(t)))),s=this.autoDispose(a.createGroup(i,this,n)),r=this.autoDispose(a.createGroup(Xe({},e.commands),this,!0)),c={knownKeys:Xe(Xe({},s.knownKeys),r.knownKeys),commands:Xe(Xe({},s.commands),r.commands)},d=e=>()=>{var t,o;return!!this.isDetached.get()||null!=(o=null==(t=a.allCommands[e])?void 0:t.run())&&o},u=this.autoDispose(a.createGroup({nextField:d("nextField"),prevField:d("prevField"),fieldEditSave:d("fieldEditSave")},this,!1));Object.assign(c.knownKeys,u.knownKeys),Object.assign(c.commands,u.commands);const h=P.Observable.create(this,!0),f=P.Computed.create(this,(t=>e.formulaError&&t(e.formulaError)?(0,je.isRaisedException)(t(e.formulaError))?(0,We.xD)(t(e.formulaError)):new We.es(["Unknown error"]):null)),b=P.Computed.create(this,f,((e,t)=>t?t.message?`${t.name} : ${t.message}`:t.name:"")),y=P.Computed.create(this,f,((e,t)=>{var o;return t&&null!=(o=t.details)?o:""}));this.autoDispose(y.addListener((()=>setTimeout(this.resize.bind(this),0)))),this._canDetach=Boolean(e.canDetach&&!e.readonly),this.autoDispose(this._aceEditor),this._isEmpty.addListener((()=>this._updateEditorPlaceholder())),this.isDetached.addListener((t=>{t?e.gristDoc.getUndoStack().disable():e.gristDoc.getUndoStack().enable()})),this.onDispose((()=>{e.gristDoc.getUndoStack().enable()})),this._dom=lt(P.dom.cls("readonly_editor",e.readonly),(0,g.createMobileButtons)(e.commands),e.cssClass?P.dom.cls(e.cssClass):null,P.dom.on("mousedown",(e=>{this.isDetached.get()&&(e.target instanceof HTMLInputElement||e.target instanceof HTMLTextAreaElement)&&this._dom.contains(e.target)||e.target instanceof HTMLElement&&(e.target.classList.contains("error_msg")||e.target.classList.contains("error_details_inner"))||(e.preventDefault(),this.focus())})),this._canDetach?(0,v.A)((0,p.hoverTooltip)(Ze("Expand Editor")),P.dom.hide(this.isDetached)):null,lt.cls("-detached",this.isDetached),(0,P.dom)("div.formula_editor.formula_field_edit",(0,m.testId)("formula-editor"),this._aceEditor.buildDom((i=>{i.setFontSize(11),i.setHighlightActiveLine(!1),i.getSession().setUseWrapMode(!1),i.renderer.setPadding(0);const n=o,s=Math.min(e.cursorPos,n.length);this._aceEditor.setValue(n,s),this._aceEditor.attachCommandGroup(c),(e.state||e.readonly)&&t(!0),e.readonly&&(this._aceEditor.enable(!1),i.gotoLine(0,0)),i.once("change",(()=>{null==t||t(!0)})),""===n&&this._updateEditorPlaceholder()}))),P.dom.maybe(e.formulaError,(()=>[(0,P.dom)("div.error_msg",(0,m.testId)("formula-error-msg"),P.dom.attr("tabindex","-1"),P.dom.maybe(y,(()=>P.dom.domComputed(h,(e=>st(e?"Expand":"Collapse",(0,m.testId)("formula-error-expand"),P.dom.on("click",(()=>{y.get()&&(h.set(!h.get()),this._aceEditor.resize())}))))))),P.dom.text(b)),P.dom.maybe((e=>Boolean(e(y)&&!e(h))),(()=>(0,P.dom)("div.error_details",P.dom.attr("tabindex","-1"),(0,P.dom)("div.error_details_inner",P.dom.text(y)),(0,m.testId)("formula-error-details"))))])),P.dom.maybe(this.isDetached,(()=>P.dom.create(Z,{column:this.options.column,field:this.options.field,gristDoc:this.options.gristDoc,editor:this}))))}attach(e){this.isDetached.set(!1),this._editorPlacement=b.EditorPlacement.create(this._placementHolder,this._dom,e,{margins:(0,g.getButtonMargins)()}),this.autoDispose(this._editorPlacement.onReposition.addListener(this._aceEditor.resize,this._aceEditor)),this._aceEditor.onAttach(),this._updateEditorPlaceholder(),this._aceEditor.resize(),this.focus()}getDom(){return this._dom}setFormula(e){this._aceEditor.setValue(e)}getCellValue(){const e=this._aceEditor.getValue();return"="===e[0]?e.slice(1):e}getTextValue(){return this._aceEditor.getValue()}getCursorPos(){const e=this._aceEditor.getEditor();return e.getSession().getDocument().positionToIndex(e.getCursorPosition())}focus(){this.isDisposed()||this._aceEditor.getEditor().focus()}resize(){this.isDisposed()||this._aceEditor.resize()}detach(){var e;return null==(e=this._dom.parentNode)||e.removeChild(this._dom),this.isDetached.set(!0),this._placementHolder.clear(),this.options.editingFormula(!0),this._updateEditorPlaceholder(),setTimeout((()=>!this.isDisposed()&&this._aceEditor.resize()),0),this._dom}_updateEditorPlaceholder(){const e=this._aceEditor.getEditor(),t=0===e.session.getValue().length;if(e.renderer.emptyMessageNode&&e.renderer.scroller.removeChild(e.renderer.emptyMessageNode),t){const t=this._canDetach&&!this.isDetached.get()&&(0,u.HAS_FORMULA_ASSISTANT)();e.renderer.emptyMessageNode=at(t?Ze("Enter formula or {{button}}.",{button:ct(Ze("use AI Assistant"),P.dom.on("click",(e=>this._handleUseAssistantButtonClick(e))),(0,m.testId)("formula-editor-use-ai-assistant"))}):Ze("Enter formula.")),e.renderer.scroller.appendChild(e.renderer.emptyMessageNode)}else e.renderer.emptyMessageNode=null}_handleUseAssistantButtonClick(e){e.stopPropagation(),e.preventDefault(),a.allCommands.detachEditor.run(),a.allCommands.activateAssistant.run()}_calcSize(e,t){if(this.isDetached.get())return{height:0,width:0};const o=this._aceEditor.getEditor().renderer.emptyMessageNode;if(o)return this._editorPlacement.calcSizeWithPadding(e,{width:o.scrollWidth,height:o.scrollHeight});const i=this._dom.querySelector(".error_details"),n=(null==i?void 0:i.getBoundingClientRect().height)||0,s=(null==i?void 0:i.scrollHeight)||0,r={width:Math.max(t.width,this.options.formulaError.get()?400:0),height:t.height+(s-n)},l=this._editorPlacement.calcSizeWithPadding(e,r);if(i){const e=n+(l.height-t.height),o=Math.min(s,Math.max(e,64));i.style.height=`${o}px`,l.height-=o-n}return l}_onSetCursor(e,t){if(this.options.readonly)return;if(!t)return;const o=t.origCol.peek().colId.peek();if(t.tableId.peek()!==this.options.column.table.peek().tableId.peek())return void this.options.gristDoc.onSetCursorPos(e,t).catch(d.reportError);const i=this._aceEditor.getEditor();if(i.selection.isEmpty()){const e=i.getCursorPosition(),t=function(e,t){let o=e.slice(0,t).search(/[$A-Za-z0-9_]+$/);o<0&&(o=t);const i=e.slice(o).match(/^[$a-zA-Z0-9_]+/);if(i){const e=i[0];return{ident:e,start:o,end:o+e.length}}return null}(i.session.getLine(e.row),e.column);if(t){if(t.ident.startsWith("$")){const n=l.makeRange(e.row,t.start,e.row,t.end);i.session.replace(n,"$"+o)}}else i.insert("$"+o)}else i.session.replace(i.selection.getRange(),"$"+o);this._aceEditor.resize(),i.focus();const n=P.dom.onElem(i.textInput.getElement(),"blur",(e=>{n.dispose(),i.focus()}));setTimeout((()=>n.dispose()),0)}}function tt(e){var t,o,i,n;const{gristDoc:s,editRow:r,refElem:l,setupCleanup:a}=e,c=new P.MultiHolder;if(e.field)e.column=e.field.origCol();else if(e.canDetach)throw new Error("Field is required for detached editor");const u=null!=(o=e.column)?o:null==(t=e.field)?void 0:t.column();if(!u)throw new Error("Column or field is required");const p=(0,He.tJ)((async()=>{var t;if(f.isDetached.get())return void f.dispose();const o=String(f.getCellValue());o!==u.formula.peek()?(e.onSave?await e.onSave(u,o):await u.updateColValues({formula:o}),f.dispose()):(f.dispose(),null==(t=e.onCancel)||t.call(e))})),h={fieldEditSave:()=>{p().catch(d.reportError)},fieldEditSaveHere:()=>{p().catch(d.reportError)},fieldEditCancel:()=>{var t;f.dispose(),null==(t=e.onCancel)||t.call(e)}},m=r?ot(c,{gristDoc:s,editRow:r,column:u,field:e.field}):void 0,f=et.create(null,{gristDoc:s,column:u,field:e.field,editingFormula:e.editingFormula,rowId:r?r.id():0,cellValue:u.formula(),formulaError:m,editValue:e.editValue,cursorPos:Number.POSITIVE_INFINITY,commands:h,cssClass:"formula_editor_sidepane",readonly:!1,canDetach:e.canDetach});f.autoDispose(c),f.attach(l);const g=null!=(n=e.editingFormula)?n:null==(i=null==e?void 0:e.field)?void 0:i.editingFormula;if(!g)throw new Error(Ze("editingFormula is required"));return u.formula()||g(!0),a(f,s,g,p),f}function ot(e,t){const{gristDoc:o,editRow:i}=t,n=P.Observable.create(e,void 0);if(!t.field){const s=t.column,r=s.colId.peek(),l=it(o,s,i,e,n),a=i.cells[r].subscribe(l);return e.autoDispose(a),l(i.cells[r].peek()),n}{const s=o.getTableModel(t.field.tableId.peek()).createFloatingRowModel();s.assign(i.getRowId()),e.autoDispose(s),P.Computed.create(e,(e=>{const i=P.MultiHolder.create(e.owner),r=e(t.field.column),l=e(r.colId),a=it(o,r,s,i,n);return i.autoDispose(s.cells[l].subscribe(a)),a(s.cells[l].peek()),i}))}return n}function it(e,t,o,i,n){return function(s){(t.isFormula()||t.hasTriggerFormula())&&(0,je.isRaisedException)(s)?(n.get()||n.set(s),e.docData.getFormulaError(t.table().tableId(),t.colId(),o.getRowId()).then((e=>{i.isDisposed()||n.set(e)})).catch((e=>{i.isDisposed()||(0,d.reportError)(e)}))):n.set(void 0)}}function nt(e,t,o){const i=P.Observable.create(e,""),n=Qe((function(){var n;if(e.isDisposed())return;const s=t.docData.getTable(o.table.peek().tableId.peek()),r=o.isRealFormula.peek()||o.hasTriggerFormula.peek();if(s&&r){const e=o.colId.peek(),t=(null==(n=s.getColValues(e))?void 0:n.length)||0,r=s.countErrors(e)||0;i.set(0===r?"":1===t?Ze("Error in the cell"):r===t?Ze("Errors in all {{numErrors}} cells",{numErrors:r}):Ze("Errors in {{numErrors}} of {{numCells}} cells",{numErrors:r,numCells:t}))}else i.set("")}),0);return P.Computed.create(e,(e=>{const i=t.docData.getTable(e(e(o.table).tableId));return i?e.owner.autoDispose(i.tableActionEmitter.addListener(n)):null})),e.autoDispose((0,P.subscribe)((e=>{e(o.id),e(o.isRealFormula),n()}))),i}const st=(0,P.styled)(f.icon,`\n  margin: -3px 4px 0 4px;\n  --icon-color: ${m.colors.slate};\n  cursor: pointer;\n  position: sticky;\n  top: 0px;\n  flex-shrink: 0;\n`),rt=(0,P.styled)("div",`\n  color: ${m.theme.errorText};\n`),lt=(0,P.styled)("div.default_editor.formula_editor_wrapper","\n  &-detached {\n    height: 100%;\n    position: relative;\n    box-shadow: none;\n  }\n  &-detached .formula_editor {\n    flex-grow: 1;\n    min-height: 100px;\n  }\n\n  &-detached .error_msg, &-detached .error_details {\n    max-height: 100px;\n    flex-shrink: 0;\n  }\n\n  &-detached .code_editor_container {\n    height: 100%;\n    width: 100%;\n  }\n\n  &-detached .ace_editor {\n    height: 100% !important;\n    width: 100% !important;\n  }\n"),at=(0,P.styled)("div",`\n  color: ${m.theme.lightText};\n  font-style: italic;\n  white-space: nowrap;\n`),ct=(0,P.styled)(h.textButton,`\n  font-size: ${m.vars.smallFontSize};\n`)},61957:(e,t,o)=>{"use strict";o.d(t,{D:()=>u});var i=o(95163),n=o(3411),s=o(88261),r=o(29922),l=o(4425),a=o(64283),c=o(1310);const d=(0,o(70387).makeT)("NTextBox");class u extends a.a{constructor(e,t={}){super(e,t),this.alignment=(0,c.fromKo)(this.options.prop("alignment")),this.wrapping=(0,c.fromKo)(this.field.wrap),this.autoDispose(this.wrapping.addListener((()=>{this.field.viewSection().events.trigger("rowHeightChange")})))}buildConfigDom(){const e=this.field.config.options,t=c.Computed.create(this,(t=>t(e.disabled("alignment")))),o=c.Computed.create(this,(t=>t(e.disabled("wrap"))));return[(0,n.cssRow)((0,s.alignmentSelect)((0,i.fromKoSave)(this.field.config.alignment),s.cssButtonSelect.cls("-disabled",t)),(0,c.dom)("div",{style:"margin-left: 8px;"},(0,s.makeButtonSelect)((0,c.fromKo)(this.field.config.wrap),[{value:!0,icon:"Wrap"}],(()=>{const e=!this.field.config.wrap.peek();this.field.config.wrap.setAndSave(e).catch(reportError)}),s.cssButtonSelect.cls("-disabled",o)),(0,r.testId)("tb-wrap-text")))]}buildDom(e){const t=e.cells[this.field.colId.peek()];return(0,c.dom)("div.field_clip",c.dom.style("text-align",this.alignment),c.dom.cls("text_wrapping",this.wrapping),c.dom.domComputed((o=>o(e._isAddRow)||this.isDisposed()?null:(0,l.iz)(o(this.valueFormatter).formatAny(o(t),d)))))}}},64283:(e,t,o)=>{"use strict";o.d(t,{a:()=>s});var i=o(73974),n=o(1310);class s extends n.Disposable{constructor(e,t={}){super(),this.field=e,this.options=e.widgetOptionsJson,this.valueFormatter=(0,n.fromKo)(e.formatter),this.defaultTextColor=(null==t?void 0:t.defaultTextColor)||"#000000"}static create(...e){return n.Disposable.create.call(this,null,...e)}buildConfigDom(){return null}buildTransformConfigDom(){return null}buildColorConfigDom(e){return n.dom.create(i.CellStyle,this.field,e,this.defaultTextColor)}_getDocData(){return this.field._table.tableData.docData}_getDocComm(){return this._getDocData().docComm}}},63074:(e,t,o)=>{"use strict";o.d(t,{_:()=>n});var i=o(1310);class n extends i.Disposable{constructor(e){super(),this.options=e}static create(e,t){return t?i.Disposable.create.call(this,e,t):i.Disposable.create.call(this,null,e)}static skipEditor(e,t){}static supportsReadonly(){return!0}detach(){return null}getDom(){return null}prepForSave(){}}},73454:(e,t,o)=>{"use strict";o.r(t),o.d(t,{buildTZAutocomplete:()=>f,timezoneOptionsImpl:()=>m});var i=o(11104),n=o(84462),s=o(29922),r=o(83277),l=Object.defineProperty,a=Object.defineProperties,c=Object.getOwnPropertyDescriptors,d=Object.getOwnPropertySymbols,u=Object.prototype.hasOwnProperty,p=Object.prototype.propertyIsEnumerable,h=(e,t,o)=>t in e?l(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;function m(e,t,o){const i=o.unix(e/1e3),n=t.map((t=>({cleanText:t.toLowerCase().trim(),value:t,label:`(GMT${i.tz(t).format("Z")}) ${t}`,offset:-o.tz.zone(t).parse(e)})));return n.sort(((e,t)=>(0,r.nativeCompare)(e.offset,t.offset)||(0,r.nativeCompare)(e.value,t.value))),n}function f(e,t,o,r,l){const f=new i.ACIndexImpl(function(e){return m(Date.now(),e.tz.names(),e)}(t),1e3,!0);return(0,n.R)(e,(g=((e,t)=>{for(var o in t||(t={}))u.call(t,o)&&h(e,o,t[o]);if(d)for(var o of d(t))p.call(t,o)&&h(e,o,t[o]);return e})({},l),a(g,c({acIndex:f,valueObs:o,save:(e,t)=>{if(!t){const o=f.search(e);o.selectIndex>=0&&o.items.length>0&&(e=(t=o.items[o.selectIndex]).value)}if(!t)throw new Error("Invalid time zone");if(e!==o.get())return r(e)}}))),(0,s.testId)("tz-autocomplete"));var g}},49142:(e,t,o)=>{"use strict";o.d(t,{JH:()=>s,Tb:()=>n,UD:()=>r});var i=o(54156);function n(e,t){const o=r[t]||r.Text;return e in o.widgets||(e=o.default),{name:e,config:o.widgets[e]}}function s(e,t){const{name:o,config:s}=n(e.widget,t);return i.default.defaults({widget:o},e,s.options)}const r={Any:{label:"Any",icon:"FieldAny",widgets:{TextBox:{cons:"TextBox",editCons:"TextEditor",icon:"FieldTextbox",options:{alignment:"left",wrap:void 0}}},default:"TextBox"},Text:{label:"Text",icon:"FieldText",widgets:{TextBox:{cons:"TextBox",editCons:"TextEditor",icon:"FieldTextbox",options:{alignment:"left",wrap:void 0}},HyperLink:{cons:"HyperLinkTextBox",editCons:"HyperLinkEditor",icon:"FieldLink",options:{alignment:"left",wrap:void 0}}},default:"TextBox"},Numeric:{label:"Numeric",icon:"FieldNumeric",widgets:{TextBox:{cons:"NumericTextBox",editCons:"TextEditor",icon:"FieldTextbox",options:{alignment:"right",wrap:void 0,decimals:void 0,maxDecimals:void 0,numMode:void 0,numSign:void 0,currency:void 0}},Spinner:{cons:"Spinner",editCons:"TextEditor",icon:"FieldSpinner",options:{alignment:"right",wrap:void 0,decimals:void 0,maxDecimals:void 0,numMode:void 0,numSign:void 0,currency:void 0}}},default:"TextBox"},Int:{label:"Integer",icon:"FieldInteger",widgets:{TextBox:{cons:"NumericTextBox",editCons:"TextEditor",icon:"FieldTextbox",options:{decimals:0,alignment:"right",wrap:void 0,maxDecimals:void 0,numMode:void 0,numSign:void 0,currency:void 0}},Spinner:{cons:"Spinner",editCons:"TextEditor",icon:"FieldSpinner",options:{decimals:0,alignment:"right",wrap:void 0,maxDecimals:void 0,numMode:void 0,numSign:void 0,currency:void 0}}},default:"TextBox"},Bool:{label:"Toggle",icon:"FieldToggle",widgets:{TextBox:{cons:"TextBox",editCons:"TextEditor",icon:"FieldTextbox",options:{alignment:"center",wrap:void 0}},CheckBox:{cons:"CheckBox",editCons:"CheckBoxEditor",icon:"FieldCheckbox",options:{}},Switch:{cons:"Switch",editCons:"CheckBoxEditor",icon:"FieldSwitcher",options:{}}},default:"CheckBox"},Date:{label:"Date",icon:"FieldDate",widgets:{TextBox:{cons:"DateTextBox",editCons:"DateEditor",icon:"FieldTextbox",options:{dateFormat:"YYYY-MM-DD",isCustomDateFormat:!1,alignment:"left"}}},default:"TextBox"},DateTime:{label:"DateTime",icon:"FieldDateTime",widgets:{TextBox:{cons:"DateTimeTextBox",editCons:"DateTimeEditor",icon:"FieldTextbox",options:{dateFormat:"YYYY-MM-DD",timeFormat:"h:mma",isCustomDateFormat:!1,isCustomTimeFormat:!1,alignment:"left"}}},default:"TextBox"},Choice:{label:"Choice",icon:"FieldChoice",widgets:{TextBox:{cons:"ChoiceTextBox",editCons:"ChoiceEditor",icon:"FieldTextbox",options:{alignment:"left",wrap:void 0,choices:void 0,choiceOptions:void 0}}},default:"TextBox"},ChoiceList:{label:"Choice List",icon:"FieldChoice",widgets:{TextBox:{cons:"ChoiceListCell",editCons:"ChoiceListEditor",icon:"FieldTextbox",options:{alignment:"left",wrap:void 0,choices:void 0,choiceOptions:void 0}}},default:"TextBox"},Ref:{label:"Reference",icon:"FieldReference",widgets:{Reference:{cons:"Reference",editCons:"ReferenceEditor",icon:"FieldReference",options:{alignment:"left",wrap:void 0}}},default:"Reference"},RefList:{label:"Reference List",icon:"FieldReference",widgets:{Reference:{cons:"ReferenceList",editCons:"ReferenceListEditor",icon:"FieldReference",options:{alignment:"left",wrap:void 0}}},default:"Reference"},Attachments:{label:"Attachment",icon:"FieldAttachment",widgets:{Attachments:{cons:"AttachmentsWidget",editCons:"AttachmentsEditor",icon:"FieldAttachment",options:{height:"36"}}},default:"Attachments"}}},81336:(e,t,o)=>{"use strict";o.d(t,{o:()=>i});class i{constructor(e){this._rpc=e,this._subscribedTables=new Set}subscribeTable(e){return this._subscribedTables.add(e),Promise.resolve()}unsubscribeTable(e){return this._subscribedTables.delete(e),Promise.resolve()}process(e){const t=e[1];if(!this._subscribedTables.has(t))return Promise.resolve();switch(e[0]){case"RemoveTable":this._subscribedTables.delete(t);break;case"RenameTable":this._subscribedTables.delete(t),this._subscribedTables.add(e[2])}return this._rpc.postMessage({type:"docAction",action:e})}}},549:(e,t,o)=>{"use strict";o.d(t,{$g:()=>r,QB:()=>l,Yo:()=>c,d:()=>d,dB:()=>s,eO:()=>n,r2:()=>a});const i=o(39898);function n(){return{tableRenames:[],tableDeltas:{}}}function s(){return{updateRows:[],removeRows:[],addRows:[],columnDeltas:{},columnRenames:[]}}function r(e){const t={};for(const[o,n]of i(e.tableDeltas)){const e=t[o]={header:[],cells:[]},s={},r=new Set;for(const[e,t]of i(n.columnDeltas)){r.add(e);for(const o of Object.keys(t))s[o]||(s[o]={}),s[o][e]=t[o]}const l=[...r].filter((e=>"manualSort"!==e));e.header=l;const a=new Set(n.addRows),c=new Set(n.removeRows),d=new Set(n.updateRows),u=Object.keys(s).map((e=>parseInt(e,10))),p=new Set(u),h=[...a,...c,...d].filter((e=>!p.has(e))).sort(((e,t)=>e-t));for(const t of u){if(h.length>0&&t>h[0])for(e.cells.push(["...",h[0],l.map((e=>[null,null]))]);t>h[0];)h.shift();const o=[];if(a.has(t)&&c.has(t))o.push(["-",e=>[e[0],null]]),o.push(["+",e=>[null,e[1]]]);else{let e="...";d.has(t)&&(e="→"),a.has(t)&&(e="+"),c.has(t)&&(e="-"),o.push([e,e=>e])}for(const[i,n]of o){const o=[],r=s[t];l.forEach((e=>{const t=r?r[e]:null;t?o.push(n(t)):o.push([null,null])})),e.cells.push([i,t,o])}}}return t}function l(e){return`-${e}`}function a(e){return[...e.tableRenames.map((e=>e[1]||l(e[0]||""))),...Object.keys(e.tableDeltas)]}function c(e,t){if(null===t)return t;const o=e.find((e=>e[1]===t));return o?o[0]:t}function d(e,t){if(null===t)return t;const o=e.find((e=>e[0]===t)),i=o?o[1]:t;return(null==i?void 0:i.startsWith("-"))?null:i}},48517:(e,t,o)=>{"use strict";function i(e){let t;return()=>{return t||((o=e.call(null)).catch((()=>{t=void 0})),t=o);var o}}function n(e,t,o){return e.get(t)||s(e,t,o(t))}function s(e,t,o){return o.catch((()=>e.delete(t))),e.set(t,o),o}o.d(t,{ND:()=>n,dh:()=>r,tJ:()=>i,uX:()=>s});class r extends Map{constructor(e){super(),this._ttlMs=e,this._timeouts=new Map}set(e,t){return this.setWithCustomTTL(e,t,this._ttlMs)}setWithCustomTTL(e,t,o){const i=this._timeouts.get(e);return i&&clearTimeout(i),super.set(e,t),this._timeouts.set(e,setTimeout(this.delete.bind(this,e),o)),this}delete(e){const t=super.delete(e),o=this._timeouts.get(e);return o&&(clearTimeout(o),this._timeouts.delete(e)),t}clear(){for(const e of this._timeouts.values())clearTimeout(e);this._timeouts.clear(),super.clear()}}},91655:(e,t,o)=>{"use strict";o.d(t,{o:()=>d,v:()=>u});var i=o(34903),n=o(93965),s=o(68652),r=o.n(s),l=o(631),a=o(75083),c=o(32275);function d(e,t=""){if((0,i.xX)(e)){let{min:o,max:i}=e;if((0,l.isNumberType)(t)||(0,l.isDateLikeType)(t)){if((0,l.isDateLikeType)(t)){const e=(0,l.extractInfoFromColType)(t),n="DateTime"===e.type&&e.timezone||"utc";o=p(o,n,(e=>e.startOf("day"))),i=p(i,n,(e=>e.endOf("day")))}return e=>"number"==typeof e&&(void 0===i||e<=i)&&(void 0===o||o<=e)}return()=>!0}const{include:o,values:s}=e;return e=>{if((0,l.isList)(e)&&t&&(0,l.isListType)(t)){const i=(0,n.xD)(e);if(i.length)return i.some((e=>s.has(e)===o));e="ChoiceList"===t?"":null}return s.has(Array.isArray(e)?JSON.stringify(e):e)===o}}function u(e,t){return e?d((0,i.nR)(e),t):null}function p(e,t,o=c.noop){if(void 0===e)return;const i=(0,a.CV)(e)?(0,a.ZW)(e):e,n=r().tz(1e3*i,t);return o(n),Math.floor(n.valueOf()/1e3)}},21296:(e,t,o)=>{"use strict";o.d(t,{Z:()=>n,u:()=>i});var i=(e=>(e.none="none",e.read_table="read table",e.full="full",e))(i||{});function n(e,t){function o(e){switch(e){case"none":return 0;case"read table":return 1;case"full":return 2;default:throw new Error(`Unrecognized access level ${e}`)}}return o(e)>=o(t)}},9072:(e,t,o)=>{"use strict";o.d(t,{G:()=>s});var i=o(86277),n=o(1310);class s extends n.Disposable{constructor(){super(),this.onDispose(this.stopListening,this)}}Object.assign(s.prototype,i.Events)},34903:(e,t,o)=>{"use strict";o.d(t,{CV:()=>i.CV,nR:()=>n,oz:()=>s,t0:()=>l,xX:()=>r});var i=o(75083);function n(e){return"string"==typeof e?n(e&&JSON.parse(e)||{}):void 0!==e.min||void 0!==e.max?{min:e.min,max:e.max}:{include:Boolean(e.included),values:new Set(e.included||e.excluded||[])}}function s(e,t){const o=n(t);if(r(e)||r(o)){if(!r(e)||!r(o))return!1;if(e.min!==o.min||e.max!==o.max)return!1}else{if(e.include!==o.include)return!1;if(e.values.size!==o.values.size)return!1;if(o.values)for(const t of o.values)if(!e.values.has(t))return!1}return!0}function r(e){const{min:t,max:o}=e;return void 0!==t||void 0!==o}function l(e,t){return(0,i.CV)(e)&&(0,i.CV)(t)?(0,i.u7)(e,t):!(0,i.CV)(e)&&!(0,i.CV)(t)&&e===t}},99597:(e,t,o)=>{"use strict";o.d(t,{LX:()=>d,QS:()=>r,y6:()=>a,zC:()=>l});var i=o(83277),n=o(45689),s=o(17933);const r=(0,n.U)("currency","decimal","percent","scientific");function l(e,t){var o;return e.currency||t.currency||s.z(null!=(o=t.locale)?o:"en-US")}function a(e,t){const o=l(e,t),n=d(e.numMode,o);void 0!==e.decimals&&null!==e.decimals&&(n.minimumFractionDigits=(0,i.clamp)(Number(e.decimals),0,20));const s=new Intl.NumberFormat(t.locale,n).resolvedOptions();return void 0!==e.maxDecimals&&null!==e.maxDecimals?n.maximumFractionDigits=(0,i.clamp)(Number(e.maxDecimals),s.minimumFractionDigits||0,20):e.numMode||(n.maximumFractionDigits=(0,i.clamp)(10,s.minimumFractionDigits||0,20)),new Intl.NumberFormat(t.locale,n)}const c=function(){try{return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",currencyDisplay:"narrowSymbol"}),"narrowSymbol"}catch(e){return"symbol"}}();function d(e,t){switch(e){case"currency":return{style:"currency",currency:t,currencyDisplay:c};case"decimal":return{useGrouping:!0};case"percent":return{style:"percent"};case"scientific":return{notation:"scientific"};default:return{useGrouping:!1}}}},50590:(e,t,o)=>{"use strict";o.d(t,{Z:()=>a});var i=o(83277),n=o(99597);const s=o(41469),r=o(97322),l=class{static fromSettings(e,t={}){return new l(e.locale,(0,n.zC)(t,e))}constructor(e,t){var o;const i=new Map;for(const o of n.QS.values){const s=Intl.NumberFormat(e,(0,n.LX)(o,t)).formatToParts(-1234567.5678);i.set(o,s)}function l(e,t="decimal"){const o=i.get(t).find((t=>t.type===e));return(null==o?void 0:o.value)||""}this.currencySymbol=l("currency","currency"),this.percentageSymbol=l("percentSign","percent"),this.exponentSeparator=l("exponentSeparator","scientific"),this.minusSign=l("minusSign"),this.decimalSeparator=l("decimal"),this.digitGroupSeparator=l("group"),this.digitGroupSeparatorCurrency=l("group","currency"),this.currencyEndsInMinusSign="minusSign"===r(i.get("currency")).type,this.defaultNumDecimalsCurrency=(null==(o=l("fraction","currency"))?void 0:o.length)||0,this._exponentSeparatorRegex=new RegExp(s(this.exponentSeparator),"i"),this._digitGroupSeparatorRegex=new RegExp(`[${s(this.digitGroupSeparator+this.digitGroupSeparatorCurrency)}](\\d\\d)`,"g");const a=this.digitsMap=function(e){const t=Intl.NumberFormat(e),o=new Map;for(let e=0;e<10;e++){const i=String(e),n=t.format(e);n!==i&&o.set(n,i)}return o}(e);if(0===a.size)this._replaceDigits=e=>e;else{const e=new RegExp([...a.keys()].join("|"),"g");this._replaceDigits=t=>t.replace(e,(e=>a.get(e)||e))}}parse(e){const[t,o]=c(e,this.currencySymbol),[i,n]=c(t,this.percentageSymbol),s="("===(e=i.replace(l.removeCharsRegex,""))[0]&&")"===e[e.length-1];if(s&&(e=e.substring(1,e.length-1)),""===e)return null;const r=e!==(e=e.replace(this._exponentSeparatorRegex,"e")),a=(e=this._replaceDigits(e))!==(e=e.replace(this._digitGroupSeparatorRegex,"$1"));e=(e=(e=e.replace(this.decimalSeparator,".")).replace(this.minusSign,"-")).replace(this.minusSign,"-"),o&&this.currencyEndsInMinusSign&&e.endsWith("-")&&(e="-"+e.substring(0,e.length-1));let d=Number(e);if(isNaN(d))return null;if(s){if(d<=0)return null;d=-d}return n&&(d*=.01),{result:d,cleaned:e,options:{isCurrency:o,isPercent:n,isParenthesised:s,hasDigitGroupSeparator:a,isScientific:r}}}guessOptions(e){let t=null,o=!1,s=0;const r=/\.\d+/;let l=0;const a={};for(const e of n.QS.values)a[e]=0;for(const n of(0,i.getDistinctValues)(e)){if(!n)continue;const e=this.parse(n);if(!e)continue;const{result:i,cleaned:c,options:{isCurrency:d,isPercent:u,isParenthesised:p,hasDigitGroupSeparator:h,isScientific:m}}=e;i<0&&!p?t=!1:null===t&&p&&(t=!0),o=o||h;let f="decimal";d?f="currency":u?f="percent":m&&(f="scientific"),a[f]+=1;const g=r.exec(c);if(g){const e=g[0].length-1;l=Math.max(l,e),g[0].endsWith("0")&&(s=Math.max(s,e))}}const c=Math.max(...Object.values(a));if(0===c)return{};const d={},u=n.QS.values.find((e=>a[e]===c));return("decimal"!==u||o)&&(d.numMode=u),t&&(d.numSign="parens"),(s>0||"currency"===u&&l<this.defaultNumDecimalsCurrency)&&(d.decimals=s),d}};let a=l;function c(e,t){const o=e.replace(t,"");return[o,o.length<e.length]}a.removeCharsRegex=/[\s\u200e\u200f\u061c]/g},55688:(e,t,o)=>{"use strict";o.d(t,{$o:()=>c,GO:()=>a,H6:()=>s,dl:()=>r});var i=o(45353),n=o(87479);class s{constructor(e,t){this._logger=t,this._activated=!1;const o=e.components.deactivate,i=o&&o.inactivitySec?o.inactivitySec:300;this.inactivityTimer=new n.w((()=>this.deactivate()),1e3*i)}activated(){return this._activated}async activate(){this._logger.info&&this._logger.info("Activating plugin component"),await this.activateImplementation(),this._activated=!0,this.inactivityTimer.enable()}async deactivate(){if(this._activated){this._logger.info&&this._logger.info("Deactivating plugin component"),this._activated=!1,this.inactivityTimer.disable();try{await this.deactivateImplementation()}catch(e){this._logger.warn&&this._logger.warn(`Deactivate failed: ${e.message}`)}}}async forwardCall(e){return this._activated||await this.activate(),await this.inactivityTimer.disableUntilFinish(this.doForwardCall(e))}async forwardMessage(e){this._activated||await this.activate(),this.inactivityTimer.ping(),this.doForwardMessage(e)}}class r{constructor(e,t){this.definition=e,this._renderTargets=new Map,this._nextRenderTargetId=0;const o=this.rpc=new i.Rpc({logger:t});o.setSendMessage((e=>o.receiveMessage(e))),this._renderTargets.set("fullscreen",l)}getStub(e,t){const o=this.definition.manifest.components[e.component];return this.rpc.getStubForward(o,e.name,t)}async shutdown(){await Promise.all([this.safeBrowser&&this.safeBrowser.deactivate(),this.safePython&&this.safePython.deactivate(),this.unsafeNode&&this.unsafeNode.deactivate()])}addRenderTarget(e){const t=this._nextRenderTargetId++;return this._renderTargets.set(t,e),t}getRenderTarget(e,t){const o=this._renderTargets.get(e);if(!o)throw new Error(`Unknown render target ${e}`);return(e,i)=>o(e,i||t)}removeRenderTarget(e){return this._renderTargets.delete(e)}}function l(e){e.classList.add("plugin_instance_fullscreen"),document.body.appendChild(e)}function a(e,t){const o=e.debug||e.log,i=e.warn;return{warn:i&&(e=>i("%s %s",t,e)),info:o&&(e=>o("%s %s",t,e))}}function c(e,t,o){if(!e._logger.warn)return;const n=setTimeout((()=>e._logger.warn(o)),t),s=e._dispatch;e._dispatch=t=>{t.mtype===i.MsgType.Ready&&clearTimeout(n),s.call(e,t)}}},75083:(e,t,o)=>{"use strict";o.d(t,{CV:()=>a,QG:()=>m,U4:()=>u,ZW:()=>c,iv:()=>d,u7:()=>h,zr:()=>l});var i=o(32275),n=o(68652),s=o.n(n),r=o(88918);const l=[{quantity:0,unit:"day"}];function a(e){return!(0,i.isUndefined)(e)&&!(0,i.isNumber)(e)}function c(e){const t=(0,r.Z)().startOf("day"),o=s().utc(t.toObject()),i=Array.isArray(e)?e:[e];for(const e of i){const{quantity:t,unit:i,endOf:n}=e;o.add(t,i),n?(o.endOf(i),o.startOf("day")):o.startOf(i)}return Math.floor(o.valueOf()/1e3)}function d(e){var t;if(1===(e=(null==(t=e[1])?void 0:t.quantity)?e:[e[0]]).length){const{quantity:t,unit:o,endOf:i}=e[0];return"day"===o?0===t?"Today":-1===t?"Yesterday":1===t?"Tomorrow":p(e[0]):i?`Last day of ${p(e[0])}`:`1st day of ${p(e[0])}`}if(2===e.length){let t=e[1].quantity;e[0].endOf&&(t-=1);let o="";return"week"===e[0].unit&&(0===e[1].quantity?o="start ":6===e[1].quantity&&(o="end ")),`${function(e,t){if("week"===t)return["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][(e+7)%7];const o=e=>s().localeData().ordinal(e);return e<0?-1===e?"Last day":`${o(-e)} to last day`:`${o(e+1)} day`}(t,e[0].unit)} ${o}of ${p(e[0])}`}throw new Error(`Relative date spec does not support more that 2 periods: ${e.length}`)}function u(e,t){return s().unix(e).utc().tz(t,!0).unix()}function p(e){const{quantity:t,unit:o}=e;if(0===t)return`this ${o}`;if(-1===t)return`last ${o}`;if(1===t)return`next ${o}`;const i=Math.abs(t);return`${i} ${o}${i>1?"s":""} ${t<1?"ago":"from now"}`}function h(e,t){e=Array.isArray(e)?e:[e],t=Array.isArray(t)?t:[t],2===e.length&&0===e[1].quantity&&(e=[e[0]]),2===t.length&&0===t[1].quantity&&(t=[t[0]]);const o=e.map((e=>(0,i.omitBy)(e,i.isUndefined))),n=t.map((e=>(0,i.omitBy)(e,i.isUndefined)));return(0,i.isEqual)(o,n)}function m(e,t,o){return e.clone().startOf(o).diff(t.clone().startOf(o),o)}},43967:(e,t,o)=>{"use strict";o.d(t,{O:()=>r,X:()=>s});var i=o(631),n=o(93965);function s(e,t){return e&&t?o=>t(e(o)):()=>!0}function r(e,{filters:t,operations:o}){const s=Object.keys(t).sort().map((s=>{const r=e.getColGetterByColId(s);if(!r)return()=>!0;const l=new Set(t[s]);switch(o[s]){case"intersects":return e=>{const t=r(e);return(0,i.isList)(t)&&(0,n.xD)(t).some((e=>l.has(e)))};case"empty":return e=>{const t=r(e);return!t||(0,i.isList)(t)&&1===t.length};case"in":return e=>l.has(r(e))}}));return e=>s.every((t=>t(e)))}},11579:(e,t,o)=>{"use strict";o.r(t),o.d(t,{SortFunc:()=>d,choiceGetter:()=>s,emptyCompare:()=>a,typedCompare:()=>c});var i=o(83277),n=o(48210);function s(e,t){return o=>{const i=e(o),n=t.indexOf(i);return n>=0?String(n).padStart(5,"0"):i}}const r=new Intl.Collator(void 0,{numeric:!0});function l(e,t){return"string"==typeof e&&"string"==typeof t?r.compare(e,t):c(e,t)}const a=e=>(t,o)=>{const i=!t&&"number"!=typeof t,n=!o&&"number"!=typeof o;return i&&!n?1:n&&!i?-1:e(t,o)};function c(e,t){let o,n,s;if(0!==(o=(0,i.nativeCompare)(n=typeof e,typeof t)))return o;if("object"===n){if(0!==(o=(0,i.nativeCompare)(s=e instanceof Array,t instanceof Array)))return o;if(s)return function(e,t){for(let o=0;o<e.length;o++){if(o>=t.length)return 1;const i=c(e[o],t[o]);if(i)return i}return e.length===t.length?0:-1}(e,t)}return"string"===n?(0,i.localeCompare)(e,t):(0,i.nativeCompare)(e,t)}class d{constructor(e){this._getters=e,this._colGetters=[],this._directions=[],this._comparators=[]}updateSpec(e){this._colGetters=e.map((e=>this._getters.getColGetter(e))).filter((e=>e)),this._directions=e.map((e=>n.Sort.direction(e))),this._comparators=e.map((e=>{const t=n.Sort.specToDetails(e);let o=c;return t.naturalSort&&(o=l),t.emptyLast&&(o=a(o)),o}));const t=this._getters.getManualSortGetter();t&&(this._colGetters.push(t),this._directions.push(1),this._comparators.push(c))}compare(e,t){for(let o=0,i=this._colGetters.length;o<i;o++){const i=this._colGetters[o],n=i(e),s=i(t),r=(0,this._comparators[o])(n,s);if(0!==r)return r*this._directions[o]}return(0,i.nativeCompare)(e,t)}}},48210:(e,t,o)=>{"use strict";o.r(t),o.d(t,{Sort:()=>i});var i,n=Object.defineProperty,s=Object.defineProperties,r=Object.getOwnPropertyDescriptors,l=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,c=Object.prototype.propertyIsEnumerable,d=(e,t,o)=>t in e?n(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,u=(e,t)=>{for(var o in t||(t={}))a.call(t,o)&&d(e,o,t[o]);if(l)for(var o of l(t))c.call(t,o)&&d(e,o,t[o]);return e},p=(e,t)=>s(e,r(t));(e=>{e.ASC=1,e.DESC=-1;const t=-1;function o(t){const o=`${t.direction===e.ASC?"":"-"}${t.colRef}`,i=[];return t.emptyLast&&i.push("emptyLast"),t.naturalSort&&i.push("naturalSort"),t.orderByChoice&&i.push("orderByChoice"),i.length?o+(i.length?":":"")+i.join(";"):+o}function i(t){return"number"==typeof t?{colRef:Math.abs(t),direction:t>=0?e.ASC:e.DESC}:n(t)}function n(t){const o=t.match(/^(-)?(\d+)(:([\w\d;]+))?$/);if(!o)throw new Error("Error parsing sort expression "+t);const[,i,n,,s]=o,r=null==s?void 0:s.split(";");return{colRef:+n,direction:"-"===i?e.DESC:e.ASC,orderByChoice:null==r?void 0:r.includes("orderByChoice"),emptyLast:null==r?void 0:r.includes("emptyLast"),naturalSort:null==r?void 0:r.includes("naturalSort")}}function s(e){return"number"==typeof e?Math.abs(e):n(e).colRef}function r(e,t){return"number"==typeof e?Math.abs(e)*t:o(p(u({},n(e)),{direction:t}))}function l(e,t,o){const i=m(e,t);return!!i&&s(i)===s(t)&&c(i)===o}function a(t){return"number"==typeof t?t>=0:n(t).direction===e.ASC}function c(t){return a(t)?e.ASC:e.DESC}function d(e,t){return s(e)===s(t)}function h(e,t){return e.findIndex((e=>d(e,t)))}function m(e,t){return e.find((e=>d(e,t)))}function f(t){if("number"==typeof t)return-t;const i=n(t);return o(p(u({},i),{direction:i.direction===e.ASC?e.DESC:e.ASC}))}e.hasOptions=function(e){if("number"==typeof e)return!1;const t="object"!=typeof e?i(e):e;return Boolean(t.emptyLast||t.naturalSort||t.orderByChoice)},e.detailsToSpec=o,e.specToDetails=i,e.getColRef=s,e.swap=function(e,o,i){const n=h(e,o),s=h(e,i);if(n===t||s===t)throw new Error(`Column expressions can be found (${o} or ${i})`);const r=e.slice();return r[n]=e[s],r[s]=e[n],r},e.setColDirection=r,e.createColSpec=function(e,t){return e*t},e.contains=l,e.containsOnly=function(e,t,o){return 1===e.length&&l(e,t,o)},e.isAscending=a,e.direction=c,e.sameColumn=d,e.swapColRef=function(e,t){if("number"==typeof e)return e>=0?t:-t;const i=n(e);return o(p(u({},i),{colRef:t}))},e.findColIndex=h,e.removeCol=function(e,t){return e.filter((e=>s(e)!==s(t)))},e.findCol=m,e.replace=function(e,t,i){const n=h(e,t);if(n>=0){const t=e.slice();return t[n]="object"==typeof i?o(i):i,t}return e},e.flipCol=f,e.flipSort=function(e,o){const i=h(e,s(o));if(i!==t){const t=Array.from(e);return t[i]=f(t[i]),t}return e},e.setSortDirection=function(e,o,i){const n=h(e,s(o));if(n!==t){const t=Array.from(e);return t[n]=r(t[n],i),t}return e},e.parseSortColRefs=function(e){try{return JSON.parse(e)}catch(e){return[]}},e.reorderSortRefs=function(e,o,i){const n=e.slice(),s=h(n,o);if(s===t)return e;n.splice(s,1);const r=i?h(n,i):n.length;return r===t?e:(n.splice(r,0,o),n)},e.parseNames=function(e,t){const o=/^(-)?([\w]+)(:.+)?/;return e.map((e=>{const i=e.match(o);if(!i)throw new Error(`unknown key ${e}`);const[,n,s,r]=i;let l=Number(s);if(isNaN(l)){if(!t.has(s))throw new Error(`unknown key ${s}`);l=t.get(s)}else if(![...t.values()].includes(l))throw new Error(`invalid column id ${s}`);return`${n||""}${l}${null!=r?r:""}`}))}})(i||(i={}))},11486:(e,t,o)=>{"use strict";o.d(t,{EF:()=>A,SP:()=>O,Ss:()=>D,cT:()=>x,ku:()=>M,o6:()=>E});var i=o(65552),n=o(631),s=o(83277),r=o(33444),l=o(99597),a=o(48807),c=o(6263),d=o(93965),u=o(68652),p=o.n(u),h=Object.defineProperty,m=Object.defineProperties,f=Object.getOwnPropertyDescriptors,g=Object.getOwnPropertySymbols,b=Object.prototype.hasOwnProperty,v=Object.prototype.propertyIsEnumerable,y=(e,t,o)=>t in e?h(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,_=(e,t)=>{for(var o in t||(t={}))b.call(t,o)&&y(e,o,t[o]);if(g)for(var o of g(t))v.call(t,o)&&y(e,o,t[o]);return e};const w=o(99451);function x(e){return D((0,d.xD)(e))}function C(e){return e.some((e=>"object"==typeof e&&e&&(Array.isArray(e)||w(e))))}function D(e,t=!0){if("object"==typeof e&&e){if(Array.isArray(e))return!t||C(e)?"["+e.map((e=>D(e,!1))).join(", ")+"]":(0,i.cw)(e.map((e=>D(e,!0))),{prettier:!0});if(w(e)){const t=e;return"{"+Object.keys(t).map((e=>`${JSON.stringify(e)}: ${D(t[e],!1)}`)).join(", ")+"}"}return t&&e instanceof d.wc?p()(e).tz(e.timezone).format("YYYY-MM-DD HH:mm:ssZ"):String(e)}return t?null==e?"":String(e):JSON.stringify(e)}class S{constructor(e,t,o){this.type=e,this.widgetOpts=t,this.docSettings=o,this.isRightType=n.isRightType(n.extractTypeFromColType(e))||n.isRightType("Any")}formatAny(e,t){return this.isRightType(e)?this.format(e,t):x(e)}format(e,t){return String(e)}}class k extends S{format(e){return x(e)}}class T extends S{constructor(e,t,o){super(e,t,o),this._numFormat=(0,l.y6)(t,o),this._formatter="parens"===t.numSign?this._formatParens:this._formatPlain}format(e){return null===e?"":this._formatter(e)}_formatPlain(e){return this._numFormat.format(e)}_formatParens(e){return e>=0?` ${this._numFormat.format(e)} `:`(${this._numFormat.format(-e)})`}}class I extends S{constructor(e,t,o,i="UTC"){super(e,t,o),this.isRightType=e=>null===e||"number"==typeof e||Array.isArray(e)&&(e[0]===c.w.Date||e[0]===c.w.DateTime),this._dateTimeFormat=t.dateFormat||"YYYY-MM-DD",this._timezone=i}format(e){if(null===e)return"";let t=this._timezone;return Array.isArray(e)&&(t=e[2]||t,e=e[1]),p().tz(1e3*e,t).format(this._dateTimeFormat)}}class R extends S{constructor(e,t,o){super(e,t,o),this.visibleColFormatter=t.visibleColFormatter||O("Id",{tableId:(0,n.getReferencedTableId)(e)},o)}formatAny(e){var t,o;return Array.isArray(e)&&e[0]===c.w.Exception&&"InvalidTypedValue"===e[1]&&(null==(o=null==(t=e[2])?void 0:t.startsWith)?void 0:o.call(t,"Ref"))?e[3]:this.formatNotInvalidRef(e)}formatNotInvalidRef(e){return this.visibleColFormatter.formatAny(e)}}const F={Numeric:T,Int:class extends T{constructor(e,t,o){super(e,_({decimals:0},t),o)}},Bool:class extends S{format(e,t){return"boolean"==typeof e&&t?t(String(e)):super.format(e,t)}},Date:I,DateTime:class extends I{constructor(e,t,o){super(e,t,o,s.removePrefix(e,"DateTime:")||"");const i=void 0===t.timeFormat?"h:mma":t.timeFormat;this._dateTimeFormat=(t.dateFormat||"YYYY-MM-DD")+" "+i}},Ref:R,RefList:class extends R{formatNotInvalidRef(e){if(!(0,n.isList)(e)||C((0,d.xD)(e)))return x(e);const t=e.slice(1).map((e=>super.formatNotInvalidRef(e)));return(0,i.cw)(t,{prettier:!0})}},Id:class extends S{format(e){return e>0?`${this.widgetOpts.tableId}[${e}]`:""}}};function O(e,t,o){return new(F[n.extractTypeFromColType(e)]||k)(e,t,o)}function E(e,t,o){const[i,n,s]=(0,a.Ci)(e,t,o),{visibleColType:r,visibleColWidgetOpts:l}=n;return A({docData:e,type:i,widgetOpts:n,visibleColType:r,visibleColWidgetOpts:l,docSettings:s})}function A(e){const{type:t,widgetOpts:o,docSettings:i}=e,n=M(e);return O(t,(s=_({},o),m(s,f({visibleColFormatter:n}))),i);var s}function M({docData:e,docSettings:t,type:o,visibleColType:i,visibleColWidgetOpts:s,widgetOpts:l}){let a=n.getReferencedTableId(o);if(a){if(i)return O(i,s,t);{const o=e.getMetaTable("_grist_Tables"),i=o.findRow("tableId",a);return(0,r.Pr)(o,i)&&(a=""),O("Id",{tableId:a},t)}}return O(o,l,t)}},48807:(e,t,o)=>{"use strict";o.d(t,{Ci:()=>T,EC:()=>x,_1:()=>R,eT:()=>S,jo:()=>k,r2:()=>I});var i=o(65552),n=o(631),s=o(83277),r=o(50590),l=o(62862),a=o(11486),c=o(93965),d=Object.defineProperty,u=Object.defineProperties,p=Object.getOwnPropertyDescriptors,h=Object.getOwnPropertySymbols,m=Object.prototype.hasOwnProperty,f=Object.prototype.propertyIsEnumerable,g=(e,t,o)=>t in e?d(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;const b=o(16914),v=o(87604);class y{constructor(e,t,o){this.type=e,this.widgetOpts=t,this.docSettings=o}cleanParse(e){var t;return e&&null!=(t=this.parse(e))?t:e}parse(e){return e}}class _ extends y{}class w extends y{constructor(e,t,o){super(e,t,o),this._parse=r.Z.fromSettings(o,t)}parse(e){var t,o;return null!=(o=null==(t=this._parse.parse(e))?void 0:t.result)?o:null}}class x extends y{constructor(){super(...arguments),this.tableData=this.widgetOpts.tableData,this.visibleColParser=S(this.widgetOpts.visibleColType,this.widgetOpts.visibleColWidgetOpts,this.docSettings),this._visibleColId=this.widgetOpts.visibleColId}parse(e){const t=this.visibleColParser.cleanParse(e);return this.lookup(t,e)}lookup(e,t){var o;if(null==e||""===e||!t)return 0;if("id"===this._visibleColId){const o=Number(e);if(!Number.isInteger(o))return t;e=o}if(!(null==(o=this.tableData)?void 0:o.isLoaded)){const o={column:this._visibleColId};return e!==t&&(o.raw=t),["l",e,o]}return this.tableData.findMatchingRowId({[this._visibleColId]:e})||t}}class C extends x{parse(e){var t;let o;try{o=JSON.parse(e)}catch(e){o=null}if(Array.isArray(o)||(o=(0,i._0)(e)),o=o.map((e=>"string"==typeof e?this.visibleColParser.cleanParse(e):(0,c.Cx)(e))),!o.length||!e)return null;if("id"===this._visibleColId){const t=o.map(Number);if(!t.every(Number.isInteger))return e;o=t}if(!(null==(t=this.tableData)?void 0:t.isLoaded)){const t={column:this._visibleColId};return 1===o.length&&o[0]===e||(t.raw=e),["l",o,t]}const n=[];for(const t of o){const o=this.tableData.findMatchingRowId({[this._visibleColId]:t});if(!o)return e;n.push(o)}return["L",...n]}}const D={Numeric:w,Int:w,Date:class extends y{parse(e){return(0,l.parseDateStrict)(e,this.widgetOpts.dateFormat)}},DateTime:class extends y{constructor(e,t,o){super(e,t,o);const i=s.removePrefix(e,"DateTime:")||"";var n;this.widgetOpts=(n=((e,t)=>{for(var o in t||(t={}))m.call(t,o)&&g(e,o,t[o]);if(h)for(var o of h(t))f.call(t,o)&&g(e,o,t[o]);return e})({},t),u(n,p({timezone:i})))}parse(e){return(0,l.parseDateTime)(e,this.widgetOpts)}},ChoiceList:class extends y{cleanParse(e){e=e.trim();const t=(this._parseJson(e)||this._parseCsv(e)).map((e=>e.trim())).filter((e=>e));return t.length?["L",...t]:null}_parseJson(e){if("["===e[0]){const t=(0,s.safeJsonParse)(e,null);return null==t?void 0:t.filter((e=>e||0===e)).map((e=>(0,a.Ss)(e)))}}_parseCsv(e){return b(e.split(/[\n\r]+/),(e=>(0,i._0)(e).map((e=>e.trim()))))}},Ref:x,RefList:C,Attachments:C};function S(e,t,o){return new(D[n.extractTypeFromColType(e)]||_)(e,t,o)}function k(e,t,o){return S(...T(e,t,o))}function T(e,t,o){const i=e.getMetaTable("_grist_Tables_column"),n=e.getMetaTable("_grist_Views_section_field"),s=i.getRecord(t);let r=s;if(o){const e=n.getRecord(o);r=(null==e?void 0:e.widgetOptions)?e:s}return I(e,s.type,r.widgetOptions,r.visibleCol)}function I(e,t,o,i){const r=e.getMetaTable("_grist_Tables_column"),l=(0,s.safeJsonParse)(o,{});if((0,n.isFullReferencingType)(t)){const o=r.getRecord(i);l.visibleColId=(null==o?void 0:o.colId)||"id",l.visibleColType=null==o?void 0:o.type,l.visibleColWidgetOpts=(0,s.safeJsonParse)((null==o?void 0:o.widgetOptions)||"",{}),l.tableData=e.getTable((0,n.getReferencedTableId)(t))}return[t,l,e.docSettings()]}function R(e,t){switch(e[0]){case"AddRecord":case"UpdateRecord":return F(e,t,!1);case"BulkAddRecord":case"BulkUpdateRecord":case"ReplaceTableData":return F(e,t,!0);case"AddOrUpdateRecord":return e=F(e,t,!1,2),F(e,t,!1,3);case"BulkAddOrUpdateRecord":return e=F(e,t,!0,2),F(e,t,!0,3);default:return e}}function F(e,t,o,i){const n=(e=e.slice())[1];void 0===i&&(i=e.length-1);const s=e[i];return e[i]=function(e,t,o,i){const n=o.getMetaTable("_grist_Tables_column"),s=o.getMetaTable("_grist_Tables").findRow("tableId",e);return s?v(t,((e,t)=>{const r=n.findMatchingRowId({colId:t,parentId:s});if(!r)return e;const l=k(o,r);if(l instanceof _)return e;function a(e){return"string"==typeof e?l.cleanParse(e):e}return i?Array.isArray(e)?e.map(a):e:a(e)})):t}(n,s,t,o),e}},88918:(e,t,o)=>{"use strict";o.d(t,{Z:()=>s});var i=o(68652),n=o.n(i);function s(){const e=()=>n()();if("undefined"==typeof window||!window)return e();const t=new URLSearchParams(window.location.search);return t.has("currentTime")?n()(t.get("currentTime")||void 0):e()}},631:(e,t,o)=>{"use strict";o.r(t),o.d(t,{CellInfoType:()=>N,MANUALSORT:()=>r,RecalcWhen:()=>F,extractInfoFromColType:()=>d,extractTypeFromColType:()=>R,getDefaultForType:()=>c,getObjCode:()=>h,getReferencedTableId:()=>E,isCensored:()=>b,isDateLikeType:()=>B,isEmptyList:()=>C,isFullReferencingType:()=>$,isHiddenCol:()=>l,isList:()=>v,isListOrNull:()=>x,isListType:()=>M,isNumberType:()=>P,isObject:()=>p,isRaisedException:()=>m,isRefListType:()=>A,isReference:()=>y,isReferenceList:()=>_,isReferencing:()=>w,isRightType:()=>I,isSkip:()=>g,isValidRuleValue:()=>L,isVersions:()=>f,reencodeAsAny:()=>u,sequelizeToGristType:()=>O});var i=o(6263),n=o(83277);const s=o(18882),r="manualSort";function l(e){return e.startsWith("gristHelper_")||e===r}const a={Any:[null,"NULL"],Attachments:[null,"NULL"],Blob:[null,"NULL"],Bool:[!1,"0"],Choice:["","''"],ChoiceList:[null,"NULL"],Date:[null,"NULL"],DateTime:[null,"NULL"],Id:[0,"0"],Int:[0,"0"],ManualSortPos:[Number.POSITIVE_INFINITY,"1e999"],Numeric:[0,"0"],PositionNumber:[Number.POSITIVE_INFINITY,"1e999"],Ref:[0,"0"],RefList:[null,"NULL"],Text:["","''"]};function c(e,t={}){const o=R(e);return(a[o]||a.Any)[t.sqlFormatted?1:0]}function d(e){if("Attachments"===e)return{type:"RefList",tableId:"_grist_Attachments"};const t=e.indexOf(":"),[o,i]=-1===t?[e]:[e.slice(0,t),e.slice(t+1)];return"Ref"===o||"RefList"===o?{type:o,tableId:String(i)}:"DateTime"===o?{type:o,timezone:String(i)}:{type:o}}function u(e,t){if("number"==typeof e)switch(t.type){case"Date":return[i.w.Date,e];case"DateTime":return[i.w.DateTime,e,t.timezone];case"Ref":return[i.w.Reference,t.tableId,e]}return e}function p(e){return Array.isArray(e)}function h(e){return Array.isArray(e)?e[0]:null}function m(e){return h(e)===i.w.Exception}function f(e){return h(e)===i.w.Versions}function g(e){return h(e)===i.w.Skip}function b(e){return h(e)===i.w.Censored}function v(e){return Array.isArray(e)&&e[0]===i.w.List}function y(e){return Array.isArray(e)&&e[0]===i.w.Reference}function _(e){return Array.isArray(e)&&e[0]===i.w.ReferenceList}function w(e){return Array.isArray(e)&&(e[0]===i.w.ReferenceList||e[0]===i.w.Reference)}function x(e){return null===e||v(e)}function C(e){return Array.isArray(e)&&1===e.length&&e[0]===i.w.List}function D(e){return"number"==typeof e||"boolean"==typeof e}function S(e){return D(e)||null===e}const k=[i.w.Exception,i.w.Pending,i.w.Skip,i.w.Unmarshallable,i.w.Versions],T={Any:function(e){return!k.includes(h(e))},Attachments:x,Text:s,Blob:s,Int:S,Bool:function(e){return"boolean"==typeof e||1===e||0===e},Date:S,DateTime:S,Numeric:S,Id:D,PositionNumber:D,ManualSortPos:D,Ref:D,RefList:x,Choice:s,ChoiceList:x};function I(e){return T[e]}function R(e){if(!e)return e;const t=e.indexOf(":");return-1===t?e:e.slice(0,t)}var F=(e=>(e[e.DEFAULT=0]="DEFAULT",e[e.NEVER=1]="NEVER",e[e.MANUAL_UPDATES=2]="MANUAL_UPDATES",e))(F||{});function O(e){let t=e.length;const o=e.indexOf("(");t=o>0?o:t;const i=e.indexOf(" ");switch(t=i>0&&i<t?i:t,e.substring(0,t)){case"INTEGER":case"BIGINT":case"SMALLINT":case"INT":return"Int";case"NUMBER":case"FLOAT":case"DECIMAL":case"NUMERIC":case"REAL":case"DOUBLE":case"DOUBLE PRECISION":return"Numeric";case"BOOLEAN":case"TINYINT":return"Bool";case"STRING":case"CHAR":case"TEXT":case"UUID":case"UUIDV1":case"UUIDV4":case"VARCHAR":case"NVARCHAR":case"TINYTEXT":case"MEDIUMTEXT":case"LONGTEXT":case"ENUM":case"TIME":case"DATE":case"DATEONLY":case"DATETIME":case"NOW":return"Text";case"BLOB":case"TINYBLOB":case"MEDIUMBLOB":case"LONGBLOB":throw new Error("SQL type: `"+e+"` is currently unsupported");case"NONE":case"HSTORE":case"JSON":case"JSONB":case"VIRTUAL":case"ARRAY":case"RANGE":case"GEOMETRY":throw new Error("SQL type: `"+e+"` is currently untested");default:throw new Error("Unrecognized datatype: `"+e+"`")}}function E(e){return"Attachments"===e?"_grist_Attachments":(0,n.removePrefix)(e,"Ref:")||(0,n.removePrefix)(e,"RefList:")}function A(e){return"Attachments"===e||(null==e?void 0:e.startsWith("RefList:"))}function M(e){return"ChoiceList"===e||A(e)}function P(e){return["Numeric","Int"].includes(e||"")}function B(e){return"Date"===e||e.startsWith("DateTime")}function $(e){return e.startsWith("Ref:")||A(e)}function L(e){return null===e||"boolean"==typeof e}var N=(e=>(e[e.COMMENT=1]="COMMENT",e))(N||{})},33444:(e,t,o)=>{"use strict";function i(e,t){const o=e.getValue(t,"tableId");return!o||n(e,t)||o.startsWith("GristHidden_")}function n(e,t){return 0!==e.getValue(t,"summarySourceTable")}o.d(t,{$U:()=>n,Pr:()=>i})},62862:(e,t,o)=>{"use strict";o.r(t),o.d(t,{TWO_DIGIT_YEAR_THRESHOLD:()=>u,dateFormatOptions:()=>I,dateTimeWidgetOptions:()=>F,guessDateFormat:()=>k,guessDateFormats:()=>T,parseDate:()=>_,parseDateStrict:()=>w,parseDateTime:()=>x,timeFormatOptions:()=>R});var i=o(83277),n=o(76466),s=o.n(n),r=o(68652),l=o.n(r);const a=o(41469),c=o(97322),d=o(28082),u=10,p=(new Date).getFullYear()+u-2e3;l().parseTwoDigitYear=function(e){const t=parseInt(e,10);return t+(t>p?1900:2e3)};const h=["M D YYYY","M D YY","M D","M","MMMM D YYYY","MMMM D","MMMM Do YYYY","MMMM Do","D MMMM YYYY","D MMMM","Do MMMM YYYY","Do MMMM","MMMM","MMM D YYYY","MMM D","MMM Do YYYY","MMM Do","D MMM YYYY","D MMM","Do MMM YYYY","Do MMM","MMM","YYYY M D","YYYY M","YYYY","D M YYYY","D M YY","D M","D"],m=["YYYY M D",...h.filter((e=>e.includes("MMM")))],f=/(?:^|\s+|T)(?:(\d\d?)(?::(\d\d?)(?::(\d\d?))?)?|(\d\d?)(\d\d))\s*([ap]m?)?$/i,g=/[^a-zA-Z](UTC?|GMT|Z)$/i,b=/([+-]\d\d?)(?::?(\d\d))?$/i,v=/[\W_]+/g,y=d((e=>{const t=[...new Set(l().tz.zone(e).abbrs.map(a))].join("|");return new RegExp(`[^a-zA-Z](${t})$`,"i")}));function _(e,t={}){if(!e)return null;const o=[...C(t.dateFormat||"YYYY-MM-DD",e),...h];let i=e.replace(v," ").trim(),n="",s=t.time;if(s){const e=D(s,t.timezone),o=S(e.remaining);if(!o||o.remaining)return null;s=o.time;const{tzOffset:r}=e;i+=" "+s+r,n=" HH:mm:ss"+(r?"Z":"")}for(const e of o){const o=e+n,s=l().tz(i,o,!0,t.timezone||"UTC");if(s.isValid())return s.valueOf()/1e3}return null}function w(e,t,o,i="UTC"){if(!e)return;const n=[...C(t=t||"YYYY-MM-DD",e),...m],s=e.replace(v," ").trim();for(const e of n){const t=l().tz(s,e,!0,i);if(t.isValid()){const e=t.valueOf()/1e3;if(!o)return e;o.add(e)}}}function x(e,t){if(!(e=e.trim()))return;const o=t.dateFormat||"YYYY-MM-DD",i=t.timezone||"UTC",n=w(e,o,void 0,i);if(n)return n;const s=D(e,i);let r="";s&&(r=s.tzOffset,e=s.remaining);const a=S(e);if(!a)return;const c=w(e=a.remaining,o);if(!c)return;e=l().unix(c).utc().format("YYYY-MM-DD")+" "+a.time+r;const d="YYYY-MM-DD HH:mm:ss"+(r?"Z":"");return l().tz(e,d,!0,i).valueOf()/1e3}function C(e,t){let o=e.replace(/MM+/g,(e=>"MM"===e?"M":e)).replace(/DD+/g,(e=>"DD"===e?"D":e)).replace(v," ").trim();o.includes("M")&&o.includes("D")&&!o.includes("Y")&&(o+=" YYYY"),o=function(e,t){var o,i;const n=/Y+|M+o?|D+o?|[a-zA-Z0-9]+/gi,s=(null==(o=e.match(n))?void 0:o.length)||0;let r=(null==(i=t.match(n))?void 0:i.length)||0;return r>s&&(/Y+/.test(t)&&(t=t.replace(/Y+/," ").trim(),r-=1),r>s&&(t=t.replace(/M+/," ").trim())),t}(t,o);const i=new Set([o]),n=o.replace(/Y{2,4}/,(e=>"YY"===e?"YYYY":"YYYY"===e?"YY":e));return i.add(n),i.add(o.replace(/MMM+/,"M")),n!==o&&i.add(n.replace(/MMM+/,"M")),i}function D(e,t){e=e.trim();let o=g.exec(e),i=0,n="";return o?(n="+00:00",i=o.index+1):(o=b.exec(e),o?(n=function(e){const[,t,o]=e;return t.slice(0,1)+t.slice(1).padStart(2,"0")+":"+(o||"0").padStart(2,"0")}(o),i=o.index):t&&(o=y(t).exec(e),o&&(i=o.index+1))),o&&(e=e.slice(0,i).trim()),{remaining:e,tzOffset:n}}function S(e){const t=f.exec(e);if(!t)return;let o=parseInt(t[1]||t[4],10);const i=(t[2]||t[5]||"0").padStart(2,"0"),n=(t[3]||"0").padStart(2,"0"),s=(t[6]||"").toLowerCase();o<12&&o>0&&s.startsWith("p")?o+=12:12===o&&s.startsWith("a")&&(o=0);const r=String(o).padStart(2,"0");return{remaining:e.slice(0,t.index).trim(),time:`${r}:${i}:${n}`}}function k(e,t="UTC"){const o=T(e,t);return o?c(o):"YYYY-MM-DD"}function T(e,t="UTC"){const o=e.filter(i.isNonNullish),n=(0,i.getDistinctValues)(o,100),r={};for(const e of n){let t;try{t=s()(e)}catch(e){continue}"string"==typeof t&&(t=[t]);for(const e of t)r[e]=0}const a=Object.keys(r);if(!a.length||a.length>10)return null;for(const e of a)for(const i of o)l().tz(i,e,!0,t).isValid()&&(r[e]+=1);const c=Math.max(...Object.values(r));return a.filter((e=>r[e]===c)).sort()}const I=["YYYY-MM-DD","MM-DD-YYYY","MM/DD/YYYY","MM-DD-YY","MM/DD/YY","DD MMM YYYY","MMMM Do, YYYY","DD-MM-YYYY"],R=["h:mma","h:mma z","HH:mm","HH:mm z","HH:mm:ss","HH:mm:ss z"];function F(e,t){const o=e.match(/[hHkaAmsSzZT]|$/).index,i=e.substr(0,o).trim(),n=e.substr(o).trim()||(t?R[0]:"");return{dateFormat:i,timeFormat:n,isCustomDateFormat:!I.includes(i),isCustomTimeFormat:!R.includes(n)}}},79801:(e,t,o)=>{"use strict";function i(e){return e.map((e=>e.map((e=>function(e){const t="string"==typeof e?e:null==e?"":String(e);return t.includes("\t")||t.includes("\n")?'"'+t.replace(/"/g,'""')+'"':t}(e))).join("\t"))).join("\n")}function n(e){const t=[];let o=[];const i=/(("([^"]*"")*[^"]*"(?!"))?[^\t\n]*)(\t|\n|$)/g;for(;;){const n=i.exec(e);if(!n)break;const s=n[4];let r=n[1];if(r.startsWith('"')&&(r=r.replace(/"([^"]*"")*[^"]*"(?!")/,(e=>e.slice(1,-1).replace(/""/g,'"')))),o.push(r),"\t"!==s&&(t.push(o),o=[],""===s))break}return t}o.r(t),o.d(t,{tsvDecode:()=>n,tsvEncode:()=>i})},85090:(e,t,o)=>{"use strict";o.d(t,{X:()=>i});const i="_grist_api"},6263:(e,t,o)=>{"use strict";o.d(t,{w:()=>i});var i=(e=>(e.List="L",e.LookUp="l",e.Dict="O",e.DateTime="D",e.Date="d",e.Skip="S",e.Censored="C",e.Reference="R",e.ReferenceList="r",e.Exception="E",e.Pending="P",e.Unmarshallable="U",e.Versions="V",e))(i||{})},18975:(e,t,o)=>{"use strict";o.d(t,{C4:()=>s});var i=o(77143);const n=[{ColumnToMap:i.iface([],{name:"string",title:i.opt(i.union("string","null")),description:i.opt(i.union("string","null")),type:i.opt("string"),optional:i.opt("boolean"),allowMultiple:i.opt("boolean")}),ColumnsToMap:i.array(i.union("string","ColumnToMap")),InteractionOptionsRequest:i.iface([],{requiredAccess:i.opt("string"),hasCustomOptions:i.opt("boolean"),columns:i.opt("ColumnsToMap"),allowSelectBy:i.opt("boolean")}),InteractionOptions:i.iface([],{accessLevel:"string"}),WidgetColumnMap:i.iface([],{[i.indexKey]:i.union("string",i.array("string"),"null")}),CustomSectionAPI:i.iface([],{configure:i.func("void",i.param("customOptions","InteractionOptionsRequest")),mappings:i.func(i.union("WidgetColumnMap","null"))})},{EditOptionsAPI:i.iface([],{getParseOptions:i.func("ParseOptions",i.param("parseOptions","ParseOptions",!0))}),ParseFileAPI:i.iface([],{parseFile:i.func("ParseFileResult",i.param("file","FileSource"),i.param("parseOptions","ParseOptions",!0))}),ParseOptions:i.iface([],{NUM_ROWS:i.opt("number"),SCHEMA:i.opt(i.array("ParseOptionSchema")),WARNING:i.opt("string")}),ParseOptionSchema:i.iface([],{name:"string",label:"string",type:"string",visible:"boolean"}),FileSource:i.iface([],{path:"string",origName:"string"}),ParseFileResult:i.iface(["GristTables"],{parseOptions:"ParseOptions"})},{UIRowId:i.union("number",i.lit("new")),CursorPos:i.iface([],{rowId:i.opt("UIRowId"),rowIndex:i.opt("number"),fieldIndex:i.opt("number"),sectionId:i.opt("number")}),ComponentKind:i.union(i.lit("safeBrowser"),i.lit("safePython"),i.lit("unsafeNode")),GristAPI:i.iface([],{render:i.func("number",i.param("path","string"),i.param("target","RenderTarget"),i.param("options","RenderOptions",!0)),dispose:i.func("void",i.param("procId","number")),subscribe:i.func("void",i.param("tableId","string")),unsubscribe:i.func("void",i.param("tableId","string"))}),GristDocAPI:i.iface([],{getDocName:i.func("string"),listTables:i.func(i.array("string")),fetchTable:i.func("any",i.param("tableId","string")),applyUserActions:i.func("any",i.param("actions",i.array(i.array("any"))),i.param("options","any",!0)),getAccessToken:i.func("AccessTokenResult",i.param("options","AccessTokenOptions"))}),GristView:i.iface([],{fetchSelectedTable:i.func("any"),fetchSelectedRecord:i.func("any",i.param("rowId","number")),allowSelectBy:i.func("void"),setSelectedRows:i.func("void",i.param("rowIds",i.union(i.array("number"),"null"))),setCursorPos:i.func("void",i.param("pos","CursorPos"))}),AccessTokenOptions:i.iface([],{readOnly:i.opt("boolean")}),AccessTokenResult:i.iface([],{token:"string",baseUrl:"string",ttlMsecs:"number"})},{GristTable:i.iface([],{table_name:i.union("string","null"),column_metadata:i.array("GristColumn"),table_data:i.array(i.array("any"))}),GristTables:i.iface([],{tables:i.array("GristTable")}),GristColumn:i.iface([],{id:"string",type:"string"}),APIType:i.enumtype({ImportSourceAPI:0,ImportProcessorAPI:1,ParseOptionsAPI:2,ParseFileAPI:3})},{ImportSourceAPI:i.iface([],{getImportSource:i.func(i.union("ImportSource","undefined"))}),ImportProcessorAPI:i.iface([],{processImport:i.func(i.array("GristTable"),i.param("source","ImportSource"))}),FileContent:i.iface([],{content:"any",name:"string"}),FileListItem:i.iface([],{kind:i.lit("fileList"),files:i.array("FileContent")}),URL:i.iface([],{kind:i.lit("url"),url:"string"}),ImportSource:i.iface([],{item:i.union("FileListItem","URL"),options:i.opt(i.union("string","Buffer")),description:i.opt("string")})},{InternalImportSourceAPI:i.iface([],{getImportSource:i.func(i.union("ImportSource","undefined"),i.param("inlineTarget","RenderTarget"))})},{RenderTarget:i.union(i.lit("fullscreen"),"number"),RenderOptions:i.iface([],{height:i.opt("string")})},{Storage:i.iface([],{getItem:i.func("any",i.param("key","string")),hasItem:i.func("boolean",i.param("key","string")),setItem:i.func("void",i.param("key","string"),i.param("value","any")),removeItem:i.func("void",i.param("key","string")),clear:i.func("void")})},{WidgetAPI:i.iface([],{getOptions:i.func(i.union("object","null")),setOptions:i.func("void",i.param("options",i.iface([],{[i.indexKey]:"any"}))),clearOptions:i.func("void"),setOption:i.func("void",i.param("key","string"),i.param("value","any")),getOption:i.func("any",i.param("key","string"))})}];void 0===o(13039).Buffer&&n.push({Buffer:new i.BasicType((e=>!1),"Buffer is not supported")}),function(e){const t=new Set;for(const o of e)for(const e of Object.keys(o)){if(t.has(e))throw new Error(`TypeCheckers: Duplicate type name ${e}`);t.add(e)}}(n);const s=(0,i.createCheckers)(...n)},93965:(e,t,o)=>{"use strict";o.d(t,{Cx:()=>m,Q8:()=>g,es:()=>c,wc:()=>r,xD:()=>f});var i=o(6263);const n=o(99451);class s extends Date{static fromGristValue(e){return new s(1e3*e)}toString(){return this.toISOString().slice(0,10)}}class r extends Date{static fromGristValue(e,t){return Object.assign(new r(1e3*e),{timezone:t})}toString(){return this.toISOString()}}class l{constructor(e,t){this.tableId=e,this.rowId=t}toString(){return`${this.tableId}[${this.rowId}]`}}class a{constructor(e,t){this.tableId=e,this.rowIds=t}toString(){return`${this.tableId}[[${this.rowIds}]]`}}class c{constructor(e){var t;if(!e.length)throw new Error("RaisedException requires a name as first element");e=[...e],this.name=e.shift(),this.message=e.shift(),this.details=e.shift(),this.user_input=null==(t=e.shift())?void 0:t.u}toString(){switch(this.name){case"ZeroDivisionError":return"#DIV/0!";case"UnmarshallableError":return this.details||"#"+this.name;case"InvalidTypedValue":return`#Invalid ${this.message}: ${this.details}`}return"#"+this.name}}class d{constructor(e){this.value=e}static safeRepr(e){try{return String(e)}catch(t){return`<${typeof e}>`}}toString(){return String(this.value)}}class u{toString(){return"Loading..."}}class p{toString(){return"..."}}class h{toString(){return"CENSORED"}}function m(e){try{switch(typeof e){case"string":case"number":case"boolean":return e}if(null==e)return null;if(e instanceof l)return[i.w.Reference,e.tableId,e.rowId];if(e instanceof a)return[i.w.ReferenceList,e.tableId,e.rowIds];if(e instanceof Date){const t=e.valueOf()/1e3;return"timezone"in e?[i.w.DateTime,t,e.timezone]:[i.w.DateTime,t,"UTC"]}if(e instanceof h)return[i.w.Censored];if(e instanceof c)return[i.w.Exception,e.name,e.message,e.details];if(Array.isArray(e))return[i.w.List,...e.map(m)];if(n(e))return[i.w.Dict,g(e,m,{sort:!0})]}catch(e){}return[i.w.Unmarshallable,d.safeRepr(e)]}function f(e){if(!Array.isArray(e))return e;const t=e[0],o=e.slice(1);let i;try{switch(t){case"D":return r.fromGristValue(o[0],String(o[1]));case"d":return s.fromGristValue(o[0]);case"E":return new c(o);case"L":return o.map(f);case"O":return g(o[0],f,{sort:!0});case"P":return new u;case"r":return new a(String(o[0]),o[1]);case"R":return new l(String(o[0]),o[1]);case"S":return new p;case"C":return new h;case"U":return new d(o[0])}}catch(e){i=e}return new d(`${t}(${JSON.stringify(o).slice(1,-1)})`+(i?`#${i.name}(${i.message})`:""))}function g(e,t,o={}){const i={},n=Object.keys(e);o.sort&&n.sort();for(const o of n)i[o]=t(e[o]);return i}},87056:(e,t,o)=>{var i=o(62802),n=o(54156);o(99102),o(54021),o(25081),o(30614);var{setupAceEditorCompletions:s}=o(50489),{getGristConfig:r}=o(36322),l=o(81294),a=o(88438),c=o(32529);function d(e){e=e||{},this.observable=e.observable||null,this.saveValueOnBlurEvent=!(!1===e.saveValueOnBlurEvent),this.calcSize=e.calcSize||((e,t)=>t),this.gristDoc=e.gristDoc||null,this.column=e.column||null,this.editorState=e.editorState||null,this._readonly=e.readonly||!1,this.editor=null,this.editorDom=null,this.session=null,this._setupCallback=null,this._setupTimer=null,this.textPadding=10}a.makeDisposable(d),d.prototype.buildDom=function(e){return this._fullDom=l("div.code_editor_container",this.editorDom=l("div")),this._setupCallback=e,this._setupTimer=setTimeout((()=>this._setup()),0),this._fullDom},d.prototype.onAttach=function(){this._setupTimer&&(clearTimeout(this._setupTimer),this._setupTimer=null,this._setup())},d.prototype.writeObservable=function(){this.observable&&c.setSaveValue(this.observable,this.getValue())},d.prototype.getEditor=function(){return this.editor},d.prototype.getValue=function(){return this.editor&&this.editor.getValue()},d.prototype.setValue=function(e,t){if(this.editor.setValue(e,0===t?-1:1),t>0&&t<e.length){var o=this.session.getDocument().indexToPosition(t);this.editor.moveCursorTo(o.row,o.column)}},d.prototype.isBuilt=function(){return null!==this.editor},d.prototype.enable=function(e){var t=this.editor;t.setReadOnly(!e),t.renderer.$cursorLayer.element.style.opacity=e?100:0,t.gotoLine(1/0,1/0)},d.prototype.attachCommandGroup=function(e){n.each(e.knownKeys,((t,o)=>{this.editor.commands.addCommand({name:t,readOnly:this._readonly,bindKey:{win:o,mac:o,sender:"editor|cli"},exec:()=>!e.commands[t]()})}))},d.prototype.attachSaveCommand=function(){if(!this.observable)throw new Error("Cannot attach save command to editor with no bound observable");this.editor.commands.addCommand({name:"saveFormula",bindKey:{sender:"editor|cli"},exec:()=>(this.writeObservable(),!0)})},d.prototype.adjustContentToWidth=function(){var e=this.editor.renderer.characterWidth,t=this.editor.renderer.scroller.clientWidth;t>0&&this.editor.getSession().setWrapLimit(parseInt(t/e,10)-1)},d.prototype.onChange=function(){this.editorState&&this.editorState.set(this.getValue()),this.resize()},d.prototype.setFontSize=function(e){this.editor.setFontSize(e),this.resize()},d.prototype._setup=function(){var e;if(this.editor=this.autoDisposeWith("destroy",i.edit(this.editorDom)),this.gristDoc&&this.column){const e=e=>{const t=this.gristDoc.viewModel.activeSection();if(!(null==t?void 0:t.getRowId()))return[];const o=t.table().tableId(),i=this.column.colId(),n=t.activeRowId();return this.gristDoc.docComm.autocomplete(e,o,i,n)};s(this.editor,{getSuggestions:e})}this.editor.setOptions({enableLiveAutocompletion:!0}),this.session=this.editor.getSession(),this.session.setMode("ace/mode/python");const t=null==(e=this.gristDoc)?void 0:e.currentTheme;if(this._setAceTheme(null==t?void 0:t.get()),!r().enableCustomCss&&t&&this.autoDispose(t.addListener((e=>{this._setAceTheme(e)}))),this.editor.renderer.setShowGutter(!1),this.session.setTabSize(2),this.session.setUseWrapMode(!0),this.editor.on("change",this.onChange.bind(this)),this.editor.$blockScrolling=1/0,this.editor.setFontSize(11),this.resize(),this.observable){var o=this.observable.subscribeInit((e=>{void 0!==e&&this.setValue(e)}));l(this.editorDom,l.autoDispose(o)),this.saveValueOnBlurEvent&&this.editor.on("blur",(()=>{this.writeObservable()}))}this._setupCallback&&(this._setupCallback.call(null,this.editor),this._setupCallback=null)},d.prototype.resize=function(){var e=this.session.getUseWrapMode(),t=e?0:this._getContentWidth(),o=this._getContentHeight(),i={width:e?0:t+this.textPadding,height:o},n=this.calcSize(this._fullDom,i);n.height<o&&(i.width+=20,n=this.calcSize(this._fullDom,i)),n.width<t&&(i.height+=20,n=this.calcSize(this._fullDom,i)),this.editorDom.style.width=n.width?Math.ceil(n.width)+"px":"auto",this.editorDom.style.height=n.height?Math.ceil(n.height)+"px":"auto",this.editor.resize()},d.prototype._getContentWidth=function(){return this.session.getScreenWidth()*this.editor.renderer.characterWidth},d.prototype._getContentHeight=function(){return Math.max(1,this.session.getScreenLength())*this.editor.renderer.lineHeight},d.prototype._setAceTheme=function(e){const{enableCustomCss:t}=r(),o="dark"!==(null==e?void 0:e.appearance)||t?"chrome":"dracula";this.editor.setTheme(`ace/theme/${o}`)};let u=null;d.makeRange=function(e,t,o,n){return u=u||i.require("ace/range").Range,new u(e,t,o,n)},e.exports=d},27601:(e,t,o)=>{var i=o(88438);function n(e){this.gristDoc=e,this._debugName=this.constructor.name+"["+n._nextObjectId+"]",this._eventNamespace=".Events_"+n._nextObjectId++,this._eventSources=[],this.autoDisposeCallback(this.clearEvents)}n._nextObjectId=1,n.setBaseFor=function(e){e.prototype=Object.create(n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),i.makeDisposable(e)},n.prototype.onEvent=function(e,t,o,i){"string"!=typeof o&&(i=o,o=null),-1===this._eventSources.indexOf(e)&&this._eventSources.push(e);var n=this;$(e).on(t+this._eventNamespace,o,(function(e){if(Array.prototype.unshift.call(arguments,this),n._eventSources)return i.apply(n,arguments)}))},n.prototype.clearEvent=function(e,t){$(e).off(t+this._eventNamespace)},n.prototype.clearEvents=function(){for(var e=this._eventSources,t=0;t<e.length;t++)$(e[t]).off(this._eventNamespace);this._eventSources.length=0},e.exports=n},30583:(e,t,o)=>{const i=o(54156),n=o(29301),s=o(68652),{nativeCompare:r,roundDownToMultiple:l,waitObs:a}=o(83277),c=o(83277),d=o(631).MANUALSORT,u=o(631),p=o(15323),{DataRowModel:h}=o(92517),{DynamicQuerySet:m}=o(25192),{SortFunc:f}=o(11579),g=o(3871),b=o(27601),{Cursor:v}=o(67931),y=o(86448),_=o(77709),w=o(86277).Events,{ClientColumnGetters:x}=o(6870),{reportError:C,reportSuccess:D}=o(92769),{urlState:S}=o(3988),{SectionFilter:k}=o(98548),{copyToClipboard:T}=o(85842),{setTestState:I}=o(80864),{ExtraRows:R}=o(89971),{createFilterMenu:F}=o(62905),{closeRegisteredMenu:O}=o(1370),{COMMENTS:E}=o(36258),{DismissedPopup:A}=o(56964),{markAsSeen:M}=o(30919),{buildConfirmDelete:P,reportUndo:B}=o(54292);function $(e,t,o){var i;if(b.call(this,e),this.options=o||{},this.viewSection=t,this._name=this.viewSection.titleDef.peek(),this.schemaModel=this.viewSection.table(),this.comparison=this.gristDoc.comparison,this.tableModel=this.gristDoc.getTableModelMaybeWithDiff(this.schemaModel.tableId()),this.extraRows=new R(this.schemaModel.tableId(),this.comparison&&this.comparison.details),this._queryRowSource=m.create(this,e.querySetManager,this.tableModel),this._mainRowSource=this._queryRowSource,this.comparison){const e=this.extraRows.getExtraRows();this._mainRowSource=g.ExtendedRowSource.create(this,this._mainRowSource,e)}this._sectionFilter=k.create(this,this.viewSection,this.tableModel.tableData),this._filteredRowSource=g.FilteredRowSource.create(this,this._sectionFilter.sectionFilterFunc.get()),this._filteredRowSource.subscribeTo(this._mainRowSource),this.autoDispose(this._sectionFilter.sectionFilterFunc.addListener((e=>{this._filteredRowSource.updateFilter(e)}))),this.rowSource=this._filteredRowSource,this.sortedRows=g.SortedRowSet.create(this,null,this.tableModel.tableData),this.sortFunc=new f(new x(this.tableModel,{unversioned:!0})),this.autoDispose(this.viewSection.activeDisplaySortSpec.subscribeInit((function(e){this.sortFunc.updateSpec(e),this.sortedRows.updateSort(((e,t)=>r("new"===e,"new"===t)||this.sortFunc.compare(e,t)))}),this)),this.sortedRows.subscribeTo(this._filteredRowSource),this.newRowSource=g.RowSource.create(this),this.newRowSource.getAllRows=function(){return["new"]},this.viewData=this.autoDispose(this.tableModel.createLazyRowsModel(this.sortedRows)),this.editRowModel=this.autoDispose(this.tableModel.createFloatingRowModel()),this.editRowModel._saveField=(e,t)=>this._saveEditRowField(this.editRowModel,e,t),this.listenTo(this.viewData,"rowModelNotify",(e=>this.onRowResize(e))),this.listenTo(this.viewSection.events,"rowHeightChange",this.onResize),this.autoDispose(_.createGroup($.commonCommands,this,this.viewSection.hasFocus)),this.linkedRowId=this.autoDispose(n.computed((()=>{let e=this.viewSection.linkingState();return e&&e.cursorPos?e.cursorPos():null})).extend({deferred:!0})),this.autoDispose(this.linkedRowId.subscribe((e=>{this.viewSection.linkingState.peek()&&this.setCursorPos({rowId:e||"new"})}))),this.isLinkSource=this.autoDispose(n.pureComputed((()=>this.viewSection.linkedSections().all().length>0))),this.disableEditing=this.autoDispose(n.computed((()=>{const e=this.viewSection.linkingState();return e&&e.disableEditing()}))),this.isPreview=null!=(i=this.options.isPreview)&&i,this.enableAddRow=this.autoDispose(n.computed((()=>this.options.addNewRow&&!this.viewSection.disableAddRemoveRows()&&!this.disableEditing()))),this.autoDispose(this.enableAddRow.subscribeInit((e=>{e?this.sortedRows.subscribeTo(this.newRowSource):this.sortedRows.unsubscribeFrom(this.newRowSource)}))),this._isLoading=n.observable(!0),this._pendingCursorPos=this.viewSection.lastCursorPos,console.log("%s BaseView viewSection %s (%s) lastCursorPos %s",this._debugName,this.viewSection.getRowId(),this.viewSection.table().tableId(),JSON.stringify(this.viewSection.lastCursorPos)),this.cursor=this.autoDispose(v.create(null,this,this.viewSection.lastCursorPos)),this.currentColumn=this.autoDispose(n.pureComputed((()=>this.viewSection.viewFields().at(this.cursor.fieldIndex()).column())).extend({rateLimit:0})),this.currentEditingColumnIndex=n.observable(-1),this.fieldBuilders=this.autoDispose(y.createAllFieldWidgets(this.gristDoc,this.viewSection.viewFields,this.cursor,{isPreview:this.isPreview})),this.activeFieldBuilder=this.autoDispose(n.pureComputed((()=>this.fieldBuilders.at(this.cursor.fieldIndex())))),this.selectedColumns=null,this.isTruncated=n.observable(!1),this.autoDispose(n.computed((()=>{this._isLoading(!0);const e=this.viewSection.linkingFilter();this._queryRowSource.makeQuery(e.filters,e.operations,(e=>{this.isDisposed()||(e&&C(e),this.onTableLoaded())}))}))),this.autoDispose(this.viewSection.linkingFilter.subscribe((e=>this.onLinkFilterChange()))),this.autoDispose(this.viewSection.activeSortSpec.subscribe((()=>this.setCursorPos({rowIndex:0})))),this.copySelection=n.observable(null),this._isPrinting=n.observable(!1)}b.setBaseFor($),i.extend(b.prototype,w),$.commonCommands={input:function(e){this.scrollToCursor(!0).catch(C),this.activateEditorAtCursor({init:e})},editField:function(){O(),this.scrollToCursor(!0),this.activateEditorAtCursor()},insertRecordBefore:function(){this.insertRow(this.cursor.rowIndex())},insertRecordAfter:function(){this.insertRow(this.cursor.rowIndex()+1)},insertCurrentDate:function(){this.insertCurrentDate(!1)},insertCurrentDateTime:function(){this.insertCurrentDate(!0)},copyLink:function(){this.copyLink().catch(C)},deleteRecords:function(e){this.deleteRecords(e)},filterByThisCellValue:function(){this.filterByThisCellValue()},duplicateRows:function(){this._duplicateRows().catch(C)},openDiscussion:function(){this.openDiscussionAtCursor()}},$.prototype.selectedRows=function(){return[]},$.prototype.deleteRows=function(e){return this.tableModel.sendTableAction(["BulkRemoveRecord",e])},$.prototype.deleteRecords=function(e){const t=this.selectedRows();if(this.viewSection.disableAddRemoveRows()||0===t.length)return;const o=e instanceof KeyboardEvent,i=this.gristDoc.docPageModel.appModel.dismissedPopups,n=A.check("deleteRecords"),s=async e=>(e&&M(i,n),this.deleteRows(t));if(o&&!i.get().includes(n)){this.scrollToCursor();const e=this.viewPane.querySelector(".selected_cursor")||this.viewPane;P(e,s,t.length<=1)}else s().then((()=>(B(this.gristDoc,`You deleted ${t.length} row${t.length>1?"s":""}.`),!0)))},$.prototype.setCursorPos=function(e){this.isDisposed()||(this._isLoading.peek()?(this._pendingCursorPos=e,this.cursor.setLive(!1)):this.cursor.setCursorPos(e))},$.prototype.getLoadingDonePromise=function(){return a(this._isLoading,(e=>!e))},$.prototype.activateEditorAtCursor=function(e){var t=this.activeFieldBuilder();if(!t.isEditorActive()){var o=this.viewData.getRowId(this.cursor.rowIndex()),i=this.getRenderedRowModel(o);i&&(this.editRowModel.assign(o),t.buildEditorDom(this.editRowModel,i,e||{}))}},$.prototype.openDiscussionAtCursor=function(e){if(!E().get())return!1;var t=this.activeFieldBuilder();if(t.isEditorActive())return!1;var o=this.viewData.getRowId(this.cursor.rowIndex()),i=this.getRenderedRowModel(o);return!!i&&(this.editRowModel.assign(o),t.buildDiscussionPopup(this.editRowModel,i,e),!0)},$.prototype.moveEditRowToCursor=function(){var e=this.viewData.getRowId(this.cursor.rowIndex());return this.editRowModel.assign(e),this.editRowModel},$.prototype.getAnchorLinkForSection=function(e){const t=this.viewData.getRowId(this.cursor.rowIndex())||this.tableModel.tableData.findMatchingRowId({})||"new",o=this.cursor.fieldIndex.peek(),i=null!==o?this.viewSection.viewFields().peek()[o]:null;return{hash:{sectionId:e,rowId:t,colRef:null==i?void 0:i.colRef.peek()}}},$.prototype.copyLink=async function(){const e=this.viewSection.getRowId(),t=this.getAnchorLinkForSection(e);try{const e=S().makeUrl(t);await T(e),I({clipboard:e}),D("Link copied to clipboard",{key:"clipboard"})}catch(e){throw new Error("cannot copy to clipboard")}},$.prototype.filterByThisCellValue=function(){const e=this.viewData.getRowId(this.cursor.rowIndex()),t=this.viewSection.viewFields().peek()[this.cursor.fieldIndex()].column();let o,i=this.tableModel.tableData.getValue(e,t.colId.peek());const n=t.type.peek();u.isList(i)&&u.isListType(n)?(o=i.slice(1),o.length||(o=["ChoiceList"===n?"":null])):(Array.isArray(i)&&(i=JSON.stringify(i)),o=[i]),this.viewSection.setFilter(t.getRowId(),{filter:JSON.stringify({included:o})})},$.prototype.insertRow=function(e){if(!this.viewSection.disableAddRemoveRows()&&!this.disableEditing()){var t=this.viewData.getRowId(e),o=Number.isInteger(t)?this.tableModel.tableData.getValue(t,"manualSort"):null;return this.sendTableAction(["AddRecord",null,{manualSort:o}]).then((e=>(this.isDisposed()||(this._sectionFilter.addTemporaryRow(e),this.setCursorPos({rowId:e})),e)))}},$.prototype._getDefaultColValues=function(){const e=this.viewSection.linkingState.peek();return e?e.getDefaultColValues():{}},$.prototype._enhanceAction=function(e){if("AddRecord"===e[0]||"BulkAddRecord"===e[0]){let t=this._getDefaultColValues(),o=e[1];return"BulkAddRecord"===e[0]&&(t=i.mapObject(t,(e=>o.map((()=>e))))),Object.assign(t,e[2]),[e[0],o,t]}return e},$.prototype.prepTableActions=function(e){return(e=e.map((e=>this._enhanceAction(e)))).forEach((e=>{e.splice(1,0,this.tableModel.tableData.tableId)})),e},$.prototype.sendTableActions=function(e,t){return this.tableModel.sendTableActions(e.map((e=>this._enhanceAction(e))),t)},$.prototype.sendTableAction=function(e,t){return e?this.tableModel.sendTableAction(this._enhanceAction(e),t):null},$.prototype.insertCurrentDate=function(e){let t=this.currentColumn();if(t.isRealFormula())return;let o,i=t.pureType(),n=Date.now();const r=this.gristDoc.docInfo.timezone.peek();if("Text"===i||"Any"===i)o=s.tz(n,r).format("YYYY-MM-DD"+(e?" HH:mm:ss":""));else if("Date"===i){const e=s.tz(n,r).utcOffset();o=l(n/1e3+60*e,86400)}else{if("DateTime"!==i)return;o=n/1e3}var a=this.viewData.getRowId(this.cursor.rowIndex());this.editRowModel.assign(a),this.editRowModel[t.colId()].setAndSave(o)},$.prototype._saveEditRowField=function(e,t,o){if(e._isAddRow.peek()){this.cursor.setLive(!1);const i=this._getDefaultColValues();return i[t]=o,e.updateColValues(i).then((e=>(this.isDisposed()||(this._sectionFilter.addTemporaryRow(e),this.setCursorPos({rowId:e})),e))).finally((()=>!this.isDisposed()&&this.cursor.setLive(!0)))}{var i=e.getRowId(),n=this.getRenderedRowModel(i);n&&n[t](o);const s=h.prototype._saveField.call(e,t,o).then((e=>(this.isDisposed()||"Bool"===this.currentColumn().pureType()||this._sectionFilter.addTemporaryRow(i),e))).finally((()=>!this.isDisposed()&&n&&n._assignColumn(t)));return this.viewSection.isSorted()?s:null}},$.prototype.copy=function(e){return _.allCommands.clearCopySelection.run(),this.copySelection(e),{data:this.tableModel.tableData,selection:e}},$.prototype.cut=function(e){return _.allCommands.clearCopySelection.run(),this.copySelection(e),{data:this.tableModel.tableData,selection:e,cutCallback:()=>p.makeDeleteAction(e)}},$.prototype.sendPasteActions=function(e,t){let o=null;return e&&(o=e(),o&&t.unshift(o)),this.gristDoc.docData.sendActions(t)},$.prototype.buildDom=function(){throw new Error("Not Implemented")},$.prototype.buildTitleControls=function(){return null},$.prototype.onTableLoaded=function(){this._pendingCursorPos&&(this.cursor.setCursorPos(this._pendingCursorPos),this._pendingCursorPos=null),this._isLoading(!1),this.isTruncated(this._queryRowSource.isTruncated),this.cursor.setLive(!0)},$.prototype.onResize=function(){},$.prototype.onRowResize=function(e){},$.prototype.onLinkFilterChange=function(e){this.viewSection.linkingState.peek()&&this.setCursorPos({rowIndex:0})},$.prototype.prepareToPrint=function(e){this._isPrinting(e)},$.prototype.getRenderedRowModel=function(e){return this.viewData.getRowModel(e)},$.prototype.getLastDataRowIndex=function(){let e=this.viewData.peekLength-1;return e>=0&&"new"===this.viewData.getRowId(e)?e-1:e},$.prototype.createFilterMenu=function(e,t,o){const{showAllFiltersButton:i,onClose:n}=o;return F({openCtl:e,sectionFilter:this._sectionFilter,filterInfo:t,rowSource:this._mainRowSource,tableData:this.tableModel.tableData,gristDoc:this.gristDoc,showAllFiltersButton:i,onClose:n})},$.prototype.isFiltered=function(){return this._filteredRowSource.getNumRows()<this.tableModel.tableData.numRecords()},$.prototype.scrollToCursor=function(){return Promise.resolve()},$.prototype._getRowInsertPos=function(e,t){var o=this.viewData.getRowId(e),i=this.tableModel.tableData.getValue(o,d);return Array(t).fill(i)},$.prototype._duplicateRows=async function(){if(this.viewSection.disableAddRemoveRows()||this.disableEditing())return;const e=this.getSelection().rowIds,t=e.length,o=["BulkAddRecord"];o.push(c.arrayRepeat(t,null));const i={};o.push(i);const n=this.viewData.getRowIndex(e[t-1]);i.manualSort=this._getRowInsertPos(n+1,t);for(const t of this.viewSection.columns.peek()){const o=t.colId.peek();t.isFormula.peek()||(i[o]=e.map((e=>this.tableModel.tableData.getValue(e,o))),i[o].every(u.isCensored)?delete i[o]:i[o].forEach(((e,t)=>{u.isCensored(e)&&(i[o][t]=null)})))}return await this.sendTableAction(o,`Duplicated rows ${e}`)},e.exports=$},88438:(e,t,o)=>{var i=o(29301),n=o(55723),s=o(54156),r=o(11527).get("DocumentFragment","Node");class l{constructor(...e){c(this.create,this,e)}static create(...e){return new this(...e)}}Object.assign(l.prototype,{autoDispose:function(e){return this.autoDisposeWith(f,e)},autoDisposePromise:function(e){return e.then((e=>this.isDisposed()?(f(e),null):(this.autoDispose(e),e)))},autoDisposeWith:function(e,t){var o;return(this._disposalList||(this._disposalList=[])).push({obj:t,disposer:"string"==typeof e?(o=e,function(e){e[o]()}):e}),t},autoDisposeCallback:function(e){this.autoDisposeWith(p,e)},disposeRelease:function(e){return u(this._disposalList,e),e},disposeDiscard:function(e){var t=u(this._disposalList,e);t&&t.disposer.call(this,e)},isDisposed:function(){return this._disposalList===d},dispose:function(){if(!this.isDisposed()){var e=this._disposalList;if(this._disposalList=d,e)for(var t=e.length-1;t>=0;t--){var o=e[t];h(this,o.disposer,o.obj)}"function"==typeof this.stopListening&&h(this,p,this.stopListening),function(e){for(var t in e)e.hasOwnProperty(t)&&(e[t]=d)}(this)}}}),t.Disposable=l,t.makeDisposable=function(e){Object.assign(e.prototype,l.prototype),e.create=a},t.safeCreate=function(e,t){return a.apply(e,Array.prototype.slice.call(arguments,1))};var a=function(e){var t=this,o=Object.create(t.prototype);return c(t,o,arguments)},c=function(e,t,o){try{return e.apply(t,o),t}catch(o){if(!o.printed){let i=t.constructor.name||e.name;console.error("Error constructing %s:",i,o),s.isObject(o)&&(o.printed=!0)}throw t.dispose(),o}},d=null;function u(e,t){if(e)for(var o=0;o<e.length;o++)if(e[o].obj===t){var i=e[o];return e.splice(o,1),i}return null}var p=function(e){e.call(this)};function h(e,t,o){try{t.call(e,o)}catch(t){console.error("While disposing %s, error disposing %s: %s",m(e),m(o),t)}}function m(e){return e&&e.constructor&&e.constructor.name?e.constructor.name:n.inspect(e,{depth:1})}function f(e){if(e instanceof r.Node)i.removeNode(e);else{if("function"!=typeof e.dispose)throw new Error("Object has no 'dispose' method");e.dispose()}}t.emptyNode=function(e){i.virtualElements.emptyNode(e),i.cleanNode(e)}},13988:(e,t,o)=>{var i=o(29301),n=o(74392),s=o(88438),r=o(83277);function l(e){return c.create(e)}function a(e,t){e(this,t)}function c(e){this._array=i.observable(e||[]),this._preparedSpliceEvent=null,this._syncSubscription=null,this._disposeElements=d,this.autoDispose(this._array.subscribe(this._emitPreparedEvent,this,"spectate")),this.autoDisposeCallback((function(){this._disposeElements(this.peek())}))}function d(){}function u(e){return e}o(33620),e.exports=t=l,t.default=l,l.isKoArray=function(e){return e&&"function"==typeof e.subscribe&&"function"==typeof e.all},t.isKoArray=l.isKoArray,l.syncedKoArray=function(e,t,o){var i=l();return t=t||u,i.autoDispose(e.subscribeInit((function(e){l.isKoArray(e)?i.syncMap(e,t,o):e&&(i.syncMapDisable(),i.assign(e.map((function(e,i){return t.call(o,e,i)}))))}))),i},t.syncedKoArray=l.syncedKoArray,s.makeDisposable(a),l.syncedMap=function(e,t,o){var i=new Map,n=e.subscribeForEach({add:e=>i.set(e,a.create(t,e)),remove:e=>r.popFromMap(i,e).dispose(),addDelay:o&&o.addDelay});return i.dispose=()=>{n.dispose(),i.forEach(((e,t)=>e.dispose()))},i},t.KoArray=c,s.makeDisposable(c),c.prototype.setAutoDisposeValues=function(){return this._disposeElements=this._doDisposeElements,this},c.prototype.all=function(){return this._array()},c.prototype.peek=function(){return this._array.peek()},c.prototype.getObservable=function(){return this._array},Object.defineProperty(c.prototype,"peekLength",{configurable:!1,enumerable:!1,get:function(){return this._array.peek().length}}),c.prototype.at=function(e){var t=this._array();return e>=0&&e<t.length?t[e]:null},c.prototype.assign=function(e){var t=this.peek();this._prepareSpliceEvent(0,e.length,t),this._array(e.slice()),this._disposeElements(t)},c.prototype.subscribe=function(e,t,o){return this._array.subscribe(e,t,o)},c.prototype._prepareSpliceEvent=function(e,t,o){this._preparedSpliceEvent={array:null,start:e,added:t,deleted:o}},c.prototype._emitPreparedEvent=function(){var e=this._preparedSpliceEvent;e&&(e.array=this.peek(),this._preparedSpliceEvent=null,this._array.notifySubscribers(e,"spliceChange"))},c.prototype._preChange=function(){this._array.valueWillMutate()},c.prototype._postChange=function(){this._array.valueHasMutated()},c.prototype._doDisposeElements=function(e){for(var t=0;t<e.length;t++)e[t].dispose()},c.prototype.push=function(){var e=this.peek(),t=e.length;this._preChange();var o=e.push.apply(e,arguments);return this._prepareSpliceEvent(t,arguments.length,[]),this._postChange(),o},c.prototype.unshift=function(){var e=this.peek();this._preChange();var t=e.unshift.apply(e,arguments);return this._prepareSpliceEvent(0,arguments.length,[]),this._postChange(),t},c.prototype.splice=function(e,t){return this.arraySplice(e,t,Array.prototype.slice.call(arguments,2))},c.prototype.arraySplice=function(e,t,o){var i=this.peek(),n=i.length,s=Math.min(n,Math.max(0,e<0?n+e:e));this._preChange();var l=void 0===t?i.splice(e):i.splice(e,t);return r.arraySplice(i,s,o),this._prepareSpliceEvent(s,o.length,l),this._postChange(),this._disposeElements(l),l},c.prototype.slice=function(){var e=this.all();return e.slice.apply(e,arguments)},c.prototype.map=function(e,t){var o=new c;return o.syncMap(this,e,t),o},c.prototype.syncMap=function(e,t,o){this.syncMapDisable(),t=t||u,this.assign(e.peek().map((function(e,i){return t.call(o,e,i)}))),this._syncSubscription=this.autoDispose(e.subscribe((function(e){for(var i=e.array,n=[],s=e.start,r=0;r<e.added;s++,r++)n.push(t.call(o,i[s],s));this.arraySplice(e.start,e.deleted.length,n)}),this,"spliceChange"))},c.prototype.syncMapDisable=function(){this._syncSubscription&&(this.disposeDiscard(this._syncSubscription),this._syncSubscription=null)},c.prototype.subscribeForEach=function(e){var t=e.context,o=e.add||d,i=e.remove||d,s="number"==typeof e.addDelay,r=this.subscribe((function(r){var l,a=r.array;for(l=0;l<r.deleted.length;l++)i.call(t,r.deleted[l],this);var c=()=>{var e=r.start+r.added;for(l=r.start;l<e;l++)o.call(t,a[l],l,this)};s?e.addDelay>0?setTimeout(c,e.addDelay):n.resolve(null).then(c):c()}),this,"spliceChange");return this.peek().forEach((function(e,i){o.call(t,e,i,this)}),this),r},c.prototype.clampIndex=function(e){var t=this.peekLength;return 0===t?null:r.clamp(e||0,0,t-1)},c.prototype.makeLiveIndex=function(e){var t=i.observable(this.clampIndex(e)),o=!0;this.subscribe((function(e){var i=t.peek();o?null===i?t(this.clampIndex(0)):i>=e.start+e.deleted.length?t(this.clampIndex(i+e.added-e.deleted.length)):i>=e.start+e.added&&t(this.clampIndex(e.start+e.added)):t(this.clampIndex(i))}),this,"spliceChange");var n=i.pureComputed({read:t,write:function(e){t(this.clampIndex(e))},owner:this});return n.setLive=e=>{o=e},n}},92979:(e,t,o)=>{var i=o(11527).get("document","Node"),n=o(29301),s=o(81294),r=o(13988);function l(e,t,o){var i;n.isObservable(t)?(i=t.subscribe((function(t){o(e,t)})),n.utils.domNodeDisposal.addDisposeCallback(e,(function(){i.dispose()})),o(e,t.peek())):"function"==typeof t?(t=n.computed(t),i=t.subscribe((function(t){o(e,t)})),n.utils.domNodeDisposal.addDisposeCallback(e,(function(){i.dispose(),t.dispose()})),o(e,t.peek())):o(e,t)}function a(e,t){return function(o){l(o,e,t)}}t.setBinding=l,t.makeBinding=a,t.text=function(e){return function(t){var o=i.document.createTextNode("");l(t,e,(function(e,t){o.nodeValue=t})),t.appendChild(o)}},t.bootstrapToken=function(e,t){var o=e.cloneNode();return l(o,t,(function(e,t){o.textContent=t})),o},t.attr=function(e,t){return a(t,(function(t,o){null==o?t.removeAttribute(e):t.setAttribute(e,o)}))},t.boolAttr=function(e,t){return a(t,(function(t,o){o?t.setAttribute(e,""):t.removeAttribute(e)}))},t.style=function(e,t){return a(t,(function(t,o){e.startsWith("--")?t.style.setProperty(e,o):t.style[e]=o}))},t.show=function(e){return a(e,(function(e,t){e.style.display=t?"":"none"}))},t.hide=function(e){return a(e,(function(e,t){e.style.display=t?"none":""}))},t.domData=function(e,t){return a(t,(function(t,o){n.utils.domData.set(t,e,o)}))},t.value=function(e){return a(e,(function(e,t){e.value!==t&&(e.value=t)}))},t.toggleClass=function(e,t){return a(t,(function(t,o){t.classList.toggle(e,!!o)}))},t.toggleDisabled=function(e){return a(e,(function(e,t){t?e.setAttribute("disabled","disabled"):e.removeAttribute("disabled")}))},t.cssClass=function(e){var t;return a(e,(function(e,o){if(t)for(const o of t.split(" "))e.classList.remove(o);if(t=o,o)for(const t of o.split(" "))e.classList.add(t)}))};const c=Symbol();function d(e,t,o){if(null===t)return Promise.resolve();const i=n.utils.domData.get(e,"scrolly");if(i)return o?(i.scrollRowIntoView(t),e[c]=null,Promise.resolve()):(e[c]=t,new Promise(((t,o)=>{setTimeout((()=>{try{if(null===e[c])return void t();i.isDisposed()||i.scrollRowIntoView(e[c]),t()}catch(e){o(e)}finally{e[c]=null}}),0)})));{const o=e.children[t];if(o){0===t&&(e.scrollTop=0);const i=o.getBoundingClientRect(),n=e.getBoundingClientRect();i.top<n.top?o.scrollIntoView(!0):i.bottom>n.bottom&&o.scrollIntoView(!1)}}return Promise.resolve()}function u(e,t){var o,r=[];return a(e,(function(e,l){o||(o=e.appendChild(i.document.createComment("")));for(var a=s.frag(t(l)),c=0;c<r.length;c++)r[c].parentNode===e&&n.removeNode(r[c]);r.length=0;var d=o.nextSibling;e.insertBefore(a,d);for(var u=o.nextSibling;u!==d;u=u.nextSibling)r.push(u)}))}t.scrollChildIntoView=function(e){return a(e,d)},t.doScrollChildIntoView=d,t.scope=u,t.maybe=function(e,t){return u(e,(function(e){return e?t(e):null}))},t.foreach=function(e,t){var o,s=[];return function(l){o||(o=l.appendChild(i.document.createComment("")));var a=function(e){var r,a=e.start,c=s.splice(a,e.deleted.length);for(r=0;r<c.length;r++)c[r]&&c[r].parentNode===l&&n.removeNode(c[r]);if(e.added>0){var d=i.document.createDocumentFragment(),u=[a,0];for(r=0;r<e.added;r++){var p=e.array[a+r],h=t(p);h&&(n.utils.domData.set(h,"itemModel",p),d.appendChild(h)),u.push(h)}Array.prototype.splice.apply(s,u);var m=o;for(r=a-1;r>=0;r--)if(s[r]&&s[r].parentNode===l){m=s[r];break}l.insertBefore(d,m.nextSibling)}},c=e;if(r.isKoArray(e)){var d=e.subscribe(a,null,"spliceChange");n.utils.domNodeDisposal.addDisposeCallback(l,(function(){d.dispose()})),c=e.all()}else if(!Array.isArray(e))throw new Error("koDom.foreach applied to non-array: "+e);a({array:c,start:0,added:c.length,deleted:[]})}}},73783:(e,t,o)=>{var i=o(11527).get("$","window","document");const n=o(72827),s=o(52906),r=o(88466),l=o(68525);var a=o(29301),c=o(74392),d=o(83277),u=o(77709),p=o(81294),h=o(92979),m=o(13988),f=o(32529).setSaveValue;function g(e,t,o){let n=null,s=null;function r(t,o){c(),i.$(i.window).on("mouseup",l),s=e.peek(),a(o,!0)}function l(){i.$(i.window).off("mouseup",l),c(),f(e,e.peek(),s)}function a(o,i){const s=t(e.peek(),o);s!==e.peek()&&(e(s),n=setTimeout(a,i?600:100,o,!1))}function c(){n&&(clearTimeout(n),n=null)}return p("div.kf_spinner",p("div.kf_spinner_half",p("div.kf_spinner_arrow.up"),h.toggleClass("disabled",(()=>o(e(),1))),p.on("mousedown",(()=>{r(0,1)}))),p("div.kf_spinner_half",p("div.kf_spinner_arrow.down"),h.toggleClass("disabled",(()=>o(e(),-1))),p.on("mousedown",(()=>{r(0,-1)}))),p.on("dblclick",(()=>!1)))}function b(e,t,o){var n=a.utils.domData.get(e,"reorderFunc"),s=a.utils.domData.get(o.item[0],"originalPrev");n&&!o.item.prev().is(s)&&n(a.utils.domData.get(o.item[0],"model"),w(o.item)).catch((function(t){console.warn("Failed to reorder item",t),i.$(e).sortable("cancel")})),x(o.item[0])}function v(e,t){var o=a.utils.domData.get(t.item[0],"originalParent"),n=a.utils.domData.get(o[0],"removeFunc"),s=a.utils.domData.get(t.item.parent()[0],"receiveFunc");n&&s?n(a.utils.domData.get(t.item[0],"model")).then((function(e){return s(e,w(t.item)).then((function(){t.item.remove()})).catch(y.bind(null,t,o,e))})).catch((function(e){console.warn("Error removing item",e),i.$(o).sortable("cancel")})).finally((function(){x(t.item[0])})):console.warn("Missing remove or receive")}function y(e,t,o,i){console.warn("Error receiving item. Trying to return removed item.",i);var n=a.utils.domData.get(t[0],"receiveFunc");if(n){var s=a.utils.domData.get(e.item[0],"originalPrev");n(o,s.length>0?w(s):_(t.children(".kf_draggable").first())).catch((function(e){console.warn("Failed to receive item in original collection.",e)})).finally((function(){e.item.remove()}))}}function _(e){return e.length&&e.length>0?a.utils.domData.get(e[0],"model"):null}function w(e){return e.next?_(e.next(".kf_draggable")):null}function x(e){a.utils.domData.set(e,"originalPrev",null),a.utils.domData.set(e,"originalParent",null),a.utils.domData.set(e,"crossedContainers",!1)}function C(e){i.$(e).on("sortremove",(function(e,t){a.utils.domData.set(t.item[0],"crossedContainers",!0),a.utils.domData.set(t.item[0],"stopIndex",t.item.index())})),i.$(e).sortable("option","disabled")&&(a.utils.domData.get(e,"receiveFunc")||a.utils.domData.get(e,"removeFunc"))&&i.$(e).sortable("option",{disabled:!1})}function D(e,t){C(e),i.$(e).addClass(t),i.$(e).sortable("option",{connectWith:"."+t})}t.button=function(e,...t){return p("div.kf_button.flexitem",p.on("click",(function(){this.classList.contains("disabled")||e()})),t)},t.accentButton=function(e,...t){return this.button(e,{class:"kf_button flexitem accent"},t)},t.liteButton=function(e,...t){return this.button(e,{class:"kf_button flexitem lite"},t)},t.logoButton=function(e,t,o,...i){return this.button(e,{class:"kf_button kf_logo_button flexitem flexhbox"},p("div.kf_btn_logo",{style:`background-image: url(${t})`}),p("div.kf_btn_text",o),i)},t.buttonGroup=function(e){return p("div.kf_button_group.kf_elem.flexhbox",p.fwdArgs(arguments,0))},t.accentButtonGroup=function(e){return this.buttonGroup([{class:"kf_button_group kf_elem flexhbox accent"}].concat(p.fwdArgs(arguments,0)))},t.liteButtonGroup=function(e){return this.buttonGroup([{class:"kf_button_group kf_elem flexhbox lite"}].concat(p.fwdArgs(arguments,0)))},t.checkButton=function(e,t){return p("div.kf_button.kf_check_button.flexitem",h.toggleClass("active",e),p.on("click",(function(){this.classList.contains("disabled")||f(e,!e())})),p.fwdArgs(arguments,1))},t.flatCheckButton=function(e,t){return p("div.flexnone",h.toggleClass("mod-active",e),p.on("click",(function(){this.classList.contains("mod-disabled")||f(e,!e())})),p.fwdArgs(arguments,1))},t.buttonSelect=function(e,t){var o=p("div.kf_button_group.kf_elem.flexhbox",p.fwdArgs(arguments,1));return i.$(o).on("click",".kf_button:not(.disabled)",(function(){f(e,a.utils.domData.get(this,"kfOptionValue"))})),h.makeBinding(e,(function(e,t){Array.prototype.forEach.call(e.querySelectorAll(".kf_button"),(function(e,o){var i=a.utils.domData.get(e,"kfOptionValue");e.classList.toggle("active",i===t)}))}))(o),o},t.optionButton=function(e,t){return p("div.kf_button.flexitem",(function(t){a.utils.domData.set(t,"kfOptionValue",e)}),p.fwdArgs(arguments,1))},t.toolTip=function(e){return p("div.kf_tooltip",p("div.kf_tooltip_pointer"),p("div.kf_tooltip_content",p.fwdArgs(arguments,0)),p.defer((function(e){var t=e.getBoundingClientRect().width,o=e.parentNode.getBoundingClientRect();e.style.left=-t/2+o.width/2+"px",e.style.top=o.height+"px"})))},t.prompt=function(e){return p("div.kf_prompt",p("div.kf_prompt_pointer"),p("div.kf_prompt_pointer_overlap"),p("div.kf_prompt_content",p.fwdArgs(arguments,0)))},t.checkbox=function(e,t){return p("label.kf_checkbox_label.kf_elem",p("input.kf_checkbox",{type:"checkbox"},h.makeBinding(e,(function(e,t){e.checked=t})),p.on("change",(function(){f(e,this.checked)}))),p.fwdArgs(arguments,1))},t.radio=function(e,t,...o){return p("label.kf_radio_label",p("input.kf_radio",{type:"radio"},h.makeBinding(t,((t,o)=>{t.checked=o===e})),p.on("change",(function(){this.checked&&f(t,e)}))),...o)},t.spinner=function(e,t,o,i){var n=void 0!==i?i:1/0,s=void 0!==o?o:-1/0;return g(e,(function(e,o){const i=(a.unwrap(t)||1)*o;return e=e||0,e=Math.round(e/i)*i+i,e=parseFloat(e.toPrecision(15)),d.clamp(e,s,n)}),(function(e,t){return t>0?e>=n:e<=s}))},t.selectSpinner=function(e,t){return g(e,(function(e,o){const i=t.peek(),n=i.indexOf(e);return i[d.mod(n+o,i.length)]}),(function(e,o){return t().length<=1}))},t.alignmentSelector=function(e){return this.buttonSelect(e,this.optionButton("left",p("span.glyphicon.glyphicon-align-left"),p.testId("koForm_alignLeft")),this.optionButton("center",p("span.glyphicon.glyphicon-align-center"),p.testId("koForm_alignCenter")),this.optionButton("right",p("span.glyphicon.glyphicon-align-right"),p.testId("koForm_alignRight")))},t.collapserLabel=function(e,t){return p("div.kf_collapser.kf_elem",p("span.kf_triangle_toggle",h.text((function(){return e()?"►":"▼"}))),p.on("click",(function(){e(!e.peek())})),p.fwdArgs(arguments,1))},t.collapsible=function(e,t){var o=a.observable(void 0===t||t),i=e(o);return[i[0],p("div",h.hide(o),p.fwdArgs(i,1))]},t.draggableList=function(e,t,o){var r,l;s(o=o||{},{removeButton:!0,axis:"y",drag_indicator:!0,itemClass:"kf_draggable__item"}),t=t||n;var d=p("div.kf_drag_container",(function(e){o.reorder&&(r=c.method(o.reorder),a.utils.domData.set(e,"reorderFunc",r)),o.remove&&(l=c.method(o.remove),a.utils.domData.set(e,"removeFunc",l)),o.receive&&a.utils.domData.set(e,"receiveFunc",c.method(o.receive))}),h.foreach(e,(e=>{var n=t(e);return n?p("div.kf_draggable",p.on("mousedown",(()=>i.document.activeElement.blur())),h.cssClass(o.itemClass),o.drag_indicator?"boolean"==typeof o.drag_indicator?p("span.kf_drag_indicator.glyphicon.glyphicon-option-vertical"):o.drag_indicator():null,h.style("display","x"===o.axis?"inline-block":"block"),h.domData("model",e),h.maybe(void 0!==l&&o.removeButton,(function(){return p("span.drag_delete.glyphicon.glyphicon-remove",p.on("click",(function(){l(e).catch((function(e){console.warn("Failed to remove item",e)}))})))})),p("span.kf_draggable_content.flexauto",n)):null})));return i.$(d).sortable({axis:o.axis,tolerance:"pointer",forcePlaceholderSize:!0,placeholder:"kf_draggable__placeholder--"+("x"===o.axis?"horizontal":"vertical")}),void 0===r&&i.$(d).sortable("option",{disabled:!0}),i.$(d).on("sortstart",(function(e,t){a.utils.domData.set(t.item[0],"originalParent",t.item.parent()),a.utils.domData.set(t.item[0],"originalPrev",t.item.prev())})),i.$(d).on("sortstop",(function(e,t){a.utils.domData.get(t.item[0],"crossedContainers")?v.call(d,e,t):b.bind(null,d).call(this,e,t)})),d};var S=0;function k(e,t,o){var i={};t&&(t.type&&(i.type=t.type),t.maxSize&&(i.maxlength=t.maxSize,i.style="max-width: "+(t.maxSize+2)+"em"),t.placeholder&&(i.placeholder=t.placeholder));var n=t=>f(e,t.target.value),s=r(n,t.delay),l=e=>{t&&t.delay?p(e,p.on("input",s),p.on("change",(e=>{s(e),s.flush()}))):p(e,p.on("change",n))};return p("div.kf_elem",p("input.kf_text",i,h.toggleDisabled(t.disabled||!1),h.value(e),l,p.fwdArgs(arguments,2)))}function T(e,t){t.textContent=e.value;var o=t.getBoundingClientRect();e.style.width=Math.ceil(o.width)+"px"}function I(e,t,o){var n=e||a.observable(0);return i.$(o).on("click",t,(function(){n(p.childIndex(this))})),a.utils.domData.set(o,"kfSelectedTab",n),o}function R(e,t,o){return function(i){var n=p.findLastChild(i,e);if(n){var s=a.utils.domData.get(n,"kfSelectedTab"),r=n.firstChild,l=n.lastChild,c=r.childNodes.length,d=a.computed((function(){return s()===c}));h.toggleClass("active",d)(t),p.autoDispose(t,d),h.show(d)(o),r.appendChild(t),l.appendChild(o)}else console.log("koForm: Attempting to add tab without an existing tabs container")}}t.connectAllDraggables=function(e){e.length<2&&console.warn("connectAllDraggables requires at least 2 draggable components");for(var t="connected-draggable-"+S++,o=0;o<arguments.length;o++)D(arguments[o],t)},t.connectDraggableOneWay=function(e,t){e.id="connected-draggable-"+S++,t.id="connected-draggable-"+S++,C(e),C(t),i.$(e).sortable("option",{connectWith:"#"+t.id})},t.label=function(e){return p("div.kf_label.kf_elem",p.fwdArgs(arguments,0))},t.lightLabel=function(e){return p("div.kf_light_label.kf_elem",p.fwdArgs(arguments,0))},t.midTabs=function(e){return I(e,".kf_mid_tab_label",p("div.flexitem.kf_mid_tabs",p("div.flexhbox.flexnone.kf_mid_tab_labels"),t.scrollable()))},t.midTab=function(e,t){return R(".kf_mid_tabs",p("div.kf_mid_tab_label.flexitem",e),p("div.kf_mid_tab_content",p.fwdArgs(arguments,1)))},t.numText=function(e,t){var o={type:"number"};return(t=t||{}).placeholder&&(o.placeholder=t.placeholder),void 0!==t.min&&(o.min=t.min),void 0!==t.max&&(o.max=t.max),p("div.kf_elem",p("input.kf_num_text",o,h.value(e),p.on("input",(function(){f(e,Number(this.value))}))))},t.text=function(e,t,...o){return k(e,t=Object.assign({type:"text"},t||{}),o)},t.color=function(e,...t){const o=r((t=>f(e,t.target.value)),300);return p("div.kf_elem",p("input.kf_color",{type:"color"},h.value(e),p.on("change",o),...t))},t.password=function(e,t,...o){return k(e,t=Object.assign({type:"password"},t||{}),o)},t.statusPanel=function(e,o){var i={};["success","info","warning","error"].forEach((function(e){var t;o[e]&&(t=void 0!==o[e].value?o[e].value:o[e],i[t]={},i[t].className="kf_status_"+e,i[t].label=o[e].label||null)}));var n=a.pureComputed((function(){return void 0!==i[e()].label}));return p("div.kf_status_panel.flexhbox",p.autoDispose(n),p("div.kf_status_indicator.flexauto",h.cssClass((function(){if(i[e()])return i[e()].className;console.error("Status must match an available status code",Object.keys(i))})),"●"),p("div.kf_status_detail.flexauto",h.maybe(o.heading,(function(){return t.row(t.label(o.heading))})),h.maybe(n,(function(){return t.row(t.lightLabel(h.text(a.pureComputed((function(){return i[e()].label})))))}))))},t.editableLabel=function(e,t){var o,i=t||a.observable(!1),n=!1,s={cancel:function(){n=!0,i(!1)},accept:function(){n=!1,i(!1)}};return p("div.kf_editable_label",p("div.kf_elabel_text",h.text(e),h.hide(i)),o=p("div.elabel_content_measure"),t?null:p.on("click",(()=>i(!0))),h.maybe(i,(function(){var t=u.createGroup(s,this,!0);return p("input.kf_elabel_input",{type:"text"},(e=>p.hide(e)),h.value(e),p.autoDispose(t),t.attach(),p.on("blur",(function(){i(!1)})),p.on("change",(function(){i(!1)})),p.on("input",(function(){T(this,o)})),p.onDispose((t=>{n||e()===t.value||f(e,t.value)})),p.defer((function(e){n=!1,T(e,o),p.show(e),e.focus(),e.select()})))})))},t.row=function(e){for(var t=1,o=p("div.kf_row.flexhbox"),i=0;i<arguments.length;i++){var n=arguments[i];"number"==typeof n?t=n:"function"==typeof n?n(o):void 0!==n&&(("string"==typeof n||Array.isArray(n))&&(n=p("div",n)),n.style.flex=n.style.webkitFlex=t+" 1 0px",o.appendChild(n),t=1)}return o},t.helpRow=function(e){var o=t.row.apply(null,arguments);return o.classList.add("kf_help_row"),o},t.scrollable=function(e){var t,o;return[p("div.flexnone.kf_scroll_shadow_outer",o=p("div.kf_scroll_shadow",p.hide)),t=p("div.flexitem.kf_scrollable",p.on("scroll",(function(){o.style.display=t.scrollTop>0?"":"none"})),p.fwdArgs(arguments,0))]},t.select=function(e,t,o){var i=(e,t)=>{let i=new Set(o.multiple?t:[t]);for(let t of e.querySelectorAll("option"))t.selected=i.has(a.utils.domData.get(t,"value"))};return p("div.kf_elem",p("div.kf_select_arrow",p("select.kf_select",l(o=o||{},["size","multiple"]),h.toggleDisabled(o.disabled||!1),h.foreach(t,(function(e){if(!e)return null;let t="string"==typeof e?e:e.value,o="string"==typeof e?e:e.label,i="string"!=typeof e&&e.disabled;return p("option",{value:t},h.domData("value",t),h.toggleDisabled(i),h.text(o))})),h.makeBinding(m.isKoArray(t)?t.getObservable():t,(t=>i(t,e()))),h.makeBinding(e,((e,t)=>i(e,t))),p.on("change",(function(){let t=[],i=this.querySelectorAll("option");for(let e=0;e<i.length;e++)if(i[e].selected){let n=a.utils.domData.get(i[e],"value");if(t.push(n),!o.multiple)break}t.sort(),f(e,o.multiple?t:t[0])})))))},t.separator=function(){return p("hr.kf_separator")},t.topTabs=function(e){return I(e,".kf_top_tab_label",p("div.flexvbox.kf_top_tabs",p("div.flexhbox.flexnone.kf_top_tab_labels"),p("div.flexitem.kf_top_tab_container")))},t.topTab=function(e,t){return R(".kf_top_tabs",p("div.kf_top_tab_label.flexitem",e),p("div.kf_top_tab_content.flexvbox",p.fwdArgs(arguments,1)))}},33620:(e,t,o)=>{var i=o(54156),n=o(29301);t.withKoUtils=function(e){return e},n.subscribable.fn.subscribeInit=function(e,t,o){var i=this.subscribe(e,t,o);return e.call(t,this.peek()),i},n.subscribable.fn.assign=function(e){this(e)},n.subscribable.fn.modifyAssign=function(e){var t=this.peek();e(t),this(t)},n.subscribable.fn.onlyNotifyUnequal=function(){return this.equalityComparer=function(e,t){return e===t},this},n.subscribable.fn.previousOnUndefined=function(){return this.equalityComparer=function(e,t){return e===t||void 0===t},this};let s=e=>{},r=n.computed;function l(e){let t;return function(){try{return t=e.call(this)}catch(e){return console.error("ERROR in ko.computed: %s",e),s(e),t}}}function a(e,t,o){var s,r=null;function l(e){return r&&r!==e&&n.ignoreDependencies(r.dispose,r),r=e,e}"object"==typeof e?(s=e.read,o=i.clone(e)):(s=e,o=i.defaults({owner:t},o||{})),o.read=function(){return l(s.call(this))};var a=n.computed(o),c=a.dispose;return a.dispose=function(){l(null),c.call(a)},a}t.setComputedErrorHandler=function(e){s=e,n.computed=function(e,t,o){return"function"==typeof e?e=l(e):e.read=l(e.read),r(e,t,o)}},t.observableWithDefault=function(e,t,o){if("function"!=typeof t){var i=t;t=function(){return i}}return n.pureComputed({read:function(){const o=e();return"boolean"==typeof o?o:o||t.call(this)},write:function(t){e(t)},owner:o})},t.observableNumber=function(e){return n.pureComputed({read:()=>Number(e()),write:t=>{e(Number(t))}})},t.computedAutoDispose=a,t.computedBuilder=function(e,t){return a((function(){var o=e.call(t);return o?n.ignoreDependencies(o):null}),null,{pure:!1})}},55424:(e,t,o)=>{var i=o(54156),n=o(29301),s=o(83277),r=o(88438),l=o(32529);function a(e,t){this._table=e,this._fields=t.slice(0),this._index=n.observable(null),this._rowId=null,this._fields.forEach((function(e){this._createField(e)}),this)}r.makeDisposable(a),i.extend(a.prototype,l.ActionDispatcher),a.prototype.getRowId=function(){return this._rowId},a.prototype._createField=function(e){this[e]=l.addSaveInterface(n.observable(),(t=>this._saveField(e,t)))},a.prototype._saveField=function(e,t){var o={};return o[e]=t,this.updateColValues(o)},a.prototype.updateColValues=function(e){return this._table.sendTableAction(["UpdateRecord",this._rowId,e])},a.prototype._assignColumn=function(e){throw new Error("Not Implemented")},a.prototype._process_RemoveColumn=function(e,t,o){s.arrayRemove(this._fields,o)||console.error("RowModel #RemoveColumn %s %s: column not found",t,o),delete this[o]},a.prototype._process_ModifyColumn=function(e,t,o,i){},a.prototype._process_UpdateRecord=function(e,t,o,i){for(var n in i)this._assignColumn(n)},a.prototype._process_BulkUpdateRecord=function(e,t,o,i){for(var n in i)this._assignColumn(n)},a.prototype._process_AddColumn=function(e,t,o,i){this._fields.push(o),this._createField(o),this._assignColumn(o)},a.prototype._process_RenameColumn=function(e,t,o,i){if(-1===this._fields.indexOf(i)){var n=this._fields.indexOf(o);-1!==n?(this._fields[n]=i,this[i]=this[o],l.addSaveInterface(this[i],this._saveField.bind(this,i)),this._assignColumn(i),delete this[o]):console.error("RowModel #RenameColumn %s %s %s: not found",t,o,i)}else console.error("RowModel #RenameColumn %s %s %s: already exists",t,o,i)},e.exports=a},41367:(e,t,o)=>{var i=o(54156),n=o(20543),s=o(86277).Events,r=o(83277),l=o(88438),a=o(13988),c=o(3871),d=o(33113),{DataRowModel:u}=o(92517);const{TableQuerySets:p}=o(25192);function h(e,t,o){d.call(this,e,t),this.tableMetaRow=o,this.tableQuerySets=new p(this.tableData);var i=t.getColIds();n(i.includes("id"),"Expecting tableData columns to include `id`"),this._newRowModel=this.autoDispose(new u(this,i)),this._floatingRows=new Set,this.listenTo(this,"rowNotify",(function(e,t){e===c.ALL?(this._newRowModel.dispatchAction(t),this._floatingRows.forEach((e=>{e.dispatchAction(t)}))):this._floatingRows.forEach((o=>{e.includes(o.getRowId())&&o.dispatchAction(t)}))}))}function m(e,t){a.KoArray.call(this,e.getKoArray().peek().map((function(e){return null}))),this._rowIdArray=e.getKoArray(),this._makeRowModel=t,this._assignedRowModels=new Map,this._allRowModels=new Set,this.autoDispose(this._rowIdArray.subscribe(this._onSpliceChange,this,"spliceChange")),this.listenTo(e,"rowNotify",this.onRowNotify),this.autoDisposeCallback((function(){for(let e of this._allRowModels)"function"==typeof e.dispose&&e.dispose()}))}l.makeDisposable(h),i.extend(h.prototype,d.prototype),h.prototype.createLazyRowsModel=function(e,t){var o=t||u,i=this;return new m(e,(function(){return new o(i,i._newRowModel._fields)}))},h.prototype.createFloatingRowModel=function(e){var t=new(e||u)(this,this._newRowModel._fields);return this._floatingRows.add(t),t.autoDisposeCallback((()=>{this._floatingRows.delete(t)})),t},m.prototype=Object.create(a.KoArray.prototype),l.makeDisposable(m),i.extend(m.prototype,s),m.prototype.makeItemModel=function(){var e=this._makeRowModel();return this._allRowModels.add(e),e},m.prototype.unsetItemModel=function(e){this.setItemModel(e,null)},m.prototype.setItemModel=function(e,t){var o=this.peek(),i=e._index.peek();null!==i&&o[i]===e&&(o[i]=null),null!==e._rowId&&this._assignedRowModels.delete(e._rowId),this._setItemModel(e,t),null!==t&&0!==o.length&&(null!==o[t=r.clamp(t,0,o.length-1)]&&o[t]!==e&&this.unsetItemModel(o[t]),o[t]=e,this._assignedRowModels.set(e._rowId,e))},m.prototype.setFloatingRowModel=function(e,t){this._setItemModel(e,t)},m.prototype._setItemModel=function(e,t){var o=this.peek();null===t||0===o.length?(e._index(null),e.assign(null)):(t=r.clamp(t,0,o.length-1),e._index(t),e.assign(this._rowIdArray.peek()[t]))},m.prototype.onRowNotify=function(e,t){if(e===c.ALL){for(let e of this._allRowModels)e.dispatchAction(t);this.trigger("rowModelNotify",this._allRowModels)}else{var o=[];for(let n of e){var i=this._assignedRowModels.get(n);i&&(i.dispatchAction(t),o.push(i))}this.trigger("rowModelNotify",o)}},m.prototype._onSpliceChange=function(e){var t,o,i=e.deleted.length,n=this.peek();for(t=e.start,o=0;o<i;t++,o++)n[t]&&this.unsetItemModel(n[t]);var s=e.added-i;if(0!==s){var l=e.start+i;for(let e of this._assignedRowModels.values()){var a=e._index.peek();a>=l&&e._index(a+s)}}var c=new Array(2+e.added);for(c[0]=e.start,c[1]=i,t=2;t<c.length;t++)c[t]=null;this.arraySplice(e.start,i,r.arrayRepeat(e.added,null))},m.prototype.getRowId=function(e){return this._rowIdArray.at(e)},m.prototype.getRowIndex=function(e){return this._rowIdArray.peek().indexOf(e)},m.prototype.getRowIndexWithSub=function(e){return this._rowIdArray.all().indexOf(e)},m.prototype.getRowModel=function(e){return this._assignedRowModels.get(e)},e.exports=h},33113:(e,t,o)=>{var i=o(54156),n=o(29301),s=o(88438),r=o(3871),l=o(32529);function a(e,t){this.docModel=e,this.tableData=t,this.rowGroupings={},this.isLoaded=n.observable(t.isLoaded),this.autoDispose(t.dataLoadedEmitter.addListener(this.onDataLoaded,this)),this.autoDispose(t.tableActionEmitter.addListener(this.dispatchAction,this))}s.makeDisposable(a),i.extend(a.prototype,r.RowSource.prototype,l.ActionDispatcher),a.prototype.fetch=function(e){return this.isLoaded.peek()&&e&&this.isLoaded(!1),this.tableData.docData.fetchTable(this.tableData.tableId,e)},a.prototype.getAllRows=function(){return this.tableData.getRowIds()},a.prototype.getNumRows=function(){return this.tableData.numRecords()},a.prototype.getRowGrouping=function(e){var t=this.rowGroupings[e];return t||((t=r.RowGrouping.create(null,this.tableData.getRowPropFunc(e))).subscribeTo(this),this.rowGroupings[e]=t),t},a.prototype.onDataLoaded=function(e,t){this.trigger("rowChange","remove",e),this.trigger("rowChange","add",t),this.isLoaded(!0)},a.prototype.sendTableActions=function(e,t){return this.tableData.sendTableActions(e,t)},a.prototype.sendTableAction=function(e,t){return this.tableData.sendTableAction(e,t)},a.prototype._process_AddRecord=function(e,t,o,i){this.trigger("rowChange","add",[o])},a.prototype._process_RemoveRecord=function(e,t,o){this.trigger("rowChange","remove",[o])},a.prototype._process_UpdateRecord=function(e,t,o,i){this.trigger("rowChange","update",[o]),this.trigger("rowNotify",[o],e)},a.prototype._process_ReplaceTableData=function(){},a.prototype._process_BulkAddRecord=function(e,t,o,i){this.trigger("rowChange","add",o)},a.prototype._process_BulkRemoveRecord=function(e,t,o){this.trigger("rowChange","remove",o)},a.prototype._process_BulkUpdateRecord=function(e,t,o,i){this.trigger("rowChange","update",o),this.trigger("rowNotify",o,e)},a.prototype.applySchemaAction=function(e){this.trigger("rowNotify",r.ALL,e)},a.prototype._process_AddColumn=function(e){this.applySchemaAction(e)},a.prototype._process_RemoveColumn=function(e){this.applySchemaAction(e)},a.prototype._process_RenameColumn=function(e){this.applySchemaAction(e)},a.prototype._process_ModifyColumn=function(e){this.applySchemaAction(e)},a.prototype._process_RenameTable=i.noop,a.prototype._process_RemoveTable=i.noop,e.exports=a},32529:(e,t,o)=>{var i=o(54156),n=o(74392),s=o(20543),r=o(83277),l=o(29301),a=o(33620);function c(e,t){return e.saveOnly=function(o){return n.try((()=>t.call(this,o))).tap((()=>e.notifySubscribers(o,"save")))},e.save=function(){return this.saveOnly(this.peek())},e.setAndSave=function(e){return this(e),this.saveOnly(e)},e}function d(e,t){return e(t)}function u(e,t){return e.saveOnly(t)}function p(e){return e.update=function(e){this(i.extend(this.peek(),e))},e._props={},e.prop=function(e){return this._props[e]||(this._props[e]=function(e,t){var o=l.pureComputed({read:function(){return e()[t]},write:function(o){var i=e.peek();i[t]=o,e(i)}});return e.saveOnly&&c(o,(function(o){var n=i.clone(e.peek());return n[t]=o,e.saveOnly(n)})),o}(this,e))},e}t.addSaveInterface=c,t.savingComputed=function(e){return c(l.pureComputed({read:e.read,write:t=>e.write(d,t)}),(t=>e.write(u,t)))},t.setSaveValue=function(e,t,o){let i=void 0===o?e.peek():o;if(t!==i&&(e(t),e.save))return n.try((()=>e.save())).catch((o=>{throw console.warn("setSaveValue %s -> %s failed: %s",i,t,o),e(i),o}))},t.createField=function(e){return c(l.observable(),e)},t.fieldWithDefault=function(e,t,o){var i=a.observableWithDefault(e,t,o);return e.saveOnly&&c(i,e.saveOnly),i},t.jsonObservable=function(e,t,o){t=t||function(e){return e||{}};var i=l.pureComputed({read:function(){var i=e();return t.call(o,i?JSON.parse(i):null)},write:function(t){e(JSON.stringify(t))}});return e.saveOnly&&c(i,(function(t){return e.saveOnly(JSON.stringify(t))})),p(i)},t.objObservable=p;var h={};function m(e){var t=l.observable(h),o=e.read,i=e.save,s=l.pureComputed({read:()=>t()!==h?t():o(),write:e=>t(e!==o()?e:h)});return s.isSaved=l.pureComputed((()=>t()===h)),s.revert=function(){t(h)},i&&c(s,(e=>n.try((()=>e!==o()?i(e):null)).finally(s.revert))),s}function f(e,t,o){s(r.startsWith(e[0],"Bulk"));var n=e[2],l=e[3],a=e.slice(0);a[0]=a[0].slice(4);for(var c=a[3]=l&&i.clone(l),d=0;d<n.length;d++){if(a[2]=n[d],c)for(var u in c)c[u]=l[u][d];t.call(o,a)}}t.customValue=function(e){var t={read:()=>e()};return e.saveOnly&&(t.save=t=>e.saveOnly(t)),m(t)},t.customComputed=m,t.bulkActionExpand=f;var g={dispatchAction:function(e){console.assert(!("function"==typeof this.isDisposed&&this.isDisposed()),`Dispatching action ${e[0]} on disposed object`,this);var t=this["_process_"+e[0]];if("function"==typeof t){var o=e.slice(0);return o[0]=e,t.apply(this,o)}console.warn("Received unknown action %s",e[0])},dispatchBulk:function(e,t,o,i){f(e,this.dispatchAction,this)}};t.ActionDispatcher=g},73353:(e,t,o)=>{var i=o(88438);const{CellStyle:n}=o(73974),{dom:s}=o(1310);function r(e,t={}){this.field=e,this.options=e.widgetOptionsJson;const{defaultTextColor:o="#000000"}=t;this.defaultTextColor=o,this.valueFormatter=this.field.visibleColFormatter,this.defaultTextColor=t.defaultTextColor||"#000000"}i.makeDisposable(r),r.prototype.buildConfigDom=function(){throw new Error("Not Implemented")},r.prototype.buildTransformConfigDom=function(){return null},r.prototype.buildDom=function(e){throw new Error("Not Implemented")},r.prototype.buildColorConfigDom=function(e){return s.create(n,this.field,e,this.defaultTextColor)},e.exports=r},16284:e=>{function t(e){}t.prototype.attach=function(e){},t.prototype.getDom=function(){return null},t.prototype.getCellValue=function(){throw new Error("Not Implemented")},t.prototype.prepForSave=function(){},t.prototype.getTextValue=function(){throw new Error("Not Implemented")},t.prototype.getCursorPos=function(){throw new Error("Not Implemented")},e.exports=t},9443:(e,t,o)=>{var i=o(88438),n=o(54156),s=o(21870);function r(e){s.call(this,e)}i.makeDisposable(r),n.extend(r.prototype,s.prototype),r.skipEditor=function(e,t){if(" "===e)return!t},r.supportsReadonly=function(){return!1},e.exports=r},29511:(e,t,o)=>{var i=o(54156),n=o(88438),s=o(21870);const{Autocomplete:r}=o(6632),{ACIndexImpl:l,buildHighlightedDom:a}=o(11104),{ChoiceItem:c,cssChoiceList:d,cssMatchText:u,cssPlusButton:p,cssPlusIcon:h}=o(31490),{menuCssClass:m}=o(1370),{testId:f,colors:g}=o(29922),{choiceToken:b,cssChoiceACItem:v}=o(55330),{dom:y,styled:_}=o(1310),{icon:w}=o(7454);function x(e){s.call(this,e),this.choices=e.field.widgetOptionsJson.peek().choices||[],this.choiceOptions=e.field.widgetOptionsJson.peek().choiceOptions||{},e.readonly||"single"!==e.field.viewSection().parentKey()||(this.cellEditorDiv.classList.add(D.className),this.cellEditorDiv.appendChild(C("Dropdown"))),this.enableAddNew=!0}n.makeDisposable(x),i.extend(x.prototype,s.prototype),x.prototype.getCellValue=function(){const e=this.autocomplete&&this.autocomplete.getSelectedItem();return e?e.label:s.prototype.getCellValue.call(this)},x.prototype.renderACItem=function(e,t){const o=this.choiceOptions[e.label];return v(e.isNew?[v.cls("-new"),p(h("Plus")),f("choice-editor-new-item")]:[v.cls("-with-new",this.showAddNew)],b(a(e.label,t,u),o||{},y.style("max-width","100%"),f("choice-editor-item-label")),f("choice-editor-item"))},x.prototype.attach=function(e){if(s.prototype.attach.call(this,e),this.options.readonly)return;const t=this.choices.map((e=>new c(e,!1))),o=new l(t),i={popperOptions:{placement:"bottom"},menuCssClass:`${m} ${d.className} test-autocomplete`,search:e=>this.maybeShowAddNew(o.search(e),e),renderItem:(e,t)=>this.renderACItem(e,t),getItemText:e=>e.label,onClick:()=>this.options.commands.fieldEditSave()};this.autocomplete=r.create(this,this.textInput,i)},x.prototype.prepForSave=async function(){const e=this.autocomplete&&this.autocomplete.getSelectedItem();if(e&&e.isNew){const t=this.options.field.widgetOptionsJson.prop("choices");await t.saveOnly([...t.peek()||[],e.label])}},x.prototype.maybeShowAddNew=function(e,t){this.showAddNew=!1;const o=t.trim();if(!this.enableAddNew||!o)return e;const i=new c(o,!1,!0);return e.items.find((e=>e.cleanText===i.cleanText))||(e.items.push(i),this.showAddNew=!0),e};const C=_(w,`\n  background-color: ${g.slate};\n  position: absolute;\n  top: 0;\n  left: 0;\n  margin: 3px 3px 0 3px;\n`),D=_("div","\n  & > .celleditor_text_editor, & > .celleditor_content_measure {\n    padding-left: 18px;\n  }\n");e.exports=x},40293:(e,t,o)=>{const i=o(68652),n=o(54156),s=o(83277),r=o(77709),l=o(88438),a=o(81294),c=o(92979),d=o(21870),{parseDate:u,TWO_DIGIT_YEAR_THRESHOLD:p}=o(62862);var h=$.fn.datepicker.Constructor;function m(e){this.timezone=e.timezone||"UTC",this.dateFormat=e.field.widgetOptionsJson.peek().dateFormat,this.locale=e.field.documentSettings.peek().locale,this.safeFormat=function(e){let t=e;return t.includes("Y")||(t+=" YYYY"),t.includes("D")&&t.includes("M")||(t="YYYY-MM-DD"),t}(this.dateFormat);const t=i.tz.guess();let o=i.tz(t).format(this.safeFormat);e.readonly&&(o=null),d.call(this,n.defaults(e,{placeholder:o}));const l=this.formatValue(e.cellValue,this.safeFormat,!0);if(this.textInput.value=s.undef(e.state,e.editValue,l),!e.readonly){this._keyboardNav=!1,this._datePickerWidget=$(this.textInput).datepicker({keyboardNavigation:!1,forceParse:!1,todayHighlight:!0,todayBtn:"linked",assumeNearbyYear:p,language:this.getLanguage(),format:{toDisplay:(e,t,o)=>i.utc(e).format(this.safeFormat),toValue:(e,t,o)=>{const i=u(e,{dateFormat:this.safeFormat,timezone:"UTC"});return null===i?null:new Date(1e3*i)}}}),this.autoDisposeCallback((()=>this._datePickerWidget.datepicker("destroy"))),this._datePickerWidget.on("keydown",(e=>{13!==e.keyCode&&27!==e.keyCode||(this._datePickerWidget.datepicker("destroy"),setTimeout((()=>e.currentTarget.dispatchEvent(e.originalEvent)),0))}));let t=Object.assign({},e.commands,{datepickerFocus:()=>{this._allowKeyboardNav(!0)}});this._datepickerCommands=this.autoDispose(r.createGroup(t,this,!0)),this._datePickerWidget.on("show",(()=>{a(document.querySelector(".datepicker"),c.attr("tabIndex",0),c.toggleClass("clipboard_focus",!0)),a(this.textInput,a.on("input",(()=>{this._allowKeyboardNav(!1)})),this._datepickerCommands.attach())}))}}Object.defineProperty(h.prototype,"isInput",{get:function(){return!0},set:function(e){}}),l.makeDisposable(m),n.extend(m.prototype,d.prototype),m.prototype.getCellValue=function(){let e=u(this.textInput.value,{dateFormat:this.safeFormat,timezone:this.timezone});return null!==e?e:this.textInput.value},m.prototype._allowKeyboardNav=function(e){this._keyboardNav!==e&&(this._keyboardNav=e,$(this.textInput).data().datepicker.o.keyboardNavigation=e,$(this.textInput).data().datepicker.o.forceParse=e)},m.prototype.formatValue=function(e,t,o){return n.isNumber(e)&&t?i.tz(1e3*e,this.timezone).format(t):o&&"string"==typeof e?e:""},m.prototype.getLanguage=function(){return this.locale.substr(0,this.locale.indexOf("-"))},e.exports=m},38062:(e,t,o)=>{var i=o(54156),n=o(29301),s=o(81294),r=o(88438),l=o(92979),a=o(73783),c=o(73353);const{fromKoSave:d}=o(95163),{alignmentSelect:u,cssButtonSelect:p}=o(88261),{cssRow:h,cssLabel:m}=o(3411),{cssTextInput:f}=o(29002),{styled:g,fromKo:b}=o(1310),{select:v}=o(1370),{dateFormatOptions:y}=o(62862);function _(e){c.call(this,e),this.alignment=this.options.prop("alignment"),this.dateFormat=this.field.config.options.prop("dateFormat"),this.isCustomDateFormat=this.field.config.options.prop("isCustomDateFormat"),this.mixedDateFormat=n.pureComputed((()=>null===this.dateFormat()||null===this.isCustomDateFormat())),this.standardDateFormat=this.autoDispose(n.computed({owner:this,read:function(){return this.mixedDateFormat()?null:this.isCustomDateFormat()?"Custom":this.dateFormat()},write:function(e){"Custom"===e?this.isCustomDateFormat.setAndSave(!0):(this.field.config.options.update({isCustomDateFormat:!1,dateFormat:e}),this.field.config.options.save())}})),this.timezone=n.observable("UTC")}r.makeDisposable(_),i.extend(_.prototype,c.prototype),_.prototype.buildDateConfigDom=function(){const e=this.field.config.options.disabled("dateFormat");return s("div",m("Date Format"),h(s(v(b(this.standardDateFormat),[...y,"Custom"],{disabled:e,defaultLabel:"Mixed format"}),s.testId("Widget_dateFormat"))),l.maybe((()=>!this.mixedDateFormat()&&this.isCustomDateFormat()),(()=>h(s(function(e,t){const o=a.text(e,null!=t?t:{}),i=o.querySelector("input");return s(i,l.cssClass(f.className),l.cssClass(x.className)),s(o,l.cssClass(w.className)),o}(this.dateFormat,{disabled:e}),s.testId("Widget_dateCustomFormat"))))))},_.prototype.buildConfigDom=function(){return s("div",this.buildDateConfigDom(),h(u(d(this.field.config.options.prop("alignment")),p.cls("-disabled",this.field.config.options.disabled("alignment")))))},_.prototype.buildTransformConfigDom=function(){return this.buildDateConfigDom()},_.prototype.buildDom=function(e){let t=e[this.field.colId()];return s("div.field_clip",l.style("text-align",this.alignment),l.text((()=>e._isAddRow()||this.isDisposed()?"":this.valueFormatter().format(t()))))};const w=g("div","\n  flex: 1;\n  margin: 0px;\n"),x=g("div","\n  &:focus {\n    outline: none;\n    box-shadow: 0 0 3px 2px var(--grist-color-cursor);\n    border: 1px solid transparent;\n  }\n");e.exports=_},52445:(e,t,o)=>{const i=o(68652),n=o(54156),s=o(81294),r=o(88438),l=o(92979),a=o(40293),c=o(83277),{parseDate:d}=o(62862),u=o(21870);function p(e){e.timezone=c.removePrefix(e.field.column().type(),"DateTime:");var t=e.commands;e.readonly||(e.commands=Object.assign({},t,{prevField:()=>1===this._focusIndex()?this._setFocus(0):t.prevField(),nextField:()=>0===this._focusIndex()?this._setFocus(1):t.nextField()})),a.call(this,e),this._timeFormat=e.field.widgetOptionsJson.peek().timeFormat,this._dateSizer=this.contentSizer,this._dateInput=this.textInput;const o=n.isNumber(e.cellValue),r=this.formatValue(e.cellValue,this._timeFormat,!1),d=i.tz("0","H",this.timezone).format(this._timeFormat);if(e.readonly){if(o){const e=r||d,t=e?" ":"";this.textInput.value=this.textInput.value+t+e}}else s(this.dom,l.toggleClass("celleditor_datetime",!0)),s(this.dom.firstChild,l.toggleClass("celleditor_datetime_editor",!0)),this.dom.appendChild(s("div.celleditor_cursor_editor.celleditor_datetime_editor",this._timeSizer=s("div.celleditor_content_measure"),this._timeInput=s("textarea.celleditor_text_editor",l.attr("placeholder",d),l.value(r),this.commandGroup.attach(),s.on("input",(()=>this.onChange())))));if("string"==typeof e.state)try{const{date:t,time:o}=JSON.parse(e.state);this._dateInput.value=t,this._timeInput.value=o,this.onChange()}catch(e){console.error("DateTimeEditor can't restore its previous state")}}r.makeDisposable(p),n.extend(p.prototype,a.prototype),p.prototype.setSizerLimits=function(){var e=this.editorPlacement.calcSize({width:1/0,height:1/0},{calcOnly:!0});this.options.readonly||(this._dateSizer.style.maxWidth=this._timeSizer.style.maxWidth=Math.ceil(e.width/2-6)+"px")},p.prototype._focusIndex=function(){return document.activeElement===this._dateInput?0:document.activeElement===this._timeInput?1:null},p.prototype._setFocus=function(e){var t=0===e?this._dateInput:1===e?this._timeInput:null;t&&(t.focus(),t.selectionStart=0,t.selectionEnd=t.value.length)},p.prototype.onChange=function(){this._resizeInput();const e=this._dateInput.value,t=this._timeInput.value;this.editorState.set(JSON.stringify({date:e,time:t}))},p.prototype.getCellValue=function(){let e=this._dateInput.value,t=this._timeInput.value,o=d(e,{dateFormat:this.safeFormat,time:t,timeFormat:this._timeFormat,timezone:this.timezone});return null!==o?o:e&&t?`${e} ${t}`:e||t},p.prototype._resizeInput=function(){if(this.options.readonly)u.prototype._resizeInput.call(this);else{this._dateSizer.textContent=this._dateInput.value,this._timeSizer.textContent=this._timeInput.value;var e=this._dateSizer.getBoundingClientRect(),t=this._timeSizer.getBoundingClientRect(),o=this.editorPlacement.calcSize({width:e.width+t.width+12,height:Math.max(e.height,t.height)+3});this.dom.style.width=o.width+"px",this._dateInput.parentNode.style.flexBasis=e.width+6+"px",this._timeInput.parentNode.style.flexBasis=t.width+6+"px",this._dateInput.style.height=Math.ceil(o.height-3)+"px",this._timeInput.style.height=Math.ceil(o.height-3)+"px"}},e.exports=p},38149:(e,t,o)=>{var i=o(54156),n=o(29301),s=o(68652),r=o(81294),l=o(88438),a=o(92979),c=o(73783),d=o(38062),u=o(83277);const{fromKoSave:p}=o(95163),{alignmentSelect:h,cssButtonSelect:m}=o(88261),{cssRow:f,cssLabel:g}=o(3411),{cssTextInput:b}=o(29002),{dom:v,styled:y,fromKo:_}=o(1310),{select:w}=o(1370),{buildTZAutocomplete:x}=o(73454),{timeFormatOptions:C}=o(62862);function D(e){d.call(this,e),this._timezone=this.autoDispose(n.computed((()=>u.removePrefix(e.column().type(),"DateTime:")))),this._setTimezone=t=>e.column().type.setAndSave("DateTime:"+t),this.timeFormat=this.field.config.options.prop("timeFormat"),this.isCustomTimeFormat=this.field.config.options.prop("isCustomTimeFormat"),this.mixedTimeFormat=n.pureComputed((()=>null===this.timeFormat()||null===this.isCustomTimeFormat())),this.standardTimeFormat=this.autoDispose(n.computed({owner:this,read:function(){return this.isCustomTimeFormat()?"Custom":this.timeFormat()},write:function(e){"Custom"===e?this.isCustomTimeFormat.setAndSave(!0):(this.isCustomTimeFormat.setAndSave(!1),this.timeFormat.setAndSave(e))}}))}l.makeDisposable(D),i.extend(D.prototype,d.prototype),D.prototype.buildConfigDom=function(e){const t=n.pureComputed((()=>this.field.config.options.disabled("timeFormat")()||this.field.column().disableEditData())),o=p(this.field.config.options.prop("alignment"));return r("div",g("Timezone"),f(v.create(x,s,_(this._timezone),this._setTimezone,{disabled:_(t)})),this.buildDateConfigDom(),g("Time Format"),f(r(w(_(this.standardTimeFormat),[...C,"Custom"],{disabled:_(t),defaultLabel:"Mixed format"}),r.testId("Widget_timeFormat"))),a.maybe((()=>!this.mixedTimeFormat()&&this.isCustomTimeFormat()),(()=>f(r(function(e,t){const o=c.text(e,t||{}),i=o.querySelector("input");return r(i,a.cssClass(b.className),a.cssClass(k.className)),r(o,a.cssClass(S.className)),o}(this.timeFormat,{disabled:this.field.config.options.disabled("timeFormat")}),r.testId("Widget_timeCustomFormat"))))),e?null:f(h(o,m.cls("-disabled",this.field.config.options.disabled("alignment")))))},D.prototype.buildTransformConfigDom=function(){return this.buildConfigDom(!0)};const S=y("div","\n  flex: 1;\n  margin: 0px;\n"),k=y("div","\n  &:focus {\n    outline: none;\n    box-shadow: 0 0 3px 2px #5e9ed6;\n    border: 1px solid transparent;\n  }\n");e.exports=D},21870:(e,t,o)=>{var i=o(54156),n=o(83277),s=o(81294),r=o(92979),l=o(88438),a=o(16284),c=o(77709);const{testId:d}=o(29922),{createMobileButtons:u,getButtonMargins:p}=o(16151),{EditorPlacement:h}=o(41880),{observable:m}=o(1310);function f(e){this.options=e,this.commandGroup=this.autoDispose(c.createGroup(e.commands,null,!0)),this._alignment=e.field.widgetOptionsJson.peek().alignment||"left";const t=n.undef(e.state,e.editValue,String(null==e.cellValue?"":e.cellValue));this.editorState=this.autoDispose(m(t)),this.dom=s("div.default_editor",r.toggleClass("readonly_editor",e.readonly),this.cellEditorDiv=s("div.celleditor_cursor_editor",s.testId("TextEditor_editor"),d("widget-text-editor"),this.contentSizer=s("div.celleditor_content_measure"),this.textInput=s("textarea.celleditor_text_editor",r.attr("placeholder",e.placeholder||""),r.style("text-align",this._alignment),r.boolAttr("readonly",e.readonly),r.value(t),this.commandGroup.attach(),s.on("input",(()=>this.onChange())))),u(e.commands))}l.makeDisposable(f),i.extend(f.prototype,a.prototype),f.prototype.attach=function(e){this.editorPlacement=h.create(this,this.dom,e,{margins:p()}),this.autoDispose(this.editorPlacement.onReposition.addListener(this._resizeInput,this)),this.setSizerLimits(),this._resizeInput(),this.textInput.focus();var t=Math.min(this.options.cursorPos,this.textInput.value.length);this.textInput.setSelectionRange(t,t)},f.prototype.getDom=function(){return this.dom},f.prototype.setSizerLimits=function(){const e=this.editorPlacement.calcSizeWithPadding(this.textInput,{width:1/0,height:1/0},{calcOnly:!0});this.contentSizer.style.maxWidth=Math.ceil(e.width)+"px"},f.prototype.getCellValue=function(){return this.textInput.value},f.prototype.onChange=function(){this.editorState&&this.editorState.set(this.getTextValue()),this._resizeInput()},f.prototype.getTextValue=function(){return this.textInput.value},f.prototype.getCursorPos=function(){return this.textInput.selectionStart},f.prototype._resizeInput=function(){var e=this.textInput;this.contentSizer.textContent=e.value+"​";var t=this.contentSizer.getBoundingClientRect();"left"===this._alignment&&(t.width+=16);var o=this.editorPlacement.calcSizeWithPadding(e,t);e.style.width=o.width+"px",e.style.height=o.height+"px"},e.exports=f},49674:e=>{function t(e){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=49674,e.exports=t}}]);
//# sourceMappingURL=928.bundle.js.map