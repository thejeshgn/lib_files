(self.webpackChunkgristy=self.webpackChunkgristy||[]).push([[272],{14400:(e,t,o)=>{"use strict";o.d(t,{P:()=>D});var i=o(3988),s=o(18222),n=o(19058),r=o(29922),l=o(1370),a=o(64978),d=o(58375),c=o(1310),u=o(21467),h=o(70387),p=o(83277),m=o(78870),g=o.n(m),f=Object.defineProperty,w=Object.defineProperties,b=Object.getOwnPropertyDescriptors,v=Object.getOwnPropertySymbols,y=Object.prototype.hasOwnProperty,_=Object.prototype.propertyIsEnumerable,x=(e,t,o)=>t in e?f(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,C=(e,t)=>{for(var o in t||(t={}))y.call(t,o)&&x(e,o,t[o]);if(v)for(var o of v(t))_.call(t,o)&&x(e,o,t[o]);return e},S=(e,t)=>w(e,b(t));const I=(0,h.makeT)("ViewAsDropdown");class D extends c.Disposable{constructor(e,t=(()=>this._fetchData())){super(),this.pageModel=e,this.fetch=t,this.isInitialized=c.Observable.create(this,!1),this.allUsers=c.Observable.create(this,[]),this._shareUsers=[],this._attributeTableUsers=[],this._exampleUsers=[],this._currentUser=null}async load(){const e=await this.fetch();this.isDisposed()||this.init(e)}getUsers(){const e=[...this._shareUsers,...this._attributeTableUsers];return this._showExampleUsers()&&e.push(...this._exampleUsers),e}init(e){var t;const o=this.pageModel;this._currentUser=(null==(t=o.userOverride.get())?void 0:t.user)||o.appModel.currentValidUser,e&&(this._shareUsers=e.users.map((t=>S(C({},t),{access:(0,d.U9)(t,e)}))).filter((e=>{return e.access&&!((t=e.email)===d._J||t===d.CF);var t})).filter((e=>{var t;return(null==(t=this._currentUser)?void 0:t.id)!==e.id})),this._attributeTableUsers=e.attributeTableUsers,this._exampleUsers=e.exampleUsers,this.allUsers.set(this.getUsers()),this.isInitialized.set(!0))}attachPopup(e,t){(0,u.setPopupToCreateDom)(e,(e=>{const o=e=>this._buildUserRow(e,C({isExampleUser:!0},t));return(0,u.cssMenuWrap)((0,u.cssMenu)(c.dom.cls(l.menuCssClass),R.cls(""),M(I("View As"),c.dom.show(this._shareUsers.length>0)),c.dom.forEach(this._shareUsers,(e=>this._buildUserRow(e,t))),this._attributeTableUsers.length>0?M(I("Users from table")):null,c.dom.forEach(this._attributeTableUsers,o),this._showExampleUsers()?[this._exampleUsers.length>0?M(I("Example Users")):null,c.dom.forEach(this._exampleUsers,o)]:null,(e=>{setTimeout((()=>e.focus()),0)}),c.dom.onKeyDown({Escape:()=>e.close()})))}),C(C({},u.defaultMenuOptions),t))}menu(e){return(0,l.menu)((()=>(this.load().catch(g()),[O("view as"),c.dom.forEach(this.allUsers,(e=>(0,l.menuItemLink)(`${e.name||e.email} (${(0,d.kw)(e)})`,(0,r.testId)("acl-user-access"),this._viewAs(e))))])),e)}async _fetchData(){const e=this.pageModel.currentDoc.get(),t=await(0,p.waitGrainObs)(this.pageModel.gristDoc);return e&&t.docComm.getUsersForViewAs()}_showExampleUsers(){return this._shareUsers.length+this._attributeTableUsers.length<5}_buildUserRow(e,t={}){return(0,c.dom)("a",{class:n.T7.className+" "+T.className},(0,n.XL)((0,s.O_)(t.isExampleUser?"exampleUser":e,"large")),(0,n.rk)((0,n.tE)(e.name||(0,c.dom)("span",e.email),k("(",(0,d.kw)(e),")",(0,r.testId)("acl-user-access"))),e.name?(0,n.gE)(e.email):null),this._viewAs(e,t.resetDocPage),(0,r.testId)("acl-user-item"))}_viewAs(e,t=!1){var o,s,n;const r={};return t&&(r.docPage=void 0),(null==(o=this.pageModel)?void 0:o.isPrefork.get())&&"owners"!==(null==(n=null==(s=this.pageModel)?void 0:s.currentDoc.get())?void 0:n.access)?c.dom.on("click",(async()=>{var t,o;const s=await(null==(o=null==(t=this.pageModel)?void 0:t.gristDoc.get())?void 0:o.docComm.fork());if(!s)throw new Error("Failed to create fork");window.location.assign((0,i.urlState)().makeUrl((0,a.xV)(e.email,S(C({},r),{doc:s.urlId}))))})):(0,i.urlState)().setHref((0,a.xV)(e.email,r))}}const R=(0,c.styled)("div","\n  max-width: unset;\n"),T=(0,c.styled)(n.T7,`\n  width: auto;\n  padding: 8px 16px;\n  align-items: center;\n  &:hover {\n    background-color: ${r.theme.lightHover};\n  }\n  &, &:hover, &:focus {\n    text-decoration: none;\n  }\n`),k=(0,c.styled)("span","\n  margin: 0 8px;\n  font-weight: normal;\n"),M=(0,c.styled)("div",`\n  margin: 11px 24px 14px 24px;\n  font-weight: 700;\n  text-transform: uppercase;\n  font-size: ${r.vars.xsmallFontSize};\n  color: ${r.theme.darkText};\n`),O=(0,c.styled)("div",`\n  margin: 8px 24px;\n  margin-bottom: 4px;\n  font-weight: 700;\n  text-transform: uppercase;\n  font-size: ${r.vars.xsmallFontSize};\n  color: ${r.theme.darkText};\n`)},23735:(e,t,o)=>{"use strict";o.r(t),o.d(t,{parsePasteForView:()=>r});var i=o(15323),s=o(631);const n=o(61393);async function r(e,t,o){const r={},l=[],a=(0,i.getDocIdHash)();return e.forEach(((e,i)=>{const d=t[i],c=null==d?void 0:d.column();if(!c||c.isRealFormula()||c.disableEditData())return;const u=d.createValueParser()||(e=>e);let h=!1;if(e[0]&&"object"==typeof e[0]){const{colType:t,docIdHash:i,colRef:r}=e[0],d=c.type(),u=i===a;if(h=u||!(0,s.isFullReferencingType)(t||""),"Any"!==d)h=h&&t===d;else if(u&&r){const e=o.docModel.columns.getRowModel(r),i=e.type();if(e.getRowId()&&"Text"!==i&&i===t){const t={type:i,visibleCol:e.visibleCol(),widgetOptions:JSON.stringify(n(e.widgetOptionsJson(),"rulesOptions"))};l.push(["UpdateRecord","_grist_Tables_column",c.getRowId(),t],["MaybeCopyDisplayFormula",r,c.getRowId()])}}}r[c.colId()]=e.map((e=>{if(e){if("string"==typeof e)return u(e);if(h&&e.hasOwnProperty("rawValue"))return e.rawValue;if(e.hasOwnProperty("displayValue"))return u(e.displayValue)}return e}))})),l.length&&await o.docData.sendActions(l),r}},3719:(e,t,o)=>{"use strict";o.r(t),o.d(t,{CELL:()=>d,COL:()=>a,CellSelector:()=>u,NONE:()=>c,ROW:()=>l});var i=o(29301),s=o.n(i),n=o(83277),r=o(1310);const l="row",a="col",d="cell",c="";class u extends r.Disposable{constructor(e){super(),this.view=e,this.row={start:s().observable(0),end:s().observable(0),linePos:s().observable("0px"),dropIndex:s().observable(-1)},this.col={start:s().observable(0),end:s().observable(0),linePos:s().observable("0px"),dropIndex:s().observable(-1)},this.currentSelectType=s().observable(c),this.currentDragType=s().observable(c),this.autoDispose(this.view.cursor.rowIndex.subscribe((()=>this.setToCursor()))),this.autoDispose(this.view.cursor.fieldIndex.subscribe((()=>this.setToCursor()))),this.setToCursor()}setToCursor(e=c){this.view.cursor.rowIndex&&(this.row.start(this.view.cursor.rowIndex()),this.row.end(this.view.cursor.rowIndex())),this.view.cursor.fieldIndex&&(this.col.start(this.view.cursor.fieldIndex()),this.col.end(this.view.cursor.fieldIndex())),this.currentSelectType(e)}containsCell(e,t){return this.containsCol(t)&&this.containsRow(e)}containsRow(e){return(0,n.between)(e,this.row.start(),this.row.end())}containsCol(e){return(0,n.between)(e,this.col.start(),this.col.end())}isSelected(e,t){if(t!==this.currentSelectType())return!1;const o=this.view.domToRowModel(e,t),i=this.view.domToColModel(e,t);switch(t){case l:return this.containsRow(o._index());case a:return this.containsCol(i._index());case d:return this.containsCell(o._index(),i._index());default:return console.error("Given element is not a row, cell or column"),!1}}isRowSelected(e){return this.isCurrentSelectType(a)||this.containsRow(e)}isColSelected(e){return this.isCurrentSelectType(l)||this.containsCol(e)}isCellSelected(e,t){return this.isColSelected(t)&&this.isRowSelected(e)}onlyCellSelected(e,t){return this.row.start()===e&&this.row.end()===e&&this.col.start()===t&&this.col.end()===t}isCurrentSelectType(e){return this._isCurrentType(this.currentSelectType(),e)}isCurrentDragType(e){return this._isCurrentType(this.currentDragType(),e)}colLower(){return Math.min(this.col.start(),this.col.end())}colUpper(){return Math.max(this.col.start(),this.col.end())}rowLower(){return Math.min(this.row.start(),this.row.end())}rowUpper(){return Math.max(this.row.start(),this.row.end())}colCount(){return this.colUpper()-this.colLower()+1}rowCount(){return this.rowUpper()-this.rowLower()+1}selectArea(e,t,o,i){this.row.start(e),this.col.start(t),this.row.end(o),this.col.end(i),(this.colCount()>1||this.rowCount()>1)&&this.currentSelectType(d)}_isCurrentType(e,t){return console.assert(-1!==[l,a,d,c].indexOf(t)),e===t}}},47079:(e,t,o)=>{"use strict";o.r(t),o.d(t,{CopySelection:()=>i});class i{constructor(e,t,o,i){this.rowIds=t,this.fields=o,this.colIds=this.fields.map((e=>e.colId())),this.colRefs=this.fields.map((e=>e.colRef())),this.displayColIds=this.fields.map((e=>e.displayColModel().colId())),this.rowStyle=i.rowStyle,this.colStyle=i.colStyle,this.columns=o.map(((t,o)=>{const i=t.formatter(),s=e.getRowPropFunc(this.displayColIds[o]),n=e.getRowPropFunc(this.colIds[o]);return{colId:this.colIds[o],fmtGetter:e=>i.formatAny(s(e)),rawGetter:e=>n(e)}}))}isCellSelected(e,t){return this.rowIds.includes(e)&&this.colIds.includes(t)}onlyAddRowSelected(){return 1===this.rowIds.length&&"new"===this.rowIds[0]}}},28250:(e,t,o)=>{"use strict";o.d(t,{S:()=>q});var i=o(30583),s=o.n(i),n=o(77709),r=o(51687),l=o(11527),a=o(97660),d=o(21296),c=o(9072),u=o(413),h=o(631),p=o(45353),m=o(1310),g=Object.defineProperty,f=Object.getOwnPropertySymbols,w=Object.prototype.hasOwnProperty,b=Object.prototype.propertyIsEnumerable,v=(e,t,o)=>t in e?g(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,y=(e,t)=>{for(var o in t||(t={}))w.call(t,o)&&v(e,o,t[o]);if(f)for(var o of f(t))b.call(t,o)&&v(e,o,t[o]);return e};const _=o(78870),x=o(88466),C=o(36812),S=o(16914),I=(0,a.a)("test-custom-widget-"),D=(0,l.get)("window");class R extends c.G{constructor(e){var t;super(),this._options=e,this._readyCalled=m.Observable.create(this,!1),e.access=e.access||d.u.none,this._rpc=new p.Rpc({}),this._rpc.queueOutgoingUntilReadyMessage(),this._rpc.setSendMessage((e=>{var t;return null==(t=this._iframe)?void 0:t.contentWindow.postMessage(e,"*")}));const o=this._onMessage.bind(this);D.window.addEventListener("message",o),this.onDispose((()=>{D.window.removeEventListener("message",o),this._rpc.setSendMessage(_)})),null==(t=e.configure)||t.call(e,this)}useEvents(e,t){this.listenTo(e,"event",(async e=>{t.check(this._options.access)&&await this._rpc.postMessage(e)})),e.attach(this)}exposeAPI(e,t,o){this._rpc.registerImpl(e,function(e,t,o){return new Proxy(e,{get:(e,i)=>function(){if("then"!==i)return t.check(o,i)?e[i](...arguments):void T(o)}})}(t,o,this._options.access)),this.onDispose((()=>this._rpc.unregisterImpl(e)))}exposeMethod(e,t,o){this._rpc.registerFunc(e,((...e)=>{if(o.check(this._options.access,"invoke"))return t(...e);T(this._options.access)}))}editOptions(){return this.callRemote("editOptions")}callRemote(e,...t){return this._rpc.callRemoteFunc(e,...t)}buildDom(){var e;const t=(e=>{if(!e)return e;const t=new URL(e);return t.searchParams.append("access",this._options.access),t.searchParams.append("readonly",String(this._options.readonly)),t.href})(this._options.url);return(null!=(e=this._options.onElem)?e:e=>e)(this._iframe=(0,m.dom)("iframe",m.dom.cls("clipboard_focus"),m.dom.cls("custom_view"),y({src:t},r.P.iframeAttributes),I("ready",this._readyCalled)))}_onMessage(e){this._iframe&&e.source===this._iframe.contentWindow&&!this.isDisposed()&&("grist"===e.data.mdest&&(e.data.mdest=""),e.data.mtype===p.MsgType.Ready&&(this.trigger("ready",this),this._readyCalled.set(!0)),this._rpc.receiveMessage(e.data))}}const T=e=>{throw new Error("Access not granted. Current access level "+e)};class k{constructor(e){this._minimum=e}check(e){return(0,d.Z)(e,this._minimum)}}class M{constructor(e){this._doc=e}async getDocName(){return this._doc.docId()}async listTables(){const{tableData:e}=await this._doc.docComm.fetchTable("_grist_Tables");return e[3].tableId.filter((e=>""!==e))}async fetchTable(e){return(0,u.Eu)(await this._doc.docComm.fetchTable(e))}async applyUserActions(e,t){return this._doc.docComm.applyUserActions(e,y({desc:void 0},t))}async getAccessToken(e){return this._doc.docComm.getAccessToken({readOnly:e.readOnly})}}M.defaultAccess=(new class{constructor(){this._accessMap=new Map}require(e,t="*"){return this._accessMap.set(t,e),this}check(e,t){if(!t)throw new Error("Method name is required for MethodAccess check");if(this._accessMap.has(t)){const o=this._accessMap.get(t);return(0,d.Z)(e,o)}if(this._accessMap.has("*")){const t=this._accessMap.get("*");return(0,d.Z)(e,t)}return!1}}).require(d.u.read_table,"getDocName").require(d.u.full);class O{constructor(e){this._baseView=e}async fetchSelectedTable(){const e=this._visibleColumns(),t=this._baseView.sortedRows.getKoArray().peek().filter((e=>"new"!=e)),o={};for(const i of e){const e=i.displayColModel.peek().colId.peek(),s=this._baseView.tableModel.tableData.getRowPropFunc(e),n=(0,h.extractInfoFromColType)(i.type.peek());o[i.colId.peek()]=t.map((e=>(0,h.reencodeAsAny)(s(e),n)))}return o.id=t,o}async fetchSelectedRecord(e){const t=this._visibleColumns(),o={id:e};for(const i of t){const t=i.displayColModel.peek().colId.peek(),s=(0,h.extractInfoFromColType)(i.type.peek());o[i.colId.peek()]=(0,h.reencodeAsAny)(this._baseView.tableModel.tableData.getValue(e,t),s)}return o}async allowSelectBy(){this._baseView.viewSection.allowSelectBy(!0),this._baseView.viewSection.selectedRows([])}async setSelectedRows(e){this._baseView.viewSection.selectedRows(e)}setCursorPos(e){return this._baseView.setCursorPos(e),Promise.resolve()}_visibleColumns(){const e=this._baseView.viewSection.columns.peek(),t=this._baseView.viewSection.hiddenColumns.peek().map((e=>e.id.peek())),o=this._baseView.viewSection.mappedColumns.peek(),i=new Set(S(Object.values(o||{})));return o?e.filter((e=>o&&i.has(e.colId.peek()))):e.filter((e=>!t.includes(e.id.peek())))}}class A{constructor(e){this._section=e}async setOptions(e){if(null==e||"object"!=typeof e)throw new Error("options must be a valid JSON object");this._section.activeCustomOptions(e)}async getOptions(){var e;return null!=(e=this._section.activeCustomOptions.peek())?e:null}async clearOptions(){this._section.activeCustomOptions(null)}async setOption(e,t){const o=y({},this._section.activeCustomOptions.peek());o[e]=t,this._section.activeCustomOptions(o)}getOption(e){const t=this._section.activeCustomOptions.peek();return null==t?void 0:t[e]}}class P extends c.G{attach(e){this.listenTo(e,"ready",this._ready.bind(this))}_ready(){}_notify(e){this.isDisposed()||this.trigger("event",e)}}class F extends P{constructor(e){super(),this._baseView=e,this._debounced=x((()=>this._update()),0),this.autoDispose(e.cursor.rowIndex.subscribe(this._debounced))}_update(){if(this.isDisposed())return;const e={tableId:this._baseView.viewSection.table().tableId(),rowId:this._baseView.cursor.getCursorPos().rowId||void 0,dataChange:!1};this._notify(e)}}class E extends P{constructor(e,t){super(),this._section=e,this._accessLevel=t,this._currentConfig=m.Computed.create(this,(e=>e(this._section.activeCustomOptions))),this._debounced=x((()=>this._update()),0),(e=>{this.autoDispose(e.addListener(((e,t)=>{C(t,e)||this._debounced()})))})(this._currentConfig)}_ready(){this._debounced()}_update(){this.isDisposed()||this._notify({options:this._currentConfig.get(),settings:{accessLevel:this._accessLevel}})}}class B extends P{constructor(e){super(),this._baseView=e,this._updateMapping=!0,this._debounced=x((()=>this._update()),0),this.autoDispose(e.viewSection.viewFields().subscribe(this._debounced.bind(this))),this.listenTo(e.sortedRows,"rowNotify",this._debounced.bind(this)),this.autoDispose(e.sortedRows.getKoArray().subscribe(this._debounced.bind(this))),this.autoDispose(e.viewSection.mappedColumns.subscribe((()=>{this._updateMapping=!0,this._debounced()})))}_ready(){this._debounced()}_update(){if(this.isDisposed())return;const e={tableId:this._baseView.viewSection.table().tableId(),rowId:this._baseView.cursor.getCursorPos().rowId||void 0,dataChange:!0,mappingsChange:this._updateMapping};this._updateMapping=!1,this._notify(e)}}class L extends m.Disposable{constructor(e,t,o){super(),this._section=e,this._currentAccess=t,this._promptCallback=o}async mappings(){return this._section.mappedColumns.peek()}async configure(e){void 0!==e.hasCustomOptions&&this._section.hasCustomOptions(e.hasCustomOptions),e.requiredAccess&&e.requiredAccess!==this._currentAccess&&this._promptCallback(e.requiredAccess),void 0!==e.columns?this._section.columnsToMap(e.columns):this._section.columnsToMap(null),void 0!==e.allowSelectBy&&this._section.allowSelectBy(e.allowSelectBy)}}var $=o(59011),U=o(88438),z=o(81294),V=o.n(z),N=o(92979),j=o(92769),W=o(1370),H=o(36322),G=o(86277),K=o(29301);const J=o(52906),X=class extends U.Disposable{create(e,t){s().call(this,e,t,{addNewRow:!0}),this.customDef=this.viewSection.customDef,this.autoDisposeCallback((()=>{this._customSection&&this._customSection.dispose()})),this._foundPlugin=K.observable(!1),this._foundSection=K.observable(!1),this._foundSection.extend({notify:"always"}),this.autoDispose(this.customDef.pluginId.subscribe(this._updatePluginInstance,this)),this.autoDispose(this.customDef.sectionId.subscribe(this._updateCustomSection,this)),this.autoDispose(n.createGroup(X._commands,this,this.viewSection.hasFocus)),this.viewPane=this.autoDispose(this._buildDom()),this._updatePluginInstance()}async triggerPrint(){if(!this.isDisposed()&&this._frame)return await this._frame.callRemote("print")}getEmptyWidgetPage(){return new URL("custom-widget.html",(0,H.getGristConfig)().homeUrl).href}_updatePluginInstance(){const e=this.customDef.pluginId();this._pluginInstance=this.gristDoc.docPluginManager.pluginsList.find((t=>t.definition.id===e)),this._pluginInstance?this._foundPlugin(!0):(this._foundPlugin(!1),this._foundSection(!1)),this._updateCustomSection()}_updateCustomSection(){if(!this._pluginInstance)return;const e=this.customDef.sectionId();this._customSection=$.CustomSectionElement.find(this._pluginInstance,e),this._customSection?(this._customSection.element.classList.add("flexitem"),this._foundSection(!0)):this._foundSection(!1)}_buildDom(){const{mode:e,url:t,access:o}=this.customDef,i=K.pureComputed((()=>"plugin"===this.customDef.mode())),s=K.pureComputed((()=>i()&&!this._foundPlugin())),n=K.pureComputed((()=>i()&&this._foundPlugin()&&!this._foundSection())),r=K.pureComputed((()=>i()&&this._foundSection())).extend({notify:"always"});return V()("div.flexauto.flexvbox.custom_view_container",V().autoDispose(i),V().autoDispose(s),V().autoDispose(n),V().autoDispose(r),N.scope((()=>[e(),t(),o()]),(([e,t,o])=>"url"===e?this._buildIFrame(t,o||d.u.none):null)),N.maybe(s,(()=>Y("Plugin ",V()("strong",N.text(this.customDef.pluginId))," was not found",V().testId("customView_notification_plugin")))),N.maybe(n,(()=>Y("Section ",V()("strong",N.text(this.customDef.sectionId))," was not found in plugin ",V()("strong",N.text(this.customDef.pluginId)),V().testId("customView_notification_section")))),N.maybe(r,(()=>this._customSection.element)))}_promptAccess(e){this.gristDoc.isReadonly.get()||this.viewSection.desiredAccessLevel(e)}_buildIFrame(e,t){return m.dom.create(R,{url:e||this.getEmptyWidgetPage(),access:t,readonly:this.gristDoc.isReadonly.get(),configure:e=>{this._frame=e;const o=this;e.exposeAPI("GristDocAPI",new M(this.gristDoc),M.defaultAccess),e.exposeAPI("GristView",new O(o),new k(d.u.read_table)),e.exposeAPI("CustomSectionAPI",new L(this.viewSection,t,this._promptAccess.bind(this)),new k(d.u.none)),e.useEvents(F.create(e,o),new k(d.u.read_table)),e.useEvents(B.create(e,o),new k(d.u.read_table)),e.exposeAPI("WidgetAPI",new A(this.viewSection),new k(d.u.none)),e.useEvents(E.create(e,this.viewSection,t),new k(d.u.none))},onElem:e=>function(e,t){let o=null,i=!1;function s(){o&&(clearInterval(o),o=null)}return m.dom.update(e,m.dom.on("mouseenter",(()=>{i||document.activeElement!==e&&(o=setInterval((()=>{if(document.activeElement===e)try{t()}finally{s()}}),70))})),m.dom.on("mouseleave",s),m.dom.onDispose((()=>{s(),i=!0})))}(e,(()=>{this.isDisposed()||(this.viewSection.isDisposed()||this.viewSection.hasFocus()||this.viewSection.hasFocus(!0),(0,W.closeRegisteredMenu)())}))})}};let q=X;function Y(...e){return V()("div.custom_view_notification.bg-warning",V()("p",...e))}q._commands={async openWidgetConfiguration(){var e;if(!this.isDisposed()&&!(null==(e=this._frame)?void 0:e.isDisposed()))try{await this._frame.editOptions()}catch(e){throw"Unknown interface"===e.message?new j.UserError("Custom widget doesn't expose configuration screen."):e}}},J(q.prototype,s().prototype),Object.assign(q.prototype,G.Events)},65272:(e,t,o)=>{"use strict";o.r(t),o.d(t,{DocComm:()=>Qt,GristDoc:()=>Ih,startDocTour:()=>_c});var i=o(29922),s=o(7454),n=o(1370),r=o(1310),l=Object.defineProperty,a=Object.getOwnPropertySymbols,d=Object.prototype.hasOwnProperty,c=Object.prototype.propertyIsEnumerable,u=(e,t,o)=>t in e?l(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;function h(e,t,o={}){return p(e,t,((e,t)=>{for(var o in t||(t={}))d.call(t,o)&&u(e,o,t[o]);if(a)for(var o of a(t))c.call(t,o)&&u(e,o,t[o]);return e})({buttonArrow:g("Collapse")},o))}const p=(0,r.styled)(n.select,`\n  height: 28px;\n  width: 100%;\n  border: 1px solid transparent;\n  cursor: pointer;\n\n  &:hover, &:focus, &.weasel-popup-open, &-active {\n    border: 1px solid ${i.colors.darkGrey};\n    box-shadow: none;\n  }\n`),m=p.className,g=(0,r.styled)(s.icon,`\n  margin: 0 2px;\n  pointer-events: none;\n  display: none;\n\n  .${m}:hover &, .${m}:focus &, .weasel-popup-open &, .${m}-active & {\n    display: flex;\n  }\n`);const f=(0,r.styled)("div",`\n  display: flex;\n  flex-direction: column;\n  gap: 4px;\n  position: relative;\n  outline: none;\n  margin: 6px 8px;\n  cursor: pointer;\n  border-radius: 4px;\n\n  border: 1px solid transparent;\n  &:not(&-editing):hover {\n    border: 1px solid ${i.theme.accessRulesColumnListBorder};\n  }\n`),w=(0,r.styled)("div",`\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  border-radius: 3px;\n  padding-left: 6px;\n  padding-right: 2px;\n  color: ${i.theme.accessRulesColumnItemFg};\n\n  .${f.className}-editing & {\n    background-color: ${i.theme.accessRulesColumnItemBg};\n  }\n`),b=(0,r.styled)("div","\n  flex: auto;\n  height: 24px;\n  line-height: 24px;\n  min-width: 0;\n  overflow: hidden;\n  text-overflow: ellipsis;\n"),v=(0,r.styled)("div",`\n  margin-top: 2px;\n  display: none;\n  .${f.className}-editing & {\n    display: flex;\n  }\n`),y=(0,r.styled)("div",`\n  flex: none;\n  height: 16px;\n  width: 16px;\n  border-radius: 16px;\n  display: none;\n  cursor: default;\n  --icon-color: ${i.theme.accessRulesColumnItemIconFg};\n  &:hover {\n    background-color: ${i.theme.accessRulesColumnItemIconHoverBg};\n    --icon-color: ${i.theme.accessRulesColumnItemIconHoverFg};\n  }\n  .${f.className}-editing & {\n    display: flex;\n  }\n`);var _=o(62802),x=o.n(_),C=o(50489),S=o(36322),I=o(88466),D=o.n(I);function R(e){const t=(0,r.dom)("div"),o=x().edit(t);function i(e){const{enableCustomCss:t}=(0,S.getGristConfig)(),i="dark"!==e.appearance||t?"chrome":"dracula";o.setTheme(`ace/theme/${i}`)}let s;i(e.gristTheme.get()),(0,S.getGristConfig)().enableCustomCss||(s=e.gristTheme.addListener((e=>{i(e)}))),o.setOptions({enableLiveAutocompletion:!0,maxLines:10}),o.renderer.setShowGutter(!1),o.renderer.setPadding(5),o.renderer.setScrollMargin(4,4,0,0),o.$blockScrolling=1/0,o.setReadOnly(e.readOnly),o.setFontSize("12"),o.setHighlightActiveLine(!1);const n=o.getSession();n.setMode("ace/mode/python"),n.setTabSize(2),n.setUseWrapMode(!1);const l=r.Observable.create(null,!e.initialValue.length);o.renderer.scroller.appendChild(k(r.dom.show(l),e.placeholder)),o.on("change",(()=>l.set(!o.getValue().length))),(0,C.setupAceEditorCompletions)(o,{getSuggestions:async function(t){return["and","or","not","in","is","True","False","None","OWNER","EDITOR","VIEWER","user","rec","newRec",...e.getSuggestions(t)].map((e=>[e,null]))}}),o.on("blur",(()=>e.setValue(o.getValue())));const a=D()((()=>e.setValue(o.getValue())),1e3);return o.on("change",a),o.commands.addCommand({name:"onEnter",bindKey:{win:"Enter",mac:"Enter"},exec:()=>o.blur()}),o.commands.removeCommands(["indent","outdent"]),o.setValue(e.initialValue),e.customiseEditor&&e.customiseEditor(o),T(r.dom.autoDispose(null!=s?s:null),T.cls("-disabled",e.readOnly),r.dom.on("mousedown",(()=>{o.focus()}),{useCapture:!0}),r.dom.onDispose((()=>o.destroy())),r.dom.onDispose((()=>a.cancel())),t)}const T=(0,r.styled)("div",`\n  width: 100%;\n  min-height: 28px;\n  padding: 1px;\n  border-radius: 3px;\n  border: 1px solid transparent;\n  cursor: pointer;\n\n  &:hover {\n    border: 1px solid ${i.theme.accessRulesFormulaEditorBorderHover};\n  }\n  &:not(&-disabled):focus-within {\n    box-shadow: inset 0 0 0 1px ${i.theme.accessRulesFormulaEditorFocus};\n    border-color: ${i.theme.accessRulesFormulaEditorFocus};\n  }\n  &:not(:focus-within) .ace_scroller, &-disabled .ace_scroller {\n    cursor: unset;\n  }\n  &-disabled, &-disabled:hover {\n    background-color: ${i.theme.accessRulesFormulaEditorBgDisabled};\n    box-shadow: unset;\n    border-color: transparent;\n  }\n  & .ace-chrome, & .ace-dracula {\n    background-color: ${i.theme.accessRulesFormulaEditorBg};\n  }\n  &-disabled .ace-chrome, &-disabled .ace-dracula {\n    background-color: ${i.theme.accessRulesFormulaEditorBgDisabled};\n  }\n  & .ace_marker-layer, & .ace_cursor-layer {\n    display: none;\n  }\n  &:not(&-disabled) .ace_focus .ace_marker-layer, &:not(&-disabled) .ace_focus .ace_cursor-layer {\n    display: block;\n  }\n`),k=(0,r.styled)("div","\n  padding: 4px 5px;\n  opacity: 0.5;\n"),M=(0,r.styled)("input",`\n  width: 100%;\n  min-height: 28px;\n  padding: 4px 5px;\n  border-radius: 3px;\n  border: 1px solid transparent;\n  cursor: pointer;\n  color: ${i.theme.accentText};\n  background-color: ${i.theme.inputBg};\n  caret-color : ${i.theme.inputFg};\n  font: 12px 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace;\n  overflow: hidden;\n  text-overflow: ellipsis;\n\n  &:hover {\n    border: 1px solid ${i.theme.inputBorder};\n  }\n  &:not(&-disabled):focus-within {\n    outline: none !important;\n    cursor: text;\n    box-shadow: inset 0 0 0 1px ${i.theme.accentBorder};\n    border-color: ${i.theme.accentBorder};\n  }\n`);var O=o(14400),A=o(76949),P=o(83277),F=o(70387),E=Object.defineProperty,B=Object.defineProperties,L=Object.getOwnPropertyDescriptors,$=Object.getOwnPropertySymbols,U=Object.prototype.hasOwnProperty,z=Object.prototype.propertyIsEnumerable,V=(e,t,o)=>t in e?E(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;const N=o(36812),j="RUCDS",W=(0,F.makeT)("PermissionsWidget");function H(e){switch(e){case"allow":return"";case"deny":return"allow"}return"deny"}function G(e,t){const o=(0,A.se)();for(const i of e)o[i]=t(i);return o}function K(e){return e?(0,n.menuIcon)("Tick"):q()}const J=(0,r.styled)("div","\n  display: flex;\n  gap: 4px;\n"),X=(0,r.styled)("div",`\n  flex: none;\n  height: 24px;\n  width: 24px;\n  border-radius: 2px;\n  font-size: 13px;\n  font-weight: 500;\n  border: 1px dashed ${i.colors.darkGrey};\n  color: ${i.colors.darkGrey};\n  cursor: pointer;\n\n  display: flex;\n  align-items: center;\n  justify-content: center;\n\n  &-allow {\n    background-color: ${i.colors.lightGreen};\n    border: 1px solid ${i.colors.lightGreen};\n    color: white;\n  }\n  &-deny {\n    background-image: linear-gradient(-45deg, ${i.colors.error} 14px, white 15px 16px, ${i.colors.error} 16px);\n    border: 1px solid ${i.colors.error};\n    color: white;\n  }\n  &.disabled {\n    opacity: 0.5;\n  }\n`),q=(0,r.styled)("div","\n  width: 24px;\n"),Y=(0,r.styled)(n.menuItem,"\n  align-items: start;\n  &.disabled {\n    opacity: unset;\n  }\n"),Z=(0,r.styled)("div","\n  display: flex;\n  flex-direction: column;\n"),Q=(0,r.styled)("div","\n  font-size: 12px;\n");var ee,te,oe,ie,se,ne,re=o(92769),le=o(98987),ae=o(11187),de=o(92478),ce=o(29002),ue=o(27771),he=o(4573),pe=o(413),me=o(42360),ge=o(631),fe=Object.defineProperty,we=Object.defineProperties,be=Object.getOwnPropertyDescriptors,ve=Object.getOwnPropertySymbols,ye=Object.prototype.hasOwnProperty,_e=Object.prototype.propertyIsEnumerable,xe=(e,t,o)=>t in e?fe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,Ce=(e,t)=>{for(var o in t||(t={}))ye.call(t,o)&&xe(e,o,t[o]);if(ve)for(var o of ve(t))_e.call(t,o)&&xe(e,o,t[o]);return e},Se=(e,t)=>we(e,be(t));const Ie=o(36812),De=(0,F.makeT)("AccessRules");class Re extends r.Disposable{constructor(e){super(),this.gristDoc=e,this._ruleCollection=new ue.Zu,this._tableRules=this.autoDispose((0,r.obsArray)()),this._docDefaultRuleSet=r.Observable.create(this,null),this._specialRulesWithDefault=r.Observable.create(this,null),this._specialRulesSeparate=r.Observable.create(this,null),this._userAttrRules=this.autoDispose((0,r.obsArray)()),this._errorMessage=r.Observable.create(this,""),this._ruleProblems=this.autoDispose((0,r.obsArray)()),this._aclResources=new Map,this._aclUsersPopup=O.P.create(this,this.gristDoc.docPageModel),this._ruleStatus=r.Computed.create(this,(e=>{const t=e(this._docDefaultRuleSet),o=e(this._tableRules),i=e(this._specialRulesWithDefault),s=e(this._specialRulesSeparate),n=e(this._userAttrRules);return Math.max(t?e(t.ruleStatus):0,Ge(o.length<this._ruleCollection.getAllTableIds().length),Ge(n.length<this._ruleCollection.getUserAttributeRules().size),...o.map((t=>e(t.ruleStatus))),...n.map((t=>e(t.ruleStatus))),i?e(i.ruleStatus):0,s?e(s.ruleStatus):0)})),this._savingEnabled=r.Computed.create(this,this._ruleStatus,((e,t)=>1===t)),this._userAttrChoices=r.Computed.create(this,this._userAttrRules,((e,t)=>{const o=[{ruleIndex:-1,value:"user.Access"},{ruleIndex:-1,value:"user.Email"},{ruleIndex:-1,value:"user.UserID"},{ruleIndex:-1,value:"user.Name"},{ruleIndex:-1,value:"user.LinkKey."},{ruleIndex:-1,value:"user.Origin"},{ruleIndex:-1,value:"user.SessionID"},{ruleIndex:-1,value:"user.IsLoggedIn"},{ruleIndex:-1,value:"user.UserRef"}];for(const[i,s]of t.entries()){const t=e(s.tableId),n=e(s.name);for(const e of this.getValidColIds(t)||[])o.push({ruleIndex:i,value:`user.${n}.${e}`})}return o}));for(const e of["_grist_ACLResources","_grist_ACLRules"]){const t=this.gristDoc.docData.getTable(e);this.autoDispose(t.tableActionEmitter.addListener(this._onChange,this))}this.autoDispose(this.gristDoc.docPageModel.currentDoc.addListener(this._updateDocAccessData,this)),this.update().catch((e=>this._errorMessage.set(e.message)))}get allTableIds(){return Array.from(this._aclResources.keys()).sort()}get userAttrRules(){return this._userAttrRules}get userAttrChoices(){return this._userAttrChoices}getTableTitle(e){const t=this._aclResources.get(e);return t?(0,he.jb)(t):`#Invalid (${e})`}async update(){if(this.isDisposed())return;this._errorMessage.set("");const e=this._ruleCollection,[,,t]=await Promise.all([e.update(this.gristDoc.docData,{log:console,pullOutSchemaEdit:!0}),this._updateDocAccessData(),this.gristDoc.docComm.getAclResources()]);if(this._aclResources=new Map(Object.entries(t.tables)),this._ruleProblems.set(t.problems),this.isDisposed())return;this._tableRules.set(e.getAllTableIds().filter((e=>e!==ue.GY)).map((t=>Te.create(this._tableRules,t,this,e.getAllColumnRuleSets(t),e.getTableDefaultRuleSet(t)))));const o=["SeedRule"],i=["SchemaEdit","FullCopies","AccessRules"];ke.create(this._specialRulesWithDefault,ue.GY,this,Je(o,e.getAllColumnRuleSets(ue.GY)),Ke(o,e.getTableDefaultRuleSet(ue.GY))),ke.create(this._specialRulesSeparate,ue.GY,this,Je(i,e.getAllColumnRuleSets(ue.GY)),Ke(i,e.getTableDefaultRuleSet(ue.GY))),Ae.create(this._docDefaultRuleSet,this,null,void 0,e.getDocDefaultRuleSet()),this._userAttrRules.set(Array.from(e.getUserAttributeRules().values(),(e=>Ue.create(this._userAttrRules,this,e))))}async save(){var e,t,o;if(!this._savingEnabled.get())return;const i=this.gristDoc.docData,s=i.getMetaTable("_grist_ACLResources"),n=i.getMetaTable("_grist_ACLRules"),r=Ve(s,We([{tableId:"*",colIds:"*"}],(null==(e=this._specialRulesWithDefault.get())?void 0:e.getResources())||[],(null==(t=this._specialRulesSeparate.get())?void 0:t.getResources())||[],...this._tableRules.get().map((e=>e.getResources()))).filter((e=>!(0,ue.k9)(e))).map((e=>Ce({id:-1},e))),je),l=r.rowIdMap.get(je({id:-1,tableId:"*",colIds:"*"}));if(!l)throw new Error("Default resource missing in resource map");const a=[];for(const e of this.getRules()){if(0===e.id)continue;let t;if((0,ue.k9)(e.resourceRec))t=l;else{const o=je(e.resourceRec);if(t=r.rowIdMap.get(o),!t)throw new Error(`Resource missing in resource map: ${o}`)}a.push({id:e.id||-1,resource:t,aclFormula:e.aclFormula,permissionsText:e.permissionsText,rulePos:e.rulePos||null,memo:null!=(o=e.memo)?o:""})}for(const e of this._userAttrRules.get()){const t=e.getRule();a.push({id:t.id||-1,resource:l,rulePos:t.rulePos||null,userAttributes:t.userAttributes})}let d=0,c=-1;for(let e=0;e<a.length;e++){const t=a[e].rulePos;if(t&&t>d){const o=(t-d)/(e-c);for(let t=c+1;t<e;t++)a[t].rulePos=d+o*(t-c);d=t,c=e}}for(let e=c+1;e<a.length;e++)a[e].rulePos=++d;const u=Ve(n,a);try{await i.sendActions([...r.userActions,...u.userActions])}catch(e){(0,re.reportError)(e)}await this.update()}buildDom(){return Xe((0,r.dom)("div",this.gristDoc.behavioralPromptsManager.attachTip("accessRules",{hideArrow:!0})),qe((0,ae.bigBasicButton)({disabled:!0},r.dom.hide(this._savingEnabled),r.dom.text((e=>{const t=e(this._ruleStatus);return De(3===t?"Checking...":0===t?"Saved":"Invalid")})),(0,i.testId)("rules-non-save")),(0,ae.bigPrimaryButton)(De("Save"),r.dom.show(this._savingEnabled),r.dom.on("click",(()=>this.save())),(0,i.testId)("rules-save")),(0,ae.bigBasicButton)(De("Reset"),r.dom.show((e=>0!==e(this._ruleStatus))),r.dom.on("click",(()=>this.update())),(0,i.testId)("rules-revert")),(0,ae.bigBasicButton)(De("Add Table Rules"),Ye("Dropdown"),{style:"margin-left: auto"},(0,n.menu)((()=>this.allTableIds.map((e=>(0,n.menuItemAsync)((()=>this._addTableRules(e)),this.getTableTitle(e),r.dom.cls("disabled",(t=>t(this._tableRules).some((t=>t.tableId===e)))))))))),(0,ae.bigBasicButton)(De("Add User Attributes"),r.dom.on("click",(()=>this._addUserAttributes()))),(0,ae.bigBasicButton)(De("View As"),Ye("Dropdown"),(e=>this._aclUsersPopup.attachPopup(e,{placement:"bottom-end",resetDocPage:!0})),r.dom.style("visibility",(e=>e(this._aclUsersPopup.isInitialized)?"":"hidden")))),it({style:"margin-left: 16px"},r.dom.text(this._errorMessage),(0,i.testId)("access-rules-error")),r.dom.maybe((e=>{const t=e(this._ruleProblems);return t.length>0?t:null}),(e=>Qe(_t(this.buildRuleProblemsDom(e))))),(0,le.a)(r.dom.maybe((e=>e(this._userAttrRules).length),(()=>Qe(et(De("User Attributes")),st(rt(ut(at.cls("-rborder"),at.cls("-center"),lt("Name")),pt(mt(ut(lt(De("Attribute to Look Up"))),ut(lt(De("Lookup Table"))),ut(lt(De("Lookup Column"))),dt()))),r.dom.forEach(this._userAttrRules,(e=>e.buildUserAttrDom())))))),r.dom.forEach(this._tableRules,(e=>e.buildDom())),Qe(et(De("Default Rules"),(0,i.testId)("rule-table-header")),r.dom.maybe(this._specialRulesWithDefault,(e=>It(e.buildCheckBoxes()))),st(rt(ut(at.cls("-rborder"),at.cls("-center"),lt("Columns")),pt(mt(dt(),ht(lt(De("Condition"))),ut(lt(De("Permissions"))),ct(),dt()))),r.dom.maybe(this._docDefaultRuleSet,(e=>e.buildRuleSetDom()))),(0,i.testId)("rule-table")),r.dom.maybe(this._specialRulesSeparate,(e=>e.buildDom()))))}buildRuleProblemsDom(e){const t=[];for(const o of e)if(o.tables&&this._addButtonsForMissingTables(t,o.tables.tableIds),o.columns&&this._addButtonsForMissingColumns(t,o.columns.tableId,o.columns.colIds),o.userAttributes){const e=o.userAttributes.names;this._addButtonsForMisconfiguredUserAttributes(t,e)}return t.map((e=>(0,r.dom)("span",e)))}getRules(){var e,t,o;return We(...this._tableRules.get().map((e=>e.getRules())),(null==(e=this._specialRulesWithDefault.get())?void 0:e.getRules())||[],(null==(t=this._specialRulesSeparate.get())?void 0:t.getRules())||[],(null==(o=this._docDefaultRuleSet.get())?void 0:o.getRules("*"))||[])}removeTableRules(e){He(this._tableRules,e)}removeUserAttributes(e){He(this._userAttrRules,e)}async checkAclFormula(e){return e?this.gristDoc.docComm.checkAclFormula(e):{}}checkTableColumns(e,t,o){var i;if(!e||e===ue.GY)return"";const s=null==(i=this._aclResources.get(e))?void 0:i.colIds;if(!s)return`Invalid table: ${e}`;if(t){const i=new Set([...s,...o||[]]),n=t.filter((e=>!i.has(e)));return 0===n.length?"":`Invalid columns in table ${e}: ${n.join(", ")}`}return""}getValidColIds(e){var t;return null==(t=this._aclResources.get(e))?void 0:t.colIds.filter((e=>!(0,ge.isHiddenCol)(e))).sort()}getSeedRules(){var e;return(null==(e=this._specialRulesWithDefault.get())?void 0:e.getCustomRules("SeedRule"))||[]}_addTableRules(e){if(this._tableRules.get().some((t=>t.tableId===e)))throw new Error(`Trying to add TableRules for existing table ${e}`);const t={tableId:e,colIds:"*",body:[]},o=Te.create(this._tableRules,e,this,void 0,t);this._tableRules.push(o),o.addDefaultRules(this.getSeedRules())}_addUserAttributes(){this._userAttrRules.push(Ue.create(this._userAttrRules,this,void 0,{focus:!0}))}_onChange(){0===this._ruleStatus.get()?this.update().catch((e=>this._errorMessage.set(e.message))):this._errorMessage.set("Access rules have changed. Click Reset to revert your changes and refresh the rules.")}async _updateDocAccessData(){await this._aclUsersPopup.load()}_addButtonsForMissingTables(e,t){for(const o of t){const t=De("Remove {{- tableId }} rules",{tableId:o}),i=(0,ae.bigBasicButton)(t,Ze("Remove"),r.dom.on("click",(async()=>{await Promise.all(this._tableRules.get().filter((e=>e.tableId===o)).map((e=>e.remove()))),i.style.display="none"})));e.push(i)}}_addButtonsForMissingColumns(e,t,o){const i=(e,t)=>{for(const o of e.columnRuleSets.get()){const e=new Set(o.getColIdList());e.has(t)&&(1===e.size?o.remove():o.removeColId(t))}};for(const s of o){const o=De("Remove column {{- colId }} from {{- tableId }} rules",{tableId:t,colId:s}),n=(0,ae.bigBasicButton)(o,Ze("Remove"),r.dom.on("click",(async()=>{await Promise.all(this._tableRules.get().filter((e=>e.tableId===t)).map((e=>i(e,s)))),n.style.display="none"})));e.push(n)}}_addButtonsForMisconfiguredUserAttributes(e,t){for(const o of t){const t=De("Remove {{- name }} user attribute",{name:o}),i=(0,ae.bigBasicButton)(t,Ze("Remove"),r.dom.on("click",(async()=>{await Promise.all(this._userAttrRules.get().filter((e=>e.name.get()===o)).map((e=>e.remove()))),i.style.display="none"})));e.push(i)}}}class Te extends r.Disposable{constructor(e,t,o,i){var s;super(),this.tableId=e,this._accessRules=t,this._colRuleSets=o,this._defRuleSet=i,this._columnRuleSets=this.autoDispose((0,r.obsArray)()),this._haveColumnRules=r.Computed.create(this,this._columnRuleSets,((e,t)=>t.length>0)),this._defaultRuleSet=r.Observable.create(this,null),this._columnRuleSets.set((null==(s=this._colRuleSets)?void 0:s.map((e=>this._createColumnObsRuleSet(this._columnRuleSets,this._accessRules,this,e,"*"===e.colIds?[]:e.colIds))))||[]),this._colRuleSets?this._defRuleSet&&Ae.create(this._defaultRuleSet,this._accessRules,this,this._haveColumnRules,this._defRuleSet):Ae.create(this._defaultRuleSet,this._accessRules,this,this._haveColumnRules),this.ruleStatus=r.Computed.create(this,(e=>{const t=e(this._columnRuleSets),o=e(this._defaultRuleSet);return Math.max(Ge(!this._colRuleSets||Boolean(o)!==Boolean(this._defRuleSet)||t.length<this._colRuleSets.length),o?e(o.ruleStatus):0,...t.map((t=>e(t.ruleStatus))))}))}getCustomRules(e){for(const t of this._columnRuleSets.get())if(t.getColIds()===e)return t.getCustomRules();return[]}addDefaultRules(e){const t=this._defaultRuleSet.get();null==t||t.addRuleParts(e,{foldEveryoneRule:!0})}remove(){this._accessRules.removeTableRules(this)}get columnRuleSets(){return this._columnRuleSets}buildDom(){return Qe(et((0,r.dom)("span",De("Rules for table "),tt(this._accessRules.getTableTitle(this.tableId))),(0,s.cssIconButton)((0,s.icon)("Dots"),{style:"margin-left: auto"},(0,n.menu)((()=>[(0,n.menuItemAsync)((()=>this._addColumnRuleSet()),De("Add Column Rule")),(0,n.menuItemAsync)((()=>this._addDefaultRuleSet()),De("Add Default Rule"),r.dom.cls("disabled",(e=>Boolean(e(this._defaultRuleSet))))),(0,n.menuItemAsync)((()=>this._accessRules.removeTableRules(this)),De("Delete Table Rules"))])),(0,i.testId)("rule-table-menu-btn")),(0,i.testId)("rule-table-header")),st(rt(ut(at.cls("-rborder"),at.cls("-center"),lt("Columns")),pt(mt(dt(),ht(lt(De("Condition"))),ut(lt(De("Permissions"))),ct(),dt()))),this.buildColumnRuleSets()),this.buildErrors(),(0,i.testId)("rule-table"))}buildColumnRuleSets(){return[r.dom.forEach(this._columnRuleSets,(e=>e.buildRuleSetDom())),r.dom.maybe(this._defaultRuleSet,(e=>e.buildRuleSetDom()))]}buildErrors(){return r.dom.forEach(this._columnRuleSets,(e=>it(r.dom.text(e.formulaError))))}getResources(){const e={allow:new Set,deny:new Set,mixed:new Set};for(const t of this._columnRuleSets.get()){const o=t.summarizePermissions(),i="mixed"===o?"mixed":"allow"===o?"deny":"allow",s=t.getColIdList();if(0===s.length)throw new re.UserError(`No columns listed in a column rule for table ${this.tableId}`);for(const t of s){if(e[i].has(t))throw new re.UserError(`Column ${t} appears in multiple rules for table ${this.tableId} that might be order-dependent. Try splitting rules up differently?`);"mixed"===o?(e.allow.add(t),e.deny.add(t),e.mixed.add(t)):(e[o].add(t),e.mixed.add(t))}}return[...this._columnRuleSets.get().map((e=>({tableId:this.tableId,colIds:e.getColIds()}))),{tableId:this.tableId,colIds:"*"}]}getRules(){var e;return We(...this._columnRuleSets.get().map((e=>e.getRules(this.tableId))),(null==(e=this._defaultRuleSet.get())?void 0:e.getRules(this.tableId))||[])}removeRuleSet(e){e===this._defaultRuleSet.get()?this._defaultRuleSet.set(null):He(this._columnRuleSets,e),this._defaultRuleSet.get()||0!==this._columnRuleSets.get().length||this._accessRules.removeTableRules(this)}_createColumnObsRuleSet(e,t,o,i,s){return Oe.create(e,t,o,i,s)}_addColumnRuleSet(){const e=Oe.create(this._columnRuleSets,this._accessRules,this,void 0,[]);this._columnRuleSets.push(e),e.addRuleParts(this._accessRules.getSeedRules(),{foldEveryoneRule:!0})}_addDefaultRuleSet(){this._defaultRuleSet.get()||(Ae.create(this._defaultRuleSet,this._accessRules,this,this._haveColumnRules),this.addDefaultRules(this._accessRules.getSeedRules()))}}class ke extends Te{buildDom(){return Qe(et(De("Special Rules"),(0,i.testId)("rule-table-header")),this.buildCheckBoxes(),(0,i.testId)("rule-table"))}buildCheckBoxes(){return[this.buildColumnRuleSets(),this.buildErrors()]}getResources(){return this._columnRuleSets.get().filter((e=>!e.hasOnlyBuiltInRules())).map((e=>({tableId:this.tableId,colIds:e.getColIds()})))}_createColumnObsRuleSet(e,t,o,i,s){return Ie(null==i?void 0:i.colIds,["SchemaEdit"])?$e.create(e,t,o,i,s):Be.create(e,t,o,i,s)}}class Me extends r.Disposable{constructor(e,t,o){var i;super(),this.accessRules=e,this._tableRules=t,this._ruleSet=o,this._body=this.autoDispose((0,r.obsArray)());const s=(null==(i=this._ruleSet)?void 0:i.body.map((e=>ze.create(this._body,this,e))))||[];0===s.length&&s.push(ze.create(this._body,this,void 0)),this._body.set(s),this.ruleStatus=r.Computed.create(this,this._body,((e,t)=>{var o,i;return Math.max(Ge(t.filter((t=>!t.isEmpty(e))).length<((null==(i=null==(o=this._ruleSet)?void 0:o.body)?void 0:i.length)||0)),...t.map((t=>e(t.ruleStatus))))}))}remove(){var e;null==(e=this._tableRules)||e.removeRuleSet(this)}getRules(e){return this._body.get().map((t=>Se(Ce({},t.getRulePart()),{resourceRec:{tableId:e,colIds:this.getColIds()}}))).filter((e=>e.aclFormula||e.permissionsText))}getColIds(){return"*"}summarizePermissions(){return(0,A.WR)(this._body.get().map((e=>e.summarizePermissions())))}buildRuleSetDom(){return nt(ut(at.cls("-rborder"),this.buildResourceDom(),(0,i.testId)("rule-resource")),pt(gt.cls(""),r.dom.forEach(this._body,(e=>e.buildRulePartDom())),r.dom.maybe((e=>!this.hasDefaultCondition(e)),(()=>mt({style:"min-height: 28px"},dt((0,s.cssIconButton)((0,s.icon)("Plus"),r.dom.on("click",(()=>this.addRulePart(null))),(0,i.testId)("rule-add"))),(0,i.testId)("rule-extra-add"))))),(0,i.testId)("rule-set"))}removeRulePart(e){var t;He(this._body,e),0===this._body.get().length&&(null==(t=this._tableRules)||t.removeRuleSet(this))}addRulePart(e,t,o=!1){const i=this._body.get(),s=e?i.indexOf(e):i.length,n=ze.create(this._body,this,t,o);return this._body.splice(s,0,n),n}addRuleParts(e,t){var o;if(t.foldEveryoneRule){const t=this._body.get(),i=1!==t.length||t[0].getRulePart().aclFormula?null:t[0],s=(null==(o=e[e.length-1])?void 0:o.getRulePart().aclFormula)?null:e[e.length-1];i&&s&&He(this._body,i)}for(const t of[...e].reverse()){const{permissionsText:e,aclFormula:o,memo:i}=t.getRulePart();void 0!==e&&void 0!==o&&this.addRulePart(this.getFirst()||null,{aclFormula:o,permissionsText:e,permissions:(0,A.$5)(e),memo:i},!0)}}getFirstBuiltIn(){return this._body.get().find((e=>e.isBuiltIn()))}getFirst(){return this._body.get()[0]}isSoleCondition(e,t){const o=e(this._body);return 1===o.length&&o[0]===t}isLastCondition(e,t){const o=e(this._body);return o[o.length-1]===t}hasDefaultCondition(e){const t=e(this._body);return t.length>0&&t[t.length-1].hasEmptyCondition(e)}getAvailableBits(){return["read","update","create","delete"]}getValidColIds(){var e;const t=null==(e=this._tableRules)?void 0:e.tableId;return t&&this.accessRules.getValidColIds(t)||[]}hasColumns(){return!1}hasOnlyBuiltInRules(){return this._body.get().every((e=>e.isBuiltIn()))}getCustomRules(){return this._body.get().filter((e=>!e.isBuiltInOrEmpty()))}}class Oe extends Me{constructor(e,t,o,i){super(e,t,o),this._initialColIds=i,this._colIds=r.Observable.create(this,this._initialColIds),this.formulaError=r.Computed.create(this,(o=>e.checkTableColumns(t.tableId,o(this._colIds),this._initialColIds)));const s=this.ruleStatus;this.ruleStatus=r.Computed.create(this,(e=>e(this.formulaError)?2:Math.max(Ge(!Ie(e(this._colIds),this._initialColIds)),e(s))))}buildResourceDom(){return function(e,t){function o(){!d.matches(".weasel-popup-open")&&e.get().length>0&&a.set(!1)}const n=r.Computed.create(null,(e=>"")).onWrite((t=>{setTimeout((()=>{return o=t,e.set([...e.get(),o]),void d.focus();var o}),0)})),l=r.Computed.create(null,e,((e,o)=>{const i=new Set(o);return t.filter((e=>!i.has(e)))})),a=r.Observable.create(null,!e.get().length);let d;return f({tabIndex:"0"},r.dom.autoDispose(l),f.cls("-editing",a),r.dom.on("focus",(function(e){a.set(!0),e.relatedTarget!==d&&d.focus()})),r.dom.forEach(e,(t=>w(b(t),y((0,s.icon)("CrossSmall"),r.dom.on("click",(()=>function(t){e.set(e.get().filter((e=>e!==t)))}(t))),(0,i.testId)("acl-col-remove")),(0,i.testId)("acl-column")))),v(r.dom.update(d=h(n,l,{defaultLabel:"[Add Column]"}),p.cls("-active"),r.dom.on("blur",o),r.dom.onKeyDown({Escape:o}),a.get()?e=>{setTimeout((()=>e.focus()),0)}:null)))}(this._colIds,this._getValidColIdsList())}getColIdList(){return this._colIds.get()}removeColId(e){this._colIds.set(this._colIds.get().filter((t=>t!==e)))}getColIds(){return this._colIds.get().join(",")}getAvailableBits(){return["read","update"]}hasColumns(){return!0}_getValidColIdsList(){return this.getValidColIds().filter((e=>"id"!==e))}}class Ae extends Me{constructor(e,t,o,i){super(e,t,i),this._haveColumnRules=o}buildResourceDom(){return[vt.cls(""),yt(r.dom.text((e=>this._haveColumnRules&&e(this._haveColumnRules)?"All Other":"All")))]}}const Pe={permissions:"+S",formula:"user.Access == EDITOR"},Fe={permissions:"-S",formula:"user.Access != OWNER"},Ee={AccessRules:{name:De("Permission to view Access Rules"),description:De("Allow everyone to view Access Rules."),availableBits:["read"],permissions:"+R",formula:"True"},FullCopies:{name:De("Permission to access the document in full when needed"),description:De("Allow everyone to copy the entire document, or view it in full in fiddle mode.\nUseful for examples and templates, but not for sensitive data."),availableBits:["read"],permissions:"+R",formula:"True"},SeedRule:{name:De("Seed rules"),description:De("When adding table rules, automatically add a rule to grant OWNER full access."),availableBits:["read","create","update","delete"],permissions:"+CRUD",formula:"user.Access in [OWNER]"},SchemaEdit:Ce({name:De("Permission to edit document structure"),description:De("Allow editors to edit structure (e.g. modify and delete tables, columns, layouts), and to write formulas, which give access to all data regardless of read restrictions."),availableBits:["schemaEdit"]},Fe)};class Be extends Oe{constructor(){super(...arguments),this._isExpanded=r.Observable.create(this,!1)}get props(){return e=this.getColIds(),Ee[e]||Se(Ce({},Ee.AccessRules),{name:e,description:e});var e}buildRuleSetDom(){const e=this._createIsNonStandardObs(),t=this._createIsCheckedObs(e);return e.get()&&this._isExpanded.set(!0),(0,r.dom)("div",r.dom.autoDispose(t),r.dom.autoDispose(e),ft((0,s.cssIconButton)((0,s.icon)("Expand"),r.dom.style("transform",(e=>e(this._isExpanded)?"rotate(90deg)":"")),r.dom.on("click",(()=>this._isExpanded.set(!this._isExpanded.get()))),(0,i.testId)("rule-special-expand"),{style:"margin: -4px"}),wt(t,r.dom.prop("disabled",e),(0,i.testId)("rule-special-checkbox")),this.props.description),this._buildDomWarning(),r.dom.maybe(this._isExpanded,(()=>st({style:"margin-left: 56px"},rt(dt(),pt(lt(this.props.name)),ut(lt("Permissions")),ct(),dt()),nt(gt.cls(""),r.dom.forEach(this._body,(e=>e.buildRulePartDom(!0))),r.dom.maybe((e=>!this.hasDefaultCondition(e)),(()=>mt({style:"min-height: 28px"},dt((0,s.cssIconButton)((0,s.icon)("Plus"),r.dom.on("click",(()=>this.addRulePart(null))),(0,i.testId)("rule-add"))),(0,i.testId)("rule-extra-add"))))),(0,i.testId)("rule-set")))),(0,i.testId)("rule-special"),(0,i.testId)(`rule-special-${this.getColIds()}`))}getAvailableBits(){return this.props.availableBits}removeRulePart(e){He(this._body,e),0===this._body.get().length&&(this._isExpanded.set(!1),this._allowEveryone(!1))}_buildDomWarning(){return null}_createIsNonStandardObs(){return r.Computed.create(null,this._body,((e,t)=>!t.every((t=>t.isBuiltInOrEmpty(e)||t.matches(e,this.props.formula,this.props.permissions)))))}_createIsCheckedObs(e){return r.Computed.create(null,this._body,((t,o)=>!t(e)&&!o.every((e=>e.isBuiltInOrEmpty(t))))).onWrite((e=>this._allowEveryone(e)))}_allowEveryone(e){const t=this._body.get().filter((e=>e.isBuiltIn()));if(e){const e=Le(this.props);this._body.set([ze.create(this._body,this,e,!0),...t])}else this._body.set(t),0===t.length&&this._body.push(ze.create(this._body,this,void 0))}}function Le({permissions:e,formula:t}){return{aclFormula:t,permissionsText:e,permissions:(0,A.$5)(e)}}class $e extends Be{_buildDomWarning(){return r.dom.maybe((e=>e(this._body).every((t=>t.isBuiltInOrEmpty(e)))),(()=>it({style:"margin-left: 56px; margin-bottom: 8px;"},De("This default should be changed if editors' access is to be limited. "),(0,r.dom)("a",{style:"color: inherit; text-decoration: underline"},"Dismiss",r.dom.on("click",(()=>this._allowEditors("confirm")))),(0,i.testId)("rule-schema-edit-warning"))))}_createIsNonStandardObs(){return r.Computed.create(null,this._body,((e,t)=>!t.every((t=>t.isBuiltInOrEmpty(e)||t.matches(e,this.props.formula,this.props.permissions)||t.matches(e,Pe.formula,Pe.permissions)))))}_createIsCheckedObs(e){return r.Computed.create(null,this._body,((e,t)=>t.every((t=>t.isBuiltInOrEmpty(e)||t.matches(e,Pe.formula,Pe.permissions))))).onWrite((e=>this._allowEditors(e)))}_allowEditors(e){const t=this._body.get().filter((e=>e.isBuiltIn()));if("confirm"===e){const e=Le(Pe);this._body.set([ze.create(this._body,this,e,!0),...t])}else if(e)this._body.set(t);else{const e=Le(Fe);this._body.set([ze.create(this._body,this,e,!0),...t])}}}class Ue extends r.Disposable{constructor(e,t,o={}){super(),this._accessRules=e,this._userAttr=t,this._options=o,this._name=r.Observable.create(this,(null==(ee=this._userAttr)?void 0:ee.name)||""),this._tableId=r.Observable.create(this,(null==(te=this._userAttr)?void 0:te.tableId)||""),this._lookupColId=r.Observable.create(this,(null==(oe=this._userAttr)?void 0:oe.lookupColId)||""),this._charId=r.Observable.create(this,"user."+((null==(ie=this._userAttr)?void 0:ie.charId)||"")),this._validColIds=r.Computed.create(this,this._tableId,((e,t)=>this._accessRules.getValidColIds(t)||[])),this._userAttrError=r.Observable.create(this,""),this.formulaError=r.Computed.create(this,this._tableId,this._lookupColId,this._userAttrError,((t,o,i,s)=>{var n,r;return s.length?s:t(this._tableId)===(null==(n=this._userAttr)?void 0:n.tableId)&&t(this._lookupColId)===(null==(r=this._userAttr)?void 0:r.lookupColId)?"":e.checkTableColumns(o,i?[i]:void 0)})),this.ruleStatus=r.Computed.create(this,(e=>{var t,o,i,s;return e(this.formulaError)?2:Ge(e(this._name)!==(null==(t=this._userAttr)?void 0:t.name)||e(this._tableId)!==(null==(o=this._userAttr)?void 0:o.tableId)||e(this._lookupColId)!==(null==(i=this._userAttr)?void 0:i.lookupColId)||e(this._charId)!=="user."+(null==(s=this._userAttr)?void 0:s.charId))})),this.autoDispose(this._tableId.addListener((()=>this._lookupColId.set("")))),this._userAttrChoices=r.Computed.create(this,e.userAttrRules,((e,t)=>{const o=t.indexOf(this);return e(this._accessRules.userAttrChoices).filter((e=>e.ruleIndex<o))}))}remove(){this._accessRules.removeUserAttributes(this)}get name(){return this._name}get tableId(){return this._tableId}buildUserAttrDom(){return nt(ut(at.cls("-rborder"),bt(ot(this._name,(async e=>this._name.set(e)),{placeholder:De("Attribute name")},this._options.focus?e=>{setTimeout((()=>e.focus()),0)}:null,(0,i.testId)("rule-userattr-name")))),pt(gt.cls(""),mt(ut(R({gristTheme:this._accessRules.gristDoc.currentTheme,initialValue:this._charId.get(),readOnly:!1,setValue:e=>this._setUserAttr(e),placeholder:"",getSuggestions:()=>this._userAttrChoices.get().map((e=>e.value)),customiseEditor:e=>{e.on("focus",(()=>{var t;"user."==e.getValue()&&(null==(t=e.completer)||t.showPopup(e))}))}}),(0,i.testId)("rule-userattr-attr")),ut(h(this._tableId,this._accessRules.allTableIds.map((e=>({value:e,label:this._accessRules.getTableTitle(e)}))),{defaultLabel:"[Select Table]"}),(0,i.testId)("rule-userattr-table")),ut(h(this._lookupColId,this._validColIds,{defaultLabel:"[Select Column]"}),(0,i.testId)("rule-userattr-col")),dt((0,s.cssIconButton)((0,s.icon)("Remove"),r.dom.on("click",(()=>this._accessRules.removeUserAttributes(this))))),r.dom.maybe(this.formulaError,(e=>it(e,(0,i.testId)("rule-error")))))),(0,i.testId)("rule-userattr"))}getRule(){var e,t,o,i;const s=this._charId.get().trim(),n=s.startsWith("user.")?s.substring("user.".length):s,r={name:this._name.get(),tableId:this._tableId.get(),lookupColId:this._lookupColId.get(),charId:n};for(const[e,t]of Object.entries(r))if(!t)throw new re.UserError(`Invalid user attribute rule: ${e} must be set`);if(this._getUserAttrError(s))throw new re.UserError("Invalid user attribute to look up");return{id:null==(t=null==(e=this._userAttr)?void 0:e.origRecord)?void 0:t.id,rulePos:null==(i=null==(o=this._userAttr)?void 0:o.origRecord)?void 0:i.rulePos,userAttributes:JSON.stringify(r)}}_setUserAttr(e){e!==this._charId.get()&&(this._charId.set(e),this._userAttrError.set(this._getUserAttrError(e)||""))}_getUserAttrError(e){return(e=e.trim()).startsWith("user.LinkKey")?/user\.LinkKey\.\w+$/.test(e)?null:"Use a simple attribute of user.LinkKey, e.g. user.LinkKey.something":this._userAttrChoices.get().map((e=>e.value)).includes(e)?null:"Not a valid user attribute"}}class ze extends r.Disposable{constructor(e,t,o=!1){var i;super(),this._ruleSet=e,this._rulePart=t,this._aclFormula=r.Observable.create(this,(null==(se=this._rulePart)?void 0:se.aclFormula)||""),this._completions=r.Computed.create(this,(e=>[...e(this._ruleSet.accessRules.userAttrChoices).map((e=>e.value)),...this._ruleSet.getValidColIds().map((e=>`rec.${e}`)),...this._ruleSet.getValidColIds().map((e=>`$${e}`)),...this._ruleSet.getValidColIds().map((e=>`newRec.${e}`))])),this._permissions=r.Observable.create(this,(null==(ne=this._rulePart)?void 0:ne.permissions)||(0,A.se)()),this._checkPending=r.Observable.create(this,!1),this._formulaError=r.Observable.create(this,""),this._formulaProperties=r.Observable.create(this,function(e){var t;const o=null==(t=null==e?void 0:e.origRecord)?void 0:t.aclFormulaParsed;return o?(0,me.W)(JSON.parse(String(o))):{}}(this._rulePart)),this._memo=r.Observable.create(this,null!=(i=null==t?void 0:t.memo)?i:""),t&&o&&(this._rulePart=void 0),this._showMemoEditor=r.Observable.create(this,!this.isBuiltIn()&&""!==this._memo.get()),this._error=r.Computed.create(this,(e=>e(this._formulaError)||this._warnInvalidColIds(e(this._formulaProperties).usedColIds)||(this._ruleSet.isLastCondition(e,this)||""!==e(this._aclFormula)||""===(0,A.$1)(e(this._permissions))?"":"Condition cannot be blank")));const s=(0,A.se)();this.ruleStatus=r.Computed.create(this,(e=>{var t,o,i,n,r,l;return e(this._error)?2:e(this._checkPending)?3:Ge(e(this._aclFormula)!==(null!=(o=null==(t=this._rulePart)?void 0:t.aclFormula)?o:"")||e(this._memo)!==(null!=(n=null==(i=this._rulePart)?void 0:i.memo)?n:"")||!Ie(e(this._permissions),null!=(l=null==(r=this._rulePart)?void 0:r.permissions)?l:s))}))}getRulePart(){var e,t,o,i;return{id:this.isBuiltIn()?0:null==(t=null==(e=this._rulePart)?void 0:e.origRecord)?void 0:t.id,aclFormula:this._aclFormula.get(),permissionsText:(0,A.$1)(this._permissions.get()),rulePos:null==(i=null==(o=this._rulePart)?void 0:o.origRecord)?void 0:i.rulePos,memo:this._memo.get()}}hasEmptyCondition(e){return""===e(this._aclFormula)}matches(e,t,o){return e(this._aclFormula)===t&&(0,A.$1)(e(this._permissions))===o}summarizePermissions(){return(0,A.tg)(this._permissions.get())}sanityCheck(e){}buildRulePartDom(e=!1){return xt(mt(dt(this._isNonFirstBuiltIn()?null:(0,s.cssIconButton)((0,s.icon)("Plus"),r.dom.on("click",(()=>this._ruleSet.addRulePart(this))),(0,i.testId)("rule-add"))),ht(e?pt.cls(""):null,R({gristTheme:this._ruleSet.accessRules.gristDoc.currentTheme,initialValue:this._aclFormula.get(),readOnly:this.isBuiltIn(),setValue:e=>this._setAclFormula(e),placeholder:r.dom.text((e=>this._ruleSet.isSoleCondition(e,this)?De("Everyone"):this._ruleSet.isLastCondition(e,this)?De("Everyone Else"):De("Enter Condition"))),getSuggestions:e=>this._completions.get()}),(0,i.testId)("rule-acl-formula")),ut(at.cls("-stretch"),function(e,t,o,...l){e=e.sort(((e,t)=>j.indexOf(e.slice(0,1).toUpperCase())-j.indexOf(t.slice(0,1).toUpperCase())));const a=(0,A.se)(),d=G(e,(()=>"allow")),c=G(e,(()=>"deny")),u=G(e,(e=>"read"===e?"allow":"deny")),h=e=>{var i;null==(i=o.sanityCheck)||i.call(o,e),t.set(e)};return J(r.dom.forEach(e,(e=>X(e.slice(0,1).toUpperCase(),X.cls((o=>"-"+o(t)[e])),r.dom.attr("title",(o=>(0,P.capitalize)(`${o(t)[e]} ${e}`.trim()))),r.dom.cls("disabled",o.disabled),o.disabled?null:r.dom.on("click",(()=>{return h((o=((e,t)=>{for(var o in t||(t={}))U.call(t,o)&&V(e,o,t[o]);if($)for(var o of $(t))z.call(t,o)&&V(e,o,t[o]);return e})({},t.get()),i={[e]:H(t.get()[e])},B(o,L(i))));var o,i}))))),(0,s.cssIconButton)((0,s.icon)("Dropdown"),(0,i.testId)("permissions-dropdown"),(0,n.menu)((()=>[[d,c,u,a].every((e=>!N(e,t.get())))?Y((()=>null),r.dom.cls("disabled"),(0,n.menuIcon)("Tick"),Z("Custom",Q(r.dom.text((e=>function(e){const t=[],o=[];for(const i of A.Md){const s=e[i];"allow"===s?t.push((0,P.capitalize)(i)):"deny"===s&&o.push((0,P.capitalize)(i))}const i=[];return t.length&&i.push(`Allow ${t.join(", ")}.`),o.length&&i.push(`Deny ${o.join(", ")}.`),i.join(" ")}(e(t))))))):null,Y((()=>h(d)),K(N(t.get(),d)),W("Allow All"),r.dom.cls("disabled",o.disabled)),Y((()=>h(c)),K(N(t.get(),c)),W("Deny All"),r.dom.cls("disabled",o.disabled)),Y((()=>h(u)),K(N(t.get(),u)),W("Read Only"),r.dom.cls("disabled",o.disabled)),Y((()=>h(a)),N(t.get(),a)?[K(!0),"No Effect"]:[K(!1),"Clear"],r.dom.cls("disabled",o.disabled))]))),...l)}(this._ruleSet.getAvailableBits(),this._permissions,{disabled:this.isBuiltIn(),sanityCheck:e=>this.sanityCheck(e)},(0,i.testId)("rule-permissions"))),ct(r.dom.maybe((e=>!this.isBuiltIn()&&!e(this._showMemoEditor)),(()=>(0,s.cssIconButton)((0,s.icon)("Memo"),r.dom.on("click",(()=>{this._showMemoEditor.set(!0),setTimeout((()=>{var e;return null==(e=this._memoEditor)?void 0:e.focus()}),0)})),(0,i.testId)("rule-memo-add"))))),dt(this.isBuiltIn()?null:(0,s.cssIconButton)((0,s.icon)("Remove"),r.dom.on("click",(()=>this._ruleSet.removeRulePart(this))),(0,i.testId)("rule-remove"))),r.dom.maybe(this._error,(e=>it(e,(0,i.testId)("rule-error")))),(0,i.testId)("rule-part")),r.dom.maybe(this._showMemoEditor,(()=>Ct(dt(),St("Memo"),ht(e?pt.cls(""):null,this._memoEditor=function(e,...t){return M(r.dom.prop("value",e),r.dom.on("input",((t,o)=>e.set(o.value))),...t)}(this._memo,{placeholder:De("Type a message...")},r.dom.onKeyDown({Enter:(e,t)=>t.blur()})),(0,i.testId)("rule-memo-editor")),ct(),dt((0,s.cssIconButton)((0,s.icon)("Remove"),r.dom.on("click",(()=>{this._showMemoEditor.set(!1),this._memo.set("")})),(0,i.testId)("rule-memo-remove"))),(0,i.testId)("rule-memo")))),(0,i.testId)("rule-part-and-memo"))}isBuiltIn(){var e;return!!this._rulePart&&!(null==(e=this._rulePart.origRecord)?void 0:e.id)}isEmpty(e=P.unwrap){return""===e(this._aclFormula)&&Ie(e(this._permissions),(0,A.se)())&&""===e(this._memo)}isBuiltInOrEmpty(e=P.unwrap){return this.isBuiltIn()||this.isEmpty(e)}_isNonFirstBuiltIn(){return this.isBuiltIn()&&this._ruleSet.getFirstBuiltIn()!==this}async _setAclFormula(e){if(e!==this._aclFormula.get()){this._aclFormula.set(e),this._checkPending.set(!0),this._formulaProperties.set({}),this._formulaError.set("");try{this._formulaProperties.set(await this._ruleSet.accessRules.checkAclFormula(e)),this.sanityCheck()}catch(e){this._formulaError.set(e.message)}finally{this._checkPending.set(!1)}}}_warnInvalidColIds(e){if(!e||!e.length)return!1;const t=new Set(this._ruleSet.getValidColIds()),o=e.filter((e=>!t.has(e)));return o.length>0?`Invalid columns: ${o.join(", ")}`:void 0}}function Ve(e,t,o=(e=>String(e.id))){const i=e.getRecords(),s=new Map(i.map((e=>[o(e),e.id]))),n=new Map(t.map((e=>[o(e),e]))),r=i.filter((e=>!n.has(o(e)))),l=t.filter((e=>!s.has(o(e)))).map(((e,t)=>Se(Ce({},e),{id:-(t+1)}))),a=i.map((e=>{const t=n.get(o(e)),i=t&&Se(Ce(Ce({},e),t),{id:e.id});return i&&!Ie(i,e)?[e,i]:null})).filter(P.isNonNullish);console.log("syncRecords: removing [%s], adding [%s], updating [%s]",r.map(o).join(", "),l.map(o).join(", "),a.map((([e])=>o(e))).join(", "));const d=e.tableId,c=[];return r.length>0&&c.push(["BulkRemoveRecord",d,r.map((e=>e.id))]),a.length>0&&c.push(["BulkUpdateRecord",d,a.map((([e])=>e.id)),Ne(a)]),l.length>0&&c.push(["BulkAddRecord",d,l.map((e=>e.id)),(0,pe.Iq)(l)]),l.forEach((e=>s.set(o(e),e.id))),{userActions:c,rowIdMap:s}}function Ne(e){const t=new Set;for(const[o,i]of e)for(const e of Object.keys(i))"id"===e||Ie(o[e],i[e])||t.add(e);const o={};for(const i of t)o[i]=e.map((([e,t])=>t[i]));return o}function je(e){return JSON.stringify([e.tableId,e.colIds])}function We(...e){return[].concat(...e)}function He(e,t){const o=e.get().indexOf(t);return o>=0&&(e.splice(o,1),!0)}function Ge(e){return e?1:0}function Ke(e,t){if(t){if("*"===t.colIds)return t;for(const o of t.colIds)if(e.includes(o))return t}}function Je(e,t){return t.map((t=>Ke(e,t))).filter((e=>e))}const Xe=(0,r.styled)("div","\n  flex: auto;\n  height: 100%;\n  width: 100%;\n  max-width: 800px;\n  margin: 0 auto;\n  display: flex;\n  flex-direction: column;\n"),qe=(0,r.styled)("div","\n  flex: none;\n  margin: 16px 16px 8px 16px;\n  display: flex;\n  gap: 16px;\n"),Ye=(0,r.styled)(s.icon,"\n  margin: -2px -2px 0 4px;\n"),Ze=(0,r.styled)(s.icon,"\n  margin: -2px -2px 0 4px;\n"),Qe=(0,r.styled)("div","\n  margin: 16px 16px 24px 16px;\n"),et=(0,r.styled)("div",`\n  display: flex;\n  align-items: center;\n  margin-bottom: 8px;\n  font-weight: bold;\n  color: ${i.theme.lightText};\n`),tt=(0,r.styled)("span",`\n  color: ${i.theme.text};\n`),ot=(0,r.styled)(ce.textInput,`\n  color: ${i.theme.inputFg};\n  background-color: ${i.theme.inputBg};\n  width: 100%;\n  border: 1px solid transparent;\n  cursor: pointer;\n\n  &:hover {\n    border: 1px solid ${i.theme.inputBorder};\n  }\n  &:focus {\n    box-shadow: inset 0 0 0 1px ${i.theme.controlFg};\n    border-color: ${i.theme.controlFg};\n    cursor: unset;\n  }\n  &[disabled] {\n    color: ${i.theme.inputDisabledFg};\n    background-color: ${i.theme.inputDisabledBg};\n    box-shadow: unset;\n    border-color: transparent;\n  }\n  &::placeholder {\n    color: ${i.theme.inputPlaceholderFg};\n  }\n`),it=(0,r.styled)("div",`\n  margin-top: 4px;\n  width: 100%;\n  color: ${i.theme.errorText};\n`),st=(0,r.styled)("div",`\n  border: 1px solid ${i.theme.accessRulesTableBorder};\n  border-radius: 8px;\n  overflow: hidden;\n`),nt=(0,r.styled)("div",`\n  display: flex;\n  border-bottom: 1px solid ${i.theme.accessRulesTableBorder};\n  &:last-child {\n    border-bottom: none;\n  }\n`),rt=(0,r.styled)(nt,`\n  background-color: ${i.theme.accessRulesTableHeaderBg};\n  color: ${i.theme.accessRulesTableHeaderFg};\n`),lt=(0,r.styled)("div","\n  margin: 4px 8px;\n  text-transform: uppercase;\n  font-weight: 500;\n  font-size: 10px;\n"),at=(0,r.styled)("div",`\n  min-width: 0px;\n  overflow: hidden;\n\n  &-rborder {\n    border-right: 1px solid ${i.theme.accessRulesTableBorder};\n  }\n  &-center {\n    text-align: center;\n  }\n  &-stretch {\n    min-width: unset;\n    overflow: visible;\n  }\n`),dt=(0,r.styled)(at,"flex: none; width: 24px;"),ct=(0,r.styled)(dt,"margin: 0px 8px;"),ut=(0,r.styled)(at,"flex: 1;"),ht=(0,r.styled)(at,"flex: 2;"),pt=(0,r.styled)(at,"flex: 4;"),mt=(0,r.styled)("div","\n  display: flex;\n  align-items: center;\n  gap: 0px 8px;\n  margin: 0 8px;\n  flex-wrap: wrap;\n"),gt=(0,r.styled)("div","\n  display: flex;\n  flex-direction: column;\n  gap: 4px;\n  margin: 4px 0;\n"),ft=(0,r.styled)("div",`\n  color: ${i.theme.text};\n  display: flex;\n  align-items: top;\n  margin: 16px 0 8px 0;\n  gap: 12px;\n  white-space: pre-line;  /* preserve line breaks in long descriptions */\n`),wt=(0,r.styled)(de.n2,"\n  flex: none;\n"),bt=(0,r.styled)("div","\n  margin: 4px 8px;\n"),vt=(0,r.styled)("div","\n  display: flex;\n  align-items: center;\n  justify-content: center;\n"),yt=(0,r.styled)("div",`\n  color: ${i.theme.accessRulesTableBodyFg};\n  font-weight: bold;\n`),_t=(0,r.styled)("div","\n  flex: auto;\n  height: 100%;\n  width: 100%;\n  display: flex;\n  flex-direction: row;\n  flex-wrap: wrap;\n  gap: 8px;\n"),xt=(0,r.styled)("div","\n  display: flex;\n  flex-direction: column;\n  row-gap: 4px;\n"),Ct=(0,r.styled)(mt,"\n  margin-bottom: 8px;\n"),St=(0,r.styled)(s.icon,`\n  --icon-color: ${i.theme.accentIcon};\n  margin-left: 8px;\n  margin-right: 8px;\n`),It=(0,r.styled)("div","\n  margin-bottom: 16px;\n");var Dt=o(88438),Rt=o(81294),Tt=o.n(Rt),kt=o(85550),Mt=o(29301),Ot=o(13988),At=o.n(Ot),Pt=o(92979),Ft=o(73783),Et=o(549);const Bt=window.gristNotify,Lt="undone",$t="default",Ut=(0,F.makeT)("ActionLog");class zt extends Dt.Disposable{constructor(){super(...arguments),this._pending=[],this._loaded=!1}create(e){this._showAllTables=Mt.observable(!1),this._loading=Mt.observable(!1),this._gristDoc=e.gristDoc,this._displayStack=At()(),this._selectedTableId=this.autoDispose(Mt.computed((()=>{if(!this._gristDoc||this._gristDoc.viewModel.isDisposed())return"";const e=this._gristDoc.viewModel.activeSection();if(!e||e.isDisposed())return"";const t=e.table();return t&&!t.isDisposed()?t.tableId():""})))}buildDom(){return this._buildLogDom()}pushAction(e){if(this._loading())return void this._pending.push(e);this._setupFilters(e,this._displayStack.at(0)||void 0);const t=e.otherId?this._displayStack.all().find((t=>t.actionNum===e.otherId)):null;if(t)t.state&&t.state(e.isUndo?Lt:$t);else{if(e.fromSelf)for(let e=0;e<this._displayStack.peekLength;e++){const t=this._displayStack.at(e);if(!t.state)continue;const o=t.state();if(t.fromSelf&&o===$t)break;t.fromSelf&&o===Lt&&t.state("buried")}e.otherId||(e.state=Mt.observable($t),this._displayStack.unshift(e))}}renderTabularDiffs(e,t,o){const i=(0,Et.$g)(e);return Tt()("div",this._renderTableSchemaChanges(e,o),this._renderColumnSchemaChanges(e,o),Object.entries(i).map((([e,t])=>0===t.cells.length?Tt()("div"):Tt()("table.action_log_table",Pt.show((()=>this._showForTable(e,o))),Tt()("caption",this._renderTableName(e)),Tt()("tr",Tt()("th"),t.header.map((e=>Tt()("th",this._renderCell(e))))),t.cells.map((t=>Tt()("tr",Tt()("td",this._renderCell(t[0])),t[2].map(((s,n)=>Tt()("td",this._renderCell(s),Tt().on("click",(()=>this._selectCell(t[1],i[e].header[n],e,o?o.actionNum:0)))))))))))),Tt()("span.action_comment",t))}_setupFilters(e,t){const o=e.tableFilters={};if(t){const i=new Map(e.actionSummary.tableRenames);for(const e of Object.keys(t.tableFilters))if(e.startsWith("-"));else if(i.has(e)){const s=i.get(e)||(0,Et.QB)(e);o[s]=t.tableFilters[e],o[s](s)}else o[e]=t.tableFilters[e]}const i=(0,Et.r2)(e.actionSummary);for(const e of i)o[e]||(o[e]=Mt.observable(e));e.affectedTableIds=i.map((t=>e.tableFilters[t])).filter((e=>e))}_hasSelectedTable(e){return!this._gristDoc||e.affectedTableIds.some((e=>e()===this._selectedTableId()))}_showForTable(e,t){if(!t)return!0;const o=t.tableFilters[e];return this._showAllTables()||!o||o()===this._selectedTableId()}_buildLogDom(){return this._loadActionSummaries().catch((()=>Bt(Ut("Action Log failed to load")))),Tt()("div.action_log",{tabIndex:"-1"},Tt()("div.preference_item",Ft.checkbox(this._showAllTables,Tt().testId("ActionLog_allTables"),Tt()("span.preference_desc","All tables"))),Tt()("div.action_log_load",Pt.show((()=>this._loading())),"Loading..."),Pt.foreach(this._displayStack,(e=>{const t=e.time?(0,kt.timeFormat)("D T",new Date(e.time)):"";let o=e.desc||"";return e.actionSummary&&(o=this.renderTabularDiffs(e.actionSummary,o,e)),Tt()("div.action_log_item",Pt.cssClass(e.state),Pt.show((()=>this._showAllTables()||this._hasSelectedTable(e))),Tt()("div.action_info",Tt()("span.action_info_action_num",`#${e.actionNum}`),e.user?Tt()("span.action_info_user",e.user,Pt.toggleClass("action_info_from_self",e.fromSelf)):"",Tt()("span.action_info_timestamp",t)),Tt()("span.action_desc",o))})))}async _loadActionSummaries(){if(this._loaded||!this._gristDoc)return;this._loading(!0);const e=await this._gristDoc.docComm.getActionSummaries();this._loading(!1),this._loaded=!0,e.forEach((e=>this.pushAction(e)));const t=e.length>0?e[e.length-1].actionNum:0;for(const e of this._pending)e.actionNum>t&&this.pushAction(e);this._pending.length=0}_renderCell(e){if(null===e)return"...";if("string"==typeof e)return e;const[t,o]=e;return t||o?t&&!o?Tt()("span.action_log_cell_remove",t[0]):!o||null!==t&&null!==t[0]&&""!==t[0]?t&&o?Tt()("div",Tt()("span.action_log_cell_remove.action_log_cell_pre",t[0]),Tt()("span.action_log_cell_add",o[0])):JSON.stringify(e):Tt()("span.action_log_cell_add",o[0]):""}_renderTableName(e){return 0!==e.indexOf("_grist_")?e:`[${e.split("_grist_")[1].replace(/_/g,".")}]`}_renderSchemaChange(e,t,o){const[i,s]=t;return"manualSort"===(i||s)?Tt()("div"):Tt()("div.action_log_rename",Pt.show((()=>this._showForTable(s||(0,Et.QB)(i),o))),s?i?["Rename ",e,Tt()("span.action_log_rename_pre",i)," to ",Tt()("span.action_log_rename_post",s)]:["Add ",e,Tt()("span.action_log_rename_post",s)]:["Remove ",e,Tt()("span.action_log_rename_pre",i)])}_renderTableSchemaChanges(e,t){return Tt()("div",e.tableRenames.map((e=>this._renderSchemaChange("",e,t))))}_renderColumnSchemaChanges(e,t){return Tt()("div",Object.keys(e.tableDeltas).filter((e=>!e.startsWith("-"))).map((o=>Tt()("div",Pt.show((()=>this._showForTable(o,t))),e.tableDeltas[o].columnRenames.map((e=>this._renderSchemaChange(o+".",e)))))))}async _selectCell(e,t,o,i){if(!this._gristDoc)return;const s=this._displayStack.peek().findIndex((e=>e.actionNum===i));if(s<0)throw new Error(`Cannot find action ${i} in the action log.`);for(let n=s;n>=0;n--){const s=this._displayStack.at(n),r=s.actionSummary,l=r.tableRenames.find((e=>e[0]===o));if(l){const e=l[1];if(!e)return void Bt(Ut("Table {{tableId}} was subsequently removed in action #{{actionNum}}",{tableId:o,actionNum:s.actionNum}));o=e}const a=r.tableDeltas[o];if(!a)continue;if(a.removeRows.indexOf(e)>=0)return void Bt(Ut("This row was subsequently removed in action {{action.actionNum}}",{actionNum:i}));const d=a.columnRenames.find((e=>e[0]===t));if(d){const e=d[1];if(!e)return void Bt(Ut("Column {{colId}} was subsequently removed in action #{{action.actionNum}}",{colId:t,actionNum:s.actionNum}));t=e}}const n=this._gristDoc.getTableModel(o);if(!n)return;const r=n.tableMetaRow.primaryView(),l=r.getRowId();await this._gristDoc.openDocPage(l);const a=r.viewSections().peek().find((e=>e.table().tableId()===o));if(!a)return;const d=a.getRowId(),c=a.viewFields().peek().findIndex((e=>e.colId.peek()===t));this._gristDoc.moveToCursorPos({rowId:e,sectionId:d,fieldIndex:c}).catch((()=>{}))}}var Vt=o(44747),Nt=o(9072);const jt=o(1066);jt.registerLanguage("python",o(68940));const Wt=(0,F.makeT)("CodeEditorPanel");class Ht extends Nt.G{constructor(e){super(),this._gristDoc=e,this._schema=r.Observable.create(this,""),this._denied=r.Observable.create(this,!1),this.listenTo(e,"schemaUpdateAction",this._onSchemaAction.bind(this)),this._onSchemaAction().catch(re.reportError)}buildDom(){return(0,r.dom)("div.g-code-panel.clipboard",{tabIndex:"-1"},r.dom.maybe(this._denied,(()=>(0,r.dom)("div.g-code-panel-denied",(0,r.dom)("h2",r.dom.text(Wt("Access denied"))),(0,r.dom)("div",r.dom.text(Wt("Code View is available only when you have full document access.")))))),r.dom.maybe(this._schema,(e=>{const t=(0,r.dom)("code.g-code-viewer",r.dom.text(e),r.dom.hide(!0));return setTimeout((()=>{jt.highlightBlock(t),r.dom.showElem(t,!0)})),t})))}async _onSchemaAction(){try{const e=await this._gristDoc.docComm.fetchTableSchema();this.isDisposed()||(this._schema.set(e),this._denied.set(!1))}catch(e){if(!String(e).match(/Cannot view code/))throw e;this.isDisposed()||(this._schema.set(""),this._denied.set(!0))}}}var Gt=o(77709),Kt=o(268),Jt=o(64978);class Xt extends r.Disposable{constructor(e,t){var o,i,s;super(),this._restored=!1,this._store=new qt(t);const n=null!=(s=null==(i=null==(o=e.app.topAppModel.appObs.get())?void 0:o.currentUser)?void 0:i.id)?s:null;this._key=e.docId()+n,this._whenDocumentLoadsRestorePosition(e),this._whenCursorHasChangedStoreInMemory(e)}clear(){this._store.clear(this._key)}_whenCursorHasChangedStoreInMemory(e){this.autoDispose(e.cursorPosition.addListener((e=>{this._restored&&e&&void 0!==e.rowId&&this._storePosition(e)})))}_whenDocumentLoadsRestorePosition(e){if(e.hasCustomNav.get())return this._abortRestore();"data"!==e.activeViewId.get()?this.autoDispose(Yt(e.currentView,(async()=>{await this._doRestorePosition(e)}))):this._doRestorePosition(e).catch((e=>(0,re.reportError)(e)))}async _doRestorePosition(e){if(this._restored)return;this._restored=!0;const t=e.activeViewId.get();if(!(0,Jt.NZ)(t))return this._abortRestore();const o=this._readPosition(t);if(o){const t=e.viewModel.activeCollapsedSections.peek();if(o.sectionId&&t.includes(o.sectionId))return;await e.recursiveMoveToCursorPos(o,!0,!0)}}_abortRestore(){this.clear(),this._restored=!0}_storePosition(e){this._store.update(this._key,e)}_readPosition(e){const t=this._store.read(this._key);return this._store.clear(this._key),t&&t.position.viewId==e?t.position:null}}class qt{constructor(e=(0,Kt.c)()){this._storage=e}update(e,t){try{const o=this._storage,i={docId:e,position:t,timestamp:Date.now()};o.setItem(this._key(e),JSON.stringify(i))}catch(e){console.error("Can't store latest position in storage. Detail error "+e.message)}}clear(e){this._storage.removeItem(this._key(e))}read(e){const t=this._storage.getItem(this._key(e));if(t)return JSON.parse(t)}_key(e){return`grist-last-position-${e}`}}function Yt(e,t){let o=e.addListener((e=>{setImmediate(i),t(e)}));function i(){o&&(o.dispose(),o=null)}return{dispose:i}}var Zt=o(86277);class Qt extends r.Disposable{constructor(e,t,o,i){super(),this._comm=e,this._docId=o,this._notifier=i,this.fetchTable=this._wrapMethod("fetchTable"),this.fetchTableSchema=this._wrapMethod("fetchTableSchema"),this.useQuerySet=this._wrapMethod("useQuerySet"),this.disposeQuerySet=this._wrapMethod("disposeQuerySet"),this.applyUserActionsById=this._wrapMethod("applyUserActionsById"),this.importFiles=this._wrapMethod("importFiles"),this.finishImportFiles=this._wrapMethod("finishImportFiles"),this.cancelImportFiles=this._wrapMethod("cancelImportFiles"),this.generateImportDiff=this._wrapMethod("generateImportDiff"),this.addAttachments=this._wrapMethod("addAttachments"),this.findColFromValues=this._wrapMethod("findColFromValues"),this.getFormulaError=this._wrapMethod("getFormulaError"),this.fetchURL=this._wrapMethod("fetchURL"),this.autocomplete=this._wrapMethod("autocomplete"),this.removeInstanceFromDoc=this._wrapMethod("removeInstanceFromDoc"),this.getActionSummaries=this._wrapMethod("getActionSummaries"),this.startBundleUserActions=this._wrapMethod("startBundleUserActions"),this.stopBundleUserActions=this._wrapMethod("stopBundleUserActions"),this.forwardPluginRpc=this._wrapMethod("forwardPluginRpc"),this.reloadPlugins=this._wrapMethod("reloadPlugins"),this.reloadDoc=this._wrapMethod("reloadDoc"),this.fork=this._wrapMethod("fork"),this.checkAclFormula=this._wrapMethod("checkAclFormula"),this.getAclResources=this._wrapMethod("getAclResources"),this.waitForInitialization=this._wrapMethod("waitForInitialization"),this.getUsersForViewAs=this._wrapMethod("getUsersForViewAs"),this.getAccessToken=this._wrapMethod("getAccessToken"),this.changeUrlIdEmitter=this.autoDispose(new r.Emitter),this._forkPromise=null,this._isClosed=!1,this._setOpenResponse(t),this.listenTo(e,"docShutdown",(e=>{this.isActionFromThisDoc(e)&&(this._isClosed=!0)})),this.onDispose((async()=>{try{await this._shutdown()}catch(e){String(e).match(/GristWSConnection disposed/)||(0,re.reportError)(e)}}))}getUrlParams(){return{clientId:this._clientId,docFD:this._docFD}}docUrl(e){return(0,S.docUrl)(this.docWorkerUrl,e)}get docWorkerUrl(){return this._comm.getDocWorkerUrl(this._docId)}isActionFromThisDoc(e){return e.docFD===this._docFD}applyUserActions(e,t){return this._comm.addUserActions(e),this._callMethod("applyUserActions",e,t)}closeDoc(){return this._callDocMethod("closeDoc")}async forkAndUpdateUrl(){await(this._forkPromise||(this._forkPromise=this._doForkDoc()))}async _shutdown(){console.log(`DocComm: shutdown clientId ${this._clientId} docFD ${this._docFD}`);try{this._isClosed||await this.closeDoc()}catch(e){console.warn(`DocComm: closeDoc failed: ${e}`)}finally{this._comm.isDisposed()||this._comm.releaseDocConnection(this._docId)}}_setOpenResponse(e){this._docFD=e.docFD,this._clientId=e.clientId,this._comm.useDocConnection(this._docId)}_wrapMethod(e){return this._callMethod.bind(this,e)}async _callMethod(e,...t){return this._notifier.slowNotification(this._doCallMethod(e,...t),1e3)}async _doCallMethod(e,...t){if(this._forkPromise)return await this._forkPromise,this._callDocMethod(e,...t);try{return await this._callDocMethod(e,...t)}catch(o){if(o.shouldFork)return await this.forkAndUpdateUrl(),this._callDocMethod(e,...t);throw o}}_callDocMethod(e,...t){return this._comm._makeRequest(this._clientId,this._docId,e,this._docFD,...t)}async _doForkDoc(){(0,re.reportMessage)("Preparing your copy...",{key:"forking"});const{urlId:e,docId:t}=await this.fork(),o=await this._comm.openDoc(t);this.closeDoc().catch((()=>null)),this._comm.releaseDocConnection(this._docId),this._docId=t,this._setOpenResponse(o),this.changeUrlIdEmitter.emit(e),(0,re.reportMessage)("You are now editing your own copy",{key:"forking"})}}Object.assign(Qt.prototype,Zt.Events);var eo=o(27910);function to(e,t){const o=t.viewSections.getRowModel(e.sectionId).viewFields().peek().findIndex((t=>t.colRef.peek()==e.colRef));return{rowId:e.rowId,fieldIndex:o,sectionId:e.sectionId}}o(55424);var oo=o(8881),io=o(4425);const so=(0,F.makeT)("components.Drafts");class no extends r.Disposable{constructor(e){super();const t=ro.create(this,e),o=lo.create(this),i=ao.create(this,e),s=co.create(this,e),n=uo.create(this,e),r=(l=this,function(e,t){l.autoDispose(e.addListener(t))});var l;r(n.cellCancelled,(e=>{if(!e.modified)return s.close(),void i.close();i.showUndoDiscard(),o.save(e),s.close()})),r(i.pressed,(async()=>{const e=o.get();e&&(await t.goToCell(e.position),await n.activate(),n.setState(e.state)),o.clear(),i.close()})),r(i.disappeared,(()=>{o.clear()})),r(n.activated,(e=>{o.hasDraftFor(e)&&s.showContinueDraft(),i.close()})),r(n.cellModified,(e=>{s.scheduleClose()})),r(n.cellSaved,(e=>{o.clear(),s.close(),i.close()})),r(s.click,(()=>{const e=o.get();e&&n.setState(e.state),s.close()}))}}class ro extends r.Disposable{constructor(e){super(),this._doc=e}async goToCell(e){await this._doc.recursiveMoveToCursorPos(to(e,this._doc.docModel),!0)}}class lo extends r.Disposable{get(){return this._memory}save(e){this._memory=e}hasDraftFor(e){const t=this._memory;return!(!t||!class{static equals(e,t){return e&&t&&e.colRef==t.colRef&&e.sectionId==t.sectionId&&e.rowId==t.rowId}static create(e,t){return{rowId:e.id.peek(),colRef:t.colRef.peek(),sectionId:t.viewSection.peek().id.peek()}}}.equals(t.position,e))}clear(){this._memory=null}}class ao extends r.Disposable{constructor(e){super(),this._doc=e,this._hadAction=!1,this._holder=r.Holder.create(this),this.pressed=this.autoDispose(new r.Emitter),this.disappeared=this.autoDispose(new r.Emitter)}close(){this._hadAction=!0,this._holder.clear()}showUndoDiscard(){const e=this._doc.app.topAppModel.notifier.createUserMessage(so("Undo discard"),{message:()=>function(...e){return po(so("Undo discard"),(0,i.testId)("draft-notification"),...e)}(r.dom.on("click",(()=>{this._hadAction=!0,this.pressed.emit()})))});e.onDispose((()=>{this._hadAction||this.disappeared.emit()})),this._holder.autoDispose(e),this._hadAction=!1}}class co extends r.Disposable{constructor(e){super(),this._doc=e,this._tooltip=null,this._scheduled=!1,this.click=this.autoDispose(new r.Emitter),this.onDispose((()=>{this.close()}))}scheduleClose(){if(this._tooltip&&!this._scheduled){this._scheduled=!0;const e=this._tooltip.close;this._tooltip.close=()=>{clearTimeout(t),e()};const t=setTimeout(this._tooltip.close,6e3)}}showContinueDraft(){var e;this.close();const t=null==(e=this._doc.activeEditor.get())?void 0:e.getDom();var o;t&&(this._tooltip=(0,oo.showTooltip)(t,(o=()=>this.click.emit(),function(e){return ho((0,io.Y3)(so("Restore last edit"),r.dom.on("mousedown",(t=>{t.preventDefault(),e.close(),o()})),(0,i.testId)("draft-tooltip")),(0,oo.tooltipCloseButton)(e))})))}close(){var e;this._scheduled=!1,null==(e=this._tooltip)||e.close(),this._tooltip=null}}class uo extends r.Disposable{constructor(e){super(),this._doc=e,this.cellSaved=this.autoDispose(new r.Emitter),this.cellModified=this.autoDispose(new r.Emitter),this.activated=this.autoDispose(new r.Emitter),this.cellCancelled=this.autoDispose(new r.Emitter),this._holder=r.Holder.create(this),this.autoDispose(e.activeEditor.addListener((e=>{if(!e)return;this.activated.emit(e.cellPosition());const t=r.MultiHolder.create(this._holder);t.autoDispose(e.changeEmitter.addListener((e=>{this.cellModified.emit({position:e.position,state:e.currentState,modified:e.wasModified})}))),t.autoDispose(e.cancelEmitter.addListener((e=>{this.cellCancelled.emit({position:e.position,state:e.currentState,modified:e.wasModified})}))),t.autoDispose(e.saveEmitter.addListener((e=>{this.cellSaved.emit({position:e.position,state:e.currentState,modified:e.wasModified})})))})))}setState(e){var t;null==(t=this._doc.activeEditor.get())||t.rebuildEditor(void 0,Number.POSITIVE_INFINITY,e)}async activate(){await this._doc.activateEditorAtCursor({})}}const ho=(0,r.styled)("div",`\n  display: flex;\n  align-items: center;\n  --icon-color: ${i.theme.controlFg};\n\n  & > .${io.Y3.className} {\n    margin-left: 8px;\n  }\n`),po=(0,r.styled)("div",`\n  cursor: pointer;\n  color: ${i.theme.controlFg};\n  &:hover {\n    text-decoration: underline;\n  }\n`);class mo extends r.Disposable{constructor(e,t){var o,i,s;super(),this._restored=!1;const n=null!=(s=null==(i=null==(o=e.app.topAppModel.appObs.get())?void 0:o.currentUser)?void 0:i.id)?s:null,r=e.docId()+n;this._store=new go(r,t),this._listenToReload(e).catch((e=>{if(!(e instanceof re.UserError))throw e;console.error("Error while restoring last edit position",e)}))}monitorEditor(e){const t=(o=this,function(e,t){o.autoDispose(e.addListener(t))});var o;t(e.cancelEmitter,(e=>{this._store.clear()})),t(e.saveEmitter,(e=>{this._store.clear()})),t(e.changeEmitter,(e=>{this._store.updateValue(e.position,e.currentState)}))}async _listenToReload(e){e.isReadonly.get()||e.hasCustomNav.get()?this._store.clear():"data"===e.activeViewId.get()?await this._doRestorePosition(e):this.autoDispose(Yt(e.currentView,(async()=>{await this._doRestorePosition(e)})))}async _doRestorePosition(e){if(this._restored)return;this._restored=!0;const t=e.activeViewId.get();if(!(0,Jt.NZ)(t))return void this._store.clear();const o=this._store.readValue();o&&(await e.recursiveMoveToCursorPos(to(o.position,e.docModel),!0,!0),await e.activateEditorAtCursor({state:o.value}))}}class go{constructor(e,t=(0,Kt.c)()){this._key=e,this._storage=t,this._entry=null,this._timestamp=0}updateValue(e,t){this._entry={position:e,value:t},this.save()}readValue(){return this.load(),this._entry}clear(){this._entry=null,this.save()}timestamp(){return this._timestamp}_storageKey(){return`grist-last-edit-${this._key}`}load(){const e=this._storage.getItem(this._storageKey());if(this._entry=null,this._timestamp=0,e)try{const{entry:t,timestamp:o}=JSON.parse(e);if(void 0===t||"number"!=typeof o)return void console.error("[EditMemory] Data in local storage has a different structure");this._entry=t,this._timestamp=o}catch(e){console.error("[EditMemory] Can't deserialize date from local storage")}}save(){const e=this._storage;if(this._entry)try{this._timestamp=Date.now();const t={timestamp:this._timestamp,entry:this._entry};e.setItem(this._storageKey(),JSON.stringify(t))}catch(e){console.error("Can't save current edited cell state. Error message: "+(null==e?void 0:e.message))}else e.removeItem(this._storageKey())}}var fo=o(442),wo=o(20742);const bo=o(66287),vo=o(79462),yo={"\n":"\\n","\r":"\\r","\t":"\\t"},_o=vo(yo);function xo(e,t,o,s,n){const l=t.filter((e=>e.visible)),a=new Map(l.map((t=>[t.name,r.Observable.create(e,o[t.name])])));return[Co(l.map((t=>So(Io((0,io.iz)(t.label)),function(e,t,o){if("boolean"===t)return(0,de.n2)(o);{const t=r.Computed.create(e,(e=>function(e){return e.replace(/[\n\r\t]/g,(e=>yo[e]))}(String(e(o)||"")))).onWrite((e=>o.set(function(e){return e.replace(/\\[nrt]/g,(e=>_o[e]))}(e))));return Do(t,{onInput:!0},r.dom.on("focus",((e,t)=>t.select())))}}(e,t.type,a.get(t.name)),(0,i.testId)("parseopts-opt"))))),(0,wo.cssModalButtons)(r.dom.domComputed((e=>l.every((t=>e(a.get(t.name))===o[t.name]))),(e=>e?(0,ae.bigBasicButton)("Close",r.dom.on("click",n),(0,i.testId)("parseopts-back")):(0,ae.bigPrimaryButton)("Update preview",r.dom.on("click",(()=>s(bo(l.map((e=>[e.name,a.get(e.name).get()])))))),(0,i.testId)("parseopts-update")))))]}const Co=(0,r.styled)("div","\n  display: flex;\n  flex-wrap: wrap;\n  justify-content: space-between;\n  padding: 16px 0;\n  width: 400px;\n  overflow-y: auto;\n"),So=(0,r.styled)("div","\n  flex: none;\n  margin: 8px 0;\n  width: calc(50% - 16px);\n  font-weight: initial;   /* negate bootstrap */\n"),Io=(0,r.styled)("div","\n  margin-bottom: 8px;\n"),Do=(0,r.styled)(r.input,`\n  color: ${i.theme.inputFg};\n  background-color: ${i.theme.inputBg};\n  position: relative;\n  display: inline-block;\n  outline: none;\n  height: 28px;\n  border: 1px solid ${i.theme.inputBorder};\n  border-radius: 3px;\n  padding: 0 6px;\n  width: 100%;\n\n  &::placeholder {\n    color: ${i.theme.inputPlaceholderFg};\n  }\n`);var Ro=o(4491),To=o(97660),ko=o(29813),Mo=o(56634),Oo=o(38109),Ao=o(85050),Po=o(86391),Fo=o(1464),Eo=o(24894),Bo=o(99002),Lo=o(97767),$o=Object.defineProperty,Uo=Object.defineProperties,zo=Object.getOwnPropertyDescriptors,Vo=Object.getOwnPropertySymbols,No=Object.prototype.hasOwnProperty,jo=Object.prototype.propertyIsEnumerable,Wo=(e,t,o)=>t in e?$o(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,Ho=(e,t)=>{for(var o in t||(t={}))No.call(t,o)&&Wo(e,o,t[o]);if(Vo)for(var o of Vo(t))jo.call(t,o)&&Wo(e,o,t[o]);return e},Go=(e,t)=>Uo(e,zo(t));const Ko=o(88466),Jo=(0,F.makeT)("Importer"),Xo=(0,To.a)("test-importer-");function qo(e,t,o){const i=e.customizedColumns.get();o?i.add(t):i.delete(t),e.customizedColumns.set(new Set(i))}class Yo extends Nt.G{constructor(e,t,o){super(),this._gristDoc=e,this._importSourceElem=t,this._createPreview=o,this._docComm=this._gristDoc.docComm,this._optionsScreenHolder=r.Holder.create(this),this._mergeOptions={},this._parseOptions=r.Observable.create(this,{}),this._sourceInfoArray=r.Observable.create(this,[]),this._sourceInfoSelected=r.Observable.create(this,null),this._sourceInfoHolder=r.Holder.create(this),this._formulaEditorHolder=r.Holder.create(this),this._previewViewSection=r.Computed.create(this,this._sourceInfoSelected,((e,t)=>{if(!t)return null;if(e(t.isLoadingSection))return null;const o=e(t.transformSection);return!o||o.isDisposed()||e(o._isDeleted)?null:o})),this._isLoadingDiff=r.Observable.create(this,!1),this._lastGenImportDiffPromise=null,this._debouncedUpdateDiff=Ko(this._updateDiff,1e3,{leading:!0,trailing:!0}),this._hasScheduledDiffUpdate=!1,this._destTables=r.Computed.create(this,(e=>[...e(this._gristDoc.docModel.visibleTableIds.getObservable()).map((e=>({value:e,label:e})))])),this._transformFields=r.Computed.create(this,this._sourceInfoSelected,((e,t)=>{const o=t&&e(t.transformSection);return!o||e(o._isDeleted)?null:e(e(o.viewFields).getObservable())})),this._transformColImportOptions=r.Computed.create(this,this._transformFields,this._sourceInfoSelected,((e,t,o)=>t&&o?new Map(t.map((t=>[e(t.colRef),this._makeImportOptionsForCol(e(t.column),o)]))):new Map)),this._unmatchedFieldsMap=r.Computed.create(this,(e=>{const t=e(this._sourceInfoArray),o=new Map,i=t=>{var o;if(e(t.destTableId)===he.X$)return null;if(e(t.destTableId)===he.H$)return null;const i=t&&e(t.transformSection);if(!i||i.isDisposed()||e(i._isDeleted))return null;const s=e(e(i.viewFields).getObservable()),n=null!=(o=null==s?void 0:s.filter((t=>""===e(e(t.column).formula).trim())).map((t=>e(t.label))))?o:null;return(null==n?void 0:n.length)?n:null};for(const e of t)o.set(e,i(e));return o}));const i=(null==t?void 0:t.importSource.label)||"Import from file";this._screen=Ro.F.create(this,i),this.onDispose((()=>{this._resetImportDiffState()}))}async pickAndUploadSource(e=null){try{if(this._importSourceElem){const t=this._importSourceElem.plugin,o=this._screen.renderPlugin(t),i=await this._importSourceElem.importSourceStub.getImportSource(o);if(t.removeRenderTarget(o),this._screen.renderSpinner(),i){const t=i.item;if("fileList"===t.kind){const o=t.files.map((({content:e,name:t})=>new File([e],t)));e=await(0,Mo.IL)(o,{docWorkerUrl:this._docComm.docWorkerUrl,sizeLimit:"import"})}else{if("url"!==t.kind)throw new Error(`Import source of kind ${t.kind} are not yet supported!`);e=(0,Mo.c5)(t.url)?await this._fetchFromDrive(t.url):await(0,Mo.QK)(this._docComm,t.url)}}}else e=e||await(0,Mo.lX)({docWorkerUrl:this._docComm.docWorkerUrl,multiple:!0,sizeLimit:"import"})}catch(e){if(e instanceof Qo)return void await this._cancelImport();if(e instanceof Zo)throw await this._cancelImport(),e;return void this._screen.renderError(e.message)}e?(this._uploadResult=e,await this._reImport(e)):await this._cancelImport()}_getPrimaryViewSection(e){return this._gristDoc.getTableModel(e).tableMetaRow.primaryView.peek().viewSections.peek().peek()[0]}_getSectionByRef(e){return this._gristDoc.docModel.viewSections.getRowModel(e)}async _updateTransformSection(e){this._resetImportDiffState(),e.isLoadingSection.set(!0),e.transformSection.set(null);const t=this._gristDoc.docData.sendAction(["GenImporterView",e.hiddenTableId,e.destTableId.get(),null,null]);e.lastGenImporterViewPromise=t;const o=(await t).viewSectionRef;this.isDisposed()||e.lastGenImporterViewPromise!==t||(e.transformSection.set(this._gristDoc.docModel.viewSections.getRowModel(o)),e.isLoadingSection.set(!1),this._gristDoc.viewModel.activeSectionId(o))}_getTransformedDataSource(e){const t=e.files.map(((e,t)=>this._createTransformRuleMap(t)));return{uploadId:e.uploadId,transforms:t}}_getMergeOptionMaps(e){return e.files.map(((e,t)=>this._createMergeOptionsMap(t)))}_createTransformRuleMap(e){const t={};for(const o of this._sourceInfoArray.get())o.uploadFileIndex===e&&(t[o.origTableName]=this._createTransformRule(o));return t}_createMergeOptionsMap(e){const t={};for(const o of this._sourceInfoArray.get())o.uploadFileIndex===e&&(t[o.origTableName]=this._getMergeOptionsForSource(o));return t}_createTransformRule(e){const t=e.transformSection.get();if(!t)throw new Error(`Table ${e.hiddenTableId} is missing transform section`);const o=t.viewFields().peek(),i=e.sourceSection.viewFields().peek(),s=e.destTableId.get();return{destTableId:s,destCols:o.map((e=>({label:e.label(),colId:s?e.colId():null,type:e.column().type(),widgetOptions:e.column().widgetOptions(),formula:e.column().formula()}))),sourceCols:i.map((e=>e.colId()))}}_getMergeOptionsForSource(e){const t=this._mergeOptions[e.hiddenTableId];if(!t)return;const{updateExistingRecords:o,mergeCols:i,mergeStrategy:s}=t;return{mergeCols:o.get()?i.get():[],mergeStrategy:s.get()}}_getHiddenTableIds(){return this._sourceInfoArray.get().map((e=>e.hiddenTableId))}async _reImport(e){this._screen.renderSpinner(),this._resetImportDiffState();try{const t=Go(Ho({},this._parseOptions.get()),{NUM_ROWS:0}),o=await this._docComm.importFiles(this._getTransformedDataSource(e),t,this._getHiddenTableIds());this._parseOptions.set(o.options),this._sourceInfoHolder.clear();const i=r.MultiHolder.create(this._sourceInfoHolder);if(this._sourceInfoArray.set(o.tables.map((e=>{var t;return{hiddenTableId:e.hiddenTableId,uploadFileIndex:e.uploadFileIndex,origTableName:e.origTableName,sourceSection:this._getPrimaryViewSection(e.hiddenTableId),transformSection:r.Observable.create(i,this._getSectionByRef(e.transformSectionRef)),destTableId:r.Observable.create(i,null!=(t=e.destTableId)?t:he.H$),isLoadingSection:r.Observable.create(i,!1),lastGenImporterViewPromise:null,selectedView:r.Observable.create(i,1),customizedColumns:r.Observable.create(i,new Set)}}))),0===this._sourceInfoArray.get().length)throw new Error("No data was imported");this._prepareMergeOptions(),this._sourceInfoSelected.set(this._sourceInfoArray.get()[0]||null),this._renderMain(e)}catch(e){console.warn("Import failed",e),this._screen.renderError(e.message)}}_prepareMergeOptions(){this._mergeOptions={},this._getHiddenTableIds().forEach((e=>{this._mergeOptions[e]={updateExistingRecords:r.Observable.create(null,!1),mergeCols:(0,r.obsArray)(),mergeStrategy:r.Observable.create(null,{type:"replace-with-nonblank-source"}),hasInvalidMergeCols:r.Observable.create(null,!1)}}))}async _maybeFinishImport(e){var t;if(!this._validateImportConfiguration())return;this._screen.renderSpinner(),this._resetImportDiffState();const o=Go(Ho({},this._parseOptions.get()),{NUM_ROWS:0}),i=this._getMergeOptionMaps(e),s=await this._docComm.finishImportFiles(this._getTransformedDataSource(e),this._getHiddenTableIds(),{mergeOptionMaps:i,parseOptions:o});if(null==(t=s.tables[0])?void 0:t.hiddenTableId){const e=this._gristDoc.docModel.dataTables[s.tables[0].hiddenTableId].tableMetaRow.primaryViewId();e&&await this._gristDoc.openDocPage(e)}this._screen.close(),this.dispose()}async _cancelImport(){this._resetImportDiffState(),this._formulaEditorHolder.dispose(),this._uploadResult&&await this._docComm.cancelImportFiles(this._uploadResult.uploadId,this._getHiddenTableIds()),this._screen.close(),this.dispose()}_resetTableMergeOptions(e){var t;null==(t=this._mergeOptions[e])||t.mergeCols.set([])}_validateImportConfiguration(){let e=!0;const t=this._sourceInfoSelected.get();if(!t)return e;const o=this._mergeOptions[t.hiddenTableId];if(!o)return e;const i=t.destTableId.get(),{updateExistingRecords:s,mergeCols:n,hasInvalidMergeCols:r}=o;return null!==i&&s.get()&&0===n.get().length&&(r.set(!0),e=!1),e}_buildModalTitle(e){const t=this._importSourceElem?this._importSourceElem.importSource.label:"Import from file";return ni((0,wo.cssModalTitle)(t),e)}_buildStaticTitle(){return si((0,wo.cssModalTitle)(Jo("Import from file")))}async _updateImportDiff(e){const{updateExistingRecords:t,mergeCols:o}=this._mergeOptions[e.hiddenTableId],i=e.destTableId&&t.get()&&o.get().length>0;!i&&this._gristDoc.comparison&&(this._isLoadingDiff.set(!0),this._gristDoc.comparison=null,this._isLoadingDiff.set(!1)),i&&(this._hasScheduledDiffUpdate=!0,this._isLoadingDiff.set(!0),await this._debouncedUpdateDiff(e))}async _updateDiff(e){this._hasScheduledDiffUpdate=!1;const t=this._docComm.generateImportDiff(e.hiddenTableId,this._createTransformRule(e),this._getMergeOptionsForSource(e));this._lastGenImportDiffPromise=t;const o=await t;this.isDisposed()||t!==this._lastGenImportDiffPromise||(this._gristDoc.comparison=o,this._hasScheduledDiffUpdate||this._isLoadingDiff.set(!1))}_resetImportDiffState(){this._cancelPendingDiffRequests(),this._gristDoc.comparison=null}_cancelPendingDiffRequests(){this._debouncedUpdateDiff.cancel(),this._lastGenImportDiffPromise=null,this._hasScheduledDiffUpdate=!1,this._isLoadingDiff.set(!1)}_renderMain(e){const t=this._parseOptions.get().SCHEMA,o=this._buildModalTitle(),l=t?oi(ii("Settings"),"Import options",Xo("options-link"),r.dom.on("click",(()=>this._renderParseOptions(t,e)))):null,a=async e=>{e!==this._sourceInfoSelected.get()&&this._validateImportConfiguration()&&(this._cancelPendingDiffRequests(),this._sourceInfoSelected.set(e),await this._updateImportDiff(e))},d=ui(r.dom.forEach(this._sourceInfoArray,(t=>{const o=r.MultiHolder.create(null);r.Computed.create(o,(e=>e(t.destTableId))).onWrite((async e=>{(t===this._sourceInfoSelected.get()||this._validateImportConfiguration())&&(t.destTableId.set(e),this._resetTableMergeOptions(t.hiddenTableId),e!==he.X$&&await this._updateTransformSection(t))}));const i=r.Computed.create(o,(e=>e(this._sourceInfoSelected)===t)),s=r.Computed.create(o,(e=>{var o,i;return null!=(i=null==(o=e(this._unmatchedFieldsMap).get(t))?void 0:o.length)?i:0}));return pi(r.dom.autoDispose(o),li(),pi.cls("-not-selected",(0,P.not)(i)),Xo("source"),Xo("source-selected",i),Xo("source-not-selected",(0,P.not)(i)),hi(ai(function(e,t){const o=t.files[e.uploadFileIndex].origName;return o.includes(".")?o.split(".").pop():"file"}(t,e),ai.cls("-active",i)),hi.cls("-selected",i),mi(gi(ei(t,e),Xo("from"),(0,oo.overflowTooltip)())),r.dom.on("click",(()=>a(t)))),r.dom.maybe(s,(e=>Hi("Exclamation",Xo("error"),(0,oo.hoverTooltip)(Jo("{{count}} unmatched field",{count:e}))))))}))),c=r.dom.maybeOwned(this._sourceInfoSelected,((e,t)=>{const{mergeCols:o,updateExistingRecords:i,hasInvalidMergeCols:a}=this._mergeOptions[t.hiddenTableId],d=r.Computed.create(e,(e=>e(t.destTableId)&&e(t.transformSection)?e(t.transformSection):null)),c=r.Computed.create(e,(e=>e(this._isLoadingDiff)||!e(this._previewViewSection))),u=r.Computed.create(e,(e=>e(c)?null:e(this._previewViewSection))),h=e=>o=>o(t.destTableId)===e,p=r.Computed.create(e,h(he.X$)),m=r.Computed.create(e,(e=>![he.H$,he.X$].includes(e(t.destTableId)))),g=e=>zi.cls("-selected",h(e)),f=e=>r.dom.on("click",(async()=>{(t===this._sourceInfoSelected.get()||this._validateImportConfiguration())&&(t.selectedView.set(1),t.destTableId.set(e),this._resetTableMergeOptions(t.hiddenTableId),e!==he.X$&&await this._updateTransformSection(t))})),w=r.Computed.create(e,(e=>e(m)&&2===e(t.selectedView))),b=e=>r.dom.on("click",(()=>{t.selectedView.set(e)}));return r.Computed.create(e,(e=>{const o=r.MultiHolder.create(e.owner);return e(d)&&o.autoDispose(i.addListener((async()=>{o.isDisposed()||await this._updateImportDiff(t)}))),o})),fi(vi(vi.cls("-right",w),wi($i("Destination table",Xo("target-top")),Ui(zi((0,Eo.lm)("Plus"),(0,r.dom)("span","New Table"),g(he.H$),f(he.H$),Xo("target"),Xo("target-new-table"),Xo("target-selected",h(he.H$)))),r.dom.maybe((e=>e(this._sourceInfoArray).length>1),(()=>[Ui(zi((0,Eo.lm)("CrossBig"),(0,r.dom)("span",Jo("Skip Import")),g(he.X$),f(he.X$),Xo("target"),Xo("target-skip"),Xo("target-selected",h(he.X$))))])),r.dom.forEach(this._destTables,(e=>{return Ui(Xo("target"),Xo("target-existing-table"),Xo("target-selected",h(e.value)),zi((0,Eo.lm)("TypeTable"),(0,r.dom)("span",e.label),g(e.value),f(e.value),b(2)),Wi("ArrowRight",b(2),(t=e.value,r.dom.show(h(t))),(0,oo.hoverTooltip)(Jo("Column mapping")),Xo("target-column-mapping")));var t}))),bi(ji(Ki(Qi(Gi("ArrowLeft"),Jo("Destination table"),b(1),Xo("table-mapping")),Zi(" / "),Yi(Jo("Column Mapping")))),Ii(r.dom.maybe(m,(()=>Di((0,de.rp)(i,Jo("Update existing records"),Xo("update-existing-records"))))),r.dom.maybe(d,(e=>r.dom.maybeOwned(i,(i=>{var s;return i.autoDispose(o.addListener((async e=>{0!==e.length&&a.get()&&a.set(!1),await this._updateImportDiff(t)}))),[Ri(Jo("Merge rows that match these fields:"),Xo("merge-fields-message")),(0,n.multiSelect)(o,null!=(s=e.viewFields().peek().map((e=>({label:e.label(),value:e.colId()}))))?s:[],{placeholder:Jo("Select fields to match on"),error:a},Xo("merge-fields-select"))]}))))),r.dom.maybeOwned(d,((e,o)=>(e.autoDispose(i.addListener((async()=>{await this._updateImportDiff(t)}))),(0,r.dom)("div",Ti((0,r.dom)("span",Jo("Grist column")),(0,r.dom)("div",null),(0,r.dom)("span",Jo("Source column"))),r.dom.forEach((0,r.fromKo)(o.viewFields().getObservable()),(e=>{const o=r.MultiHolder.create(null),i=r.Computed.create(o,(o=>o(t.customizedColumns).has(e.colId())));return ki(Xo("column-match-source-destination"),r.dom.autoDispose(o),r.dom.domComputed(e.label,(()=>Oi(r.dom.text(e.label),(0,oo.overflowTooltip)(),Xo("column-match-destination")))),Xi("ArrowRightOutlined"),r.dom.domComputedOwned(i,((o,i)=>i?this._buildCustomFormula(o,e,t):this._buildSourceSelector(o,e,t))),(0,r.dom)("div",r.dom.maybe(i,(()=>(0,s.icon)("Revert",r.dom.style("cursor","pointer"),(0,oo.hoverTooltip)(Jo("Revert")),r.dom.on("click",(async()=>{var o;qo(t,e.colId(),!1);const i=e.column.peek(),s=[...(null!=(o=this._transformColImportOptions.get().get(i.getRowId()))?o:new Map).entries()].find((([,e])=>e===i.label.peek()));s?await this._setColumnFormula(i,s[0],t):await this._gristDoc.clearColumns([e.colRef()])})))))))})),Xo("column-match-options"))))))),yi(r.dom.maybe(c,(()=>xi((0,Bo.M)(),Xo("preview-spinner")))),r.dom.maybe(u,(()=>[Vi(r.dom.domComputed(t.destTableId,(e=>Ni(e===he.H$?Jo("New Table"):e===he.X$?Jo("Skip Import"):r.dom.domComputed(this._destTables,(t=>{var o,i;return null!=(i=null==(o=t.find((t=>t.value===e)))?void 0:o.label)?i:Jo("New Table")}))))),l)])),ci(r.dom.text((e=>{var t;return(null==(t=e(this._parseOptions))?void 0:t.WARNING)||""})),Xo("warning")),r.dom.domComputed((e=>{if(e(p))return Ci(Jo("Skip Table on Import"),Xo("preview-overlay"));const t=e(u);if(!t||t.isDisposed())return null;const o=this._createPreview(t);return Si(r.dom.autoDispose(o),o.viewPane,Xo("preview"))}))))})),u=Bi(Li((0,ae.bigPrimaryButton)("Import",r.dom.on("click",(()=>this._maybeFinishImport(e))),r.dom.boolAttr("disabled",(e=>null===e(this._previewViewSection)||e(this._sourceInfoArray).every((t=>e(t.destTableId)===he.X$)))),(0,i.testId)("modal-confirm")),(0,ae.bigBasicButton)("Cancel",r.dom.on("click",(()=>this._cancelImport())),(0,i.testId)("modal-cancel")),r.dom.domComputed(this._unmatchedFieldsMap,(t=>{const o=[];let i=0;for(const[s,n]of t)(null==n?void 0:n.length)&&(i+=n.length,o.push(Ei(n.join(", "),r.dom.on("click",(()=>a(s))),(0,oo.hoverTooltip)(ei(s,e)))));return i?Pi(Fi(Ai("Exclamation"),Jo("{{count}} unmatched field in import",{count:i}),": "),...o,Xo("unmatched-fields")):null})))),h=ti({tabIndex:"-1"},o,ri(di(d),c),u);this._addFocusLayer(h),this._screen.render(h,{fullscreen:!0,fullbody:!0})}_makeImportOptionsForCol(e,t){const o=new Map,i=t.sourceSection.viewFields.peek().peek(),s=e.refTable.peek(),n=s?s.tableId.peek():void 0,r=e.visibleColModel.peek().colId.peek(),l=Boolean(t.destTableId.get()&&"Ref"===e.pureType.peek());for(const e of i){const t=e.column.peek(),i=t.colId.peek(),s=t.label.peek();if(l&&r){const e=`${n}.lookupOne(${r}=$${i}) or ($${i} and str($${i}))`;o.set(e,s)}else o.set(`$${i}`,s);l&&["Numeric","Int"].includes(t.type.peek())&&o.set(`${n}.lookupOne(id=NUM($${i})) or ($${i} and str(NUM($${i})))`,`${s} (as row ID)`)}return o}_makeImportOptionsMenu(e,t,o){return[(0,n.menuItem)((()=>this._setColumnFormula(e,null,o)),"Skip",Xo("column-match-menu-item")),t.length?(0,n.menuDivider)():null,...t.map((([t,i])=>(0,n.menuItem)((()=>this._setColumnFormula(e,t,o)),i,Xo("column-match-menu-item"))))]}_addFocusLayer(e){r.dom.autoDisposeElem(e,new ko.FocusLayer({defaultFocusElem:e,allowFocus:e=>e!==document.body,onDefaultFocus:()=>this.trigger("importer_focus")}))}async _setColumnFormula(e,t,o){const i=e.id(),s=o.customizedColumns.get();s.delete(e.colId()),o.customizedColumns.set(s),null===t?await this._gristDoc.clearColumns([i],{keepType:!0}):await this._gristDoc.docModel.columns.sendTableAction(["UpdateRecord",i,{formula:t,isFormula:!0}]),await this._updateImportDiff(o)}_activateFormulaEditor(e,t,o){const i=this._gristDoc.viewModel.activeSection().viewInstance(),s=null==i?void 0:i.moveEditRowToCursor(),n=(0,Lo.Ex)({gristDoc:this._gristDoc,column:t.column(),editingFormula:t.editingFormula,refElem:e,editRow:s,canDetach:!1,setupCleanup:this._setupFormulaEditorCleanup.bind(this),onSave:async(e,t)=>{t!==e.formula.peek()&&(await e.updateColValues({formula:t}),await o(t))}});this._formulaEditorHolder.autoDispose(n)}_setupFormulaEditorCleanup(e,t,o,i){const s=()=>i().catch(Oo.eK);this.on("importer_focus",s),e.onDispose((()=>{this.off("importer_focus",s),o(!1)}))}_buildSourceSelector(e,t,o){const i=r.Computed.create(e,(e=>{var i;const s=t.column.peek(),n=null!=(i=e(this._transformColImportOptions).get(s.getRowId()))?i:new Map,r=Array.from(n).filter((([t])=>{var i;const n=e(s.formula),r=null==(i=o.transformSection.get())?void 0:i.viewFields.peek().all().filter((e=>e.column.peek()!==s)).map((t=>e(t.column.peek().formula)));return t===n||!(null==r?void 0:r.includes(t))}));return this._makeImportOptionsMenu(s,r,o)})),s=r.Computed.create(e,(e=>{const o=e(t.column),i=e(this._transformColImportOptions).get(o.getRowId());return(null==i?void 0:i.get(e(o.formula)))||null})),l=r.Computed.create(e,(e=>e(s)||Jo("Skip"))),a=Ji(r.dom.text(l),Xo("column-match-formula"),Ji.cls("-skip",(0,P.not)(s)),(0,oo.overflowTooltip)()),d=r.dom.domComputed(i,(e=>e)),c=(0,n.selectOption)((()=>{this._activateFormulaEditor(u,t,(async e=>{qo(o,t.colId.peek(),!!e),await this._updateImportDiff(o)}))}),"Apply Formula","Lighting",Xo("apply-formula"),qi.cls("")),u=(0,n.selectMenu)(a,(()=>[d,(0,n.menuDivider)(),c]),Xo("column-match-source"));return u}_buildCustomFormula(e,t,o){const i=r.Computed.create(e,(e=>{const o=e(t.column);return e(o.formula)})),s={gristTheme:this._gristDoc.currentTheme,placeholder:"Skip",maxLines:1};return Mi(i,s,r.dom.cls("disabled"),r.dom.cls("formula_field_sidepane"),{tabIndex:"-1"},r.dom.on("focus",((e,i)=>this._activateFormulaEditor(i,t,(async e=>{qo(o,t.colId.peek(),!!e),await this._updateImportDiff(o)})))),Xo("column-match-formula"))}_renderParseOptions(e,t){const o=Ro.F.create(this._optionsScreenHolder,"Import from file");o.showImportDialog({noClickAway:!1,noEscapeKey:!1}),o.render([this._buildStaticTitle(),r.dom.create(xo,e,this._parseOptions.get(),(e=>{o.dispose(),this._parseOptions.set(e),this._sourceInfoArray.set([]),this._reImport(t).catch((e=>(0,Oo.eK)(e)))}),(()=>{o.dispose(),this._renderMain(t)}))])}async _fetchFromDrive(e){try{return await(0,Mo.QK)(this._docComm,e)}catch(t){if((0,Fo.F0)()){const o={};try{const e=await(0,Fo.X3)(this);o.googleAuthorizationCode=e}catch(o){throw(null==o?void 0:o.message)===Fo.au?new Zo(e):(null==o?void 0:o.message)===Fo.dw?new Qo:t}return await(0,Mo.QK)(this._docComm,e,o)}throw new Zo(e)}}}class Zo extends Error{constructor(e){super(`This url ${e} is not supported`),this.url=e}}class Qo extends Error{}function ei(e,t){const o=t.files[e.uploadFileIndex].origName;return e.origTableName?`${e.origTableName} - ${o}`:o}const ti=(0,r.styled)("div","\n  height: 100%;\n  display: flex;\n  flex-direction: column;\n  outline: unset;\n"),oi=(0,r.styled)("div",`\n  display: inline-flex;\n  align-items: center;\n  cursor: pointer;\n  color: ${i.theme.controlFg};\n  --icon-color: ${i.theme.controlFg};\n  &:hover {\n    color: ${i.theme.controlHoverFg};\n    --icon-color: ${i.theme.controlHoverFg};\n  }\n`),ii=(0,r.styled)(s.icon,"\n  flex: none;\n  margin-right: 4px;\n"),si=(0,r.styled)("div",`\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  margin-bottom: 16px;\n  & > .${wo.cssModalTitle.className} {\n    margin-bottom: 0px;\n  }\n`),ni=(0,r.styled)(si,"\n  padding-left: var(--css-modal-dialog-padding-horizontal, 0px);\n  padding-right: var(--css-modal-dialog-padding-horizontal, 0px);\n  padding-top: var(--css-modal-dialog-padding-vertical, 0px);\n"),ri=(0,r.styled)("div","\n  display: flex;\n  flex-direction: column;\n  flex-grow: 1;\n"),li=(0,r.styled)("div",`\n  border-bottom: 1px solid ${i.theme.importerTableInfoBorder};\n  display: none;\n  height: 0px;\n  bottom: 0px;\n  position: absolute;\n  width: 100%;\n`),ai=(0,r.styled)("div",`\n  background: ${i.theme.importerInactiveFileBg};\n  color: ${i.theme.importerInactiveFileFg};\n  border-radius: 4px;\n  height: 2em;\n  text-align: center;\n  display: flex;\n  align-items: center;\n  padding: 1em;\n  font-size: 15px;\n  font-weight: 600;\n  text-transform: uppercase;\n  &-active{\n    background: ${i.theme.importerActiveFileBg};\n    color: ${i.theme.importerActiveFileFg};\n  }\n`),di=(0,r.styled)("div",`\n  border-bottom: 1px solid ${i.theme.importerTableInfoBorder};\n  display: flex;\n  flex-direction: column;\n`),ci=(0,r.styled)("div",`\n  margin-bottom: 8px;\n  color: ${i.theme.errorText};\n  white-space: pre-line;\n`),ui=(0,r.styled)("div","\n  align-self: flex-start;\n  max-width: 100%;\n  display: flex;\n  padding: 0px var(--css-modal-dialog-padding-horizontal, 0px);\n"),hi=(0,r.styled)("div",`\n  border: 1px solid transparent;\n  padding-left: 20px;\n  padding-right: 20px;\n  display: flex;\n  align-items: center;\n  align-content: flex-end;\n  overflow: hidden;\n  border-radius: 4px 4px 0px 0px;\n  height: 56px;\n  column-gap: 8px;\n  &-selected {\n    border: 1px solid ${i.theme.importerTableInfoBorder};\n    border-bottom-color: ${i.theme.importerMainContentBg};\n    background-color: ${i.theme.importerMainContentBg};\n  }\n`),pi=(0,r.styled)("div",`\n  background: ${i.theme.importerOutsideBg};\n  position: relative;\n  cursor: pointer;\n  margin-bottom: -2px;\n  border-bottom: 1px solid ${i.theme.importerMainContentBg};\n  flex: 1;\n  &-not-selected + &-not-selected::after{\n    content: '';\n    position: absolute;\n    left: 0px;\n    top: 20%;\n    height: 60%;\n    border-left: 1px solid ${i.theme.importerTableInfoBorder};\n  }\n  &-not-selected .${li.className} {\n    display: block;\n  }\n  &-not-selected .${ai.className} {\n    display: none;\n  }\n  &-not-selected {\n    min-width: 0px;\n  }\n  &-not-selected:first-child .${hi.className} {\n    padding-left: 0px;\n  }\n`),mi=(0,r.styled)("div","\n  display: flex;\n  align-items: center;\n  overflow: hidden;\n  flex-shrink: 1;\n  height: 100%;\n"),gi=(0,r.styled)("div","\n  overflow: hidden;\n  white-space: nowrap;\n  text-overflow: ellipsis;\n  flex-shrink: 1;\n"),fi=(0,r.styled)("div",`\n  display: flex;\n  gap: 8px;\n  flex-grow: 1;\n  height: 0px;\n  background-color: ${i.theme.importerMainContentBg};\n  padding-right: var(--css-modal-dialog-padding-horizontal, 0px);\n`),wi=(0,r.styled)("div","\n  padding-right: 8px;\n  padding-top: 16px;\n  position: absolute;\n  inset: 0;\n  display: flex;\n  flex-direction: column;\n  overflow-y: auto;\n  width: 100%;\n  transition: transform 0.2s ease-in-out;\n"),bi=(0,r.styled)(wi,"\n  left: 100%;\n  padding-left: var(--css-modal-dialog-padding-horizontal, 0px);\n"),vi=(0,r.styled)("div",`\n  width: 360px;\n  height: 100%;\n  position: relative;\n  overflow-x: hidden;\n  &-right .${wi.className} {\n    transform: translateX(-100%);\n  }\n  &-right .${bi.className} {\n    transform: translateX(-100%);\n  }\n`),yi=(0,r.styled)("div","\n  display: flex;\n  flex-direction: column;\n  flex-grow: 1;\n"),_i=(0,r.styled)("div","\n  display: flex;\n  flex-grow: 1;\n"),xi=(0,r.styled)(_i,"\n  align-items: center;\n  justify-content: center;\n"),Ci=(0,r.styled)("div",`\n  background: ${i.theme.importerSkippedTableOverlay};\n  flex: 1;\n  display: grid;\n  place-items: center;\n`),Si=(0,r.styled)(_i,`\n  border: 1px solid ${i.theme.importerPreviewBorder};\n  position: relative;\n`),Ii=(0,r.styled)("div","\n  margin-bottom: 16px;\n"),Di=(0,r.styled)("div","\n  margin-bottom: 8px;\n  margin-top: 8px;\n"),Ri=(0,r.styled)("div",`\n  color: ${i.theme.lightText};\n  margin-bottom: 8px;\n`),Ti=(0,r.styled)("div",`\n  display: grid;\n  grid-template-columns: 1fr 20px 1fr;\n  text-transform: uppercase;\n  color: ${i.theme.lightText};\n  letter-spacing: 1px;\n  font-size: ${i.vars.xsmallFontSize};\n  margin-bottom: 12px;\n`),ki=(0,r.styled)("div",`\n  display: grid;\n  grid-template-columns: 1fr 20px 1fr 20px;\n  gap: 4px;\n  align-items: center;\n  --icon-color: ${i.theme.iconDisabled};\n  & + & {\n    margin-top: 16px;\n  }\n`),Mi=(0,r.styled)(Ao.Lh,`\n  flex: auto;\n  cursor: pointer;\n  margin-top: 1px;\n  padding-left: 24px;\n  --icon-color: ${i.theme.accentIcon};\n`),Oi=(0,r.styled)("div",`\n  overflow: hidden;\n  white-space: nowrap;\n  text-overflow: ellipsis;\n  padding-left: 4px;\n  cursor: unset;\n  background-color: ${i.theme.pageBg};\n  color: ${i.theme.text};\n  width: 100%;\n  height: 30px;\n  line-height: 16px;\n  font-size: ${i.vars.mediumFontSize};\n  padding: 5px;\n  border: 1px solid ${i.theme.selectButtonBorder};\n  border-radius: 3px;\n  user-select: none;\n  outline: none;\n`),Ai=(0,r.styled)(s.icon,`\n  height: 12px;\n  --icon-color: ${i.theme.lightText};\n  vertical-align: bottom;\n  margin-bottom: 2px;\n`),Pi=(0,r.styled)("div","\n  display: flex;\n  flex-wrap: wrap;\n  row-gap: 2px;\n  column-gap: 4px;\n  align-items: flex-start;\n"),Fi=(0,r.styled)("div","\n  padding: 4px 8px;\n"),Ei=(0,r.styled)("div",`\n  white-space: nowrap;\n  text-overflow: ellipsis;\n  overflow: hidden;\n  padding-right: 16px;\n  color: ${i.theme.text};\n  border-radius: 8px;\n  padding: 4px 8px;\n  background-color: ${i.theme.pagePanelsBorder};\n  max-width: 160px;\n  cursor: pointer;\n`),Bi=(0,r.styled)("div",`\n  padding-top: 40px;\n  padding-left: var(--css-modal-dialog-padding-horizontal, 0px);\n  padding-right: var(--css-modal-dialog-padding-horizontal, 0px);\n  padding-bottom: calc(var(--css-modal-dialog-padding-vertical, 0px) - 12px);\n  background-color: ${i.theme.importerMainContentBg};\n`),Li=(0,r.styled)("div","\n  height: 52px;\n  overflow: hidden;\n  display: flex;\n  gap: 8px;\n  align-items: flex-start;\n"),$i=(0,r.styled)("span._cssToFrom",`\n  color: ${i.theme.darkText};\n  text-transform: uppercase;\n  font-weight: 600;\n  font-size: ${i.vars.smallFontSize};\n  letter-spacing: 0.5px;\n  padding-left: var(--css-modal-dialog-padding-horizontal, 0px);\n  text-align: left;\n  margin-bottom: 16px;\n`),Ui=(0,r.styled)("div","\n  margin-bottom: 1px;\n  /* Reuse the modal padding but move 16px to left if possible */\n  margin-left: max(0px, calc(var(--css-modal-dialog-padding-horizontal, 0px) - 16px));\n  display: flex;\n  align-items: center;\n"),zi=(0,r.styled)("div",`\n  --icon-color: ${i.theme.lightText};\n  align-items: center;\n  border-radius: 0 3px 3px 0;\n  padding-left: 16px;\n  color: ${i.theme.text};\n  cursor: pointer;\n  display: flex;\n  height: 32px;\n  line-height: 32px;\n  flex: 1;\n  &:hover {\n    background-color: ${i.theme.pageHoverBg};\n  }\n  &-selected, &-selected:hover {\n    background-color: ${i.theme.activePageBg};\n    color: ${i.theme.activePageFg};\n    --icon-color: ${i.theme.activePageFg};\n  }\n`),Vi=(0,r.styled)("div","\n  display: flex;\n  align-items: flex-end;\n  padding-bottom: 8px;\n  justify-content: space-between;\n  height: 36px;\n"),Ni=(0,r.styled)("span","\n  font-weight: 600;\n"),ji=(0,r.styled)("div","\n  display: flex;\n  align-items: center;\n  margin-bottom: 8px;\n"),Wi=(0,r.styled)(s.icon,`\n  flex: none;\n  color: ${i.theme.controlFg};\n  --icon-color: ${i.theme.controlFg};\n  margin-left: 4px;\n  margin-top: -4px;\n  cursor: pointer;\n  &:hover {\n    --icon-color: ${i.theme.controlHoverFg};\n  }\n`),Hi=(0,r.styled)(s.icon,`\n  --icon-color: ${i.theme.iconError};\n  right: 2px;\n  position: absolute;\n  z-index: 1;\n  top: calc(50% - 8px);\n`),Gi=(0,r.styled)(s.icon,`\n  flex: none;\n  color: ${i.theme.controlFg};\n  --icon-color: ${i.theme.controlFg};\n  margin-right: 4px;\n  margin-top: -3px;\n  width: 12px;\n`),Ki=(0,r.styled)("div","\n  display: flex;\n  align-items: baseline;\n"),Ji=(0,r.styled)(gi,`\n  &-skip {\n    color: ${i.theme.lightText};\n  }\n`),Xi=(0,r.styled)(s.icon,"\n  transform: rotate(180deg);\n"),qi=(0,r.styled)("div",`\n--icon-color: ${i.theme.accentIcon};\n`),Yi=(0,r.styled)("span",`\n  text-transform: uppercase;\n  color: ${i.theme.darkText};\n  text-transform: uppercase;\n  font-weight: 600;\n  font-size: ${i.vars.smallFontSize};\n  letter-spacing: 0.5px;\n`),Zi=(0,r.styled)("div",`\n  padding: 0px 4px;\n  font-size: ${i.vars.xsmallFontSize};\n  color: ${i.theme.lightText};\n`),Qi=(0,r.styled)(ae.textButton,`\n  text-transform: uppercase;\n  font-size: ${i.vars.smallFontSize};\n  letter-spacing: 0.5px;\n  text-align: left;\n  margin-bottom: 16px;\n  color: ${i.theme.lightText};\n`);var es=o(85842),ts=o(80864),os=o(36524),is=o(37540),ss=o(7740);const ns=(0,F.makeT)("DuplicateTable"),rs=(0,r.makeTestId)("test-duplicate-table-");class ls extends r.Disposable{constructor(e,t){super(),this._gristDoc=e,this._tableId=t,this._newTableName=r.Observable.create(this,""),this._includeData=r.Observable.create(this,!1),this._saveDisabled=r.Computed.create(this,this._newTableName,((e,t)=>!t.trim()))}get saveDisabled(){return this._saveDisabled}save(){return this._duplicateTable()}buildDom(){return[(0,ss.$S)((0,r.input)(this._newTableName,{onInput:!0},{placeholder:ns("Name for new table")},(e=>{setTimeout((()=>{e.focus()}),20)}),r.dom.on("focus",((e,t)=>{t.select()})),r.dom.cls(is.g.className),rs("name"))),ds(cs("Warning"),(0,r.dom)("div",ns("Instead of duplicating tables, it's usually better to segment data using linked views. {{link}}",{link:(0,io.Y3)({href:Jt.PH.helpLinkingWidgets,target:"_blank"},"Read More.")}))),(0,ss.$S)(as(this._includeData,ns("Copy all data in addition to the table structure."),rs("copy-all-data"))),r.dom.maybe(this._includeData,(()=>ds(cs("Warning"),(0,r.dom)("div",ns("Only the document default access rules will apply to the copy.")),rs("acl-warning"))))]}_duplicateTable(){const{docData:e}=this._gristDoc,[t,o]=[this._newTableName.get(),this._includeData.get()];return e.sendAction(["DuplicateTable",this._tableId,t,o])}}const as=(0,r.styled)(de.rp,"\n  margin-top: 8px;\n"),ds=(0,r.styled)("div","\n  display: flex;\n  column-gap: 8px;\n"),cs=(0,r.styled)(s.icon,`\n  --icon-color: ${i.colors.orange};\n  flex-shrink: 0;\n`);var us=o(21467),hs=o(73181),ps=o(73154),ms=Object.defineProperty,gs=Object.getOwnPropertySymbols,fs=Object.prototype.hasOwnProperty,ws=Object.prototype.propertyIsEnumerable,bs=(e,t,o)=>t in e?ms(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;const vs=(0,r.makeTestId)("test-widget-title-"),ys=(0,F.makeT)("WidgetTitle");function _s(e,t,o,i,...s){return Cs(Ss(vs("text"),r.dom.text(t),Ss.cls("-empty",(e=>{var o;return!(null==(o=e(t))?void 0:o.trim())})),(t=>{(0,us.setPopupToCreateDom)(t,(t=>function(e,t,o){var i,s;const l=t.table.peek(),a=Boolean(l.summarySourceTable.peek()),d=[l.tableNameDef.peek(),l.groupDesc.peek()].filter((e=>Boolean(null==e?void 0:e.trim()))).join(" "),c=r.Observable.create(e,d),u=r.Observable.create(e,null!=(i=t.title.peek())?i:""),h=t.title.peek()?t.defaultWidgetTitle.peek():ys("Override widget title"),p=r.Observable.create(e,null!=(s=t.description.peek())?s:""),m=r.Computed.create(e,(e=>{var o,i,s,n,r,l;const a=null!=(i=null==(o=e(c))?void 0:o.trim())?i:"",h=null!=(n=null==(s=e(u))?void 0:s.trim())?n:"",m=null!=(l=null==(r=e(p))?void 0:r.trim())?l:"";return!a||a===d&&h===e(t.title)&&m===e(t.description)})),g=wo.ModalControl.create(e,(()=>e.close())),f=async()=>{a||c.get().trim()&&c.get()!==l.tableNameDef.peek()&&await l.tableNameDef.saveOnly(c.get())},w=async()=>{var e,o;const i=null!=(o=null==(e=u.get())?void 0:e.trim())?o:"";i!==t.title.peek()&&await t.title.saveOnly(i)},b=async()=>{var e;const o=null!=(e=p.get().trim())?e:"";o!==t.description.peek()&&await t.description.saveOnly(o)};function v(){const e=!D,o=!t.title.peek();var i;null==(i=a?D:e||o?I:D)||i.focus(),null==i||i.select()}let y=!1;const _=()=>e.close(),x=()=>{y=!0,_()},C={cancel:x,accept:()=>{if(document.activeElement===R)return!0;_()},cursorUp:()=>{if(document.activeElement===R&&0===(null==R?void 0:R.selectionStart))null==D||D.focus(),null==D||D.select();else{if(document.activeElement!==D)return!0;null==I||I.focus(),null==I||I.select()}},cursorDown:()=>{if(document.activeElement===I)null==D||D.focus(),null==D||D.select();else{if(document.activeElement!==D)return!0;null==R||R.focus(),null==R||R.select()}}},S=Gt.createGroup(((e,t)=>{for(var o in t||(t={}))fs.call(t,o)&&bs(e,o,t[o]);if(gs)for(var o of gs(t))ws.call(t,o)&&bs(e,o,t[o]);return e})({},C),e,!0);let I,D,R;return(0,ps.GM)((t=>{ko.FocusLayer.create(e,{defaultFocusElem:t,pauseMousetrap:!1})}),r.dom.onDispose((()=>{y||Promise.all([f(),w(),b()]).catch(reportError)})),r.dom.autoDispose(S),vs("popup"),r.dom.cls(n.menuCssClass),r.dom.maybe(!o.tableNameHidden,(()=>[(0,ps.xY)(ys("DATA TABLE NAME")),I=(0,ps.g8)(c,xs,{disabled:a,placeholder:ys("Provide a table name")},vs("table-name-input"),S.attach())])),r.dom.maybe(!o.widgetNameHidden,(()=>[(0,ps.xY)(ys("WIDGET TITLE")),D=(0,ps.g8)(u,xs,{placeholder:h},vs("section-name-input"),S.attach())])),(0,ps.xY)(ys("WIDGET DESCRIPTION")),R=(0,ps.F5)(p,xs,vs("section-description-input"),S.attach(),(0,hs.po)(p)),Is((0,ae.primaryButton)(ys("Save"),r.dom.on("click",_),r.dom.boolAttr("disabled",(e=>e(m)||e(g.workInProgress))),vs("save")),(0,ae.basicButton)(ys("Cancel"),vs("cancel"),r.dom.on("click",x))),r.dom.onKeyDown({Enter$:e=>{if(e.ctrlKey||e.metaKey)return _(),!1}}),(e=>{setTimeout(v,0)}))}(t,e,i)),{placement:"bottom-start",trigger:["click"],attach:"body",boundaries:"viewport"})}),r.dom.on("click",(e=>{e.stopPropagation(),e.preventDefault()}))),r.dom.maybe(o,(()=>[(0,oo.descriptionInfoTooltip)(o.get(),"widget")])),...s)}const xs={onInput:!0},Cs=(0,r.styled)("div","\n  flex: 1 1 0px;\n  min-width: 0px;\n  display: flex;\n  .info_toggle_icon {\n    width: 13px;\n    height: 13px;\n  }\n"),Ss=(0,r.styled)("div",`\n  cursor: pointer;\n  overflow: hidden;\n  border-radius: 3px;\n  margin: -4px;\n  padding: 4px;\n  text-overflow: ellipsis;\n  align-self: start;\n  &:hover {\n    background-color: ${i.theme.hover};\n  }\n  &-empty {\n    min-width: 48px;\n    min-height: 23px;\n  }\n`),Is=(0,r.styled)("div",`\n  display: flex;\n  margin-top: 16px;\n  & > .${ae.cssButton.className}:not(:first-child) {\n    margin-left: 8px;\n  }\n`),Ds=(0,r.makeTestId)("test-raw-data-"),Rs=(0,F.makeT)("DataTables");class Ts extends r.Disposable{constructor(e){super(),this._gristDoc=e,this._rowCount=r.Computed.create(this,this._gristDoc.docPageModel.currentDocUsage,((e,t)=>null==t?void 0:t.rowCount)),this._rowCountFormatter=new Intl.NumberFormat("en-US"),this._tables=r.Computed.create(this,(t=>[...t(e.docModel.rawDataTables.getObservable()),...t(e.docModel.rawSummaryTables.getObservable())].filter((e=>Boolean(t(e.tableId))))))}buildDom(){return ks(Ks(Ds("list"),Ms(Rs("Raw Data Tables")),Os(r.dom.forEach(this._tables,(e=>As(Ds("table"),Ps(r.dom.domComputed((t=>$s(0!==t(e.summarySourceTable)?"PivotLight":"TypeTable",Ds(`table-id-${t(e.tableId)}`))))),Fs(Es(Hs(this._tableTitle(e),Ds("table-title"))),Bs(zs(Ns(Gs("Table ID: "),js(Ds("table-id"),r.dom.text(e.tableId)),{title:Rs("Click to copy")},r.dom.on("click",(async(t,o)=>{t.stopImmediatePropagation(),t.preventDefault(),(0,oo.showTransientTooltip)(o,Rs("Table ID copied to clipboard"),{key:"copy-table-id"}),await(0,es.copyToClipboard)(e.tableId.peek()),(0,ts.setTestState)({clipboard:e.tableId.peek()})})))),this._tableRows(e))),Ls((0,os.f)(Ds("table-menu"),(0,s.icon)("Dots"),(0,n.menu)((()=>this._menuItems(e)),{placement:"bottom-start"}),r.dom.on("click",(e=>{e.stopPropagation(),e.preventDefault()})))),r.dom.on("click",(()=>{const t=e.rawViewSection.peek().getRowId();if(!t)throw new Error(`Table ${e.tableId.peek()} doesn't have a raw view section.`);this._gristDoc.viewModel.activeSectionId(t)}))))))))}_tableTitle(e){return r.dom.domComputed((t=>{const o=t((0,r.fromKo)(e.rawViewSectionRef)),i=0!==t(e.summarySourceTable);if(!o||i){const o=[t(e.tableNameDef),i?t(e.groupDesc):""].filter((e=>Boolean(null==e?void 0:e.trim()))).join(" ");return Xs(o)}return(0,r.dom)("div",r.dom.domComputed((0,r.fromKo)(e.rawViewSection),(e=>function(e,...t){const o=r.Computed.create(null,(t=>t(t(e.table).tableNameDef))),i=r.Computed.create(null,(t=>t(e.description)));return _s(e,o,i,{widgetNameHidden:!0},r.dom.autoDispose(o),...t)}(e,Ds("widget-title")))))}))}_menuItems(e){const{isReadonly:t,docModel:o}=this._gristDoc;return[(0,n.menuItem)((()=>this._duplicateTable(e)),Rs("Duplicate Table"),Ds("menu-duplicate-table"),r.dom.cls("disabled",(o=>o(t)||o(e.isHidden)||0!==o(e.summarySourceTable)))),(0,n.menuItem)((()=>this._removeTable(e)),"Remove",Ds("menu-remove"),r.dom.cls("disabled",(i=>i(t)||i(o.visibleTables.getObservable()).length<=1&&!i(e.isHidden)))),r.dom.maybe(t,(()=>(0,n.menuText)(Rs("You do not have edit access to this document"))))]}_duplicateTable(e){!function(e,t,{onSuccess:o}={}){(0,wo.saveModal)(((i,s)=>{const n=ls.create(s,e,t);return{title:"Duplicate Table",body:n.buildDom(),saveFunc:async()=>{const e=await n.save();null==o||o(e)},saveDisabled:n.saveDisabled,width:"normal"}}))}(this._gristDoc,e.tableId(),{onSuccess:({raw_section_id:e})=>this._gristDoc.viewModel.activeSectionId(e)})}_removeTable(e){const{docModel:t}=this._gristDoc;(0,wo.confirmModal)(Rs("Delete {{formattedTableName}} data, and remove it from all pages?",{formattedTableName:e.formattedTableName()}),"Delete",(function(){return t.docData.sendAction(["RemoveTable",e.tableId()])}))}_tableRows(e){return r.dom.maybe(this._rowCount,(t=>"hidden"===t?null:Vs(Gs("Rows: "),"pending"===t?Js():Ws(void 0!==t[e.getRowId()]?this._rowCountFormatter.format(t[e.getRowId()]):"",Ds("table-rows")))))}}const ks=(0,r.styled)("div","\n  overflow-y: auto;\n  position: relative;\n"),Ms=(0,r.styled)(os.gs,"\n  display: inline-block;\n"),Os=(0,r.styled)("div","\n  display: flex;\n  flex-direction: column;\n  gap: 12px;\n"),As=(0,r.styled)("div",`\n  display: flex;\n  align-items: center;\n  cursor: pointer;\n  border-radius: 3px;\n  width: 100%;\n  height: calc(1em * 56/13); /* 56px for 13px font */\n  max-width: 750px;\n  border: 1px solid ${i.theme.rawDataTableBorder};\n  &:hover {\n    border-color: ${i.theme.rawDataTableBorderHover};\n  }\n`),Ps=(0,r.styled)("div","\n  padding-top: 11px;\n  padding-left: 12px;\n  margin-right: 8px;\n  align-self: flex-start;\n  display: flex;\n  flex: none;\n"),Fs=(0,r.styled)("div","\n  flex-grow: 1;\n  min-width: 0px;\n  display: flex;\n  flex-wrap: wrap;\n  margin-top: 6px;\n  margin-bottom: 4px;\n"),Es=(0,r.styled)("div","\n  min-width: 100%;\n  margin-right: 4px;\n"),Bs=(0,r.styled)("div","\n  min-width: 100%;\n  display: flex;\n  gap: 8px;\n"),Ls=(0,r.styled)("div","\n  padding-right: 8px;\n  margin-left: 8px;\n  align-self: center;\n  display: flex;\n  flex: none;\n"),$s=(0,r.styled)(s.icon,`\n  --icon-color: ${i.theme.accentIcon};\n`),Us=(0,r.styled)("span","\n  white-space: nowrap;\n  text-overflow: ellipsis;\n  overflow: hidden;\n"),zs=(0,r.styled)("div","\n  display: flex;\n  flex-grow: 1;\n  min-width: 0;\n"),Vs=(0,r.styled)("div",`\n  display: flex;\n  flex-shrink: 0;\n  min-width: 100px;\n  overflow: hidden;\n  align-items: baseline;\n  color: ${i.theme.lightText};\n  line-height: 18px;\n  padding: 0px 2px;\n`),Ns=(0,r.styled)("div",`\n  display: flex;\n  overflow: hidden;\n  cursor: default;\n  align-items: baseline;\n  color: ${i.theme.lightText};\n  transition: background 0.05s;\n  padding: 0px 2px;\n  line-height: 18px;\n  &:hover {\n    background: ${i.theme.lightHover};\n  }\n`),js=(0,r.styled)(Us,`\n  font-size: ${i.vars.smallFontSize};\n`),Ws=js,Hs=(0,r.styled)("div",`\n  color: ${i.theme.text};\n  white-space: nowrap;\n`),Gs=(0,r.styled)("span","\n  text-transform: uppercase;\n  letter-spacing: 0.81px;\n  font-weight: 500;\n  font-size: 9px; /* xxsmallFontSize is to small */\n  margin-right: 2px;\n  flex: 0;\n  white-space: nowrap;\n"),Ks=(0,r.styled)("div","\n  overflow-y: auto;\n  position: relative;\n  margin-bottom: 56px;\n"),Js=(0,r.styled)(Bo.W,"\n  --dot-size: 6px;\n"),Xs=(0,r.styled)("span",`\n  color: ${i.theme.text};\n`);var qs=o(13998),Ys=o(3988),Zs=o(7485),Qs=o(29116),en=o(49668),tn=o(51503);const on=(0,F.makeT)("DocumentUsage"),sn=(0,r.makeTestId)("test-doc-usage-");class nn extends r.Disposable{constructor(e){super(),this._docPageModel=e,this._currentDoc=this._docPageModel.currentDoc,this._currentDocUsage=this._docPageModel.currentDocUsage,this._currentOrg=this._docPageModel.currentOrg,this._currentProduct=this._docPageModel.currentProduct,this._rowCountFormatter=new Intl.NumberFormat("en-US"),this._dataLimitStatus=r.Computed.create(this,this._currentDocUsage,((e,t)=>{var o;return null!=(o=null==t?void 0:t.dataLimitStatus)?o:null})),this._rowCount=r.Computed.create(this,this._currentDocUsage,((e,t)=>null==t?void 0:t.rowCount)),this._dataSizeBytes=r.Computed.create(this,this._currentDocUsage,((e,t)=>null==t?void 0:t.dataSizeBytes)),this._attachmentsSizeBytes=r.Computed.create(this,this._currentDocUsage,((e,t)=>null==t?void 0:t.attachmentsSizeBytes)),this._rowMetricOptions=r.Computed.create(this,this._currentProduct,this._rowCount,((e,t,o)=>{const i=null==t?void 0:t.features.baseMaxRowsPerDocument,s=i&&i>0?i:void 0;return{name:on("Rows"),currentValue:"object"!=typeof o?void 0:o.total,maximumValue:null!=s?s:2e4,unit:"rows",shouldHideLimits:void 0===s,formatValue:e=>this._rowCountFormatter.format(e)}})),this._dataSizeMetricOptions=r.Computed.create(this,this._currentProduct,this._dataSizeBytes,((e,t,o)=>{const i=null==t?void 0:t.features.baseMaxDataSizePerDocument,s=i&&i>0?i:void 0;return{name:on("Data Size"),currentValue:"number"!=typeof o?void 0:o,maximumValue:null!=s?s:4096e4,unit:"MB",shouldHideLimits:void 0===s,tooltipContentFunc:Zs.D.dataSize,formatValue:e=>(e/1024/1e3).toFixed(2)}})),this._attachmentsSizeMetricOptions=r.Computed.create(this,this._currentProduct,this._attachmentsSizeBytes,((e,t,o)=>{const i=null==t?void 0:t.features.baseMaxAttachmentsBytesPerDocument,s=i&&i>0?i:void 0;return{name:on("Attachments Size"),currentValue:"number"!=typeof o?void 0:o,maximumValue:null!=s?s:1073741824,unit:"GB",shouldHideLimits:void 0===s,formatValue:e=>(e/1073741824).toFixed(2)}})),this._areAllMetricsPending=r.Computed.create(this,this._currentDoc,this._rowCount,this._dataSizeBytes,this._attachmentsSizeBytes,((e,t,o,i,s)=>{const n=[o,i,s].some((e=>"pending"!==e&&void 0!==e));return!t||!n})),this._isAccessDenied=r.Computed.create(this,this._areAllMetricsPending,this._currentDoc,this._rowCount,this._dataSizeBytes,this._attachmentsSizeBytes,((e,t,o,i,s,n)=>{if(t)return null;const{access:r}=o.workspace.org,l="guests"===r||null===r,a=[i,s,n].some((e=>"hidden"===e));return l||a}))}buildDom(){return(0,r.dom)("div",fn(on("Usage"),sn("heading")),r.dom.domComputed(this._areAllMetricsPending,(e=>e?_n((0,Bo.M)(),sn("loading")):[this._buildMessage(),this._buildMetrics()])),sn("container"))}_buildMessage(){return r.dom.domComputed((e=>{const t=e(this._isAccessDenied);if(null===t)return null;if(t)return cn(on("Usage statistics are only available to users with full access to the document data."));const o=e(this._currentOrg),i=e(this._currentProduct),s=e(this._dataLimitStatus);return o&&s?cn([rn(s,null==i?void 0:i.features,{disableRawDataLink:!0}),i&&(0,en.Vz)(i.name)?[" ",ln((0,tn.eb)(o),"long",(()=>this._docPageModel.appModel.showUpgradeModal()))]:null]):null}))}_buildMetrics(){return r.dom.maybe((e=>!1===e(this._isAccessDenied)),(()=>wn(r.dom.domComputed(this._rowMetricOptions,(e=>dn(e,sn("rows")))),r.dom.domComputed(this._dataSizeMetricOptions,(e=>dn(e,sn("data-size")))),r.dom.domComputed(this._attachmentsSizeMetricOptions,(e=>dn(e,sn("attachments-size")))),sn("metrics"))))}}function rn(e,t,o={}){const{disableRawDataLink:i=!1}=o;switch(e){case"approachingLimit":return["This document is ",i?"approaching":an("approaching")," free plan limits."];case"gracePeriod":{const e=null==t?void 0:t.gracePeriodDays;return e?["Document limits ",i?"exceeded":an("exceeded"),`. In ${e} days, this document will be read-only.`]:["Document limits ",i?"exceeded":an("exceeded"),"."]}case"deleteOnly":return["This document ",i?"exceeded":an("exceeded")," free plan limits and is now read-only, but you can delete rows."]}}function ln(e,t,o){if(!e)return on("Contact the site owner to upgrade the plan to raise limits.");const i=on("start your 30-day free trial of the Pro plan.");return["short"===t?null:on("For higher limits, "),(s="short"===t?(0,P.capitalizeFirstWord)(i):i,n=()=>o(),(0,qs._O)(s,r.dom.on("click",(()=>n()))))];var s,n}function an(e){return(0,qs._O)(e,(0,Ys.urlState)().setLinkUrl({docPage:"data"}))}function dn(e,...t){const{name:o,tooltipContentFunc:i}=e;return bn(mn(i?(0,oo.withInfoTooltip)(gn(o,sn("name")),i()):gn(o,sn("name"))),function(e){const{currentValue:t,maximumValue:o,shouldHideLimits:i,unit:s,formatValue:n=(e=>e.toString())}=e;let l,a;return void 0===t?(l=0,a=0):(l=t/(o||1/0),a=Math.min(100,Math.floor(100*l))),[vn(yn({style:`width: ${a}%`},i||l<=Qs.cM?null:yn.cls("-approaching-limit"),sn("progress-fill"))),(0,r.dom)("div",void 0===t?["Loading ",xn()]:n(t)+(i||!o?"":" of "+n(o))+(s?` ${s}`:""),sn("value"))]}(e),...t)}function cn(e){return hn(pn("Idea"),un(e,sn("message-text")),sn("message"))}const un=(0,r.styled)("div","\n  font-weight: 500;\n"),hn=(0,r.styled)("div",`\n  color: ${i.theme.text};\n  --icon-color: ${i.theme.text};\n  display: flex;\n  gap: 16px;\n  margin-top: 16px;\n`),pn=(0,r.styled)(s.icon,"\n  flex-shrink: 0;\n  width: 16px;\n  height: 16px;\n"),mn=(0,r.styled)("div","\n  display: flex;\n  align-items: center;\n  gap: 8px;\n  font-weight: 700;\n"),gn=(0,r.styled)("span","\n  overflow: hidden;\n  white-space: nowrap;\n  text-overflow: ellipsis;\n"),fn=(0,r.styled)(os.gs,"\n  margin-bottom: 0px;\n"),wn=(0,r.styled)("div","\n  display: flex;\n  flex-wrap: wrap;\n  margin-top: 24px;\n  row-gap: 24px;\n  column-gap: 54px;\n"),bn=(0,r.styled)("div",`\n  color: ${i.theme.text};\n  display: flex;\n  flex-direction: column;\n  width: 180px;\n  gap: 8px;\n\n  @media ${i.mediaXSmall} {\n    & {\n      width: 100%;\n    }\n  }\n`),vn=(0,r.styled)("div",`\n  width: 100%;\n  height: 4px;\n  border-radius: 5px;\n  background: ${i.theme.progressBarBg};\n`),yn=(0,r.styled)(vn,`\n  background: ${i.theme.progressBarFg};\n\n  &-approaching-limit {\n    background: ${i.theme.progressBarErrorFg};\n  }\n`),_n=(0,r.styled)("div","\n  display: flex;\n  justify-content: center;\n  margin-top: 32px;\n"),xn=(0,r.styled)(Bo.W,"\n  --dot-size: 8px;\n");var Cn=o(68498),Sn=o(60664),In=o(3411);const Dn=(0,F.makeT)("ViewLayoutMenu");var Rn=o(91465),Tn=o(21376),kn=Object.defineProperty,Mn=Object.defineProperties,On=Object.getOwnPropertyDescriptors,An=Object.getOwnPropertySymbols,Pn=Object.prototype.hasOwnProperty,Fn=Object.prototype.propertyIsEnumerable,En=(e,t,o)=>t in e?kn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,Bn=(e,t)=>{for(var o in t||(t={}))Pn.call(t,o)&&En(e,o,t[o]);if(An)for(var o of An(t))Fn.call(t,o)&&En(e,o,t[o]);return e},Ln=(e,t)=>Mn(e,On(t));const $n=(0,r.makeTestId)("test-section-menu-"),Un=(0,F.makeT)("ViewSectionMenu");function zn(e,t,o){const{docModel:s,isReadonly:l}=t,a=r.Computed.create(e,(e=>Boolean(e(o.activeFilters).length))),d=r.Computed.create(e,(e=>e(o.filterSpecChanged)||!e(o.activeSortJson.isSaved)||!e(o.activeCustomOptions.isSaved))),c=()=>{(async function(e,t){await e.docData.bundleActions(Un("Update Sort&Filter settings"),(()=>Promise.all([t.activeSortJson.save(),t.saveFilters(),t.activeCustomOptions.save()])))})(s,o).catch(Oo.eK)},u=()=>function(e){e.activeSortJson.revert(),e.revertFilters(),e.activeCustomOptions.revert()}(o),h=r.Computed.create(e,(e=>{const t=e(o.view),i=e(e(t.viewSections).getObservable()).filter((t=>!1===e(t.isCollapsed))).length;return 1===i||!i})),p=r.Computed.create(e,(e=>!e((0,i.isNarrowScreenObs)())&&e(t.maximizedSectionId)!==e(o.id)&&e(t.externalSectionId)!==e(o.id)&&!e(o.isRaw)&&!e(h)));return[Gn(Gn.cls("-unsaved",d),$n("wrapper"),jn($n("sortAndFilter"),Yn($n("filter-icon"),Yn.cls("-any",a),Zn("Filter"),(0,oo.hoverTooltip)("Sort and filter",{key:"sortFilterBtnTooltip"}))),r.dom.maybe(d,(()=>nr(or(Un("Save"),or.cls("-accent"),r.dom.on("click",c),(0,oo.hoverTooltip)("Save sort & filter settings",{key:"sortFilterBtnTooltip"}),$n("small-btn-save"),r.dom.hide(l)),ir(sr("Revert",sr.cls("-normal")),r.dom.on("click",u),(0,oo.hoverTooltip)("Revert sort & filter settings",{key:"sortFilterBtnTooltip"}),$n("small-btn-revert"))))),(0,n.menu)((e=>{return[Vn(o,t),(i=o,[(0,In.cssLabel)(Un("FILTER"),$n("heading-filter")),r.dom.create(Rn.P,i,{menuOptions:{attach:null}})]),r.dom.maybe((e=>"custom"===e(o.parentKey)),(()=>function(e){const t=r.Computed.create(null,(t=>t(e.activeCustomOptions.isSaved)?"-normal":"-accent")),o=r.Computed.create(null,(t=>t(e.activeCustomOptions)?t(e.activeCustomOptions.isSaved)?Un("(customized)"):Un("(modified)"):Un("(empty)")));return[Qn(Un("Custom options"),$n("heading-widget-options")),er(r.dom.autoDispose(o),r.dom.autoDispose(t),r.dom.text(o),er.cls(t),rr(),r.dom.maybe((t=>Boolean(t(e.activeCustomOptions))),(()=>Hn(Kn("Remove",$n("btn-remove-options"),r.dom.on("click",(()=>e.activeCustomOptions(null))))))),$n("custom-options"))]}(o))),r.dom.domComputed(d,(t=>[t?(0,In.cssSaveButtonsRow)(tr(Un("Save"),$n("btn-save"),r.dom.on("click",(()=>{e.close(),c()})),r.dom.boolAttr("disabled",l)),(0,ae.basicButton)(Un("Revert"),$n("btn-revert"),r.dom.on("click",(()=>{e.close(),u()})))):null])),r.dom.autoDispose(o.activeFilters.addListener((()=>e.update()))),r.dom.autoDispose(o.activeSortJson.subscribe((()=>e.update())))];var i}),Ln(Bn({},us.defaultMenuOptions),{placement:"bottom-end",trigger:[(e,t)=>r.dom.onMatchElem(e,".test-section-menu-sortAndFilter","click",(()=>{t.toggle()})),(e,t)=>r.dom.onMatchElem(e,".test-section-menu-small-btn-save","click",(()=>{t.close()})),(e,t)=>r.dom.onMatchElem(e,".test-section-menu-small-btn-revert","click",(()=>{t.close()}))]}))),jn($n("viewLayout"),Jn(Kn("Dots")),(0,n.menu)((e=>function(e,t){var o;const s=e.viewInstance.peek(),l=s.gristDoc,a=s.cursor.rowIndex.peek(),d="new"===(null!==a?s.viewData.getRowId(a):null),c=[(0,n.menuItemCmd)(Gt.allCommands.deleteRecords,Dn("Delete record"),(0,i.testId)("section-delete-card"),r.dom.cls("disabled",t||d)),(0,n.menuItemCmd)(Gt.allCommands.copyLink,Dn("Copy anchor link"),(0,i.testId)("section-card-link")),(0,n.menuDivider)()],u=e.view(),h="singlePage"===(null==(o=(0,Ys.urlState)().state.get().params)?void 0:o.style),p=e.table.peek().rawViewSectionRef.peek(),m=s.getAnchorLinkForSection(p);m.hash.popup=!0;const g=(0,Ys.urlState)().makeUrl(m),f=()=>!u.getRowId()||u.viewSections().peekLength<=1||t||1===(()=>{var e,t;return null!=(t=null==(e=l.viewLayout)?void 0:e.layout.getAllLeafIds().length)&&t})();return[r.dom.maybe((t=>["single"].includes(t(e.parentKey))),(()=>c)),r.dom.maybe((t=>!t(e.isRaw)&&!h),(()=>(0,n.menuItemLink)({href:g},Dn("Show raw data"),(0,i.testId)("show-raw-data"),r.dom.on("click",(e=>{e.stopImmediatePropagation(),e.preventDefault(),(0,Ys.urlState)().pushUrl(m,{replace:!0}).catch(reportError)}))))),(0,n.menuItemCmd)(Gt.allCommands.printSection,Dn("Print widget"),(0,i.testId)("print-section")),(0,n.menuItemLink)({href:l.getCsvLink(),target:"_blank",download:""},Dn("Download as CSV"),(0,i.testId)("download-section")),(0,n.menuItemLink)({href:l.getXlsxActiveViewLink(),target:"_blank",download:""},Dn("Download as XLSX"),(0,i.testId)("download-section")),r.dom.maybe((t=>["detail","single"].includes(t(e.parentKey))),(()=>(0,n.menuItemCmd)(Gt.allCommands.editLayout,Dn("Edit Card Layout"),r.dom.cls("disabled",t)))),r.dom.maybe(!h,(()=>[(0,n.menuDivider)(),(0,n.menuItemCmd)(Gt.allCommands.viewTabOpen,Dn("Widget options"),(0,i.testId)("widget-options")),(0,n.menuItemCmd)(Gt.allCommands.sortFilterTabOpen,Dn("Advanced Sort & Filter")),(0,n.menuItemCmd)(Gt.allCommands.dataSelectionTabOpen,Dn("Data selection"))])),(0,n.menuDivider)(),r.dom.maybe((t=>"custom"===t(e.parentKey)&&t(e.hasCustomOptions)),(()=>(0,n.menuItemCmd)(Gt.allCommands.openWidgetConfiguration,Dn("Open configuration"),(0,i.testId)("section-open-configuration")))),(0,n.menuItemCmd)(Gt.allCommands.collapseSection,Dn("Collapse widget"),r.dom.cls("disabled",f()||l.externalSectionId.get()===e.getRowId()||l.maximizedSectionId.get()===e.getRowId()),(0,i.testId)("section-collapse")),(0,n.menuItemCmd)(Gt.allCommands.deleteSection,Dn("Delete widget"),r.dom.cls("disabled",f()),(0,i.testId)("section-delete"))]}(o,l.get())),Ln(Bn({},us.defaultMenuOptions),{placement:"bottom-end"}))),r.dom.maybe(p,(()=>Xn(qn("Grow"),$n("expandSection"),r.dom.on("click",(()=>Gt.allCommands.maximizeActiveSection.run())),(0,oo.hoverTooltip)("Expand section",{key:"expandSection"}))))]}function Vn(e,t){return[(0,In.cssLabel)(Un("SORT"),$n("heading-sort")),r.dom.create(Tn.m,e,t,{menuOptions:{attach:null}})]}const Nn=(0,r.styled)("div",""),jn=(0,r.styled)("div",`\n  display: flex;\n  cursor: pointer;\n  border-radius: 3px;\n  &.${Nn.className} {\n    margin-top: 0px;\n    border-radius: 0px;\n  }\n  &:hover, &.weasel-popup-open {\n    background-color: ${i.theme.hover};\n  }\n`),Wn=(0,r.styled)("div","\n  padding: 3px;\n  border-radius: 3px;\n  cursor: pointer;\n  user-select: none;\n"),Hn=(0,r.styled)(Wn,`\n  display: flex;\n  margin: -3px 0;\n  width: 22px;\n  height: 22px;\n\n  &:hover, &.weasel-popup-open {\n    background-color: ${i.theme.hover};\n  }\n  &-changed {\n    background-color: ${i.theme.accentIcon};\n  }\n  &-changed:hover, &-changed:hover.weasel-popup-open {\n    background-color: ${i.theme.controlHoverFg};\n  }\n`),Gn=(0,r.styled)("div",`\n  display: flex;\n  border-radius: 3px;\n  align-items: center;\n  &-unsaved {\n    border: 1px solid ${i.theme.accentBorder};\n  }\n  & .${jn.className} {\n    border: none;\n  }\n`),Kn=(0,r.styled)(s.icon,`\n  flex: none;\n  cursor: pointer;\n  background-color: ${i.theme.lightText};\n\n  .${Hn.className}-changed & {\n    background-color: ${i.theme.controlPrimaryFg};\n  }\n\n  .${Nn.className} & {\n    background-color: ${i.theme.controlPrimaryFg};\n  }\n\n  &-accent {\n    background-color: ${i.theme.accentIcon};\n  }\n`),Jn=(0,r.styled)(Wn,`\n  border-radius: 0px 2px 2px 0px;\n  display: flex;\n  .${Nn.className} & {\n    border-radius: 0px;\n  }\n`),Xn=(0,r.styled)("div",`\n  display: flex;\n  border-radius: 3px;\n  align-items: center;\n  padding: 4px;\n  cursor: pointer;\n  &:hover, &.weasel-popup-open {\n    background-color: ${i.theme.hover};\n  }\n`),qn=(0,r.styled)(Kn,"\n  height: 13px;\n  width: 13px;\n"),Yn=(0,r.styled)(Wn,`\n  border-radius: 2px 0px 0px 2px;\n  display: flex;\n  &-any {\n    border-radius: 2px;\n    background-color: ${i.theme.controlSecondaryFg};\n  }\n  .${Gn.className}-unsaved & {\n    background-color: ${i.theme.controlPrimaryBg};\n  }\n`),Zn=(0,r.styled)(Kn,`\n  .${Yn.className}-any & {\n    background-color: ${i.theme.controlPrimaryFg};\n  }\n  .${Gn.className}-unsaved & {\n    background-color: ${i.theme.controlPrimaryFg};\n  }\n`),Qn=(0,r.styled)("div",`\n  color: ${i.theme.menuSubheaderFg};\n  font-weight: ${i.vars.bigControlTextWeight};\n  padding: 8px 24px 8px 24px;\n  cursor: default;\n`),er=(0,r.styled)("div",`\n  display: flex;\n  align-items: center;\n  padding: 0px 24px 8px 24px;\n  cursor: default;\n  white-space: nowrap;\n  &-accent {\n    color: ${i.theme.accentText};\n  }\n  &-normal {\n    color: ${i.theme.lightText};\n  }\n`),tr=(0,r.styled)(ae.primaryButton,"\n  margin-right: 8px;\n"),or=(0,r.styled)("div",`\n  display: flex;\n  align-items: center;\n  cursor: pointer;\n  font-size: ${i.vars.mediumFontSize};\n  padding: 0px 5px;\n  border-right: 1px solid ${i.theme.accentBorder};\n\n  &-accent {\n    color: ${i.theme.accentText};\n  }\n`),ir=(0,r.styled)("div","\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  cursor: pointer;\n"),sr=(0,r.styled)(s.icon,`\n  --icon-color: ${i.theme.accentIcon};\n  margin: 0 5px 0 5px;\n`),nr=(0,r.styled)("div","\n  padding: 0 1px 0 1px;\n  display: flex;\n  justify-content: space-between;\n  align-self: normal;\n"),rr=(0,r.styled)("div","\n  margin: 0 auto;\n");var lr=o(33769),ar=Object.defineProperty,dr=Object.defineProperties,cr=Object.getOwnPropertyDescriptors,ur=Object.getOwnPropertySymbols,hr=Object.prototype.hasOwnProperty,pr=Object.prototype.propertyIsEnumerable,mr=(e,t,o)=>t in e?ar(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;const gr=(0,F.makeT)("ViewSection");function fr(e,...t){const{gristDoc:o,sectionRowId:l}=e;if("string"==typeof l)return Sr((0,r.dom)("span.viewsection_title_font","Empty"));const a=o.docModel.viewSections.getRowModel(l),d=r.Computed.create(null,(e=>(0,lr.a)(e(a.parentKey)).icon));return Sr((0,i.testId)(`collapsed-section-${l}`),(0,i.testId)("collapsed-section"),Ir(r.dom.domComputed(d,(e=>(0,s.icon)(e))),(0,r.dom)("div",{style:"margin-right: 16px;"}),r.dom.maybe((e=>e(e(a.table).summarySourceTable)),(()=>vr("Pivot",(0,i.testId)("sigma")))),(0,r.dom)("span.viewsection_title_font",(0,i.testId)("collapsed-section-title"),r.dom.text(a.titleDef))),jn((0,i.testId)("section-menu-viewLayout"),Jn((0,In.cssIcon)("Dots")),(0,n.menu)((e=>function(e,t){var o;const s=t.isReadonly.get(),l="singlePage"===(null==(o=(0,Ys.urlState)().state.get().params)?void 0:o.style),a={hash:{sectionId:e.table.peek().rawViewSectionRef.peek(),popup:!0}},d=(0,Ys.urlState)().makeUrl(a);return[r.dom.maybe((o=>!o(e.isRaw)&&!l&&!o(t.maximizedSectionId)),(()=>(0,n.menuItemLink)({href:d},Dn("Show raw data"),(0,i.testId)("show-raw-data"),r.dom.on("click",(e=>{e.stopImmediatePropagation(),e.preventDefault(),(0,Ys.urlState)().pushUrl(a,{replace:!0}).catch(reportError)}))))),(0,n.menuDivider)(),(0,n.menuItemCmd)(Gt.allCommands.expandSection,Dn("Add to page"),r.dom.cls("disabled",s),(0,i.testId)("section-expand")),(0,n.menuItemCmd)(Gt.allCommands.deleteCollapsedSection,Dn("Delete widget"),r.dom.cls("disabled",s),(0,i.testId)("section-delete"))]}(a,o)),(c=((e,t)=>{for(var o in t||(t={}))hr.call(t,o)&&mr(e,o,t[o]);if(ur)for(var o of ur(t))pr.call(t,o)&&mr(e,o,t[o]);return e})({},us.defaultMenuOptions),dr(c,cr({placement:"bottom-end"}))))),...t);var c}function wr(e){var t;const o=null!=(t=e.isResizing)?t:r.Observable.create(null,!1),{gristDoc:s,sectionRowId:n,viewModel:l,draggable:a=!0,focusable:d=!0}=e,c=s.docModel.viewSections.getRowModel(n),u=r.Computed.create(null,(e=>e(c.linkSrcSectionRef)?e(e(c.linkSrcSection).titleDef):null));return(0,r.dom)("div.view_leaf.viewsection_content.flexvbox.flexauto",(0,i.testId)(`viewlayout-section-${n}`),r.dom.autoDispose(u),e.isResizing?null:r.dom.autoDispose(o),yr.cls(""),_r.cls("",(e=>!c.isDisposed()&&!e(c.hasFocus))),r.dom.cls("active_section",c.hasFocus),r.dom.cls("active_section--no-indicator",!d),r.dom.maybe((e=>e(c.viewInstance)),(t=>(0,r.dom)("div.viewsection_title.flexhbox",xr("DragDrop",r.dom.cls("viewsection_drag_indicator"),r.dom.cls("layout_grabbable",(e=>!e(s.isReadonlyKo))),a?null:r.dom.style("visibility","hidden")),r.dom.maybe((e=>e(e(t.viewSection.table).summarySourceTable)),(()=>vr("Pivot",(0,i.testId)("sigma")))),function(e,t,...o){const i=r.Computed.create(null,(t=>t(e.titleDef))),s=r.Computed.create(null,(t=>t(e.description)));return _s(e,i,s,t,r.dom.autoDispose(i),...o)}(c,e,(0,i.testId)("viewsection-title"),br((0,i.testId)("viewsection-blank"))),t.buildTitleControls(),(0,r.dom)("div.viewsection_buttons",r.dom.create(zn,s,c))))),r.dom.create(Sn.B,s,c),r.dom.maybe(c.viewInstance,(e=>[(0,r.dom)("div.view_data_pane_container.flexvbox",Cr.cls("",o),r.dom.maybe(e.disableEditing,(()=>(0,r.dom)("div.disable_viewpane.flexvbox",r.dom.domComputed(u,(e=>e?gr("No row selected in {{title}}",{title:e}):gr("No data")))))),r.dom.maybe(e.isTruncated,(()=>(0,r.dom)("div.viewsection_truncated",gr("Not all data is shown")))),r.dom.cls((e=>"viewsection_type_"+e(c.parentKey))),e.viewPane),r.dom.maybe((e=>!e((0,i.isNarrowScreenObs)())),(()=>{var t;return null==(t=e.selectionSummary)?void 0:t.buildDom()}))])),r.dom.on("mousedown",(()=>{null==l||l.activeSectionId(n)})))}const br=(0,r.styled)("div","\n  min-width: 2px;\n"),vr=(0,r.styled)(s.icon,`\n  bottom: 1px;\n  margin-right: 5px;\n  background-color: ${i.theme.lightText}\n`),yr=(0,r.styled)("div",`\n  @media ${i.mediaSmall} {\n    & {\n      margin: 4px;\n    }\n  }\n`),_r=(0,r.styled)("div",`\n  @media screen and ${i.mediaSmall} {\n    & {\n      overflow: hidden;\n      background: repeating-linear-gradient(\n        -45deg,\n        ${i.theme.widgetInactiveStripesDark},\n        ${i.theme.widgetInactiveStripesDark} 10px,\n        ${i.theme.widgetInactiveStripesLight} 10px,\n        ${i.theme.widgetInactiveStripesLight} 20px\n      );\n      border: 1px solid ${i.theme.widgetBorder};\n      border-radius: 4px;\n      padding: 0 2px;\n    }\n    &::after {\n      content: '';\n      position: absolute;\n      top: 0;\n      left: 0;\n      right: 0;\n      bottom: 0;\n    }\n    &.layout_vbox {\n      max-width: 32px;\n    }\n    &.layout_hbox {\n      max-height: 32px;\n    }\n    & > .viewsection_title.flexhbox {\n      position: absolute;\n    }\n    & > .view_data_pane_container,\n    & .viewsection_buttons,\n    & .grist-single-record__menu,\n    & > .filter_bar {\n      display: none;\n    }\n  }\n`),xr=(0,r.styled)(s.icon,`\n  visibility: hidden;\n  --icon-color: ${i.colors.slate};\n  top: -1px;\n  z-index: 100;\n\n  .viewsection_title:hover &.layout_grabbable {\n    visibility: visible;\n  }\n`),Cr=(0,r.styled)("div","\n  pointer-events: none;\n"),Sr=(0,r.styled)("div.mini_section_container",`\n  --icon-color: ${i.colors.lightGreen};\n  display: flex;\n  align-items: center;\n  padding-right: 8px;\n`),Ir=(0,r.styled)("div.draggable-handle","\n  display: flex;\n  padding: 8px;\n  flex: 1;\n  padding-right: 16px;\n");var Dr=o(21296),Rr=o(28250);class Tr extends Rr.S{create(e,t){super.create(e,t),t.customDef.access.setAndSave(Dr.u.full),this.gristDoc.app.topAppModel.api.getWidgets().then((async e=>{const t=e.find((e=>e.name==this.getWidgetName()));t&&await this.customDef.url.setAndSave(t.url)})).catch((()=>{}))}}var kr=o(18285),Mr=o(87346),Or=o(29255),Ar=o(11527);class Pr{constructor(e,t){this._listeners=new WeakSet,this._emitter=Nt.G.create(e),this.state=r.Observable.create(this,t)}static create(e,t){return new Pr(e,t)}static fromEvents(e,t,o,...i){const s=Pr.create(e,null);for(const e of[o,...i])s._emitter.listenTo(t,e,(e=>s.emit(e)));return s}static compute(e,t){const o=Pr.create(e,null),i=e=>(o._listeners.has(e)||(o._listeners.add(e),o._emitter.listenTo(e._emitter,"signal",(()=>o.emit(t(i))))),e.state.get());return o.state.set(t(i)),o}dispose(){this._emitter.dispose()}autoDispose(e){this._emitter.autoDispose(e)}pipe(e){return this.autoDispose(this.listen((t=>e.emit(t)))),this}map(e){const t=Pr.create(this,e(this.state.get()));return this.listen((o=>{t.emit(e(o))})),t}filter(e){const t=Pr.create(this,this.state.get());return this.listen((o=>{e(o)&&t.emit(o)})),t}distinct(){let e=this.state.get();const t=this.filter((t=>t!==e&&(e=t,!0)));return t.state.set(e),t}flag(){return this.map(Boolean).distinct()}listen(e){const t=()=>{e(this.state.get())};return this._emitter.on("signal",t),{dispose:()=>this._emitter.off("signal",t)}}emit(e){this._beforeHandler?this._beforeHandler(e,(e=>{this.state.set(e),this._emitter.trigger("signal",e)})):(this.state.set(e),this._emitter.trigger("signal",e))}before(e){this._beforeHandler=e}}var Fr=o(97837),Er=o(36812),Br=o.n(Er);const Lr=(0,r.makeTestId)("test-layoutTray-"),$r=(0,Ar.get)("document","window","$");class Ur extends Nt.G{constructor(e){super(),this.viewLayout=e,this.drag=Pr.create(this,null),this.drop=Pr.create(this,null),this.hovering=Pr.create(this,!1),this.over=Pr.compute(this,(e=>Boolean(e(this.drag)&&e(this.hovering)))),this.dragging=Pr.create(this,null),this.layout=Vr.create(this,this),this.active=Pr.create(this,!1);const t=Kr.create(this,this);this.layout.buildLayout(this.viewLayout.viewModel.collapsedSections.peek()),this._registerCommands(),this.drop.before(((e,t)=>{if(t(e),e&&this.drop.state.get()&&this.over.state.get()){const t=e.leafId();this.layout.addBox(t),e.removeFromLayout()}this.drop.state.set(null)}));let o=48;this.autoDispose(t.drag.listen((e=>{var t,i;e&&(o=(null!=(i=null==(t=this._rootElement.parentElement)?void 0:t.getBoundingClientRect().top)?i:61)-13)}))),this.drag.map((e=>e&&this.layout.count.get()>0)).flag().filter(Boolean).pipe(this.active),Pr.compute(this,(e=>{if(!e(t.drag))return!1;const i=e(t.dragMove);return!!(i&&i.clientY<o)})).flag().filter(Boolean).pipe(this.active),this.drag.flag().filter((e=>!e)).pipe(this.active)}replaceLayout(){const e=this.viewLayout.viewModel.collapsedSections.peek();this.viewLayout.viewModel.activeCollapsedSections(e);const t=this.layout.buildLayout(e);return{dispose(){t.forEach((e=>e.dispose())),t.length=0}}}buildPopup(e,t,o){const i=r.Observable.create(e,null);return e.autoDispose(t.addListener(((e,t)=>{var o,s;t&&(null==(o=this.layout.getBox(t))||o.attach()),e&&(null==(s=this.layout.getBox(e))||s.detach()),i.set(e)}))),r.dom.domComputed(i,(e=>e?r.dom.update(wr({gristDoc:this.viewLayout.gristDoc,sectionRowId:e,draggable:!1,focusable:!1})):null))}buildDom(){return this._rootElement=Qr(Lr("editor"),Qr.cls("-is-active",this.active.state),Qr.cls("-is-target",this.over.state),Xr(this.hovering),r.dom.create(zr,this),this.layout.buildDom(),r.dom.show((e=>e(this.layout.count)>0||e(this.active.state))))}buildContentDom(e){return fr({gristDoc:this.viewLayout.gristDoc,sectionRowId:e})}_registerCommands(){const e=this.viewLayout,t={collapseSection:()=>{const t=e.viewModel.activeSectionId();if(!t)return;const o=e.layoutEditor.getBox(t);o&&(e.viewModel.activeSectionId(e.layoutEditor.layout.getAllLeafIds().filter((e=>e!==t))[0]),this.layout.addBox(t),o.dispose(),e.saveLayoutSpec())},expandSection:()=>{const t=e.viewModel.activeCollapsedSectionId();t&&(e.viewModel.activeCollapsedSectionId(0),e.viewModel.activeCollapsedSections(e.viewModel.activeCollapsedSections.peek().filter((e=>e!==t))),e.viewModel.activeSectionId(t),e.saveLayoutSpec())},deleteCollapsedSection:()=>{var t;const o=e.viewModel.activeCollapsedSectionId();if(!o)return;this.viewLayout.removeViewSection(o);const i=e.viewModel.layoutSpecObj(),s=new Set(e.viewModel.viewSections.peek().peek().map((e=>e.id.peek())));s.delete(o),i.collapsed=null==(t=i.collapsed)?void 0:t.filter((e=>"number"==typeof e.leaf&&s.has(e.leaf))),e.saveLayoutSpec(i)}};this.autoDispose(Gt.createGroup(t,this,!0))}}class zr extends r.Disposable{constructor(e){let t;super(),this.model=e,this._animation=r.Observable.create(this,0),this._lastIndex=-1;const o=e.layout;this.autoDispose(e.active.distinct().listen((e=>{e?(t=jr.create(null,this.model),o.addBox(t)):t&&o.destroy(t)})))}buildDom(){const e=r.Observable.create(this,[]);return this._rootElement=Yr(r.dom.maybeOwned(this.model.over.state,(t=>{const o=this._rootElement.getBoundingClientRect(),i=async i=>{var s;if(t.isDisposed()||this._isAnimating())return;if(this._lastTarget&&(null==(s=e.get()[this._lastIndex])?void 0:s.contains(i)))return;e.set(this._calculate(o));const n=e.get().findIndex((e=>null==e?void 0:e.contains(i)));n!==this._lastIndex&&(-1===n?this._removeDropZone().catch((e=>console.error("Failed to remove zone:",e))):this._insertDropTarget(n).catch((e=>console.error("Failed to insert zone:",e))))};return $r.window.addEventListener("mousemove",i),t.onDispose((()=>{this._removeDropZone().catch((e=>console.error("Failed to remove zone:",e)))})),t.onDispose((()=>$r.window.removeEventListener("mousemove",i))),null})))}_start(){this._animation.set(this._animation.get()+1)}_stop(){this._animation.set(this._animation.get()-1)}_isAnimating(){return this._animation.get()>0}_calculate(e){var t;const o=this.model.layout.all(),i=[];let s=12;const n=null==(t=o[0])?void 0:t.rootElement.getBoundingClientRect().height;for(let t=0;t<o.length;t++){const r=o[t],l=o[t-1],a=o[t+1];if(l&&(null==l?void 0:l.rootElement.offsetTop)!==r.rootElement.offsetTop){i.push(null);continue}const d=r.rootElement;if(s=d.offsetTop,0===t&&r instanceof Hr){const t=0,o=d.offsetLeft+50;i.push(new qr(e,{left:t,top:s,right:o,height:n}))}else if(r instanceof Hr&&t===o.length-1){const t=d.offsetLeft+d.offsetWidth-30,o=d.offsetLeft+d.offsetWidth+30;i.push(new qr(e,{left:t,top:s,right:o,height:n}))}else if(r instanceof Hr&&l instanceof Hr){const t=l.rootElement,o=d,r=t.offsetLeft+t.offsetWidth-30,a=o.offsetLeft+30;i.push(new qr(e,{left:r,top:s,right:a,height:n}))}else if(a&&r instanceof Wr&&0===t){const t=0,o=a.rootElement.offsetLeft;i.push(new qr(e,{left:t,top:s,right:o,height:n}))}else if(r instanceof Wr&&l instanceof Hr&&a instanceof Hr){const t=l.rootElement.offsetLeft+l.rootElement.offsetWidth-30,o=a.rootElement.offsetLeft+30;i.push(new qr(e,{left:t,top:s,right:o,height:n}))}}return i}async _insertDropTarget(e){var t;this._start();try{await(null==(t=this._lastTarget)?void 0:t.remove()),this._lastTarget=Wr.create(null,this.model),await this._lastTarget.insert(e),this._lastIndex=e}finally{this._stop()}}async _removeDropZone(){var e;if(this._lastTarget){this._start();try{await(null==(e=this._lastTarget)?void 0:e.remove()),this._lastTarget=void 0,this._lastIndex=-1}finally{this._stop()}}}}class Vr extends r.Disposable{constructor(e){super(),this.model=e,this.holder=Jr.create(this),this._boxes=this.autoDispose((0,r.obsArray)()),this._boxes.addListener((t=>e.viewLayout.viewModel.activeCollapsedSections(this.leafIds()))),this.count=r.Computed.create(this,(e=>e(this._boxes).length))}all(){return this._boxes.get()}buildLayout(e){if(Br()(e,this._boxes.get().map((e=>e.id.get()))))return[];const t=this._boxes.splice(0,this._boxes.get().length,...e.map((e=>Hr.create(this.holder,this.model,e))));return t.forEach((e=>this.holder.release(e))),t}addBox(e,t){null!=t||(t=-1);const o="number"==typeof e?Hr.create(this.holder,this.model,e):e;return"number"!=typeof e&&this.holder.autoDispose(o),this.insert(t,o)}indexOf(e){return this._boxes.get().indexOf(e)}insert(e,t){return this.holder.autoDispose(t),e<0?this._boxes.push(t):this._boxes.splice(e,0,t),t}remove(e){const t=this._boxes.get().indexOf(e);if(t>=0){const e=this._boxes.splice(t,1)[0];return e&&this.holder.release(e),e||null}return null}destroy(e){var t;null==(t=this.remove(e))||t.dispose()}leafIds(){return this._boxes.get().map((e=>e.id.get())).filter((e=>e&&"number"==typeof e))}getBox(e){return this._boxes.get().find((t=>t.id.get()===e))}buildDom(){return this.rootElement=tl(Lr("layout"),(e=>{let t=!1,o=!1,i=null,s=null,n=null,l=null;const a=e=>{switch(e.type){case"mousedown":if(0!==e.button)return;if(i=function(e){var t;if(e instanceof HTMLElement){const o=null==(t=e.closest(".draggable-handle"))?void 0:t.closest(".draggable");return o?r.dom.getData(o,"draggable"):null}return null}(e.target),!i)return;return null==s||s.dispose(),s=new Gr,t=!0,$r.$($r.window).on("mousemove",d),$r.$($r.window).on("mouseup",c),n=e.clientX,l=e.clientY,!1;case"mouseup":if(!i)return;return t=!1,$r.$($r.window).off("mousemove",d),$r.$($r.window).off("mouseup",c),o&&(o=!1,(null==i?void 0:i.drop)&&i.drop(e,s),(null==i?void 0:i.dragEnd)&&i.dragEnd(e,s)),i=null,null==s||s.dispose(),s=null,!1;case"mousemove":if(t&&n&&l&&(Math.abs(e.clientX-n)>3||Math.abs(e.clientY-l)>3)){if(t=!1,(null==i?void 0:i.dragStart)&&(i=i.dragStart(e,s),!i))return;o=!0}if(!o)return;return(null==i?void 0:i.drag)&&i.drag(e,s),s.onMove(e),!1}},d=e=>a(e),c=e=>a(e);r.dom.autoDisposeElem(e,r.dom.onElem($r.window,"mousedown",(e=>a(e)))),r.dom.onDisposeElem(e,(()=>(null==s||s.dispose(),s=null)))}),r.dom.hide((e=>0===e(this._boxes).length)),r.dom.forEach(this._boxes,(e=>e.buildDom())))}}class Nr extends r.Disposable{constructor(){super(...arguments),this.id=r.Observable.create(this,0)}buildDom(){return null}}class jr extends Nr{constructor(e){super(),this.model=e,this.name=r.Observable.create(this,"empty"),this._onHover=Pr.create(this,!1),this.monitorDrop()}monitorDrop(){this.autoDispose(this.model.drop.listen((e=>{if(!e||!this._onHover.state.get())return;this.model.drop.state.set(null);const t=this.model.layout.indexOf(this),o=e.leafId();this.model.layout.addBox(o,t),e.removeFromLayout()})))}buildDom(){return this.rootElement=il(il.cls("-can-accept",this._onHover.state),Xr(this._onHover),Lr("empty-box"))}}class Wr extends jr{buildDom(){this.name.set("target");const e=super.buildDom();return r.dom.update(e,Lr("target-box"),r.dom.cls(sl.className),{style:"width: 2px;"}),e}insert(e){return this.model.layout.insert(e,this),this.rootElement.getBoundingClientRect(),new Promise((e=>{new Fr.T9(this.rootElement).onDispose((()=>{e(void 0)})),this.rootElement.style.width=""}))}remove(){return new Promise((e=>{new Fr.T9(this.rootElement).onDispose((()=>{this.model.layout.destroy(this),e(void 0)})),this.rootElement.style.width="0px"}))}}class Hr extends Nr{constructor(e,t){super(),this.model=e,this._content=r.Observable.create(this,null),this._hiddenViewInstance=r.Observable.create(this,null),this._indexWhenDragged=0,this._detached=!1,this.id.set(t),this._viewInstance=r.Computed.create(this,(e=>{const t=e(e(this.model.viewLayout.viewModel.viewSections).getObservable()).find((t=>e(t.id)===e(this.id)));return t?e(t.viewInstance):null})),this._buildHidden(),this.onDispose((()=>{const e=this._hiddenViewInstance.get();e&&r.dom.domDispose(e)}))}detach(){this._detached=!0}attach(){this._detached=!1;const e=this._hiddenViewInstance.get();this._buildHidden(),e&&r.dom.domDispose(e)}buildDom(){return this._content.set(this.model.buildContentDom(this.id.get())),this.rootElement=ol(Lr("leaf-box"),r.dom.domComputed(this._content,(e=>e)),(this,[r.dom.cls("draggable"),r.dom.data("draggable",this)]),r.dom.on("click",(e=>{this.model.viewLayout.viewModel.activeCollapsedSectionId(this.id.get()),e.target instanceof HTMLElement&&e.target.closest(".draggable-handle")&&((0,Ys.urlState)().pushUrl({hash:{sectionId:this.id.get(),popup:!0}}).catch((()=>{})),e.preventDefault(),e.stopPropagation())})),(e=this._hiddenViewInstance,[r.dom.maybe(e,(e=>e)),r.dom.onDispose((()=>e.get()&&(0,Rt.detachNode)(e.get())))]));var e}dragStart(e,t){const o=this._content.get();this._content.set(null),t.content.set(o);const i=Hr.create(t,this.model,this.id.get());return i._indexWhenDragged=this.model.layout.indexOf(this),this.model.drag.emit(i),this.model.layout.destroy(this),i}dragEnd(e){this.model.drag.emit(null)}drag(e){this.model.dragging.emit(e)}drop(e,t){const o=t.content.get();t.content.set(null),this._content.set(o),this.model.drop.emit(this),0!==this.id.get()&&this.model.layout.addBox(this.id.get(),this._indexWhenDragged)}removeFromLayout(){this.id.set(0),this.model.layout.destroy(this)}leafId(){return this.id.get()}_buildHidden(){this._hiddenViewInstance.set(rl(r.dom.maybe(this._viewInstance,(e=>this._detached?null:e.viewPane))))}}class Gr extends r.Disposable{constructor(){super(),this.content=r.Observable.create(this,null),this.rootElement=this.buildDom(),$r.document.body.appendChild(this.rootElement),this.onDispose((()=>{this.rootElement.remove(),r.dom.domDispose(this.rootElement)}))}buildDom(){return nl(r.dom.show((e=>Boolean(e(this.content)))),r.dom.domComputed(this.content,(e=>e)))}onMove(e){this.content.get()&&(this.rootElement.style.left=`${e.clientX}px`,this.rootElement.style.top=`${e.clientY}px`)}}class Kr extends r.Disposable{constructor(e){super(),this.model=e;const t=()=>this.model.viewLayout.layout.getAllLeafIds().length>1;this.drag=Pr.fromEvents(this,this.model.viewLayout.layoutEditor,"dragStart","dragEnd").filter(t),this._drop=Pr.fromEvents(this,this.model.viewLayout.layoutEditor,"dragDrop").filter(t),this.dragMove=Pr.fromEvents(this,this.model.viewLayout.layoutEditor,"dragMove").filter(t),this.drag.map((e=>e?this:null)).distinct().pipe(this.model.drag),this._drop.map((e=>this)).pipe(this.model.drop),this.autoDispose(e.dragging.listen((t=>{t&&e.drag.state.get()!==this&&this.model.viewLayout.layoutEditor.updateTargets(t)})));const o=Pr.compute(this,(t=>t(e.drag)&&!t(this.drag))).map(Boolean).distinct();this.autoDispose(o.listen((e=>{e?this.model.viewLayout.layoutEditor.triggerUserEditStart():(this.model.viewLayout.layoutEditor.dropTargeter.removeTargetHints(),this.model.viewLayout.layoutEditor.triggerUserEditStop(),this.model.viewLayout.saveLayoutSpec())}))),this.autoDispose(e.drop.listen((e=>{var t;if(!e)return;if(e===this)return;const o=this.model.viewLayout.layoutEditor,i=this.model.viewLayout.layoutEditor.dropTargeter;if((null==i?void 0:i.activeTarget)&&!(null==(t=null==i?void 0:i.activeTarget)?void 0:t.box.isDisposed())){const t=i.activeTarget;i.removeTargetHints();const s=e.leafId(),n=o.layout.buildLayoutBox({leaf:s});e.removeFromLayout(),t.isChild?t.box.addChild(n,t.isAfter):t.box.addSibling(n,t.isAfter),this.model.viewLayout.viewModel.activeSectionId(s),this.model.drop.state.set(null)}}))),this._replaceFloater()}removeFromLayout(){const e=this._drop.state.get();if(!e)return;const t=this.leafId(),o=this.model.viewLayout.layoutEditor.layout.getAllLeafIds().find((e=>"number"==typeof e&&e!==t));this.model.viewLayout.viewModel.activeSectionId(o),this.model.viewLayout.layoutEditor.doRemoveBox(e)}leafId(){var e;return(null==(e=this._drop.state.get())?void 0:e.leafId.peek())||0}_replaceFloater(){const e=this.model,t=Pr.fromEvents(e,e.viewLayout.layoutEditor,"dragStart","dragStop"),o=Pr.compute(e,(o=>Boolean(o(t)&&o(e.over)))).distinct();let i=null,s=null,n=null,l=null;e.autoDispose(o.listen((t=>{if(t){const t=e.viewLayout.layoutEditor.floater,o=t.leafId.peek();if("number"!=typeof o)return;const r=t.leafContent.peek();if(r){i=r,r.style.display="none";const a=Zr(r,fr({gristDoc:e.viewLayout.gristDoc,sectionRowId:o}));t.leafContent(a),s=t.dom.style.transform,n=t.mouseOffsetX,l=t.mouseOffsetY,t.dom.style.transform="none",t.mouseOffsetX=0,t.mouseOffsetY=0}}else if(i){i.style.display="";const t=e.viewLayout.layoutEditor.floater,o=t.leafContent.peek();t.leafContent(i),o&&r.dom.domDispose(o),i=null,t.dom.style.transform=s,t.mouseOffsetX=n,t.mouseOffsetY=l}})))}}class Jr extends r.Disposable{constructor(){super(),this._array=[],this.onDispose((()=>{const e=new Set;for(const t of this._array)e.has(t)||(e.add(t),t.dispose());this._array=[]}))}autoDispose(e){return this._array.push(e),e}release(e){const t=this._array.indexOf(e);return t>=0?this._array.splice(t,1):null}}function Xr(e){return[r.dom.on("mouseenter",(()=>e.emit(!0))),r.dom.on("mouseleave",(()=>e.emit(!1)))]}class qr{constructor(e,t){Object.assign(this,t),this.left+=e.left,this.right+=e.left,this.top+=e.top,this.width=this.right-this.left}contains(e){return e.clientX>=this.left&&e.clientX<=this.right&&e.clientY>=this.top&&e.clientY<=this.top+this.height}}const Yr=(0,r.styled)("div","\n  position: absolute;\n  inset: 0;\n"),Zr=(0,r.styled)("div",`\n  height: 40px;\n  width: 140px;\n  max-width: 140px;\n  background: ${i.theme.tableBodyBg};\n  border: 1px solid ${i.theme.widgetBorder};\n  border-radius: 4px;\n  -webkit-transform: rotate(5deg) scale(0.8) translate(-10px, 0px);\n  transform: rotate(5deg) scale(0.8) translate(-10px, 0px);\n  & .mini_section_container {\n    overflow: hidden;\n    white-space: nowrap;\n  }\n`),Qr=(0,r.styled)("div.collapsed_layout",`\n  display: flex;\n  flex-direction: column;\n  overflow: hidden;\n  transition: height 0.2s;\n  position: relative;\n  margin: calc(-1 * var(--view-content-page-margin, 12px));\n  margin-bottom: 0;\n  user-select: none;\n  background-color: ${i.theme.pageBg};\n  border-bottom: 1px solid ${i.theme.pagePanelsBorder};\n  outline-offset: -1px;\n\n  &-is-active {\n    outline: 2px dashed ${i.theme.widgetBorder};\n  }\n  &-is-target {\n    outline: 2px dashed #7B8CEA;\n    background: rgba(123, 140, 234, 0.1);\n  }\n`),el=(0,r.styled)("div","display: flex"),tl=(0,r.styled)(el,"\n  padding: 8px 24px;\n  column-gap: 16px;\n  row-gap: 8px;\n  flex-wrap: wrap;\n  position: relative;\n"),ol=(0,r.styled)("div",`\n  border: 1px solid ${i.theme.widgetBorder};\n  border-radius: 3px;\n  background: ${i.theme.widgetBg};\n  min-width: 120px;\n  min-height: 34px;\n  cursor: pointer;\n`),il=(0,r.styled)("div",`\n  text-align: center;\n  text-transform: uppercase;\n  color: ${i.theme.widgetBorder};\n  font-weight: bold;\n  letter-spacing: 1px;\n  border: 2px dashed ${i.theme.widgetBorder};\n  border-radius: 3px;\n  padding: 8px;\n  width: 120px;\n  min-height: 34px;\n  &-can-accept {\n    border: 2px dashed #7B8CEA;\n    background: rgba(123, 140, 234, 0.1);\n  }\n`),sl=(0,r.styled)("div","\n  min-width: 0px;\n  padding: 0px;\n  transition: width 0.2s ease-out;\n"),nl=(0,r.styled)(ol,"\n  pointer-events: none;\n  position: absolute;\n  overflow: hidden;\n  pointer-events: none;\n  z-index: 10;\n  -webkit-transform: rotate(5deg) scale(0.8);\n  transform: rotate(5deg) scale(0.8);\n  transform-origin: top left;\n"),rl=((0,r.styled)("div","\n  outline: 1px solid blue;\n  position: absolute;\n  z-index: 10;\n  background: rgba(0, 0, 0, 0.1);\n"),(0,r.styled)("div","display: none;"));var ll=o(96682),al=o(59727),dl=o(54156);const cl={record:fo,detail:kr,chart:Vt.ChartView,single:kr,custom:Rr.S,"custom.calendar":class extends Tr{getWidgetName(){return"Calendar"}}};class ul extends r.Disposable{constructor(e,t){super(),this._instance=r.Holder.create(this),this.onDispose((()=>t.viewInstance(null))),this.autoDispose((0,r.subscribe)((o=>{const i=o(t.table),s=function(e){const t=cl[e];return t||console.error("ViewLayout error: requested an unsupported section type:",e),t||cl.record}(o(t.parentKey));this._instance.clear(),i.getRowId()&&this._instance.autoDispose(s.create(e,t)),t.viewInstance(this._instance.get())})))}}class hl extends Nt.G{constructor(e,t){super(),this.gristDoc=e,this.docModel=this.gristDoc.docModel,this.previousSectionId=0,this.isResizing=r.Observable.create(this,!1),this.layoutSaveDelay=this.autoDispose(new ll.Delay),this._freeze=!1,this._savePending=r.Observable.create(this,!1),this.viewModel=this.docModel.views.getRowModel(t);const o=(0,al.$)(this,this.viewModel.viewSections());this.autoDispose((0,r.computedArray)(o,((t,o,i)=>ul.create(i,e,t)))),this.layoutSpec=this.autoDispose(Mt.computed((()=>this._updateLayoutSpecWithSections(this.viewModel.layoutSpecObj()))).extend({rateLimit:0})),this.layout=this.autoDispose(Mr.Layout.create(this.layoutSpec(),this._buildLeafContent.bind(this),!0)),this.autoDispose(this.layoutSpec.subscribe((e=>this._freeze||this.rebuildLayout(e)))),this.listenTo(this.layout,"layoutUserEditStop",(()=>{this.isResizing.set(!1),this.layoutSaveDelay.schedule(1e3,(()=>{this.saveLayoutSpec()}))})),this.listenTo(this.layout,"layoutUserEditStart",(()=>{this.layoutSaveDelay.cancel(),this._savePending.set(!0),this.isResizing.set(!0)})),this.layoutEditor=this.autoDispose(Or.LayoutEditor.create(this.layout)),this.layoutTray=Ur.create(this,this),this.onDispose((()=>this.layout.dispose())),this.autoDispose(this.gristDoc.resizeEmitter.addListener(this._onResize,this)),this.listenTo(this.gristDoc.app,"clipboard_blur",this._maybeFocusInSection);const s=D()((e=>{if("flex-grow"!==e.propertyName||!(0,i.isNarrowScreen)())return;if(this.viewModel.isDisposed()||!this.viewModel.activeSection)return;const t=this.viewModel.activeSection.peek();if(!t||t.isDisposed())return;const o=t.viewInstance.peek();o&&!o.isDisposed()&&o.onResize()}),0);this.layout.rootElem.addEventListener("transitionend",s);const n=pl.className+"-active",l=pl.className+"-inactive";this.autoDispose((0,r.subscribe)((0,r.fromKo)(this.viewModel.activeSection),((e,t)=>{var o,s;const r=t.getRowId();this.layout.forEachBox((e=>{e.dom.classList.add(l),e.dom.classList.remove(n),e.dom.classList.remove("transition")}));let a=(null==(o=this.layout.getLeafBox(r))?void 0:o.dom)||null;for(;null==a?void 0:a.matches(".layout_box");)a.classList.remove(l),a.classList.add(n),a=a.parentElement;(0,i.isNarrowScreen)()||null==(s=t.viewInstance.peek())||s.onResize()})));const a={deleteSection:()=>{this.removeViewSection(this.viewModel.activeSectionId())},nextSection:()=>{this._otherSection(1)},prevSection:()=>{this._otherSection(-1)},printSection:()=>{(0,Cn.printViewSection)(this.layout,this.viewModel.activeSection()).catch(re.reportError)},sortFilterMenuOpen:e=>{this._openSortFilterMenu(e)},maximizeActiveSection:()=>{this._maximizeActiveSection()},cancel:()=>{this.maximized.get()&&this.maximized.set(null)}};this.autoDispose(Gt.createGroup(a,this,!0)),this.maximized=(0,r.fromKo)(this.layout.maximizedLeaf),this.autoDispose(this.maximized.addListener(((e,t)=>{var o;if(e){const e=this.viewModel.activeSection.peek();!e.isDisposed()&&e.id.peek()&&(null==(o=null==e?void 0:e.viewInstance.peek())||o.onResize())}else this._onResize(),t&&this.viewModel.activeCollapsedSections.peek().includes(t)&&this.previousSectionId&&this.viewModel.viewSections.peek().all().some((e=>!e.isDisposed()&&e.id.peek()===this.previousSectionId))&&this.viewModel.activeSectionId(this.previousSectionId)})))}buildDom(){const e=r.MultiHolder.create(null),t=()=>this.maximized.set(null),o=r.Computed.create(e,(e=>this.layout.getAllLeafIds().includes(e(this.maximized)))),s=r.Computed.create(e,(e=>e(o)?null:e(this.maximized)));return gl(r.dom.autoDispose(e),gl.cls("-active",(e=>!!e(this.maximized))),(0,i.testId)("viewLayout-overlay"),wl(this.layoutTray.buildDom(),ml(ml.cls("-active",(e=>Boolean(e(this.maximized)))),r.dom.update(this.layout.rootElem,r.dom.hide((e=>Boolean(e(s))))),this.layoutTray.buildPopup(e,s,t))),r.dom.maybe((e=>!!e(this.maximized)),(()=>fl("CrossBig",(0,i.testId)("close-button"),r.dom.on("click",(()=>t()))))),r.dom.on("click",((e,o)=>{e.target===o&&this.maximized.get()&&t()})),r.dom.cls("test-viewLayout-save-pending",this._savePending))}async freezeUntil(e){this._freeze=!0;try{return await e}finally{this._freeze=!1,this.rebuildLayout(this.layoutSpec.peek())}}saveLayoutSpec(e){this._savePending.set(!1),this.layoutSaveDelay.cancel(),this.layout&&(this.gristDoc.isReadonly.get()||(e||((e=this.layout.getLayoutSpec()).collapsed=this.viewModel.activeCollapsedSections.peek().map((e=>({leaf:e})))),this.viewModel.layoutSpecObj.setAndSave(e).catch(re.reportError)),this._onResize())}removeViewSection(e){this.maximized.set(null),this.gristDoc.docData.sendAction(["RemoveViewSection",e]).catch(re.reportError)}rebuildLayout(e){const t=this.layoutTray.replaceLayout();this.layout.buildLayout(e,!0),this._onResize(),t.dispose()}_maximizeActiveSection(){const e=this.viewModel.activeSection().getRowId(),t=this.layout.getLeafBox(e);t&&t.maximize()}_buildLeafContent(e){return wr({gristDoc:this.gristDoc,sectionRowId:e,isResizing:this.isResizing,viewModel:this.viewModel})}_updateLayoutSpecWithSections(e){const t=Mr.Layout.create(e,(()=>(0,r.dom)("div")),!0),o=t.getAllLeafIds(),i=this.viewModel.viewSections().all().map((function(e){return e.getRowId()}));dl.difference(o,i).forEach((function(e){var o;null==(o=t.getLeafBox(e))||o.dispose()}));const s=dl.difference(i,o),n=new Set((e.collapsed||[]).map((e=>e.leaf)));return s.forEach((function(e){n.has(e)||function(e){const o=t.buildLayoutBox({leaf:e}),i=t.rootBox().childBoxes.peek(),s=i[i.length-1];i.length>=1&&s.isLeaf()?s.addChild(o,!0):t.rootBox().addChild(o,!0)}(e)})),e=t.getLayoutSpec(),t.dispose(),e}_onResize(){this.viewModel.viewSections().all().forEach((e=>{const t=e.viewInstance.peek();t&&t.onResize()}))}_otherSection(e){const t=this.layout.getAllLeafIds(),o=this.viewModel.activeSectionId.peek(),i=t.indexOf(o),s=(0,P.mod)(i+e,t.length);this.viewModel.activeSectionId(t[s])}_maybeFocusInSection(){const e=this.layout.getContainingBox(document.activeElement);e&&e.leafId&&this.gristDoc.viewModel.activeSectionId(e.leafId.peek())}_openSortFilterMenu(e){var t;const o=null!=e?e:this.viewModel.activeSectionId(),i=null==(t=this.layout.getLeafBox(o))?void 0:t.dom;if(!i)return;const s=i.querySelector(".test-section-menu-sortAndFilter");null==s||s.click()}}const pl=(0,r.styled)("div",`\n  @media screen and ${i.mediaSmall} {\n    &-active, &-inactive {\n      transition: flex-grow var(--grist-layout-animation-duration, 0.4s); // Exposed for tests\n    }\n    &-active > &-inactive,\n    &-active > &-inactive.layout_hbox .layout_hbox,\n    &-active > &-inactive.layout_vbox .layout_vbox {\n      flex: none !important;\n    }\n\n    &-active > &-inactive.layout_hbox.layout_leaf,\n    &-active > &-inactive.layout_hbox .layout_hbox.layout_leaf {\n      height: 40px;\n    }\n\n    &-active > &-inactive.layout_vbox.layout_leaf,\n    &-active > &-inactive.layout_vbox .layout_vbox.layout_leaf {\n      width: 40px;\n    }\n\n    &-inactive.layout_leaf {\n      min-height: 40px;\n      min-width: 40px;\n    }\n  }\n`),ml=(0,r.styled)("div",`\n  display: flex;\n  flex-direction: column;\n  position: relative;\n  flex-grow: 1;\n  @media not print {\n    &-active {\n      background: ${i.theme.mainPanelBg};\n      height: 100%;\n      width: 100%;\n      border-radius: 5px;\n      border-bottom-left-radius: 0px;\n      border-bottom-right-radius: 0px;\n      position: relative;\n    }\n    &-active .viewsection_content {\n      margin: 0px;\n      margin-top: 12px;\n    }\n    &-active .viewsection_title {\n      padding: 0px 12px;\n    }\n    &-active .filter_bar {\n      margin-left: 6px;\n    }\n  }\n`),gl=(0,r.styled)("div",`\n  height: 100%;\n  @media screen {\n    &-active {\n      background-color: ${i.theme.modalBackdrop};\n      inset: 0px;\n      height: 100%;\n      width: 100%;\n      padding: 20px 56px 20px 56px;\n      position: absolute;\n    }\n    &-active .collapsed_layout {\n      display: none !important;\n    }\n  }\n  @media screen and ${i.mediaSmall} {\n    &-active {\n      padding: 22px;\n      padding-top: 30px;\n    }\n  }\n`),fl=(0,r.styled)(s.icon,`\n  position: absolute;\n  top: 16px;\n  right: 16px;\n  height: 24px;\n  width: 24px;\n  cursor: pointer;\n  --icon-color: ${i.theme.modalBackdropCloseButtonFg};\n  &:hover {\n    --icon-color: ${i.theme.modalBackdropCloseButtonHoverFg};\n  }\n  @media ${i.mediaSmall} {\n    & {\n      top: 6px;\n      right: 6px;\n    }\n  }\n`),wl=(0,r.styled)("div","\n  height: 100%;\n  display: flex;\n  flex-direction: column;\n"),bl=(0,r.makeTestId)("test-raw-data-");class vl extends r.Disposable{constructor(e){super(),this._gristDoc=e;const t={printSection:()=>{(0,Cn.printViewSection)(null,this._gristDoc.viewModel.activeSection()).catch(re.reportError)}};this.autoDispose(Gt.createGroup(t,this,!0)),this._lightboxVisible=r.Computed.create(this,(e=>{const t=e(this._gristDoc.viewModel.activeSection);return Boolean(e(t.id))&&e(t.isRaw)}));const o=this._gristDoc.docModel.views.rowModels.find((e=>void 0===e.id.peek()));this.autoDispose(this._gristDoc.activeViewId.addListener((()=>{null==o||o.activeSectionId(0)}))),this.autoDispose(this._lightboxVisible.addListener((e=>{e||this._gristDoc.cursorMonitor.clear()})))}buildDom(){return _l(xl((0,r.dom)("div",this._gristDoc.behavioralPromptsManager.attachTip("rawDataPage",{hideArrow:!0})),(0,r.dom)("div",r.dom.create(Ts,this._gristDoc),r.dom.create(nn,this._gristDoc.docPageModel)),r.dom.hide(this._lightboxVisible)),r.dom.domComputed((0,r.fromKo)(this._gristDoc.viewModel.activeSection),(e=>e.getRowId()&&e.isRaw.peek()?r.dom.create(yl,this._gristDoc,e,(()=>this._close())):null)))}_close(){this._gristDoc.viewModel.activeSectionId(0)}}class yl extends r.Disposable{constructor(e,t,o){super(),this._gristDoc=e,this._viewSection=t,this._onClose=o;const i={cancel:()=>{this._onClose()},deleteSection:()=>{if(this._viewSection.isRaw.peek())throw new Error("Can't delete a raw section");this._gristDoc.docData.sendAction(["RemoveViewSection",this._viewSection.id.peek()]).catch(re.reportError)}};this.autoDispose(Gt.createGroup(i,this,!0))}buildDom(){return ul.create(this,this._gristDoc,this._viewSection),Cl(bl("overlay"),Sl(wr({gristDoc:this._gristDoc,sectionRowId:this._viewSection.getRowId(),draggable:!1,focusable:!1,widgetNameHidden:this._viewSection.isRaw.peek()})),Il("CrossBig",bl("close-button"),r.dom.on("click",(()=>this._onClose()))),r.dom.on("click",((e,t)=>{e.target===t&&this._onClose()})))}}const _l=(0,r.styled)("div","\n  height: 100%;\n  overflow: hidden;\n  position: relative;\n"),xl=(0,r.styled)("div",`\n  overflow-y: auto;\n  height: 100%;\n  padding: 32px 64px 24px 64px;\n  @media ${i.mediaSmall} {\n    & {\n      padding: 32px 24px 24px 24px;\n    }\n  }\n`),Cl=(0,r.styled)("div",`\n  background-color: ${i.theme.modalBackdrop};\n  inset: 0px;\n  height: 100%;\n  width: 100%;\n  padding: 20px 56px 20px 56px;\n  position: absolute;\n  @media ${i.mediaSmall} {\n    & {\n      padding: 22px;\n      padding-top: 30px;\n    }\n  }\n`),Sl=(0,r.styled)("div",`\n  background: ${i.theme.mainPanelBg};\n  height: 100%;\n  display: flex;\n  flex-direction: column;\n  border-radius: 5px;\n  border-bottom-left-radius: 0px;\n  border-bottom-right-radius: 0px;\n  & .viewsection_content {\n    margin: 0px;\n    margin-top: 12px;\n  }\n  & .viewsection_title {\n    padding: 0px 12px;\n  }\n  & .filter_bar {\n    margin-left: 6px;\n  }\n`),Il=(0,r.styled)(s.icon,`\n  position: absolute;\n  top: 16px;\n  right: 16px;\n  height: 24px;\n  width: 24px;\n  cursor: pointer;\n  --icon-color: ${i.theme.modalBackdropCloseButtonFg};\n  &:hover {\n    --icon-color: ${i.theme.modalBackdropCloseButtonHoverFg};\n  }\n  @media ${i.mediaSmall} {\n    & {\n      top: 6px;\n      right: 6px;\n    }\n  }\n`),Dl=o(91944);class Rl extends Dt.Disposable{constructor(){super(...arguments),this._undoChain=new P.PromiseChain}create(e,t){this._gristDoc=t.gristDoc,this.isDisabled=r.Observable.create(this,!1),this._stack=[],this._pointer=0,this._linkMap=new Map,this.undoDisabledObs=Mt.observable(!0),this.redoDisabledObs=Mt.observable(!0),this._gristDoc.docPageModel&&this._gristDoc.docPageModel.undoState.set({isUndoDisabled:(0,r.fromKo)(this.undoDisabledObs),isRedoDisabled:(0,r.fromKo)(this.redoDisabledObs)}),e.forEach((e=>{this.pushAction(e)}))}pushAction(e){if(!e.fromSelf)return;const t=e.otherId?this._stack.findIndex((t=>t.actionNum===e.otherId)):-1;e.linkId?(0,P.setDefault)(this._linkMap,e.linkId,[]).push(e):t>-1?this._pointer=e.isUndo?t:t+1:(this.redoDisabledObs()||this._stack.splice(this._pointer),e.otherId||this._stack.push(e),this._pointer=this._stack.length),this.undoDisabledObs(this._pointer<=0),this.redoDisabledObs(this._pointer>=this._stack.length)}async sendUndoAction(){if(!this.isDisabled.get())return this._undoChain.add((()=>this._sendAction(!0)))}async sendRedoAction(){if(!this.isDisabled.get())return this._undoChain.add((()=>this._sendAction(!1)))}enable(){this.isDisabled.set(!1)}disable(){this.isDisabled.set(!0)}async _sendAction(e){const t=this._stack[e?this._pointer-1:this._pointer];if(t)try{const o=this._findActionBundle(t);this._gristDoc.moveToCursorPos(t.cursorPos,t).catch((()=>{})),1===o.length&&o[0].op?await o[0].op(o[0],e):await this._gristDoc.docComm.applyUserActionsById(o.map((e=>e.actionNum)),o.map((e=>e.actionHash)),e,{otherId:t.actionNum}),this._gristDoc.moveToCursorPos(t.cursorPos,t).catch((()=>{}))}catch(t){throw t.message=`Failed to apply ${e?"undo":"redo"} action: ${t.message}`,t}}_findActionBundle(e){const t=new Set,o=[],i=[e];for(;i.length&&(e=i.pop(),!t.has(e.actionNum));)o.push(e),t.add(e.actionNum),i.push(...this._linkMap.get(e.actionNum)||[]);return Dl(o,(e=>e.actionNum))}}var Tl=o(42064),kl=o(55688),Ml=o(45353);class Ol{constructor(e,t,o,i){this._untrustedContentOrigin=t,this._docComm=o,this._clientScope=i,this.pluginsList=[];for(const t of e)try{const e=new kl.dl(t,(0,kl.GO)(console,`PLUGIN ${t.id}:`)),o=t.manifest.components||{},i=e.safeBrowser=new Tl.u0(e,this._clientScope,this._untrustedContentOrigin,o.safeBrowser);o.safeBrowser&&e.rpc.registerForwarder(o.safeBrowser,i),e.rpc.registerForwarder("*",{forwardCall:e=>this._docComm.forwardPluginRpc(t.id,e),forwardMessage:e=>this._docComm.forwardPluginRpc(t.id,e)}),this.pluginsList.push(e)}catch(e){console.error(`DocPluginManager: failed to instantiate ${t.id}: ${e.message}`)}}receiveAction(e){for(const t of this.pluginsList){const o=t.safeBrowser;o&&o.receiveAction(e)}}makeAnonForwarder(){const e=new Ml.Rpc({});return e.queueOutgoingUntilReadyMessage(),e.registerForwarder("*",{forwardCall:e=>this._docComm.forwardPluginRpc("builtIn/core",e),forwardMessage:e=>this._docComm.forwardPluginRpc("builtIn/core",e)}),e}}var Al=o(98279),Pl=o(56209),Fl=o(89971),El=o(11104);class Bl{constructor(e){this._tableData=e,this._cachedColIndexes=new Map,this._tableData.tableActionEmitter.addListener(this._invalidateCache,this),this._tableData.dataLoadedEmitter.addListener(this._clearCache,this)}getValue(e,t){return(0,P.getSetMapValue)(this._cachedColIndexes,e,t)}_invalidateCache(e){if((0,pe.vo)(e)||(0,pe.L6)(e)){const t=e[3];for(const e of Object.keys(t))this._cachedColIndexes.delete(e)}else this._clearCache()}_clearCache(){this._cachedColIndexes.clear()}}class Ll{constructor(e){this._tableData=e,this._columnCache=new Bl(this._tableData)}getColACIndex(e,t){return this._columnCache.getValue(e,(()=>this._buildColACIndex(e,t)))}_buildColACIndex(e,t){const o=this._tableData.getRowIds(),i=this._tableData.getColValues(e);if(!i)throw new re.UserError(`Invalid column ${this._tableData.tableId}.${e}`);const s=i.map(((e,i)=>{const s=o[i],n=t.formatAny(e);return{rowId:s,text:n,cleanText:(0,El.normalizeText)(n)}}));return s.sort($l),new El.ACIndexImpl(s)}}function $l(e,t){return(0,P.localeCompare)(e.cleanText,t.cleanText)||(0,P.localeCompare)(e.text,t.text)||(0,P.nativeCompare)(e.rowId,t.rowId)}var Ul=o(6212);class zl extends Ul.C{constructor(e,t,o,i){super(t,o,i),this.docData=e,this.tableActionEmitter=new r.Emitter,this.dataLoadedEmitter=new r.Emitter,this.columnACIndexes=new Ll(this),this._columnErrorCounts=new Bl(this)}loadData(e){const t=super.loadData(e);return this.dataLoadedEmitter&&this.dataLoadedEmitter.emit(t,this.getRowIds()),t}loadPartial(e){super.loadPartial(e),this.dataLoadedEmitter.emit([],e[2])}unloadPartial(e){super.unloadPartial(e),this.dataLoadedEmitter.emit(e,[])}countErrors(e){return this._columnErrorCounts.getValue(e,(()=>{const t=this.getColValues(e);return t&&(0,P.countIf)(t,ge.isRaisedException)}))}sendTableActions(e,t){return e.forEach((e=>e.splice(1,0,this.tableId))),this.docData.sendActions(e,t)}sendTableAction(e,t){if(e)return e.splice(1,0,this.tableId),this.docData.sendAction(e,t)}receiveAction(e){const t=super.receiveAction(e);return t&&this.tableActionEmitter.emit(e),t}}var Vl=o(33485),Nl=o(74392);const jl=o(52906),Wl=window.gristNotify;class Hl extends Vl.a{constructor(e,t){super((t=>e.fetchTable(t)),t),this.docComm=e,this.sendActionsEmitter=new r.Emitter,this.sendActionsDoneEmitter=new r.Emitter,this._bundlesPending=0,this._nextDesc=null,this._lastActionNum=null,this._bundleSender=new Gl(this.docComm),this._virtualTablesFunc=new Map}createTableData(e,t,o){var i;return new((null==(i=this._virtualTablesFunc)?void 0:i.get(e))||zl)(this,e,t,o)}getTable(e){return super.getTable(e)}getMetaTable(e){return super.getMetaTable(e)}async findColFromValues(e,t,o){try{return await this.docComm.findColFromValues(e,t,o)}catch(e){return Wl(`Error finding matching columns: ${e.message}`),[]}}getFormulaError(e,t,o){return this.docComm.getFormulaError(e,t,o)}startBundlingActions(e){if(this._bundlesPending>=2)throw new Error("Too many actions already pending");let t;this._bundlesPending++;const o=new Promise((e=>{t=e}));let i;const s=new Promise((e=>{i=e})),n=this._lastBundlePromise=(async()=>{var n;this._lastBundlePromise&&(null==(n=this._triggerBundleFinalize)||n.call(this),await this._lastBundlePromise);try{this._nextDesc=e.description,this._lastActionNum=null,this._triggerBundleFinalize=i,t(e.prepare()),this._shouldIncludeInBundle=e.shouldIncludeInBundle,await Promise.all([s,o]),this._shouldIncludeInBundle=void 0,await e.finalize()}finally{this._shouldIncludeInBundle=void 0,this._triggerBundleFinalize=void 0,this._bundlesPending--,0===this._bundlesPending&&(this._lastBundlePromise=void 0)}})();return{preparePromise:o,triggerFinalize:i,completionPromise:n}}async bundleActions(e,t,o={}){if(o.nestInActiveBundle&&this._bundlesPending)return await t();const i=this.startBundlingActions({description:e,shouldIncludeInBundle:()=>!0,prepare:t,finalize:async()=>{}});try{return await i.preparePromise}finally{i.triggerFinalize(),await i.completionPromise}}sendActions(e,t){return Nl.Promise.resolve(this._sendActionsImpl(e,t))}sendAction(e,t){return this.sendActions([e],t).then((e=>e[0]))}registerVirtualTable(e,t){this._virtualTablesFunc.set(e,t)}async _sendActionsImpl(e,t){var o,i,s;const n=String(null==(o=e[0])?void 0:o[1]);if(null==(i=this._virtualTablesFunc)?void 0:i.has(n)){for(const t of e){if(!(0,pe.q$)(t))throw new Error("virtual table received an action it cannot handle");if((0,pe.A0)(t)!==n)throw new Error("virtual table actions mixed with other actions")}const o=e.map((e=>[e[0],...e.slice(2)]));return this.getTable(n).sendTableActions(o,t)}const r={actions:e};this.sendActionsEmitter.emit(r);const l={desc:t};this._shouldIncludeInBundle&&!this._shouldIncludeInBundle(e)&&(null==(s=this._triggerBundleFinalize)||s.call(this),await this._lastBundlePromise),this._bundlesPending&&(jl(l,{desc:this._nextDesc,linkId:this._lastActionNum}),this._nextDesc=null);const a=await this._bundleSender.applyUserActions(e,l);return this._lastActionNum=a.actionNum,this.sendActionsDoneEmitter.emit(r),a.retValues}}class Gl{constructor(e){this._docComm=e,this._options={},this._actions=[]}applyUserActions(e,t){jl(this._options,t);const o=this._actions.length;this._actions.push(...e);const i=this._actions.length;return this._getSendPromise().then((e=>({actionNum:e.actionNum,retValues:e.retValues.slice(o,i),isModification:e.isModification})))}_getSendPromise(){return this._sendPromise||(this._sendPromise=Promise.resolve().then((()=>{this._sendPromise=void 0;const e=this._docComm.applyUserActions(this._actions,this._options);return this._options={},this._actions=[],e}))),this._sendPromise}}var Kl=o(28082),Jl=o.n(Kl),Xl=o(33620),ql=o(41367),Yl=o.n(ql),Zl=o(10832),Ql=o.n(Zl),ea=o(3871),ta=o(33444),oa=o(90744);function ia(e){}var sa=o(76961),na=o(32529),ra=o(11486),la=o(48807),aa=o(2877);function da(e){this.table=ad(e.tables,this.parentId),this.widgetOptionsJson=(0,na.jsonObservable)(this.widgetOptions),this.viewFields=ld(this,e.viewFields,"colRef"),this.summarySource=ad(e.columns,this.summarySourceCol),this.cells=ld(this,e.cells,"colRef"),this.isEmpty=Mt.pureComputed((()=>this.isFormula()&&""===this.formula())),this.isRealFormula=Mt.pureComputed((()=>this.isFormula()&&""!==this.formula())),this.hasTriggerFormula=Mt.pureComputed((()=>!this.isFormula()&&""!==this.formula())),this.origColRef=Mt.observable(this.getRowId()),this.origCol=ad(e.columns,this.origColRef),this.isTransforming=Mt.observable(!1),this.pureType=Mt.pureComputed((()=>ge.extractTypeFromColType(this.type()))),this._displayColModel=ad(e.columns,this.displayCol),this.saveDisplayFormula=function(t){if(t!==(this._displayColModel().formula()||""))return e.docData.sendAction(["SetDisplayFormula",this.table().tableId(),null,this.getRowId(),t])},this.displayColRef=Mt.pureComputed((()=>this.displayCol()||this.origColRef())),this.displayColModel=ad(e.columns,this.displayColRef),this.visibleColModel=ad(e.columns,this.visibleCol),this.disableModifyBase=Mt.pureComputed((()=>Boolean(this.summarySourceCol()))),this.disableModify=Mt.pureComputed((()=>this.disableModifyBase()||this.isTransforming())),this.disableEditData=Mt.pureComputed((()=>Boolean(this.summarySourceCol()))),this.isHiddenCol=Mt.pureComputed((()=>ge.isHiddenCol(this.colId()))),this.refTable=Mt.pureComputed((()=>{const t=(0,ge.getReferencedTableId)(this.type()||"");return t&&e.visibleTables.all().find((e=>e.tableId()===t))||null})),this.visibleColFormatter=Mt.pureComputed((()=>ca(this,this,e,"vcol"))),this.formatter=Mt.pureComputed((()=>ca(this,this,e,"full"))),this.createValueParser=function(){const t=(0,la.jo)(e.docData,this.id.peek());return t.cleanParse.bind(t)},this.behavior=Mt.pureComputed((()=>this.isEmpty()?"empty":this.isFormula()?"formula":"data")),this.chatHistory=this.autoDispose(Mt.computed((()=>{var e;const t=`formula-assistant-history-v2-${null!=(e=(0,Ys.urlState)().state.get().doc)?e:""}-${this.table().tableId()}-${this.colId()}`;return(0,sa.sA)(t,{messages:[],conversationId:(0,aa.v4)()})})))}function ca(e,t,o,i){const s=e.visibleColModel();return("full"===i?ra.EF:ra.ku)({docData:o.docData,type:t.type(),widgetOpts:e.widgetOptionsJson(),visibleColType:null==s?void 0:s.type(),visibleColWidgetOpts:null==s?void 0:s.widgetOptionsJson(),docSettings:o.docInfoRow.documentSettingsJson()})}function ua(e){this.documentSettingsJson=(0,na.jsonObservable)(this.documentSettings),this.defaultViewId=this.autoDispose(Mt.pureComputed((()=>{const t=e.allTabs.at(0);return t?t.viewRef():0}))),this.newDefaultViewId=this.autoDispose(Mt.pureComputed((()=>{const t=e.visibleDocPages()[0];return t?t.viewRef():0})))}function ha(e){this.viewSection=ad(e.viewSections,this.viewSectionRef),this.column=ad(e.columns,this.colRef),this.activeFilter=na.customComputed({read:()=>{const e=this.filter();return"null"===e?"":e}})}function pa(e){this.view=ad(e.views,this.viewRef),this.isCensored=Mt.pureComputed((()=>!this.view().name())),this.isSpecial=Mt.pureComputed((()=>{const t=this.view().name();return"GristDocTour"===t&&!e.showDocTourTable||"GristDocTutorial"===t&&!e.showDocTutorialTable||(()=>{var t;const o=this.view().id(),i=e.rawDataTables.all().find((e=>e.primaryViewId()===o));return!!i&&(null==(t=i.tableId())?void 0:t.startsWith("GristHidden_"))})()})),this.isHidden=Mt.pureComputed((()=>this.isCensored()||this.isSpecial()))}function ma(e){this.view=ad(e.views,this.viewRef)}var ga=o(90771),fa=o.n(ga);function wa(e){this.columns=ld(this,e.columns,"parentId",{sortBy:"parentPos"}),this.validations=ld(this,e.validations,"tableRef"),this.primaryView=ad(e.views,this.primaryViewId),this.rawViewSection=ad(e.viewSections,this.rawViewSectionRef),this.summarySource=ad(e.tables,this.summarySourceTable),this.isHidden=this.autoDispose(Mt.pureComputed((()=>!this.tableId()||!!this.summarySourceTable()||this.tableId().startsWith("GristHidden_")))),this.summarySourceColRefs=this.autoDispose(Mt.pureComputed((()=>new Set(this.columns().all().map((e=>e.summarySourceCol())).filter((e=>e)))))),this.primaryTableId=Mt.pureComputed((()=>this.summarySourceTable()?this.summarySource().tableId():this.tableId())),this.groupByColumns=Mt.pureComputed((()=>this.columns().all().filter((e=>e.summarySourceCol())))),this.groupDesc=Mt.pureComputed((()=>this.summarySourceTable()?(0,he.YG)(this.groupByColumns().map((e=>e.label()))):"")),this.tableColor=fa()({luminosity:"light",seed:"number"==typeof this.id()?5*this.id():this.id()}),this.disableAddRemoveRows=Mt.pureComputed((()=>Boolean(this.summarySourceTable()))),this.supportsManualSort=Mt.pureComputed((()=>this.columns().all().some((e=>e.colId()===ge.MANUALSORT)))),this.tableName=na.savingComputed({read:()=>this.isDisposed()?"":this.summarySourceTable()?this.summarySource().rawViewSection().title():this.rawViewSection().isDisposed()?"":this.rawViewSection().title(),write:(e,t)=>{this.summarySourceTable()?e(this.summarySource().rawViewSection().title,t):e(this.rawViewSection().title,t)}}),this.tableNameDef=na.fieldWithDefault(this.tableName,Mt.computed((()=>this.isDisposed()?"":(this.summarySourceTable()?this.summarySource():this).tableId()||""))),this.formattedTableName=Mt.pureComputed((()=>this.summarySourceTable()?`${this.tableNameDef()} ${this.groupDesc()}`:this.tableNameDef()))}function ba(e){}async function va(e,t,o){var i,s;const n=t.rulesCols.peek()[o];if(!n)throw new Error(`There is no rule at index ${o}`);const r=null!=(s=null==(i=t.rulesStyles.peek())?void 0:i.slice())?s:[];r.length>=o?r.splice(o,1):console.debug(`There are not style options at index ${o}`),await e.docData.bundleActions("Remove conditional rule",(()=>Promise.all([t.rulesStyles.setAndSave(r),e.docData.sendAction(["RemoveColumn",t.tableId.peek(),n.colId.peek()])])))}var ya=o(49142),_a=o(27973),xa=o.n(_a),Ca=o(80687),Sa=o.n(Ca),Ia=Object.defineProperty,Da=Object.getOwnPropertySymbols,Ra=Object.prototype.hasOwnProperty,Ta=Object.prototype.propertyIsEnumerable,ka=(e,t,o)=>t in e?Ia(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,Ma=(e,t)=>{for(var o in t||(t={}))Ra.call(t,o)&&ka(e,o,t[o]);if(Da)for(var o of Da(t))Ta.call(t,o)&&ka(e,o,t[o]);return e};class Oa{constructor(e,t){this._field=e,this._docModel=t;const o=e;this.fields=o.autoDispose(Mt.pureComputed((()=>{const t=this._field.viewSection().selectedFields();return t&&t.length?t.filter((e=>!e.isDisposed()&&!e.column().isDisposed())):[e]}))),this.multiselect=o.autoDispose(Mt.pureComputed((()=>this.fields().length>1))),this.sameWidgets=o.autoDispose(Mt.pureComputed((()=>{var e;const t=this.fields();if(t.length<=1)return!0;const o=t.map((e=>{var t,o;return Object.keys(null!=(o=null==(t=ya.UD[e.column().pureType()])?void 0:t.widgets)?o:{})}));return xa()(...o).length===(null==(e=o[0])?void 0:e.length)}))),this.widget=o.autoDispose(Mt.pureComputed({read:()=>{if(!this.multiselect())return this._field.widget();const e=this.fields().map((e=>e.widget()));return Aa(e)?e[0]:void 0},write:e=>{for(const t of this.fields.peek()){const o=t.widgetOptionsJson.peek();t.widgetOptionsJson.setAndSave({widget:e,fillColor:o.fillColor,textColor:o.textColor}).catch(reportError)}}}));const i=o.autoDispose(Mt.pureComputed((()=>{var e,t;const o=this.fields();let i=null;for(const s of o){const o=s.widget()||"",n=null==(t=null==(e=ya.UD[s.column().pureType()])?void 0:e.widgets[o])?void 0:t.options;if(n)if(i){const e=new Set(Object.keys(n));for(const t of i)e.has(t)||i.delete(t)}else i=new Set(Object.keys(n))}return null!=i?i:new Set}))),s=na.savingComputed({read:()=>{var e;if(!this.multiselect())return this._field.widgetOptionsJson();const t={},o=this.fields().map((e=>e.widgetOptionsJson())),s=i();for(const i of s)t[i]=null,Aa(o.map((e=>e[i])))&&(t[i]=null!=(e=o[0][i])?e:null);return t},write:(e,t)=>{if(!this.multiselect.peek())return e(this._field.widgetOptionsJson,t);t=Ma({},t);for(const e of Object.keys(t))null===t[e]&&delete t[e];for(const o of this.fields.peek()){const i=o.widgetOptionsJson.peek();e(o.widgetOptionsJson,Ma(Ma({},i),t))}}});this.options=o.autoDispose(Fa(na.objObservable(s),{disabled:e=>Mt.pureComputed((()=>!i().has(e))),mixed:e=>Mt.pureComputed((()=>!Aa(this.fields().map((t=>t.widgetOptionsJson.prop(e)()))))),empty:e=>Mt.pureComputed((()=>Pa(this.fields().map((t=>t.widgetOptionsJson.prop(e)())))))})),this.wrap=na.fieldWithDefault(this.options.prop("wrap"),(()=>"record"!==this._field.viewSection().parentKey())),this.alignment=this.options.prop("alignment"),this.style=Mt.pureComputed((()=>{const e=this.fields(),t=e.length>1,o=na.savingComputed({read:()=>{var o;if(!t)return this._field.widgetOptionsJson();const i={},s=e.map((e=>e.widgetOptionsJson()));for(const e of["textColor","fillColor","fontBold","fontItalic","fontUnderline","fontStrikethrough"])i[e]=null,Aa(s.map((t=>t[e])))&&(i[e]=null!=(o=s[0][e])?o:null);return i},write:(o,i)=>{if(!t)return o(this._field.widgetOptionsJson,i);i=Ma({},i);for(const e of Object.keys(i))null===i[e]&&delete i[e];for(const t of e){const e=t.widgetOptionsJson.peek();o(t.widgetOptionsJson,Ma(Ma({},e),i))}}}),i=e.map((e=>e.style.peek())),s=Fa(na.objObservable(o),{mixed:t=>Mt.pureComputed((()=>!Aa(e.map((e=>e.widgetOptionsJson.prop(t)()))))),empty:t=>Mt.pureComputed((()=>Pa(e.map((e=>e.widgetOptionsJson.prop(t)())))))});return s.revert=()=>{Sa()(e,i).forEach((([e,t])=>e.style(t)))},s})),this.headerStyle=Mt.pureComputed((()=>{const e=this.fields(),t=e.length>1,o=na.savingComputed({read:()=>{var o;if(!t)return this._field.widgetOptionsJson();const i={},s=e.map((e=>e.widgetOptionsJson()));for(const e of["headerTextColor","headerFillColor","headerFontBold","headerFontItalic","headerFontUnderline","headerFontStrikethrough"])i[e]=null,Aa(s.map((t=>t[e])))&&(i[e]=null!=(o=s[0][e])?o:null);return i},write:(o,i)=>{if(!t)return o(this._field.widgetOptionsJson,i);i=Ma({},i);for(const e of Object.keys(i))null===i[e]&&delete i[e];for(const t of e){const e=t.widgetOptionsJson.peek();o(t.widgetOptionsJson,Ma(Ma({},e),i))}}}),i=e.map((e=>e.headerStyle.peek())),s=Fa(na.objObservable(o),{mixed:t=>Mt.pureComputed((()=>!Aa(e.map((e=>e.widgetOptionsJson.prop(t)()))))),empty:t=>Mt.pureComputed((()=>Pa(e.map((e=>e.widgetOptionsJson.prop(t)())))))});return s.revert=()=>{Sa()(e,i).forEach((([e,t])=>e.headerStyle(t)))},s}))}async updateChoices(e,t){const o=!!Object.entries(e).length,i=this._field.column.peek().table.peek().tableId.peek();if(this.multiselect.peek()){this._field.config.options.update(t);const s=this.fields.peek().map((e=>e.colId.peek()));return this._docModel.docData.bundleActions("Update choices configuration",(()=>Promise.all([this._field.config.options.save(),o?this._docModel.docData.sendActions(s.map((t=>["RenameChoices",i,t,e]))):null])))}{const s=this._field.column.peek(),n={nestInActiveBundle:s.isTransforming.peek()};return this._field.widgetOptionsJson.update(t),this._docModel.docData.bundleActions("Update choices configuration",(()=>Promise.all([this._field.widgetOptionsJson.save(),o?this._docModel.docData.sendAction(["RenameChoices",i,s.colId.peek(),e]):null])),n)}}}function Aa(e){if(e.length<=1)return!0;const t=(0,P.ifNotSet)(e[0],null),o=e.every((e=>Br()((0,P.ifNotSet)(e,null),t)));return o}function Pa(e){return 0===e.length||e.every((e=>null===(0,P.ifNotSet)(e,null)))}function Fa(e,t){const o=e;for(const e of Object.keys(t)){const i=`__${e}`;o[i]=new Map,o[e]=s=>(o[i].has(s)||o[i].set(s,t[e](s)),o[i].get(s))}return o}function Ea(e){this.viewSection=ad(e.viewSections,this.parentId),this.widthDef=na.fieldWithDefault(this.width,(()=>this.viewSection().defaultWidth())),this.widthPx=Mt.pureComputed((()=>this.widthDef()+"px")),this.column=ad(e.columns,this.colRef),this.origCol=Mt.pureComputed((()=>this.column().origCol())),this.colId=Mt.pureComputed((()=>this.column().colId())),this.label=Mt.pureComputed((()=>this.column().label())),this.description=na.savingComputed({read:()=>this.column().description(),write:(e,t)=>e(this.column().description,t)}),this.displayLabel=na.savingComputed({read:()=>e.editingFormula()?"$"+this.origCol().colId():this.origCol().label(),write:(e,t)=>e(this.column().label,t)});const t=Mt.observable(!1);this.editingFormula=Mt.pureComputed({read:()=>t(),write:o=>{e.editingFormula(o),t(o)}}),this.formulaCssClass=Mt.pureComputed((()=>{const e=this.column();return e.isTransforming()?e.origCol().isFormula()&&""!==e.origCol().formula()?"transform_field formula_field":"transform_field":this.editingFormula()?"formula_field_edit":e.isFormula()&&""!==e.formula()?"formula_field":null})),this._displayColModel=ad(e.columns,this.displayCol),this.saveDisplayFormula=function(t){if(t!==(this._displayColModel().formula()||""))return e.docData.sendAction(["SetDisplayFormula",this.column().table().tableId(),this.getRowId(),null,t])},this.useColOptions=this.autoDispose(Mt.pureComputed((()=>!this.widgetOptions()||this.column().isTransforming()))),this._fieldOrColumn=this.autoDispose(Mt.pureComputed((()=>this.useColOptions()?this.column():this))),this.displayColRef=this.autoDispose(Mt.pureComputed((()=>this._fieldOrColumn().displayCol()||this.colRef()))),this.visibleColRef=na.addSaveInterface(Mt.pureComputed({read:()=>this._fieldOrColumn().visibleCol(),write:e=>this._fieldOrColumn().visibleCol(e)}),(t=>e.docData.bundleActions(null,(async()=>{const o=e.columns.getRowModel(t);await Promise.all([this._fieldOrColumn().visibleCol.saveOnly(t),this._fieldOrColumn().saveDisplayFormula(t?`$${this.colId()}.${o.colId()}`:"")])}),{nestInActiveBundle:this.column.peek().isTransforming.peek()}))),this.displayColModel=ad(e.columns,this.displayColRef),this.visibleColModel=ad(e.columns,this.visibleColRef),this.visibleColFormatter=Mt.pureComputed((()=>ca(this,this.column(),e,"vcol"))),this.formatter=Mt.pureComputed((()=>ca(this,this.column(),e,"full"))),this.createValueParser=function(){const t=this.useColOptions.peek()?void 0:this.id.peek(),o=(0,la.jo)(e.docData,this.colRef.peek(),t);return o.cleanParse.bind(o)},this._widgetOptionsStr=this.autoDispose(na.savingComputed({read:()=>this._fieldOrColumn().widgetOptions(),write:(e,t)=>e(this._fieldOrColumn().widgetOptions,t)})),this.widgetOptionsJson=this.autoDispose(na.jsonObservable(this._widgetOptionsStr,(e=>ya.JH(e||{},this.column().pureType())))),this.wrap=this.autoDispose(na.fieldWithDefault(this.widgetOptionsJson.prop("wrap"),(()=>"record"!==this.viewSection().parentKey()))),this.widget=this.widgetOptionsJson.prop("widget"),this.textColor=this.widgetOptionsJson.prop("textColor"),this.fillColor=this.widgetOptionsJson.prop("fillColor"),this.fontBold=this.widgetOptionsJson.prop("fontBold"),this.fontUnderline=this.widgetOptionsJson.prop("fontUnderline"),this.fontItalic=this.widgetOptionsJson.prop("fontItalic"),this.fontStrikethrough=this.widgetOptionsJson.prop("fontStrikethrough"),this.headerTextColor=this.widgetOptionsJson.prop("headerTextColor"),this.headerFillColor=this.widgetOptionsJson.prop("headerFillColor"),this.headerFontBold=this.widgetOptionsJson.prop("headerFontBold"),this.headerFontUnderline=this.widgetOptionsJson.prop("headerFontUnderline"),this.headerFontItalic=this.widgetOptionsJson.prop("headerFontItalic"),this.headerFontStrikethrough=this.widgetOptionsJson.prop("headerFontStrikethrough"),this.documentSettings=Mt.pureComputed((()=>e.docInfoRow.documentSettingsJson())),this.style=Mt.pureComputed({read:()=>({textColor:this.textColor(),fillColor:this.fillColor(),fontBold:this.fontBold(),fontUnderline:this.fontUnderline(),fontItalic:this.fontItalic(),fontStrikethrough:this.fontStrikethrough()}),write:e=>{this.widgetOptionsJson.update(e)}}),this.headerStyle=Mt.pureComputed({read:()=>({headerTextColor:this.headerTextColor(),headerFillColor:this.headerFillColor(),headerFontBold:this.headerFontBold(),headerFontUnderline:this.headerFontUnderline(),headerFontItalic:this.headerFontItalic(),headerFontStrikethrough:this.headerFontStrikethrough()}),write:e=>{this.widgetOptionsJson.update(e)}}),this.tableId=Mt.pureComputed((()=>this.column().table().tableId())),this.rulesList=Mt.pureComputed((()=>this._fieldOrColumn().rules())),this.rulesCols=dd(e.columns,Mt.pureComputed((()=>this._fieldOrColumn().rules()))),this.rulesColsIds=Mt.pureComputed((()=>this.rulesCols().map((e=>e.colId())))),this.rulesStyles=na.fieldWithDefault(this.widgetOptionsJson.prop("rulesOptions"),[]),this.hasRules=Mt.pureComputed((()=>this.rulesCols().length>0)),this.addEmptyRule=async()=>{const t=this.useColOptions.peek(),o=["AddEmptyRule",this.column.peek().table.peek().tableId.peek(),t?0:this.id.peek(),t?this.column.peek().id.peek():0];await e.docData.sendAction(o,`Update rules for ${this.colId.peek()}`)},this.removeRule=t=>va(e,this,t),this.config=new Oa(this,e),this.disableModify=this.autoDispose(Mt.pureComputed((()=>this.column().disableModify()))),this.disableEditData=this.autoDispose(Mt.pureComputed((()=>this.column().disableEditData())))}function Ba(e){this.viewSections=ld(this,e.viewSections,"parentId"),this.tabBarItem=ld(this,e.tabBar,"viewRef"),this.layoutSpecObj=na.jsonObservable(this.layoutSpec),this.activeCollapsedSectionId=Mt.observable(0),this.collapsedSections=this.autoDispose(Mt.pureComputed((()=>{const e=new Set(this.viewSections().all().map((e=>e.id())));return(this.layoutSpecObj().collapsed||[]).map((e=>e.leaf)).filter((t=>e.has(t)))}))),this.activeCollapsedSections=Mt.observable(this.collapsedSections.peek()),this.activeSectionId=Xl.observableWithDefault(Mt.observable(),(()=>{var e;if(this.isDisposed()||!this.getRowId())return 0;const t=this.viewSections().all(),o=new Set(this.activeCollapsedSections()),i=t.filter((e=>!o.has(e.id()))),s=function(e){for(var t;null==(t=null==e?void 0:e.children)?void 0:t.length;)e=e.children[0];return null==e?void 0:e.leaf}(this.layoutSpecObj.peek());return i.find((e=>e.id()===s))?s:(null==(e=i[0])?void 0:e.id())||0})),this.activeSection=ad(e.viewSections,this.activeSectionId),this._isActiveSectionGone=this.autoDispose(Mt.computed((()=>this.activeSection()._isDeleted()))),this.autoDispose(this._isActiveSectionGone.subscribe((e=>{e&&this.activeSectionId(0)})))}var La=o(93965);const $a=o(72827),Ua=o(87604),za=o(46402);class Va extends r.Disposable{constructor(e,t){var o;super();const{srcSection:i,srcCol:s,srcColId:n,tgtSection:r,tgtCol:l,tgtColId:a}=t;this._srcSection=i,this._srcCol=s,this._srcColId=n,this._srcTableModel=e.dataTables[i.table().tableId()];const d=this._srcTableModel.tableData;if(a){const e=(0,ge.isRefListType)(l.type())?"intersects":"in";i.selectedRowsActive()?this.filterColValues=this._srcCustomFilter(a,e):this.filterColValues=n?this._srcCellFilter(a,e):this._simpleFilter(a,e,(e=>[e]))}else if(n&&(0,ge.isRefListType)(s.type()))this.filterColValues=this._srcCellFilter("id","in");else if(!n&&function(e,t){const o=e.summarySourceTable();if(o===t.getRowId())return!0;const i=t.summarySourceTable();return Boolean(o)&&i===o&&e.getRowId()!==t.getRowId()&&P.isSubset(e.summarySourceColRefs(),t.summarySourceColRefs())}(i.table(),r.table())){let e=function(){const e={filters:{},operations:{}};if(i.isDisposed())return e;const s=i.activeRowId();for(const o of i.table().groupByColumns()){const i=o.colId(),n=d.getValue(s,i);e.filters[i]=[n],e.operations[i]="in",t&&(0,ge.isListType)(o.summarySource().type())&&(e.operations[i]=n?"intersects":"empty")}o(e)};const t=i.table().summarySourceTable()===r.table().getRowId(),o=Mt.observable();this.filterColValues=this.autoDispose(Mt.computed((()=>o()))),this.autoDispose(d.dataLoadedEmitter.addListener(e)),e()}else if(i.selectedRowsActive())this.filterColValues=this._srcCustomFilter("id","in");else{const e=n?this._makeSrcCellGetter():$a;if(e&&(this.cursorPos=this.autoDispose(Mt.computed((()=>e(i.activeRowId()))))),!n){const e=null==(o=i.linkingState())?void 0:o.getDefaultColValues;e&&(this.getDefaultColValues=e)}}this.getDefaultColValues||(this.getDefaultColValues=()=>{if(!this.filterColValues)return{};const{filters:e,operations:t}=this.filterColValues.peek();return Ua(za(e,((e,t)=>e.length>0&&"id"!==t)),((e,o)=>"intersects"===t[o]?(0,La.Cx)(e):e[0]))})}disableEditing(){return Boolean(this.filterColValues)&&"new"===this._srcSection.activeRowId()}_simpleFilter(e,t,o){return this.autoDispose(Mt.computed((()=>{const i=this._srcSection.activeRowId();if(null===i)return console.warn("_simpleFilter activeRowId is null"),{filters:{},operations:{}};const s=o(i);return{filters:{[e]:s},operations:{[e]:t}}})))}_srcCellFilter(e,t){const o=this._makeSrcCellGetter();if(o){const i=(0,ge.isRefListType)(this._srcCol.type());return this._simpleFilter(e,t,(e=>{const t=o(e);return i?(0,ge.isList)(t)?t.slice(1):[]:[t]}))}}_srcCustomFilter(e,t){return this.autoDispose(Mt.computed((()=>{const o=this._srcSection.selectedRows();return{filters:{[e]:o},operations:{[e]:t}}})))}_makeSrcCellGetter(){const e=this.autoDispose(this._srcTableModel.createFloatingRowModel()),t=e.cells[this._srcColId];return t?o=>(e.assign(o),"new"===o?"new":t()):null}}var Na=o(82882),ja=o(21602),Wa=o(48210),Ha=Object.defineProperty,Ga=Object.getOwnPropertySymbols,Ka=Object.prototype.hasOwnProperty,Ja=Object.prototype.propertyIsEnumerable,Xa=(e,t,o)=>t in e?Ha(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,qa=(e,t)=>{for(var o in t||(t={}))Ka.call(t,o)&&Xa(e,o,t[o]);if(Ga)for(var o of Ga(t))Ja.call(t,o)&&Xa(e,o,t[o]);return e};const Ya=o(52906);function Za(e){this.viewFields=ld(this,e.viewFields,"parentId",{sortBy:"parentPos"}),this.linkedSections=ld(this,e.viewSections,"linkSrcSectionRef"),this.columns=this.autoDispose(Mt.pureComputed((()=>this.table().columns().all().filter((e=>!e.isHiddenCol()))))),this.editingFormula=Mt.pureComputed({read:()=>e.editingFormula(),write:t=>{e.editingFormula(t)}});const t={verticalGridlines:!0,horizontalGridlines:!0,zebraStripes:!1,customView:"",numFrozen:0};this.optionsObj=na.jsonObservable(this.options,(e=>Ya(e||{},t)));const o={mode:"url",url:null,widgetDef:null,access:"",pluginId:"",sectionId:""},i=na.jsonObservable(this.optionsObj.prop("customView"),(e=>Ya(e||{},o)));this.customDef={mode:i.prop("mode"),url:i.prop("url"),widgetDef:i.prop("widgetDef"),widgetOptions:i.prop("widgetOptions"),columnsMapping:i.prop("columnsMapping"),access:i.prop("access"),pluginId:i.prop("pluginId"),sectionId:i.prop("sectionId")},this.selectedFields=Mt.observable([]);const s=this.autoDispose(Mt.pureComputed((()=>this.selectedFields().filter((e=>!e.isDisposed())).map((e=>e.column())).filter((e=>!e.isDisposed())))));this.columnsBehavior=Mt.pureComputed((()=>{const e=new Set(s().map((e=>e.behavior())));return 1===e.size?e.values().next().value:"mixed"})),this.columnsType=Mt.pureComputed((()=>{const e=new Set(s().map((e=>e.type())));return 1===e.size?e.values().next().value:"mixed"})),this.columnsAllIsFormula=Mt.pureComputed((()=>s().every((e=>e.isFormula())))),this.activeCustomOptions=na.customValue(this.customDef.widgetOptions),this.saveCustomDef=async()=>{await i.save(),this.activeCustomOptions.revert()},this.themeDef=na.fieldWithDefault(this.theme,"form"),this.chartTypeDef=na.fieldWithDefault(this.chartType,"bar"),this.view=ad(e.views,this.parentId),this.table=ad(e.tables,this.tableRef),this.defaultWidgetTitle=this.autoDispose(Mt.pureComputed((()=>{var e;const t="record"!==this.parentKey()?`${(0,lr.a)(this.parentKey.peek()).label}`:"",o=this.table();return[null==(e=o.tableNameDef())?void 0:e.toUpperCase(),o.groupDesc(),t].filter((e=>Boolean(null==e?void 0:e.trim()))).join(" ")}))),this.titleDef=na.fieldWithDefault(this.title,this.defaultWidgetTitle),this.description=na.fieldWithDefault(this.description,this.description()),this.isRaw=this.autoDispose(Mt.pureComputed((()=>this.table().rawViewSectionRef()===this.getRowId()))),this.isVirtual=this.autoDispose(Mt.pureComputed((()=>"string"==typeof this.id()))),this.borderWidthPx=Mt.pureComputed((()=>this.borderWidth()+"px")),this.layoutSpecObj=na.jsonObservable(this.layoutSpec),this._savedFilters=ld(this,e.filters,"viewSectionRef"),this._unsavedFilters=new Map,this.filters=this.autoDispose(Mt.computed((()=>{const e=new Map(this._savedFilters().all().map((e=>[e.colRef(),e]))),t=new Map(this.viewFields().all().map((e=>[e.origCol().getRowId(),e])));return this.columns().map((o=>{var i;const s=e.get(o.origColRef()),n=na.customComputed({read:()=>s?s.activeFilter():""}),r=na.customComputed({read:()=>!!s&&s.pinned()}),l=this._unsavedFilters.get(o.origColRef());if(l){const{filter:e,pinned:t}=l;void 0!==e&&n(e),void 0!==t&&r(t)}return{viewSection:this,filter:n,pinned:r,fieldOrColumn:null!=(i=t.get(o.origColRef()))?i:o,isFiltered:Mt.pureComputed((()=>""!==n())),isPinned:Mt.pureComputed((()=>r()))}}))}))),this.activeFilters=r.Computed.create(this,(e=>e(this.filters).filter((t=>e(t.isFiltered))))),this.pinnedActiveFilters=r.Computed.create(this,(e=>e(this.activeFilters).filter((t=>e(t.isPinned))))),this.filterSpecChanged=r.Computed.create(this,(e=>e(this.filters).some((t=>!e(t.filter.isSaved)||!e(t.pinned.isSaved))))),this.showNestedFilteringPopup=r.Observable.create(this,!1),this.saveFilters=()=>e.docData.bundleActions(`Save all filters in ${this.titleDef()}`,(async()=>{const t=new Map(this._savedFilters().all().map((e=>[e.colRef(),e]))),o=[],i=[],s=[];for(const e of this.filters()){const{fieldOrColumn:n,filter:r,pinned:l}=e;if(r.isSaved()&&l.isSaved())continue;const a=t.get(n.origCol().origColRef());if(a)""===r()?i.push(a.id()):o.push([a.id(),{filter:r(),pinned:l()}]);else{if(""===r())continue;s.push([n.origCol().origColRef(),{filter:r(),pinned:l()}])}}const n=[];i.length>0&&n.push(["BulkRemoveRecord",i]),o.length>0&&n.push(["BulkUpdateRecord",o.map((([e])=>e)),{filter:o.map((([,{filter:e}])=>e)),pinned:o.map((([,{pinned:e}])=>e))}]),s.length>0&&n.push(["BulkAddRecord",(0,P.arrayRepeat)(s.length,null),{viewSectionRef:(0,P.arrayRepeat)(s.length,this.id()),colRef:s.map((([e])=>e)),filter:s.map((([,{filter:e}])=>e)),pinned:s.map((([,{pinned:e}])=>e))}]),n.length>0&&await e.filters.sendTableActions(n),this.revertFilters()})),this.revertFilters=()=>{this._unsavedFilters.clear(),this.filters().forEach((e=>{e.filter.revert(),e.pinned.revert()}))},this.setFilter=(e,t)=>{this._unsavedFilters.set(e,qa(qa({},this._unsavedFilters.get(e)),t));const o=this.filters().find((t=>t.fieldOrColumn.origCol().origColRef()===e));if(!o)return;const{filter:i,pinned:s}=t;void 0!==i&&o.filter(i),void 0!==s&&o.pinned(s)},this.revertFilter=e=>{this._unsavedFilters.delete(e);const t=this.filters().find((t=>t.fieldOrColumn.origCol().origColRef()===e));t&&(t.filter.revert(),t.pinned.revert())},this.activeSortJson=na.customValue(this.sortColRefs),this.activeSortSpec=na.jsonObservable(this.activeSortJson,(t=>(t||[]).filter((t=>{const o=e.columns.getRowModel(Wa.Sort.getColRef(t));return!o._isDeleted()&&o.getRowId()})))),this.activeDisplaySortSpec=this.autoDispose(Mt.computed((()=>this.activeSortSpec().map((e=>{const t=Wa.Sort.getColRef(e),o=this.viewFields().all().find((e=>e.column().origColRef()===t)),i=o?o.displayColRef():t;return Wa.Sort.swapColRef(e,i)}))))),this.hiddenColumns=this.autoDispose(Mt.pureComputed((()=>{const e=new Set(this.viewFields().all().map((e=>e.column().origColRef())));return this.columns().filter((t=>!e.has(t.getRowId())))}))),this.hasFocus=Mt.pureComputed({read:()=>!this.isDisposed()&&this.view().activeSectionId()===this.id(),write:e=>{this.view().activeSectionId(e?this.id():0)}}),this.linkSrcSection=ad(e.viewSections,this.linkSrcSectionRef),this.linkSrcCol=ad(e.columns,this.linkSrcColRef),this.linkTargetCol=ad(e.columns,this.linkTargetColRef),this.activeRowId=Mt.observable(null),this._linkingState=r.Holder.create(this),this.linkingState=this.autoDispose(Mt.pureComputed((()=>{if(!this.linkSrcSectionRef())return null;try{const t=new ja.vH(this);return Va.create(this._linkingState,e,t)}catch(e){return console.warn(e),this._linkingState.dispose(),null}}))),this.linkingFilter=this.autoDispose(Mt.pureComputed((()=>{var e,t;return(null==(t=null==(e=this.linkingState())?void 0:e.filterColValues)?void 0:t.call(e))||{filters:{},operations:{}}}))),this.viewInstance=Mt.observable(null),this.lastCursorPos={rowId:0,fieldIndex:0},this.lastScrollPos={rowIndex:0,offset:0,scrollLeft:0},this.disableAddRemoveRows=Mt.pureComputed((()=>this.table().disableAddRemoveRows())),this.isSorted=Mt.pureComputed((()=>this.activeSortSpec().length>0)),this.disableDragRows=Mt.pureComputed((()=>this.isSorted()||!this.table().supportsManualSort())),this.rawNumFrozen=na.customValue(this.optionsObj.prop("numFrozen")),this.numFrozen=Mt.pureComputed((()=>Math.max(0,Math.min(this.rawNumFrozen(),this.viewFields().all().length-1)))),this.hasCustomOptions=Mt.observable(!1),this.desiredAccessLevel=Mt.observable(null),this.columnsToMap=Mt.observable(null),this.mappedColumns=Mt.pureComputed((()=>{const e=this.columnsToMap(),t=this.customDef.columnsMapping();if(!e||!t)return null;const o=e.map((e=>new Na.V(e))),i={},s=new Map(this.columns().map((e=>[e.id.peek(),e])));for(const e of o){i[e.name]=e.allowMultiple?[]:null;const o=t[e.name];if(o)if(e.allowMultiple){if(!Array.isArray(o))continue;i[e.name]=o.filter((e=>s.has(e))).filter((t=>e.canByMapped(s.get(t).pureType()))).map((e=>s.get(e).colId()))}else{if(Array.isArray(o)||!s.has(o))continue;const t=s.get(o);i[e.name]=e.canByMapped(t.pureType())?t.colId():null}}return i})),this.allowSelectBy=Mt.observable(!1),this.selectedRows=Mt.observable(null),this.selectedRowsActive=this.autoDispose(Mt.pureComputed((()=>null!==this.selectedRows()))),this.tableId=this.autoDispose(Mt.pureComputed((()=>this.table().tableId())));const n=this.autoDispose(Mt.pureComputed((()=>this.table().rawViewSection())));this.rulesCols=dd(e.columns,Mt.pureComputed((()=>n().rules()))),this.rulesColsIds=Mt.pureComputed((()=>this.rulesCols().map((e=>e.colId())))),this.rulesStyles=na.savingComputed({read:()=>{var e;return null!=(e=n().optionsObj.prop("rulesOptions")())?e:[]},write:(e,t)=>e(n().optionsObj.prop("rulesOptions"),t)}),this.hasRules=Mt.pureComputed((()=>this.rulesCols().length>0)),this.addEmptyRule=async()=>{const t=["AddEmptyRule",this.tableId.peek(),null,null];await e.docData.sendAction(t,`Update rules for ${this.table.peek().tableId.peek()}`)},this.removeRule=t=>va(e,this,t),this.isCollapsed=this.autoDispose(Mt.pureComputed((()=>this.view().activeCollapsedSections().includes(this.id()))))}function Qa(e){this.hidden=Mt.pureComputed((()=>(0,ge.isCensored)(this.content()))),this.column=ad(e.columns,this.colRef),this.table=ad(e.tables,this.tableRef),this.parent=ad(e.cells,this.parentId),this.children=ld(this,e.cells,"parentId");const t=na.savingComputed({read:()=>this.hidden()?"{}":this.content(),write:(e,t)=>e(this.content,t)}),o=(0,na.jsonObservable)(t);this.text=o.prop("text"),this.userName=o.prop("userName"),this.timeCreated=o.prop("timeCreated"),this.timeUpdated=o.prop("timeUpdated"),this.resolved=o.prop("resolved"),this.resolvedBy=o.prop("resolvedBy")}var ed,td,od=Object.defineProperty,id=Object.getOwnPropertySymbols,sd=Object.prototype.hasOwnProperty,nd=Object.prototype.propertyIsEnumerable,rd=(e,t,o)=>t in e?od(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;function ld(e,t,o,i){const s=((e,t)=>{for(var o in t||(t={}))sd.call(t,o)&&rd(e,o,t[o]);if(id)for(var o of id(t))nd.call(t,o)&&rd(e,o,t[o]);return e})({groupBy:o,sortBy:"id"},i);return Xl.computedAutoDispose((()=>t.createRowGroupModel(e.id()||0,s)),null,{pure:!0})}function ad(e,t){return Mt.pureComputed((()=>e.getRowModel(t()||0,!0)))}function dd(e,t){return Mt.pureComputed((()=>{const o=(0,La.xD)(t());return Array.isArray(o)?o.map((t=>e.getRowModel(t,!0))):[]}))}class cd{constructor(e,t){this.docData=e,this._docPageModel=t,this.docInfo=this._metaTableModel("_grist_DocInfo",ua),this.tables=this._metaTableModel("_grist_Tables",wa),this.columns=this._metaTableModel("_grist_Tables_column",da),this.views=this._metaTableModel("_grist_Views",Ba),this.viewSections=this._metaTableModel("_grist_Views_section",Za),this.viewFields=this._metaTableModel("_grist_Views_section_field",Ea),this.tabBar=this._metaTableModel("_grist_TabBar",ma),this.validations=this._metaTableModel("_grist_Validations",ba),this.pages=this._metaTableModel("_grist_Pages",pa),this.rules=this._metaTableModel("_grist_ACLRules",ia),this.filters=this._metaTableModel("_grist_Filters",ha),this.cells=this._metaTableModel("_grist_Cells",Qa),this.dataTables={},this.dataTablesByRef=new Map,this.allTabs=this.tabBar.createAllRowsModel("tabPos"),this.editingFormula=Mt.observable(!1),this.showDocTourTable="GristDocTour"===(0,Ys.urlState)().state.get().docPage,this.showDocTutorialTable=!this._docPageModel.isTutorialFork.get()||(0,tn.J5)(null!=(td=null==(ed=this._docPageModel.currentDoc.get())?void 0:ed.trunkAccess)?td:null);for(const e of this._metaTables)e.loadData();this.docInfoRow=this.docInfo.getRowModel(1),this.allTables=this._createAllTablesArray(),this.visibleTables=this._createVisibleTablesArray(),this.rawDataTables=this._createRawDataTablesArray(),this.rawSummaryTables=this._createRawSummaryTablesArray();const o=Mt.computed((()=>this.allTables.all().map((e=>e.tableId()))));this.allTableIds=Ot.syncedKoArray(o);const i=Mt.computed((()=>this.visibleTables.all().map((e=>e.tableId()))));this.visibleTableIds=Ot.syncedKoArray(i),this.tables.createAllRowsModel("id").subscribeForEach({add:e=>this._onAddTable(e),remove:e=>this._onRemoveTable(e)});const s=this.pages.createAllRowsModel("pagePos");this.menuPages=Mt.computed((()=>{const e=s.all().filter((e=>!e.isSpecial())).sort(((e,t)=>e.pagePos()-t.pagePos())),t=Jl()((t=>{const o=e.slice(e.indexOf(t)+1),i=o.findIndex((e=>e.indentation()<=t.indentation()));return i>=0?o.slice(0,i):o})),o=Jl()((e=>e.isCensored()&&t(e).every((e=>o(e)))));return e.filter((e=>!o(e)))})),this.visibleDocPages=Mt.computed((()=>s.all().filter((e=>!e.isHidden())))),this.hasDocTour=Mt.computed((()=>this.visibleTableIds.all().includes("GristDocTour"))),this.isTutorial=Mt.computed((()=>(0,r.toKo)(Mt,this._docPageModel.isTutorialFork)()&&this.allTableIds.all().includes("GristDocTutorial")))}_metaTableModel(e,t){const o=Object.keys(oa.f[e]),i=new(Ql())(this,this.docData.getTable(e),o,t);return this._metaTables||(this._metaTables=[]),this._metaTables.push(i),i}_onAddTable(e){let t=e.tableId();const o=new(Yl())(this,this.docData.getTable(t),e);this.dataTables[t]=o,this.dataTablesByRef.set(e.getRowId(),o),e.tableId.subscribe((e=>{this.dataTables[e]=this.dataTables[t],delete this.dataTables[t],t=e}))}_onRemoveTable(e){const t=e.tableId();this.dataTables[t].dispose(),delete this.dataTables[t],this.dataTablesByRef.delete(e.getRowId())}_createAllTablesArray(){return ud(this.tables)}_createVisibleTablesArray(){return ud(this.tables,(e=>!(0,ta.Pr)(this.tables.tableData,e)&&(this.tables.tableData,!("string"==typeof e))&&(!hd(this.tables.tableData,e)||this.showDocTutorialTable)))}_createRawDataTablesArray(){return ud(this.tables,(e=>!(0,ta.$U)(this.tables.tableData,e)&&(!hd(this.tables.tableData,e)||this.showDocTutorialTable)))}_createRawSummaryTablesArray(){return ud(this.tables,(e=>(0,ta.$U)(this.tables.tableData,e)))}}function ud(e,t=(e=>!0)){const o=new ea.FilteredRowSource(t);return o.subscribeTo(e),e._createRowSetModel(o,"tableId")}function hd(e,t){return"GristDocTutorial"===e.getValue(t,"tableId")}var pd=o(25192),md=o(30919),gd=o(88748),fd=o(71571),wd=o(88261),bd=o(45689),vd=o(60611),yd=o.n(vd),_d=Object.defineProperty,xd=Object.defineProperties,Cd=Object.getOwnPropertyDescriptors,Sd=Object.getOwnPropertySymbols,Id=Object.prototype.hasOwnProperty,Dd=Object.prototype.propertyIsEnumerable,Rd=(e,t,o)=>t in e?_d(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,Td=(e,t)=>{for(var o in t||(t={}))Id.call(t,o)&&Rd(e,o,t[o]);if(Sd)for(var o of Sd(t))Dd.call(t,o)&&Rd(e,o,t[o]);return e},kd=(e,t)=>xd(e,Cd(t));const Md=(0,F.makeT)("DocHistory"),Od=(0,bd.U)("activity","snapshots");class Ad extends r.Disposable{constructor(e,t){super(),this._docPageModel=e,this._actionLog=t,this._subTab=(0,Pl.h4)(this,"docHistorySubTab","snapshots",Od.guard)}buildDom(){const e=[{value:"activity",label:Md("Activity")},{value:"snapshots",label:Md("Snapshots")}];return[Pd((0,wd.buttonSelect)(this._subTab,e,{},(0,i.testId)("doc-history-tabs"))),r.dom.domComputed(this._subTab,(e=>(0,fd.lX)("activity"===e?this._actionLog.buildDom():"snapshots"===e?r.dom.create(this._buildSnapshots.bind(this)):null)))]}_buildSnapshots(e){var t;const o=this._docPageModel.currentDoc.get();if(!o)return null;const l=(0,Jt.L3)(kd(Td({},o.idParts),{snapshotId:void 0})),a=null==(t=(0,Ys.urlState)().state.get().params)?void 0:t.compare,d=a&&(0,Jt.wA)(a).snapshotId;function c(e,t){return r.dom.attr("href",(o=>(0,Ys.urlState)().makeUrl(kd(Td({},o((0,Ys.urlState)().state)),{doc:e.docId,params:t?{compare:t}:{}}))))}const u=r.Observable.create(e,[]),h=r.Observable.create(e,!1);return this._docPageModel.appModel.api.getDocAPI(l).getSnapshots().then((e=>u.isDisposed()||u.set(e.snapshots))).catch((e=>{h.set(!0),(0,re.reportError)(e)})),(0,r.dom)("div",r.dom.maybe(h,(()=>Ed(Md("Snapshots are unavailable."),(0,i.testId)("doc-history-error")))),r.dom.domComputed(u,(e=>e.map(((t,a)=>{const u=yd()(t.lastModified),h=e[a+1]||null;return Fd(Bd((0,gd.i0)(t.lastModified)),Ld(Ld.cls("-current",Boolean(t.snapshotId===o.idParts.snapshotId||d&&t.snapshotId===d)),(0,r.dom)("div",$d(u.format("ddd ll"))," ",$d(u.format("LT"))),Ud((0,s.icon)("Dots"),(0,n.menu)((()=>[(0,n.menuItemLink)(c(t),Md("Open Snapshot")),(0,n.menuItemLink)(c(t,l),Md("Compare to Current"),(0,n.menuAnnotate)(Md("Beta"))),h&&(0,n.menuItemLink)(c(h,t.docId),Md("Compare to Previous"),(0,n.menuAnnotate)(Md("Beta")))]),{placement:"bottom-end",parentSelectorToMark:"."+Ld.className}),(0,i.testId)("doc-history-snapshot-menu")),(0,i.testId)("doc-history-card")),(0,i.testId)("doc-history-snapshot"))})))))}}const Pd=(0,r.styled)("div",`\n  padding: 16px;\n  border-bottom: 1px solid ${i.theme.pagePanelsBorder};\n`),Fd=(0,r.styled)("div","\n  margin: 8px 16px;\n"),Ed=(0,r.styled)("div","\n  margin: 8px 16px;\n"),Bd=(0,r.styled)("div",`\n  text-align: right;\n  color: ${i.theme.lightText};\n  font-size: ${i.vars.smallFontSize};\n`),Ld=(0,r.styled)("div",`\n  border: 1px solid ${i.theme.documentHistorySnapshotBorder};\n  padding: 8px;\n  color: ${i.theme.documentHistorySnapshotFg};\n  background: ${i.theme.documentHistorySnapshotBg};\n  border-radius: 8px;\n  overflow: hidden;\n  display: flex;\n  align-items: center;\n  --icon-color: ${i.theme.controlSecondaryFg};\n\n  &-current {\n    background-color: ${i.theme.documentHistorySnapshotSelectedBg};\n    color: ${i.theme.documentHistorySnapshotSelectedFg};\n    --icon-color: ${i.theme.documentHistorySnapshotSelectedFg};\n  }\n`),$d=(0,r.styled)("span","\n  display: inline-block;\n"),Ud=(0,r.styled)("div",`\n  flex: none;\n  margin: 0 4px 0 auto;\n  height: 24px;\n  width: 24px;\n  padding: 4px;\n  line-height: 0px;\n  border-radius: 3px;\n  cursor: default;\n  &:hover, &.weasel-popup-open {\n    background-color: ${i.theme.hover};\n  }\n`);var zd=o(64985),Vd=o(84602),Nd=o(84418),jd=o(50733),Wd=o(39764);const Hd=o(49268),Gd=(0,F.makeT)("OnBoardingPopups"),Kd=(0,r.makeTestId)("test-onboarding-"),Jd=r.Holder.create(null);function Xd(e,t){Qd.create(Jd,e,t).start().catch(re.reportError)}function qd(){return!Jd.isEmpty()}class Yd extends Error{constructor(e){super(e),this.name="OnBoardingError"}}let Zd=0;class Qd extends r.Disposable{constructor(e,t){if(super(),this._messages=e,this._onFinishCB=t,this._arrowEl=oc((0,r.svg)("svg",{style:"width: 13px; height: 34px;"},(0,r.svg)("path",{d:"M 2 19 h 13 v 18 Z"}))),0===this._messages.length)throw new Yd("messages should not be an empty list");Zd=Math.min(Zd,this._messages.length-1),this.onDispose((()=>{var e;null==(e=this._openPopupCtl)||e.close()}))}async start(){this._showOverlay(),await this._move(0),jd.setPaused(!0),this.onDispose((()=>{jd.setPaused(!1)}))}_finish(){this._onFinishCB(),this.dispose()}async _move(e,t=!1){var o;const i=Zd+e,s=this._messages[i];s?(Zd=i,s.skip?await this._move(e||1):(null==(o=this._openPopupCtl)||o.close(),s.urlState&&(await(0,Ys.urlState)().pushUrl(s.urlState),await(0,Wd.g)(100)),s.showHasModal?this._showHasModal():await this._showHasPopup(e))):t&&(Zd=0,this._finish())}async _showHasPopup(e){const t=this._buildPopupContent(),o=this._messages[Zd],i=document.querySelector(o.selector),{placement:s}=o;if(!i)return console.warn(`On boarding tour: element ${o.selector} not found!`),this._move(e||1);this._openPopupCtl={close:function(){l.destroy(),r.dom.domDispose(t),t.remove()}},document.body.appendChild(t),this._addFocusLayer(t);const n=o.cropPadding?this._getAdjacentPadding(i,s):0,l=(0,Nd.fi)(i,t,{placement:s,modifiers:[{name:"arrow",options:{element:this._arrowEl}},{name:"offset",options:{offset:[0,12-n]}}]})}_addFocusLayer(e){r.dom.autoDisposeElem(e,new ko.FocusLayer({defaultFocusElem:e,allowFocus:e=>e!==document.body}))}_getAdjacentPadding(e,t){if(t){let o="";if(t.includes("bottom")?o=getComputedStyle(e).paddingBottom:t.includes("top")?o=getComputedStyle(e).paddingTop:t.includes("left")?o=getComputedStyle(e).paddingLeft:t.includes("right")&&(o=getComputedStyle(e).paddingRight),o&&o.endsWith("px"))return Number(o.slice(0,o.length-2))}return 0}_showHasModal(){const e=this._buildPopupContent();r.dom.update(this._overlay,e),this._addFocusLayer(e),this._openPopupCtl={close:function(){e.remove(),r.dom.domDispose(e)}}}_buildPopupContent(){return ec({tabindex:"-1"},this._arrowEl,ic((0,Vd.Ot)((0,Vd.gQ)("CrossBig"),r.dom.on("click",(()=>this._finish())),Kd("close")),dc(this._messages[Zd].title),cc(this._messages[Zd].body),this._buildFooter(),Kd("popup")),r.dom.onKeyDown({Escape:()=>this._finish(),ArrowLeft:()=>this._move(-1),ArrowRight:()=>this._move(1),Enter:()=>this._move(1,!0)}))}_buildFooter(){const e=this._messages.length,t=Zd===e-1,o=0===Zd;return sc(nc(Hd(e).map((e=>lc(lc.cls("-done",e>Zd))))),rc((0,ae.bigBasicButton)("Previous",Kd("previous"),r.dom.on("click",(()=>this._move(-1))),r.dom.prop("disabled",o),{style:"margin-right: 8px; visibility: "+(o?"hidden":"visible")}),(0,ae.bigPrimaryButton)(Gd(t?"Finish":"Next"),Kd("next"),r.dom.on("click",(()=>this._move(1,!0))))))}_showOverlay(){document.body.appendChild(this._overlay=ac()),this.onDispose((()=>{document.body.removeChild(this._overlay),r.dom.domDispose(this._overlay)}))}}const ec=(0,r.styled)("div",`\n  align-self: center;\n  border: 2px solid ${i.theme.accentBorder};\n  border-radius: 3px;\n  z-index: ${i.vars.onboardingPopupZIndex};\n  max-width: 490px;\n  position: relative;\n  background-color: ${i.theme.popupBg};\n  box-shadow: 0 2px 18px 0 ${i.theme.popupInnerShadow}, 0 0 1px 0 ${i.theme.popupOuterShadow};\n  outline: unset;\n`);function tc(e){return`.${ec.className}[data-popper-placement^=${e}]`}const oc=(0,r.styled)("div",`\n  position: absolute;\n\n  & path {\n    stroke: ${i.theme.accentBorder};\n    stroke-width: 2px;\n    fill: ${i.theme.popupBg};\n  }\n\n  ${tc("top")} > & {\n    bottom: -26px;\n  }\n\n  ${tc("bottom")} > & {\n    top: -23px;\n  }\n\n  ${tc("right")} > & {\n    left: -12px;\n  }\n\n  ${tc("left")} > & {\n    right: -12px;\n  }\n\n  ${tc("top")} svg {\n    transform: rotate(-90deg);\n  }\n\n  ${tc("bottom")} svg {\n    transform: rotate(90deg);\n  }\n\n  ${tc("left")} svg {\n    transform: scalex(-1);\n  }\n`),ic=(0,r.styled)("div",`\n  position: relative;\n  padding: 32px;\n  background-color: ${i.theme.popupBg};\n`),sc=(0,r.styled)("div","\n  display: flex;\n  flex-direction: row;\n  margin-top: 32px;\n  justify-content: space-between;\n  align-items: center;\n"),nc=(0,r.styled)("div","\n  display: flex;\n  flex-direction: row;\n  flex-wrap: wrap;\n  row-gap: 12px;\n"),rc=(0,r.styled)("div","\n  display: flex;\n  flex-directions: row;\n"),lc=(0,r.styled)("div",`\n  width: 6px;\n  height: 6px;\n  border-radius: 3px;\n  margin-right: 12px;\n  align-self: center;\n  background-color: ${i.theme.progressBarFg};\n  &-done {\n    background-color: ${i.theme.progressBarBg};\n  }\n`),ac=(0,r.styled)("div",`\n  position: fixed;\n  display: flex;\n  flex-direction: column;\n  justify-content: center;\n  width: 100%;\n  height: 100%;\n  top: 0;\n  left: 0;\n  z-index: ${i.vars.onboardingBackdropZIndex};\n  overflow-y: auto;\n`),dc=(0,r.styled)("div",`\n  font-size: ${i.vars.xxxlargeFontSize};\n  font-weight: ${i.vars.headerControlTextWeight};\n  color: ${i.theme.text};\n  margin: 0 0 16px 0;\n  line-height: 32px;\n`),cc=(0,r.styled)("div",`\n  color: ${i.theme.text};\n`),uc=["ChartArea","ChartBar","ChartDonut","ChartKaplan","ChartLine","ChartPie","TypeCard","TypeCardList","TypeCell","TypeChart","TypeCustom","TypeDetails","TypeTable","FieldAny","FieldAttachment","FieldCheckbox","FieldChoice","FieldColumn","FieldDate","FieldDateTime","FieldFunction","FieldFunctionEqual","FieldInteger","FieldLink","FieldNumeric","FieldReference","FieldSpinner","FieldSwitcher","FieldTable","FieldText","FieldTextbox","FieldToggle","LoginStreamline","LoginUnify","LoginVisualize","GoogleLogo","GristLogo","ThumbPreview","AddUser","ArrowLeft","ArrowRight","ArrowRightOutlined","BarcodeQR","BarcodeQR2","Board","Bookmark","CenterAlign","Chat","Code","Collapse","Convert","Copy","CrossBig","CrossSmall","Database","Dots","Download","DragDrop","Dropdown","DropdownUp","Empty","Exclamation","Expand","EyeHide","EyeShow","Feedback","Filter","FilterSimple","Fireworks","Flag","Folder","FontBold","FontItalic","FontStrikethrough","FontUnderline","FunctionResult","GreenArrow","Grow","Heart","Help","Home","Idea","Import","ImportArrow","Info","LeftAlign","Lighting","Lock","Log","Mail","Maximize","Memo","Message","Minimize","Minus","MobileChat","MobileChat2","NewNotification","Notification","Offline","Page","PanelLeft","PanelRight","Pencil","PinBig","PinSmall","PinTilted","Pivot","PivotLight","Plus","Popup","Public","PublicColor","PublicFilled","Redo","Remove","RemoveBig","Repl","ResizePanel","Revert","RightAlign","Robot","Script","Search","Settings","Share","Sort","Sparks","Tick","TickSolid","Undo","Validation","Video","Warning","Widget","Wrap","Zoom","UseChart","UseEducate","UseFinance","UseHr","UseMedia","UseMonitor","UseOther","UseProduct","UseSales","UseScience"];var hc=Object.defineProperty,pc=Object.defineProperties,mc=Object.getOwnPropertyDescriptors,gc=Object.getOwnPropertySymbols,fc=Object.prototype.hasOwnProperty,wc=Object.prototype.propertyIsEnumerable,bc=(e,t,o)=>t in e?hc(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;const vc=o(91944),yc=(0,F.makeT)("DocTour");async function _c(e,t,o){const s=await async function(e,t){const o="GristDocTour";if(!e.getTable(o))return null;await t.waitForInitialization(),await e.fetchTable(o);const s=e.getTable(o),n=vc(s.getRowIds(),s.getRowPropFunc("manualSort")).map((e=>{function t(t){return String(s.getValue(e,t)||"")}const o=t("Title");let n=t("Body");const l=t("Link_Text"),a=t("Link_URL"),d=t("Link_Icon"),c=t("Location");let u=t("Placement");if(!o&&!n)return null;const h=(0,Ys.sameDocumentUrlState)(c);!(0,i.isNarrowScreen)()&&zd.Ct.includes(u)||(u="auto");let p=!0;try{new URL(a)}catch(e){p=!1}return p&&l&&(n=(0,r.dom)("div",(0,r.dom)("p",n),(0,r.dom)("p",(0,Vd.ED)((0,Vd.ct)(uc.includes(d)?(0,Vd.K1)(d):null,l,{href:a,target:"_blank"}))))),{title:o,body:n,placement:u,urlState:h,selector:".active_cursor",showHasModal:!(null==h?void 0:h.hash)}})).filter((e=>null!==e));return n.length?n:null}(e,t)||xc;!function(e){window._gristDocTour=()=>e.map((e=>{var t,o,i,s;return i=((e,t)=>{for(var o in t||(t={}))fc.call(t,o)&&bc(e,o,t[o]);if(gc)for(var o of gc(t))wc.call(t,o)&&bc(e,o,t[o]);return e})({},e),s={body:"string"==typeof e.body?e.body:null==(t=e.body)?void 0:t.outerHTML.replace(/_grain\d+_/g,"_grainXXX_"),urlState:null==(o=e.urlState)?void 0:o.hash},pc(i,mc(s))}))}(s),Xd(s,o)}const xc=[{title:yc("No valid document tour"),body:yc("Cannot construct a document tour from the data in this document. Ensure there is a table named GristDocTour with columns Title, Body, Placement, and Location."),selector:"document",showHasModal:!0}];var Cc=o(77561),Sc=o(34925);const Ic=new Sc.TU.Renderer;Ic.image=(e,t,o)=>{var i;let s="doc-tutorial-popup-thumbnail";const n=null==(i=null==e?void 0:e.split("#"))?void 0:i[1];return n&&(s+=` doc-tutorial-popup-thumbnail-${n}`),`<div class="${s}">\n  <img src="${e}" title="${null!=t?t:""}" />\n  <div class="doc-tutorial-popup-thumbnail-icon-wrapper">\n    <div class="doc-tutorial-popup-thumbnail-icon"></div>\n  </div>\n</div>`},Ic.link=(e,t,o)=>`<a href="${e}" target="_blank">${o}</a>`;var Dc,Rc,Tc,kc,Mc,Oc,Ac=o(63561),Pc=o(60321),Fc=Object.defineProperty,Ec=Object.defineProperties,Bc=Object.getOwnPropertyDescriptors,Lc=Object.getOwnPropertySymbols,$c=Object.prototype.hasOwnProperty,Uc=Object.prototype.propertyIsEnumerable,zc=(e,t,o)=>t in e?Fc(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,Vc=(e,t)=>{for(var o in t||(t={}))$c.call(t,o)&&zc(e,o,t[o]);if(Lc)for(var o of Lc(t))Uc.call(t,o)&&zc(e,o,t[o]);return e};const Nc=o(88466),jc=o(49268),Wc=o(91944),Hc=(0,r.makeTestId)("test-doc-tutorial-");class Gc extends Ac.X${constructor(e){super({minimizable:!0,stopClickPropagationOnMove:!0}),this._gristDoc=e,this._appModel=this._gristDoc.docPageModel.appModel,this._currentDoc=this._gristDoc.docPageModel.currentDoc.get(),this._currentFork=null==(Rc=null==(Dc=this._currentDoc)?void 0:Dc.forks)?void 0:Rc[0],this._docComm=this._gristDoc.docComm,this._docData=this._gristDoc.docData,this._docId=this._gristDoc.docId(),this._slides=r.Observable.create(this,null),this._currentSlideIndex=r.Observable.create(this,null!=(Oc=null==(Mc=null==(kc=null==(Tc=this._currentFork)?void 0:Tc.options)?void 0:kc.tutorial)?void 0:Mc.lastSlideIndex)?Oc:0),this._saveCurrentSlidePositionDebounced=Nc(this._saveCurrentSlidePosition,1e3,{leading:!0,trailing:!0})}async start(){this.showPopup(),await this._loadSlides();const e=this._docData.getTable("GristDocTutorial");e&&this.autoDispose(e.tableActionEmitter.addListener((()=>this._reloadSlides())))}_buildTitle(){return(0,r.dom)("span",r.dom.text(this._gristDoc.docPageModel.currentDocTitle),Hc("popup-header"))}_buildContent(){return[r.dom.domComputed((e=>{const t=e(this._slides),o=e(this._currentSlideIndex),i=null==t?void 0:t[o];return(0,Ac.QS)(i?[(0,r.dom)("div",(e=>{e.innerHTML=i.slideContent})),i.boxContent?Jc((0,r.dom)("div",(e=>{e.innerHTML=i.boxContent}))):null,r.dom.on("click",(e=>{"IMG"===e.target.tagName&&this._openLightbox(e.target.src)})),this._initializeImages()]:su((0,Bo.M)()),Hc("popup-body"))})),Kc(r.dom.domComputed((e=>{const t=e(this._slides);if(!t)return null;const o=e(this._currentSlideIndex),i=t.length,n=0===o,l=o===i-1;return[Zc(Xc((0,s.icon)("Undo"),(0,oo.hoverTooltip)("Restart Tutorial",{key:Ac.Jn}),r.dom.on("click",(()=>this._restartTutorial())),Hc("popup-restart"))),qc(jc(t.length).map((e=>Yc((0,oo.hoverTooltip)(t[e].slideTitle,{closeOnClick:!1,key:Ac.Jn}),Yc.cls("-current",e===o),e===o?null:r.dom.on("click",(()=>this._changeSlide(e))),Hc(`popup-slide-${e+1}`))))),Qc((0,ae.basicButton)("Previous",r.dom.on("click",(async()=>{await this._previousSlide()})),{style:"visibility: "+(n?"hidden":"visible")},Hc("popup-previous")),(0,ae.primaryButton)(l?"Finish":"Next",l?r.dom.on("click",(async()=>await this._finishTutorial())):r.dom.on("click",(async()=>await this._nextSlide())),Hc("popup-next")))]})),Hc("popup-footer"))]}_buildArgs(){return[r.dom.cls("doc-tutorial-popup"),Hc("popup"),r.dom.maybe(this._slides,(e=>(0,r.dom)("div",{style:"display: none;"},r.dom.forEach(e,(e=>0===e.imageUrls.length?null:(0,r.dom)("div",e.imageUrls.map((e=>(0,r.dom)("img",{src:e})))))))))]}async _loadSlides(){const e="GristDocTutorial";if(!this._docData.getTable(e))throw new Error("DocTutorial failed to find table GristDocTutorial");if(await this._docComm.waitForInitialization(),this.isDisposed())return;if(await this._docData.fetchTable(e),this.isDisposed())return;const t=this._docData.getTable(e),o=(await Promise.all(Wc(t.getRowIds(),t.getRowPropFunc("manualSort")).map((async e=>{let o;const i=[],s=o=>{const i=t.getValue(e,o);return i?String(i):void 0},n=e=>{"image"===e.type&&i.push(e.href),o||"heading"!==e.type||1!==e.depth||(o=e.text)};let r=s("slide_content");if(!r)return null;r=(0,Pc.j)(await Sc.TU.parse(r,{async:!0,renderer:Ic,walkTokens:n}));let l=s("box_content");return l&&(l=(0,Pc.j)(await Sc.TU.parse(l,{async:!0,renderer:Ic,walkTokens:n}))),{slideContent:r,boxContent:l,slideTitle:o,imageUrls:i}})))).filter((e=>null!==e));if(!this.isDisposed()){if(0===o.length)throw new Error("DocTutorial failed to find slides in table GristDocTutorial");this._slides.set(o)}}async _reloadSlides(){await this._loadSlides();const e=this._slides.get();e&&this._currentSlideIndex.get()>e.length-1&&this._currentSlideIndex.set(e.length-1)}async _saveCurrentSlidePosition(){var e,t,o,i,s;const n=null!=(t=null==(e=this._currentDoc)?void 0:e.options)?t:{},r=this._currentSlideIndex.get(),l=null==(o=this._slides.get())?void 0:o.length;var a,d;let c;await this._appModel.api.updateDoc(this._docId,{options:(a=Vc({},n),d={tutorial:{lastSlideIndex:r}},Ec(a,Bc(d)))}),void 0!==l&&l>0&&(c=Math.floor((r+1)/l*100)),(0,Cc.C)("tutorialProgressChanged",{full:{tutorialForkIdDigest:null==(i=this._currentFork)?void 0:i.id,tutorialTrunkIdDigest:null==(s=this._currentFork)?void 0:s.trunkId,lastSlideIndex:r,numSlides:l,percentComplete:c}})}async _changeSlide(e){this._currentSlideIndex.set(e),await this._saveCurrentSlidePositionDebounced()}async _previousSlide(){await this._changeSlide(this._currentSlideIndex.get()-1)}async _nextSlide(){await this._changeSlide(this._currentSlideIndex.get()+1)}async _finishTutorial(){this._saveCurrentSlidePositionDebounced.cancel(),await this._saveCurrentSlidePosition();const e=this._appModel.lastVisitedOrgDomain.get();e?await(0,Ys.urlState)().pushUrl({org:e}):window.location.assign((0,Ys.getWelcomeHomeUrl)())}async _restartTutorial(){(0,wo.confirmModal)("Do you want to restart the tutorial? All progress will be lost.","Restart",(async()=>{const e=this._currentDoc.id,{trunkId:t}=(0,Jt.wA)(e),o=this._appModel.api.getDocAPI(e);await o.replace({sourceDocId:t,resetTutorialMetadata:!0})}),{modalOptions:{backerDomArgs:[r.dom.style("z-index",i.vars.tutorialModalZIndex.toString())]}})}_initializeImages(){return e=>{setTimeout((()=>{const t=e.querySelectorAll("img");for(const e of t)e.src=e.src,(0,oo.setHoverTooltip)(e,"Click to expand",{key:Ac.Jn,modifiers:{flip:{boundariesElement:"scrollParent"}},placement:"bottom"})}),0)}}_openLightbox(e){(0,wo.modal)((t=>(this.onDispose(t.close),[eu.cls(""),tu("CrossBig",r.dom.on("click",(()=>t.close())),Hc("lightbox-close")),ou(iu({src:e},Hc("lightbox-image"))),r.dom.on("click",((e,o)=>{e.target===o&&t.close()})),Hc("lightbox")])),{backerDomArgs:[r.dom.style("z-index",i.vars.tutorialModalZIndex.toString())]})}}const Kc=(0,r.styled)("div",`\n  display: flex;\n  column-gap: 24px;\n  align-items: center;\n  justify-content: space-between;\n  flex-shrink: 0;\n  padding: 24px 16px 24px 16px;\n  border-top: 1px solid ${i.theme.tutorialsPopupBorder};\n`),Jc=(0,r.styled)("div",`\n  margin-top: 16px;\n  padding: 24px;\n  border-radius: 4px;\n  background-color: ${i.theme.tutorialsPopupBoxBg};\n`),Xc=(0,r.styled)("div",`\n  --icon-color: ${i.theme.controlSecondaryFg};\n  padding: 4px;\n  border-radius: 4px;\n  cursor: pointer;\n\n  &:hover {\n    background-color: ${i.theme.hover};\n  }\n`),qc=(0,r.styled)("div","\n  display: flex;\n  gap: 8px;\n  flex-grow: 1;\n  flex-wrap: wrap;\n"),Yc=(0,r.styled)("div",`\n  width: 10px;\n  height: 10px;\n  border-radius: 5px;\n  align-self: center;\n  cursor: pointer;\n  background-color: ${i.theme.progressBarBg};\n\n  &-current {\n    cursor: default;\n    background-color: ${i.theme.progressBarFg};\n  }\n`),Zc=(0,r.styled)("div","\n  flex-shrink: 0;\n"),Qc=(0,r.styled)("div",`\n  display: flex;\n  justify-content: flex-end;\n  column-gap: 8px;\n  flex-shrink: 0;\n  min-width: 140px;\n\n  @media ${i.mediaXSmall} {\n    & {\n      flex-direction: column;\n      row-gap: 8px;\n      column-gap: 0px;\n      min-width: 0px;\n    }\n  }\n`),eu=(0,r.styled)("div","\n  display: flex;\n  flex-direction: column;\n  row-gap: 8px;\n  background-color: initial;\n  width: 100%;\n  height: 100%;\n  border: none;\n  border-radius: 0px;\n  box-shadow: none;\n  padding: 0px;\n"),tu=(0,r.styled)(s.icon,`\n  align-self: flex-end;\n  flex-shrink: 0;\n  height: 24px;\n  width: 24px;\n  cursor: pointer;\n  --icon-color: ${i.theme.modalBackdropCloseButtonFg};\n  &:hover {\n    --icon-color: ${i.theme.modalBackdropCloseButtonHoverFg};\n  }\n`),ou=(0,r.styled)("div","\n  align-self: center;\n  min-height: 0;\n  margin-top: auto;\n  margin-bottom: auto;\n"),iu=(0,r.styled)("img","\n  height: 100%;\n  max-width: min(100%, 1200px);\n"),su=(0,r.styled)("div","\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  height: 100%;\n");var nu=o(84462),ru=o(66632),lu=o(73454),au=o(22985),du=o(68652);const cu=(0,F.makeT)("DocumentSettings");class uu extends r.Disposable{constructor(e){super(),this._gristDoc=e,this._docInfo=this._gristDoc.docInfo,this._timezone=this._docInfo.timezone,this._locale=this._docInfo.documentSettingsJson.prop("locale"),this._currency=this._docInfo.documentSettingsJson.prop("currency"),this._engine=r.Computed.create(this,(e=>e(this._docInfo.documentSettingsJson.prop("engine")))).onWrite((e=>this._setEngine(e)))}buildDom(){const e=bu().length>0,t=this._gristDoc.docPageModel;return mu(pu(cu("Document Settings")),fu(cu("Time Zone:")),fu(r.dom.create(lu.buildTZAutocomplete,du,(0,r.fromKo)(this._timezone),(e=>this._timezone.saveOnly(e)))),fu(cu("Locale:")),fu(r.dom.create(hu,this._locale)),fu(cu("Currency:")),fu(r.dom.domComputed((0,r.fromKo)(this._locale),(e=>r.dom.create(ru.g,(0,r.fromKo)(this._currency),(e=>this._currency.saveOnly(e)),{defaultCurrencyLabel:cu("Local currency ({{currency}})",{currency:(0,au.zC)(e)})})))),e?fu([fu(cu("Engine (experimental {{span}} change at own risk):",{span:(0,r.dom)("span","",r.dom.style("cursor","pointer"),r.dom.on("click",(async()=>{await t.appModel.api.getDocAPI(t.currentDocId.get()).forceReload(),document.location.reload()})))})),(0,n.select)(this._engine,bu())]):null,pu(cu("API")),fu(cu("This document's ID (for API use):")),fu(gu((0,r.dom)("tt",t.currentDocId.get()),r.dom.on("click",(async(e,o)=>{e.stopImmediatePropagation(),e.preventDefault(),(0,oo.showTransientTooltip)(o,cu("Document ID copied to clipboard"),{key:"copy-document-id"}),await(0,es.copyToClipboard)(t.currentDocId.get())})))),pu(cu("Webhooks"),wu("Beta")),fu((0,ae.primaryButtonLink)(cu("Manage Webhooks"),(0,Ys.urlState)().setLinkUrl({docPage:"webhook"}))))}async _setEngine(e){(0,wo.confirmModal)(cu("Save and Reload"),cu("Ok"),(()=>this._doSetEngine(e)))}async _doSetEngine(e){const t=this._gristDoc.docPageModel;this._engine.get()!==e&&(await this._docInfo.documentSettingsJson.prop("engine").saveOnly(e),await t.appModel.api.getDocAPI(t.currentDocId.get()).forceReload())}}function hu(e,t){const o=au.k1.map((e=>({value:e.name,label:e.name,locale:e.code,cleanText:e.name.trim().toLowerCase()}))).sort((0,P.propertyCompare)("label")),s=new El.ACIndexImpl(o,200,!0),n=r.Computed.create(e,(e=>{var o;const i=e(t);return(null==(o=au.k1.find((e=>e.code===i)))?void 0:o.name)||i}));return(0,nu.R)(e,{acIndex:s,valueObs:n,save(e,o){if(!o)throw new Error("Invalid locale");t.saveOnly(o.locale).catch(Oo.eK)}},(0,i.testId)("locale-autocomplete"))}const pu=(0,r.styled)(os.gs,"\n  margin-bottom: 0;\n  &:not(:first-of-type) {\n    margin-top: 40px;\n  }\n"),mu=(0,r.styled)("div",`\n  overflow-y: auto;\n  position: relative;\n  height: 100%;\n  padding: 32px 64px 24px 64px;\n  @media ${i.mediaSmall} {\n    & {\n      padding: 32px 24px 24px 24px;\n    }\n  }\n`),gu=(0,r.styled)("div",`\n  display: inline-block;\n  cursor: default;\n  color: ${i.theme.lightText};\n  transition: background 0.05s;\n  &:hover {\n    background: ${i.theme.lightHover};\n  }\n`),fu=(0,r.styled)("div",`\n  margin: 16px 0px;\n  font-size: ${i.vars.largeFontSize};\n  color: ${i.theme.text};\n  width: 360px;\n`),wu=(0,r.styled)("sup",`\n  text-transform: uppercase;\n  color: ${i.theme.text};\n  font-size: ${i.vars.smallFontSize};\n  margin-left: 8px;\n`);function bu(){return(window.gristConfig||{}).supportEngines||[]}var vu=o(22641),yu=o(57570),_u=o(29114),xu=o(31660),Cu=o.n(xu);class Su{constructor(e){this.docData=new Vl.a((async e=>{throw new Error(`no ${e}`)}),null),this._altActions=new _u.H(this);for(const t of e||[])this.docData.receiveAction(t)}async sendTableActions(e){const t=[];for(const o of e){const e=await this._altActions.processUserAction(o);t.push(e);for(const t of e.stored)this.docData.receiveAction(t)}return t}async fetchActionData(e,t,o){return(await this.docData.requireTable(e)).getTableDataAction(t,o)}async getNextRowId(e){const t=await this.docData.requireTable(e);return(Cu()(t.getRowIds())||0)+1}}var Iu=Object.defineProperty,Du=Object.defineProperties,Ru=Object.getOwnPropertyDescriptors,Tu=Object.getOwnPropertySymbols,ku=Object.prototype.hasOwnProperty,Mu=Object.prototype.propertyIsEnumerable,Ou=(e,t,o)=>t in e?Iu(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;const Au=o(88466);let Pu=1;class Fu extends zl{constructor(e,t,o,i){super(e,t,o,i)}setExt(e){this.ext=e,this.cache=new Su(this.ext.initialActions)}get name(){return this.ext.name}fetchData(){return super.fetchData((async()=>{var e;const t=await this.ext.fetchAll();return null==(e=this.cache.docData.getTable(this.name))||e.loadData(t),t}))}async sendTableActions(e){const t=await this._sendTableActionsCore(e,{isUser:!0});return await this.ext.afterEdit(this._editor(t)),t.map((e=>e.retValues))}sync(){return this.ext.sync(this._editor())}async sendTableAction(e){return(await this.sendTableActions([e]))[0]}async schemaChange(){await this.ext.afterAnySchemaChange(this._editor())}_editor(e=[]){const t=(0,yu.Rx)(e.map((e=>(0,yu.Y0)(e.stored,e.undo))));return{actions:e,delta:t.tableDeltas[this.name],gristDoc:this.gristDoc,getRecord:e=>this.getRecord(e),getRecordNew:e=>this.getRecord(e),getRowIds:()=>this.getRowIds(),patch:e=>this._sendTableActionsCore(e,{hasTableIds:!0,isUser:!1})}}async _sendTableActionsCore(e,t){const{isUndo:o,isUser:i,hasTableIds:s}=t;s||e.forEach((e=>e.splice(1,0,this.tableId)));const n=await this.cache.sendTableActions(e);if(i){const e=await this.cache.docData.requireTable(this.name);try{await this.ext.beforeEdit((r=((e,t)=>{for(var o in t||(t={}))ku.call(t,o)&&Ou(e,o,t[o]);if(Tu)for(var o of Tu(t))Mu.call(t,o)&&Ou(e,o,t[o]);return e})({},this._editor(n)),l={getRecordNew:t=>e.getRecord(t)},Du(r,Ru(l))))}catch(e){n.reverse();for(const e of n)await this.cache.sendTableActions(e.undo);throw e}}var r,l;for(const e of n)for(const s of e.stored)if(this.docData.receiveAction(s),this.cache.docData.receiveAction(s),i){const i=`ext-${this.name}-${Pu}`;Pu++,this.gristDoc.getUndoStack().pushAction({actionNum:i,actionHash:"hash",fromSelf:!0,otherId:t.actionNum||0,linkId:0,rowIdHint:0,isUndo:o,action:e,op:this._doUndo.bind(this)})}return n}async _doUndo(e,t){await this._sendTableActionsCore(t?e.action.undo:e.action.stored,{isUndo:t,isUser:!0,actionNum:e.actionNum,hasTableIds:!0})}}class Eu{constructor(e,t,o){if(this._owner=e,this.lazySync=Au(this.sync,1e3,{maxWait:2e3,trailing:!0}),t.docModel.docData.getTable(o.name))this.tableData=t.docModel.docData.getTable(o.name);else{t.docModel.docData.registerVirtualTable(o.name,Fu);for(const e of o.initialActions)t.docData.receiveAction(e);this.tableData=t.docModel.docData.getTable(o.name),this.tableData.gristDoc=t,this.tableData.setExt(o),this.tableData.schemaChange().catch((e=>(0,re.reportError)(e))),e.listenTo(t,"schemaUpdateAction",(()=>this.tableData.schemaChange()))}Promise.resolve(this.lazySync()).catch((e=>(0,re.reportError)(e)))}async sync(){this._owner.isDisposed()||await this.tableData.sync()}}var Bu=o(6263),Lu=Object.defineProperty,$u=Object.defineProperties,Uu=Object.getOwnPropertyDescriptors,zu=Object.getOwnPropertySymbols,Vu=Object.prototype.hasOwnProperty,Nu=Object.prototype.propertyIsEnumerable,ju=(e,t,o)=>t in e?Lu(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;const Wu=o(61393),Hu=o(68525),Gu=o(49268),Ku=o(83116),Ju=(0,F.makeT)("WebhookPage"),Xu=[{id:"vt_webhook_fc1",colId:"tableId",type:"Choice",label:"Table"},{id:"vt_webhook_fc2",colId:"url",type:"Text",label:"URL"},{id:"vt_webhook_fc3",colId:"eventTypes",type:"ChoiceList",label:"Event Types",widgetOptions:JSON.stringify({widget:"TextBox",alignment:"left",choices:["add","update"],choiceOptions:{}})},{id:"vt_webhook_fc4",colId:"enabled",type:"Bool",label:"Enabled",widgetOptions:JSON.stringify({widget:"Switch"})},{id:"vt_webhook_fc5",colId:"isReadyColumn",type:"Text",label:"Ready Column"},{id:"vt_webhook_fc6",colId:"webhookId",type:"Text",label:"Webhook Id"},{id:"vt_webhook_fc7",colId:"name",type:"Text",label:"Name"},{id:"vt_webhook_fc8",colId:"memo",type:"Text",label:"Memo"},{id:"vt_webhook_fc9",colId:"status",type:"Text",label:"Status"}],qu=["name","memo","eventTypes","url","tableId","isReadyColumn","webhookId","enabled","status"];class Yu{constructor(e){var t;this._docApi=e,this.name="GristHidden_WebhookTable",this.initialActions=[["AddTable",t=this.name,Xu.map((e=>({isFormula:!0,type:"Any",formula:"",id:e.colId})))],["AddRecord","_grist_Tables","vt_webhook_ft1",{tableId:t,primaryViewId:0}],["BulkAddRecord","_grist_Tables_column",Xu.map((e=>e.id)),(0,pe.Iq)(Xu.map((e=>Object.assign({isFormula:!1,formula:"",widgetOptions:"",parentId:"vt_webhook_ft1"},Wu(e,["id"])))))],["AddRecord","_grist_Views_section","vt_webhook_fs1",{tableRef:"vt_webhook_ft1",parentKey:"detail",title:"",borderWidth:1,defaultWidth:100,theme:"blocks"}],["BulkAddRecord","_grist_Views_section_field",qu.map(((e,t)=>`vt_webhook_ff${t+1}`)),{colRef:qu.map((e=>Xu.find((t=>t.colId===e)).id)),parentId:qu.map((()=>"vt_webhook_fs1")),parentPos:qu.map(((e,t)=>t))}]],this.saveableFields=["tableId","url","eventTypes","enabled","name","memo","isReadyColumn"],this.webhooks=(0,Mt.observableArray)([])}async fetchAll(){const e=(await this._docApi.getWebhooks()).webhooks;this._initalizeWebhookList(e);const t=Gu(e.length);return["TableData",this.name,t.map((e=>e+1)),(0,pe.Iq)(t.map((t=>oh(e[t]))))]}async beforeEdit(e){const t=e.actions;for(const e of t)for(const t of e.stored){if(!(0,pe.q$)(t))continue;const e=new Set((0,pe.gV)(t)||[]);if(e.has("webhookId")||e.has("status"))throw new Error("Sorry, not all fields can be edited.")}const o=e.delta;for(const t of o.removeRows){const o=e.getRecord(t);o&&(await this._removeWebhook(o),(0,re.reportMessage)("Removed webhook."))}const i=new Set(o.updateRows),s=e;for(const e of i){const t=s.getRecordNew(e);(null==t?void 0:t.webhookId)&&await this._updateWebhook(String(null==t?void 0:t.webhookId),t)}}async afterEdit(e){const{delta:t}=e,o=new Set(t.updateRows),i=new Set([...t.addRows,...t.updateRows]);for(const t of i){const i=e.getRecord(t);if(!i)continue;const s=[],n={};if(i.webhookId)s.push("Updated");else try{const e=await this._addWebhook(i);n.webhookId=e,s.push("Added")}catch(e){s.push("Incomplete | "+this._getErrorString(e).replace(/^Error: /,"").replace("\n"," | "))}n.status||(n.status=s.join("\n")),o.has(t)||(n.enabled=!1),await e.patch([["UpdateRecord",this.name,t,n]])}}async sync(e){var t;const o=new Map(e.getRowIds().map((t=>[e.getRecord(t).webhookId,t]))),i=new Set(e.getRowIds()),s=[],n=(await this._docApi.getWebhooks()).webhooks;this._initalizeWebhookList(n);for(const e of n){const t=oh(e),n=o.get(e.id);n?(i.delete(n),s.push(["UpdateRecord",this.name,n,t])):s.push(["AddRecord",this.name,null,t])}for(const o of i)(null==(t=e.getRecord(o))?void 0:t.webhookId)&&s.push(["RemoveRecord",this.name,o]);await e.patch(s)}async afterAnySchemaChange(e){const t=e.gristDoc.docModel.visibleTables.all().map((e=>e.tableId()));e.gristDoc.docData.receiveAction(["UpdateRecord","_grist_Tables_column","vt_webhook_fc1",{widgetOptions:JSON.stringify({widget:"TextBox",alignment:"left",choices:t})}])}_initalizeWebhookList(e){this.webhooks.removeAll(),this.webhooks.push(...e)}_getErrorString(e){var t;return(null==(t=e.details)?void 0:t.userError)||e.message}async _addWebhook(e){const t=this._prepareFields(e),{webhookId:o}=await this._docApi.addWebhook(Wu(t,"enabled"));return o}async _updateWebhook(e,t){const o=this._prepareFields(t);Object.keys(o).length&&await this._docApi.updateWebhook({id:e,fields:o})}async _removeWebhook(e){e.webhookId&&await this._docApi.removeWebhook(String(e.webhookId),String(e.tableId))}_prepareFields(e){return(e=Hu(e,...this.saveableFields)).eventTypes&&(e.eventTypes=Ku(e.eventTypes,"L")),e}}class Zu extends Nt.G{constructor(e){super(),this.gristDoc=e,this.docApi=this.gristDoc.docPageModel.appModel.api.getDocAPI(this.gristDoc.docId()),this._webhookExternalTable=new Yu(this.docApi);const t=new Eu(this,e,this._webhookExternalTable);this.listenTo(e,"webhooks",(async()=>{await t.lazySync()}))}buildDom(){const e=this.gristDoc.docModel.viewSections.getRowModel("vt_webhook_fs1");return ul.create(this,this.gristDoc,e),th(Qu(Ju("Webhook Settings")),eh((0,ae.bigPrimaryButton)(Ju("Clear Queue"),r.dom.on("click",(()=>this.reset())),(0,i.testId)("webhook-reset"))),(0,r.dom)("div.active_section.view_data_pane_container.flexvbox",e.viewInstance().viewPane))}async reset(){await this.docApi.flushWebhooks(),(0,re.reportSuccess)("Cleared webhook queue.")}async resetSelected(e){await this.docApi.flushWebhook(e),(0,re.reportSuccess)(`Cleared webhook ${e} queue.`)}}const Qu=(0,r.styled)(os.gs,"\n  margin-bottom: 0;\n  &:not(:first-of-type) {\n    margin-top: 40px;\n  }\n"),eh=(0,r.styled)("div","\n  flex: none;\n  margin-bottom: 16px;\n  margin-top: 16px;\n  display: flex;\n  gap: 16px;\n"),th=(0,r.styled)("div",`\n  overflow-y: auto;\n  position: relative;\n  height: 100%;\n  padding: 32px 64px 24px 64px;\n\n  display: flex;\n  flex-direction: column;\n  @media ${i.mediaSmall} {\n    & {\n      padding: 32px 24px 24px 24px;\n    }\n  }\n`);function oh(e){const t=e.fields,{eventTypes:o}=t;return i=((e,t)=>{for(var o in t||(t={}))Vu.call(t,o)&&ju(e,o,t[o]);if(zu)for(var o of zu(t))Nu.call(t,o)&&ju(e,o,t[o]);return e})({},t),s={webhookId:e.id,status:JSON.stringify(e.usage),eventTypes:[Bu.w.List,...o]},$u(i,Uu(s));var i,s}var ih=o(82246);const sh=(0,F.makeT)("WelcomeTour"),nh=[{title:sh("Editing Data"),body:()=>[(0,r.dom)("p",sh("Double-click or hit {{enter}} on a cell to edit it. ",{enter:(0,ih.ShortcutKey)((0,ih.ShortcutKeyContent)(sh("Enter")))}),sh("Start with {{equal}} to enter a formula.",{equal:(0,ih.ShortcutKey)((0,ih.ShortcutKeyContent)("="))}))],selector:".field_clip",placement:"bottom"},{selector:".tour-creator-panel",title:sh("Configuring your document"),body:()=>[(0,r.dom)("p",sh("Toggle the {{creatorPanel}} to format columns, ",{creatorPanel:(0,r.dom)("em",sh("creator panel"))}),sh("convert to card view, select data, and more."))],placement:"left",cropPadding:!0},{selector:".tour-type-selector",title:sh("Customizing columns"),body:()=>[(0,r.dom)("p",sh("Set formatting options, formulas, or column types, such as dates, choices, or attachments. ")),(0,r.dom)("p",sh("Make it relational! Use the {{ref}} type to link tables. ",{ref:(0,ih.ShortcutKey)(sh("Reference"))}))],placement:"right"},{selector:".tour-add-new",title:sh("Building up"),body:()=>[(0,r.dom)("p",sh("Use {{addNew}} to add widgets, pages, or import more data. ",{addNew:(0,ih.ShortcutKey)(sh("Add New"))}))],placement:"right"},{selector:".tour-share-icon",title:sh("Sharing"),body:()=>[(0,r.dom)("p",sh("Use the Share button ({{share}}) to share the document or export data.",{share:rh(sh("Share"))}))],placement:"bottom",cropPadding:!0},{selector:".tour-help-center",title:sh("Flying higher"),body:()=>[(0,r.dom)("p",sh("Use {{helpCenter}} for documentation or questions.",{helpCenter:(0,ih.ShortcutKey)(lh("Help"),sh("Help Center"))}))],placement:"right"},{selector:".tour-welcome",title:sh("Welcome to Grist!"),body:()=>[(0,r.dom)("p",sh("Browse our {{templateLibrary}} to discover what's possible and get inspired.",{templateLibrary:(0,io.Y3)({target:"_blank",href:(0,Ys.urlState)().makeUrl({homePage:"templates"})},sh("template library"),ah("FieldLink"))}))],showHasModal:!0}],rh=(0,r.styled)(s.icon,`\n  --icon-color: ${i.theme.topBarButtonPrimaryFg};\n`),lh=(0,r.styled)(s.icon,`\n  --icon-color: ${i.theme.shortcutKeySecondaryFg};\n  margin-right: 8px;\n`),ah=(0,r.styled)(s.icon,"\n  margin: -3px 8px 0 4px;\n");var dh=o(66986),ch=o(85837),uh=Object.defineProperty,hh=Object.defineProperties,ph=Object.getOwnPropertyDescriptors,mh=Object.getOwnPropertySymbols,gh=Object.prototype.hasOwnProperty,fh=Object.prototype.propertyIsEnumerable,wh=(e,t,o)=>t in e?uh(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,bh=(e,t)=>{for(var o in t||(t={}))gh.call(t,o)&&wh(e,o,t[o]);if(mh)for(var o of mh(t))fh.call(t,o)&&wh(e,o,t[o]);return e},vh=(e,t)=>hh(e,ph(t));const yh=o(24843),_h=o(36812),xh=(0,F.makeT)("GristDoc"),Ch=(0,Ar.get)("document","window"),Sh=(0,bd.U)("none","docHistory","validations","discussion");class Ih extends Nt.G{constructor(e,t,o,s,n,l,a={}){super(),this.app=e,this.appModel=t,this.docComm=o,this.docPageModel=s,this.isReadonly=this.docPageModel.isReadonly,this.isReadonlyKo=(0,r.toKo)(Mt,this.isReadonly),this.resizeEmitter=this.autoDispose(new r.Emitter),this.fieldEditorHolder=r.Holder.create(this),this.activeEditor=r.Observable.create(this,null),this.userOrgPrefs=(0,md.getUserOrgPrefsObs)(this.docPageModel.appModel),this.behavioralPromptsManager=this.docPageModel.appModel.behavioralPromptsManager,this.maximizedSectionId=r.Observable.create(this,null),this.viewLayout=null,this.formulaPopup=r.Holder.create(this),this.currentTheme=this.docPageModel.appModel.currentTheme,this._lastOwnActionGroup=null,this._rightPanelTabs=new Map,this._rightPanelTool=(0,Pl.h4)(this,"rightPanelTool","none",Sh.guard),this._showGristTour=(0,md.getUserOrgPrefObs)(this.userOrgPrefs,"showGristTour"),this._seenDocTours=(0,md.getUserOrgPrefObs)(this.userOrgPrefs,"seenDocTours"),this._rawSectionOptions=r.Observable.create(this,null),this._docTutorialHolder=r.Holder.create(this),this._isRickRowing=r.Observable.create(this,!1),this._showBackgroundVideoPlayer=r.Observable.create(this,!1),this._backgroundVideoPlayerHolder=r.Holder.create(this),this._disableAutoStartingTours=!1,console.log("RECEIVED DOC RESPONSE",n),this.docData=new Hl(this.docComm,n.doc),this.docModel=new cd(this.docData,this.docPageModel),this.querySetManager=pd.QuerySetManager.create(this,this.docModel,this.docComm),this.docPluginManager=new Ol(l,e.topAppModel.getUntrustedContentOrigin(),this.docComm,e.clientScope),this.docInfo=this.docModel.docInfoRow;const d=this.docInfo.newDefaultViewId;this.activeViewId=r.Computed.create(this,(e=>{const{docPage:t}=e((0,Ys.urlState)().state);return"string"==typeof t&&"GristDocTour"!==t&&Jt.VP.guard(t)?t:this.docModel.views.tableData.findRow("GristDocTour"===t?"name":"id",t)||e(d)})),this._activeContent=r.Computed.create(this,(e=>{var t;return null!=(t=e(this._rawSectionOptions))?t:e(this.activeViewId)})),this.externalSectionId=r.Computed.create(this,(e=>{const t=e(this._rawSectionOptions);return t?e(t.viewSection.id):null})),this.viewModel=this.autoDispose(this.docModel.views.createFloatingRowModel((0,r.toKo)(Mt,this.activeViewId))),this.autoDispose(this.viewModel.activeSectionId.subscribe((e=>{var t,o;e!==this.maximizedSectionId.get()&&(this.maximizedSectionId.set(null),(null==(t=this.viewLayout)?void 0:t.isDisposed())||null==(o=this.viewLayout)||o.maximized.set(null))}))),this.currentPageName=r.Computed.create(this,this.activeViewId,((e,t)=>"number"==typeof t?e(this.viewModel.name):t)),this.autoDispose(this.viewModel._isDeleted.subscribe((e=>{e&&Promise.resolve().then((()=>(0,Ys.urlState)().pushUrl({docPage:void 0}))).catch((()=>null))}))),this.autoDispose((0,r.subscribe)((0,Ys.urlState)().state,(async(e,t)=>{if(t.hash)try{if(t.hash.popup)await this.openPopup(t.hash);else{const e=this._getCursorPosFromHash(t.hash);await this.recursiveMoveToCursorPos(e,!0)}const e=qd()||this.docModel.isTutorial();!t.hash.rickRow||this._isRickRowing.get()||e||(dh.D.create(this._backgroundVideoPlayerHolder,"dQw4w9WgXcQ",{height:"100%",width:"100%",origin:(0,Ys.getMainOrgUrl)(),playerVars:{controls:0,disablekb:1,fs:0,iv_load_policy:3,modestbranding:1},onPlayerStateChange:(e,t)=>{t.data===dh.f.Playing&&this._isRickRowing.set(!0)}},Mh.cls("")),this._showBackgroundVideoPlayer.set(!0),this._waitForView().then((()=>{const e=document.querySelector(".selected_cursor.active_cursor");e&&this.behavioralPromptsManager.showTip(e,"rickRow",{forceShow:!0,hideDontShowTips:!0,markAsSeen:!1,showOnMobile:!0,onDispose:()=>this.playRickRollVideo()})})).catch(Oo.eK))}catch(e){(0,Oo.eK)(e)}finally{setTimeout(Dh,0)}}))),this.docModel.isTutorial()&&this.behavioralPromptsManager.disable();let c=!1;this.autoDispose((0,r.subscribe)((0,Ys.urlState)().state,(async(e,t)=>{var o,s;if("singlePage"===(null==(o=t.params)?void 0:o.style))return;const n=this.docModel.isTutorial();if((0,i.isNarrowScreen)()&&!n)return;(null==(s=t.hash)?void 0:s.rickRow)&&(this._disableAutoStartingTours=!0);const r=qd()||!this._docTutorialHolder.isEmpty();if(c||r)return;const l=n,a=t.docTour||this._shouldAutoStartDocTour(),d=t.welcomeTour||this._shouldAutoStartWelcomeTour();if(l||a||d){c=!0;try{if(await this._waitForView(),await(0,Ys.urlState)().pushUrl({welcomeTour:!1,docTour:!1},{replace:!0,avoidReload:!0}),l)await Gc.create(this._docTutorialHolder,this).start();else if(a){const e=()=>{var e;return!(null==(e=this._seenDocTours.get())?void 0:e.includes(this.docId()))&&(0,md.markAsSeen)(this._seenDocTours,this.docId())};await _c(this.docData,this.docComm,e)}else u=()=>this._showGristTour.set(!1),Gt.allCommands.fieldTabOpen.run(),Xd(nh,u)}finally{c=!1}}var u})));const u=e=>{const t=fo.create(this,e,!0);return e.viewInstance(t),t.autoDisposeCallback((()=>e.viewInstance(null))),t},h=Al.j.fromArray(this.docPluginManager.pluginsList),p=[{label:xh("Import from file"),action:()=>async function(e,t){let o=null;const i=await(0,Po.y)({multiple:!0});await e.forkIfNeeded();const s=i.map((e=>e.name)).join(", "),n=i.reduce(((e,t)=>e+t.size),0),r=e.app.topAppModel.appObs.get(),l=r?r.notifier.createProgressIndicator(s,(0,P.byteString)(n)):null,a=e=>l&&l.setProgress(e);try{a(0),o=await(0,Mo.IL)(i,{docWorkerUrl:e.docComm.docWorkerUrl,sizeLimit:"import"},a),a(100)}finally{l&&l.dispose()}await Yo.create(null,e,null,t).pickAndUploadSource(o)}(this,u)},...h.map((e=>({label:e.importSource.label,action:()=>async function(e,t,o,i){try{await Yo.create(null,e,o,i).pickAndUploadSource(null)}catch(s){if(s instanceof Zo){const n=t.find((e=>"builtIn/gdrive"===e.plugin.definition.id&&e!==o));if(n)try{await Yo.create(null,e,n,i).pickAndUploadSource(null)}catch(e){(0,Oo.eK)(e)}else(0,Oo.eK)(s)}else(0,Oo.eK)(s)}}(this,h,e,u)})))];this.docPageModel.importSources=p,this._actionLog=this.autoDispose(zt.create({gristDoc:this})),this._undoStack=this.autoDispose(Rl.create(n.log,{gristDoc:this})),this._docHistory=Ad.create(this,this.docPageModel,this._actionLog),this._discussionPanel=ch.un.create(this,this),this.autoDispose(this.docData.sendActionsEmitter.addListener(this._onSendActionsStart,this)),this.autoDispose(this.docData.sendActionsDoneEmitter.addListener(this._onSendActionsEnd,this)),this.autoDispose(Gt.createGroup({undo(){this._undoStack.sendUndoAction().catch(Oo.eK)},redo(){this._undoStack.sendRedoAction().catch(Oo.eK)},reloadPlugins(){this.docComm.reloadPlugins().then((()=>Ch.window.location.reload(!1)))},setCursor:this.onSetCursorPos.bind(this)},this,!0)),this.listenTo(e.comm,"docUserAction",this.onDocUserAction),this.listenTo(e.comm,"docUsage",this.onDocUsageMessage),this.listenTo(e.comm,"docChatter",this.onDocChatter),this._handleTriggerQueueOverflowMessage(),this.autoDispose(eo.create({gristDoc:this})),this.rightPanelTool=r.Computed.create(this,(e=>this._getToolContent(e(this._rightPanelTool)))),this.comparison=a.comparison||null,this.autoDispose(r.dom.onElem(window,"dragover",(e=>e.preventDefault()))),this.autoDispose(r.dom.onElem(window,"drop",(e=>e.preventDefault()))),this.autoDispose(r.dom.onElem(window,"resize",(()=>this.resizeEmitter.emit()))),this.currentView=r.Observable.create(this,null);const m=(0,r.fromKo)(this.autoDispose(Mt.pureComputed((()=>{const e=(0,r.toKo)(Mt,this.activeViewId)();if(!(0,Jt.NZ)(e))return null;const t=this.viewModel.activeSection();return(null==t?void 0:t.isDisposed())?null:t.viewInstance()}))));this.autoDispose(m.addListener((async e=>{e&&await e.getLoadingDonePromise(),(null==e?void 0:e.isDisposed())||this.currentView.set(e)}))),this.cursorPosition=r.Computed.create(this,(e=>{const t=e(this.currentView);if(!t)return;const o=e(this.activeViewId);if(!(0,Jt.NZ)(o))return;const i=e(t.cursor.currentPosition);return i?vh(bh({},i),{viewId:o}):void 0})),this.hasCustomNav=r.Computed.create(this,(0,Ys.urlState)().state,((e,t)=>{const o=t.hash;return!(!o||void 0===(0,P.undef)(o.colRef,o.rowId,o.sectionId))})),this.draftMonitor=no.create(this,this),this.cursorMonitor=Xt.create(this,this),this.editorMonitor=mo.create(this,this),this.autoDispose(this.viewModel.activeSection.subscribe((e=>{e.isDisposed()||e._isDeleted.peek()||["chart","custom"].includes(e.parentKey.peek())&&Gt.allCommands.viewTabFocus.run()})))}get docApi(){return this.docPageModel.appModel.api.getDocAPI(this.docPageModel.currentDocId.get())}docId(){return this.docPageModel.currentDocId.get()}addOptionsTab(e,t,o,i){return this._rightPanelTabs.set(e,o),{dispose:()=>null}}buildDom(){const e=r.Computed.create(this,(e=>null!==e(this.maximizedSectionId))),t=r.Computed.create(this,(t=>["data","settings"].includes(t(this.activeViewId))||t(e)||"object"==typeof t(this._activeContent)));return Rh((0,i.testId)("gristdoc"),Rh.cls("-contents",t),r.dom.maybe(this._isRickRowing,(()=>Oh(Ah("CrossBig"),r.dom.on("click",(()=>{this._isRickRowing.set(!1),this._showBackgroundVideoPlayer.set(!1)})),(0,i.testId)("gristdoc-stop-rick-rowing")))),r.dom.domComputed(this._activeContent,(e=>"code"===e?r.dom.create(Ht,this):"acl"===e?r.dom.create(Re,this):"data"===e?r.dom.create(vl,this):"settings"===e?r.dom.create(uu,this):"webhook"===e?r.dom.create(Zu,this):"GristDocTour"===e?null:"object"==typeof e?r.dom.create((t=>(t.autoDispose(this.activeViewId.addListener(e.close)),e.viewSection.autoDispose({dispose:e.close}),r.dom.create(yl,this,e.viewSection,e.close)))):r.dom.create((t=>(this.viewLayout=hl.create(t,this,e),this.viewLayout.maximized.addListener((e=>this.maximizedSectionId.set(e))),t.onDispose((()=>this.viewLayout=null)),this.viewLayout))))),r.dom.maybe(this._showBackgroundVideoPlayer,(()=>{var e;return[kh(null==(e=this._backgroundVideoPlayerHolder.get())?void 0:e.buildDom(),kh.cls("-fade-in-and-out",this._isRickRowing),(0,i.testId)("gristdoc-background-video"))]})))}openDocPage(e){return(0,Ys.urlState)().pushUrl({docPage:e})}showTool(e){this._rightPanelTool.set(e)}getCursorPos(){const e={sectionId:this.viewModel.activeSectionId()},t=this.viewModel.activeSection.peek().viewInstance.peek();return Object.assign(e,t?t.cursor.getCursorPos():{})}async onSetCursorPos(e,t){return this.setCursorPos({rowIndex:(null==e?void 0:e._index())||0,fieldIndex:(null==t?void 0:t._index())||0,sectionId:null==t?void 0:t.viewSection().getRowId()})}async setCursorPos(e){if(e.sectionId&&e.sectionId!==this.externalSectionId.get()){const t=this.docModel.viewSections.getRowModel(e.sectionId);if(!t.id.peek())return;if(!t.parentId.peek()&&!t.isRaw.peek()){const o=t.viewInstance.peek();if(o&&!o.isDisposed())return void o.setCursorPos(e)}t.view.peek().getRowId()!==this.activeViewId.get()?await this._switchToSectionId(e.sectionId):t!==this.viewModel.activeSection.peek()&&this.viewModel.activeSectionId(e.sectionId)}const t=this.viewModel.activeSection.peek().viewInstance.peek();null==t||t.setCursorPos(e)}async moveToCursorPos(e,t){if(e&&e.sectionId)try{await this.setCursorPos(e)}catch(e){(0,Oo.eK)(e)}}onDocUserAction(e){console.log("GristDoc.onDocUserAction",e);let t=!1;if(e.data.error)(0,Oo.eK)(new Error(e.data.error));else if(this.docComm.isActionFromThisDoc(e)){const o=e.data.docActions;for(let e=0,i=o.length;e<i;e++)console.log("GristDoc applying #%d",e,o[e]),this.docData.receiveAction(o[e]),this.docPluginManager.receiveAction(o[e]),!t&&(0,pe.ZX)(o[e])&&(t=!0);const i=e.data.actionGroup;i.fromSelf=e.fromSelf||!1,i.internal||(this._actionLog.pushAction(i),this._undoStack.pushAction(i),i.fromSelf&&(this._lastOwnActionGroup=i)),t&&this.trigger("schemaUpdateAction",o),this.docPageModel.updateCurrentDocUsage(e.data.docUsage),this.trigger("onDocUserAction",o)}}getUndoStack(){return this._undoStack}onDocUsageMessage(e){this.docComm.isActionFromThisDoc(e)&&(0,r.bundleChanges)((()=>{var t;this.docPageModel.updateCurrentDocUsage(e.data.docUsage),this.docPageModel.currentProduct.set(null!=(t=e.data.product)?t:null)}))}onDocChatter(e){this.docComm.isActionFromThisDoc(e)&&e.data.webhooks&&("webhookOverflowError"==e.data.webhooks.type?this.trigger("webhookOverflowError",xh("New changes are temporarily suspended. Webhooks queue overflowed. Please check webhooks settings, remove invalid webhooks, and clean the queue.")):this.trigger("webhooks",e.data.webhooks))}getTableModel(e){return this.docModel.dataTables[e]}getTableModelMaybeWithDiff(e){var t;const o=this.getTableModel(e);return(null==(t=this.comparison)?void 0:t.details)?new Fl.DataTableModelWithDiff(o,this.comparison.details):o}async addEmptyTable(){const e=await this._promptForName();if(void 0===e)return;const t=await this.docData.sendAction(["AddEmptyTable",e||null]);await this.openDocPage(this.docModel.tables.getRowModel(t.id).primaryViewId())}async addWidgetToPage(e){const t=this.docModel.docData,o=this.viewModel.name.peek();let i;if("New Table"===e.table&&(i=await this._promptForName(),void 0===i))return;const s=await t.bundleActions(xh("Added new linked section to view {{viewName}}",{viewName:o}),(()=>this.addWidgetToPageImpl(e,null!=i?i:null)));this.viewModel.activeSectionId(s.sectionRef),this._maybeShowEditCardLayoutTip(e.type).catch(Oo.eK)}async addWidgetToPageImpl(e,t=null){const o=this.activeViewId.get(),i="New Table"===e.table?0:e.table,s=await this.docData.sendAction(["CreateViewSection",i,o,e.type,e.summarize?e.columns:null,t]);return"chart"===e.type&&await this._ensureOneNumericSeries(s.sectionRef),await this.saveLink(e.link,s.sectionRef),s}async addNewPage(e){if("New Table"===e.table){const e=await this._promptForName();if(void 0===e)return;const t=await this.docData.sendAction(["AddEmptyTable",e]);await this.openDocPage(t.views[0].id)}else{let t;await this.docData.bundleActions("Add new page",(async()=>{t=await this.docData.sendAction(["CreateViewSection",e.table,0,e.type,e.summarize?e.columns:null,null]),"chart"===e.type&&await this._ensureOneNumericSeries(t.sectionRef)})),await this.openDocPage(t.viewRef),this.viewModel.activeSectionId(t.sectionRef),this._maybeShowEditCardLayoutTip(e.type).catch(Oo.eK)}}async uploadNewTable(){const e=await(0,Mo.lX)({docWorkerUrl:this.docComm.docWorkerUrl,multiple:!0});if(e){const t={uploadId:e.uploadId,transforms:[]},o=(await this.docComm.finishImportFiles(t,[],{})).tables[0].hiddenTableId,i=this.docModel.dataTables[o].tableMetaRow;await this.openDocPage(i.primaryViewId())}}async saveViewSection(e,t){const o=this.docModel.docData,i=(0,vu.FU)(e),s=e.view(),n=e.viewFields().all().map((e=>e.column().colId()));return _h(i,t)?e:await this.viewLayout.freezeUntil(o.bundleActions(xh("Saved linked section {{title}} in view {{name}}",{title:e.title(),name:s.name()}),(async()=>i.table!==t.table||i.summarize!==t.summarize?await this._replaceViewSection(e,i,t):(i.type!==t.type&&await e.parentKey.saveOnly(t.type),_h(i.columns,t.columns)||(await o.sendAction(["UpdateSummaryViewSection",e.getRowId(),t.columns]),"chart"===t.type&&"chart"===i.type&&await this.setSectionViewFieldsFromArray(e,n)),i.link!==t.link&&await this.saveLink(t.link),e)),{nestInActiveBundle:!0}))}async setSectionViewFieldsFromArray(e,t){await Promise.all(e.viewFields.peek().all().map((e=>this.docModel.viewFields.sendTableAction(["RemoveRecord",e.id()]))));const o=new Map;for(const t of e.table().columns().all())o.set(t.colId(),t);t.length&&(e.optionsObj.prop("multiseries")()?(o.has(t[0])||await e.optionsObj.prop("multiseries").saveOnly(!1),t.length>1&&!o.has(t[1])&&await e.optionsObj.prop("isXAxisUndefined").saveOnly(!0)):o.has(t[0])||await e.optionsObj.prop("isXAxisUndefined").saveOnly(!0)),await Promise.all(t.map(((t,i)=>{if(!o.has(t))return;const s=["AddRecord",null,{parentId:e.id(),colRef:o.get(t).id(),parentPos:i}];return this.docModel.viewFields.sendTableAction(s)})))}async saveLink(e,t){t=t||this.viewModel.activeSection.peek().getRowId();const o=(0,ja.pS)(e);if(o.targetColRef){const e=this.docModel.viewSections.getRowModel(t).table(),i=this.docModel.columns.getRowModel(o.targetColRef);e.id()!==i.table().id()&&(o.targetColRef=e.columns().all().find((e=>e.summarySourceCol()===o.targetColRef)).id())}return this.docData.sendAction(["UpdateRecord","_grist_Views_section",t,{linkSrcSectionRef:o.srcSectionRef,linkSrcColRef:o.srcColRef,linkTargetColRef:o.targetColRef}])}selectBy(e){const t=this.viewModel.viewSections.peek().peek();return(0,ja.Kg)(this.docModel,t,e)}async forkIfNeeded(){this.docPageModel.isPrefork.get()&&await this.docComm.forkAndUpdateUrl()}async clearColumns(e,{keepType:t}={}){await this.docModel.columns.sendTableAction(["BulkUpdateRecord",e,vh(bh({isFormula:e.map((e=>!0)),formula:e.map((e=>""))},t?{}:{type:e.map((e=>"Any")),widgetOptions:e.map((e=>"")),visibleCol:e.map((e=>null)),displayCol:e.map((e=>null)),rules:e.map((e=>null))}),{recalcWhen:e.map((e=>ge.RecalcWhen.DEFAULT)),recalcDeps:e.map((e=>null))})])}async convertIsFormula(e,t){return this.docModel.columns.sendTableAction(["BulkUpdateRecord",e,{isFormula:e.map((e=>t.toFormula)),recalcWhen:e.map((e=>t.noRecalc?ge.RecalcWhen.NEVER:ge.RecalcWhen.DEFAULT)),recalcDeps:e.map((e=>null))}])}async updateFormula(e,t){return this.docModel.columns.sendTableAction(["UpdateRecord",e,{formula:t}])}async convertToFormula(e,t){return this.docModel.columns.sendTableAction(["UpdateRecord",e,{isFormula:!0,formula:t,recalcWhen:ge.RecalcWhen.DEFAULT,recalcDeps:null}])}async convertToTrigger(e,t){return this.docModel.columns.sendTableAction(["UpdateRecord",e,{isFormula:!1,formula:t,recalcWhen:ge.RecalcWhen.DEFAULT,recalcDeps:null}])}getCsvLink(){const e=this._getDocApiDownloadParams();return this.docPageModel.appModel.api.getDocAPI(this.docId()).getDownloadCsvUrl(e)}getXlsxActiveViewLink(){const e=this._getDocApiDownloadParams();return this.docPageModel.appModel.api.getDocAPI(this.docId()).getDownloadXlsxUrl(e)}hasGranularAccessRules(){const e=this.docData.getMetaTable("_grist_ACLRules");return e.numRecords()>e.filterRowIds({permissionsText:"",permissions:63}).length}async recursiveMoveToCursorPos(e,t,o=!1){try{if(!e.sectionId)throw new Error("sectionId required");if(!e.rowId)throw new Error("rowId required");const i=this.docModel.viewSections.getRowModel(e.sectionId);if(!i.id.peek())throw new Error(`Section ${e.sectionId} does not exist`);const s=i.linkSrcSection.peek();if(s.id.peek()){const t=i.linkTargetCol.peek();let n;n=t.colId.peek()?(await this._getTableData(i)).getValue(e.rowId,t.colId.peek()):e.rowId;const r=i.linkSrcCol.peek().colId.peek();let l;const a=s.table.peek().summarySource.peek().id.peek();if(r||a){const t=await this._getTableData(s),o={tableId:t.tableId,filters:{},operations:{}};if(r)o.operations[r]=(0,ge.isRefListType)(i.linkSrcCol.peek().type.peek())?"intersects":"in",o.filters[r]=(0,ge.isList)(n)?n.slice(1):[n];else{const t=await this._getTableData(i);for(const i of s.table.peek().groupByColumns.peek()){const s=i.summarySource.peek(),r=s.colId.peek();n=t.getValue(e.rowId,r),o.operations[r]=(0,ge.isListType)(s.type.peek())&&!n?"empty":"in",o.filters[r]=(0,ge.isList)(n)?n.slice(1):[n]}}l=t.getRowIds().find((0,pd.getFilterFunc)(this.docData,o))}else(0,ge.isList)(n)&&(n=n[1]),l=n;if(!l||"number"!=typeof l)throw new Error("cannot trace rowId");await this.recursiveMoveToCursorPos({rowId:l,sectionId:s.id.peek()},!1,o)}const n=i.view.peek(),r=i.isRaw.peek()?"data":n.getRowId();r!=this.activeViewId.get()&&await this.openDocPage(r),t&&n.activeSectionId(e.sectionId);const l=e.fieldIndex,a=await(0,P.waitObs)(i.viewInstance);if(!a)throw new Error("view not found");return await(0,Wd.g)(0),a.setCursorPos(vh(bh({},e),{fieldIndex:l})),await(0,Wd.g)(0),!0}catch(t){if(console.debug(`_recursiveMoveToCursorPos(${JSON.stringify(e)}): ${t}`),!o)throw new re.UserError("There was a problem finding the desired cell.");return!1}}async activateEditorAtCursor(e){const t=await this._waitForView();null==t||t.activateEditorAtCursor(e)}async renameTable(e,t){const o=this.docModel.visibleTables.all().find((t=>t.tableId.peek()===e));if(!o)throw new re.UserError(`No table with id ${e}`);await o.tableName.saveOnly(t)}async openPopup(e){var t;if(!e.sectionId)return;if(this.viewModel.viewSections.peek().peek().some((t=>t.id.peek()===e.sectionId))){if(this.viewLayout&&(this.viewLayout.previousSectionId=this.viewModel.activeSectionId.peek()),this.viewModel.activeSectionId(e.sectionId),e.colRef&&e.rowId){const t=this.viewModel.activeSection.peek(),o=t.viewFields.peek().all().findIndex((t=>t.colRef.peek()===e.colRef));if(o>=0){const i=await this._waitForView(t);null==i||i.setCursorPos({rowId:e.rowId,fieldIndex:o})}}return void(null==(t=this.viewLayout)||t.maximized.set(e.sectionId))}const o=this.viewModel.activeSection.peek();this.viewModel.activeSectionId(e.sectionId);const i=this.viewModel.activeSection.peek();if(i.hasFocus(!0),this._rawSectionOptions.set({hash:e,viewSection:i,close:()=>{this._rawSectionOptions.get()&&(i!==o&&(i.isDisposed()||i.hasFocus(!1),o.isDisposed()||o.hasFocus(!0)),this._rawSectionOptions.set(null))}}),e.colRef&&e.rowId){const t=i.viewFields.peek().all().findIndex((t=>t.colRef.peek()===e.colRef));if(t>=0){const o=await this._waitForView(i);null==o||o.setCursorPos({rowId:e.rowId,fieldIndex:t})}}}async playRickRollVideo(){const e=this._backgroundVideoPlayerHolder.get();if(!e)return;await e.isLoaded(),e.play();const t=async(t,o,i)=>{let s;const n=t<=o?()=>s<=o:()=>s>=o,r=t<=o?()=>s+=i:()=>s-=i;for(s=t;n();r())e.setVolume(s),await(0,Wd.g)(250)};await t(0,100,5),await(0,Wd.g)(19e4),this._isRickRowing.get()&&(await t(100,0,5),this._isRickRowing.set(!1),this._showBackgroundVideoPlayer.set(!1))}async _waitForView(e){const t=null!=e?e:this.viewModel.activeSection.peek();if(!t.getRowId())return null;async function o(e){return await(0,P.waitObs)(t.viewInstance,(e=>Boolean(e&&!e.isDisposed())))}let i=await o();return i.isDisposed()&&(e&&(i=await o()),i.isDisposed())?null:(await i.getLoadingDonePromise(),await(0,Wd.g)(0),i)}_getToolContent(e){switch(e){case"docHistory":return{icon:"Log",label:"Document History",content:this._docHistory};case"validations":{const e=this._rightPanelTabs.get("Validate Data");return e?{icon:"Validation",label:"Validation Rules",content:e}:null}case"discussion":return{icon:"Chat",label:this._discussionPanel.buildMenu(),content:this._discussionPanel};default:return null}}async _maybeShowEditCardLayoutTip(e){if(!["single","detail"].includes(e)||this.behavioralPromptsManager.hasSeenTip("editCardLayout"))return;Gt.allCommands.viewTabOpen.run(),await Gt.allCommands.rightPanelOpen.run();const t=document.querySelector(".behavioral-prompt-edit-card-layout");if(!t)throw new Error("GristDoc failed to find edit card layout button");this.behavioralPromptsManager.showTip(t,"editCardLayout",{popupOptions:{placement:"left-start"}})}async _promptForName(){return await(0,wo.invokePrompt)("Table name","Create","","Default table name")}async _replaceViewSection(e,t,o){const i=this.docModel,s=e.view(),n=this.docModel.docData,r=e.options(),l=e.viewFields().all().map((e=>e.column().colId())),a=e.chartType(),d=e.theme(),c=this.viewLayout.layoutSpec(),u=e.title(),h=e.id(),p=await this.addWidgetToPageImpl(o),m=i.viewSections.getRowModel(p.sectionRef);await m.title.saveOnly(u);const g=yh(c,(e=>{if("object"==typeof e&&e.leaf===h)return vh(bh({},e),{leaf:m.id()})}));return await s.layoutSpec.saveOnly(JSON.stringify(g)),await m.options.saveOnly(r),"chart"===t.type&&"chart"===o.type&&await this.setSectionViewFieldsFromArray(m,l),await m.theme.saveOnly(d),await m.chartType.saveOnly(a),this.viewModel.activeSectionId(m.getRowId()),await n.sendAction(["RemoveViewSection",h]),m}_onSendActionsStart(e){this._lastOwnActionGroup=null,e.cursorPos=this.getCursorPos()}_onSendActionsEnd(e){const t=this._lastOwnActionGroup;t&&(t.cursorPos=e.cursorPos,t.rowIdHint&&(t.cursorPos.rowId=t.rowIdHint))}_getDocApiDownloadParams(){const e=this.viewModel.activeSection(),t=e.activeFilters.get().map((e=>({colRef:e.fieldOrColumn.origCol().origColRef(),filter:e.filter()}))),o=e.linkingFilter();return{viewSection:this.viewModel.activeSectionId(),tableId:e.table().tableId(),activeSortSpec:JSON.stringify(e.activeSortSpec()),filters:JSON.stringify(t),linkingFilter:JSON.stringify(o)}}async _switchToSectionId(e){const t=this.docModel.viewSections.getRowModel(e);if(t.isRaw.peek())await(0,Ys.urlState)().pushUrl({docPage:"data"}),this.viewModel.activeSectionId(e);else if(t.isVirtual.peek())await(0,Ys.urlState)().pushUrl({docPage:"webhook"}),this.viewModel.activeSectionId(e);else{const o=t.view.peek();await this.openDocPage(o.getRowId()),o.activeSectionId(e)}return(0,P.waitObs)(t.viewInstance)}async _getTableData(e){const t=await(0,P.waitObs)(e.viewInstance);if(!t)throw new Error("view not found");await t.getLoadingDonePromise();const o=this.docData.getTable(e.table.peek().tableId.peek());if(!o)throw new Error("no section table");return o}_getCursorPosFromHash(e){const t={rowId:e.rowId,sectionId:e.sectionId};if(null!=t.sectionId&&void 0!==e.colRef){const o=this.docModel.viewSections.getRowModel(t.sectionId).viewFields.peek().all().findIndex((t=>t.colRef.peek()==e.colRef));o>=0&&(t.fieldIndex=o)}return t}_shouldAutoStartDocTour(){var e;return!this._disableAutoStartingTours&&!this.docModel.isTutorial()&&this.docModel.hasDocTour()&&!(null==(e=this._seenDocTours.get())?void 0:e.includes(this.docId()))}_shouldAutoStartWelcomeTour(){var e,t;if(this._disableAutoStartingTours||this.docModel.isTutorial()||this.docModel.hasDocTour())return!1;const o=this.docPageModel.appModel;return!(!(null==(e=o.currentOrg)?void 0:e.owner)||this.isReadonly.get())&&(null!=(t=this._showGristTour.get())?t:!o.currentValidUser)}async _ensureOneNumericSeries(e){const t=this.docModel.viewSections.getRowModel(e);if(1===t.viewFields.peek().peek().length)return;const o=t.viewFields.peek().peek()[1];if((0,Vt.isNumericOnly)(t.chartTypeDef.peek())&&!(0,Vt.isNumericLike)(o.column.peek())){const e=[];e.push(["RemoveRecord",o.id.peek()]);const i=t.hiddenColumns.peek().find((e=>(0,Vt.isNumericLike)(e)));if(i){const o={parentId:t.id.peek(),colRef:i.id.peek()};e.push(["AddRecord",null,o])}await this.docModel.viewFields.sendTableActions(e)}}_handleTriggerQueueOverflowMessage(){this.listenTo(this,"webhookOverflowError",(e=>{this.app.topAppModel.notifier.createNotification({message:e.toString(),canUserClose:!1,level:"error",badgeCounter:!0,expireSec:5,key:"webhookOverflowError",actions:[{label:xh("go to webhook settings"),action:async()=>{await(0,Ys.urlState)().pushUrl({docPage:"webhook"})}}]})}))}}async function Dh(){await(0,Ys.urlState)().pushUrl({hash:{}},{replace:!0}),(0,ts.setTestState)({anchorApplied:!0})}const Rh=(0,r.styled)("div",`\n  --view-content-page-margin: 12px;\n  flex: auto;\n  display: flex;\n  flex-direction: column;\n  overflow: visible;\n  position: relative;\n  min-width: 240px;\n  margin: var(--view-content-page-margin, 12px);\n  @media ${i.mediaSmall} {\n    & {\n      margin: 4px;\n    }\n  }\n  @media print {\n    & {\n      margin: 0px;\n    }\n  }\n  &-contents {\n    margin: 0px;\n    overflow: hidden;\n  }\n`),Th=(0,r.keyframes)("\n  0% {\n    opacity: 0.01;\n  }\n  5%, 95% {\n    opacity: 0.2;\n  }\n  100% {\n    opacity: 0.01;\n  }\n"),kh=(0,r.styled)("div",`\n  position: fixed;\n  top: 0;\n  right: 0;\n  height: 100%;\n  width: 100%;\n  opacity: 0;\n  pointer-events: none;\n\n  &-fade-in-and-out {\n    animation: ${Th} 200s;\n  }\n`),Mh=(0,r.styled)("div",`\n  position: absolute;\n  width: 450%;\n  height: 450%;\n  top: -175%;\n  left: -175%;\n\n  @media ${i.mediaXSmall} {\n    & {\n      width: 450%;\n      height: 450%;\n      top: -175%;\n      left: -175%;\n    }\n  }\n`),Oh=(0,r.styled)("div",`\n  position: fixed;\n  top: 0;\n  right: 0;\n  padding: 8px;\n  margin: 16px;\n  border-radius: 24px;\n  background-color: ${i.theme.toastBg};\n  cursor: pointer;\n`),Ah=(0,r.styled)(s.icon,`\n  height: 24px;\n  width: 24px;\n  --icon-color: ${i.theme.toastControlFg};\n`)},87346:(e,t,o)=>{"use strict";o.r(t),o.d(t,{Layout:()=>f,LayoutBox:()=>m});var i=o(81294),s=o.n(i),n=o(13988),r=o.n(n),l=o(92979),a=o(88438),d=o(20543),c=o.n(d),u=o(86277),h=o(29301),p=o(54156);class m extends a.Disposable{constructor(){super(...arguments),this.dom=null}create(e){this.layout=e,this.parentBox=(0,h.observable)(null),this.childBoxes=r()(),this.leafId=(0,h.observable)(null),this.leafContent=(0,h.observable)(null),this.uniqueId=(0,p.uniqueId)("lb"),this.isVBox=this.autoDispose((0,h.computed)((()=>!this.parentBox()||!this.parentBox().isVBox()),this)),this.isHBox=this.autoDispose((0,h.computed)((()=>!this.isVBox()))),this.isLeaf=this.autoDispose((0,h.computed)((()=>null!==this.leafId()),this)),this.isMaximized=this.autoDispose(h.pureComputed((()=>{var e;const t=null==(e=this.layout)?void 0:e.maximizedLeaf();return!!t&&(t===this.leafId()||this.childBoxes.all().some((function(e){return e.isMaximized()})))}),this)),this.isHidden=this.autoDispose(h.pureComputed((()=>{var e;return!!(null==(e=this.layout)?void 0:e.maximizedLeaf())&&!this.isMaximized()}),this)),this.flexSize=(0,h.observable)(100),this.dom=null,this._parentBeingDisposed=!1,this.autoDisposeCallback((()=>{this._parentBeingDisposed||this.removeFromParent(),this.childBoxes.peek().forEach((function(e){e._parentBeingDisposed=!0,e.dispose()}))}))}getDom(){return this.dom||(this.dom=this.autoDispose(this.buildDom()))}maximize(){this.layout.maximizedLeaf.peek()!==this.leafId.peek()?this.layout.maximizedLeaf(this.leafId()):this.layout.maximizedLeaf(null)}buildDom(){const e=this,t=this.layout.needDynamic?p.identity:g;return s()("div.layout_box",(0,l.toggleClass)("layout_leaf",t(this.isLeaf)),(0,l.toggleClass)("layout_hidden",this.isHidden),(0,l.toggleClass)(this.layout.leafId,t(this.isLeaf)),(0,l.cssClass)(t((function(){return e.isVBox()?"layout_vbox":"layout_hbox"}))),(0,l.cssClass)(t((function(){return e.layout.fillWindow?"layout_fill_window":e.isLastChild()?"layout_last_child":null}))),(0,l.style)("--flex-grow",t((function(){return e.isVBox()||e.isHBox()&&e.layout.fillWindow?e.flexSize():""}))),(0,l.domData)("layoutBox",this),(0,l.foreach)(t(this.childBoxes),(function(e){return e.getDom()})),(0,l.scope)(t(this.leafContent),(function(e){return e})))}takeLeafFrom(e){this.leafId(e.leafId.peek()),this.leafContent((0,i.detachNode)(e.leafContent.peek())),e.leafId(null),e.leafContent(null)}setChildren(e){e.forEach((e=>e.parentBox(this))),this.childBoxes.assign(e)}isFirstChild(){return!this.parentBox()||this.parentBox().childBoxes.peek()[0]===this}isLastChild(){return!this.parentBox()||(0,p.last)(this.parentBox().childBoxes.all())===this}isDomDetached(){return!(this.dom&&this.dom.parentNode)}getSiblingBox(e){if(!this.parentBox())return null;const t=this.parentBox().childBoxes.peek();let o=t.indexOf(this);return o<0?null:(o+=e?1:-1,o<0||o>=t.length?null:t[o])}_addChild(e,t,o){let i;c()(null===e.parentBox(),"LayoutBox._addChild: child already has parentBox set"),i=o?this.childBoxes.peek().indexOf(o)+(t?1:0):t?this.childBoxes.peekLength:0,e.parentBox(this),this.childBoxes.splice(i,0,e)}addSibling(e,t){e.removeFromParent();const o=this.parentBox();if(o)o._addChild(e,t,this);else if(1===this.childBoxes.peekLength){const o=this.childBoxes.peek()[0];c()(!o.isLeaf(),"LayoutBox.addSibling: should not have leaf as a single child"),o._addChild(e,t)}else{const o=m.create(this.layout),i=m.create(this.layout);o._addChild(i,!1),i._addChild(this,!1),i._addChild(e,t),this.layout.setRoot(o)}this.layout.trigger("layoutChanged")}addChild(e,t){if(e.removeFromParent(),this.isLeaf()){const e=m.create(this.layout);e.takeLeafFrom(this),this._addChild(e,!1)}this._addChild(e,t),this.layout.trigger("layoutChanged")}toString(){return this.isDisposed()?this.uniqueId+"[disposed]":this.uniqueId+(this.isHBox()?"H":"V")+(this.isLeaf()?"("+this.leafId()+")":"["+this.childBoxes.peek().map((function(e){return e.toString()})).join(",")+"]")}_removeChildBox(e){let t=this.childBoxes.peek().indexOf(e);if(e.parentBox(null),t>=0&&(this.childBoxes.splice(t,1),this.rescaleFlexSizes()),1===this.childBoxes.peekLength){const e=this.childBoxes.peek()[0],o=this.parentBox();if(e.isLeaf())this.takeLeafFrom(e),e.dispose();else if(o){t=o.childBoxes.peek().indexOf(this),c()(t>=0,"LayoutBox._removeChildBox: box not found in parent");const i=e.childBoxes.peek();i.forEach((function(e){e.parentBox(o)})),o.childBoxes.arraySplice(t,0,i),e.childBoxes.splice(0,e.childBoxes.peekLength),this.removeFromParent(),e.dispose(),this.dispose()}}}removeFromParent(){this.parentBox()&&(this.parentBox()._removeChildBox(this),this.layout.trigger("layoutChanged"))}rescaleFlexSizes(){const e=this.childBoxes.peek(),t=Math.min.apply(null,e.map((function(e){return e.flexSize()})));t<1&&e.forEach((function(e){e.flexSize(e.flexSize()/t)}))}}function g(e){return(0,h.isObservable)(e)||(0,n.isKoArray)(e)?e.peek():"function"==typeof e?e():e}class f extends a.Disposable{static getContainingBox(e,t){const o=(0,i.findAncestor)(e,t,".layout_box");return o?h.utils.domData.get(o,"layoutBox"):null}create(e,t,o){this.maximizedLeaf=(0,h.observable)(null),this.rootBox=(0,h.observable)(null),this.createLeafFunc=t,this._leafIdMap=null,this.fillWindow=o||!1,this.needDynamic=!1,this.rootElem=this.autoDispose(this.buildDom()),this.leafId=(0,p.uniqueId)("layout_leaf_"),this.buildLayout(e||{}),this.listenTo(this,"layoutChanged",(()=>{this._leafIdMap=null})),this.autoDisposeCallback((()=>{this.rootBox()&&this.rootBox().dispose()}))}getLeafBox(e){return this.getLeafIdMap().get(e)}getAllLeafIds(){return Array.from(this.getLeafIdMap().keys())}setRoot(e){this.rootBox(e)}buildDom(){return s()("div.layout_root",(0,l.domData)("layoutModel",this),(0,l.toggleClass)("layout_fill_window",this.fillWindow),(0,l.toggleClass)("layout_box_maximized",this.maximizedLeaf),(0,l.scope)(this.rootBox,(e=>e?e.getDom():null)))}forEachBox(e,t){this.rootBox.peek()&&function o(i){e.call(t,i),i.childBoxes.peek().forEach(o)}(this.rootBox.peek())}buildLayoutBox(e){const t=m.create(this);return e.size&&t.flexSize(e.size),e.leaf?(t.leafId(e.leaf),t.leafContent(this.createLeafFunc(t.leafId()))):e.children&&t.setChildren(e.children.map(this.buildLayoutBox,this)),t}buildLayout(e,t=!1){this.needDynamic=t;const o=this.rootBox();this.rootBox(this.buildLayoutBox(e)),this.trigger("layoutChanged"),o&&o.dispose()}_getBoxSpec(e){const t={};return e.isDisposed()||(e.flexSize()&&100!==e.flexSize()&&(t.size=e.flexSize()),e.isLeaf()?t.leaf=e.leafId():t.children=e.childBoxes.peek().map(this._getBoxSpec,this)),t}getLayoutSpec(){return this._getBoxSpec(this.rootBox())}getLeafIdMap(){return this._leafIdMap||(this._leafIdMap=new Map,this.forEachBox((e=>{const t=e.leafId.peek();null!==t&&this._leafIdMap.set(t,e)}),this)),this._leafIdMap}getContainingBox(e){return f.getContainingBox(e,this.rootElem)}}Object.assign(f.prototype,u.Events)},29255:(e,t,o)=>{"use strict";o.r(t),o.d(t,{LayoutEditor:()=>_});var i=o(54156),s=o(29301),n=o(20543),r=o.n(n),l=o(74392),a=o.n(l),d=o(86277),c=o(88438),u=o(96682),h=o(81294),p=o.n(h),m=o(92979),g=o(87346);const f=(0,o(11527).get)("document","window","$");class w{constructor(e){this.scalePerFlexUnit=0,this.nextSiblings=[],this.origNextSizes=[],this.origSize=0,this.sumAll=0,this.sumPrev=0,this.sumNext=0,e&&(0,i.extend)(this,e)}}class b extends c.Disposable{create(e){this.leafId=(0,s.observable)(null),this.leafContent=(0,s.observable)(null),this.fillWindow=e||!1,this.dom=this.autoDispose(p()("div.layout_editor_floater",m.show(this.leafContent),m.scope(this.leafContent,(e=>e)))),f.document.body.appendChild(this.dom),this.mouseOffsetX=0,this.mouseOffsetY=0,this.lastMouseEvent=null}onInitialMouseMove(e,t){const o=t.dom.getBoundingClientRect();this.dom.style.width=o.width+"px",this.dom.style.height=o.height+"px",this.mouseOffsetX=.2*o.width,this.mouseOffsetY=.1*o.height,this.onMouseMove(e),this.leafId(t.leafId()),this.leafContent(t.leafContent()),t.leafId("empty"),t.leafContent(p()("div.layout_editor_empty_space",m.style("margin",.02*o.height+"px"),m.style("min-height",.96*o.height+"px")))}onMouseUp(){this.lastMouseEvent=null}onMouseMove(e){this.lastMouseEvent=e,this.dom.style.left=e.clientX-this.mouseOffsetX+"px",this.dom.style.top=e.clientY-this.mouseOffsetY+"px"}}class v extends c.Disposable{create(){this.overlayElem=this.autoDispose(p()("div.layout_editor_drop_overlay")),this.overlayRect=null,this.hBorder=null,this.vBorder=null}detach(){this.overlayElem.parentNode&&this.overlayElem.parentNode.removeChild(this.overlayElem)}attach(e){const t=this.overlayRect=e.getBoundingClientRect();this.hBorder=Math.floor(Math.min(t.height,2*t.width)/3),this.vBorder=Math.floor(Math.min(t.width,2*t.height)/3);const o=this.overlayElem.style;o.borderTopWidth=o.borderBottomWidth=this.hBorder+"px",o.borderLeftWidth=o.borderRightWidth=this.vBorder+"px"}getAffinity(e){const t=this.overlayRect,o=e.clientX-t.left,i=e.clientY-t.top,s=x(i,this.hBorder),n=x(t.height-i,this.hBorder),r=x(o,this.vBorder),l=x(t.width-o,this.vBorder),a=Math.min(s,n,r,l);return a===1/0?-1:[s,n,r,l].indexOf(a)}}class y extends c.Disposable{create(e){this.rootElem=e,this.targetsDom=null,this.currentBox=null,this.currentAffinity=null,this.delayedInsertion=u.Delay.create(),this.activeTarget=null,this.autoDisposeCallback(this.removeTargetHints)}removeTargetHints(){var e,t;(null==(t=null==(e=this.activeTarget)?void 0:e.box)?void 0:t.dom)&&(this.activeTarget.box.dom.style.transition="",this.activeTarget.box.dom.style.padding="0"),this.activeTarget=null,this.delayedInsertion.cancel(),this.targetsDom&&((0,s.removeNode)(this.targetsDom),this.targetsDom=null),this.currentBox=null,this.currentAffinity=null}updateTargetHints(e,t,o,i){if(!e||e===this.currentBox&&t===this.currentAffinity)return;if(this.removeTargetHints(),-1===t)return;this.currentBox=e,this.currentAffinity=t;const s=function(e){return e>>1==0}(t),n=function(e){return 1==(1&e)}(t),r=[];for(s===e.isVBox()&&e!==i&&r.push({box:e,isChild:!0,isAfter:n});e;){if(s===e.isHBox()){const t=e.childBoxes.peek();if(2===t.length&&(null==i?void 0:i.parentBox())===e?r.splice(r.length-1,1,{box:e,isChild:!1,isAfter:n}):i!==e&&i!==e.getSiblingBox(n)&&1!==t.length&&r.push({box:e,isChild:!1,isAfter:n}),n&&!e.isLastChild())break;if(!n&&!e.isFirstChild())break}e=e.parentBox()}if(0===r.length)return;n||r.reverse();const l=s?"top":"left",a=s?"height":"width",d=s?"left":"top",c=s?"width":"height";let u=s?o.hBorder:o.vBorder;const h=Math.floor(u/r.length);u=h*r.length;const g=this.rootElem.getBoundingClientRect(),f=this.currentBox.dom.getBoundingClientRect(),w=this;this.targetsDom=p()("div.layout_editor_drop_targeter",m.style(l,f[l]-g[l]+(n?f[a]-u:0)+"px"),r.map(((e,t)=>{const o=e.box.dom.getBoundingClientRect();return p()("div.layout_editor_drop_target",(e=>{e.style[a]=h+1+"px",e.style[c]=o[c]+"px",e.style[d]=o[d]-g[d]+"px",e.style[l]=h*t+"px"}),p().on("mouseenter",(function(){this.classList.add("layout_hover"),w.activeTarget=e;const t="padding"+(s?n?"Bottom":"Top":n?"Right":"Left");e.box.dom.style.transition="padding .3s",e.box.dom.style[t]="20px"})),p().on("mouseleave",(function(){this.classList.remove("layout_hover"),w.activeTarget=null,e.box.dom.style.padding="0"})),p().on("transitionend",this.triggerInsertion.bind(this,e)))}))),this.rootElem.appendChild(this.targetsDom)}triggerInsertion(e){this.removeTargetHints(),this.trigger("insertBox",(t=>{e.isChild?e.box.addChild(t,e.isAfter):e.box.addSibling(t,e.isAfter)}))}accelerateInsertion(){this.activeTarget&&(this.activeTarget.box.dom.style.transition="",this.activeTarget.box.dom.style.padding="0",this.triggerInsertion(this.activeTarget))}}(0,i.extend)(y.prototype,d.Events);class _ extends c.Disposable{create(e){this.layout=e,this.rootElem=e.rootElem,this.layout.buildLayout(this.layout.getLayoutSpec(),!0),this.floater=this.autoDispose(b.create(this.layout.fillWindow)),this.dropOverlay=this.autoDispose(v.create()),this.dropTargeter=this.autoDispose(y.create(this.rootElem)),this.listenTo(this.dropTargeter,"insertBox",this.onInsertBox),this.measuringBox=this.autoDispose(p()("div.layout_editor_measuring_box")),this.rootElem.appendChild(this.measuringBox),this.transitionPromise=a().resolve(),this.trashDelay=u.Delay.create(),this.originalBox=null,this.targetBox=null,this.layout.forEachBox(this.makeResizable,this),this.listenTo(this.layout,"layoutChanged",(()=>{this.layout.forEachBox(this.makeResizable,this)}));const t=this;this.boundMouseDown=function(e){return t.handleMouseDown(e,this)},this.boundMouseMove=this.handleMouseMove.bind(this),this.boundMouseUp=this.handleMouseUp.bind(this),f.$(this.rootElem).on("mousedown",".layout_leaf",this.boundMouseDown),this.initialMouseDown=!1,this.lastTriggered="stop",this.autoDisposeCallback((()=>{f.$(f.window).off("mouseup",this.boundMouseUp),f.$(f.window).off("mousemove",this.boundMouseMove),f.$(this.rootElem).off("mousedown",this.boundMouseDown),this.layout.isDisposed()||(this.layout.buildLayout(this.layout.getLayoutSpec(),!1),this.layout.forEachBox(this.unmakeResizable,this))}))}triggerUserEditStart(){r()("stop"===this.lastTriggered,"UserEditStart triggered twice in succession"),this.lastTriggered="start",this.rootElem.setAttribute("data-useredit","start"),this.layout.trigger("layoutUserEditStart")}triggerUserEditStop(){r()("start"===this.lastTriggered,"UserEditStop triggered twice in succession"),this.lastTriggered="stop",this.layout.trigger("layoutUserEditStop"),this.rootElem.setAttribute("data-useredit","stop")}makeResizable(e){if(f.$(e.dom).resizable("instance")||e.isHBox()&&!this.layout.fillWindow||e.isLastChild())return;const t=new w({box:e}),o=e.isVBox();f.$(e.dom).resizable({handles:o?"e":"s",start:this.onResizeStart.bind(this,t,o),resize:this.onResizeMove.bind(this,t,o),stop:this.triggerUserEditStop.bind(this)})}unmakeResizable(e){f.$(e.dom).resizable("instance")&&f.$(e.dom).resizable("destroy")}onResizeStart(e,t,o,i){this.triggerUserEditStart();const s=t?i.originalSize.width:i.originalSize.height;e.scalePerFlexUnit=s/(e.box.flexSize()||1);const n=e.box.parentBox().childBoxes.peek(),r=n.indexOf(e.box);e.nextSiblings=n.slice(r+1),e.origNextSizes=e.nextSiblings.map((function(e){return e.flexSize()})),e.origSize=e.box.flexSize(),e.sumPrev=n.slice(0,r).reduce(R,0),e.sumAll=n.reduce(R,0),e.sumNext=e.sumAll-e.sumPrev}onResizeMove(e,t,o,i){let s=(t?i.size.width:i.size.height)/e.scalePerFlexUnit;s=C(s,e.sumPrev,e.sumAll);const n=(e.sumNext-s)/(e.sumNext-e.origSize);let r=e.sumPrev+s;const l=[];e.origNextSizes.forEach((function(t){const o=C(t*n,r,e.sumAll);r+=o,l.push(o)})),s<=0||l.some((e=>e<=0))||s!==e.box.flexSize.peek()&&(e.box.flexSize(s),e.nextSiblings.forEach((function(e,t){e.flexSize(l[t])})),this.layout.trigger("layoutResized"))}handleMouseDown(e,t){const o=e.target;if(0===e.button&&!(null==o?void 0:o.classList.contains("ui-resizable-handle")))return(null==o?void 0:o.classList.contains("layout_grabbable"))?(this.initialMouseDown=!0,this.originalBox=s.utils.domData.get(t,"layoutBox"),r()(this.originalBox,"MouseDown on element without an associated layoutBox"),f.$(f.window).on("mousemove",this.boundMouseMove),f.$(f.window).on("mouseup",this.boundMouseUp),!1):void 0}dragInNewBox(e,t){const o=this.layout.buildLayoutBox({leaf:t});this.measuringBox.appendChild(o.getDom()),this.handleMouseDown(e,o.dom)}startDragBox(e,t){this.triggerUserEditStart(),this.targetBox=t,this.floater.onInitialMouseMove(e,t),this.trigger("dragStart",this.originalBox)}handleMouseUp(e){var t;f.$(f.window).off("mousemove",this.boundMouseMove),f.$(f.window).off("mouseup",this.boundMouseUp),this.initialMouseDown?this.initialMouseDown=!1:(this.trigger("dragStop"),this.targetBox.takeLeafFrom(this.floater),this.trigger("dragDrop",this.targetBox),"empty"!==(null==(t=this.originalBox)?void 0:t.leafId())&&(this.dropTargeter.activeTarget?this.dropTargeter.accelerateInsertion():S(this.targetBox,"reset")),this.dropTargeter.removeTargetHints(),this.dropOverlay.detach(),this.trigger("dragEnd"),this.transitionPromise.finally((()=>{this.floater.onMouseUp(),S(this.targetBox,"reset"),this.targetBox=this.originalBox=null,(0,c.emptyNode)(this.measuringBox),this.triggerUserEditStop()})))}getBoxFromElement(e){const t=this.layout.getContainingBox(e);return t&&!t.isDomDetached()?t:null}getBox(e){return this.layout.getLeafBox(e)}removeContainingBox(e){e&&!e.isDomDetached()&&(this.triggerUserEditStart(),this.targetBox=e,this.doRemoveBox(e),this.triggerUserEditStop())}doRemoveBox(e){const t=e.dom.getBoundingClientRect();e.leafId("empty"),e.leafContent(p()("div.layout_editor_empty_space",m.style("min-height",t.height+"px"))),this.onInsertBox(i.noop).catch(i.noop)}handleMouseMove(e){var t;if(this.originalBox&&!(null==(t=this.originalBox)?void 0:t.isDisposed())&&(this.initialMouseDown&&(this.initialMouseDown=!1,this.startDragBox(e,this.originalBox)),this.floater.onMouseMove(e),this.trigger("dragMove",e,this.originalBox),!this.transitionPromise.isPending()))if(p().findAncestor(e.target,null,".layout_trash")){const e=this.targetBox&&this.targetBox.isDomDetached();this.trashDelay.isPending()||e||this.trashDelay.schedule(100,this.onInsertBox,this,i.noop)}else this.trashDelay.cancel(),this.updateTargets(e)}updateTargets(e){if(this.transitionPromise.isPending())return;const t=p().findAncestor(e.target,this.rootElem,"."+this.layout.leafId);if(t){const o=s.utils.domData.get(t,"layoutBox");this.dropOverlay.attach(t);const i=this.dropOverlay.getAffinity(e);this.dropTargeter.updateTargetHints(o,i,this.dropOverlay,this.targetBox)}else p().findAncestor(e.target,this.rootElem,".layout_editor_drop_target")||this.dropTargeter.removeTargetHints()}async onInsertBox(e){const t=this.targetBox;let o;this.targetBox=g.LayoutBox.create(this.layout),this.targetBox.takeLeafFrom(t),this.targetBox.flexSize(t.flexSize()),this.targetBox.getDom(),this.transitionPromise=new(a())((function(e,t){o=e})),e(this.targetBox);const i=t.dom.getBoundingClientRect(),s=t.dom.style.flexGrow;t.dom.style.flexGrow="0";const n=this.targetBox.dom.getBoundingClientRect();t.dom.style.flexGrow=s,await a().all([D(t,i,"collapse"),D(this.targetBox,"collapse",n)]),t.dispose(),this.targetBox&&(S(this.targetBox,"reset"),this.dropOverlay.attach(this.targetBox.dom)),o(),this.layout.trigger("layoutResized")}}function x(e,t){return e<t?e/t:1/0}function C(e,t,o){const i=(s=t+e,n=o/60,Math.round(s/n)*n);var s,n;return Math.min(i,o)-t}function S(e,t){const o="reset"===t,i="collapse"===t;"current"===t&&(t=e.dom.getBoundingClientRect()),e.isHBox()?e.dom.style.height=o?"":i?"0px":t.height+"px":e.dom.style.width=o?"":i?"0px":t.width+"px",e.dom.style.opacity=i?"0.0":"1.0"}function I(e){return"string"==typeof e?e:Math.floor(e.width)+"x"+Math.floor(e.height)}function D(e,t,o){if(e.isDomDetached())return a().resolve();const s=e.dom.style.flexGrow;return e.dom.style.flexGrow="0",S(e,t),(0,i.pick)(f.window.getComputedStyle(e.dom),"height","width"),e.dom.classList.add("layout_editor_resize_transition"),new(a())((function(t,i){p().once(e.dom,"transitionend",(function(){t()})),S(e,o)})).timeout(600).catch(a().TimeoutError,(function(){console.error("LayoutEditor.resizeLayoutBoxSmoothly %s %s->%s: transition didn't run",e,I(t),I(o))})).finally((function(){e.dom.classList.remove("layout_editor_resize_transition"),e.dom.style.flexGrow=s}))}function R(e,t){return e+t.flexSize.peek()}(0,i.extend)(_.prototype,d.Events)},4491:(e,t,o)=>{"use strict";o.d(t,{F:()=>g});var i=o(70387),s=o(11187),n=o(29922),r=o(99002),l=o(20742),a=o(1310),d=Object.defineProperty,c=Object.getOwnPropertySymbols,u=Object.prototype.hasOwnProperty,h=Object.prototype.propertyIsEnumerable,p=(e,t,o)=>t in e?d(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;const m=(0,i.makeT)("PluginScreen");class g extends a.Disposable{constructor(e){super(),this._title=e,this._openModalCtl=null,this._importerContent=a.Observable.create(this,null),this._fullscreen=a.Observable.create(this,!1),this._fullbody=a.Observable.create(this,!1)}renderContent(e){this.render([this._buildModalTitle(),e])}renderPlugin(e){return e.addRenderTarget(((e,t={})=>{e.style.width="100%",e.style.height=t.height||"200px",this.renderContent(e)}))}render(e,t){this._fullscreen.set(Boolean(null==t?void 0:t.fullscreen)),this._fullbody.set(Boolean(null==t?void 0:t.fullbody)),this.showImportDialog(),this._importerContent.set(e)}renderError(e){this._fullbody.set(!1),this.render([this._buildModalTitle(),w(m("Import failed: "),e,(0,n.testId)("importer-error")),(0,l.cssModalButtons)((0,s.bigBasicButton)("Close",a.dom.on("click",(()=>this.close())),(0,n.testId)("modal-cancel")))])}renderSpinner(){this._fullbody.set(!1),this.render([this._buildModalTitle(),v((0,r.M)())])}close(){var e;null==(e=this._openModalCtl)||e.close(),this._openModalCtl=null}showImportDialog(e){this._openModalCtl||(0,l.modal)(((e,t)=>(this._openModalCtl=e,this.onDispose((()=>{t.isDisposed()||e.close()})),[f.cls(""),f.cls("-fullscreen",this._fullscreen),f.cls("-fullbody",this._fullbody),a.dom.domComputed(this._importerContent),(0,n.testId)("importer-dialog")])),((e,t)=>{for(var o in t||(t={}))u.call(t,o)&&p(e,o,t[o]);if(c)for(var o of c(t))h.call(t,o)&&p(e,o,t[o]);return e})({noClickAway:!0,noEscapeKey:!0},e))}_buildModalTitle(e){return b((0,l.cssModalTitle)(this._title),e)}}const f=(0,a.styled)("div",`\n  max-height: calc(100% - 32px);\n  display: flex;\n  flex-direction: column;\n  & > .${l.cssModalButtons.className} {\n    margin-top: 16px;\n  }\n\n  &-fullscreen {\n    height: 100%;\n    margin: 32px;\n  }\n\n  &-fullbody {\n    padding: 0px;\n    background-color: ${n.theme.importerOutsideBg};\n  }\n`),w=(0,a.styled)("div","\n  padding: 16px 0;\n  overflow-y: auto;\n  max-width: 470px;\n  white-space: pre-line;\n"),b=(0,a.styled)("div",`\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  margin-bottom: 16px;\n  & > .${l.cssModalTitle.className} {\n    margin-bottom: 0px;\n  }\n`),v=(0,a.styled)("div","\n  display: flex;\n  align-items: center;\n  height: 80px;\n  margin: auto;\n")},68498:(e,t,o)=>{"use strict";o.r(t),o.d(t,{printViewSection:()=>r,renderAllRows:()=>l});var i=o(28250),s=o(29922),n=o(1310);async function r(e,t){var o;const r=t.viewInstance.peek(),l=null==(o=null==r?void 0:r.viewPane)?void 0:o.closest(".viewsection_content");if(!l)throw new Error("No page widget to print");if(r instanceof i.S)try{return void await r.triggerPrint()}catch(e){console.warn(`Failed to trigger print in CustomView: ${e}`)}function a(t){(0,s.prefersDarkModeObs)().pause(),null==e||e.forEachBox((e=>{e.dom.contains(l)||e.dom.classList.toggle("print-hide",t)})),l.classList.toggle("print-widget",t),null==r||r.prepareToPrint(t);let o=(l.querySelector(".print-all-rows")||l).parentElement;for(;o;)o.classList.toggle("print-parent",t),o=o.parentElement}const d=n.dom.onElem(window,"beforeprint",(()=>a(!0))),c=n.dom.onElem(window,"afterprint",window.afterPrintCallback=()=>{d.dispose(),c.dispose(),window.debugPrinting?window.finishPrinting=()=>a(!1):a(!1),delete window.afterPrintCallback,(0,s.prefersDarkModeObs)().pause(!1),(0,s.prefersDarkModeObs)().set((0,s.prefersDarkMode)())});setTimeout((()=>window.print()),0)}function l(e,t,o){const i=e.createFloatingRowModel(null),s=[];t.forEach(((e,t)=>{if("new"!==e){i._index(t),i.assign(e);const r=o(i);s.push(`<div class="print-row">${r.outerHTML}</div>`),n.dom.domDispose(r)}})),i.dispose();const r=(0,n.dom)("div.print-all-rows");return r.innerHTML=s.join("\n"),r}},50254:(e,t,o)=>{"use strict";o.r(t),o.d(t,{SelectionSummary:()=>g});var i=o(3719),s=o(85842),n=o(96682),r=o(92769),l=o(3871),a=o(8881),d=o(29922),c=o(7454),u=o(631),h=o(1310);const p=(0,o(70387).makeT)("SelectionSummary"),m=(0,h.makeTestId)("test-selection-summary-");class g extends h.Disposable{constructor(e,t,o,s){super(),this._cellSelector=e,this._tableData=t,this._sortedRows=o,this._viewFields=s,this._colTotalCount=h.Computed.create(this,(e=>e(e(this._viewFields).getObservable()).length)),this._rowTotalCount=h.Computed.create(this,(e=>{const t=e(this._sortedRows.getKoArray().getObservable()),o=t.length>0&&"new"===t[t.length-1];return t.length-(o?1:0)})),this._rowRange=h.Computed.create(this,(e=>{if(e(this._cellSelector.currentSelectType)===i.COL)return{begin:0,end:e(this._rowTotalCount)};{const t=e(this._cellSelector.row.start),o=e(this._cellSelector.row.end);return{begin:Math.min(t,o),end:Math.max(t,o)+1}}})),this._colRange=h.Computed.create(this,(e=>{if(e(this._cellSelector.currentSelectType)===i.ROW)return{begin:0,end:e(this._colTotalCount)};{const t=e(this._cellSelector.col.start),o=e(this._cellSelector.col.end);return{begin:Math.min(t,o),end:Math.max(t,o)+1}}})),this._summary=h.Observable.create(this,[]),this._delayedRecalc=this.autoDispose(n.Delay.create()),this.autoDispose(this._sortedRows.getKoArray().subscribe(this._onSpliceChange,this,"spliceChange"));const r=this._onRowNotify.bind(this);this._sortedRows.on("rowNotify",r),this.onDispose((()=>this._sortedRows.off("rowNotify",r))),this.autoDispose((0,h.subscribe)(this._rowRange,this._colRange,(()=>this._scheduleRecalc()))),this.autoDispose((0,d.isNarrowScreenObs)().addListener((e=>{e||this._scheduleRecalc()})))}buildDom(){return f(h.dom.forEach(this._summary,(({id:e,label:t,value:o,clickToCopy:i})=>w(t?(0,h.dom)("span",b(t),v("Copy")):null,o,w.cls("-copyable",Boolean(i)),i?h.dom.on("click",((e,t)=>async function(e,t){await(0,s.copyToClipboard)(e),(0,a.showTransientTooltip)(t,p("Copied to clipboard"),{key:"copy-selection-summary"})}(o,t))):null,m(e)))))}_onSpliceChange(e){const t=this._rowRange.get();1!=t.end-t.begin&&(e.start>=t.end||this._scheduleRecalc())}_onRowNotify(e){const t=this._rowRange.get();if(e===l.ALL)this._scheduleRecalc();else{const o=this._sortedRows.getKoArray().peek(),i=new Set(e);for(let e=t.begin;e<t.end;e++)if(i.has(o[e])){this._scheduleRecalc();break}}}_scheduleRecalc(){this._delayedRecalc.schedule(0,(()=>this._recalc()))}_recalc(){const e=this._rowRange.get(),t=this._colRange.get();let o=e.end-e.begin,i=t.end-t.begin;const s=o*i,n=[];if(s>1&&!(0,d.isNarrowScreen)()){if(s<=1e6){const s=this._sortedRows.getKoArray().peek(),l=this._viewFields.peek().peek();let a=0,d=0,c=0,h=null;const p=[];for(let t=e.begin;t<e.end;t++){const e=s[t];void 0!==e&&"new"!==e?p.push(this._tableData.getRowIdIndex(e)):o-=1}for(let e=t.begin;e<t.end;e++){if(void 0===l[e]){i-=1;continue}const t=l[e].column.peek(),o=l[e].displayColModel.peek(),s=t.type.peek(),n=l[e].visibleColModel.peek().type.peek(),m=null!=n?n:s,g=o.colId.peek(),f=this._tableData.getColValues(g);if(!f)throw new r.UserError(`Invalid column ${this._tableData.tableId}.${g}`);const w=["Numeric","Int","Any"].includes(m),b=s.startsWith("Ref:")&&!n?e=>0===e:(0,u.isRefListType)(s)||(0,u.isListType)(m)?u.isEmptyList:void 0;if(w){h||(h=l[e].formatter.peek());for(const e of p){const t=f[e];"number"==typeof t?(a++,c+=t):null==t||""===t||(null==b?void 0:b(t))||d++}}else for(const e of p){const t=f[e];null==t||""===t||!1===t||(null==b?void 0:b(t))||d++}}if(a>0){const e=h?h.formatAny(c):String(c);n.push({id:"sum",label:"Sum ",value:e,clickToCopy:!0})}else n.push({id:"count",label:"Count ",value:String(d),clickToCopy:!0})}n.push({id:"dimensions",label:"",value:`${o}${i}`})}this._summary.set(n)}}const f=(0,h.styled)("div",`\n  position: absolute;\n  bottom: -18px;\n  height: 18px;\n  line-height: 18px;\n  display: flex;\n  column-gap: 8px;\n  width: 100%;\n  justify-content: end;\n  color: ${d.theme.text};\n  font-family: ${d.vars.fontFamilyData};\n\n  @media print {\n    & {\n      display: none;\n    }\n  }\n`),w=(0,h.styled)("div",`\n  padding: 0 8px;\n  border-radius: 4px;\n  border-top-left-radius: 0px;\n  border-top-right-radius: 0px;\n  border-top: none;\n  z-index: 100;\n  position: relative;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  white-space: nowrap;\n  /* Set explicit backdrop to improve visibility in raw data views. */\n  background-color: ${d.theme.mainPanelBg};\n\n  &-copyable:hover {\n    cursor: pointer;\n  }\n  &::before {\n    content: "";\n    position: absolute;\n    top: 0;\n    left: 0;\n    bottom: 0;\n    right: 0;\n    background-color: ${d.colors.mediumGrey};\n    opacity: 0.8;\n    z-index: -1;\n  }\n`),b=(0,h.styled)("span",`\n  font-size: ${d.vars.xsmallFontSize};\n  text-transform: uppercase;\n  position: relative;\n  margin-right: 4px;\n  .${w.className}-copyable:hover & {\n    visibility: hidden;\n  }\n`),v=(0,h.styled)(c.icon,`\n  position: absolute;\n  top: 0;\n  margin: 1px 0 0 4px;\n  --icon-color: ${d.theme.controlFg};\n  display: none;\n  .${w.className}-copyable:hover & {\n    display: block;\n  }\n`)},98279:(e,t,o)=>{"use strict";o.d(t,{j:()=>s});var i=o(18975);class s{constructor(e,t){this.plugin=e,this.importSource=t,this.importSourceStub=e.getStub(t.importSource,i.C4.InternalImportSourceAPI)}static fromArray(e){const t=[];for(const o of e){const e=o.definition.manifest.contributions.importSources;if(e)for(const i of e)t.push(new s(o,i))}return t}}},31248:(e,t,o)=>{"use strict";o.r(t),o.d(t,{onDblClickMatchElem:()=>s});var i=o(1310);function s(e,t,o){i.dom.styleElem(e,"touch-action","manipulation"),i.dom.onMatchElem(e,t,"dblclick",((e,t)=>{o(e,t)}));let s=0,n=null;i.dom.onMatchElem(e,t,"touchend",((e,t)=>{const i=Date.now(),r=i-s,l=t===n;s=i,n=t,l&&r<500&&r>0&&(e.preventDefault(),o(e,t))}))}},97660:(e,t,o)=>{"use strict";o.d(t,{a:()=>s});var i=o(1310);function s(e){return(t,o)=>i.dom.cls(e+t,null==o||o)}},41675:(e,t,o)=>{"use strict";o.d(t,{a:()=>s});var i=o(62258);async function s(){const e=await(0,i.ic)();return new URLSearchParams(window.location.search).get("timezone")||e.tz.guess()}},88748:(e,t,o)=>{"use strict";o.d(t,{Xp:()=>A,i0:()=>O,Nj:()=>P});var i=o(41675),s=o(42064),n=o(55688);class r{constructor(e,t,o){this.pluginsList=[];for(const i of e)try{const e=i.manifest.components||{};if(e.safePython||e.unsafeNode)continue;const r=i.manifest.contributions.importSources;if(!(null==r?void 0:r.some((e=>e.safeHome))))continue;const a=new n.dl(i,(0,n.GO)(console,`HOME PLUGIN ${i.id}:`)),d=a.safeBrowser=new s.u0(a,o,t,e.safeBrowser);e.safeBrowser&&a.rpc.registerForwarder(e.safeBrowser,d);const c=new l;a.rpc.registerForwarder("*",{forwardCall:e=>c.forwardPluginRpc(i.id,e),forwardMessage:e=>c.forwardPluginRpc(i.id,e)}),this.pluginsList.push(a)}catch(e){console.error(`HomePluginManager: failed to instantiate ${i.id}: ${e.message}`)}}}class l{async forwardPluginRpc(e,t){throw new Error("This api is not available")}}var a=o(98279),d=o(76961),c=o(38109),u=o(92769),h=o(3988);if(179==o.j)var p=o(43272);var m,g=o(83277),f=o(56964),w=o(51503),b=o(36322),v=o(1310),y=o(60611),_=o.n(y),x=Object.defineProperty,C=Object.defineProperties,S=Object.getOwnPropertyDescriptors,I=Object.getOwnPropertySymbols,D=Object.prototype.hasOwnProperty,R=Object.prototype.propertyIsEnumerable,T=(e,t,o)=>t in e?x(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;const k=o(50949),M=o(91944);function O(e){const t=_().utc(e),o=_()(),i=o.diff(t,"s");return i<0&&i>-60?o.fromNow():t.fromNow()}class A extends(179==o.j?v.Disposable:null){constructor(e,t){if(super(),this._app=e,this.pageType="home",this.currentPage=v.Computed.create(this,(0,h.urlState)().state,((e,t)=>t.homePage||(void 0!==t.ws?"workspace":"all"))),this.currentWSId=v.Computed.create(this,(0,h.urlState)().state,((e,t)=>t.ws)),this.workspaces=v.Observable.create(this,[]),this.loading=v.Observable.create(this,!0),this.available=v.Observable.create(this,!1),this.singleWorkspace=v.Observable.create(this,!0),this.trashWorkspaces=v.Observable.create(this,[]),this.templateWorkspaces=v.Observable.create(this,[]),this.importSources=v.Observable.create(this,[]),this.currentWS=v.Computed.create(this,(e=>e(this.workspaces).find((t=>t.id===e(this.currentWSId))))),this.currentWSPinnedDocs=v.Computed.create(this,this.currentPage,this.currentWS,((e,t,o)=>{const i="all"===t?k(e(this.workspaces).map((e=>e.docs))):o?o.docs:[];return M(i.filter((e=>e.isPinned)),(e=>e.name.toLowerCase()))})),this.featuredTemplates=v.Computed.create(this,this.templateWorkspaces,((e,t)=>{const o=k(t.map((e=>e.docs))).filter((e=>e.isPinned));return M(o,(e=>e.name.toLowerCase()))})),this.otherSites=v.Computed.create(this,this.currentPage,this.app.topAppModel.orgs,((e,t,o)=>{if("all"!==t)return[];const i=this._app.currentOrg;return i&&(i.owner||"viewers"===i.access&&i.public)?o.filter((e=>e.id!==i.id)):[]})),this.newDocWorkspace=v.Computed.create(this,this.currentPage,this.currentWS,((e,t,o)=>{if(!this.app.currentValidUser)return"unsaved";if("trash"===t)return null;const i=["all","templates"].includes(t)?e(this.workspaces)[0]||null:o;return i&&w.J5(i.access)?i:null})),this.showIntro=v.Computed.create(this,this.workspaces,((e,t)=>t.every((e=>e.isSupportWorkspace||0===e.docs.length)))),this.shouldShowAddNewTip=v.Observable.create(this,!this._app.behavioralPromptsManager.hasSeenTip("addNew")),this._userOrgPrefs=v.Observable.create(this,null==(m=this._app.currentOrg)?void 0:m.userOrgPrefs),this.app.currentValidUser)this.currentSort=v.Computed.create(this,this._userOrgPrefs,((e,t)=>f.SortPref.parse(null==t?void 0:t.docMenuSort)||"name")).onWrite((e=>this._saveUserOrgPref("docMenuSort",e))),this.currentView=v.Computed.create(this,this._userOrgPrefs,((e,t)=>f.ViewPref.parse(null==t?void 0:t.docMenuView)||function(e){const t=e.filter((e=>!e.isSupportWorkspace)),o=t.reduce(((e,t)=>e+t.docs.length),0),i=t.some((e=>e.docs.some((e=>e.isPinned))));return o>4||i?"list":"icons"}(e(this.workspaces)))).onWrite((e=>this._saveUserOrgPref("docMenuView",e)));else{const e=P(null,"all");this.currentSort=e.currentSort,this.currentView=e.currentView}this.autoDispose((0,v.subscribe)(this.currentPage,this.currentWSId,(e=>this._updateWorkspaces().catch(c.eK))));const o=new r(e.topAppModel.plugins,e.topAppModel.getUntrustedContentOrigin(),t),i=a.j.fromArray(o.pluginsList);this.importSources.set(i),this._app.refreshOrgUsage().catch(c.eK)}get app(){return this._app}async createWorkspace(e){const t=this._app.currentOrg;t&&(this._checkForDuplicates(e),await this._app.api.newWorkspace({name:e},t.id),await this._updateWorkspaces())}async renameWorkspace(e,t){this._checkForDuplicates(t),await this._app.api.renameWorkspace(e,t),await this._updateWorkspaces()}async deleteWorkspace(e,t){await(t?this._app.api.deleteWorkspace(e):this._app.api.softDeleteWorkspace(e)),await this._updateWorkspaces()}async restoreWorkspace(e){await this._app.api.undeleteWorkspace(e.id),await this._updateWorkspaces(),(0,u.reportMessage)(`Workspace "${e.name}" restored`)}async createDoc(e,t){if("unsaved"===t){const e=await(0,i.a)();return await this._app.api.newUnsavedDoc({timezone:e})}const o=await this._app.api.newDoc({name:e},t);return await this._updateWorkspaces(),o}async renameDoc(e,t){await this._app.api.renameDoc(e,t),await this._updateWorkspaces()}async deleteDoc(e,t){await(t?this._app.api.deleteDoc(e):this._app.api.softDeleteDoc(e)),await this._updateWorkspaces()}async restoreDoc(e){await this._app.api.undeleteDoc(e.id),await this._updateWorkspaces(),(0,u.reportMessage)(`Document "${e.name}" restored`)}async pinUnpinDoc(e,t){await(t?this._app.api.pinDoc(e):this._app.api.unpinDoc(e)),await this._updateWorkspaces()}async moveDoc(e,t){await this._app.api.moveDoc(e,t),await this._updateWorkspaces()}_checkForDuplicates(e){if(this.workspaces.get().find((t=>t.name===e)))throw new u.UserError("Name already exists. Please choose a different name.")}async _updateWorkspaces(){if(this.isDisposed())return;const e=this._app.currentOrg;if(!e)return this.workspaces.set([]),this.trashWorkspaces.set([]),void this.templateWorkspaces.set([]);this.loading.set(!0);const t=this.currentPage.get(),o=[this._fetchWorkspaces(e.id,!1).catch(c.eK),"trash"===t?this._fetchWorkspaces(e.id,!0).catch(c.eK):null,this._maybeFetchTemplates()],i=Promise.all(o);await(0,g.isLongerThan)(i,500)&&this.loading.set("slow");const[s,n,r]=await i;this.isDisposed()||(0,v.bundleChanges)((()=>{this.workspaces.set(s||[]),this.trashWorkspaces.set(n||[]),this.templateWorkspaces.set(r||[]),this.loading.set(!1),this.available.set(!!s);const e=Array.isArray(s)?s.filter((e=>!e.isSupportWorkspace)):null;this.singleWorkspace.set(0===(null==e?void 0:e.length)||1===(null==e?void 0:e.length)&&1===this._app.currentFeatures.maxWorkspacesPerOrg)}))}async _fetchWorkspaces(e,t){var o;let i=this._app.api;t&&(i=i.forRemoved());const s=await i.getOrgWorkspaces(e);if(this.isDisposed())return null;for(const e of s){if(e.docs=M(e.docs,(e=>e.name.toLowerCase())),t)for(const t of e.docs)t.removedAt=t.removedAt||e.removedAt;for(const t of e.docs)t.workspace=null!=(o=t.workspace)?o:e}return M(s,(e=>[e.isSupportWorkspace,(0,p.pE)(this._app,e).toLowerCase(),e.name.toLowerCase()]))}async _maybeFetchTemplates(){var e;const{templateOrg:t}=(0,b.getGristConfig)();if(!t)return null;const o=this.currentPage.get();if(!["all","templates"].includes(o))return null;let i=[];try{const e="all"===o;i=await this._app.api.getTemplates(e)}catch(e){(0,c.eK)("Failed to load templates")}if(this.isDisposed())return null;for(const t of i){for(const o of t.docs)o.workspace=null!=(e=o.workspace)?e:t;t.docs=M(t.docs,(e=>e.name.toLowerCase()))}return i}async _saveUserOrgPref(e,t){const o=this._app.currentOrg;var i;o&&(o.userOrgPrefs=(i=((e,t)=>{for(var o in t||(t={}))D.call(t,o)&&T(e,o,t[o]);if(I)for(var o of I(t))R.call(t,o)&&T(e,o,t[o]);return e})({},o.userOrgPrefs),C(i,S({[e]:t}))),this._userOrgPrefs.set(o.userOrgPrefs),await this._app.api.updateOrg("current",{userOrgPrefs:o.userOrgPrefs}))}}function P(e,t){var o;const i=(null==(o=null==e?void 0:e.app.currentUser)?void 0:o.id)||0,s=(0,d.BW)(`u=${i}:ws=${t}:sort`),n=(0,d.BW)(`u=${i}:ws=${t}:view`);return{currentSort:v.Computed.create(null,(t=>f.SortPref.parse(t(s))||(e?t(e.currentSort):"name"))).onWrite((e=>s.set(e))),currentView:v.Computed.create(null,(o=>f.ViewPref.parse(o(n))||("trash"===t?"list":e?o(e.currentView):"icons"))).onWrite((e=>n.set(e)))}}},43272:(e,t,o)=>{"use strict";function i(e,t){const{owner:o,name:i}=n(e,t);return[i,o?`@${o.name}`:""].join(" ").trim()}function s(e,t){const{owner:o,self:i}=n(e,t);return i?"":o?o.name:""}function n(e,t){const o=e.currentUser,{name:i,owner:s}=t,n="Home"===i;if(!o||!s)return{owner:s,name:i};const r=o.id===s.id,l=r&&n;return t.isSupportWorkspace?{name:i,self:r,isDefault:l}:n&&!l?{name:"",owner:s,self:r,isDefault:l}:r?{name:i,self:r,isDefault:l}:{name:i,owner:s,self:r,isDefault:l}}o.d(t,{BT:()=>n,pE:()=>s,rq:()=>i})},58847:(e,t,o)=>{"use strict";o.r(t),o.d(t,{CellContextMenu:()=>d});var i=o(77709),s=o(70387),n=o(1370),r=o(36258),l=o(1310);const a=(0,s.makeT)("CellContextMenu");function d(e,t){const{disableInsert:o,disableDelete:s,isViewSorted:d}=e,{disableModify:c,isReadonly:u}=t,h=l.dom.cls("disabled",Boolean(c)||u),p=l.dom.cls("disabled",u),m=t.numColumns,g=t.isFiltered?a("Reset {{count}} entire columns",{count:m}):a("Reset {{count}} columns",{count:m}),f=a("Delete {{count}} columns",{count:m}),w=e.numRows,b=a("Delete {{count}} rows",{count:w}),v=a(w>1||m>1?"Clear values":"Clear cell"),y=[];return y.push((0,n.menuItemCmd)(i.allCommands.contextMenuCut,a("Cut"),h),(0,n.menuItemCmd)(i.allCommands.contextMenuCopy,a("Copy")),(0,n.menuItemCmd)(i.allCommands.contextMenuPaste,a("Paste"),h),(0,n.menuDivider)(),t.isFormula?null:(0,n.menuItemCmd)(i.allCommands.clearValues,v,h),(0,n.menuItemCmd)(i.allCommands.clearColumns,g,h),...m>1||w>1?[]:[(0,n.menuDivider)(),(0,n.menuItemCmd)(i.allCommands.copyLink,a("Copy anchor link")),(0,n.menuDivider)(),(0,n.menuItemCmd)(i.allCommands.filterByThisCellValue,a("Filter by this value")),(0,n.menuItemCmd)(i.allCommands.openDiscussion,a("Comment"),l.dom.cls("disabled",u||0===w||0===m),l.dom.hide((e=>!e((0,r.COMMENTS)()))))],(0,n.menuDivider)(),...d?[(0,n.menuItemCmd)(i.allCommands.insertRecordAfter,a("Insert row"),l.dom.cls("disabled",o))]:[(0,n.menuItemCmd)(i.allCommands.insertRecordBefore,a("Insert row above"),l.dom.cls("disabled",o)),(0,n.menuItemCmd)(i.allCommands.insertRecordAfter,a("Insert row below"),l.dom.cls("disabled",o))],(0,n.menuItemCmd)(i.allCommands.duplicateRows,a("Duplicate rows",{count:w}),l.dom.cls("disabled",o||0===w)),(0,n.menuItemCmd)(i.allCommands.insertFieldBefore,a("Insert column to the left"),p),(0,n.menuItemCmd)(i.allCommands.insertFieldAfter,a("Insert column to the right"),p),(0,n.menuDivider)(),(0,n.menuItemCmd)(i.allCommands.deleteRecords,b,l.dom.cls("disabled",s)),(0,n.menuItemCmd)(i.allCommands.deleteFields,f,h)),y}},28795:(e,t,o)=>{"use strict";o.r(t),o.d(t,{buildRenameColumn:()=>D});var i=o(58810),s=o(77709),n=o(85842),r=o(29813),l=o(70387),a=o(80864),d=o(73181),c=o(8881),u=o(11187),h=o(29922),p=o(7454),m=o(1370),g=o(1310),f=o(21467),w=o(73154),b=Object.defineProperty,v=Object.getOwnPropertySymbols,y=Object.prototype.hasOwnProperty,_=Object.prototype.propertyIsEnumerable,x=(e,t,o)=>t in e?b(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,C=(e,t)=>{for(var o in t||(t={}))y.call(t,o)&&x(e,o,t[o]);if(v)for(var o of v(t))_.call(t,o)&&x(e,o,t[o]);return e};const S=(0,g.makeTestId)("test-column-title-"),I=(0,l.makeT)("ColumnTitle");function D(e){return t=>{(0,f.setPopupToCreateDom)(t,(t=>function(e,{field:t,isEditing:o,optCommands:l}){const h=g.Observable.create(e,t.displayLabel.peek()),f=g.Observable.create(e,t.description.peek()),b="$"+t.colId.peek(),v=g.Computed.create(e,(e=>{var o,i;return(null==(o=e(h))?void 0:o.trim())!==t.displayLabel.peek()||(null==(i=e(f))?void 0:i.trim())!==t.description.peek()})),y=g.Computed.create(e,(e=>{var t;return!Boolean(null==(t=e(h))?void 0:t.trim())})),_=async()=>{var e,o;const i=null!=(o=null==(e=h.get())?void 0:e.trim())?o:"";i&&i!==t.displayLabel.peek()&&await t.displayLabel.setAndSave(i)},x=async()=>{var e,o;const i=null!=(o=null==(e=f.get())?void 0:e.trim())?o:"";i!==t.description.peek()&&await t.description.saveOnly(i)};let D=!1;const A=()=>e.close(),P=()=>{D=!0,A()},F={cancel:P,accept:()=>{if(document.activeElement===z)return!0;A()},nextField:()=>{var e;A(),null==(e=null==l?void 0:l.nextField)||e.call(l)},prevField:()=>{var e;A(),null==(e=null==l?void 0:l.prevField)||e.call(l)},cursorUp:()=>{if(document.activeElement!==z||0!==(null==z?void 0:z.selectionStart))return!0;null==U||U.focus(),null==U||U.select()},cursorDown:()=>{if(document.activeElement!==U)return!0;{const e=()=>{null==z||z.focus(),null==z||z.select()};$.set(!0),e()}}},E=s.createGroup(C(C({},l),F),e,!0);let B;const L=e=>g.dom.on("focus",(()=>B=e)),$=g.Observable.create(null,Boolean(""!==t.description.peek()));let U,z;return(0,w.GM)(g.dom.onDispose((()=>{D||Promise.all([_(),x()]).catch(reportError),o(!1)})),g.dom.autoDispose(E),g.dom.autoDispose($),S("popup"),g.dom.cls(m.menuCssClass),(0,w.xY)(I("Column label")),k(U=(0,w.g8)(h,R,{placeholder:I("Provide a column label")},S("label"),E.attach(),L),M(I("COLUMN ID: "),b,g.dom.on("click",(async(e,t)=>{e.stopImmediatePropagation(),e.preventDefault(),(0,c.showTransientTooltip)(t,I("Column ID copied to clipboard"),{key:"copy-column-id"}),await(0,n.copyToClipboard)(b),(0,a.setTestState)({clipboard:b})})),S("colid"))),g.dom.maybe((e=>!e($)),(()=>T((0,u.textButton)((0,p.icon)("Plus"),I("Add description"),g.dom.on("click",(()=>{$.set(!0),null==z||z.focus(),setTimeout((()=>null==z?void 0:z.focus()),0)})),S("add-description"))))),g.dom.maybe($,(()=>[(0,w.xY)(I("Column description")),z=(0,w.F5)(f,R,S("description"),E.attach(),L,(0,d.po)(f))])),g.dom.onKeyDown({Enter$:e=>{if(e.ctrlKey||e.metaKey)return A(),!1}}),O((0,u.primaryButton)(g.dom.on("click",P),S("close"),g.dom.hide(v),I("Close")),(0,u.primaryButton)(I("Save"),g.dom.on("click",A),S("save"),g.dom.show(v),g.dom.boolAttr("disabled",y)),(0,u.basicButton)(I("Cancel"),S("cancel"),g.dom.on("click",P),g.dom.show(v))),(t=>{setTimeout((()=>{e.isDisposed()||(null==U||U.focus(),null==U||U.select())}),0)}),(t=>{r.FocusLayer.create(e,{defaultFocusElem:t,pauseMousetrap:!1,allowFocus:i.allowFocus})}),(e=>g.dom.on("focus",(()=>null==B?void 0:B.focus()))))}(t,e)),{placement:"bottom-start",trigger:[(t,o)=>{o.autoDispose(e.isEditing.subscribe((e=>{e?o.open():o.isDisposed()||o.close()})))}],attach:"body",boundaries:"viewport"})}}const R={onInput:!0},T=(0,g.styled)("div","\n  display: flex;\n  padding-top: 14px;\n  padding-bottom: 4px;\n  & button {\n    display: flex;\n    align-items: center;\n    gap: 8px;\n  }\n"),k=(0,g.styled)("div","\n  display: flex;\n  flex-direction: column;\n  flex: auto;\n  min-width: 80px;\n"),M=(0,g.styled)("div",`\n  font-size: ${h.vars.xsmallFontSize};\n  font-weight: ${h.vars.bigControlTextWeight};\n  margin-top: 8px;\n  color: ${h.theme.lightText};\n  white-space: nowrap;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  cursor: pointer;\n  align-self: start;\n`),O=(0,g.styled)("div","\n  display: flex;\n  margin-top: 16px;\n  gap: 8px;\n  & button {\n    min-width: calc(50 / 13 * 1em); /* Min 50px for 13px font size, to make Save and Close buttons equal width */\n  }\n")},36524:(e,t,o)=>{"use strict";o.d(t,{AI:()=>d,AV:()=>M,BS:()=>R,C4:()=>_,CT:()=>N,D2:()=>B,DC:()=>y,F5:()=>W,FS:()=>x,J7:()=>g,Jj:()=>k,Lc:()=>L,ME:()=>S,P2:()=>v,Pt:()=>J,Ri:()=>b,S1:()=>$,SH:()=>P,XN:()=>w,Zw:()=>f,az:()=>p,e9:()=>F,eo:()=>a,f:()=>z,fK:()=>j,gs:()=>h,h9:()=>X,j2:()=>D,lY:()=>H,m2:()=>G,mV:()=>U,nm:()=>V,o9:()=>E,qE:()=>I,qk:()=>m,tp:()=>O,ud:()=>K,uj:()=>C,vs:()=>A,wj:()=>c});var i=o(68370),s=o(29922),n=o(7454),r=o(1310),l=o(11187);o(21467);const a=(0,r.styled)("div",`\n  height: 100%;\n  padding: 32px 64px 24px 64px;\n  overflow-y: auto;\n  position: relative;\n  display: flex;\n  flex-direction: column;\n\n  &:after {\n    content: "";\n    display: block;\n    height: 64px;\n  }\n  @media ${s.mediaSmall} {\n    & {\n      padding: 32px 24px 24px 24px;\n    }\n  }\n  @media print {\n    & {\n      display: none;\n    }\n  }\n`),d=(0,r.styled)("div","\n  display: flex;\n"),c=(0,r.styled)("div","\n  flex-grow: 1;\n  max-width: 100%;\n"),u=(0,r.styled)("div",`\n  min-height: 32px;\n  line-height: 32px;\n  color: ${s.theme.text};\n  font-size: ${s.vars.xxxlargeFontSize};\n  font-weight: ${s.vars.headerControlTextWeight};\n`),h=(0,r.styled)(u,"\n  margin-bottom: 24px;\n"),p=(0,r.styled)("div",`\n  display: flex;\n  align-items: baseline;\n  justify-content: space-between;\n  gap: 16px;\n  margin-bottom: 24px;\n\n  @media ${s.mediaSmall} {\n    & {\n      flex-direction: column;\n      align-items: flex-start;\n    }\n  }\n`),m=(0,r.styled)(u,"\n  cursor: pointer;\n"),g=(0,r.styled)(h,"\n  display: flex;\n  align-items: center;\n"),f=179==o.j?m:null,w=(0,r.styled)("div","\n  display: flex;\n"),b=(0,r.styled)("div",`\n  color: ${s.theme.text};\n  max-width: 550px;\n  min-width: 300px;\n  margin-bottom: 28px;\n\n  &-icons {\n    max-width: max-content;\n    min-width: calc(min(550px, 100%));\n  }\n`),v=(0,r.styled)(b,"\n  margin-top: 32px;\n"),y=(0,r.styled)("div",`\n  color: ${s.theme.text};\n  margin-bottom: 32px;\n`),_=(0,r.styled)("div","\n  display: flex;\n  overflow: auto;\n  padding-bottom: 16px;\n  margin-top: 16px;\n  margin-bottom: 28px;\n  gap: 16px;\n"),x=(0,r.styled)(l.bigBasicButton,"\n  flex: 0 0 auto;\n"),C=(0,r.styled)(n.icon,`\n  margin-right: 8px;\n  margin-top: -3px;\n  --icon-color: ${s.theme.lightText};\n`),S=(0,r.styled)(C,`\n  --icon-color: ${s.theme.text};\n`),I=(0,r.styled)(n.icon,`\n  --icon-color: ${s.theme.text};\n  margin-right: 8px;\n  width: 20px;\n  height: 20px;\n`),D=(0,r.styled)(C,"\n  width: 24px;\n  height: 24px;\n"),R=179==o.j?D:null,T=`\n  display: flex;\n  align-items: center;\n  height: 40px;\n  line-height: 40px;\n  margin-bottom: 8px;\n  margin-right: -16px;\n  color: ${s.theme.text};\n  font-size: ${s.vars.mediumFontSize};\n  font-weight: bold;\n  &, &:hover, &:focus {\n    text-decoration: none;\n    outline: none;\n    color: inherit;\n  }\n`,k=(0,r.styled)("a",T),M=(0,r.styled)("div",T),O=(0,r.styled)("div",`\n  color: ${s.theme.text};\n  flex: 1 0 50%;\n  min-width: 0px;\n  margin-right: 24px;\n`),A=(0,r.styled)("div",`\n  position: relative;\n  margin: 0px -16px 8px -16px;\n  border-radius: 3px;\n  font-size: ${s.vars.mediumFontSize};\n  color: ${s.theme.text};\n  --icon-color: ${s.theme.lightText};\n\n  &:hover, &.weasel-popup-open, &-renaming {\n    background-color: ${s.theme.hover};\n  }\n`),P=(0,r.styled)("a",`\n  display: flex;\n  align-items: center;\n  height: 40px;\n  line-height: 40px;\n  border-radius: 3px;\n  outline: none;\n  transition: background-color 2s;\n  &, &:hover, &:focus {\n    text-decoration: none;\n    outline: none;\n    color: inherit;\n  }\n  &-no-access, &-no-access:hover, &-no-access:focus {\n    color: ${s.theme.disabledText};\n    cursor: not-allowed;\n  }\n`),F=(0,r.styled)("div","\n  flex: 1 0 50%;\n  min-width: 0px;\n  margin: 0 16px;\n  display: flex;\n  align-items: center;\n"),E=(0,r.styled)("div","\n  flex: 0 1 auto;\n  white-space: nowrap;\n  overflow: hidden;\n  text-overflow: ellipsis;\n"),B=(0,r.styled)(n.icon,`\n  flex: none;\n  margin-left: 4px;\n  --icon-color: ${s.theme.accentIcon};\n`),L=(0,r.styled)(n.icon,`\n  flex: none;\n  margin-left: auto;\n  --icon-color: ${s.theme.accentIcon};\n`),$=(0,r.styled)(i.o,"\n  flex: 1 0 50%;\n  min-width: 0px;\n  margin: 0 16px;\n  color: initial;\n  font-size: inherit;\n  line-height: initial;\n"),U=(0,r.styled)("div",`\n  flex: 1 1 50%;\n  color: ${s.theme.lightText};\n  white-space: nowrap;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  font-weight: normal;\n`),z=(0,r.styled)("div",`\n  flex: none;\n  margin: 0 4px 0 auto;\n  height: 24px;\n  width: 24px;\n  padding: 4px;\n  line-height: 0px;\n  border-radius: 3px;\n  cursor: default;\n  --icon-color: ${s.theme.docMenuDocOptionsFg};\n  .${P.className}:hover > & {\n    --icon-color: ${s.theme.docMenuDocOptionsHoverFg};\n  }\n  &:hover, &.weasel-popup-open {\n    background-color: ${s.theme.docMenuDocOptionsHoverBg};\n    --icon-color: ${s.theme.docMenuDocOptionsHoverFg};\n  }\n`),V=(0,r.styled)("div",`\n  display: flex;\n  flex-direction: column;\n  border-bottom: 1px solid ${s.theme.modalBorderDark};\n  margin: 0 -64px;\n  height: 200px;\n`),N=(0,r.styled)("div",`\n  display: flex;\n  justify-content: space-between;\n  width: 100%;\n  height: 32px;\n  padding: 12px 64px;\n  cursor: pointer;\n  font-size: ${s.vars.mediumFontSize};\n\n  &-selected {\n    background-color: ${s.theme.moveDocsSelectedBg};\n    color: ${s.theme.moveDocsSelectedFg};\n  }\n  &-disabled {\n    color: ${s.theme.moveDocsDisabledFg};\n    cursor: default;\n  }\n`),j=(0,r.styled)("div","\n  display: flex;\n  flex: 1 1 0;\n  flex-direction: column;\n  justify-content: center;\n"),W=(0,r.styled)(j,"\n  text-align: right;\n"),H=(0,r.styled)("div","\n  display: flex;\n  align-items: center;\n  height: 80px;\n  margin: auto;\n  margin-top: 80px;\n"),G=(0,r.styled)("div","\n  float: right;\n  display: flex;\n  align-items: center;\n"),K=(0,r.styled)("div",`\n  margin-right: 24px;\n\n  /* negate the styles of a select that normally looks like a button */\n  border: none;\n  display: inline-flex;\n  height: unset;\n  line-height: unset;\n  align-items: center;\n  border-radius: ${s.vars.controlBorderRadius};\n  color: ${s.theme.controlFg};\n  --icon-color: ${s.theme.controlFg};\n  background-color: unset;\n\n  &:focus, &:hover {\n    outline: none;\n    box-shadow: none;\n    background-color: ${s.theme.hover};\n  }\n  @media ${s.mediaSmall} {\n    & {\n      margin-right: 0;\n    }\n  }\n`),J=(0,r.styled)("div",`\n  margin-left: 32px;\n\n  @media ${s.mediaSmall} {\n    & {\n      margin-left: 8px;\n    }\n  }\n`),X=(0,r.styled)("div","\n  margin-left: 64px;\n")},84602:(e,t,o)=>{"use strict";o.d(t,{ED:()=>w,K1:()=>v,Ot:()=>y,_5:()=>d,ct:()=>b,gQ:()=>_});var i=o(97837),s=o(29922),n=o(7454),r=o(4425),l=o(1310);let a=null;function d(e,t){const{elem:o,markAsSeen:n,reopen:r}=t,d=e.welcomeCard;if(!d)return null;const x=h(p({src:e.imgUrl}),m(g(d.title),f(d.text),w(b(v("Page"),d.tutorialName,{href:e.tutorialUrl,target:"_blank"}))),y(_("CrossBig"),l.dom.on("click",(function(){a=null,function(e,t){new i.T9(e).onDispose((()=>c(e))),u(e,t)}(x,o.getBoundingClientRect()),n()})),(0,s.testId)("example-card-close")),(0,s.testId)("example-card"));document.body.appendChild(x),r&&function(e,t){(0,i.b1)(e,(()=>u(e,t))),Object.assign(e.style,{transform:"",opacity:"",visibility:"visible"})}(x,o.getBoundingClientRect()),null==a||a(),a=()=>c(x)}function c(e){l.dom.domDispose(e),e.remove()}function u(e,t){const o=e.getBoundingClientRect(),i=t.left+t.width/2-o.left,s=t.top+t.height/2-o.top;Object.assign(e.style,{transform:`scale(${t.width/o.width}, ${t.height/o.height})`,transformOrigin:`${i}px ${s}px`,opacity:"0"})}const h=(0,l.styled)("div",`\n  position: absolute;\n  left: 24px;\n  bottom: 24px;\n  margin-right: 24px;\n  max-width: 624px;\n  padding: 32px 56px 32px 32px;\n  background-color: ${s.theme.popupBg};\n  box-shadow: 0 2px 18px 0 ${s.theme.popupInnerShadow}, 0 0 1px 0 ${s.theme.popupOuterShadow};\n  display: flex;\n  overflow: hidden;\n  transition-property: opacity, transform;\n  transition-duration: 0.5s;\n  transition-timing-func: ease-in;\n  --title-font-size: ${s.vars.headerControlFontSize};\n\n  @media ${s.mediaXSmall} {\n    & {\n      flex-direction: column;\n      padding: 32px;\n      --title-font-size: 18px;\n    }\n  }\n`),p=(0,l.styled)("img",`\n  flex: none;\n  width: 180px;\n  height: 140px;\n  margin: 0 16px 0 -8px;\n  @media ${s.mediaXSmall} {\n    & {\n      margin: auto;\n    }\n  }\n`),m=(0,l.styled)("div",`\n  color: ${s.theme.text};\n  min-width: 0px;\n`),g=(0,l.styled)("div",`\n  color: ${s.theme.text};\n  font-size: var(--title-font-size);\n  font-weight: ${s.vars.headerControlTextWeight};\n  margin-bottom: 16px;\n`),f=(0,l.styled)("div","\n  margin: 16px 0 24px 0;\n  line-height: 1.6;\n"),w=(0,l.styled)("div","\n  display: flex;\n"),b=(0,l.styled)(r.Y3,"\n  &:not(:last-child) {\n    margin-right: 32px;\n  }\n"),v=(0,l.styled)(n.icon,"\n  margin-right: 8px;\n  margin-top: -2px;\n"),y=(0,l.styled)("div",`\n  position: absolute;\n  top: 8px;\n  right: 8px;\n  padding: 4px;\n  border-radius: 4px;\n  cursor: pointer;\n  --icon-color: ${s.theme.popupCloseButtonFg};\n\n  &:hover {\n    background-color: ${s.theme.hover};\n  }\n`),_=(0,l.styled)(n.icon,"\n  padding: 12px;\n")},67583:(e,t,o)=>{"use strict";o.r(t),o.d(t,{FieldContextMenu:()=>a});var i=o(77709),s=o(70387),n=o(1370),r=o(1310);const l=(0,s.makeT)("FieldContextMenu");function a(e,t){const{disableModify:o,isReadonly:s}=t,a=r.dom.cls("disabled",o||s);return[(0,n.menuItemCmd)(i.allCommands.contextMenuCut,l("Cut"),a),(0,n.menuItemCmd)(i.allCommands.contextMenuCopy,l("Copy")),(0,n.menuItemCmd)(i.allCommands.contextMenuPaste,l("Paste"),a),(0,n.menuDivider)(),(0,n.menuItemCmd)(i.allCommands.clearCardFields,l("Clear field"),a),(0,n.menuItemCmd)(i.allCommands.hideCardFields,l("Hide field")),(0,n.menuDivider)(),(0,n.menuItemCmd)(i.allCommands.copyLink,l("Copy anchor link"))]}},7916:(e,t,o)=>{"use strict";o.r(t),o.d(t,{ColumnAddMenu:()=>h,ColumnContextMenu:()=>m,MultiColumnMenu:()=>g,calcFieldsCondition:()=>p,freezeAction:()=>f});var i=o(70387),s=o(77709),n=o(29922),r=o(7454),l=o(1370),a=o(48210),d=o(1310);const c=o(36812),u=(0,i.makeT)("GridViewMenus");function h(e,t){return[(0,l.menuItem)((()=>e.addNewColumn()),u("Add Column")),(0,l.menuDivider)(),...t.hiddenColumns().map((o=>(0,l.menuItem)((()=>{e.showColumn(o.id(),t.viewFields().peekLength)}),u("Show column {{- label}}",{label:o.label()}))))]}function p(e,t){return!!e.every(t)||!!e.some(t)&&"mixed"}function m(e){const{disableModify:t,filterOpenFunc:o,colId:i,sortSpec:h,isReadonly:p}=e,m=d.dom.cls("disabled",Boolean(t)||p),f=function(e,t){const o=e.map((e=>a.Sort.getColRef(e)));if(0!==e.length&&!c(o,[t])){const e=o.indexOf(t);return e>-1?u("Sorted (#{{count}})",{count:e+1}):u("Add to sort")}}(h,i);return[(0,l.menuItemCmd)(s.allCommands.fieldTabOpen,u("Column Options")),(0,l.menuItem)(o,u("Filter Data")),(0,l.menuDivider)({style:"margin-bottom: 0;"}),b(_(s.allCommands.sortAsc.run,(0,d.dom)("span",u("Sort"),{style:"flex: 1  0 auto; margin-right: 8px;"},(0,n.testId)("sort-label")),(0,r.icon)("Sort",d.dom.style("transform","scaley(-1)")),"A-Z",d.dom.style("flex",""),y.cls("-selected",a.Sort.containsOnly(h,i,a.Sort.ASC)),(0,n.testId)("sort-asc")),_(s.allCommands.sortDesc.run,(0,r.icon)("Sort"),"Z-A",y.cls("-selected",a.Sort.containsOnly(h,i,a.Sort.DESC)),(0,n.testId)("sort-dsc")),(0,n.testId)("sort")),f?[b(_(s.allCommands.addSortAsc.run,v(f,(0,n.testId)("add-to-sort-label")),(0,r.icon)("Sort",d.dom.style("transform","scaley(-1)")),"A-Z",y.cls("-selected",a.Sort.contains(h,i,a.Sort.ASC)),(0,n.testId)("add-to-sort-asc")),_(s.allCommands.addSortDesc.run,(0,r.icon)("Sort"),"Z-A",y.cls("-selected",a.Sort.contains(h,i,a.Sort.DESC)),(0,n.testId)("add-to-sort-dsc")),(0,n.testId)("add-to-sort"))]:null,(0,l.menuDivider)({style:"margin-bottom: 0; margin-top: 0;"}),(0,l.menuItem)(s.allCommands.sortFilterTabOpen.run,u("More sort options ..."),(0,n.testId)("more-sort-options")),(0,l.menuDivider)({style:"margin-top: 0;"}),(0,l.menuItemCmd)(s.allCommands.renameField,u("Rename column"),m),w(e),(0,l.menuDivider)(),g((e.disableFrozenMenu=!0,e)),(0,n.testId)("column-menu")]}function g(e){const t=d.dom.cls("disabled",Boolean(e.disableModify)||e.isReadonly),o=d.dom.cls("disabled",e.isReadonly),i=e.numColumns,n=e.isFiltered?u("Reset {{count}} entire columns",{count:i}):u("Reset {{count}} columns",{count:i}),r=u("Delete {{count}} columns",{count:i}),a=u("Hide {{count}} columns",{count:i}),c=e.disableFrozenMenu?null:w(e);return[c?[c,(0,l.menuDivider)()]:null,e.isFormula?(0,l.menuItemCmd)(s.allCommands.convertFormulasToData,u("Convert formula to data"),t):null,!0!==e.isFormula?(0,l.menuItemCmd)(s.allCommands.clearValues,u("Clear values"),t):null,e.isRaw?null:(0,l.menuItemCmd)(s.allCommands.hideFields,a,o),(0,l.menuItemCmd)(s.allCommands.clearColumns,n,t),(0,l.menuItemCmd)(s.allCommands.deleteFields,r,t),(0,l.menuDivider)(),(0,l.menuItemCmd)(s.allCommands.insertFieldBefore,u("Insert column to the left"),o),(0,l.menuItemCmd)(s.allCommands.insertFieldAfter,u("Insert column to the right"),o)]}function f(e){const t=e.numColumns;if(0===t)return null;const o=e.columnIndices,i=o[0],s=o[o.length-1],n=e.numFrozen;if(s==e.totalColumnCount-1)return null;const r=1===t&&i+1>n,l=1===t&&i+1<=n,a=t>1,d=a&&i===n,c=a&&i<=n&&s>=n;let h="";if(a){if(a&&s+1===n)return h=u("Unfreeze {{count}} columns",{count:t}),{text:h,numFrozen:n-t};if(d)return h=u("Freeze {{count}} columns",{count:t}),{text:h,numFrozen:n+t};if(c){const e=s+1-n;return h=u("Freeze {{count}} more columns",{count:e}),{text:h,numFrozen:n+e}}return null}if(r){if(0===i||i===n)h=u("Freeze {{count}} columns",{count:1});else{h=u(n?"Freeze {{count}} more columns":"Freeze {{count}} columns",{count:i-n+1})}return{text:h,numFrozen:i+1}}if(l){if(i+1===n)h=u("Unfreeze {{count}} columns",{count:1});else{const e=n-i;h=e===n?u("Unfreeze all columns"):u("Unfreeze {{count}} columns",{count:e})}return{text:h,numFrozen:o[0]}}return null}function w(e){const t=f(e);return t?(0,l.menuItemCmd)(s.allCommands.toggleFreeze,t.text):null}const b=(0,d.styled)(((...e)=>(0,d.dom)("li",{tabindex:"-1"},...e)),"\n  display: flex;\n  outline: none;\n"),v=(0,d.styled)("div","\n  margin-right: 8px;\n  flex: 1 0 auto;\n"),y=(0,d.styled)("div",`\n  padding: 8px 8px;\n  display: flex;\n  &:not(:hover) {\n    background-color: ${n.theme.menuBg};\n    color: ${n.theme.menuItemFg};\n    --icon-color: ${n.theme.menuItemFg};\n  }\n  &:last-of-type {\n    padding-right: 24px;\n    flex: 0 0 auto;\n  }\n  &:first-of-type {\n    padding-left: 24px;\n    flex: 1 0 auto;\n  }\n  &-selected, &-selected:not(:hover) {\n    background-color: ${n.theme.menuItemSelectedBg};\n    color: ${n.theme.menuItemSelectedFg};\n    --icon-color: ${n.theme.menuItemSelectedFg};\n  }\n`);function _(e,...t){return y(...t,d.dom.on("click",(()=>e())))}},42882:(e,t,o)=>{"use strict";o.r(t),o.d(t,{menuToggle:()=>r});var i=o(29922),s=o(7454),n=o(1310);function r(e,...t){return l((0,s.icon)("Dropdown",n.dom.cls("menu_toggle_icon")),...t)}const l=(0,n.styled)("div.menu_toggle",`\n  background: ${i.theme.menuToggleBg};\n  cursor: pointer;\n  --icon-color: ${i.theme.menuToggleFg};\n  border: 1px solid ${i.theme.menuToggleBorder};\n  border-radius: 4px;\n  &:hover  {\n    --icon-color: ${i.theme.menuToggleHoverFg};\n    border-color: ${i.theme.menuToggleHoverFg};\n  }\n  &:active  {\n    --icon-color: ${i.theme.menuToggleActiveFg};\n    border-color: ${i.theme.menuToggleActiveFg};\n  }\n  & > .menu_toggle_icon {\n    display: block; /* don't create a line */\n  }\n`)},73154:(e,t,o)=>{"use strict";o.d(t,{F5:()=>u,GM:()=>l,g8:()=>c,xY:()=>a});var i=o(29922),s=o(91033),n=o(29002),r=o(1310);const l=(0,r.styled)("div",`\n  display: flex;\n  flex-direction: column;\n  min-width: 280px;\n  padding: 16px;\n  background-color: ${i.theme.popupBg};\n  border-radius: 2px;\n  outline: none;\n`),a=(0,r.styled)("label",`\n  color: ${i.theme.text};\n  font-size: ${i.vars.xsmallFontSize};\n  font-weight: ${i.vars.bigControlTextWeight};\n  text-transform: uppercase;\n  margin: 0 0 8px 0;\n  &:not(:first-child) {\n    margin-top: 16px;\n  }\n`),d=(0,r.styled)("div","\n  position: relative;\n  display: flex;\n  flex-direction: column;\n"),c=(0,r.styled)(((e,t,...o)=>(0,r.input)(e,t,n.cssTextInput.cls(""),...o)),`\n  text-overflow: ellipsis;\n  color: ${i.theme.inputFg};\n  background-color: transparent;\n  &:disabled {\n    color: ${i.theme.inputDisabledFg};\n    background-color: ${i.theme.inputDisabledBg};\n    pointer-events: none;\n  }\n  &::placeholder {\n    color: ${i.theme.inputPlaceholderFg};\n  }\n  .${d.className} > &:disabled {\n    padding-right: 28px;\n  }\n`),u=(0,r.styled)(s.J7,`\n  color: ${i.theme.inputFg};\n  background-color: ${i.theme.mainPanelBg};\n  border: 1px solid ${i.theme.inputBorder};\n  width: 100%;\n  padding: 3px 6px;\n  outline: none;\n  max-width: 100%;\n  min-width: calc(280px - 16px*2);\n  max-height: 500px;\n  min-height: calc(3em * 1.5);\n  resize: none;\n  border-radius: 3px;\n  &::placeholder {\n    color: ${i.theme.inputPlaceholderFg};\n  }\n\n  &[readonly] {\n    background-color: ${i.theme.inputDisabledBg};\n    color: ${i.theme.inputDisabledFg};\n  }\n`)},19085:(e,t,o)=>{"use strict";o.r(t),o.d(t,{RowContextMenu:()=>a});var i=o(77709),s=o(70387),n=o(1370),r=o(1310);const l=(0,s.makeT)("RowContextMenu");function a({disableInsert:e,disableDelete:t,isViewSorted:o,numRows:s}){const a=[];return o?a.push((0,n.menuItemCmd)(i.allCommands.insertRecordAfter,l("Insert row"),r.dom.cls("disabled",e))):a.push((0,n.menuItemCmd)(i.allCommands.insertRecordBefore,l("Insert row above"),r.dom.cls("disabled",e)),(0,n.menuItemCmd)(i.allCommands.insertRecordAfter,l("Insert row below"),r.dom.cls("disabled",e))),a.push((0,n.menuItemCmd)(i.allCommands.duplicateRows,l("Duplicate rows",{count:s}),r.dom.cls("disabled",e||0===s))),a.push((0,n.menuDivider)(),(0,n.menuItemCmd)(i.allCommands.deleteRecords,l("Delete"),r.dom.cls("disabled",t))),a.push((0,n.menuDivider)(),(0,n.menuItemCmd)(i.allCommands.copyLink,l("Copy anchor link"))),a}},19058:(e,t,o)=>{"use strict";o.d(t,{KA:()=>h,ND:()=>m,T7:()=>l,XL:()=>a,bE:()=>b,dg:()=>g,fe:()=>w,gE:()=>u,hS:()=>p,j$:()=>f,rk:()=>d,tE:()=>c});var i=o(29922),s=o(7454),n=o(1310),r=o(21467);const l=(0,n.styled)("div","\n  display: flex;\n  width: 460px;\n  min-height: 64px;\n  margin: 0 auto;\n  padding: 12px 0;\n"),a=(0,n.styled)("div",`\n  width: 40px;\n  height: 40px;\n  margin: 0 4px;\n  border-radius: 20px;\n  background-color: ${i.colors.lightGreen};\n  background-size: cover;\n\n  .${l.className}-removed & {\n    opacity: 0.4;\n  }\n`),d=(0,n.styled)("div",`\n  display: flex;\n  flex-direction: column;\n  justify-content: center;\n  margin: 2px 12px;\n  flex: 1 1 0;\n  min-width: 0px;\n  font-size: ${i.vars.mediumFontSize};\n\n  .${l.className}-removed & {\n    opacity: 0.4;\n  }\n`),c=(0,n.styled)("span",`\n  font-weight: bold;\n  color: ${i.theme.text};\n  padding: 2px 0;\n\n  .${r.cssMenuItem.className}-sel & {\n    color: ${i.theme.menuItemSelectedFg};\n  }\n`),u=(0,n.styled)("span",`\n  color: ${i.theme.lightText};\n  /* the following just undo annoying bootstrap styles that apply to all labels */\n  margin: 0px;\n  font-weight: normal;\n  padding: 2px 0;\n  white-space: nowrap;\n\n  .${r.cssMenuItem.className}-sel & {\n    color: ${i.theme.menuItemSelectedFg};\n  }\n`),h=(0,n.styled)("span",`\n  color: ${i.theme.lightText};\n  /* the following just undo annoying bootstrap styles that apply to all labels */\n  margin: 0px;\n  font-weight: normal;\n  padding: 2px 0;\n  white-space: nowrap;\n\n  .${r.cssMenuItem.className}-sel & {\n    color: ${i.theme.menuItemSelectedFg};\n  }\n`),p=(0,n.styled)("span",`\n  color: ${i.theme.errorText};\n  /* the following just undo annoying bootstrap styles that apply to all labels */\n  margin: 0px;\n  font-weight: normal;\n  padding: 2px 0;\n  white-space: nowrap;\n\n  .${r.cssMenuItem.className}-sel & {\n    color: ${i.theme.menuItemSelectedFg};\n  }\n`),m=(0,n.styled)("div","\n  width: 16px;\n  height: 16px;\n  cursor: pointer;\n\n  &-disabled {\n    opacity: 0.3;\n    cursor: default;\n  }\n"),g=(0,n.styled)(s.icon,`\n  background-color: ${i.theme.lightText};\n  margin: 12px 0;\n`),f=(0,n.styled)("div",`\n  position: relative;\n  display: flex;\n  height: 42px;\n  padding: 0 3px;\n  margin: 16px 63px;\n  border: 1px solid ${i.theme.inputBorder};\n  border-radius: 3px;\n  font-size: ${i.vars.mediumFontSize};\n  outline: none;\n\n  &-green {\n    border: 1px solid ${i.theme.inputValid};\n  }\n`),w=(0,n.styled)(n.input,`\n  color: ${i.theme.inputFg};\n  background-color: ${i.theme.inputBg};\n  flex: 1 1 0;\n  font-size: ${i.vars.mediumFontSize};\n  font-family: ${i.vars.fontFamily};\n  outline: none;\n  border: none;\n\n  &::placeholder {\n    color: ${i.theme.inputPlaceholderFg};\n  }\n`),b=(0,n.styled)(s.icon,`\n  margin: 12px 8px 12px 13px;\n  background-color: ${i.theme.lightText};\n`)},66986:(e,t,o)=>{"use strict";o.d(t,{D:()=>g,f:()=>p});var i=o(11527),s=o(83277),n=o(1310),r=o(29301),l=o.n(r),a=Object.defineProperty,d=Object.getOwnPropertySymbols,c=Object.prototype.hasOwnProperty,u=Object.prototype.propertyIsEnumerable,h=(e,t,o)=>t in e?a(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,p=(e=>(e[e.Unstarted=-1]="Unstarted",e[e.Ended=0]="Ended",e[e.Playing=1]="Playing",e[e.Paused=2]="Paused",e[e.Buffering=3]="Buffering",e[e.VideoCued=5]="VideoCued",e))(p||{});const m=(0,i.get)("document","window");class g extends n.Disposable{constructor(e,t,...o){var i;if(super(),this._videoId=e,this._options=t,this._isLoading=l().observable(!0),this._playerId=`youtube-player-${this._videoId}`,this._domArgs=o,m.window.YT)setTimeout((()=>this._handleYouTubeIframeAPIReady()),0);else{const e=document.createElement("script");e.src="https://www.youtube.com/iframe_api";const t=document.getElementsByTagName("script")[0];null==(i=null==t?void 0:t.parentNode)||i.insertBefore(e,t),m.window.onYouTubeIframeAPIReady=()=>this._handleYouTubeIframeAPIReady()}}isLoading(){return this._isLoading()}isLoaded(){return(0,s.waitObs)(this._isLoading,(e=>!e))}play(){this._player.playVideo()}setVolume(e){this._player.setVolume(e)}getCurrentTime(){return this._player.getCurrentTime()}buildDom(){return(0,n.dom)("div",{id:this._playerId},...this._domArgs)}_handleYouTubeIframeAPIReady(){const e=this._options,{onPlayerReady:t,onPlayerStateChange:o,playerVars:i}=e,s=((e,t)=>{var o={};for(var i in e)c.call(e,i)&&t.indexOf(i)<0&&(o[i]=e[i]);if(null!=e&&d)for(var i of d(e))t.indexOf(i)<0&&u.call(e,i)&&(o[i]=e[i]);return o})(e,["onPlayerReady","onPlayerStateChange","playerVars"]);this._player=new m.window.YT.Player(this._playerId,((e,t)=>{for(var o in t||(t={}))c.call(t,o)&&h(e,o,t[o]);if(d)for(var o of d(t))u.call(t,o)&&h(e,o,t[o]);return e})({videoId:this._videoId,playerVars:i,events:{onReady:()=>{this._isLoading(!1),null==t||t(this._player)},onStateChange:e=>null==o?void 0:o(this._player,e)}},s))}}},74624:(e,t,o)=>{"use strict";o.r(t),o.d(t,{contextMenu:()=>l});var i=o(1310),s=o(1370),n=o(21467);class r extends i.Disposable{constructor(e,t){super(),this._event=e,setTimeout((()=>this._updatePosition()),0);const o=n.Menu.create(null,this,[t(this)],{menuCssClass:s.cssMenuElem.className+" grist-floating-menu"}),r=this._content=o.content;r.style.visibility="hidden",document.body.appendChild(r),i.dom.onKeyElem(r,"keydown",{ArrowLeft:e=>e.stopPropagation(),ArrowRight:e=>e.stopPropagation()});const l=e=>{const t=e.target;t&&!r.contains(t)&&this.close()};this.autoDispose(i.dom.onElem(document,"contextmenu",l,{useCapture:!0})),this.autoDispose(i.dom.onElem(document,"click",l,{useCapture:!0})),this.onDispose((()=>{i.dom.domDispose(r),r.remove()})),(0,s.registerMenuOpen)(this)}close(){this.dispose()}setOpenClass(){}getTriggerElem(){return document.body}update(){}_updatePosition(){const e=this._content,t=this._event,o=e.getBoundingClientRect();e.style.left=(t.pageX+o.width<window.innerWidth?t.pageX:t.pageX-o.width)+"px",e.style.bottom=Math.max(window.innerHeight-(t.pageY+o.height),0)+"px",e.style.visibility=""}}function l(e){return t=>{const o=i.Holder.create(null);i.dom.autoDisposeElem(t,o),i.dom.onElem(t,"contextmenu",(t=>{t.preventDefault(),t.stopPropagation(),r.create(o,t,e)}))}}},68370:(e,t,o)=>{"use strict";o.d(t,{o:()=>r});var i=o(38109),s=o(29922),n=o(1310);function r({initialValue:e,save:t,close:o},...s){let r=e;async function a(e){try{(e||c.value!==r)&&(r=c.value,await t(c.value)),o()}catch(e){(0,i.eK)(e),d()}}function d(){setTimeout((()=>{c.focus(),c.select()}),10)}const c=l({type:"text",placeholder:"Enter name"},n.dom.prop("value",e),n.dom.on("blur",(()=>a(!1))),n.dom.onKeyDown({Enter:()=>a(!0),Escape:()=>o()}),...s);return d(),c}const l=(0,n.styled)("input",`\n  background-color: transparent;\n  color: ${s.theme.inputFg};\n\n  &::placeholder {\n    color: ${s.theme.inputPlaceholderFg};\n  }\n`)},76949:(e,t,o)=>{"use strict";o.d(t,{$1:()=>_,$5:()=>y,Ah:()=>k,KV:()=>x,Md:()=>f,WR:()=>R,ez:()=>C,iK:()=>S,pf:()=>I,se:()=>v,tg:()=>D});var i=Object.defineProperty,s=Object.defineProperties,n=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,l=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,d=(e,t,o)=>t in e?i(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,c=(e,t)=>{for(var o in t||(t={}))l.call(t,o)&&d(e,o,t[o]);if(r)for(var o of r(t))a.call(t,o)&&d(e,o,t[o]);return e},u=(e,t)=>s(e,n(t));const h=o(66287),p=o(87604),m={R:"read",C:"create",U:"update",D:"delete",S:"schemaEdit"},g="CRUDS",f=Array.from(g,(e=>m[e])),w={all:"+CRUDS",none:"-CRUDS"},b=h(Object.entries(w).map((([e,t])=>[t,e])));function v(){return{read:"",create:"",update:"",delete:"",schemaEdit:""}}function y(e){w.hasOwnProperty(e)&&(e=w[e]);const t={read:"",create:"",update:"",delete:"",schemaEdit:""};let o="";for(const i of e)if("+"===i)o="allow";else if("-"===i)o="deny";else{if(!m.hasOwnProperty(i)||""===o)throw new Error(`Invalid permissions specification ${JSON.stringify(e)}`);t[m[i]]=o}return t}function _(e){let t="",o="";for(const i of g){const s=e[m[i]];"allow"===s?t+=i:"deny"===s&&(o+=i)}const i=(t?"+"+t:"")+(o?"-"+o:"");return b[i]||i}function x(e){return p(e,(e=>"allow"===e?"allowSome":"deny"===e?"denySome":e))}function C(e,t){return S([e,t],(([e,t])=>function(e,t){return e?t?"allowSome"===e?"allowSome"===t||"allow"===t?t:"mixed":"denySome"===e?"denySome"===t||"deny"===t?t:"mixed":e:e:t}(e,t)))}function S(e,t){const o={};for(const i of f)o[i]=t(e.map((e=>e[i])));return o}function I(e){return S([e],(([e])=>"allow"===e||"mixed"===e?e:"deny"))}function D(e){let t="";for(const o of Object.keys(e)){const i=e[o],s="allowSome"===i?"allow":"denySome"===i?"deny":i;s&&s!==t&&(t=t?"mixed":s)}return"allow"===t||"deny"===t?t:"mixed"}function R(e){if(0===e.length)return"mixed";const t=e[0];return e.some((e=>e!==t))?"mixed":t}function T(e){return Object.values(e).every((e=>""===e))}function k(e){const t=u(c({},{read:"",create:"",update:"",delete:"",schemaEdit:""}),{schemaEdit:e.schemaEdit}),o=u(c({},e),{schemaEdit:""});return{schemaEdit:T(t)?void 0:t,nonSchemaEdit:!T(o)||T(t)?o:void 0}}},27771:(e,t,o)=>{"use strict";o.d(t,{GY:()=>w,Zu:()=>x,k9:()=>v});var i=o(76949),s=o(83277),n=o(93965),r=Object.defineProperty,l=Object.defineProperties,a=Object.getOwnPropertyDescriptors,d=Object.getOwnPropertySymbols,c=Object.prototype.hasOwnProperty,u=Object.prototype.propertyIsEnumerable,h=(e,t,o)=>t in e?r(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,p=(e,t)=>{for(var o in t||(t={}))c.call(t,o)&&h(e,o,t[o]);if(d)for(var o of d(t))u.call(t,o)&&h(e,o,t[o]);return e},m=(e,t)=>l(e,a(t));const g=o(91944),f=()=>!0,w="*SPECIAL",b={tableId:"*",colIds:"*",body:[{aclFormula:"user.Access in [EDITOR, OWNER]",matchFunc:e=>["editors","owners"].includes(String(e.user.Access)),permissions:(0,i.$5)("all"),permissionsText:"all"},{aclFormula:"user.Access in [VIEWER]",matchFunc:e=>["viewers"].includes(String(e.user.Access)),permissions:(0,i.$5)("+R-CUDS"),permissionsText:"+R"},{aclFormula:"",matchFunc:f,permissions:(0,i.$5)("none"),permissionsText:"none"}]};function v(e){return e.tableId===w&&"SchemaEdit"===e.colIds}const y={SchemaEdit:{tableId:w,colIds:["SchemaEdit"],body:[{aclFormula:"user.Access in [EDITOR, OWNER]",matchFunc:e=>["editors","owners"].includes(String(e.user.Access)),permissions:(0,i.$5)("+S"),permissionsText:"+S"},{aclFormula:"",matchFunc:f,permissions:(0,i.$5)("-S"),permissionsText:"-S"}]},AccessRules:{tableId:w,colIds:["AccessRules"],body:[{aclFormula:"user.Access in [OWNER]",matchFunc:e=>["owners"].includes(String(e.user.Access)),permissions:(0,i.$5)("+R"),permissionsText:"+R"},{aclFormula:"",matchFunc:f,permissions:(0,i.$5)("-R"),permissionsText:"-R"}]},FullCopies:{tableId:w,colIds:["FullCopies"],body:[{aclFormula:"user.Access in [OWNER]",matchFunc:e=>["owners"].includes(String(e.user.Access)),permissions:(0,i.$5)("+R"),permissionsText:"+R"},{aclFormula:"",matchFunc:f,permissions:(0,i.$5)("-R"),permissionsText:"-R"}]},SeedRule:{tableId:w,colIds:["SeedRule"],body:[]}},_={tableId:"*",colIds:"*",body:[{aclFormula:"user.Access in [OWNER]",matchFunc:e=>["owners"].includes(String(e.user.Access)),permissions:(0,i.$5)("all"),permissionsText:"all"},{aclFormula:"",matchFunc:f,permissions:(0,i.$5)("none"),permissionsText:"none"}]};class x{constructor(){this._haveRules=!1,this._columnRuleSets=new Map,this._tableColumnMap=new Map,this._specialRuleSets=new Map,this._tableRuleSets=new Map,this._defaultRuleSet=b,this._tableIds=[],this._userAttributeRules=new Map}haveRules(){return this._haveRules}getColumnRuleSet(e,t){return e===w?this._specialRuleSets.get(t):this._tableColumnMap.get(`${e}:${t}`)}getAllColumnRuleSets(e){return this._columnRuleSets.get(e)||[]}getTableDefaultRuleSet(e){return this._tableRuleSets.get(e)}getDocDefaultRuleSet(){return this._defaultRuleSet}getAllTableIds(){return this._tableIds}getUserAttributeRules(){return this._userAttributeRules}async update(e,t){const{ruleSets:o,userAttributes:i}=this._safeReadAclRules(e,t),n=new Map;for(const e of i)n.set(e.name,e);const r=new Map,l=new Map,a=new Map,d=new Set;let c=b;const u=new Map(Object.entries(y));for(const e of o)if(e.tableId===w){const o=String(e.colIds),i=u.get(o);i?u.set(o,m(p({},e),{body:[...e.body,...i.body]})):t.log.error(`Invalid rule for ${e.tableId}:${e.colIds}`)}else if(t.pullOutSchemaEdit&&"*"===e.tableId&&"*"===e.colIds){const t=e.body.map((e=>S(e).schemaEdit)).filter(s.isNonNullish);if(t.length>0){const e="SchemaEdit",o=u.get(e);u.set(e,{tableId:w,colIds:["SchemaEdit"],body:[...t,...o.body]})}}for(const e of u.values())(0,s.getSetMapValue)(r,w,(()=>[])).push(e);this._haveRules=o.length>0;for(const e of o)if("*"===e.tableId){if("*"!==e.colIds)throw new Error(`Invalid rule for tableId ${e.tableId}, colIds ${e.colIds}`);{const o=t.pullOutSchemaEdit?e.body.map((e=>S(e).nonSchemaEdit)).filter(s.isNonNullish):e.body;c=m(p({},e),{body:[...o,...b.body]})}}else if(e.tableId===w);else if("*"===e.colIds){if(d.add(e.tableId),a.has(e.tableId))throw new Error(`Invalid duplicate default rule for ${e.tableId}`);a.set(e.tableId,e)}else{d.add(e.tableId),(0,s.getSetMapValue)(r,e.tableId,(()=>[])).push(e);for(const t of e.colIds)l.set(`${e.tableId}:${t}`,e)}this._columnRuleSets=r,this._tableColumnMap=l,this._tableRuleSets=a,this._defaultRuleSet=c,this._tableIds=[...d],this._userAttributeRules=n,this._specialRuleSets=u}checkDocEntities(e){const t=this.findRuleProblems(e);if(0!==t.length)throw new Error(t[0].comment)}findRuleProblems(e){const t=[],o=e.getMetaTable("_grist_Tables"),i=e.getMetaTable("_grist_Tables_column"),n=new Set(o.getColValues("tableId")),r=this.getAllTableIds().filter((e=>!n.has(e)));r.length>0&&t.push({tables:{tableIds:r},comment:`Invalid tables in rules: ${r.join(", ")}`});const l=new Map,a=i.getColValues("parentId");for(const[e,t]of i.getColValues("colId").entries())(0,s.getSetMapValue)(l,a[e],(()=>new Set)).add(t);for(const e of this.getAllTableIds()){if(!n.has(e))continue;const i=o.findRow("tableId",e),s=l.get(i);for(const o of this.getAllColumnRuleSets(e))if(Array.isArray(o.colIds)){const i=o.colIds.filter((e=>!(null==s?void 0:s.has(e))));i.length>0&&t.push({columns:{tableId:e,colIds:i},comment:`Invalid columns in rules for table ${e}: ${i.join(", ")}`})}}const d=[],c=[];for(const e of this.getUserAttributeRules().values()){const t=o.findRow("tableId",e.tableId);i.findMatchingRowId({parentId:t,colId:e.lookupColId})||(d.push(`${e.tableId}.${e.lookupColId}`),c.push(e.name))}return d.length>0&&t.push({userAttributes:{invalidUAColumns:d,names:c},comment:`Invalid columns in User Attribute rules: ${d.join(", ")}`}),t}_safeReadAclRules(e,t){try{return this.ruleError=void 0,function(e,{log:t,compile:o,includeHelperCols:n}){const r=e.getMetaTable("_grist_ACLResources"),l=e.getMetaTable("_grist_ACLRules"),a=[],d=[],c=new Map;for(const e of g(l.getRecords(),"rulePos"))(0,s.getSetMapValue)(c,e.resource,(()=>[])).push(e);for(const[s,l]of c.entries()){const c=r.getRecord(s);if(!c)throw new Error(`ACLRule ${l[0].id} refers to an invalid ACLResource ${s}`);if(!c.tableId||!c.colIds)continue;const u=c.tableId,h="*"===c.colIds?"*":c.colIds.split(",");n&&Array.isArray(h)&&h.push(...C(e,u,h,t));const p=[];for(const e of l)if(e.userAttributes){if("*"!==u||"*"!==h)throw new Error(`ACLRule ${e.id} invalid; user attributes must be on the default resource`);const t=JSON.parse(String(e.userAttributes));if(!t||"object"!=typeof t||![t.name,t.tableId,t.lookupColId,t.charId].every((e=>e&&"string"==typeof e)))throw new Error(`User attribute rule ${e.id} is invalid`);t.origRecord=e,d.push(t)}else{if(p.length>0&&!p[p.length-1].aclFormula)throw new Error(`ACLRule ${e.id} invalid because listed after default rule`);if(e.aclFormula&&!e.aclFormulaParsed)throw new Error(`ACLRule ${e.id} invalid because missing its parsed formula`);{const t=e.aclFormula&&JSON.parse(String(e.aclFormulaParsed));p.push({origRecord:e,aclFormula:String(e.aclFormula),matchFunc:e.aclFormula?null==o?void 0:o(t):f,memo:e.memo,permissions:(0,i.$5)(String(e.permissionsText)),permissionsText:String(e.permissionsText)})}}const m={tableId:u,colIds:h,body:p};a.push(m)}return{ruleSets:a,userAttributes:d}}(e,t)}catch(e){return this.ruleError=e,{ruleSets:[_],userAttributes:[]}}}}function C(e,t,o,i){const s=e.getMetaTable("_grist_Tables"),r=e.getMetaTable("_grist_Tables_column"),l=e.getMetaTable("_grist_Views_section_field"),a=s.findRow("tableId",t);if(!a)return[];const d=[];for(const e of o){let o=function(o){if(Array.isArray(o))for(const s of o){if("number"!=typeof s)continue;const o=r.getRecord(s);o&&(o.colId.startsWith("gristHelper_")&&o.parentId===a?d.push(o.colId):i.error(`Invalid helper column ${o.colId} of ${t}:${e}`))}},s=function(e){o([e.displayCol]),o((0,n.xD)(e.rules))};const[c]=r.filterRecords({parentId:a,colId:e});if(c){s(c);for(const e of l.filterRecords({colRef:c.id}))s(e)}}return d}function S(e){const t=(0,i.Ah)(e.permissions);let o,s;return t.schemaEdit&&(o=m(p({},e),{permissions:t.schemaEdit,permissionsText:(0,i.$1)(t.schemaEdit)})),t.nonSchemaEdit&&(s=m(p({},e),{permissions:t.nonSchemaEdit,permissionsText:(0,i.$1)(t.nonSchemaEdit)})),o&&s&&(o.origRecord={id:-1}),{schemaEdit:o,nonSchemaEdit:s}}},22542:(e,t,o)=>{"use strict";function i(e){return e.map((e=>e[1]))}o.d(t,{$:()=>i})},8594:(e,t,o)=>{"use strict";o.d(t,{u:()=>s});const i=o(87604);class s{dispatchAction(e){const t=e;switch(e[0]){case"AddRecord":return this.onAddRecord(e,t[1],t[2],t[3]);case"UpdateRecord":return this.onUpdateRecord(e,t[1],t[2],t[3]);case"RemoveRecord":return this.onRemoveRecord(e,t[1],t[2]);case"BulkAddRecord":return this.onBulkAddRecord(e,t[1],t[2],t[3]);case"BulkUpdateRecord":return this.onBulkUpdateRecord(e,t[1],t[2],t[3]);case"BulkRemoveRecord":return this.onBulkRemoveRecord(e,t[1],t[2]);case"ReplaceTableData":return this.onReplaceTableData(e,t[1],t[2],t[3]);case"AddColumn":return this.onAddColumn(e,t[1],t[2],t[3]);case"RemoveColumn":return this.onRemoveColumn(e,t[1],t[2]);case"RenameColumn":return this.onRenameColumn(e,t[1],t[2],t[3]);case"ModifyColumn":return this.onModifyColumn(e,t[1],t[2],t[3]);case"AddTable":return this.onAddTable(e,t[1],t[2]);case"RemoveTable":return this.onRemoveTable(e,t[1]);case"RenameTable":return this.onRenameTable(e,t[1],t[2]);default:throw new Error(`Received unknown action ${e[0]}`)}}onBulkAddRecord(e,t,o,s){for(let n=0;n<o.length;n++)this.onAddRecord(e,t,o[n],i(s,(e=>e[n])))}onBulkUpdateRecord(e,t,o,s){for(let n=0;n<o.length;n++)this.onUpdateRecord(e,t,o[n],i(s,(e=>e[n])))}onBulkRemoveRecord(e,t,o){for(const i of o)this.onRemoveRecord(e,t,i)}}},57570:(e,t,o)=>{"use strict";if(o.d(t,{RH:()=>p,Rx:()=>S,Y0:()=>m}),179==o.j)var i=o(22542);var s=o(549),n=o(413),r=o(83277);const l=o(66287),a=o(39070),d=o(91944),c=o(39898),u=o(84307);class h{constructor(e){this._options=e}addForwardAction(e,t){const o=t[1];if(n.Xq(t)){e.tableRenames.push([null,o]);for(const i of t[2])this._forTable(e,o).columnRenames.push([null,i.id])}else if(n.hm(t))this._addRename(e.tableRenames,[o,t[2]]);else if(n.hf(t))this._addRename(this._forTable(e,o).columnRenames,[t[2],t[3]]);else if(n.Bj(t))this._forTable(e,o).columnRenames.push([null,t[2]]);else if(n.QR(t))this._forTable(e,o).columnRenames.push([t[2],null]);else if(n.ol(t)){const i=this._forTable(e,o);i.addRows.push(t[2]),this._addRow(i,t[2],t[3],1)}else if(n.vo(t)){const i=this._forTable(e,o);i.updateRows.push(t[2]),this._addRow(i,t[2],t[3],1)}else if(n.hK(t)){const i=this._forTable(e,o);(0,r.arrayExtend)(i.addRows,t[2]),this._addRows(o,i,t[2],t[3],1)}else if(n.L6(t)){const i=this._forTable(e,o);(0,r.arrayExtend)(i.updateRows,t[2]),this._addRows(o,i,t[2],t[3],1)}else if(n.by(t)){const i=this._forTable(e,o);(0,r.arrayExtend)(i.addRows,t[2]),this._addRows(o,i,t[2],t[3],1)}}addReverseAction(e,t){const o=t[1];if(n.Xq(t)){e.tableRenames.push([o,null]);for(const i of t[2])this._forTable(e,o).columnRenames.push([i.id,null])}else if(n.ol(t)){const i=this._forTable(e,o);i.removeRows.push(t[2]),this._addRow(i,t[2],t[3],0)}else if(n.vo(t)){const i=this._forTable(e,o);this._addRow(i,t[2],t[3],0)}else if(n.hK(t)){const i=this._forTable(e,o);(0,r.arrayExtend)(i.removeRows,t[2]),this._addRows(o,i,t[2],t[3],0)}else if(n.L6(t)){const i=this._forTable(e,o);(0,r.arrayExtend)(i.updateRows,t[2]),this._addRows(o,i,t[2],t[3],0)}else if(n.hm(t))this._addRename(e.tableRenames,[t[2],o]);else if(n.hf(t))this._addRename(this._forTable(e,o).columnRenames,[t[3],t[2]]);else if(n.by(t)){const i=this._forTable(e,o);(0,r.arrayExtend)(i.removeRows,t[2]),this._addRows(o,i,t[2],t[3],0)}}_forTable(e,t){return e.tableDeltas[t]||(e.tableDeltas[t]=(0,s.dB)())}_forCell(e,t,o){const i=e.columnDeltas[o]||(e.columnDeltas[o]={});return i[t]||(i[t]=[null,null])}_addRow(e,t,o,i){for(const[s,n]of c(o))this._forCell(e,t,s)[i]=[n]}_addRows(e,t,o,i,s){var n,r;const l=(null==(n=this._options)?void 0:n.maximumInlineRows)||10,a=o.length>l&&!e.startsWith("_grist_");let d=[];a&&(d=[...o.slice(0,l-1).entries()],d.push([o.length-1,o[o.length-1]]));const u=new Set((null==(r=this._options)?void 0:r.alwaysPreserveColIds)||[]);for(const[e,n]of c(i)){const i=(o,i)=>{this._forCell(t,o,e)[s]=[n[i]]};!a||u.has(e)?o.forEach(i):d.forEach((([e,t])=>i(t,e)))}}_addRename(e,t){e.find((e=>e[0]===t[0]&&e[1]===t[1]))||e.push(t)}}function p(e,t){return m((0,i.$)(e.stored),e.undo,t)}function m(e,t,o){const i=new h(o),n=(0,s.eO)();for(const t of e)i.addForwardAction(n,t);for(const e of Array.from(t).reverse())i.addReverseAction(n,e);for(const e of n.tableRenames){const t=e[0];let o=e[1];null!==t&&(null===o&&(o=(0,s.QB)(t)),n.tableDeltas[t]&&(n.tableDeltas[o]=n.tableDeltas[t],delete n.tableDeltas[t]))}for(const e of u(n.tableDeltas)){for(const t of e.columnRenames){const o=t[0];let i=t[1];null!==o&&(null===i&&(i=(0,s.QB)(o)),e.columnDeltas[o]&&(e.columnDeltas[i]=e.columnDeltas[o],delete e.columnDeltas[o]))}e.addRows=Array.from(new Set(e.addRows)),e.updateRows=Array.from(new Set(e.updateRows)),e.removeRows=Array.from(new Set(e.removeRows))}return n}function g(e,t){const o={dead1:new Set,dead2:new Set,rename1:new Map,rename2:new Map,merge:new Array},i=a(e,(e=>e[1])),n=a(t,(e=>e[0]));for(const[t,i]of e){if(!i){if(!t)throw new Error("invalid name change found");o.dead1.add(t),o.merge.push([t,null]);continue}const e=n[i];if(!e){o.merge.push([t,i]);continue}const r=e[1];r?(o.rename1.set(i,r),o.merge.push([t,r])):(o.dead2.add(i),t?(o.dead1.add(t),o.merge.push([t,null])):(o.dead1.add(i),o.dead2.add((0,s.QB)(i))))}for(const[e,s]of t){if(!e&&!s)throw new Error("invalid name change found");e&&i[e]||(o.merge.push([e,s]),e&&s&&o.rename1.set(e,s))}return o.merge=d(o.merge,(([e,t])=>[e||"",t||""])),o}function f(e,t,o){for(const o of t)delete e[o];const i={};for(const t of o.keys())e[t]&&(i[t]=e[t],delete e[t]);for(const[t,s]of o.entries())i[t]&&(e[s]=i[t])}function w(e,t,o,i){f(t,e.dead1,e.rename1),f(o,e.dead2,e.rename2);const s=o;for(const e of Object.keys(t)){const o=t[e];s[e]?s[e]=i(o,s[e]):s[e]=o}return s}function b(e){if(!e)return;const t=[null,null];return(e.removed||e.updated)&&(t[0]="?"),(e.added||e.updated)&&(t[1]="?"),t}function v(e,t,o,i){for(const s of Object.keys(e)){let n=o[s],r=i[s];(n||r)&&(n=n||b(e[s]),r=r||b(t[s]),r?n[1]&&(i[s]=[n[0],r[1]]):i[s]=o[s])}return i}function y(e){return[...new Set(e)].sort(((e,t)=>e-t))}function _(e){const t=new Set([...e.addRows,...e.removeRows,...e.updateRows]),o=new Set(e.addRows),i=new Set(e.removeRows),s=new Set(e.updateRows);return l([...t].map((e=>[e,{added:o.has(e),removed:i.has(e),updated:s.has(e)}])))}function x(e,t){const o=g(e.columnRenames,t.columnRenames);w(o,e.columnDeltas,t.columnDeltas,v.bind(null,_(e),_(t))),t.columnRenames=o.merge;const i=new Set(e.addRows),s=new Set(t.removeRows),n=e.addRows.filter((e=>s.has(e)));t.addRows=y([...t.addRows,...e.addRows.filter((e=>!s.has(e)))]),t.removeRows=y([...t.removeRows.filter((e=>!i.has(e))),...e.removeRows]),t.updateRows=y([...e.updateRows.filter((e=>!s.has(e))),...t.updateRows.filter((e=>!i.has(e)))]);for(const e of u(t.columnDeltas))for(const t of n)delete e[t];return t}function C(e,t){const o=g(e.tableRenames,t.tableRenames),i=w(o,e.tableDeltas,t.tableDeltas,x);return{tableRenames:o.merge,tableDeltas:i}}function S(e){if(0===e.length)return(0,s.eO)();let t=e[0];for(let o=1;o<e.length;o++)t=C(t,e[o]);return t}},4573:(e,t,o)=>{"use strict";o.d(t,{H$:()=>i,X$:()=>s,YG:()=>r,jb:()=>n});const i=null,s="";function n(e){let{title:t}=e;return e.groupByColLabels&&(t+=" "+r(e.groupByColLabels)),t}function r(e){return`[${e.length?"by "+e.join(", "):"Totals"}]`}},29114:(e,t,o)=>{"use strict";o.d(t,{H:()=>n});var i=o(413);const s=new Set(["AddRecord","BulkAddRecord","UpdateRecord","BulkUpdateRecord","RemoveRecord","BulkRemoveRecord"]);class n{constructor(e){this._storage=e}usesAlternateStorage(e){return!0}processUserAction(e){const t=e.map((e=>e));switch(t[0]){case"ApplyUndoActions":return this._doApplyUndoActions(t[1]);case"AddRecord":return this._doAddRecord(t[1],t[2],t[3]);case"BulkAddRecord":return this._doBulkAddRecord(t[1],t[2],t[3]);case"UpdateRecord":return this._doUpdateRecord(t[1],t[2],t[3]);case"BulkUpdateRecord":return this._doBulkUpdateRecord(t[1],t[2],t[3]);case"RemoveRecord":return this._doRemoveRecord(t[1],t[2]);case"BulkRemoveRecord":return this._doBulkRemoveRecord(t[1],t[2]);default:throw new Error(`Received unknown action ${e[0]}`)}}splitByStorage(e){const t=[],o=[];return e.forEach((e=>{const i=s.has(e[0]),n="string"==typeof e[1]&&!e[1].startsWith("_grist_");if("ApplyUndoActions"===e[0]){const[i,s]=this.splitByStorage(e[1]);i.length>0&&t.push(["ApplyUndoActions",i]),s.length>0&&o.push(["ApplyUndoActions",s])}else n&&i&&this.usesAlternateStorage(e[1])?o.push(e):t.push(e)})),[t,o]}isSchemaAction(e){return(0,i.ZX)(e)&&this.usesAlternateStorage(e[1])}async _doApplyUndoActions(e){const t=[];for(const o of e){const e=await this.processUserAction(o);t.concat(e.undo)}return{stored:e,undo:t,retValues:null}}async _doAddRecord(e,t,o){return null===t&&(t=await this._storage.getNextRowId(e)),o.manualSort=t,{stored:[["AddRecord",e,t,o]],undo:[["RemoveRecord",e,t]],retValues:t}}async _doBulkAddRecord(e,t,o){if(null===t[0]){const o=await this._storage.getNextRowId(e);for(let e=0;e<t.length;e++)t[e]=o+e}return o.manualSort=t,{stored:[["BulkAddRecord",e,t,o]],undo:[["BulkRemoveRecord",e,t]],retValues:t}}async _doUpdateRecord(e,t,o){const[,,i,s]=await this._storage.fetchActionData(e,[t],Object.keys(o));return{stored:[["UpdateRecord",e,t,o]],undo:[["BulkUpdateRecord",e,i,s]],retValues:null}}async _doBulkUpdateRecord(e,t,o){const[,,i,s]=await this._storage.fetchActionData(e,t,Object.keys(o));return{stored:[["BulkUpdateRecord",e,t,o]],undo:[["BulkUpdateRecord",e,i,s]],retValues:null}}async _doRemoveRecord(e,t){const[,,o,i]=await this._storage.fetchActionData(e,[t]);return{stored:[["RemoveRecord",e,t]],undo:[["BulkAddRecord",e,o,i]],retValues:null}}async _doBulkRemoveRecord(e,t){const[,,o,i]=await this._storage.fetchActionData(e,t);return{stored:[["BulkRemoveRecord",e,t]],undo:[["BulkAddRecord",e,o,i]],retValues:null}}}},413:(e,t,o)=>{"use strict";o.d(t,{$A:()=>I,$B:()=>u,A0:()=>S,Bj:()=>g,Eu:()=>T,Iq:()=>k,L6:()=>p,QR:()=>f,QT:()=>R,Xq:()=>b,ZX:()=>x,by:()=>m,ep:()=>O,gV:()=>M,hK:()=>c,hf:()=>w,hm:()=>v,ol:()=>d,q$:()=>C,vo:()=>h,z9:()=>D});var i=Object.defineProperty,s=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,l=(e,t,o)=>t in e?i(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,a=(e,t)=>{for(var o in t||(t={}))n.call(t,o)&&l(e,o,t[o]);if(s)for(var o of s(t))r.call(t,o)&&l(e,o,t[o]);return e};function d(e){return"AddRecord"===e[0]}function c(e){return"BulkAddRecord"===e[0]}function u(e){return"BulkRemoveRecord"===e[0]}function h(e){return"UpdateRecord"===e[0]}function p(e){return"BulkUpdateRecord"===e[0]}function m(e){return"ReplaceTableData"===e[0]}function g(e){return"AddColumn"===e[0]}function f(e){return"RemoveColumn"===e[0]}function w(e){return"RenameColumn"===e[0]}function b(e){return"AddTable"===e[0]}function v(e){return"RenameTable"===e[0]}const y=new Set(["AddTable","RemoveTable","RenameTable","AddColumn","RemoveColumn","RenameColumn","ModifyColumn"]),_=new Set(["AddRecord","RemoveRecord","UpdateRecord","BulkAddRecord","BulkRemoveRecord","BulkUpdateRecord","ReplaceTableData","TableData"]);function x(e){return y.has(e[0])}function C(e){return _.has(String(e[0]))}function S(e){return e[1]}const I=new Set(["Calculate","UpdateCurrentTime","RespondToRequests"]);function D(e){return C(e)?Array.isArray(e[2])?e[2].length:1:0}function R(e,t){const o=a({},t),i=o.id;return delete o.id,["TableData",e,i,o]}function T(e){const t="tableData"in e?e.tableData:e,o=t[2],i=t[3];return a({id:o},i)}function k(e){const t=new Set;for(const o of e)for(const e of Object.keys(o))"id"!==e&&t.add(e);const o={};for(const i of t)o[i]=e.map((e=>e[i]));return o}function M(e){if(e[3])return Object.keys(e[3])}function O(e,t){const o=e[3];if(!o)return;const i=o[t];return i?Array.isArray(e[2])?i:[i]:void 0}},33485:(e,t,o)=>{"use strict";o.d(t,{a:()=>d});var i=o(83277),s=o(90744),n=o(8594),r=o(6212);const l=o(66287),a=o(24013);class d extends n.u{constructor(e,t){if(super(),this._tables=new Map,this._fetchTableFunc=async t=>{const{tableData:o,attachments:i}=await e(t);return i&&this.receiveAction(i),o},null===t)return;for(const e in s.f)if(s.f.hasOwnProperty(e)){const o=s.f[e];this._tables.set(e,this.createTableData(e,t[e],o))}const o=a(this._tables.get("_grist_Tables_column").getRecords(),"parentId");for(const e of this._tables.get("_grist_Tables").getRecords()){const t=e.tableId,i=o[e.id]||[],s=l(i.map((e=>[e.colId,e.type])));this._tables.set(t,this.createTableData(t,null,s))}}createTableData(e,t,o){return new(e in s.f?r.r:r.C)(e,t,o)}getTable(e){return this._tables.get(e)}async requireTable(e){await this.fetchTable(e);const t=this._tables.get(e);if(!t)throw new Error(`could not fetch table: ${e}`);return t}getMetaTable(e){return this.getTable(e)}getTables(){return this._tables}fetchTable(e,t){const o=this._tables.get(e);if(!o)throw new Error(`DocData.fetchTable: unknown table ${e}`);return!o.isLoaded||t?o.fetchData(this._fetchTableFunc):Promise.resolve()}async syncTable(e){const t=await this._fetchTableFunc(e),o=l(Object.keys(t[3]).map((e=>[e,"Any"])));o.id="Any",this._tables.set(e,this.createTableData(e,t,o))}receiveAction(e){const t=e[1],o=this._tables.get(t);this.dispatchAction(e),o&&o.receiveAction(e)}docInfo(){return this.getMetaTable("_grist_DocInfo").getRecord(1)}docSettings(){return(0,i.safeJsonParse)(this.docInfo().documentSettings,{})}onAddTable(e,t,o){const i=l(o.map((e=>[e.id,e.type])));this._tables.set(t,this.createTableData(t,null,i))}onRemoveTable(e,t){this._tables.delete(t)}onRenameTable(e,t,o){const i=this._tables.get(t);i&&(this._tables.set(o,i),this._tables.delete(t))}onAddRecord(e,t,o,i){}onUpdateRecord(e,t,o,i){}onRemoveRecord(e,t,o){}onBulkAddRecord(e,t,o,i){}onBulkUpdateRecord(e,t,o,i){}onBulkRemoveRecord(e,t,o){}onReplaceTableData(e,t,o,i){}onAddColumn(e,t,o,i){}onRemoveColumn(e,t,o){}onRenameColumn(e,t,o,i){}onModifyColumn(e,t,o,i){}}},29116:(e,t,o)=>{"use strict";o.d(t,{XK:()=>s,cM:()=>i});const i=.9;function s(e,t){return!function(e){return void 0!==e&&e>0}(t)||void 0===e||e<0?0:e/t}},42360:(e,t,o)=>{"use strict";function i(e){const t={};s(e)&&(t.hasRecOrNewRec=!0);const o=new Set;return r(e,o),t.usedColIds=Array.from(o),t}function s(e){if(!Array.isArray(e))throw new Error("expected a list");return!!n(e)||e.some((e=>!!Array.isArray(e)&&s(e)))}function n(e){return Array.isArray(e)&&"Name"===e[0]&&("rec"===e[1]||"newRec"===e[1])}function r(e,t){if(!Array.isArray(e))throw new Error("expected a list");if("Attr"===e[0]&&n(e[1])){const o=e[2];t.add(String(o))}else e.forEach((e=>Array.isArray(e)&&r(e,t)))}o.d(t,{W:()=>i})},6212:(e,t,o)=>{"use strict";o.d(t,{C:()=>d,r:()=>c});var i=o(8594),s=o(413),n=o(631),r=o(83277);const l=o(36812),a=o(66287);class d extends i.u{constructor(e,t,o){super(),this._isLoaded=!1,this._columns=new Map,this._colArray=[],this._rowIdCol=[],this._rowMap=new Map,this._tableId=e;for(const e in o)if(o.hasOwnProperty(e)){const t=o[e],i={colId:e,type:t,defl:(0,n.getDefaultForType)(t),values:[]};this._columns.set(e,i),this._colArray.push(i)}this._columns.set("id",{colId:"id",type:"Id",defl:0,values:this._rowIdCol}),t&&this.loadData(t)}fetchData(e){return this._fetchPromise||(this._fetchPromise=e(this._tableId).then((e=>{this._fetchPromise=void 0,this.loadData(e)}))),this._fetchPromise}loadData(e){const t=e[2],o=e[3],i=this._rowIdCol.slice(0);u(this._rowIdCol,t);for(const e of this._colArray){const i="id"===e.colId?t:o[e.colId];u(e.values,i||this._rowIdCol.map((()=>e.defl)))}this._rowMap.clear();for(let e=0;e<t.length;e++)this._rowMap.set(t[e],e);return this._isLoaded=!0,i}loadPartial(e){const t=e[2];this.onBulkAddRecord(e,e[1],t,e[3]),this._isLoaded=!0}unloadPartial(e){this.onBulkRemoveRecord(["BulkRemoveRecord",this.tableId,e],this.tableId,e)}get tableId(){return this._tableId}get isLoaded(){return this._isLoaded}numRecords(){return this._rowIdCol.length}getValue(e,t){const o=this._columns.get(t),i=this._rowMap.get(e);return o&&void 0!==i?o.values[i]:void 0}hasRowId(e){return this._rowMap.has(e)}getRowIdIndex(e){return this._rowMap.get(e)}getRowPropFunc(e){const t=this._columns.get(e);if(!t)return()=>{};const o=t.values,i=this._rowMap;return e=>o[i.get(e)]}getKeepFunc(){}getSkipRowId(){throw new Error("no skip row id defined")}getRowIds(){return this._rowIdCol}getSortedRowIds(){return this._rowIdCol.slice(0).sort(((e,t)=>e-t))}mayHaveVersions(){return!1}getColIds(){return Array.from(this._columns.keys())}getColValues(e){const t=this._columns.get(e);return t?t.values:void 0}getDistinctValues(e,t=1/0){const o=this.getColValues(e);if(o)return(0,r.getDistinctValues)(o,t)}getTableDataAction(e,t){t=t||this.getColIds();const o=new Set(t),i=e||this.getRowIds();let s;const n=this._colArray.filter((({colId:e})=>o.has(e)));if(e){const e=i.length;s={};for(const o of t)s[o]=Array(e);for(let t=0;t<e;t++){const e=this._rowMap.get(i[t]);for(const{colId:o,values:i}of n){const n=void 0===e?null:i[e];s[o][t]=n}}}else s=a(t.filter((e=>"id"!==e)).map((e=>[e,this.getColValues(e)])));return["TableData",this.tableId,i,s]}getBulkAddRecord(e){const t=this.getTableDataAction(null==e?void 0:e.sort(((e,t)=>e-t)));return["BulkAddRecord",t[1],t[2],t[3]]}getColType(e){const t=this._columns.get(e);return t?t.type:void 0}getRecord(e){const t=this._rowMap.get(e);if(void 0===t)return;const o={id:this._rowIdCol[t]};for(const e of this._colArray)o[e.colId]=e.values[t];return o}getRecords(){const e=this._rowIdCol.map((e=>({id:e})));for(const{colId:t,values:o}of this._colArray)for(let i=0;i<e.length;i++)e[i][t]=o[i];return e}filterRowIds(e){return this._filterRowIndices(e).map((e=>this._rowIdCol[e]))}filterRecords(e){const t=this._filterRowIndices(e),o=t.map((e=>({id:this._rowIdCol[e]})));for(const{colId:e,values:i}of this._colArray)for(let s=0;s<o.length;s++)o[s][e]=i[t[s]];return o}findRow(e,t){const o=this._columns.get(e);if(!o)return 0;const i=o.values.indexOf(t);return i<0?0:this._rowIdCol[i]}findMatchingRowId(e){const t=Object.keys(e).map((t=>({col:this._columns.get(t),value:e[t]})));return t.every((e=>e.col))&&this._rowIdCol.find(((e,o)=>t.every((e=>l(e.col.values[o],e.value)))))||0}receiveAction(e){return!(!this._isLoaded&&!(0,s.ZX)(e)||(this.dispatchAction(e),0))}onAddRecord(e,t,o,i){if(void 0!==this._rowMap.get(o))return void this.onUpdateRecord(e,t,o,i);const s=this._rowIdCol.length;this._rowMap.set(o,s),this._rowIdCol[s]=o;for(const{colId:e,defl:t,values:o}of this._colArray)o[s]=i.hasOwnProperty(e)?i[e]:t}onBulkAddRecord(e,t,o,i){let s=this._rowIdCol.length;for(let e=0;e<o.length;e++){const t=this._rowMap.get(o[e]);if(void 0!==t){for(const o in i)if(i.hasOwnProperty(o)){const s=this._columns.get(o);s&&(s.values[t]=i[o][e])}}else{this._rowMap.set(o[e],s),this._rowIdCol[s]=o[e];for(const{colId:t,defl:o,values:n}of this._colArray)n[s]=i.hasOwnProperty(t)?i[t][e]:o;s++}}}onRemoveRecord(e,t,o){const i=this._rowMap.get(o);if(void 0!==i){const e=this._rowIdCol.length-1;for(const{values:t}of this._columns.values())t[i]=t[e],t.pop();this._rowMap.set(this._rowIdCol[i],i),this._rowMap.delete(o)}}onUpdateRecord(e,t,o,i){const s=this._rowMap.get(o);if(void 0!==s)for(const e in i)if(i.hasOwnProperty(e)){const t=this._columns.get(e);t&&(t.values[s]=i[e])}}onBulkUpdateRecord(e,t,o,i){for(let e=0;e<o.length;e++){const t=this._rowMap.get(o[e]);if(void 0!==t)for(const o in i)if(i.hasOwnProperty(o)){const s=this._columns.get(o);s&&(s.values[t]=i[o][e])}}}onReplaceTableData(e,t,o,i){this.loadData(e)}onAddColumn(e,t,o,i){if(this._columns.has(o))return;const s=i.type,r=(0,n.getDefaultForType)(s),l={colId:o,type:s,defl:r,values:this._rowIdCol.map((()=>r))};this._columns.set(o,l),this._colArray.push(l)}onRemoveColumn(e,t,o){const i=this._columns.get(o);i&&(this._columns.delete(o),(0,r.arrayRemove)(this._colArray,i))}onRenameColumn(e,t,o,i){const s=this._columns.get(o);s&&(s.colId=i,this._columns.set(i,s),this._columns.delete(o))}onModifyColumn(e,t,o,i){const s=this._columns.get(o);s&&i.hasOwnProperty("type")&&(s.type=i.type,s.defl=(0,n.getDefaultForType)(i.type))}onRenameTable(e,t,o){this._tableId=o}onAddTable(e,t,o){}onRemoveTable(e,t){this._isLoaded=!1}_filterRowIndices(e){const t=[],o=Object.keys(e).map((t=>({col:this._columns.get(t),value:e[t]})));return this._rowIdCol.forEach(((e,i)=>{o.every((e=>l(e.col.values[i],e.value)))&&t.push(i)})),t}}class c extends d{constructor(e,t,o){super(e,t,o)}getValue(e,t){return super.getValue(e,t)}getRecords(){return super.getRecords()}getRecord(e){return super.getRecord(e)}filterRecords(e){return super.filterRecords(e)}findMatchingRowId(e){return super.findMatchingRowId(e)}getRowPropFunc(e){return super.getRowPropFunc(e)}getColValues(e){return super.getColValues(e)}findRow(e,t){return super.findRow(e,t)}}function u(e,t){e.length=0,(0,r.arraySplice)(e,0,t)}},90744:(e,t,o)=>{"use strict";o.d(t,{b:()=>i,f:()=>s});const i=39,s={_grist_DocInfo:{docId:"Text",peers:"Text",basketId:"Text",schemaVersion:"Int",timezone:"Text",documentSettings:"Text"},_grist_Tables:{tableId:"Text",primaryViewId:"Ref:_grist_Views",summarySourceTable:"Ref:_grist_Tables",onDemand:"Bool",rawViewSectionRef:"Ref:_grist_Views_section"},_grist_Tables_column:{parentId:"Ref:_grist_Tables",parentPos:"PositionNumber",colId:"Text",type:"Text",widgetOptions:"Text",isFormula:"Bool",formula:"Text",label:"Text",description:"Text",untieColIdFromLabel:"Bool",summarySourceCol:"Ref:_grist_Tables_column",displayCol:"Ref:_grist_Tables_column",visibleCol:"Ref:_grist_Tables_column",rules:"RefList:_grist_Tables_column",recalcWhen:"Int",recalcDeps:"RefList:_grist_Tables_column"},_grist_Imports:{tableRef:"Ref:_grist_Tables",origFileName:"Text",parseFormula:"Text",delimiter:"Text",doublequote:"Bool",escapechar:"Text",quotechar:"Text",skipinitialspace:"Bool",encoding:"Text",hasHeaders:"Bool"},_grist_External_database:{host:"Text",port:"Int",username:"Text",dialect:"Text",database:"Text",storage:"Text"},_grist_External_table:{tableRef:"Ref:_grist_Tables",databaseRef:"Ref:_grist_External_database",tableName:"Text"},_grist_TableViews:{tableRef:"Ref:_grist_Tables",viewRef:"Ref:_grist_Views"},_grist_TabItems:{tableRef:"Ref:_grist_Tables",viewRef:"Ref:_grist_Views"},_grist_TabBar:{viewRef:"Ref:_grist_Views",tabPos:"PositionNumber"},_grist_Pages:{viewRef:"Ref:_grist_Views",indentation:"Int",pagePos:"PositionNumber"},_grist_Views:{name:"Text",type:"Text",layoutSpec:"Text"},_grist_Views_section:{tableRef:"Ref:_grist_Tables",parentId:"Ref:_grist_Views",parentKey:"Text",title:"Text",description:"Text",defaultWidth:"Int",borderWidth:"Int",theme:"Text",options:"Text",chartType:"Text",layoutSpec:"Text",filterSpec:"Text",sortColRefs:"Text",linkSrcSectionRef:"Ref:_grist_Views_section",linkSrcColRef:"Ref:_grist_Tables_column",linkTargetColRef:"Ref:_grist_Tables_column",embedId:"Text",rules:"RefList:_grist_Tables_column"},_grist_Views_section_field:{parentId:"Ref:_grist_Views_section",parentPos:"PositionNumber",colRef:"Ref:_grist_Tables_column",width:"Int",widgetOptions:"Text",displayCol:"Ref:_grist_Tables_column",visibleCol:"Ref:_grist_Tables_column",filter:"Text",rules:"RefList:_grist_Tables_column"},_grist_Validations:{formula:"Text",name:"Text",tableRef:"Int"},_grist_REPL_Hist:{code:"Text",outputText:"Text",errorText:"Text"},_grist_Attachments:{fileIdent:"Text",fileName:"Text",fileType:"Text",fileSize:"Int",fileExt:"Text",imageHeight:"Int",imageWidth:"Int",timeDeleted:"DateTime",timeUploaded:"DateTime"},_grist_Triggers:{tableRef:"Ref:_grist_Tables",eventTypes:"ChoiceList",isReadyColRef:"Ref:_grist_Tables_column",actions:"Text",label:"Text",memo:"Text",enabled:"Bool"},_grist_ACLRules:{resource:"Ref:_grist_ACLResources",permissions:"Int",principals:"Text",aclFormula:"Text",aclColumn:"Ref:_grist_Tables_column",aclFormulaParsed:"Text",permissionsText:"Text",rulePos:"PositionNumber",userAttributes:"Text",memo:"Text"},_grist_ACLResources:{tableId:"Text",colIds:"Text"},_grist_ACLPrincipals:{type:"Text",userEmail:"Text",userName:"Text",groupName:"Text",instanceId:"Text"},_grist_ACLMemberships:{parent:"Ref:_grist_ACLPrincipals",child:"Ref:_grist_ACLPrincipals"},_grist_Filters:{viewSectionRef:"Ref:_grist_Views_section",colRef:"Ref:_grist_Tables_column",filter:"Text",pinned:"Bool"},_grist_Cells:{tableRef:"Ref:_grist_Tables",colRef:"Ref:_grist_Tables_column",rowId:"Int",root:"Bool",parentId:"Ref:_grist_Cells",type:"Int",content:"Text",userRef:"Text"}}},58810:(e,t,o)=>{var{getHumanKey:i,isMac:s}=o(77709),{copyToClipboard:n,readDataFromClipboard:r}=o(85842),{FocusLayer:l}=o(29813),{makeT:a}=o(70387),{tsvDecode:d}=o(79801),{ShortcutKey:c,ShortcutKeyContent:u}=o(82246),{confirmModal:h}=o(20742),{styled:p}=o(1310),m=o(77709),g=o(81294),f=o(27601),w=o(15323);const b=a("Clipboard");function v(e){f.call(this,null),this._app=e,this.copypasteField=this.autoDispose(g("textarea.copypaste.mousetrap","")),this.timeoutId=null,this.onEvent(this.copypasteField,"input",(function(e,t){var o=e.value;return e.value="",m.allCommands.input.run(o),!1})),this.onEvent(this.copypasteField,"copy",this._onCopy),this.onEvent(this.copypasteField,"cut",this._onCut),this.onEvent(this.copypasteField,"paste",this._onPaste),document.body.appendChild(this.copypasteField),l.create(this,{defaultFocusElem:this.copypasteField,allowFocus:C,onDefaultFocus:()=>{this.copypasteField.value=" ",this.copypasteField.select(),this._app.trigger("clipboard_focus")},onDefaultBlur:()=>{this._app.trigger("clipboard_blur")}}),window.gristClipboardGrabFocus=()=>l.grabFocus(),this.onEvent(window,"mousedown",(e=>{document.activeElement&&document.activeElement!==document.body||l.grabFocus()})),this._cutCallback=null,this._cutData=null,this.autoDispose(m.createGroup(v.commands,this,!0))}f.setBaseFor(v),v.commands={contextMenuCopy:function(){this._doContextMenuCopy()},contextMenuCut:function(){this._doContextMenuCut()},contextMenuPaste:function(){this._doContextMenuPaste()}},v.prototype._onCopy=function(e,t){t.preventDefault();let o=m.allCommands.copy.run();this._setCBdata(o,t.originalEvent.clipboardData)},v.prototype._doContextMenuCopy=function(){let e=m.allCommands.copy.run();this._copyToClipboard(e,"copy")},v.prototype._onCut=function(e,t){t.preventDefault();let o=m.allCommands.cut.run();this._setCBdata(o,t.originalEvent.clipboardData)},v.prototype._doContextMenuCut=function(){let e=m.allCommands.cut.run();this._copyToClipboard(e,"cut")},v.prototype._setCBdata=function(e,t){if(!e)return;const o=w.makePasteText(e.data,e.selection);t.setData("text/plain",o);const i=w.makePasteHtml(e.data,e.selection);t.setData("text/html",i),this._setCutCallback(e,o)},v.prototype._copyToClipboard=async function(e,t){if(!e)return;const o=w.makePasteText(e.data,e.selection);let i;if("function"==typeof ClipboardItem){const t=w.makePasteHtml(e.data,e.selection);i=new ClipboardItem({"text/plain":new Blob([o],{type:"text/plain"}),"text/html":new Blob([t],{type:"text/html"})})}else i=o;try{await n(i)}catch(e){return void S(t)}this._setCutCallback(e,o)},v.prototype._setCutCallback=function(e,t){e.cutCallback?(this._cutCallback=e.cutCallback,this._cutData=t):(this._cutCallback=null,this._cutData=null)},v.prototype._onPaste=function(e,t){t.preventDefault();const o=t.originalEvent.clipboardData,i=o.getData("text/plain"),s=_(i,o.getData("text/html"));this._doPaste(s,i)};var y={INPUT:!0,TEXTAREA:!0,SELECT:!0,IFRAME:!0};function _(e,t){try{return w.parsePasteHtml(t)}catch(t){return""===e||65279===e.charCodeAt(0)?[[""]]:d(e.replace(/\r\n?/g,"\n").trimEnd())}}async function x(e,t){if(!e)return"";try{return(await e.getType(t)).text()}catch(e){return""}}function C(e){return e&&(y.hasOwnProperty(e.tagName)||e.hasAttribute("tabindex")||e.classList.contains("clipboard_focus"))}function S(e){let t;switch(e){case"cut":t="Mod+X";break;case"copy":t="Mod+C";break;case"paste":t="Mod+V";break;default:throw new Error(`Clipboard: unrecognized action ${e}`)}h(b("Unavailable Command"),b("Got it"),(()=>{}),{explanation:I(b("The {{action}} menu command is not available in this browser. You can still {{action}} by using the keyboard shortcut {{shortcut}}.",{action:e,shortcut:c(u(i(t,s)))})),hideCancel:!0})}v.prototype._doContextMenuPaste=async function(){var e;let t;try{t=null==(e=await r())?void 0:e[0]}catch(e){return void S("paste")}const o=await x(t,"text/plain"),i=_(o,await x(t,"text/html"));this._doPaste(i,o)},v.prototype._doPaste=function(e,t){console.log(this._cutData,t,this._cutCallback),this._cutData===t?this._cutCallback&&m.allCommands.paste.run(e,this._cutCallback):(this._cutData=null,m.allCommands.paste.run(e,null)),this._cutCallback=null},v.allowFocus=C,e.exports=v;const I=p("div","\n  line-height: 18px;\n")},18285:(e,t,o)=>{const i=o(54156),s=o(29301),n=o(81294),r=o(92979),l=o(61237),{renderAllRows:a}=o(68498),{isNarrowScreen:d}=o(29922);o(33620);const c=o(27601),u=o(30583),h=o(3719),{CopySelection:p}=o(47079),m=o(42683),g=o(77709),f=o(15323),{FieldContextMenu:w}=o(67583),{RowContextMenu:b}=o(19085),{parsePasteForView:v}=o(23735),{descriptionInfoTooltip:y}=o(8881);function _(e,t){u.call(this,e,t,{addNewRow:!0}),this.cellSelector=h.CellSelector.create(this,this),this.viewFields=e.docModel.viewFields,this._isSingle="single"===this.viewSection.parentKey.peek(),this.recordLayout=this.autoDispose(m.create({viewSection:this.viewSection,buildFieldDom:this.buildFieldDom.bind(this),buildRowContextMenu:this.buildRowContextMenu.bind(this),buildFieldContextMenu:this.buildFieldContextMenu.bind(this),resizeCallback:()=>{this._isSingle||(this.scrolly().updateSize(),this.scrolly().scrollRowIntoView(this.cursor.rowIndex.peek()))}})),this.scrolly=this.autoDispose(s.computed((()=>{if(!this.recordLayout.isEditingLayout()&&!this._isSingle)return l.getInstance(this.viewData)}))),this.autoDispose(this.viewSection.themeDef.subscribe((()=>{var e=this.scrolly();e&&setTimeout((function(){e.resetHeights()}),0)}))),this.layoutBoxIdx=s.observable(0),this._isSingle?(this.detailRecord=this.autoDispose(this.tableModel.createFloatingRowModel()),this._updateFloatingRow(),this.autoDispose(this.cursor.rowIndex.subscribe(this._updateFloatingRow,this)),this.autoDispose(this.viewData.subscribe(this._updateFloatingRow,this))):this.detailRecord=null,this.scrollPane=null,this.viewPane=this.autoDispose(this.buildDom()),this._twoLastFieldIdsSelected=[null,null],this.onEvent(this.viewPane,"mousedown",".g_record_detail_el",(function(e,t){this.viewSection.hasFocus(!0);var o=this.recordLayout.getContainingRow(e,this.viewPane),i=this.recordLayout.getContainingField(e,this.viewPane);g.allCommands.setCursor.run(o,i),this._twoLastFieldIdsSelected.unshift(i.id()),this._twoLastFieldIdsSelected.pop()})),this.onEvent(this.viewPane,"dblclick",".g_record_detail_el",(function(e,t){this.activateEditorAtCursor()})),this.onEvent(this.viewPane,"click",".g_record_detail_value",(function(e,t){var o=this.recordLayout.getContainingField(e,this.viewPane);this._twoLastFieldIdsSelected[0]===this._twoLastFieldIdsSelected[1]&&!d()&&this._canSingleClick(o)&&this.activateEditorAtCursor()})),this.autoDispose(g.createGroup(_.generalCommands,this,this.viewSection.hasFocus)),this.autoDispose(g.createGroup(_.fieldCommands,this,this.viewSection.hasFocus));const o=this.autoDispose(s.pureComputed((()=>!this.cellSelector.isCurrentSelectType("")||this.copySelection())));this.autoDispose(g.createGroup(_.selectionCommands,this,o))}c.setBaseFor(_),i.extend(_.prototype,u.prototype),_.prototype.onTableLoaded=function(){u.prototype.onTableLoaded.call(this),this._updateFloatingRow();const e=this.scrolly();e&&e.scrollToSavedPos(this.viewSection.lastScrollPos)},_.prototype._updateFloatingRow=function(){this.detailRecord&&this.viewData.setFloatingRowModel(this.detailRecord,this.cursor.rowIndex.peek())},_.generalCommands={cursorUp:function(){this.cursor.fieldIndex(this.cursor.fieldIndex()-1)},cursorDown:function(){this.cursor.fieldIndex(this.cursor.fieldIndex()+1)},pageUp:function(){this.cursor.rowIndex(this.cursor.rowIndex()-1)},pageDown:function(){this.cursor.rowIndex(this.cursor.rowIndex()+1)},copy:function(){return this.copy(this.getSelection())},cut:function(){return this.cut(this.getSelection())},paste:function(e,t){return this.gristDoc.docData.bundleActions(null,(()=>this.paste(e,t)))},editLayout:function(){this.scrolly()&&this.scrolly().scrollRowIntoView(this.cursor.rowIndex()),this.recordLayout.editLayout(this.cursor.rowIndex())}},_.fieldCommands={clearCardFields:function(){this._clearCardFields()},hideCardFields:function(){this._hideCardFields()}},_.selectionCommands={clearCopySelection:function(){this._clearCopySelection()},cancel:function(){this._clearSelection()}},_.prototype.selectedRows=function(){return this._isAddRow()?[]:[this.viewData.getRowId(this.cursor.rowIndex())]},_.prototype.deleteRows=async function(e){const t=this.cursor.rowIndex();try{await u.prototype.deleteRows.call(this,e)}finally{this.cursor.rowIndex(t)}},_.prototype.paste=async function(e,t){let o=e[0][0],s=this.viewSection.viewFields().at(this.cursor.fieldIndex()),n=1===e.length&&1===e[0].length;const r=await v([[o]],[s],this.gristDoc);if(i.isEmpty(r))return;const l=this.viewData.getRowId(this.cursor.rowIndex()),a="new"===l?["BulkAddRecord",[null],r]:["BulkUpdateRecord",[l],r],d=this.cursor.getCursorPos();return this.sendPasteActions(n?t:null,this.prepTableActions([a])).then((e=>{const t="BulkAddRecord"===a[0]?e[0][0]:null;this.cursor.setCursorPos({rowId:"new"===d.rowId?t:d.rowId}),g.allCommands.clearCopySelection.run()}))},_.prototype.getSelection=function(){return new p(this.tableModel.tableData,[this.viewData.getRowId(this.cursor.rowIndex())],[this.viewSection.viewFields().at(this.cursor.fieldIndex())],{})},_.prototype.buildRowContextMenu=function(e){const t=this._getRowContextMenuOptions(e);return b(t)},_.prototype.buildFieldContextMenu=function(e){const t=this._getRowContextMenuOptions(e),o=this._getFieldContextMenuOptions();return w(t,o)},_.prototype.buildFieldDom=function(e,t){var o=this;if(e.isNewField)return n("div.g_record_detail_el.flexitem",r.cssClass((function(){return"detail_theme_field_"+o.viewSection.themeDef()})),n("div.g_record_detail_label_container",n("div.g_record_detail_label",r.text(e.label)),r.scope(e.description,(e=>e?y(e,"colmun"):null))),n("div.g_record_detail_value"));var l=s.pureComputed((function(){return this.cursor.fieldIndex()===(e&&e._index())&&this.cursor.rowIndex()===(t&&t._index())}),this),a=s.pureComputed((function(){return this.viewSection.hasFocus()&&l()}),this),d=s.computed((function(){return o.copySelection()&&o.copySelection().isCellSelected(t.getRowId(),e.colId())}));this.autoDispose(l.subscribe((e=>{if(e){var t=n.findAncestor(u,".layout_hbox");this.layoutBoxIdx(i.indexOf(t.parentElement.childNodes,t))}})));var c=this.fieldBuilders.at(e._index()),u=n("div.g_record_detail_el.flexitem",n.autoDispose(l),n.autoDispose(a),r.cssClass((function(){return"detail_theme_field_"+o.viewSection.themeDef()})),n("div.g_record_detail_label_container",n("div.g_record_detail_label",r.text(e.displayLabel)),r.scope(e.description,(e=>e?y(e,"column"):null))),n("div.g_record_detail_value",r.toggleClass("scissors",d),r.toggleClass("record-add",t._isAddRow),n.autoDispose(d),c.buildDomWithCursor(t,a,l)));return u},_.prototype.buildDom=function(){return n("div.flexvbox.flexitem",r.toggleClass("detailview_single",(()=>this._isSingle||this.recordLayout.isEditingLayout())),r.toggleClass("detailview_layout_editor",this.recordLayout.isEditingLayout),r.maybe(this.recordLayout.isEditingLayout,(()=>{const e=this.viewData.getRowId(this.recordLayout.editIndex.peek()),t=this.getRenderedRowModel(e);return n(this.recordLayout.buildLayoutDom(t,!0),r.cssClass((()=>"detail_theme_record_"+this.viewSection.themeDef())),r.cssClass("detailview_record_"+this.viewSection.parentKey.peek()))})),r.maybe((()=>!this.recordLayout.isEditingLayout()),(()=>this._isSingle?n(this.makeRecord(this.detailRecord),r.domData("itemModel",this.detailRecord),r.hide((()=>null===this.cursor.rowIndex()))):this.scrollPane=n("div.detailview_scroll_pane.flexitem",r.scrollChildIntoView(this.cursor.rowIndex),n.onDispose((()=>{this.scrolly()&&(this.viewSection.lastScrollPos=this.scrolly().getScrollPos())})),l.scrolly(this.viewData,{fitToWidth:!0},(e=>this.makeRecord(e))),r.maybe(this._isPrinting,(()=>a(this.tableModel,this.sortedRows.getKoArray().peek(),(e=>this.makeRecord(e)))))))))},_.prototype.buildTitleControls=function(){const e=s.computed((()=>{if(!this._isSingle||this.recordLayout.layoutEditor())return!1;const e=this.viewSection.linkingState();return!(e&&Boolean(e.cursorPos))}));return n("div",n.autoDispose(e),r.toggleClass("record-layout-editor",this.recordLayout.layoutEditor),r.maybe(this.recordLayout.layoutEditor,(e=>e.buildEditorDom())),r.maybe(e,(()=>n("div.grist-single-record__menu.flexhbox.flexnone",n("div.grist-single-record__menu__count.flexitem",r.text((()=>this._isAddRow()?"Add record":`${this.cursor.rowIndex()+1} of ${this.getLastDataRowIndex()+1}`))),n("div.btn-group.btn-group-xs",n("div.btn.btn-default.detail-left",n("span.glyphicon.glyphicon-chevron-left"),n.on("click",(()=>{this.cursor.rowIndex(this.cursor.rowIndex()-1)})),r.toggleClass("disabled",(()=>0===this.cursor.rowIndex()))),n("div.btn.btn-default.detail-right",n("span.glyphicon.glyphicon-chevron-right"),n.on("click",(()=>{this.cursor.rowIndex(this.cursor.rowIndex()+1)})),r.toggleClass("disabled",(()=>this.cursor.rowIndex()>=this.viewData.all().length-1)))),n("div.btn-group.btn-group-xs.detail-add-grp",n("div.btn.btn-default.detail-add-btn",n("span.glyphicon.glyphicon-plus"),n.on("click",(()=>{let e=this.viewData.getRowIndex("new");this.cursor.rowIndex(e)})),r.toggleClass("disabled",(()=>"new"===this.viewData.getRowId(this.cursor.rowIndex())))))))))},_.prototype.onResize=function(){var e=this.scrolly();e&&e.scheduleUpdateSize()},_.prototype.onRowResize=function(e){var t=this.scrolly();t&&t.resetItemHeights(e)},_.prototype.makeRecord=function(e){return n(this.recordLayout.buildLayoutDom(e),r.cssClass((()=>"detail_theme_record_"+this.viewSection.themeDef())),this.comparison?r.cssClass((()=>{const t=this.extraRows.getRowType(e.id());return t&&`diff-${t}`||""})):null,r.toggleClass("active",(()=>this.cursor.rowIndex()===e._index()&&this.viewSection.hasFocus())),r.toggleClass("selected",(()=>this.cursor.rowIndex()===e._index()&&!this.viewSection.hasFocus())),r.cssClass("detailview_record_"+this.viewSection.parentKey.peek()))},_.prototype.getRenderedRowModel=function(e){return this.detailRecord?this.detailRecord.getRowId()===e?this.detailRecord:null:this.viewData.getRowModel(e)},_.prototype._isAddRow=function(e=this.cursor.rowIndex()){return"new"===this.viewData.getRowId(e)},_.prototype.scrollToCursor=function(e=!0){return this.scrollPane?r.doScrollChildIntoView(this.scrollPane,this.cursor.rowIndex(),e):Promise.resolve()},_.prototype._duplicateRows=async function(){const e=await u.prototype._duplicateRows.call(this);this.setCursorPos({rowId:e[0]})},_.prototype._canSingleClick=function(e){return!(e.column().isRealFormula()||e.column().hasTriggerFormula()||"Bool"===e.column().pureType()&&["Switch","CheckBox"].includes(e.column().visibleColFormatter().widgetOpts.widget))},_.prototype._clearCardFields=function(){const{isFormula:e}=this._getFieldContextMenuOptions();if(!0===e)this.activateEditorAtCursor({init:""});else{const e=f.makeDeleteAction(this.getSelection());e&&this.gristDoc.docData.sendAction(e)}},_.prototype._hideCardFields=function(){const e=this.getSelection().fields.map((e=>["RemoveRecord",e.id()]));return this.gristDoc.docModel.viewFields.sendTableActions(e,`Hide fields ${e.map((e=>e[1])).join(", ")} from ${this.tableModel.tableData.tableId}.`)},_.prototype._clearSelection=function(){this.copySelection(null),this.cellSelector.setToCursor()},_.prototype._clearCopySelection=function(){this.copySelection(null)},_.prototype._getRowContextMenuOptions=function(e){return{disableInsert:Boolean(this.gristDoc.isReadonly.get()||this.viewSection.disableAddRemoveRows()||this.tableModel.tableMetaRow.onDemand()),disableDelete:Boolean(this.gristDoc.isReadonly.get()||this.viewSection.disableAddRemoveRows()||e._isAddRow()),isViewSorted:this.viewSection.activeSortSpec.peek().length>0,numRows:this.getSelection().rowIds.length}},_.prototype._getFieldContextMenuOptions=function(){var e,t;const o=this.getSelection();return{disableModify:Boolean(null==(e=o.fields[0])?void 0:e.disableModify.peek()),isReadonly:this.gristDoc.isReadonly.get()||this.isPreview,isFormula:Boolean(null==(t=o.fields[0])?void 0:t.column.peek().isRealFormula.peek())}},e.exports=_},27910:(e,t,o)=>{var i=o(88438),s=o(81294),n=o(8113);function r(e,t){this.gristDoc=e.gristDoc,this.validationPanel=this.autoDispose(n.create({gristDoc:this.gristDoc})),this.autoDispose(this.gristDoc.addOptionsTab("Validate Data",s("span.glyphicon.glyphicon-check"),this.buildValidationsConfigDomObj(),{shortLabel:"Valid"}))}i.makeDisposable(r),r.prototype.buildValidationsConfigDomObj=function(){return[{buildDom:this.validationPanel.buildDom.bind(this.validationPanel),keywords:["document","validations","rules","validate"]}]},e.exports=r},442:(e,t,o)=>{var i=Object.defineProperty,s=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,l=(e,t,o)=>t in e?i(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;const a=o(54156),d=o(29301),c=o(88466),u=o(83277),h=o(10328),{Sort:p}=o(48210),m=o(81294),g=o(92979),f=o(73783),w=o(61237),b=o(15323),{addToSort:v,sortBy:y}=o(52064),_=o(77709),x=o(52103),C=o(27601),S=o(30583),I=o(3719),{CopySelection:D}=o(47079),{SelectionSummary:R}=o(50254),T=o(33620),k=o(81401),{renderAllRows:M}=o(68498),{reportWarning:O}=o(92769),{reportUndo:A}=o(54292),{onDblClickMatchElem:P}=o(31248),{dom:F,Holder:E,Computed:B}=o(1310),{closeRegisteredMenu:L,menu:U}=o(1370),{calcFieldsCondition:z}=o(7916),{ColumnAddMenu:V,ColumnContextMenu:N,MultiColumnMenu:j,freezeAction:W}=o(7916),{RowContextMenu:H}=o(19085),{setPopupToCreateDom:G}=o(21467),{CellContextMenu:K}=o(58847),{testId:J,isNarrowScreen:X}=o(29922),{contextMenu:q}=o(74624),{mouseDragMatchElem:Y}=o(79365),{menuToggle:Z}=o(42882),{descriptionInfoTooltip:Q,showTooltip:ee}=o(8881),{parsePasteForView:te}=o(23735),{NEW_FILTER_JSON:oe}=o(45051),{CombinedStyle:ie}=o(53186),{buildRenameColumn:se}=o(28795),{makeT:ne}=o(70387),re=ne("GridView");function le(e,t,o=!1){S.call(this,e,t,{isPreview:o,addNewRow:!0}),this.viewSection=t,this.dragX=d.observable(0),this.dragY=d.observable(0),this.rowShadowAdjust=0,this.colShadowAdjust=0,this.scrollLeft=d.observable(0),this.isScrolledLeft=this.autoDispose(d.computed((()=>this.scrollLeft()>0))),this.scrollTop=d.observable(0),this.isScrolledTop=this.autoDispose(d.computed((()=>this.scrollTop()>0))),this.cellSelector=I.CellSelector.create(this,this),o||(this.selectionSummary=R.create(this,this.cellSelector,this.tableModel.tableData,this.sortedRows,this.viewSection.viewFields)),this.colMenuTargets={},this.selectedColumns=this.autoDispose(d.pureComputed((()=>this.viewSection.viewFields().all().filter(((e,t)=>!e.isDisposed()&&!e.column().isDisposed()&&this.cellSelector.containsCol(t)))))),this.colRightOffsets=this.autoDispose(d.computed((()=>{let e=this.viewSection.viewFields(),t=new h;return t.fillFromValues(e.all().map((e=>e.widthDef()))),t}))),this.visibleRowIndex=d.observable(this.cursor.rowIndex()).extend({notify:"always"}),this.currentPosition=B.create(this,(e=>({rowIndex:e(this.cursor.rowIndex),fieldIndex:e(this.cursor.fieldIndex)}))),this.autoDispose(this.currentPosition.addListener(((e,t)=>{e.rowIndex===t.rowIndex&&e.fieldIndex===t.fieldIndex||this.visibleRowIndex(e.rowIndex)}))),this.autoDispose(this.cursor.fieldIndex.subscribe((e=>{if(this.numFrozen.peek()&&e<this.numFrozen.peek())return;const t=this.colRightOffsets.peek().getSumTo(e),o=this._cornerDom.clientWidth,i=this.scrollPane.clientWidth-o,s=this.colRightOffsets.peek().getValue(e)+1,n=this.frozenWidth.peek(),r=this.scrollPane.scrollLeft+n,l=r+(i-n),a=t-u.clamp(t,r,l-s);this.scrollPane.scrollLeft=this.scrollPane.scrollLeft+a}))),this.isPreview=o,this.scrollShadow={left:this.isScrolledLeft,top:this.isScrolledTop},this.ctxMenuHolder=E.create(this),this.width=d.observable(0),this.numFrozen=this.viewSection.numFrozen,this.frozenWidth=this.autoDispose(d.pureComputed((()=>this.colRightOffsets().getSumTo(this.numFrozen())))),this.frozenLine=this.autoDispose(d.pureComputed((()=>this.numFrozen()&&!this.isScrolledLeft()))),this.frozenOffset=this.autoDispose(d.computed((()=>{const e=this.viewSection.viewFields().all(),t=e[e.length-1],o=t?t.widthDef():0,i=-this.frozenWidth()-52+this.width()-o-40,s=-this.frozenWidth()-52+this.width()/2,n=Math.floor(Math.max(i,s));return n>0?0:Math.abs(n)}))),this.frozenScrollOffset=this.autoDispose(d.computed((()=>this.numFrozen()?this.scrollLeft():0))),this.frozenShadow=this.autoDispose(d.computed((()=>this.numFrozen()&&this.frozenOffset()&&this.isScrolledLeft()))),this.frozenPositions=this.autoDispose(this.viewSection.viewFields().map((function(e){return d.pureComputed((()=>this.colRightOffsets().getSumTo(e._index())))}),this)),this.frozenMap=this.autoDispose(this.viewSection.viewFields().map((function(e){return d.pureComputed((()=>e._index()<this.numFrozen()))}),this)),this.hoverColumn=d.observable(-1),this.editingFormula=d.pureComputed((()=>!!this.gristDoc.docModel.editingFormula()&&this.viewSection.viewFields().all().some((e=>e.editingFormula())))),this.changeHover=c((e=>{this.isDisposed()||this.editingFormula()&&this.hoverColumn(e)}),0),this.isColSelected=this.autoDispose(this.viewSection.viewFields().map((function(e){return this._createColSelectedObs(e)}),this)),this.header=null,this._cornerDom=null,this._modField=null,this.scrollPane=null,this.viewPane=this.autoDispose(this.buildDom()),this.attachSelectorHandlers(),this.scrolly=w.getInstance(this.viewData),P(this.scrollPane,".field:not(.column_name)",(()=>this.activateEditorAtCursor())),this.isPreview||F.onMatchElem(this.scrollPane,".field:not(.column_name)","contextmenu",((e,t)=>this.onCellContextMenu(e,t)),{useCapture:!0}),this.onEvent(this.scrollPane,"scroll",this.onScroll),this.autoDispose(_.createGroup(le.gridCommands,this,this.viewSection.hasFocus));const i=this.autoDispose(d.pureComputed((()=>!this.cellSelector.isCurrentSelectType("")||this.copySelection())));this.autoDispose(_.createGroup(le.selectionCommands,this,i)),this._colClickTime=0}function ae(e,t,o){return d.computed((()=>{if(e.isDisposed())return null;const i=t();return i&&i.style&&i.style[o]||""}))}C.setBaseFor(le),a.extend(le.prototype,S.prototype),le.selectionCommands={clearCopySelection:function(){this._clearCopySelection()},cancel:function(){this.clearSelection()}},le.gridCommands={cursorUp:function(){0===this.cursor.rowIndex()&&(this.scrollPane.scrollTop=0),this.cursor.rowIndex(this.cursor.rowIndex()-1)},shiftDown:function(){this._shiftSelect(1,this.cellSelector.row.end,I.COL,this.getLastDataRowIndex())},shiftUp:function(){this._shiftSelect(-1,this.cellSelector.row.end,I.COL,this.getLastDataRowIndex())},shiftRight:function(){this._shiftSelect(1,this.cellSelector.col.end,I.ROW,this.viewSection.viewFields().peekLength-1)},shiftLeft:function(){this._shiftSelect(-1,this.cellSelector.col.end,I.ROW,this.viewSection.viewFields().peekLength-1)},ctrlShiftDown:function(){this._shiftSelectUntilContent(I.COL,1,this.cellSelector.row.end,this.getLastDataRowIndex())},ctrlShiftUp:function(){this._shiftSelectUntilContent(I.COL,-1,this.cellSelector.row.end,this.getLastDataRowIndex())},ctrlShiftRight:function(){this._shiftSelectUntilContent(I.ROW,1,this.cellSelector.col.end,this.viewSection.viewFields().peekLength-1)},ctrlShiftLeft:function(){this._shiftSelectUntilContent(I.ROW,-1,this.cellSelector.col.end,this.viewSection.viewFields().peekLength-1)},fillSelectionDown:function(){this.fillSelectionDown()},selectAll:function(){this.selectAll()},fieldEditSave:function(){this.cursor.rowIndex(this.cursor.rowIndex()+1)},editField:function(){L(),this.scrollToCursor(!0),this.activateEditorAtCursor()},insertFieldBefore:function(){this.insertColumn(this.cursor.fieldIndex())},insertFieldAfter:function(){this.insertColumn(this.cursor.fieldIndex()+1)},renameField:function(){this.renameColumn(this.cursor.fieldIndex())},hideFields:function(){this.hideFields(this.getSelection())},deleteFields:function(){const e=this.getSelection(),t=e.colIds.length;this.deleteColumns(e).then((e=>{!1!==e&&A(this.gristDoc,`You deleted ${t} column${t>1?"s":""}.`)}))},clearValues:function(){this.clearValues(this.getSelection())},clearColumns:function(){this._clearColumns(this.getSelection())},convertFormulasToData:function(){this._convertFormulasToData(this.getSelection())},copy:function(){return this.copy(this.getSelection())},cut:function(){return this.cut(this.getSelection())},paste:async function(e,t){await this.gristDoc.docData.bundleActions(null,(()=>this.paste(e,t))),await this.scrollToCursor(!1)},sortAsc:function(){y(this.viewSection.activeSortSpec,this.currentColumn().getRowId(),p.ASC)},sortDesc:function(){y(this.viewSection.activeSortSpec,this.currentColumn().getRowId(),p.DESC)},addSortAsc:function(){v(this.viewSection.activeSortSpec,this.currentColumn().getRowId(),p.ASC)},addSortDesc:function(){v(this.viewSection.activeSortSpec,this.currentColumn().getRowId(),p.DESC)},toggleFreeze:function(){const e=this.getSelection(),t=this._getColumnMenuOptions(e),o=W(t);o&&(this.gristDoc.isReadonly.get()?this.viewSection.rawNumFrozen(o.numFrozen):this.viewSection.rawNumFrozen.setAndSave(o.numFrozen))}},le.prototype.onTableLoaded=function(){S.prototype.onTableLoaded.call(this),this.onScroll(),this.scrollPane.scrollLeft=this.viewSection.lastScrollPos.scrollLeft,this.scrolly.scrollToSavedPos(this.viewSection.lastScrollPos)},le.prototype._shiftSelect=function(e,t,o,i){if(console.assert(o===I.ROW||o===I.COL),!this.cellSelector.isCurrentSelectType(o)){this.cellSelector.isCurrentSelectType(I.NONE)&&this.cellSelector.currentSelectType(I.CELL);var s=u.clamp(t()+e,0,i);t(s)}},le.prototype._shiftSelectUntilContent=function(e,t,o,i){const s={colStart:this.cellSelector.col.start(),colEnd:this.cellSelector.col.end(),rowStart:this.cellSelector.row.start(),rowEnd:this.cellSelector.row.end()},n=this._stepsToContent(e,t,s,i);n>0&&this._shiftSelect(t*n,o,e,i)},le.prototype._stepsToContent=function(e,t,o,i){const{colEnd:s,rowEnd:n}=o;let r;const l=this.cursor.fieldIndex(),a=this.cursor.rowIndex();if(e===I.ROW&&t>0){if(s+1>i)return 0;r=this._selectionData({colStart:s,colEnd:i,rowStart:a,rowEnd:a})}else if(e===I.ROW&&t<0){if(s-1<0)return 0;r=this._selectionData({colStart:0,colEnd:s,rowStart:a,rowEnd:a})}else if(e===I.COL&&t>0){if(n+1>i)return 0;r=this._selectionData({colStart:l,colEnd:l,rowStart:n,rowEnd:i})}else if(e===I.COL&&t<0){if(n-1>i)return 0;r=this._selectionData({colStart:l,colEnd:l,rowStart:0,rowEnd:n})}const{fields:d,rowIndices:c}=r;e===I.ROW&&t<0&&d.reverse(),e===I.COL&&t<0&&c.reverse();const u={};for(const e of d){const t=e.displayColModel.peek().colId.peek();u[e._index()]=this.tableModel.tableData.getColValues(t)}let h=0;if(e===I.ROW){const e=c[0],o=this._isCellValueEmpty(u[s][e]),i=this._isCellValueEmpty(u[s+t][e]),n=!o&&!i;for(let t=1;t<d.length;t++){const o=this._isCellValueEmpty(u[d[t]._index()][e]);if(o&&n)return h;if(!o&&!n)return h+1;h+=1}}else{const e=u[d[0]._index()],t=this._isCellValueEmpty(e[c[0]]),o=this._isCellValueEmpty(e[c[1]]),i=!t&&!o;for(let t=1;t<c.length;t++){const o=this._isCellValueEmpty(e[c[t]]);if(o&&i)return h;if(!o&&!i)return h+1;h+=1}}return h},le.prototype._selectionData=function({colStart:e,colEnd:t,rowStart:o,rowEnd:i}){const s=[];for(let o=e;o<=t;o++){const e=this.viewSection.viewFields().at(o);e&&s.push(e)}const n=[];for(let e=o;e<=i;e++){const t=this.viewData.getRowId(e);t&&n.push(this.tableModel.tableData.getRowIdIndex(t))}return{fields:s,rowIndices:n}},le.prototype._isCellValueEmpty=function(e){return null==e||""===e||"false"===e},le.prototype.paste=async function(e,t){let o=a.unzip(e),i=o[0].length,s=o.length,n=Math.max(u.roundDownToMultiple(this.cellSelector.rowCount(),i),i),r=Math.max(u.roundDownToMultiple(this.cellSelector.colCount(),s),s),l=this.cellSelector.rowLower(),d=a.range(l,l+n).map((e=>this.viewData.getRowId(e))),c=this.cellSelector.colLower(),h=a.range(c,c+r);o=u.growMatrix(o,h.length,d.length);let p=this.viewSection.viewFields().peek(),m=h.map((e=>p[e]||null));const g=await te(o,m,this.gristDoc);let f=this._createBulkActionsFromPaste(d,g);if(f.length>0){let e=this.cursor.getCursorPos();return this.sendPasteActions(t,f).then((t=>{let o="BulkAddRecord"===f[0][0]?t[0]:[];console.assert(o.length<=d.length,`Unexpected number of added rows: ${o.length} of ${d.length}`);let i=d.slice(0,d.length-o.length).concat(o);this.cursor.setCursorPos({rowId:"new"===e.rowId?o[0]:e.rowId});let s=this.viewData.getRowIndex(i[0]);i.every(((e,t)=>e===this.viewData.getRowId(s+t)))&&this.cellSelector.selectArea(s,c,s+n-1,c+r-1),_.allCommands.clearCopySelection.run()}))}},le.prototype._createBulkActionsFromPaste=function(e,t){if(a.isEmpty(t))return[];let o=e.filter((e=>null===e||"new"===e)).length,i=e.length-o,s=[];return o>0&&s.push(["BulkAddRecord",u.arrayRepeat(o,null),a.mapObject(t,(e=>e.slice(-o)))]),i>0&&s.push(["BulkUpdateRecord",e.slice(0,i),a.mapObject(t,(e=>e.slice(0,i)))]),this.prepTableActions(s)},le.prototype.fillSelectionDown=function(){var e=this.cellSelector.rowLower(),t=a.times(this.cellSelector.rowCount(),(t=>this.viewData.getRowId(e+t)));if(!(t.length<=1)){var o=this.cellSelector.colLower(),i=this.viewSection.viewFields().peek(),s=a.times(this.cellSelector.colCount(),(e=>{if(!i[o+e].column().isFormula())return i[o+e].colId()})).filter((e=>e)),n=a.object(s,s.map((e=>{var o=this.tableModel.tableData.getValue(t[0],e);return t.map((()=>o))})));this.tableModel.sendTableAction(["BulkUpdateRecord",t,n])}},le.prototype.getSelection=function(){let e=[],t=[],o={},i={},s=this.cellSelector.colLower(),n=this.cellSelector.colUpper(),r=this.cellSelector.rowLower(),l=this.cellSelector.rowUpper();if(this.cellSelector.isCurrentSelectType(I.NONE)&&(r=l=this.cursor.rowIndex(),s=n=this.cursor.fieldIndex()),this.cellSelector.isCurrentSelectType(I.ROW)?(s=0,n=this.viewSection.viewFields().peekLength-1):this.cellSelector.isCurrentSelectType(I.COL)&&(r=0,l=this.getLastDataRowIndex()),null!==s&&null!==n)for(var a=s;a<=n;a++){let e=this.viewSection.viewFields().at(a);t.push(e),i[e.colId()]=this._getColStyle(a)}for(var d,c=r;c<=l;c++)d=this.viewData.getRowId(c),e.push(d),o[d]=this._getRowStyle(c);return new D(this.tableModel.tableData,e,t,{rowStyle:o,colStyle:i})},le.prototype.clearSelection=function(){this.copySelection(null),this.cellSelector.setToCursor()},le.prototype.clearValues=function(e){if(!0===this._getColumnMenuOptions(e).isFormula)this.activateEditorAtCursor({init:""});else{let t=b.makeDeleteAction(e);t&&this.gristDoc.docData.sendAction(t)}},le.prototype._clearColumns=function(e){const t=e.fields;return this.gristDoc.clearColumns(t.map((e=>e.colRef.peek())))},le.prototype._convertFormulasToData=function(e){const t=e.fields.filter((e=>e.column.peek().isFormula.peek()));return t.length?this.gristDoc.convertIsFormula(t.map((e=>e.colRef.peek())),{toFormula:!1}):null},le.prototype.selectAll=function(){this.cellSelector.selectArea(0,0,this.getLastDataRowIndex(),this.viewSection.viewFields().peekLength-1)},le.prototype.assignCursor=function(e,t){this.viewSection.hasFocus(!0);try{let o=this.domToRowModel(e,t),i=this.domToColModel(e,t);_.allCommands.setCursor.run(o,i)}catch(e){console.error(e),console.error("GridView.assignCursor expects a row/col header, or cell as an input.")}this.cellSelector.setToCursor(t)},le.prototype.scheduleAssignCursor=function(e,t){this._assignCursorTimeoutId=setTimeout((()=>{this.assignCursor(e,t),this._assignCursorTimeoutId=null}),0)},le.prototype.preventAssignCursor=function(){clearTimeout(this._assignCursorTimeoutId),this._assignCursorTimeoutId=null},le.prototype.selectedRows=function(){const e=this.getSelection();return a.without(e.rowIds,"new")},le.prototype.deleteRows=async function(e){const t=this.cursor.getCursorPos();this.cursor.setLive(!1);try{await S.prototype.deleteRows.call(this,e)}finally{this.cursor.setCursorPos(t),this.cursor.setLive(!0),this.clearSelection()}},le.prototype.addNewColumn=function(){this.insertColumn(this.viewSection.viewFields().peekLength).then((()=>this.scrollPaneRight()))},le.prototype.insertColumn=async function(e){const t=b.fieldInsertPositions(this.viewSection.viewFields(),e)[0];var o=["AddColumn",null,{_position:t}];await this.gristDoc.docData.bundleActions("Insert column",(async()=>{const e=await this.tableModel.sendTableAction(o);if(!this.viewSection.isRaw.peek()){const o={colRef:e.colRef,parentPos:t,parentId:this.viewSection.id.peek()};await this.gristDoc.docModel.viewFields.sendTableAction(["AddRecord",null,o])}})),this.selectColumn(e),this.currentEditingColumnIndex(e)},le.prototype.renameColumn=function(e){this.currentEditingColumnIndex(e)},le.prototype.scrollPaneRight=function(){this.scrollPane.scrollLeft=this.scrollPane.scrollWidth},le.prototype.selectColumn=function(e){this.cursor.fieldIndex(e),this.cellSelector.currentSelectType(I.COL)},le.prototype.showColumn=function(e,t){let o=b.fieldInsertPositions(this.viewSection.viewFields(),t,1)[0],i={parentId:this.viewSection.id(),colRef:e,parentPos:o};return this.gristDoc.docModel.viewFields.sendTableAction(["AddRecord",null,i]).then((()=>this.selectColumn(t))).then((()=>this.scrollPaneRight()))},le.prototype.deleteColumns=function(e){var t=e.fields;if(t.length===this.viewSection.viewFields().peekLength)return O("You can't delete all the columns on the grid.",{key:"delete-all-columns"}),Promise.resolve(!1);let o=t.filter((e=>!e.disableModify())).map((e=>["RemoveColumn",e.colId()]));return o.length>0?this.tableModel.sendTableActions(o,`Removed columns ${o.map((e=>e[1])).join(", ")} from ${this.tableModel.tableData.tableId}.`).then((()=>this.clearSelection())):Promise.resolve(!1)},le.prototype.hideFields=function(e){var t=e.fields.map((e=>["RemoveRecord",e.id()]));return this.gristDoc.docModel.viewFields.sendTableActions(t,`Hide columns ${t.map((e=>e[1])).join(", ")} from ${this.tableModel.tableData.tableId}.`)},le.prototype.moveColumns=function(e,t){if(0===e.length)return;if(e[0]===t||e[0]+1===t)return;var o=b.fieldInsertPositions(this.viewSection.viewFields(),t,e.length),i=["BulkUpdateRecord",e.map((function(e){return this.viewSection.viewFields().at(e).id()}),this),{parentPos:o}],s=this.gristDoc.docModel.viewFields,n=e.length;const r=t<this.cellSelector.colLower()?t:t-n;s.sendTableAction(i).then((()=>{this.cursor.fieldIndex(r),this.cellSelector.currentSelectType(I.COL),this.cellSelector.col.start(r),this.cellSelector.col.end(r+n-1)}))},le.prototype.moveRows=function(e,t){if(0===e.length)return;if(e[0]===t||e[0]+1===t)return;var o=this._getRowInsertPos(t,e.length),i=["BulkUpdateRecord",e.map((function(e){return this.viewData.getRowId(e)}),this),{manualSort:o}],s=e.length;const n=t<this.cellSelector.rowLower()?t:t-s;this.tableModel.sendTableAction(i).then((()=>{this.cursor.rowIndex(n),this.cellSelector.currentSelectType(I.ROW),this.cellSelector.row.start(n),this.cellSelector.row.end(n+s-1)}))},le.prototype.getMousePosRow=function(e){var t=this.header.getBoundingClientRect().bottom;return this.scrolly.rowOffsetTree.getIndex(e-t)},le.prototype.currentMouseRow=function(e){return Math.min(this.getMousePosRow(this.scrollTop()+e),this.getLastDataRowIndex())},le.prototype.getMousePosCol=function(e){const t=this.scrollLeft(),o=e-this._cornerDom.getBoundingClientRect().right,i=this.frozenWidth.peek(),s=Math.min(this.frozenOffset.peek(),t),n=o+(this.numFrozen.peek()&&o<=i-s?s:t);return this.colRightOffsets.peek().getIndex(n)},le.prototype._getRowStyle=function(e){return{height:this.scrolly.rowOffsetTree.getValue(e)+"px"}},le.prototype._getColStyle=function(e){return{width:this.viewSection.viewFields().at(e).widthPx()}},le.prototype.domToRowModel=function(e,t){switch(t){case I.COL:return;case I.ROW:return d.utils.domData.get(e.parentNode,"itemModel");case I.NONE:case I.CELL:return d.utils.domData.get(e.parentNode.parentNode,"itemModel");default:throw Error("Unknown elemType in domToRowModel:"+t)}},le.prototype.domToColModel=function(e,t){switch(t){case I.ROW:return;case I.NONE:case I.CELL:case I.COL:return d.utils.domData.get(e,"itemModel");default:throw Error("Unknown elemType in domToRowModel")}},le.prototype.onScroll=function(){var e=this.scrollPane;this.scrollLeft(e.scrollLeft),this.scrollTop(e.scrollTop),this.width(e.clientWidth)},le.prototype.buildDom=function(){var e=this,t=this.viewData,o=this.viewSection,i=this.currentEditingColumnIndex;let s=o.optionsObj.prop("horizontalGridlines"),n=o.optionsObj.prop("verticalGridlines"),r=o.optionsObj.prop("zebraStripes");var l={nextField:function(){i()===o.viewFields().peekLength-1?i(-1):(i(i()+1),e.selectColumn(i.peek()))},prevField:function(){i(i()-1),e.selectColumn(i.peek())}};return m("div.gridview_data_pane.flexvbox",g.style("--frozen-offset",this.frozenOffset),g.style("--frozen-width",this.frozenWidth),e._cornerDom=m("div.gridview_data_corner_overlay",m.on("click",(()=>this.selectAll()))),m("div.scroll_shadow_top",g.show(this.scrollShadow.top)),m("div.scroll_shadow_left",g.show(this.scrollShadow.left),g.style("--frozen-scroll-offset",this.frozenScrollOffset)),m("div.frozen_line",g.show(this.frozenLine)),m("div.gridview_header_backdrop_left"),m("div.gridview_header_backdrop_top"),m("div.gridview_left_border",g.show(this.numFrozen),g.style("left","52px")),m("div.scroll_shadow_frozen",g.show(this.frozenShadow)),m.on("mouseleave",(()=>!this.isDisposed()&&this.hoverColumn(-1))),e.colLine=m("div.col_indicator_line",g.show((function(){return e.cellSelector.isCurrentDragType(I.COL)})),g.style("left",e.cellSelector.col.linePos)),e.colShadow=m("div.column_shadow",g.show((function(){return e.cellSelector.isCurrentDragType(I.COL)})),g.style("left",(function(){return e.dragX()-e.colShadowAdjust+"px"}))),e.rowLine=m("div.row_indicator_line",g.show((function(){return e.cellSelector.isCurrentDragType(I.ROW)})),g.style("top",e.cellSelector.row.linePos)),e.rowShadow=m("div.row_shadow",g.show((function(){return e.cellSelector.isCurrentDragType(I.ROW)})),g.style("top",(function(){return e.dragY()-e.rowShadowAdjust+"px"}))),e.scrollPane=m("div.grid_view_data.gridview_data_scroll.show_scrollbar",g.scrollChildIntoView(e.visibleRowIndex),m.onDispose((()=>{e.viewSection.lastScrollPos=a.extend({scrollLeft:e.scrollPane.scrollLeft},e.scrolly.getScrollPos())})),m("div.gridview_stick-top.flexhbox",m("div.gridview_corner_spacer"),e.header=m("div.gridview_data_header.flexhbox",m("div.column_names.record",g.style("minWidth","100%"),g.style("borderLeftWidth",o.borderWidthPx),g.foreach(o.viewFields(),(t=>{const s=T.withKoUtils(d.pureComputed({read:()=>i()===t._index()&&!(()=>this.gristDoc.isReadonlyKo()||e.isPreview)()&&!Boolean(t.column().disableEditData()),write:e=>{e?i(t._index()):i.peek()===t._index.peek()&&i(-1)}}).extend({rateLimit:0})).onlyNotifyUnequal();let n;const r=d.pureComputed((()=>e.editingFormula()&&d.unwrap(e.hoverColumn)===t._index())),a=d.computed((()=>t.headerTextColor()||"")),c=d.computed((()=>t.headerFillColor()||"")),u=d.computed((()=>t.headerFontBold())),h=d.computed((()=>t.headerFontItalic())),p=d.computed((()=>t.headerFontUnderline())),w=d.computed((()=>t.headerFontStrikethrough()));return m("div.column_name.field",m.autoDispose(a),m.autoDispose(c),m.autoDispose(u),m.autoDispose(h),m.autoDispose(p),m.autoDispose(w),g.style("--grist-header-color",a),g.style("--grist-header-background-color",c),g.toggleClass("font-bold",u),g.toggleClass("font-italic",h),g.toggleClass("font-underline",p),g.toggleClass("font-strikethrough",w),g.style("--frozen-position",(()=>d.unwrap(this.frozenPositions.at(t._index())))),g.toggleClass("frozen",(()=>d.unwrap(this.frozenMap.at(t._index())))),m.autoDispose(s),m.autoDispose(r),m.testId("GridView_columnLabel"),(e=>{const o=new de(e);return[m.autoDispose(o),m.autoDispose(r.subscribe((e=>{e?o.show(re("Click to insert")+` $${t.origCol.peek().colId.peek()}`):o.hide()})))]}),g.style("width",t.widthPx),g.style("borderRightWidth",o.borderWidthPx),x.makeResizable(t.width,{shouldSave:!this.gristDoc.isReadonly.get()}),g.toggleClass("selected",(()=>d.unwrap(this.isColSelected.at(t._index())))),m.on("contextmenu",(e=>{e.preventDefault();const t=e.currentTarget.querySelector(".g-column-menu-btn");t&&t.click()})),m("div.g-column-label",g.scope(t.description,(e=>e?Q(e,"column"):null)),m.on("mousedown",(e=>!s()||e.stopPropagation())),f.editableLabel(e.isPreview?t.label:t.displayLabel,d.observable(!1)),g.scope(t.description,(e=>e?m("div.g-column-label-spacer"):null)),se({field:t,isEditing:s,optCommands:l})),e._showTooltipOnHover(t,r),e.isPreview?null:Z(null,g.cssClass("g-column-main-menu"),g.cssClass("g-column-menu-btn"),m.on("mousedown",(()=>!1)),m.on("click",(e=>this.maybeSelectColumn(e.currentTarget.parentNode,t))),(e=>{n=G(e,(e=>this._columnFilterMenu(e,t,{showAllFiltersButton:!0})),{attach:"body",placement:"bottom-start",boundaries:"viewport",trigger:[]})}),U((e=>this.columnContextMenu(e,this.getSelection(),t,n))),J("column-menu-trigger")),m("div.selection"))})),this.isPreview?null:g.maybe((()=>!this.gristDoc.isReadonlyKo()),(()=>this._modField=m("div.column_name.mod-add-column.field","+",g.style("width","40px"),m.on("click",(e=>{0===this.viewSection.hiddenColumns().length&&(e.stopImmediatePropagation(),this.addNewColumn())})),U((e=>V(this,this.viewSection))))))))),w.scrolly(t,{paddingBottom:80,paddingRight:28},c),g.maybe(this._isPrinting,(()=>M(this.tableModel,this.sortedRows.getKoArray().peek(),c)))));function c(t){var i=d.computed((()=>t._index()===e.cursor.rowIndex()));const l=d.pureComputed((()=>e.viewSection.rulesColsIds().map((e=>t.cells[e]&&t.cells[e]()||!1)))),a=T.withKoUtils(d.pureComputed((()=>{if(t._isAddRow()||!t.id())return null;const o=l();if(0===o.length)return null;const i=e.viewSection.rulesStyles()||[];return{style:new ie(i,o)}}),this).extend({deferred:!0})),c=ae(e,a,"fillColor"),u=d.pureComputed((()=>function(e){if(!e||7!==e.length)return e;const t=k.hex.hsl(e.substr(1));return t[2]>50?t[2]-=2.6:t[2]>1?t[2]+=11:t[2]+=16,`#${k.hsl.hex(t)}`}(c()))),h=ae(e,a,"textColor"),p=ae(e,a,"fontBold"),f=ae(e,a,"fontItalic"),w=ae(e,a,"fontUnderline"),b=ae(e,a,"fontStrikethrough");return m("div.gridview_row",m.autoDispose(i),m.autoDispose(l),m.autoDispose(a),m.autoDispose(h),m.autoDispose(c),m.autoDispose(u),m.autoDispose(p),m.autoDispose(f),m.autoDispose(w),m.autoDispose(b),g.toggleClass("link_selector_row",(()=>e.isLinkSource()&&i())),m("div.gridview_data_row_num",g.style("width","52px"),m("div.gridview_data_row_info",g.toggleClass("linked_dst",(()=>{const o=t.id(),i=e.linkedRowId();return i&&i===o}))),g.text((function(){return t._index()+1})),g.scope(t._validationFailures,(function(e){if(!t._isAddRow()&&e.length>0)return m("div.validation_error_number",e.length,g.attr("title",(function(){return"Validation failed: "+e.map((function(e){return e.name()})).join(", ")})))})),m.on("contextmenu",(e=>{e.preventDefault(),e.currentTarget.querySelector(".menu_toggle").click()})),e.isPreview?null:Z(null,m.on("click",(o=>e.maybeSelectRow(o.currentTarget.parentNode,t.getRowId()))),U((t=>(t.autoDispose(i.subscribe((()=>t.close()))),e.rowContextMenu())),{trigger:["click"]}),m.on("mousedown",(()=>!1)),J("row-menu-trigger")),g.toggleClass("selected",(()=>!t._isAddRow()&&e.cellSelector.isRowSelected(t._index())))),m("div.record",g.toggleClass("record-add",t._isAddRow),g.style("borderLeftWidth",o.borderWidthPx),g.style("borderBottomWidth",o.borderWidthPx),g.toggleClass("font-bold",p),g.toggleClass("font-underline",w),g.toggleClass("font-italic",f),g.toggleClass("font-strikethrough",b),g.style("--grist-row-rule-background-color",c),g.style("--grist-row-rule-background-color-zebra",u),g.style("--grist-row-color",h),g.toggleClass("record-hlines",s),g.toggleClass("record-vlines",n),g.toggleClass("record-zebra",r),g.toggleClass("record-even",(()=>(t._index()+1)%2==0)),m.on("mouseleave",(t=>{t.relatedTarget&&t.relatedTarget.classList.contains("record")||e.changeHover(-1)})),e.isPreview?null:q((t=>(t.autoDispose(i.subscribe((()=>t.close()))),e.cellContextMenu()))),e.comparison?g.cssClass((()=>{const o=e.extraRows.getRowType(t.id());return o&&`diff-${o}`||""})):null,g.foreach(o.viewFields(),(function(s){var n=d.computed((()=>i()&&s._index()===e.cursor.fieldIndex())),r=d.computed((()=>n()&&o.hasFocus())),l=d.computed((function(){return e.copySelection()&&e.copySelection().isCellSelected(t.id(),s.colId())})),a=e.fieldBuilders.at(s._index()),c=d.computed((()=>!t._isAddRow()&&!e.cellSelector.isCurrentSelectType(I.NONE)&&d.unwrap(e.isColSelected.at(s._index()))&&e.cellSelector.isRowSelected(t._index()))),u=d.pureComputed((()=>e.editingFormula()&&d.unwrap(e.hoverColumn)===s._index()));return m("div.field",g.style("--frozen-position",(()=>d.unwrap(e.frozenPositions.at(s._index())))),g.toggleClass("frozen",(()=>d.unwrap(e.frozenMap.at(s._index())))),g.toggleClass("scissors",l),m.autoDispose(l),m.autoDispose(n),m.autoDispose(r),m.autoDispose(c),e._showTooltipOnHover(s,u),g.style("width",s.widthPx),g.style("borderRightWidth",o.borderWidthPx),g.toggleClass("selected",c),a.buildDomWithCursor(t,r,n),m("div.selection"))}))))}},le.prototype.onResize=function(){const e=this.activeFieldBuilder();let t=null;X()&&(t=window.outerHeight),e&&e.isEditorActive()?(this.scrolly.updateSize(t),this.scrolly.scrollRowIntoView(this.cursor.rowIndex.peek())):this.scrolly.scheduleUpdateSize(t),this.width(this.scrollPane.clientWidth)},le.prototype.onRowResize=function(e){this.scrolly.resetItemHeights(e)},le.prototype.onLinkFilterChange=function(e){S.prototype.onLinkFilterChange.call(this,e),this.clearSelection()},le.prototype.onCellContextMenu=function(e,t){let o=this.domToRowModel(t,I.CELL),i=this.domToColModel(t,I.CELL);this.cellSelector.containsCell(o._index(),i._index())?this.preventAssignCursor():this.assignCursor(t,I.NONE)},le.prototype._createColSelectedObs=function(e){return d.pureComputed((function(){return this.cellSelector.isCurrentSelectType(I.ROW)||u.between(e._index(),this.cellSelector.col.start(),this.cellSelector.col.end())}),this)},le.prototype.cellMouseDown=function(e,t){let o=this.domToColModel(e,I.CELL);if(this.hoverColumn()===o._index())return this._tooltipMouseDown(e,I.CELL);if(t.shiftKey){this.viewSection.hasFocus(!0);let t=this.domToRowModel(e,I.CELL);this.cellSelector.selectArea(this.cursor.rowIndex(),this.cursor.fieldIndex(),t._index(),o._index())}else this.assignCursor(e,I.NONE)},le.prototype.colMouseDown=function(e,t){let o=this.domToColModel(e,I.COL);if(this.hoverColumn()===o._index())return this._tooltipMouseDown(e,I.COL);this._colClickTime=Date.now(),this.assignCursor(e,I.COL),this.cellSelector.row.end(this.getLastDataRowIndex())},le.prototype._tooltipMouseDown=function(e,t){let o=this.domToRowModel(e,t),i=this.domToColModel(e,t);_.allCommands.setCursor.run(o,i)},le.prototype.rowMouseDown=function(e,t){t.shiftKey?(this.cellSelector.currentSelectType(I.ROW),this.cellSelector.row.end(this.currentMouseRow(t.pageY))):this.assignCursor(e,I.ROW)},le.prototype.rowMouseMove=function(e){this.cellSelector.row.end(this.currentMouseRow(e.pageY))},le.prototype.colMouseMove=function(e){if(!this.editingFormula()){var t=Math.min(this.getMousePosCol(e.pageX),this.viewSection.viewFields().peekLength-1);this.cellSelector.col.end(t)}},le.prototype.cellMouseMove=function(e){this.editingFormula()||(this.colMouseMove(e),this.rowMouseMove(e),this.cellSelector.onlyCellSelected(this.cursor.rowIndex(),this.cursor.fieldIndex())?this.cellSelector.currentSelectType(I.NONE):this.cellSelector.currentSelectType(I.CELL))},le.prototype.createSelector=function(){this.cellSelector=new I.CellSelector(this)},le.prototype.attachSelectorHandlers=function(){const e=(e,t)=>0!==e.button||e.target.classList.contains("ui-resizable-handle")||!this.ctxMenuHolder.isEmpty();this.autoDispose(Y(this.viewPane,".gridview_data_row_num",((t,o)=>{if(!e(t)){if(!this.cellSelector.isSelected(o,I.ROW))return this.rowMouseDown(o,t),{onMove:e=>this.rowMouseMove(e),onStop:e=>{}};if(!this.viewSection.disableDragRows())return this.styleRowDragElements(o,t),{onMove:e=>this.dragRows(e),onStop:e=>this.dropRows()}}}))),this.autoDispose(Y(this.viewPane,".column_name.field:not(.mod-add-column)",((t,o)=>{if(!e(t))return this.cellSelector.isSelected(o,I.COL)?(this.styleColDragElements(o,t),{onMove:e=>this.dragCols(e),onStop:e=>this.dropCols()}):(this.colMouseDown(o,t),{onMove:e=>this.colMouseMove(e),onStop:e=>{}})}))),this.autoDispose(Y(this.scrollPane,".field:not(.column_name)",((t,o)=>{if(!e(t))return this.cellSelector.isSelected(o,I.CELL)?(this.scheduleAssignCursor(o,I.NONE),{onMove:e=>{},onStop:e=>{this.cellSelector.currentDragType(I.NONE)}}):(this.cellMouseDown(o,t),{onMove:e=>this.cellMouseMove(e),onStop:e=>{}})})))},le.prototype.styleRowDragElements=function(e,t){var o=this.cellSelector.rowLower(),i=this.cellSelector.rowUpper(),s=this.scrolly.rowOffsetTree.getCumulativeValueRange(o,i+1),n=this.header.getBoundingClientRect().height+this.scrolly.rowOffsetTree.getSumTo(o)-this.scrollTop();this.rowLine.style.top=n+"px",this.rowShadow.style.top=n+"px",this.rowShadow.style.height=s+"px",this.rowShadowAdjust=t.pageY-n,this.cellSelector.currentDragType(I.ROW),this.cellSelector.row.dropIndex(this.cellSelector.rowLower())},le.prototype.styleColDragElements=function(e,t){this._colClickTime=Date.now();var o=this.cellSelector.colLower(),i=this.cellSelector.colUpper(),s=this.colRightOffsets.peek().getCumulativeValueRange(o,i+1),n=$(".gridview_corner_spacer").width()+this.colRightOffsets.peek().getSumTo(o)-this.scrollLeft();this.colLine.style.left=n+"px",this.colShadow.style.left=n+"px",this.colShadow.style.width=s+"px",this.colShadowAdjust=t.pageX-n,this.cellSelector.currentDragType(I.COL),this.cellSelector.col.dropIndex(this.cellSelector.colLower())},le.prototype.dragRows=function(e){var t=Math.min(this.getMousePosRow(e.pageY+this.scrollTop()),this.getLastDataRowIndex());this.cellSelector.containsRow(t)?t=this.cellSelector.rowLower():t>this.cellSelector.rowUpper()&&(t+=1),this.cellSelector.rowUpper()===this.viewData.peekLength-1&&(t=Math.min(t,this.cellSelector.rowLower()));var o=this.scrolly.rowOffsetTree.getSumTo(t)+this.header.getBoundingClientRect().height-this.scrollTop();this.cellSelector.row.linePos(o+"px"),this.cellSelector.row.dropIndex(t),this.dragY(e.pageY)},le.prototype.dragCols=function(e){let t=Math.min(this.getMousePosCol(e.pageX),this.viewSection.viewFields().peekLength-1);this.cellSelector.containsCol(t)?t=this.cellSelector.colLower():t>this.cellSelector.colUpper()&&(t+=1),this.cellSelector.colUpper()===this.viewSection.viewFields().peekLength-1&&(t=Math.min(t,this.cellSelector.colLower()));let o=$(".gridview_corner_spacer").width()+this.colRightOffsets.peek().getSumTo(t);const i=this.numFrozen(),s=i>0&&t<i,n=this.scrollLeft();o-=s?Math.min(this.frozenOffset.peek(),n):n,this.cellSelector.col.linePos(o+"px"),this.cellSelector.col.dropIndex(t),this.dragX(e.pageX)},le.prototype.dropRows=function(){var e=a.range(this.cellSelector.rowLower(),this.cellSelector.rowUpper()+1);this.moveRows(e,this.cellSelector.row.dropIndex()),this.cellSelector.currentDragType(I.NONE)},le.prototype.dropCols=function(){var e=a.range(this.cellSelector.colLower(),this.cellSelector.colUpper()+1);const t=this.cellSelector.col.dropIndex();this.moveColumns(e,t),Date.now()-this._colClickTime<500&&1===e.length&&t===e[0]&&_.allCommands.renameField.run(),this._colClickTime=0,this.cellSelector.currentDragType(I.NONE)},le.prototype.columnContextMenu=function(e,t,o,i){const a=t.colIds;this.ctxMenuHolder.autoDispose(e);const d=this._getColumnMenuOptions(t);return a.length>1&&a.includes(o.column().colId())?j(d):N(((e,t)=>{for(var o in t||(t={}))n.call(t,o)&&l(e,o,t[o]);if(s)for(var o of s(t))r.call(t,o)&&l(e,o,t[o]);return e})({filterOpenFunc:()=>i.open(),sortSpec:this.gristDoc.viewModel.activeSection.peek().activeSortSpec.peek(),colId:o.column.peek().id.peek()},d))},le.prototype._getColumnMenuOptions=function(e){return{columnIndices:e.fields.map((e=>e._index())),totalColumnCount:this.viewSection.viewFields.peek().peekLength,numColumns:e.fields.length,numFrozen:this.viewSection.numFrozen.peek(),disableModify:z(e.fields,(e=>e.disableModify.peek())),isReadonly:this.gristDoc.isReadonly.get()||this.isPreview,isRaw:this.viewSection.isRaw(),isFiltered:this.isFiltered(),isFormula:z(e.fields,(e=>e.column.peek().isRealFormula.peek()))}},le.prototype._columnFilterMenu=function(e,t,o){this.ctxMenuHolder.autoDispose(e);const i=this.viewSection.filters().find((({fieldOrColumn:e})=>e.origCol().origColRef()===t.column().origColRef()));return i.isFiltered.peek()||this.viewSection.setFilter(i.fieldOrColumn.origCol().origColRef(),{filter:oe,pinned:!0}),this.createFilterMenu(e,i,o)},le.prototype.maybeSelectColumn=function(e,t){this.viewSection.hasFocus(!0);const o=this.getSelection().colIds;o.length>1&&o.includes(t.column().colId())||this.assignCursor(e,I.COL)},le.prototype.maybeSelectRow=function(e,t){this.viewSection.hasFocus(!0),this.getSelection().rowIds.includes(t)||this.assignCursor(e,I.ROW)},le.prototype.rowContextMenu=function(){return H(this._getRowContextMenuOptions())},le.prototype._getRowContextMenuOptions=function(){return{disableInsert:Boolean(this.gristDoc.isReadonly.get()||this.viewSection.disableAddRemoveRows()||this.tableModel.tableMetaRow.onDemand()),disableDelete:Boolean(this.gristDoc.isReadonly.get()||this.viewSection.disableAddRemoveRows()||this.getSelection().onlyAddRowSelected()),isViewSorted:this.viewSection.activeSortSpec.peek().length>0,numRows:this.getSelection().rowIds.length}},le.prototype.cellContextMenu=function(){return K(this._getRowContextMenuOptions(),this._getColumnMenuOptions(this.getSelection()))},le.prototype.scrollToCursor=function(e=!0){return g.doScrollChildIntoView(this.scrollPane,this.cursor.rowIndex(),e)},le.prototype._duplicateRows=async function(){const e=await S.prototype._duplicateRows.call(this),t=this.viewData.getRowIndex(e[0]);this.setCursorPos({rowId:e[0]}),e.every(((e,o)=>e===this.viewData.getRowId(t+o)))&&this.cellSelector.selectArea(t,0,t+e.length-1,this.viewSection.viewFields().peekLength-1)},le.prototype._clearCopySelection=function(){this.copySelection(null)},le.prototype._showTooltipOnHover=function(e,t){return[g.toggleClass("hover-column",t),m.on("mouseenter",(()=>{this.changeHover(e._index())})),m.on("mousedown",(e=>{t()&&e.preventDefault()}))]};class de{constructor(e){this.el=e}show(e){this.hide(),this.tooltip=ee(this.el,(()=>m("span",e,J("column-formula-tooltip"))))}hide(){this.tooltip&&(this.tooltip.close(),this.tooltip=null)}dispose(){this.hide()}}e.exports=le},42683:(e,t,o)=>{var i=o(54156),s=o(29301),n=o(74392),r=o(83277),l=o(88438),a=o(81294),{Delay:d}=o(96682),c=o(92979),{makeT:u}=o(70387),h=o(87346),p=o(78843),m=o(77709),{menuToggle:g}=o(42882),{menu:f}=o(1370),{testId:w}=o(29922),{contextMenu:b}=o(74624);const v=u("RecordLayout");function y(e){this.viewSection=e.viewSection,this.buildFieldDom=e.buildFieldDom,this.buildRowContextMenu=e.buildRowContextMenu,this.buildFieldContextMenu=e.buildFieldContextMenu,this.isEditingLayout=s.observable(!1),this.editIndex=s.observable(0),this.layoutEditor=s.observable(null),e.resizeCallback&&(this._resizeCallback=e.resizeCallback,this._delayedResize=this.autoDispose(d.create())),this.fieldsById=this.autoDispose(s.computed((function(){return i.indexBy(this.viewSection.viewFields().all(),(function(e){return e.getRowId()}))}),this)),this.layoutSpec=this.autoDispose(s.computed((function(){return this.viewSection.isDisposed()?null:y.updateLayoutSpecWithFields(this.viewSection.layoutSpecObj(),this.viewSection.viewFields().all())}),this).extend({rateLimit:0})),this.autoDispose(this.layoutSpec.subscribe((()=>this.resizeCallback())))}l.makeDisposable(y),y.prototype.resizeCallback=function(){this.isDisposed()||!this._delayedResize||this.isEditingLayout.peek()||this._delayedResize.schedule(0,this._resizeCallback)},y.prototype.getField=function(e){if("string"==typeof e&&e.includes(":")){var t=r.maxsplit(e,":",2);return{isNewField:!0,colRef:parseInt(t[0],10),label:t[1],value:t[2]}}return this.fieldsById()[e]},y.prototype.editLayout=function(e){this.editIndex(e),this.isEditingLayout(!0)},y.prototype.onEditLayoutCancel=function(e){this.isEditingLayout(!1),this.resizeCallback()},y.prototype.onEditLayoutSave=async function(e){try{await this.saveLayoutSpec(e)}finally{this.isEditingLayout(!1),this.resizeCallback()}},y.updateLayoutSpecWithFields=function(e,t){var o=h.Layout.create(e,(function(e){return a("div")})),s=o.getAllLeafIds(),n=t.map((function(e){return e.getRowId()}));return i.difference(s,n).forEach((function(e){o.getLeafBox(e).dispose()})),i.difference(n,s).forEach((function(e){var t=o.buildLayoutBox({leaf:e}),s=o.rootBox().childBoxes.peek();s.length>=1&&i.last(s).isLeaf()?i.last(s).addChild(t,!0):o.rootBox().addChild(t,!0)})),e=o.getLayoutSpec(),o.dispose(),e},y.prototype.saveLayoutSpec=async function(e){if(JSON.stringify(e)===this.viewSection.layoutSpec.peek())return;const t=this.viewSection._table.docModel,o=t.docData,i=this.viewSection.table().tableId(),s=e=>this.getField(e),l=["AddColumn",null,{}];var a=[],d=new Map;this.viewSection.viewFields().all().forEach((e=>{a.push(e.getRowId()),d.set(e.colRef(),e.getRowId())}));var c=0,u=0,h=[],p=[],m=[],g=[],f=[],w=[],b=[];!function e(t){if(t.leaf&&"empty"!==t.leaf){let e=c++,o=s(t.leaf),i=e=>{t.leaf=e};if(o.isNewField)if(d.has(o.colRef)){let t=d.get(o.colRef);h.push(t),p.push(e),i(t)}else Number.isNaN(o.colRef)?(u++,w.push(i),b.push(e)):(m.push(o.colRef),g.push(i),f.push(e));else h.push(o.getRowId()),p.push(e)}t.children&&t.children.map(e)}(e);let y=w.concat(g),_=b.concat(f),x=r.arrayRepeat(u,0).map((()=>l.slice()));await o.bundleActions(v("Updating record layout."),(()=>n.try((()=>u>0?t.dataTables[i].sendTableActions(x):[])).then((e=>{let o=e.map((e=>e.colRef)).concat(m);const i=o.length;return i>0?t.viewFields.sendTableAction(["BulkAddRecord",r.arrayRepeat(i,null),{parentId:r.arrayRepeat(i,this.viewSection.getRowId()),colRef:o,parentPos:_}]):[]})).each(((e,t)=>{y[t](e)})).then((t=>{let i=[],s=new Set(h.concat(t)),n=a.filter((e=>!s.has(e)));return n.length>0&&i.push(["BulkRemoveRecord","_grist_Views_section_field",n]),h.length>0&&i.push(["BulkUpdateRecord","_grist_Views_section_field",h,{parentPos:p}]),i.push(["UpdateRecord","_grist_Views_section",this.viewSection.getRowId(),{layoutSpec:JSON.stringify(e)}]),o.sendActions(i)}))))},y.prototype.buildLayoutDom=function(e,t){const o=Boolean(t&&!this.layoutEditor.peek()),i=h.Layout.create(this.layoutSpec(),(t=>a("div.g_record_layout_leaf.flexhbox.flexauto",this.buildFieldDom(this.getField(t),e),o?c.maybe(this.layoutEditor,(e=>e.buildLeafDom())):null))),s=this.layoutSpec.subscribe((e=>{i.buildLayout(e,o)}));return o&&this.layoutEditor(p.create(this,i)),a("div.g_record_detail.flexauto",a.autoDispose(i),a.autoDispose(s),o?a.onDispose((()=>{this.layoutEditor.peek().dispose(),this.layoutEditor(null)})):null,b((()=>this.buildFieldContextMenu(e))),a("div.detail_row_num",c.text((()=>e._index()+1)),a.on("contextmenu",(e=>{e.preventDefault(),e.stopPropagation(),e.currentTarget.querySelector(".menu_toggle").click()})),g(null,a.on("click",(()=>{this.viewSection.hasFocus(!0),m.allCommands.setCursor.run(e)})),f((()=>this.buildRowContextMenu(e))),w("card-menu-trigger"))),a("div.g_record_detail_inner",i.rootElem))},y.prototype.getContainingField=function(e,t){return this.getField(h.Layout.getContainingBox(e,t).leafId())},y.prototype.getContainingRow=function(e,t){var o=a.findAncestor(e,t,".g_record_detail");return s.utils.domData.get(o,"itemModel")},e.exports=y},78843:(e,t,o)=>{var i=o(54156),s=o(86277).Events,n=o(88438),{makeT:r}=o(70387),l=o(77709),a=o(29255);const d=r("RecordLayoutEditor"),{basicButton:c,cssButton:u,primaryButton:h}=o(11187),{icon:p}=o(7454),{menu:m,menuDivider:g,menuItem:f}=o(1370),{testId:w}=o(29922),{dom:b,Observable:v,styled:y}=o(1310);function _(e,t,o){this.recordLayout=e,this.layout=t,this.layoutEditor=this.autoDispose(a.LayoutEditor.create(t)),this._hiddenColumns=this.autoDispose(v.create(null,this.getHiddenColumns())),this.listenTo(t,"layoutChanged",(function(){this._hiddenColumns.set(this.getHiddenColumns())})),o&&(this.listenTo(t,"layoutChanged",o),this.listenTo(t,"layoutResized",o)),this.autoDispose(l.createGroup(_.editLayoutCommands,this,!0))}n.makeDisposable(_),i.extend(_.prototype,s),_.editLayoutCommands={accept:function(){this.recordLayout.onEditLayoutSave(this.layout.getLayoutSpec())},cancel:function(){this.layout.buildLayout(this.recordLayout.layoutSpec()),this.recordLayout.onEditLayoutCancel()}},_.prototype.getHiddenColumns=function(){var e=new Set(this.layout.getAllLeafIds().map((function(e){var t=this.recordLayout.getField(e);return t.isNewField?t.colRef:t.colRef.peek()}),this));return this.recordLayout.viewSection.table().columns().all().filter((function(t){return!e.has(t.getRowId())&&!t.isHiddenCol()}))},_.prototype._addField=function(e){var t=this.layout.buildLayoutBox({leaf:e}),o=this.layout.rootBox().childBoxes.peek();o.length>=1&&i.last(o).isLeaf()?i.last(o).addChild(t,!0):this.layout.rootBox().addChild(t,!0)},_.prototype.buildEditorDom=function(){const e=()=>{this._addField(":New_Field:")},t=e=>{setTimeout((()=>this._addField(e.getRowId()+":"+e.label())),0)};return x(c(d("Add Field"),C("Collapse"),m((o=>[f((()=>e()),d("Create New Field")),b.maybe((e=>e(this._hiddenColumns).length>0),(()=>g())),b.forEach(this._hiddenColumns,(e=>f((()=>t(e)),d("Show field {{- label}}",{label:e.label()})))),w("edit-layout-add-menu")]))),b("div.flexauto",{style:"margin-left: 8px"}),this.buildFinishButtons(),w("edit-layout-controls"))},_.prototype.buildFinishButtons=function(){return[h(d("Save Layout"),b.on("click",(()=>l.allCommands.accept.run()))),c(d("Cancel"),b.on("click",(()=>l.allCommands.cancel.run())),{style:"margin-left: 8px"})]},_.prototype.buildLeafDom=function(){return b("div.layout_grabbable.g_record_layout_editing",b("div.g_record_delete_field.glyphicon.glyphicon-eye-close",b.on("mousedown",(e=>e.stopPropagation())),b.on("click",((e,t)=>{e.preventDefault(),e.stopPropagation();const o=this.layoutEditor.getBoxFromElement(t);this.layoutEditor.removeContainingBox(o)}))))};const x=y("div",`\n  display: flex;\n  align-items: flex-start;\n\n  & > .${u.className} {\n    white-space: nowrap;\n    overflow: hidden;\n  }\n`),C=y(p,"\n  margin: -3px -2px -2px 2px;\n");e.exports=_},8113:(e,t,o)=>{var i=o(29301),s=o(88438),n=o(81294),r=o(92979),l=o(73783),a=o(87056),{makeT:d}=o(70387);const c=d("ValidationPanel");function u(e){this.gristDoc=e.gristDoc,this.validationsTable=this.gristDoc.docModel.validations,this.validations=this.autoDispose(this.validationsTable.createAllRowsModel("id")),this.docTables=this.autoDispose(this.gristDoc.docModel.tables.createAllRowsModel("tableId")),this.tableChoices=this.autoDispose(this.docTables.map((function(e){return{label:e.tableId,value:e.id()}})))}s.makeDisposable(u),u.prototype.onAddRule=function(){this.validationsTable.sendTableAction(["AddRecord",null,{tableRef:this.docTables.at(0).id(),name:c("Rule {{length}}",{length:this.validations.peekLength+1}),formula:""}]).then((function(){$(".validation_formula").last().find("input").focus()}))},u.prototype.onDeleteRule=function(e){this.validationsTable.sendTableAction(["RemoveRecord",e])},u.prototype.buildDom=function(){return[l.row(1,l.label("Validations"),1,l.buttonGroup(l.button(this.onAddRule.bind(this),"Add Rule",n.testId("Validation_addRule")))),n("div",n.testId("Validation_rules"),r.foreach(this.validations,(e=>{var t=a.create({observable:e.formula}),o=i.observable(!0);return n("div.validation",n.autoDispose(t),n("div.validation_title.flexhbox",n("div.validation_name",l.editableLabel(e.name)),n("div.flexitem"),n("div.validation_trash.glyphicon.glyphicon-remove",n.on("click",this.onDeleteRule.bind(this,e.id())))),l.row(1,n("div.glyphicon.glyphicon-tag.config_icon"),8,l.label("Table"),9,l.select(e.tableRef,this.tableChoices)),n("div.kf_elem.validation_formula",t.buildDom((i=>{t.attachSaveCommand(),i.on("change",(()=>{t.getValue()===e.formula()!==o()&&o(!o())})),i.removeAllListeners("blur")}))),l.row(2,"",1,l.buttonGroup(l.button((()=>t.writeObservable()),"Apply",{title:c("Update formula (Shift+Enter)")},r.toggleClass("disabled",o)))))})))]},e.exports=u},52103:(e,t,o)=>{var i=o(92979),s=$.ui.resizable.prototype._respectSize;$.ui.resizable.prototype._respectSize=function(){var e=s.apply(this,arguments);return this.options.isFlex&&(console.log("Ignoring left, top"),e.left=e.top=void 0),e},t.makeResizable=function(e,t){function o(o,i){e(i.size.width),"resizestop"===o.type&&(t.stop&&t.stop(o,i),e.save&&!1!==t.shouldSave&&e.save())}return t=t||{},function(e){$(e).resizable({handles:t.handles||"e",resize:o,stop:o,isFlex:t.isFlex,minWidth:t.minWidth||10}),t.hasOwnProperty("enabled")&&i.setBinding(e,t.enabled,(function(e,t){t?$(e).resizable("enable"):$(e).resizable("disable").removeClass("ui-state-disabled")}))}}},61237:(e,t,o)=>{var i=o(54156),s=o(29301),n=o(20543),r=o(83277),l=o(10328),{Delay:a}=o(96682),d=o(88438),c=o(92979),u=o(81294),h=o(11527).get("window","$");function p(e,t,o,n,r){this.scrolly=e,this.paneIndex=t,this.container=o,this.itemCreateFunc=r,this.preparedRows=[],i.extend(this.scrolly.options,n),this.container.appendChild(this.scrollDiv=u("div.scrolly_outer",c.style("height",this.scrolly.totalHeightPx),this.blockDiv=u("div",c.style("position","absolute"),c.style("top",this.scrolly.blockTopPx),c.style("width",n.fitToWidth?"100%":""),c.style("padding-right",n.paddingRight+"px")))),s.utils.domNodeDisposal.addDisposeCallback(o,(()=>{for(var e in this.scrolly.destroyPane(this),this)delete this[e]})),h.$(this.container).on("scroll",(()=>this.scrolly.onScroll(this)))}function m(e){this.data=e,this.numRows=0,this.options={paddingBottom:0},this.panes=[],this.activeItemModels=[],this.rowHeights=[],this.rowOffsetTree=new l,this.minRowHeight=23,this.numBuffered=1,this.numRendered=1,this.begin=0,this.end=0,this.scrollTop=0,this.shownHeight=0,this.blockBottom=0,this.blockTop=s.observable(0),this.blockTopPx=s.computed((function(){return this.blockTop()+"px"}),this),this.totalHeight=s.observable(0),this.totalHeightPx=s.computed((function(){return this.totalHeight()+"px"}),this),this.subscription=this.autoDispose(this.data.subscribe(this.onDataSplice,this,"spliceChange")),this.delayedUpdateSize=this.autoDispose(a.create());var t=this.data.all();this.onDataSplice({array:t,start:0,added:t.length,deleted:[]});let o=()=>{this.scheduleUpdateSize()};h.$(h.window).on("resize.scrolly",o),this.autoDisposeCallback((()=>h.$(h.window).off("resize.scrolly",o)))}function g(e){return e._scrollyObj||(e._scrollyObj=m.create(e),e._scrollyObj.autoDisposeCallback((()=>delete e._scrollyObj))),e._scrollyObj}p.prototype.prepareNewRows=function(){var e,t,o,i=this.scrolly.begin,r=this.scrolly.end-i,l=this.scrolly.data.peek(),a=this.scrolly.activeItemModels,d=this.preparedRows;for(d.length>0&&n.equal(d.length,a.length,"Rows and models not in sync: "+d.length+"!="+a.length),this.preparedRows=[],e=0;e<d.length;e++)if(o=d[e],null===(t=a[e])._index())s.removeNode(o);else{var u=t._index()-i;n(u>=0&&u<r,"prepareNewRows saw out-of-range model"),this.preparedRows[u]=o}for(e=0;e<r;e++)this.preparedRows[e]||(t=l[i+e],n(t,"ScrollyPane item missing at index "+(i+e)),t._rowHeightPx(""),o=this.itemCreateFunc(t),c.style("height",t._rowHeightPx)(o),s.utils.domData.set(o,"itemModel",t),this.preparedRows[e]=o,this.blockDiv.appendChild(o))},p.prototype.measurePreparedRow=function(e){var t=this.preparedRows[e].getBoundingClientRect();return t.bottom-t.top},p.prototype.arrangePreparedRows=function(){for(var e=0;e<this.preparedRows.length;e++){var t=this.preparedRows[e],o=this.blockDiv.childNodes[e];t!==o&&this.blockDiv.insertBefore(t,o)}},t.Scrolly=m,d.makeDisposable(m),m.prototype.debug=function(){console.log("Scrolly: numRows "+this.numRows+"; panes "+this.panes.length+"; numRendered "+this.numRendered+" ["+this.begin+", "+this.end+"); block at "+this.blockTop()+" of "+this.totalHeight()+"; scrolled to "+this.scrollTop+"; shownHeight "+this.shownHeight),console.assert(this.numRows,this.data.peekLength,"Wrong numRows; data is "+this.data.peekLength),console.assert(this.numRows,this.rowHeights.length,"Wrong rowHeights size "+this.rowHeights.length),console.assert(this.numRows,this.rowOffsetTree.size(),"Wrong rowOffsetTree size "+this.rowOffsetTree.size());var e=Math.min(this.numRendered,this.numRows);console.assert(this.end-this.begin,e,"Wrong range size "+(this.end-this.begin)),console.assert(this.activeItemModels.length,e,"Wrong activeItemModels.size "+this.activeItemModels.length);var t=this.blockBottom-this.blockTop();if(e>0)for(var o=0;o<this.panes.length;o++){var s=this.panes[o].preparedRows[0].getBoundingClientRect(),n=i.last(this.panes[o].preparedRows).getBoundingClientRect().bottom-s.top;n!==t&&console.warn("Scrolly render pane #%d %dpx bigger from expected (%dpx per row). Ensure items have no margins",o,n-t,(n-t)/e)}},t.getInstance=g,m.prototype.addPane=function(e,t,o){var i=new p(this,this.panes.length,e,t,o);this.panes.push(i),this.scheduleUpdateSize()},m.prototype.scheduleUpdateSize=function(e){this.isDisposed()||this.delayedUpdateSize.isPending()||this.delayedUpdateSize.schedule(0,this.updateSize.bind(this,e),this)},m.prototype.updateSize=function(e){this.resetHeights(),this.shownHeight=Math.max(0,Math.max.apply(null,this.panes.map((function(e){return e.container.clientHeight}))));var t=Math.max(1,Math.ceil((null!=e?e:this.shownHeight)/this.minRowHeight));this.numBuffered=5,this.numRendered=t+2*this.numBuffered,this._updateRange(),this.render(),this.syncScrollPosition()},m.prototype.onScroll=function(e){this.scrollTo(e.container.scrollTop)},m.prototype.scrollTo=function(e){if(e!==this.scrollTop&&(this.scrollTop=e,this.syncScrollPosition(),!(this.blockTop()<=e&&this.blockBottom>=e+this.shownHeight))){var t=e+this.shownHeight>=this.panes[0].container.scrollHeight;this._updateRange(),this.render(),t&&(this.scrollTop=this.panes[0].container.scrollHeight-this.shownHeight),this.syncScrollPosition()}},m.prototype.onDataSplice=function(e){this.numRows=this.data.peekLength,this.rowHeights.splice(e.start,e.deleted.length),r.arraySplice(this.rowHeights,e.start,r.arrayRepeat(e.added,this.minRowHeight)),this.rowOffsetTree.fillFromValues(this.rowHeights),this.totalHeight(this.rowOffsetTree.getTotal()+this.options.paddingBottom),this._updateRange(),this.scheduleUpdateSize()},m.prototype.syncScrollPosition=function(){for(var e=this.scrollTop,t=0;t<this.panes.length;t++)this.panes[t].container.scrollTop=e},m.prototype.createItemModel=function(){var e=this.data.makeItemModel();return e._rowHeightPx=s.observable(""),e},m.prototype.render=function(){var e,t,o,i,s,r=this.end-this.begin,l=this.data.peek(),a=[];n(this.end<=l.length,"Scrolly render() exceeds data length of "+l.length);var d=this.rowOffsetTree.getIndex(this.scrollTop),c=this.rowOffsetTree.getSumTo(d);for(e=0;e<this.activeItemModels.length;e++)(null===(i=(o=this.activeItemModels[e])._index())||i<this.begin||i>=this.end)&&a.push(o);for(e=0,i=this.begin;e<r;e++,i++)l[i]||(o=a.shift()||this.createItemModel(),this.data.setItemModel(o,i),o._rowHeightPx(""));for(e=0;e<a.length;e++)this.data.unsetItemModel(a[e]);for(t=0;t<this.panes.length;t++)this.panes[t].prepareNewRows();for(e=0,i=this.begin;e<r;e++,i++)if(""===(o=l[i])._rowHeightPx.peek()){var u=this.minRowHeight;for(t=0;t<this.panes.length;t++)u=Math.max(u,this.panes[t].measurePreparedRow(e));0!=(s=(u=Math.round(u))-this.rowHeights[i])&&(this.rowHeights[i]=u,this.rowOffsetTree.addValue(i,s))}for(e=0,i=this.begin;e<r;e++,i++)(o=l[i])._rowHeightPx(this.rowHeights[i]+"px");for(t=0;t<this.panes.length;t++)this.panes[t].arrangePreparedRows();this.activeItemModels=l.slice(this.begin,this.end),this.totalHeight(this.rowOffsetTree.getTotal()+this.options.paddingBottom),this.blockTop(this.rowOffsetTree.getSumTo(this.begin)),this.blockBottom=this.rowOffsetTree.getSumTo(this.end),0!=(s=this.rowOffsetTree.getSumTo(d)-c)&&(this.scrollTop+=s,this.syncScrollPosition())},m.prototype.resetHeights=function(e){var t=this.data.peek();if(e)for(var o=0;o<e.length;o++){var i=t[e[o]];i&&i._rowHeightPx("")}else this.activeItemModels.forEach((function(e){e._rowHeightPx("")}));this.render()},m.prototype.resetItemHeights=function(e){this.isDisposed()||(e.forEach((e=>e._rowHeightPx(""))),this.render())},m.prototype.scrollToPosition=function(e){var t=e();this.scrollTo(t),(t=e())!==this.scrollTop&&(this.scrollTop=t,this.syncScrollPosition())},m.prototype.scrollRowIntoView=function(e){this.scrollToPosition((()=>{var t=this.rowOffsetTree.getSumTo(e),o=t+this.rowHeights[e];return r.clamp(this.scrollTop,o-this.shownHeight+43,t-10)}))},m.prototype.scrollToSavedPos=function(e){this.scrollToPosition((()=>this.rowOffsetTree.getSumTo(e.rowIndex)+e.offset))},m.prototype.getScrollPos=function(){var e=this.rowOffsetTree.getIndex(this.scrollTop);return{rowIndex:e,offset:this.scrollTop-this.rowOffsetTree.getSumTo(e)}},m.prototype.destroyPane=function(e){r.arrayRemove(this.panes,e),0===this.panes.length&&this.dispose()},m.prototype._updateRange=function(){const e=this.rowOffsetTree.getIndex(this.scrollTop)-this.numBuffered;this.begin=r.clamp(e,0,this.numRows-this.numRendered),this.end=r.clamp(this.begin+this.numRendered,0,this.numRows)},t.scrolly=function(e,t,o){return n.equal(typeof o,"function"),t=t||{},function(i){var n=g(e);n.addPane(i,t,o),s.utils.domData.set(i,"scrolly",n)}}},88795:(e,t,o)=>{var i=o(54156),s=o(29301),n=o(88438),r=o(55424),l=o(32529),a=o(86277).Events;function d(e,t,o,i){var n=["id"].concat(t);r.call(this,e,n),this._rowId=i,this.events=this.autoDisposeWith("stopListening",a),this._isDeleted=s.observable(!1),this._fields.forEach((function(e){this._assignColumn(e)}),this),o&&o.call(this,e.docModel,e)}n.makeDisposable(d),i.extend(d.prototype,r.prototype),d.prototype._assignColumn=function(e){this.hasOwnProperty(e)&&this[e].assign(this._table.tableData.getValue(this._rowId,e))},d.Floater=function(e,t){this._table=e,this.rowIdObs=t,this._underlyingRowModel=this.autoDispose(s.computed((function(){return e.getRowModel(t())}))),i.each(this._underlyingRowModel(),(function(e,t){s.isObservable(e)&&(this[t]=this.autoDispose(s.pureComputed({owner:this,read:function(){return this._underlyingRowModel()[t]()},write:function(e){this._underlyingRowModel()[t](e)}})),e.saveOnly&&l.addSaveInterface(this[t],(e=>this._underlyingRowModel()[t].saveOnly(e))))}),this)},n.makeDisposable(d.Floater),e.exports=d},10832:(e,t,o)=>{var i=o(54156),s=o(29301),n=o(88438),r=o(88795),l=o(33113),a=o(3871),d=o(20543),c=o(83277);function u(e,t,o,i){l.call(this,e,t),this._fields=o,this._rowConstructor=i,this.rowModels=[],this._rowModelVersions=[],this.listenTo(this,"rowNotify",(function(e,t){d(e!==a.ALL,"Unexpected schema action on a metadata table");for(let o of e)this.rowModels[o]&&this.rowModels[o].dispatchAction(t)}))}n.makeDisposable(u),i.extend(u.prototype,l.prototype),u.prototype.loadData=function(){d(this.tableData.isLoaded,"MetaTableModel: tableData not yet loaded"),this.getAllRows().forEach((function(e){this._createRowModel(e)}),this)},u.prototype.getRowModel=function(e,t){const o=this.rowModels[e]||this.getEmptyRowModel();if(t){const t=this._rowModelVersions[e];t&&t()}return o},u.prototype.getEmptyRowModel=function(){return this._createRowModel(0)},u.prototype._createRowModel=function(e){return this.rowModels[e]||s.ignoreDependencies((()=>{this.rowModels[e]=r.create(this,this._fields,this._rowConstructor,e);let t=this._rowModelVersions[e]||(this._rowModelVersions[e]=s.observable(0));t(t.peek()+1)})),this.rowModels[e]},u.prototype.createFloatingRowModel=function(e){return r.Floater.create(this,e)},u.prototype._process_RemoveRecord=function(e,t,o){l.prototype._process_RemoveRecord.apply(this,arguments),this._deleteRowModel(o)},u.prototype._deleteRowModel=function(e){this.rowModels[e]._isDeleted(!0),this.rowModels[e].dispose(),delete this.rowModels[e]},u.prototype._process_BulkRemoveRecord=function(e,t,o){l.prototype._process_BulkRemoveRecord.apply(this,arguments),o.forEach((e=>this._deleteRowModel(e)))},u.prototype._process_AddRecord=function(e,t,o,i){this._createRowModel(o),l.prototype._process_AddRecord.apply(this,arguments)},u.prototype._process_BulkAddRecord=function(e,t,o,i){o.forEach((e=>this._createRowModel(e))),l.prototype._process_BulkAddRecord.apply(this,arguments)},u.prototype.applySchemaAction=function(e){throw new Error("No schema actions should apply to metadata")},u.prototype.createAllRowsModel=function(e){return this._createRowSetModel(this,e)},u.prototype.createRowGroupModel=function(e,t){var o=this.getRowGrouping(t.groupBy);return this._createRowSetModel(o.getGroup(e),t.sortBy)},u.prototype._createRowSetModel=function(e,t){var o=this.tableData.getRowPropFunc(t),i=a.SortedRowSet.create(null,(function(e,t){return c.nativeCompare(o(e),o(t))}));i.subscribeTo(e);var s=this._createRowModelArray(i.getKoArray());return s.autoDispose(i),s},u.prototype._createRowModelArray=function(e){var t=e.map(this._createRowModelItem,this);return t.subscribe((function(e){var t,o=e.array;for(t=0;t<e.deleted.length;t++)e.deleted[t]._index(null);if(0!=e.added-e.deleted.length)for(t=e.start+e.added;t<o.length;t++)o[t]._index(t)}),null,"spliceChange"),t},u.prototype._createRowModelItem=function(e,t){var o=this._createRowModel(e);d.ok(o,"MetaTableModel._createRowModelItem called for invalid rowId "+e);var i=Object.create(o);return i._index=s.observable(t),i},e.exports=u},10328:e=>{function t(e){if(this.tree=[],e>0){this.tree.length=e;for(var t=0;t<e;t++)this.tree[t]=0;this.mask=s(this.tree.length-1)}}function o(e){return e&-e}function i(e){return e&e-1}function s(e){if(0===e)return 0;for(var t=1;e>>>=1;)t<<=1;return t}function n(e){for(var t=e.length-1;t>=1;t--)e[t]-=e[t-1];return e}function r(e){for(var t=1;t<e.length;t++)e[t]+=e[t-1];return e}t.leastSignificantOne=o,t.stripLeastSignificantOne=i,t.mostSignificantOne=s,t.cumulToValues=n,t.valuesToCumul=r,t.prototype.size=function(){return this.tree.length},t.prototype.toCumulativeArray=function(){for(var e=[this.tree[0]],t=e.length=this.tree.length,o=1;o<t;o++)e[o]=this.tree[o]+e[i(o)];return e},t.prototype.toValueArray=function(){return n(this.toCumulativeArray())},t.prototype.fillFromCumulative=function(e){var t=this.tree.length=e.length;if(t>0){this.tree[0]=e[0];for(var o=1;o<t;o++)this.tree[o]=e[o]-e[i(o)];this.mask=s(this.tree.length-1)}else this.mask=0},t.prototype.fillFromValues=function(e){this.fillFromCumulative(r(e.slice()))},t.prototype.getCumulativeValue=function(e){for(var t=this.tree[0];e>0;)t+=this.tree[e],e=i(e);return t},t.prototype.getCumulativeValueRange=function(e,t){return this.getSumTo(t)-this.getSumTo(e)},t.prototype.getSumTo=function(e){return e>0?this.getCumulativeValue(e-1):0},t.prototype.getTotal=function(){return this.getCumulativeValue(this.tree.length-1)},t.prototype.getValue=function(e){var t=this.tree[e];if(e>0){var o=i(e);for(e--;e!==o;)t-=this.tree[e],e=i(e)}return t},t.prototype.addValue=function(e,t){if(0===e)this.tree[0]+=t;else for(;e<this.tree.length;)this.tree[e]+=t,e+=o(e)},t.prototype.setValue=function(e,t){this.addValue(e,t-this.getValue(e))},t.prototype.getIndex=function(e){if(0===this.tree.length||this.tree[0]>=e)return 0;for(var t=0,o=this.mask,i=this.tree[0];0!==o;){var s=t+o;s<this.tree.length&&i+this.tree[s]<e&&(t=s,i+=this.tree[t]),o>>>=1}return t+1},e.exports=t}}]);
//# sourceMappingURL=272.bundle.js.map